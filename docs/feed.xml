<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://hvppyarchive.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://hvppyarchive.github.io/" rel="alternate" type="text/html" /><updated>2025-10-27T11:05:53+09:00</updated><id>https://hvppyarchive.github.io/feed.xml</id><title type="html">ARCHIVE</title><subtitle>An amazing archive.</subtitle><author><name>hvppyarchive</name></author><entry><title type="html"></title><link href="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/" rel="alternate" type="text/html" title="" /><published>2025-10-27T11:05:53+09:00</published><updated>2025-10-27T11:05:53+09:00</updated><id>https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str</id><content type="html" xml:base="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/"><![CDATA[<p class="chat--user">

Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> í•¨ìˆ˜ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> í•¨ìˆ˜ì˜ ì°¨ì´ì 

</p>

<p>Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> ê³¼ <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ì°¨ì´ì ì€ <strong>ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ í‘œí˜„í•˜ëŠ” ëª©ì </strong> ì—ì„œ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì°¨ì´ë¥¼ ë‹¨ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.</p>

<hr />

<h2 id="1-__repr__-ì˜-ëª©ì ">1. <code class="language-plaintext highlighter-rouge">__repr__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ê°œë°œì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ê°œë°œì"ê°€ ë³´ê³  ì´í•´í•  ìˆ˜ ìˆë„ë¡ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì¬í˜„ ê°€ëŠ¥(reproducible)</strong> : ê°€ëŠ¥í•œ í•œ ê°ì²´ë¥¼ ë‹¤ì‹œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì½”ë“œ í˜•íƒœë¡œ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë³´í†µ <code class="language-plaintext highlighter-rouge">eval(repr(obj)) == obj</code> ê°€ ì„±ë¦½í•˜ëŠ” í˜•íƒœë¥¼ ì§€í–¥í•©ë‹ˆë‹¤ (ê¼­ í•­ìƒ ê·¸ëŸ° ê±´ ì•„ë‹ˆì§€ë§Œ ê¶Œì¥).</p>
  </li>
  <li>
    <p>ë””ë²„ê¹…í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Person(name=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">'</span><span class="s">, age=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># Person(name='Alice', age=30)
</span></code></pre></div></div>

<hr />

<h2 id="2-__str__-ì˜-ëª©ì ">2. <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ì‚¬ìš©ì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ì‚¬ìš©ì"ê°€ ë³´ê¸° ì¢‹ì€ ë¬¸ìì—´ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì½ê¸° ì‰½ê³  ê¹”ë”í•˜ê²Œ ì¶œë ¥í•˜ëŠ” ë° ì´ˆì ì„ ë‘¡ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">print(obj)</code> ë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ë³´ì—¬ì§€ëŠ” ê°’ì´ <code class="language-plaintext highlighter-rouge">__str__</code> ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s"> years old)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Alice (30 years old)
</span></code></pre></div></div>

<hr />

<h2 id="3-__repr__-vs-__str__-ë¹„êµ">3. <code class="language-plaintext highlighter-rouge">__repr__</code> vs <code class="language-plaintext highlighter-rouge">__str__</code> ë¹„êµ</h2>

<table>
  <thead>
    <tr>
      <th>íŠ¹ì§•</th>
      <th><code class="language-plaintext highlighter-rouge">__repr__</code></th>
      <th><code class="language-plaintext highlighter-rouge">__str__</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ëª©ì </td>
      <td>ê°œë°œììš©, ë””ë²„ê¹…</td>
      <td>ì‚¬ìš©ììš©, ê°€ë…ì„±</td>
    </tr>
    <tr>
      <td>ì¶œë ¥ ëŒ€ìƒ</td>
      <td><code class="language-plaintext highlighter-rouge">repr(obj)</code>, ëŒ€í™”í˜• ì‰˜ì—ì„œ ê¸°ë³¸</td>
      <td><code class="language-plaintext highlighter-rouge">str(obj)</code>, <code class="language-plaintext highlighter-rouge">print(obj)</code></td>
    </tr>
    <tr>
      <td>í˜•ì‹</td>
      <td>ê°ì²´ ì¬í˜„ ê°€ëŠ¥í•˜ê±°ë‚˜ ìƒì„¸</td>
      <td>ì½ê¸° ì‰¬ìš´ ì„¤ëª… ìœ„ì£¼</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="4-êµ¬í˜„-ì‹œ-ì£¼ì˜ì‚¬í•­">4. êµ¬í˜„ ì‹œ ì£¼ì˜ì‚¬í•­</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code> ê°€ ì—†ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ê°€ ëŒ€ì‹  ì‚¬ìš©</strong>ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë”°ë¼ì„œ ìµœì†Œí•œ <code class="language-plaintext highlighter-rouge">__repr__</code> ì€ ì •ì˜í•´ ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>ğŸ‘‰ ì •ë¦¬í•˜ë©´,</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__repr__</code></strong> : â€œê°œë°œìê°€ ë””ë²„ê¹…í•  ë•Œâ€ ê°ì²´ì˜ ì •í™•í•œ í‘œí˜„.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code></strong> : â€œì‚¬ìš©ìê°€ ì¶œë ¥ë¬¼ì„ ë³¼ ë•Œâ€ ë³´ê¸° ì¢‹ê²Œ í‘œí˜„.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> ë¥¼ ë™ì‹œì— êµ¬í˜„í–ˆì„ ë•Œ <code class="language-plaintext highlighter-rouge">print(obj)</code> ì™€ <code class="language-plaintext highlighter-rouge">obj</code> (ì‰˜ ì¶œë ¥) ì˜ ì°¨ì´ë¥¼ ì§ì ‘ ì‹¤í–‰í•´ ë³´ì—¬ë“œë¦´ ìˆ˜ë„ ìˆëŠ”ë°, ì˜ˆì œ ì½”ë“œ ì‹œì—°ì„ ì›í•˜ì‹œë‚˜ìš”?</p>]]></content><author><name>hvppyarchive</name></author></entry><entry><title type="html">OpenAI í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸</title><link href="https://hvppyarchive.github.io/llm/openai-function-call-examples/" rel="alternate" type="text/html" title="OpenAI í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸" /><published>2025-10-27T11:05:47+09:00</published><updated>2025-10-27T11:05:47+09:00</updated><id>https://hvppyarchive.github.io/llm/openai-function-call-examples</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/openai-function-call-examples/"><![CDATA[<p class="chat--user">

openai packageë¥¼ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±í• ê±°ì•¼. ëª©í‘œ: 2ê°€ì§€ ëª¨ë¸ì— ëŒ€í•´ 2ê°€ì§€ api type(completions, responses)ì— ëŒ€í•´ function calling í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³  ì‹¶ì–´. ì´ 4ê°œ ì¡°í•©ì— ëŒ€í•´ ì„¤ì •í•  ìˆ˜ ìˆê²Œ ì½”ë“œ ì‘ì„± í•˜ì. íˆ´ì€ ê°„ë‹¨íˆ íŠ¹ì • í´ë”ì˜ íŒŒì¼ ì¡°íšŒ, íŠ¹ì • í´ë”ì˜ íŒŒì¼ ì½ê¸° ë‘ ê°€ì§€ íˆ´ì„ êµ¬í˜„í• ê±°ì•¼ 2ê°œ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸, api í‚¤, ëª¨ë¸ëª…ì„ ì½”ë“œ ë‚´ì—ì„œ ì„¤ì •í•  ìˆ˜ ìˆë„ë¡ í•  ê²ƒ.

</p>

<p>ì¢‹ì•„! ì•„ë˜ëŠ” â€œë‘ ëª¨ë¸ Ã— ë‘ API íƒ€ì…(completions, responses) Ã— í•¨ìˆ˜ í˜¸ì¶œ(function calling)â€ ì¡°í•©ì„ í•œ íŒŒì¼ì—ì„œ ëª¨ë‘ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ì•¼.<br />
ìš”êµ¬ì‚¬í•­ ì •ë¦¬ëŒ€ë¡œ</p>

<ol>
  <li>
    <p>ë‘ ê°€ì§€ íŒŒì¼ ê´€ë ¨ íˆ´(í´ë” ë‚´ íŒŒì¼ ëª©ë¡ ì¡°íšŒ, íŒŒì¼ ì½ê¸°)</p>
  </li>
  <li>
    <p>2ê°œ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸Â·API í‚¤Â·ëª¨ë¸ëª…ì„ ì½”ë“œ ë‚´ì—ì„œ ì„¤ì • ê°€ëŠ¥</p>
  </li>
  <li>
    <p>4ê°€ì§€ ì¡°í•©ì„ ì›í•˜ëŠ” ëŒ€ë¡œ ì‹¤í–‰ ê°€ëŠ¥</p>
  </li>
</ol>

<p>ì„ ëª¨ë‘ ë‹´ì•˜ì–´. ìµœì‹  OpenAI Python SDKì˜ ì‚¬ìš©ë²•ê³¼ Responses APIì˜ íˆ´ í˜¸ì¶œ íë¦„ì€ ê³µì‹ ë¬¸ì„œì˜ êµ¬ì¡°ë¥¼ ë”°ëì–´. ì°¸ê³ : function callingê³¼ tools ì •ì˜ ë°©ì‹ì€ ê³µì‹ ê°€ì´ë“œì™€ ë™ì¼í•˜ê³ , Chat Completions APIì—ì„œëŠ” tool_callsë¥¼ messageì—, Responses APIì—ì„œëŠ” output í•­ëª©ê³¼ tool_callsë¥¼ í†µí•´ ì£¼ê³ ë°›ëŠ” í˜•íƒœì•¼. ê´€ë ¨ ë¬¸ì„œ: Function Calling ê°€ì´ë“œì™€ Responses API ë ˆí¼ëŸ°ìŠ¤. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼+1</a></p>

<p>ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒì²˜ëŸ¼ ë™ì‘í•´</p>

<ul>
  <li>
    <p>MODELS ì„¹ì…˜ì—ì„œ model A/Bì˜ endpoint, api_key, model ì´ë¦„ì„ ì±„ì›Œë‘”ë‹¤(ì˜ˆì‹œ í¬í•¨).</p>
  </li>
  <li>
    <p>TOOL ì •ì˜ëŠ” ê³µí†µ(JSON Schema).</p>
  </li>
  <li>
    <p>run_with_chat_completions(â€¦), run_with_responses(â€¦) ë‘ í•¨ìˆ˜ê°€ ê°ê° í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„ë¥¼ ìˆ˜í–‰.</p>
  </li>
  <li>
    <p>mainì—ì„œ ë„¤ ê°€ì§€ ì¡°í•©ì„ ìˆœì°¨ ì‹¤í–‰í•˜ê±°ë‚˜, ì›í•˜ëŠ” ì¡°í•©ë§Œ ì„ íƒ ì‹¤í–‰í•˜ë„ë¡ CLI ì˜µì…˜ ì œê³µ.</p>
  </li>
</ul>

<p>ì½”ë“œ ë³µì‚¬í•´ì„œ test_openai_tools.pyë¡œ ì €ì¥í•œ ë’¤, samples í´ë”ì— í…ŒìŠ¤íŠ¸ìš© íŒŒì¼ì„ ëª‡ ê°œ ë„£ê³  ëŒë ¤ë´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 1) êµ¬ì„±(ëª¨ë¸/ì—”ë“œí¬ì¸íŠ¸/í‚¤)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># ex) "https://api.openai.com/v1"
</span>    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># ex) os.getenv("OPENAI_API_KEY")
</span>
<span class="c1"># ì—¬ê¸°ì„œ ë‘ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸/í‚¤/ëª¨ë¸ëª…ì„ ì„¤ì •í•˜ì„¸ìš”.
# ì‹¤ì œ í‚¤ë¥¼ ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì§€ ë§ê³ , í™˜ê²½ë³€ìˆ˜ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
</span><span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">,</span>          <span class="c1"># ì˜ˆì‹œ (ì›í•˜ëŠ” ìµœì‹  ëª¨ë¸ëª…ìœ¼ë¡œ ë³€ê²½)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>           <span class="c1"># ì˜ˆì‹œ (ì›í•˜ëŠ” ìµœì‹  ëª¨ë¸ëª…ìœ¼ë¡œ ë³€ê²½)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =====================================
# 2) ë¡œì»¬ íŒŒì¼ íˆ´(í´ë” ëª©ë¡/íŒŒì¼ ì½ê¸°)
# =====================================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì§€ì • í´ë” ë‚´ íŒŒì¼ ëª©ë¡ ë°˜í™˜(íŒŒì¼ë§Œ).</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">files</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ì§€ì • ê²½ë¡œì˜ í…ìŠ¤íŠ¸ íŒŒì¼ ë‚´ìš© ë°˜í™˜(UTF-8 ê°€ì •).</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c1"># ë°”ì´ë„ˆë¦¬ ë“± í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ê²½ìš°
</span>        <span class="k">return</span> <span class="sh">""</span>

<span class="c1"># ê³µí†µ íˆ´ ìŠ¤í‚¤ë§ˆ(JSON Schema; Chat Completions/Responsesì—ì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
</span><span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content as a string.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># íˆ´ ë””ìŠ¤íŒ¨ì²˜
</span><span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># =====================================
# 3) Chat Completionsë¡œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
# =====================================
</span>
<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chat Completions APIë¡œ function calling í…ŒìŠ¤íŠ¸.
    - tools: TOOLS
    - tool_choice: </span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="s"> ê¶Œì¥
    - tool_calls -&gt; ì‹¤ì œ íŒŒì´ì¬ í•¨ìˆ˜ ì‹¤í–‰ -&gt; tool ë©”ì‹œì§€ ì²¨ë¶€ -&gt; ì¬í˜¸ì¶œ
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>  <span class="c1"># 'auto' or {'type':'function','function':{'name':'...'}}
</span>    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
</span>    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="c1"># tool ë©”ì‹œì§€ ì²¨ë¶€
</span>            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_output</span>
            <span class="p">})</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="c1"># í›„ì† í˜¸ì¶œ(ìµœì¢… ë‹µë³€ ìœ ë„)
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =====================================
# 4) Responses APIë¡œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
#    - ìµœì‹  SDK ê·œì•½ì— ë§ì¶° ë¹„ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ êµ¬ì„±
# =====================================
</span>
<span class="k">def</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Responses APIì˜ output ë°°ì—´ì—ì„œ ìì—°ì–´ í…ìŠ¤íŠ¸ë§Œ ëª¨ì•„ ë°˜í™˜.</span><span class="sh">"""</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># item.type == "message" ì¸ ê²½ìš°, item.content[*] ì¤‘ type == "output_text"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="c1"># ì¼ë¶€ ëª¨ë¸ì€ ìµœì¢…ì— ë°”ë¡œ output_textë§Œ ë‚´ë³´ë‚´ê¸°ë„ í•¨
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì˜ outputì—ì„œ tool_call ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘.
    ê° í•­ëª©ì€ {id, name, arguments} í˜•íƒœë¡œ ì •ê·œí™”í•´ì„œ ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># ì¼€ì´ìŠ¤1: item.type == "tool_call"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">tc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
            <span class="c1"># argumentsëŠ” ë¬¸ìì—´/ë”•ì…”ë„ˆë¦¬ ëª¨ë‘ ê°€ëŠ¥ì„± ê³ ë ¤
</span>            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span>

        <span class="c1"># ì¼€ì´ìŠ¤2: item.type == "message" ë‚´ë¶€ content[*]ì— tool_calls ë¬¶ì—¬ìˆì„ ìˆ˜ ìˆìŒ
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># ì¼ë¶€ SDK ë²„ì „ì—ì„œ item.tool_calls ë˜ëŠ” item.content[*].tool_calls í˜•íƒœ
</span>            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">arg_obj</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIë¡œ function calling í…ŒìŠ¤íŠ¸.
    íë¦„:
      1) responses.create(input=[{role:user, content:...}], tools=TOOLS, tool_choice=...)
      2) tool_callì´ ìˆìœ¼ë©´ ë¡œì»¬ í•¨ìˆ˜ ì‹¤í–‰
      3) responses.create(..., tool_outputs=[{tool_call_id, output}], response_id=prev.id) ë¡œ ì´ì–´ì„œ í˜¸ì¶œ
         (ìµœì‹  ë¬¸ì„œì˜ ê·œì•½ì„ ë”°ë¦„)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>
    <span class="p">)</span>

    <span class="c1"># ë£¨í”„: ë„êµ¬ í˜¸ì¶œì´ ëë‚  ë•Œê¹Œì§€
</span>    <span class="n">final_text_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># ì•ˆì „ ìƒí•œ
</span>        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">plain_text</span> <span class="o">=</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">plain_text</span><span class="p">:</span>
            <span class="n">final_text_parts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span>
            <span class="p">})</span>

        <span class="c1"># ì´ì „ responseì™€ ì´ì–´ ë¶™ì—¬ íˆ´ ê²°ê³¼ë¥¼ ì „ë‹¬
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs_payload</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">final_text_parts</span> <span class="k">if</span> <span class="n">p</span><span class="p">])</span>

<span class="c1"># =====================================
# 5) ì‹¤í–‰ë¶€(4ê°€ì§€ ì¡°í•©)
# =====================================
</span>
<span class="n">DEFAULT_USER_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë” ì•ˆì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">ê·¸ ì¤‘ í•˜ë‚˜ì˜ ë‚´ìš©ì„ ì½ì–´ì„œ í•µì‹¬ë§Œ 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">combo_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">combo_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] with Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">combo_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Test function-calling with OpenAI (4-way matrix).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which API type to run.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which model to use.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_USER_TASK</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">User task/prompt.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>

    <span class="c1"># ìƒ˜í”Œ í´ë” ì•ˆë‚´
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© ë°©ë²• ê°„ë‹¨ ì •ë¦¬</p>

<ol>
  <li>í™˜ê²½ ë³€ìˆ˜ ì„¸íŒ…(ê¶Œì¥)</li>
</ol>

<ul>
  <li>
    <p>Model A</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY=â€¦</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Model B</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY_B=â€¦</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL_B=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¤€ë¹„</li>
</ol>

<ul>
  <li>í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— samples í´ë”ë¥¼ ë§Œë“¤ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì„ 1ê°œ ì´ìƒ ë„£ëŠ”ë‹¤. ì˜ˆ: samples/readme.txt</li>
</ul>

<ol>
  <li>ì‹¤í–‰</li>
</ol>

<ul>
  <li>
    <p>ë„¤ ì¡°í•© ëª¨ë‘:<br />
python test_openai_tools.py</p>
  </li>
  <li>
    <p>íŠ¹ì • APIë§Œ:<br />
python test_openai_tools.py â€“api completions<br />
python test_openai_tools.py â€“api responses</p>
  </li>
  <li>
    <p>íŠ¹ì • ëª¨ë¸ë§Œ:<br />
python test_openai_tools.py â€“model A<br />
python test_openai_tools.py â€“model B</p>
  </li>
  <li>
    <p>í”„ë¡¬í”„íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ:<br />
python test_openai_tools.py â€“task "ì—¬ê¸°ì— ì›í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì§€ì‹œë¬¸"</p>
  </li>
</ul>

<p>êµ¬í˜„ í¬ì¸íŠ¸ ì„¤ëª…(í•„ìš” ì‹œ ì ê²€í•  ì²´í¬ë¦¬ìŠ¤íŠ¸)</p>

<ul>
  <li>
    <p>Chat Completions: response.choices[0].message.tool_callsë¥¼ í™•ì¸í•˜ê³ , ê° íˆ´ì„ ì‹¤í–‰í•œ ë’¤ tool ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•´ì„œ ì¬í˜¸ì¶œí•˜ëŠ” ì „í˜•ì  ë£¨í”„ë¥¼ ì‚¬ìš©í–ˆì–´. ì´ê²ƒì€ Function Calling ê°€ì´ë“œì˜ ê¶Œê³  íŒ¨í„´ì´ì•¼. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Responses API: responses.create(â€¦) â†’ outputì—ì„œ tool_call ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘ â†’ ì‹¤ì œ í•¨ìˆ˜ ì‹¤í–‰ â†’ tool_outputsì™€ ì´ì „ response_idë¥¼ í•¨ê»˜ ë„˜ê²¨ í›„ì† responses.create(â€¦) í˜¸ì¶œë¡œ ì´ì–´ ë¶™ì´ëŠ” íŒ¨í„´ì´ì•¼. ì´ íë¦„ì€ ê³µì‹ Responses API ë ˆí¼ëŸ°ìŠ¤ê°€ ì•ˆë‚´í•˜ëŠ” ë°©ì‹ê³¼ ë§ë¬¼ë ¤ ìˆì–´. <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>tools ìŠ¤í‚¤ë§ˆëŠ” ë‘ APIì—ì„œ ë™ì¼í•˜ê²Œ ì¬ì‚¬ìš©.</p>
  </li>
  <li>
    <p>ë¡œì»¬ íŒŒì¼ I/OëŠ” ì•ˆì „í•˜ê²Œ ì˜ˆì™¸ ì²˜ë¦¬í–ˆê³ , í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ê°€ì •(UTF-8)í–ˆì§€ë§Œ ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¬¸ìì—´ì„ ë°˜í™˜í•´ ëª¨ë¸ì´ ì ì ˆíˆ ì•ˆë‚´í•˜ë„ë¡ í–ˆì–´.</p>
  </li>
</ul>

<p>ë¬¸ì„œ ì°¸ê³  ë§í¬</p>

<ul>
  <li>
    <p>Function Calling ê°€ì´ë“œ(íˆ´ ì •ì˜/í˜¸ì¶œ íë¦„) <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Responses API ë ˆí¼ëŸ°ìŠ¤(ì‘ë‹µ êµ¬ì¡°, tool_outputs ì „ë‹¬ ë°©ì‹) <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI í”Œë«í¼</a></p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´</p>

<ul>
  <li>
    <p>ëª¨ë¸ëª…ë§Œ ë°”ê¿”ì„œ(ì˜ˆ: ìµœì‹  gpt-4.1 ê³„ì—´ ë“±) ì¦‰ì‹œ ì‹œí—˜ ê°€ëŠ¥</p>
  </li>
  <li>
    <p>tool_choiceë¥¼ "any"ë¡œ ë°”ê¾¸ë©´ ì—¬ëŸ¬ íˆ´ ë³‘ë ¬ í˜¸ì¶œ ê²½í–¥ì„ ë” ì‹œí—˜í•  ìˆ˜ ìˆì–´</p>
  </li>
  <li>
    <p>samples í´ë” ê²½ë¡œë‚˜ ì½ì„ íŒŒì¼ ì„ íƒ ë¡œì§ì„ ë” ì—„ê²©í•˜ê²Œ ì§€ì •í•˜ê³  ì‹¶ë‹¤ë©´, í”„ë¡¬í”„íŠ¸ë¥¼ ê³ ì •(seed task)í•˜ê±°ë‚˜ ì‹œìŠ¤í…œ ë©”ì‹œì§€ìª½ì— ê·œì¹™ì„ ë”í•´ë„ ì¢‹ì•„</p>
  </li>
</ul>

<p>ì›í•˜ëŠ” ë¶€ë¶„ ë” ë°”ê¿”ë“œë¦´ê²Œ.</p>

<p class="chat--user">

ì•„ë‹ˆ ë‚´ê°€ ì¡°ì‚¬í–ˆì„ ë•Œ responsesìš© íˆ´ jsonì´ ìˆê³ , completionìš©ì´ ë”°ë¡œ ìˆì–´ ì¡°ê¸ˆ ë‹¤ë¥´ê²Œ ìƒê²¼ë˜ë° ì°¾ì•„ì„œ ë°˜ì˜í•´ì¤˜

</p>

<p>ì¢‹ì€ ì§€ì ì´ì•¼. ì‹¤ì œë¡œ â€œë„êµ¬ ì •ì˜(tools JSON)â€ëŠ” ë‘ APIê°€ ê±°ì˜ ê°™ì§€ë§Œ, Responses APIëŠ” ì‹¤í–‰Â·ìƒíƒœ ì „íŒŒ ë°©ì‹(response_id, tool_outputs ë“±)ê³¼ ì¶œë ¥ êµ¬ì¡°ê°€ ë‹¤ë¥´ê³ , ê°€ì´ë“œì—ì„  Responses ì˜ˆì‹œì—ì„œ ì—„ê²© íŒŒì‹±(strict) ì˜µì…˜ì„ ê³ë“¤ì—¬ ì“°ëŠ” íŒ¨í„´ì´ ìì£¼ ë³´ì—¬ì„œ ëª¨ì–‘ì´ ì‚´ì§ ë‹¬ë¼ ë³´ì¼ ìˆ˜ ìˆì–´. ê·¸ë˜ì„œ ì•„ë˜ì²˜ëŸ¼ ì•„ì˜ˆ ë‘ ë²Œì˜ ìŠ¤í‚¤ë§ˆë¥¼ ë¶„ë¦¬í•´ ë‘ê³ , Responses ìª½ì—” ì—„ê²© íŒŒì‹±ì„ ë„£ëŠ” ì‹ìœ¼ë¡œ ë°˜ì˜í–ˆì–´. ë˜í•œ ResponsesëŠ” tool_outputsì™€ response_idë¥¼ í†µí•´ ë‹¨ê³„ì ìœ¼ë¡œ ì´ì–´ë¶™ì´ëŠ” ì ì„ ì½”ë“œì— ëª…í™•íˆ í–ˆì–´. ì°¸ê³  ë¬¸ì„œ: Function Calling ê°€ì´ë“œì™€ Responses API ë ˆí¼ëŸ°ìŠ¤. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI í”Œë«í¼+2</a></p>

<p>ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë„¤ ê°€ì§€ ì¡°í•©(ëª¨ë¸ A/B Ã— completions/responses) ëª¨ë‘ í•¨ìˆ˜ í˜¸ì¶œì„ ì‹œí—˜í•˜ê³ , ë‘ ì¢…ë¥˜ì˜ íŒŒì¼ íˆ´ì„ ì œê³µí•´. ë³€ê²½ í¬ì¸íŠ¸ëŠ” 1) CHAT_TOOLS vs RESPONSES_TOOLS ë¶„ë¦¬, 2) Responses ë£¨í”„ì—ì„œ tool_outputsÂ·response_id ì‚¬ìš©ì„ ë” ì—„ê²©íˆ, 3) Responses ì¶œë ¥ íŒŒì„œ ë³´ê°•ì´ì•¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools_split_tools.py
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ê³µí†µ ì‹¤ì œ êµ¬í˜„ í•¨ìˆ˜
</span><span class="kn">import</span> <span class="n">os</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># Chat Completions ì „ìš© ë„êµ¬ JSON
# - ì „í†µì ì¸ function calling ìŠ¤í‚¤ë§ˆ
</span><span class="n">CHAT_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses ì „ìš© ë„êµ¬ JSON
# - ìŠ¤í‚¤ë§ˆ í•„ë“œëŠ” ìœ ì‚¬í•˜ì§€ë§Œ, Responses ì˜ˆì œ ê´€ë¡€ì— ë§ì¶° strictë¥¼ ì¼¬
#   (ëª¨ë¸ì´ schemaì— ì •í™•íˆ ë§ì¶° ì¸ì ìƒì„±í•˜ë„ë¡ ê°•ì œ)
</span><span class="n">RESPONSES_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">CHAT_TOOLS</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># ê° íˆ´ ì‹¤í–‰
</span>        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>
        <span class="c1"># ëŒ€í™” ì´ì–´ë¶™ì´ê¸°
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># Responses ì¶œë ¥ íŒŒì„œ
</span><span class="k">def</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>

    <span class="n">final_text</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># ResponsesëŠ” tool_outputs + response_idë¡œ ìƒíƒœë¥¼ ì´ì–´ì„œ ë³´ë‚¸ë‹¤.
</span>    <span class="c1"># ì´ì–´ë¶™ì´ê¸° íŒ¨í„´ì€ ê³µì‹ ë ˆí¼ëŸ°ìŠ¤ì˜ íë¦„ê³¼ ë™ì¼. :contentReference[oaicite:1]{index=1}
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>  <span class="c1"># ì•ˆì „ ìƒí•œ
</span>        <span class="n">txt</span> <span class="o">=</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">txt</span><span class="p">:</span>
            <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">calls</span> <span class="o">=</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">})</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>          <span class="c1"># ì´ì „ ì‘ë‹µê³¼ ì—°ê²°
</span>            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>  <span class="c1"># íˆ´ ì‹¤í–‰ ê²°ê³¼ ì „ë‹¬
</span>        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ ìš”ì•½. í•„ìš”í•˜ë©´ íˆ´ ì‚¬ìš©.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">which_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">which_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">which_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></div>

<p>í•µì‹¬ ì°¨ì´ ì •ë¦¬ ë‹¨ê³„ë³„</p>

<ol>
  <li>
    <p>ë„êµ¬ ì •ì˜ ìì²´ëŠ” í•„ë“œ êµ¬ì¡°ê°€ ë™ì¼(type=function, function.name/description/parameters)í•˜ë˜, Responses ìª½ ì˜ˆì‹œì—ì„œëŠ” strictë¥¼ ì¼œì„œ JSON Schemaë¥¼ ì—„ê²©íˆ ì§€í‚¤ê²Œ í•˜ëŠ” íŒ¨í„´ì´ ë„ë¦¬ ì“°ì¸ë‹¤. ê·¸ë˜ì„œ ìŠ¤í‚¤ë§ˆê°€ â€œì¡°ê¸ˆ ë‹¤ë¥´ê²Œ ìƒê¸´ ê²ƒì²˜ëŸ¼â€ ë³´ì¼ ìˆ˜ ìˆë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>Chat CompletionsëŠ” messages ë°°ì—´ì— assistant.tool_callsê°€ ë‚˜ì˜¤ê³ , ê° call.idì— ëŒ€ì‘í•˜ëŠ” tool ë©”ì‹œì§€ë¥¼ ë„£ì–´ ë‹¤ì‹œ chat.completions.createë¥¼ í˜¸ì¶œí•œë‹¤.</p>
  </li>
  <li>
    <p>ResponsesëŠ” outputì— tool_call í•­ëª©ì´ ë‚˜ì˜¤ë©°, ì‹¤ì œ ë„êµ¬ ì‹¤í–‰ í›„ tool_outputs ë°°ì—´ê³¼ ì´ì „ ì‘ë‹µì˜ response_idë¥¼ í¬í•¨í•´ responses.createë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•´ ìƒíƒœë¥¼ ì´ì–´ ë¶™ì¸ë‹¤. ì´ê²Œ ê°€ì¥ í° ì°¨ì´ì ì´ë‹¤. <a href="https://platform.openai.com/docs/api-reference/responses-streaming/response?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ol>

<p>ì´ ë²„ì „ìœ¼ë¡œ ëŒë ¤ë³´ê³ , Responsesì—ì„œ strictë¥¼ ë„ê³  ì‹¶ìœ¼ë©´ RESPONSES_TOOLSì—ì„œ "strict": Trueë§Œ ë¹¼ë©´ ë¼. ëª¨ë¸Â·ì—”ë“œí¬ì¸íŠ¸Â·í‚¤ëŠ” ìƒë‹¨ MODELSì—ì„œ ì¡°ì • ê°€ëŠ¥í•˜ê³ , samples í´ë”ì— í…ŒìŠ¤íŠ¸ íŒŒì¼ë§Œ ìˆìœ¼ë©´ ë°”ë¡œ ë„¤ ì¡°í•©ì„ ëª¨ë‘ í™•ì¸í•  ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ì•„ë‹ˆ ì˜ˆì‹œë¥¼ ì¢€ ì°¾ì•„ë´.. from openai import OpenAI import json client = OpenAI() # 1. Define a list of callable tools for the model tools = [ { "type": "function", "name": "get_horoscope", "description": "Get today's horoscope for an astrological sign.", "parameters": { "type": "object", "properties": { "sign": { "type": "string", "description": "An astrological sign like Taurus or Aquarius", }, }, "required": ["sign"], }, }, ] def get_horoscope(sign): return f"{sign}: Next Tuesday you will befriend a baby otter." # Create a running input list we will add to over time input_list = [ {"role": "user", "content": "What is my horoscope? I am an Aquarius."} ] # 2. Prompt the model with tools defined response = client.responses.create( model="gpt-5", tools=tools, input=input_list, ) # Save function call outputs for subsequent requests input_list += response.output for item in response.output: if item.type == "function_call": if item.name == "get_horoscope": # 3. Execute the function logic for get_horoscope horoscope = get_horoscope(json.loads(item.arguments)) # 4. Provide function call results to the model input_list.append({ "type": "function_call_output", "call_id": item.call_id, "output": json.dumps({ "horoscope": horoscope }) }) print("Final input:") print(input_list) response = client.responses.create( model="gpt-5", instructions="Respond only with a horoscope generated by a tool.", tools=tools, input=input_list, ) # 5. The model should be able to give a response! print("Final output:") print(response.model_dump_json(indent=2)) print("\n" + response.output_text) ê·¸ëŸ¬ë©´ ì´ 8ê°œ ì¡°í•©ì´ ë‚˜ì˜¤ì§€? ëª¨ë¸ x API íƒ€ì…(completion, responses) x json í˜•íƒœ ì´ 8ê°œ ì¡°í•©ì— ëŒ€í•´ ê°ê° í…ŒìŠ¤íŠ¸í•˜ëŠ” ì½”ë“œë¥¼ ì§œì¤˜ ì´ ë•Œ ì‹¤í–‰ ì¤‘ ì—ëŸ¬ê°€ ë‚˜ëŠ” ê²½ìš°ì—ëŠ” ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ë‚˜ë¨¸ì§€ê°€ ì˜ ìˆ˜í–‰ë˜ê²Œ í•´ì¤˜.

</p>

<p>ì¢‹ì•„. â€œ2ê°œ ëª¨ë¸ Ã— 2ê°œ API(completions, responses) Ã— 2ê°€ì§€ tools JSON í˜•íƒœ(Completions ìŠ¤íƒ€ì¼ vs Responses ìŠ¤íƒ€ì¼)â€ = ì´ 8ê°œ ì¡°í•©ì„ í•œ ë²ˆì— ëŒë ¤ë³´ëŠ” í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤€ë¹„í–ˆì–´. ê° ì¡°í•©ì€ ê°œë³„ try/exceptë¡œ ê°ì‹¸ ì—ëŸ¬ê°€ ë‚˜ë”ë¼ë„ ë‚˜ë¨¸ì§€ê°€ ê³„ì† ìˆ˜í–‰ë¼. tools JSONì€ ë„¤ê°€ ì¤€ Responses ìŠ¤íƒ€ì¼ ì˜ˆì‹œ(í‰í‰í•œ í˜•íƒœ: type/name/parametersê°€ ìµœìƒìœ„)ì™€, Chat Completionsì—ì„œ í”íˆ ì“°ëŠ” ì¤‘ì²© í˜•íƒœ({"type":"function","function":{â€¦}})ë¥¼ ê°ê° ë¶„ë¦¬í•´ ë‘ì—ˆê³ , ì¼ë¶€ ì¡°í•©ì€ ì˜ë„ì ìœ¼ë¡œ â€œë§ì§€ ì•ŠëŠ” í˜•íƒœâ€ë¥¼ ë„£ì—ˆê¸° ë•Œë¬¸ì— ì‹¤íŒ¨í•  ìˆ˜ë„ ìˆì–´(ê·¸ ê²½ìš° ì—ëŸ¬ë§Œ ì¶œë ¥). ì°¸ê³ ë¡œ Responsesì™€ Chat Completionsì˜ ì°¨ì´, strict ì˜µì…˜ ë“±ì€ ìµœì‹  ê°€ì´ë“œì— ì •ë¦¬ë¼ ìˆì–´. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI í”Œë«í¼+2</a></p>

<p>ì•„ë˜ íŒŒì¼ì„ test_8combos_tools.pyë¡œ ì €ì¥í•´ì„œ ì‹¤í–‰í•˜ë©´ ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_8combos_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 0) ëª¨ë¸ ì„¤ì •
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# 1) ë¡œì»¬ íˆ´ êµ¬í˜„
# =========================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ëª¨ë“  íˆ´ì˜ ê²°ê³¼ë¥¼ dictë¡œ í†µì¼í•´ì„œ ë°˜í™˜.
    Responsesì˜ function_call_outputì— ë„£ê¸° ì¢‹ê²Œ {</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="s">: ...} í˜•íƒœë¡œ ê°ì‹¸ì¤€ë‹¤.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">path</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# 2) tools JSON ë‘ ê°€ì§€ í˜•íƒœ
# =========================
</span>
<span class="c1"># (A) Chat Completions ìŠ¤íƒ€ì¼: function í•„ë“œì— ì¤‘ì²©
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># (B) Responses ìŠ¤íƒ€ì¼: ë„¤ê°€ ì¤€ ì˜ˆì‹œì²˜ëŸ¼ í‰í‰í•œ í˜•íƒœ(ì¼ë¶€ ë¬¸ì„œ/ì˜ˆì‹œì—ì„œ ë³´ì´ëŠ” í¬ë§·)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # í•„ìš” ì‹œ ì¼œì„œ ì¸ì ìŠ¤í‚¤ë§ˆ ì¤€ìˆ˜ ê°•ì œ (ë„ì›€ë§ ì°¸ì¡°)
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# 3) Chat Completions ìª½ í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
# =========================
</span>
<span class="k">def</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">  -&gt; CHAT_STYLE_TOOLS ì‚¬ìš© (ê¶Œì¥)
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS ì‚¬ìš© (ì˜ë„ì  ë¹„í˜¸í™˜ ê°€ëŠ¥)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># tool_calls ë£¨í”„
</span>    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="c1"># argumentsëŠ” ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="p">})</span>

        <span class="c1"># ëŒ€í™” ì´ì–´ë¶™ì´ê¸°
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 4) Responses ìª½ í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
# =========================
</span>
<span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì˜ output ë°°ì—´ì—ì„œ function_call / tool_call ë¥˜ ì´ë²¤íŠ¸ë¥¼ ì¶”ì¶œ.
    ë‹¤ì–‘í•œ ì¼€ì´ìŠ¤ë¥¼ ìµœëŒ€í•œ ê´€ëŒ€í•˜ê²Œ ì²˜ë¦¬í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># ì¼€ì´ìŠ¤ A: item.type == "function_call"
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="p">})</span>

        <span class="c1"># ì¼€ì´ìŠ¤ B: ì¼ë¶€ ëª¨ë¸ì´ "tool_call" / item.message.tool_calls í˜•íƒœë¡œ ì¤„ ë•Œ
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS ì‚¬ìš© (ê¶Œì¥)
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">      -&gt; CHAT_STYLE_TOOLS ì‚¬ìš© (ì˜ë„ì  ë¹„í˜¸í™˜ ê°€ëŠ¥)
    ìˆœìˆ˜ Responses ë°©ì‹: ë„¤ê°€ ì¤€ ì˜ˆì‹œ íŒ¨í„´(input_list ì¶•ì  + function_call_output)ë¡œ êµ¬í˜„.
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="c1"># running input_list
</span>    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># function_call ì²˜ë¦¬
</span>    <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="c1"># callë“¤ì„ ì°¾ì•„ ì‹¤í–‰í•˜ê³ , function_call_outputì„ ì´ì–´ ë¶™ì„
</span>    <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="c1"># ìµœì¢… ì‘ë‹µ ì‹œë„(ì§€ì‹œë¬¸ì„ ì¶”ê°€ì ìœ¼ë¡œ ì¤„ ìˆ˜ë„ ìˆìŒ)
</span>    <span class="n">r2</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">Respond with a short summary of what you found.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># í…ìŠ¤íŠ¸ ì¶”ì¶œ(ì¤‘ê°„/ìµœì¢…)
</span>    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">txt1</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt1</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt1</span><span class="p">)</span>
    <span class="n">txt2</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt2</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt2</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 5) 8ê°œ ì¡°í•© ì‹¤í–‰ê¸°
# =========================
</span>
<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ ìš”ì•½. í•„ìš”í•˜ë©´ ë„êµ¬ë¥¼ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools_json=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 8 combinations: 2 models Ã— 2 APIs Ã— 2 tools JSON styles.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># tools_variantë¥¼ "both"ë¡œ ë‘ë©´ ê° APIì—ì„œ chat/â€‹responses ë‘ ê°€ì§€ íˆ´ JSON ëª¨ë‘ ì‹œë„ â†’ 8ì¡°í•©
</span>    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># ìƒ˜í”Œ í´ë” ìƒì„± ì•ˆë‚´
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>

    <span class="c1"># 8ì¡°í•©: 2ëª¨ë¸ Ã— 2API Ã— 2JSON
</span>    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">mk</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‹¤í–‰ ì˜ˆì‹œ<br />
python test_8combos_tools.py<br />
python test_8combos_tools.py â€“apis completions â€“tools both<br />
python test_8combos_tools.py â€“models A â€“apis responses â€“tools responses</p>

<p>í¬ì¸íŠ¸ ìš”ì•½</p>

<ol>
  <li>
    <p>CHAT_STYLE_TOOLSì™€ RESPONSES_STYLE_TOOLSë¥¼ ë¶„ë¦¬í•´ ë‘ì—ˆê³ , Responses ë£¨í”„ëŠ” ë„¤ê°€ ë¶™ì—¬ì¤€ ì˜ˆì‹œì²˜ëŸ¼ input_listì— function_callê³¼ function_call_outputì„ ëˆ„ì í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í–ˆì–´. ì¼ë¶€ ë¬¸ì„œ/ì˜ˆì‹œì—ì„  strictë¥¼ ì¼œ JSON ìŠ¤í‚¤ë§ˆë¥¼ ê°•ì œí•˜ë‹ˆ í•„ìš”í•˜ë©´ í•´ë‹¹ í‚¤ë¥¼ ì¼œë©´ ë¼. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>ì¼ë¶€ ì¡°í•©ì€ ì˜ë„ì ìœ¼ë¡œ í˜¸í™˜ë˜ì§€ ì•Šì•„ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆì–´(ì˜ˆ: Chat Completionsì— Responses ìŠ¤íƒ€ì¼ tools). ëª¨ë“  runì€ try/exceptë¡œ ê°ì‹¸ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ê°€ ì´ì–´ì§„ë‹¤.</p>
  </li>
  <li>
    <p>ìµœì‹  ì°¨ì´ì ê³¼ ê¶Œì¥ íë¦„ì€ Responses vs Chat Completions ê°€ì´ë“œì—ì„œ ë¹„êµ ê°€ëŠ¥í•´. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ol>

<p>ë” ì—„ê²©í•˜ê²Œ Responsesì˜ â€œresponse_id + tool_outputsâ€ ë°©ì‹ìœ¼ë¡œ ì´ì–´ë¶™ì´ëŠ” ë²„ì „ë„ ì›í•˜ë©´ ë”°ë¡œ ì¶”ê°€í•´ì¤„ê²Œ.</p>

<p class="chat--user">

ê°œì„  í•„ìš” ì‚¬í•­ 1. responses apiì—ì„œë„ ì—¬ëŸ¬ ë²ˆ ì½œì„ í•˜ê³  ê° ëŒ€í™”ë¥¼ ë‹¤ ì¶œë ¥í•˜ê³  ì‹¶ì–´. 2. ì…ë ¥ ì „ì²´ë¥¼ ê·¸ëƒ¥ jsonìœ¼ë¡œ ì¶œë ¥í•˜ê³ , ì¶œë ¥ ì „ì²´ë„ ê·¸ëƒ¥ jsonìœ¼ë¡œ ë‹¤ ì €ì¥í•´ì¤˜. ë‹¨, ì½˜ì†” ì¶œë ¥ ìƒ‰ê¹” ì§€ì •ì„ í†µí•´ì„œ (1) ì…ë ¥ (2) íˆ´ ìš”ì²­ (3) ì¶œë ¥ ì´ êµ¬ë¶„ë˜ë©´ ì¢‹ê² ì–´. 3. ì¶”ê°€ì ìœ¼ë¡œ json formatting (structured json)ë„ ì¶”ê°€í•´ì¤˜. structured jsonì´ ìˆëŠ” ë²„ì ¼ê³¼ ì—†ëŠ” ë²„ì ¼ ê°ê° ì¶”ê°€í•´ì£¼ë©´ ì¢‹ê² ì–´. ì´ 16ê°€ì§€ ì¡°í•©ì´ ë  ê±°ì•¼. ê° apiì— ëŒ€í•œ structured formatting ì˜ˆì‹œëŠ” ì•„ë˜ ì½”ë“œë¥¼ ì°¸ê³ í•´ chat completions 
<code class="language-plaintext highlighter-rouge">
from pydantic import BaseModel
from openai import OpenAI

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

completion = client.chat.completions.parse(
    model="gpt-4o-2024-08-06",
    messages=[
        {"role": "system", "content": "Extract the event information."},
        {"role": "user", "content": "Alice and Bob are going to a science fair on Friday."},
    ],
    response_format=CalendarEvent,
)

event = completion.choices[0].message.parsed
</code>

responses 
<code class="language-plaintext highlighter-rouge">
from openai import OpenAI
from pydantic import BaseModel

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

response = client.responses.parse(
    model="gpt-4o-2024-08-06",
    input=[
        {"role": "system", "content": "Extract the event information."},
        {
            "role": "user",
            "content": "Alice and Bob are going to a science fair on Friday.",
        },
    ],
    text_format=CalendarEvent,
)

event = response.output_parsed
</code>

</p>

<p>ì¢‹ì•„, ìš”êµ¬ì‚¬í•­(2ëª¨ë¸ Ã— 2 API íƒ€ì… Ã— 2 Tools JSON ìŠ¤íƒ€ì¼ Ã— 2 Structured í¬ë§· ìœ ë¬´ = 16ì¡°í•©)ì„ ëª¨ë‘ ë§Œì¡±í•˜ëŠ” ë‹¨ì¼ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤€ë¹„í–ˆì–´. ë‹¤ìŒì„ ë³´ì¥í•´.</p>

<ol>
  <li>
    <p>Responses APIì—ì„œ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œ(íˆ´ í˜¸ì¶œ ë°œìƒ ì‹œ ë£¨í”„)í•˜ë©°, ë§¤ ìŠ¤í…ì˜ ëŒ€í™” ì „ê°œë¥¼ ì½˜ì†”ì— ëª¨ë‘ ì¶œë ¥.</p>
  </li>
  <li>
    <p>ê° ì¡°í•©ë§ˆë‹¤ â€œì…ë ¥ ì „ì²´â€ì™€ â€œì¶œë ¥ ì „ì²´â€ë¥¼ JSONìœ¼ë¡œ íŒŒì¼ë¡œ ì €ì¥. ì½˜ì†”ì—ì„  ìƒ‰ìƒìœ¼ë¡œ (ì…ë ¥ / íˆ´ìš”ì²­ / ì¶œë ¥) êµ¬ë¶„.</p>
  </li>
  <li>
    <p>Structured JSON íŒŒì‹± ë²„ì „ê³¼ ì¼ë°˜ ë²„ì „ ê°ê° ì œê³µ.</p>
  </li>
  <li>
    <p>ì—ëŸ¬ëŠ” ì¡°í•©ë³„ë¡œ try/exceptë¡œ ê³ ë¦½ ì²˜ë¦¬í•˜ì—¬, ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ì¡°í•© ê³„ì† ì‹¤í–‰.</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œë¥¼ test_16combos.pyë¡œ ì €ì¥í•´ì„œ ì‹¤í–‰í•´. samples í´ë”ì— í…ìŠ¤íŠ¸ íŒŒì¼ ëª‡ ê°œ ë‘ë©´ íˆ´ ë™ì‘ì„ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆì–´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# ANSI ìƒ‰ìƒ ìœ í‹¸
# =========================
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># ì…ë ¥
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># íˆ´ ìš”ì²­/íˆ´ ì¶œë ¥
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># ëª¨ë¸ ì¶œë ¥
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># ì—ëŸ¬
</span>
<span class="c1"># =========================
# ëª¨ë¸/ì—”ë“œí¬ì¸íŠ¸/í‚¤ ì„¤ì •
# =========================
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# ë¡œì»¬ íˆ´ êµ¬í˜„
# =========================
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# Tools JSON 2ê°€ì§€ ìŠ¤íƒ€ì¼
# =========================
# Chat Completions ìŠ¤íƒ€ì¼ (function í•„ë“œ ì¤‘ì²©)
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses ìŠ¤íƒ€ì¼ (í‰í‰í•œ í˜•íƒœ; ì¼ë¶€ ì˜ˆì‹œ í¬ë§·)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # í•„ìš” ì‹œ í™œì„±í™”
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# Structured JSON í¬ë§·ìš© Pydantic
# =========================
</span><span class="k">class</span> <span class="nc">FileTaskResult</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chosen_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># =========================
# ê³µí†µ: ì¶œë ¥/ì €ì¥ í—¬í¼
# =========================
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Chat Completions ëŸ¬ë„ˆ (plain/structured)
# =========================
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="c1"># ëŒ€í™” ì‹œì‘
</span>    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># ì…ë ¥/ì¶œë ¥ ì „ì²´ ì €ì¥ì„ ìœ„í•œ êµ¬ì¡°
</span>    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: parse() ì‚¬ìš©
</span>        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># function calling ë£¨í”„ (parse ê²°ê³¼ì—ì„œë„ tool_calls ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì‹œë„)
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># ìµœì¢… êµ¬ì¡°í™” ê²°ê³¼
</span>        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FileTaskResult</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_to_print</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">:</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat Completions, structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_to_print</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: create() ì‚¬ìš©
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat Completions, plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># íŒŒì¼ ì €ì¥
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# Responses ëŸ¬ë„ˆ (plain/structured)
# - ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•˜ë©° ë§¤ ìŠ¤í… ì¶œë ¥
# =========================
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>

        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: responses.parse(text_format=...)
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># íˆ´ í˜¸ì¶œ íƒì§€ â†’ ì‹¤í–‰ â†’ function_call_output ì¶”ê°€ â†’ ì´ì–´ì„œ ë˜ parse
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># ìµœì¢… íŒŒì‹± ê²°ê³¼
</span>        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: responses.create()
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="c1"># function_call_outputì„ inputì— ëˆ„ì 
</span>                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># ë‹¤ìŒ í„´
</span>            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="c1"># íŒŒì¼ ì €ì¥
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# 16ê°œ ì¡°í•© ì‹¤í–‰ê¸°
#   2 ëª¨ë¸ Ã— 2 API Ã— 2 Tools JSON Ã— 2 Structured
# =========================
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span>
    <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">combo_label</span> <span class="o">=</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">combo_label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="c1"># ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ê³„ì†
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos: 2 models Ã— 2 APIs Ã— 2 Tools JSON Ã— 2 Structured.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš©ë²• ìš”ì•½</p>

<ol>
  <li>í™˜ê²½ ë³€ìˆ˜ ì„¤ì •(ì˜ˆì‹œ)</li>
</ol>

<ul>
  <li>
    <p>ëª¨ë¸ A:<br />
OPENAI_API_KEY_A, OPENAI_BASE_URL_A=https://api.openai.com/v1, MODEL_A_NAME</p>
  </li>
  <li>
    <p>ëª¨ë¸ B:<br />
OPENAI_API_KEY_B, OPENAI_BASE_URL_B=https://api.openai.com/v1, MODEL_B_NAME</p>
  </li>
</ul>

<ol>
  <li>
    <p>ìƒ˜í”Œ ì¤€ë¹„<br />
í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— samples í´ë”ë¥¼ ë§Œë“¤ê³  í…ìŠ¤íŠ¸ íŒŒì¼ì„ 1ê°œ ì´ìƒ ë„£ì–´ë‘”ë‹¤.</p>
  </li>
  <li>
    <p>ì‹¤í–‰ ì˜ˆì‹œ</p>
  </li>
</ol>

<ul>
  <li>
    <p>16ê°œ ì „ì²´ ì¡°í•© ì‹¤í–‰<br />
python test_16combos.py</p>
  </li>
  <li>
    <p>Responsesë§Œ, structured/plain ë‘˜ ë‹¤, toolsëŠ” responses ìŠ¤íƒ€ì¼ë§Œ<br />
python test_16combos.py â€“apis responses â€“tools responses â€“structured both</p>
  </li>
  <li>
    <p>ëª¨ë¸ Aë§Œ, Chat Completionsë§Œ, structuredë§Œ<br />
python test_16combos.py â€“models A â€“apis completions â€“structured on</p>
  </li>
</ul>

<p>ë™ì‘ ì •ë¦¬</p>

<ul>
  <li>
    <p>ì½˜ì†” ìƒ‰ìƒìœ¼ë¡œ ì…ë ¥(ì²­ë¡), íˆ´ ìš”ì²­(ë…¸ë‘), ì¶œë ¥(ì´ˆë¡)ì„ êµ¬ë¶„.</p>
  </li>
  <li>
    <p>ê° ì¡°í•©ì€ runs/íƒ€ì„ìŠ¤íƒ¬í”„/ëª¨ë¸_API_tools_structured/ ì•„ë˜ì— input.json, outputs.json ì €ì¥.</p>
  </li>
  <li>
    <p>Responses APIëŠ” íˆ´ í˜¸ì¶œì´ ê³„ì† ë‚˜ì˜¤ë©´ ë£¨í”„ë¥¼ ë°˜ë³µí•˜ê³  ë§¤ ìŠ¤í… ì¶œë ¥ ë° ëˆ„ì  ì €ì¥.</p>
  </li>
  <li>
    <p>Structured ëª¨ë“œì—ì„  chat.completions.parse / responses.parseë¥¼ ì‚¬ìš©í•´ Pydantic ëª¨ë¸(FileTaskResult)ë¡œ ê²°ê³¼ë¥¼ íŒŒì‹±í•´ ë³„ë„ ìš”ì•½ë„ ì½˜ì†”ì— í‘œì‹œ.</p>
  </li>
</ul>

<p>ì›í•˜ëŠ” ì¶”ê°€ í¬ë§·(ì˜ˆ: íŒŒì¼ëª… ê·œì¹™, ë” ìì„¸í•œ ë¡œê¹…, strict ì˜µì…˜ ìƒì‹œ on ë“±)ì´ ìˆìœ¼ë©´ ì•Œë ¤ì¤˜.</p>

<p class="chat--user">

ì¶œë ¥ json í¬ë§·ì€ taskì—ì„œ ìš”ì²­í•œ ê±¸ ëŒ€ë‹µí•  ìˆ˜ ìˆê²Œ í•´ì£¼ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„. ì˜ˆë¥¼ ë“¤ì–´ filename: íŒŒì¼ëª… contents: ë‚´ìš© 

</p>

<p>ì¢‹ì•„! â€œê²°ê³¼ JSON í¬ë§·ì„ taskì— ë°”ë¡œ ì“°ì´ê²Œ(filename, contents)â€ë¡œ ë§ì¶˜ ë²„ì „ì„ ì•„ë˜ì²˜ëŸ¼ ì—…ë°ì´íŠ¸í–ˆì–´. í•µì‹¬ì€ structured ëª¨ë“œì—ì„œ íŒŒì‹± ëª¨ë¸ì„ <code class="language-plaintext highlighter-rouge">{"filename": str, "contents": str}</code>ë¡œ ê³ ì •í•˜ê³ , ëª¨ë¸ì—ê²Œ â€œcontentsì—ëŠ” ìš”ì•½ì„ ë„£ì–´ë¼â€ë¼ê³  ì§€ì‹œí•˜ëŠ” ê²ƒ. plain ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ ê·¸ëŒ€ë¡œ ììœ  í…ìŠ¤íŠ¸ë¥¼ ì¶œë ¥í•˜ê³  ì „ì²´ ì›ì‹œ JSON ë¡œê·¸ë§Œ ì €ì¥í•˜ë©°, structured ëª¨ë“œì—ì„œëŠ” ì¶”ê°€ë¡œ <code class="language-plaintext highlighter-rouge">result.json</code>ì— <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>ë¥¼ ì €ì¥í•´.</p>

<p>ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ì „ 16ì¡°í•© ì‹¤í–‰ê¸°(test_16combos.py)ë¥¼ ëŒ€ì²´í•˜ëŠ” ì™„ì „íŒì´ì•¼. ë°”ë€ ì ë§Œ ë¹ ë¥´ê²Œ ìš”ì•½í•˜ê³  ë°”ë¡œ ì½”ë“œ ì¤„ê²Œ.</p>

<p>ë³€ê²½ ìš”ì•½</p>

<ol>
  <li>Structured íŒŒì‹± ëª¨ë¸ êµì²´</li>
</ol>

<ul>
  <li>
    <p>Pydantic ëª¨ë¸ì„ <code class="language-plaintext highlighter-rouge">TaskAnswer</code>ë¡œ ì •ì˜í•˜ê³  í•„ë“œë¥¼ filename, contents ë‘ ê°œë¡œ í†µì¼.</p>
  </li>
  <li>
    <p>contentsëŠ” â€œì½ì€ íŒŒì¼ì˜ 2~3ë¬¸ì¥ ìš”ì•½â€ì„ ë„£ë„ë¡ system/instructionsì— ëª…í™•íˆ ì§€ì‹œ.</p>
  </li>
</ul>

<ol>
  <li>Structured ëª¨ë“œì—ì„œ ê²°ê³¼ JSON ì €ì¥</li>
</ol>

<ul>
  <li>
    <p>ê° ì¡°í•© í´ë”ì— <code class="language-plaintext highlighter-rouge">result.json</code>ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code> ì €ì¥.</p>
  </li>
  <li>
    <p>ê¸°ì¡´ì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>ë„ ê³„ì† ì €ì¥.</p>
  </li>
</ul>

<ol>
  <li>ì½˜ì†” ìƒ‰ìƒ ì¶œë ¥ì€ ë™ì¼í•˜ê²Œ ìœ ì§€</li>
</ol>

<ul>
  <li>ì…ë ¥(CYAN), íˆ´ ìš”ì²­(YELLOW), ì¶œë ¥(GREEN)ìœ¼ë¡œ êµ¬ë¶„.</li>
</ul>

<ol>
  <li>Responses APIëŠ” ë‹¤ë‹¨ í˜¸ì¶œ ìœ ì§€</li>
</ol>

<ul>
  <li>ê° stepì˜ ì¶œë ¥ê³¼ íˆ´ ìš”ì²­ì„ ëª¨ë‘ ì½˜ì†”ì— í‘œì‹œí•˜ê³ , outputs.jsonì— ëˆ„ì  ì €ì¥.</li>
</ul>

<p>ì½”ë“œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos_v2.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI ìƒ‰ìƒ =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># ì…ë ¥
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># íˆ´ ìš”ì²­/íˆ´ ì¶œë ¥
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># ëª¨ë¸ ì¶œë ¥
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># ì—ëŸ¬
</span>
<span class="c1"># ===== ëª¨ë¸ ì„¤ì • =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== ë¡œì»¬ íˆ´ êµ¬í˜„ =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON 2ê°€ì§€ =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON ìŠ¤í‚¤ë§ˆ =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># ì„ íƒëœ íŒŒì¼ì˜ 2~3ë¬¸ì¥ ìš”ì•½(ëª¨ë¸ì´ ìƒì„±)
</span>
<span class="c1"># ===== ìœ í‹¸ =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># ===== Chat Completions ëŸ¬ë„ˆ =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If using structured output, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskAnswer</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses ëŸ¬ë„ˆ =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If structured parsing is enabled, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== 16ê°œ ì¡°í•© ì‹¤í–‰ê¸° =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>  <span class="c1"># ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ê³„ì†
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos with JSON result format {filename, contents}.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© í¬ì¸íŠ¸</p>

<ul>
  <li>
    <p>structured ëª¨ë“œì¼ ë•Œë§Œ <code class="language-plaintext highlighter-rouge">result.json</code>ì„ ìƒì„±í•˜ë©° ë‚´ìš©ì€ ë°˜ë“œì‹œ <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>ë¡œ ì €ì¥ë¼.</p>
  </li>
  <li>
    <p>contentsì—ëŠ” â€œì„ íƒí•œ íŒŒì¼ì˜ 2~3ë¬¸ì¥ ìš”ì•½â€ì´ ë“¤ì–´ê°€ë„ë¡ ì‹œìŠ¤í…œ ë©”ì‹œì§€ì—ì„œ ê°•ì œí–ˆì–´.</p>
  </li>
  <li>
    <p>plain ëª¨ë“œì—ì„  ììœ  í˜•ì‹ ì¶œë ¥ì´ì§€ë§Œ, ì…ë ¥ê³¼ ëª¨ë“  ì›ì‹œ ì‘ë‹µì€ <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>ë¡œ ì €ì¥ë¼.</p>
  </li>
  <li>
    <p>ê° ë‹¨ê³„ì˜ ì½˜ì†” ì¶œë ¥ì€ ìƒ‰ìƒìœ¼ë¡œ êµ¬ë¶„ë¼ì„œ ì…ë ¥/íˆ´ìš”ì²­/ì¶œë ¥ì´ í•œëˆˆì— ë³´ì—¬.</p>
  </li>
</ul>

<p>ì›í•˜ë©´ contentsë¥¼ â€œíŒŒì¼ ì „ë¬¸â€ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì˜µì…˜ ìŠ¤ìœ„ì¹˜ë„ ì¶”ê°€í•´ì¤„ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

Completions(structured)ì—ì„œ ValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.

</p>

<p>ì¢‹ì€ í”¼ë“œë°±ì´ì•¼. ì—ëŸ¬ ì›ì¸ì€ chat.completions.parseë¥¼ ì‚¬ìš©í•  ë•Œ íˆ´ì´ strict ëª¨ë“œê°€ ì•„ë‹ˆë©´ ìë™ íŒŒì‹±ì´ ë¶ˆê°€ëŠ¥í•´ì„œì•¼. ì¦‰, structured ëª¨ë“œì—ì„œ í•¨ìˆ˜ íˆ´ ì •ì˜ì— strict=Trueê°€ ë°˜ë“œì‹œ ë“¤ì–´ê°€ì•¼ í•´.</p>

<p>ìˆ˜ì • ë°©í–¥ ìš”ì•½ ë‹¨ê³„ë³„</p>

<ol>
  <li>
    <p>tools_variantì™€ structured ì—¬ë¶€ì— ë”°ë¼ íˆ´ JSONì— strictë¥¼ ì£¼ì…í•˜ëŠ” í—¬í¼ë¥¼ ë§Œë“ ë‹¤.</p>
  </li>
  <li>
    <p>Chat ìŠ¤íƒ€ì¼ì¼ ë• tool["function"]["strict"]=True, Responses ìŠ¤íƒ€ì¼ì¼ ë• tool["strict"]=Trueë¥¼ ë„£ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>run_chat / run_responsesì—ì„œ ê¸°ì¡´ ì •ì  TOOLS ëŒ€ì‹  ì´ í—¬í¼ë¡œ ë°˜í™˜ëœ íˆ´ì„ ì‚¬ìš©í•œë‹¤.</p>
  </li>
</ol>

<p>ì•„ë˜ ë³€ê²½ë§Œ ì ìš©í•˜ë©´ ë¼. ë‚˜ë¨¸ì§€ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ë‘¬ë„ ë™ì‘í•œë‹¤.</p>

<p>ì¶”ê°€ í•¨ìˆ˜ ë° ë³€ê²½ì </p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">copy</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">'</span><span class="s">chat</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'</span><span class="s">
    structuredê°€ Trueë©´ strict í”Œë˜ê·¸ë¥¼ ì£¼ì…í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># Chat ìŠ¤íƒ€ì¼: "function" ë¸”ë¡ ì•ˆì— strict
</span>        <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Responses ìŠ¤íƒ€ì¼: ìµœìƒìœ„ì— strict
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></div>

<p>run_chat ë‚´ë¶€ì—ì„œ íˆ´ ì„ íƒ ë¶€ë¶„ êµì²´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´
# tools = CHAT_STYLE_TOOLS if tools_variant == "chat" else RESPONSES_STYLE_TOOLS
# ë³€ê²½
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>run_responses ë‚´ë¶€ì—ì„œë„ ë™ì¼í•˜ê²Œ êµì²´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´
# tools = RESPONSES_STYLE_TOOLS if tools_variant == "responses" else CHAT_STYLE_TOOLS
# ë³€ê²½
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>ì¶”ê°€ ì°¸ê³ </p>

<ul>
  <li>
    <p>ì´ ë³€ê²½ìœ¼ë¡œ Completions(structured) ë¿ë§Œ ì•„ë‹ˆë¼ Responses(structured)ì—ì„œë„ ì¼ê´€ë˜ê²Œ ì—„ê²© íŒŒì‹±ì´ ë³´ì¥ë¼.</p>
  </li>
  <li>
    <p>plain ëª¨ë“œì—ì„  strictê°€ ì—†ì–´ë„ ë˜ì§€ë§Œ, ìœ„ í—¬í¼ëŠ” structuredì¼ ë•Œë§Œ strictë¥¼ ì£¼ì…í•˜ë¯€ë¡œ ê¸°ì¡´ ë™ì‘ì„ í•´ì¹˜ì§€ ì•Šì•„.</p>
  </li>
  <li>
    <p>tools JSONì„ ë™ì ìœ¼ë¡œ ì£¼ì…í•˜ë¯€ë¡œ, ìƒˆ í•¨ìˆ˜ë§Œ ì¶”ê°€í•˜ê³  ë‘ ê³³ í˜¸ì¶œë¶€ë§Œ ë°”ê¾¸ë©´ ëë‚˜.</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œ ìˆ˜ì •í•˜ë©´ â€œValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.â€ ì—ëŸ¬ëŠ” ì‚¬ë¼ì§€ê³  16ê°œ ì¡°í•© ëª¨ë‘ ì •ìƒì ìœ¼ë¡œ ìˆœíšŒí•  ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ê·¸ë˜ë„ ê³„ì† ì—ëŸ¬ê°€ ë‚˜ë„¤. ì¼ë‹¨ ë„˜ì–´ê°€ê³  json schemeì„ ì§€ì •í•˜ëŠ” ë°©ì‹ì€ ë™ì‘ì„ ì˜ ì•ˆí•˜ë„¤ ì¼ë°˜ json ëª¨ë“œë¥¼ ì¼œë³´ê³  ì‹¶ì–´. ì´ 3ê°€ì§€ sweep(no structured, json_mode, structured)ë¡œ ì‹¤í—˜í•´ë³´ì. ì˜ˆì‹œ responses 
<code class="language-plaintext highlighter-rouge">
we_did_not_specify_stop_tokens = True

try:
    response = client.responses.create(
        model="gpt-3.5-turbo-0125",
        input=[
            {"role": "system", "content": "You are a helpful assistant designed to output JSON."},
            {"role": "user", "content": "Who won the world series in 2020? Please respond in the format {winner: ...}"}
        ],
        text={"format": {"type": "json_object"}}
    )

    # Check if the conversation was too long for the context window, resulting in incomplete JSON 
    if response.status == "incomplete" and response.incomplete_details.reason == "max_output_tokens":
        # your code should handle this error case
        pass

    # Check if the OpenAI safety system refused the request and generated a refusal instead
    if response.output[0].content[0].type == "refusal":
        # your code should handle this error case
        # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing
        print(response.output[0].content[0]["refusal"])

    # Check if the model's output included restricted content, so the generation of JSON was halted and may be partial
    if response.status == "incomplete" and response.incomplete_details.reason == "content_filter":
        # your code should handle this error case
        pass

    if response.status == "completed":
        # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a "stop token"

        if we_did_not_specify_stop_tokens:
            # If you didn't specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object
            # This will parse successfully and should now contain  "{"winner": "Los Angeles Dodgers"}"
            print(response.output_text)
        else:
            # Check if the response.output_text ends with one of your stop tokens and handle appropriately
            pass
except Exception as e:
    # Your code should handle errors here, for example a network error calling the API
    print(e)
</code>

completions 
<code class="language-plaintext highlighter-rouge">
response = client.chat.completions.create(
  model="gpt-4-1106-preview",
  messages=[
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "LangChainì€ ë¬´ì—‡ì„ í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì§€? JSONìœ¼ë¡œ ë‹µí•´ì¤˜. JSON í‚¤ì›Œë“œëŠ” Description, Features, Usageë¡œ í•´ì¤˜."}
  ],
  response_format = {'type':"json_object"}
)
</code>

</p>

<p>ì¢‹ì•„. strict ê¸°ë°˜ì˜ JSON Schema íŒŒì‹±ì€ ì ‘ê³ , ì„¸ ëª¨ë“œë¡œ ìŠ¤ìœ•í•˜ë„ë¡ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í–ˆì–´.</p>

<p>ìŠ¤ìœ• ì¶•: 2ëª¨ë¸ Ã— 2 API(completions/responses) Ã— 2 Tools JSON(chat-style/responses-style) Ã— 3 ëª¨ë“œ(plain, json_mode, structured) = ì´ 24ì¡°í•©.</p>

<p>í•µì‹¬</p>

<ul>
  <li>
    <p>plain: ììœ  ì¶œë ¥. ì „ì²´ ì…ë ¥/ì¶œë ¥ ì›ë³¸ JSONì„ ì €ì¥.</p>
  </li>
  <li>
    <p>json_mode: ëª¨ë¸ì—ê²Œ â€œë¬´ì¡°ê±´ JSONâ€ì„ ìš”êµ¬. ì¶œë ¥ì€ {"filename","contents"} í˜•ì‹. ì €ì¥ ì‹œ result.json ìƒì„±.</p>

    <ul>
      <li>
        <p>Chat Completions: response_format={'type': 'json_object'}</p>
      </li>
      <li>
        <p>Responses: text={"format":{"type":"json_object"}}</p>
      </li>
    </ul>
  </li>
  <li>
    <p>structured: ì´ì „ì²˜ëŸ¼ parse ì‚¬ìš©. ì—¬ì „íˆ ëª¨ë¸/SDKì— ë”°ë¼ strict ìš”êµ¬ë¡œ ì‹¤íŒ¨í•  ìˆ˜ë„ ìˆìœ¼ë‹ˆ try/exceptë¡œ ê²©ë¦¬. ì„±ê³µ ì‹œ result.json ìƒì„±.</p>
  </li>
  <li>
    <p>Responses APIëŠ” íˆ´ í˜¸ì¶œì´ ë‚˜ì˜¤ë©´ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œë˜ë©° ë§¤ ìŠ¤í… ì½˜ì†” ì¶œë ¥. ì½˜ì†”ì€ ìƒ‰ìƒìœ¼ë¡œ ì…ë ¥(CYAN), íˆ´ ìš”ì²­(YELLOW), ì¶œë ¥(GREEN) êµ¬ë¶„.</p>
  </li>
  <li>
    <p>ëª¨ë“  ì¡°í•©ì€ runs/íƒ€ì„ìŠ¤íƒ¬í”„/ëª¨ë¸_API_tools_mode/ í´ë”ì— input.json, outputs.json ì €ì¥. json_mode/structuredëŠ” result.json ì¶”ê°€ ì €ì¥.</p>
  </li>
  <li>
    <p>ì—ëŸ¬ëŠ” ì¡°í•©ë³„ë¡œë§Œ ì¶œë ¥í•˜ê³  ë‚˜ë¨¸ì§€ ê³„ì† ì§„í–‰.</p>
  </li>
</ul>

<p>ì½”ë“œ: test_24combos.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_24combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI colors =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># input
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># tool
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># output
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># error
</span>
<span class="c1"># ===== Model configs =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== Local tools =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON (two shapes) =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON schema (optional) =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># ===== Helpers =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="c1"># structuredì—ì„œ strict ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ ì—¬ê¸°ì„  strict ì£¼ì…ì„ ë”
</span>    <span class="c1"># (structuredëŠ” parse() ì‚¬ìš© ì‹œ ì—¬ì „íˆ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ try/exceptë¡œ ê°ì‹¼ë‹¤)
</span>    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="k">return</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

<span class="c1"># ===== Common parsing for Responses =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># ===== Chat Completions runner =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">When asked to answer in JSON, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                    <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                    <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

                <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Chat structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Force JSON output
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># Try to parse JSON
</span>        <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses runner =====
</span><span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If JSON is requested, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                    <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                    <span class="p">})</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Responses structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># Try to parse JSON text
</span>        <span class="n">result_text</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">result_text</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== 24-combo driver =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">ê°€ëŠ¥í•˜ë‹¤ë©´ JSONìœ¼ë¡œ {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string} í˜•íƒœë¡œ ë‹µí•´ì¤˜.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 24 combos: 2 models Ã— 2 APIs Ã— 2 tool JSONs Ã— 3 modes.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--modes</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">mode_list</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">modes</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">modes</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">mode_list</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© íŒ</p>

<ul>
  <li>
    <p>json_modeê°€ ê°€ì¥ ì•ˆì •ì ìœ¼ë¡œ {"filename","contents"}ë¥¼ ë±‰ì–´ ì¤„ ê±°ì•¼. structuredëŠ” SDK/ëª¨ë¸ì˜ strict ì •ì±…ì— ë”°ë¼ ì—¬ì „íˆ ì‹¤íŒ¨í•  ìˆ˜ ìˆì§€ë§Œ, ìŠ¤í¬ë¦½íŠ¸ëŠ” ê°œë³„ ì¡°í•©ë³„ë¡œ ì—ëŸ¬ë¥¼ ì‚¼í‚¤ê³  ê³„ì† ì§„í–‰í•œë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë“  ì¡°í•©ì˜ ì…ë ¥/ì¶œë ¥(raw)ì„ ì €ì¥í•´ì„œ ë¦¬ê·¸ë ˆì…˜ ë¹„êµê°€ ê°€ëŠ¥í•´. json_mode/structuredëŠ” result.jsonì„ ë”°ë¡œ ì €ì¥í•˜ë¯€ë¡œ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´.</p>
  </li>
  <li>
    <p>í•„ìš”í•˜ë©´ system ë©”ì‹œì§€ì˜ ì§€ì‹œë¥¼ ìˆ˜ì •í•´ì„œ contentsì— â€œìš”ì•½â€ ëŒ€ì‹  â€œì›ë¬¸ ì „ì²´â€ë¥¼ ë„£ë„ë¡ ë°”ê¿€ ìˆ˜ë„ ìˆì–´.</p>
  </li>
</ul>

<p class="chat--user">

ë‘˜ ë‹¤ json ê´€ë ¨ í¬ë§¤íŒ…ì€ ì˜ ì•ˆë¨¹íˆë„¤ ì¼ë‹¨ ì¼ë°˜ í…ìŠ¤íŠ¸ ì¶œë ¥ë§Œ ìƒê°í•˜ì. ì´ì œ ì†Œí”„íŠ¸ì›¨ì–´ ì•„í‚¤í…íŠ¸ ë””ìì¸ ì¸¡ë©´ì—ì„œ í•œ ë²ˆ ë³´ì. ì¡°í•© 1. GPT OSS + responses í˜•ì‹ call + ì‹ ê·œ tool json í˜•ì‹ ì¡°í•© 2. Qwen + completions í˜•ì‹ call + ê³¼ê±° tool json í˜•ì‹ ì´ê±°ì•¼. ê·¸ëŸ°ë° ë‚˜ëŠ” ì‚¬ìš©ìê°€ ì¼ì¢…ì˜ ì½¤ë³´ ë°•ìŠ¤ë¡œ GPT OSSë¥¼ ì“¸ ê²ƒì¸ì§€, Qwenì„ ì“¸ ê²ƒì¸ì§€ ì„ íƒí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ê·¸ ë•Œ ê·¸ ë•Œ ì˜ ë™ì‘í•˜ê²Œ í•˜ê³  ì‹¶ì–´. ë­”ê°€ ë””ìì¸ íŒ¨í„´ì ì¸ ê²ƒì„ ì¨ì„œ ê¹”ë”í•˜ê²Œ ì´ë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì´ ìˆì„ê¹Œ? function call toolë„ ì–´ë–¤ ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ë©´ ì¢‹ì„ê¹Œ íŒŒì´ì¬ ê³ ìˆ˜ì˜ ì…ì¥ì—ì„œ ì´ëŸ° ì ì„ ê³ ë ¤í•´ì„œ ê¹”ë”í•œ ì½”ë“œ ë§Œë“¤ì–´ì¤˜.

</p>

<p>ì¢‹ì•„. ìš”êµ¬ ì¡°í•©ê³¼ ì‚¬ìš©ì„±(ì½¤ë³´ë°•ìŠ¤ë¡œ ì—”ì§„ ì„ íƒ)ê¹Œì§€ ê³ ë ¤í•´ì„œ â€œì „ëµ(Strategy) + íˆ´ ìŠ¤í‚¤ë§ˆ ë¹Œë”(Factory) + ë ˆì§€ìŠ¤íŠ¸ë¦¬ + ì–´ëŒ‘í„°â€ ì¡°í•©ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì„¤ê³„í•œ íŒŒì´ì¬ ì˜ˆì‹œë¥¼ ì¤„ê²Œ.</p>

<p>í•µì‹¬ ì•„ì´ë””ì–´ ìš”ì•½(ê°„ê²°):</p>

<ol>
  <li>Strategy íŒ¨í„´: ì„œë¡œ ë‹¤ë¥¸ í˜¸ì¶œ ë°©ì‹ ì°¨ì´ë¥¼ ìº¡ìŠí™”</li>
</ol>

<ul>
  <li>
    <p>ResponsesStrategy(GPT OSS, responses í˜¸ì¶œ, â€œì‹ ê·œ/í‰í‰í•œâ€ tool JSON)</p>
  </li>
  <li>
    <p>CompletionsStrategy(Qwen, chat.completions í˜¸ì¶œ, â€œê³¼ê±°/ì¤‘ì²©â€ tool JSON)</p>
  </li>
</ul>

<ol>
  <li>ToolRegistry + ToolSchemaBuilder(Factory):</li>
</ol>

<ul>
  <li>
    <p>ToolRegistryëŠ” íŒŒì´ì¬ í•¨ìˆ˜ë¥¼ ë“±ë¡/ì‹¤í–‰</p>
  </li>
  <li>
    <p>ToolSchemaBuilderê°€ ë“±ë¡ëœ íˆ´ì„ ê° ì—”ì§„ì´ ìš”êµ¬í•˜ëŠ” JSON ëª¨ì–‘ìœ¼ë¡œ ë³€í™˜</p>

    <ul>
      <li>
        <p>NewToolJSONBuilder: responsesìš© flat JSON</p>
      </li>
      <li>
        <p>OldToolJSONBuilder: completionsìš© nested JSON</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>Output ì–´ëŒ‘í„°(ë‹¨ìˆœí™”):</li>
</ol>

<ul>
  <li>ë‘ ì „ëµì€ ëª¨ë‘ ìµœì¢…ì ìœ¼ë¡œ strì„ ë°˜í™˜. ë‚´ë¶€ì˜ tool_call íŒŒì‹± ì°¨ì´ëŠ” ì „ëµì—ì„œ ìˆ¨ê¹€.</li>
</ul>

<ol>
  <li>ì„¤ì • ì£¼ì…:</li>
</ol>

<ul>
  <li>ì—”ë“œí¬ì¸íŠ¸Â·API í‚¤Â·ëª¨ë¸ëª…ì„ configë¡œ ì£¼ì….</li>
</ul>

<p>ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ì¼ íŒŒì¼ ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># arch_combo_clean.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# Config &amp; DTO
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RunConfig</span><span class="p">:</span>
    <span class="n">engine</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "gpt-oss" | "qwen"
</span>    <span class="n">task</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">samples_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span>

<span class="c1"># =========================
# Tool layer
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON schema for parameters
</span>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># executes with parsed args
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># =========================
# Tool JSON schema builders (Factory)
# =========================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">NewToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì—ì„œ ìì£¼ ë³´ì´ëŠ” </span><span class="sh">'</span><span class="s">í‰í‰í•œ(flat)</span><span class="sh">'</span><span class="s"> íˆ´ ì •ì˜
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

<span class="k">class</span> <span class="nc">OldToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chat Completions APIì—ì„œ ìì£¼ ë³´ì´ëŠ” </span><span class="sh">'</span><span class="s">ì¤‘ì²©(nested)</span><span class="sh">'</span><span class="s"> íˆ´ ì •ì˜
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{ </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} } }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># =========================
# Strategy layer
# =========================
</span>
<span class="k">class</span> <span class="nc">EngineStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="c1"># ---- GPT OSS + Responses Strategy ----
</span>
<span class="k">class</span> <span class="nc">ResponsesStrategy</span><span class="p">(</span><span class="n">EngineStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    - responses.create ì‚¬ìš©
    - íˆ´ ì •ì˜: NewToolJSONBuilder(flat)
    - function_call â†’ ë¡œì»¬ íˆ´ ì‹¤í–‰ â†’ function_call_outputë¥¼ inputì— append â†’ ë‹¤ì‹œ responses.create
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>

        <span class="c1"># ì²« í˜¸ì¶œ
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ëˆ„ì  í…ìŠ¤íŠ¸ì™€ ë£¨í”„
</span>        <span class="n">final_text_chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># ì¶œë ¥ í…ìŠ¤íŠ¸ ìˆ˜ì§‘
</span>            <span class="n">final_text_chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

            <span class="c1"># íˆ´ í˜¸ì¶œ ìˆ˜ì§‘
</span>            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># íˆ´ ì‹¤í–‰ â†’ function_call_output ì¶”ê°€
</span>            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># ë‹¤ìŒ í„´
</span>            <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text_chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="c1"># Helpers
</span>    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">calls</span>

<span class="c1"># ---- Qwen + Chat Completions Strategy ----
</span>
<span class="k">class</span> <span class="nc">CompletionsStrategy</span><span class="p">(</span><span class="n">EngineStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    - chat.completions.create ì‚¬ìš©
    - íˆ´ ì •ì˜: OldToolJSONBuilder(nested)
    - assistant.tool_calls â†’ ë¡œì»¬ íˆ´ ì‹¤í–‰ â†’ tool ë©”ì‹œì§€ ì²¨ë¶€ â†’ ë‹¤ì‹œ completions
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">final_text_chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">final_text_chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text_chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Tool implementations
# =========================
</span>
<span class="k">def</span> <span class="nf">list_files_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_registry</span><span class="p">(</span><span class="n">samples_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_tool</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_tool</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># =========================
# Engine factory / selector
# =========================
</span>
<span class="k">def</span> <span class="nf">make_engine</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EngineStrategy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì½¤ë³´ë°•ìŠ¤ì—ì„œ </span><span class="sh">'</span><span class="s">gpt-oss</span><span class="sh">'</span><span class="s"> ë˜ëŠ” </span><span class="sh">'</span><span class="s">qwen</span><span class="sh">'</span><span class="s">ì„ ì„ íƒí•˜ë©´,
    ë‚´ë¶€ì ìœ¼ë¡œ ì•Œë§ì€ Strategy + ToolJSONBuilderë¥¼ êµ¬ì„±í•´ì„œ ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">engine</span> <span class="o">==</span> <span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Responses + New(flat) tool JSON
</span>        <span class="k">return</span> <span class="nc">ResponsesStrategy</span><span class="p">(</span><span class="n">model_cfg</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="nc">NewToolJSONBuilder</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">engine</span> <span class="o">==</span> <span class="sh">"</span><span class="s">qwen</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Completions + Old(nested) tool JSON
</span>        <span class="k">return</span> <span class="nc">CompletionsStrategy</span><span class="p">(</span><span class="n">model_cfg</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="nc">OldToolJSONBuilder</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Unknown engine. Choose </span><span class="sh">'</span><span class="s">gpt-oss</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">qwen</span><span class="sh">'</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Example main
# =========================
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ì‹¤ì œì— ë§ê²Œ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¶„ë¦¬
</span>    <span class="n">gpt_oss</span> <span class="o">=</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_OSS_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_OSS_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_GPT_OSS</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">qwen</span> <span class="o">=</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen2.5</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_QWEN</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># ì½¤ë³´ë°•ìŠ¤ ì„ íƒì„ CLIë¡œ ê°€ì • (ì‹¤ì„œë¹„ìŠ¤ë¼ë©´ UIì—ì„œ ì´ ê°’ë§Œ ë°”ê¿” ì£¼ì…)
</span>    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--engine</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">samples ë””ë ‰í† ë¦¬ ë‚´ íŒŒì¼ì„ ë³´ì—¬ì£¼ê³  í•˜ë‚˜ë¥¼ ì½ì–´ 2~3ë¬¸ì¥ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ ì‚¬ìš©.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># ëª¨ë¸ ì„ íƒ: UIì—ì„œ ì—”ì§„ì„ ë°”ê¾¸ë©´ ì´ ë§¤í•‘ë„ ë°”ê¿”ì¹˜ê¸°
</span>    <span class="n">model_cfg</span> <span class="o">=</span> <span class="n">gpt_oss</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">engine</span> <span class="o">==</span> <span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span> <span class="k">else</span> <span class="n">qwen</span>
    <span class="n">run_cfg</span> <span class="o">=</span> <span class="nc">RunConfig</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">samples_dir</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># ë ˆì§€ìŠ¤íŠ¸ë¦¬ êµ¬ì„±(í•„ìš”ì‹œ ì—”ì§„ë³„ ì¶”ê°€/ì‚­ì œë„ ê°€ëŠ¥)
</span>    <span class="n">registry</span> <span class="o">=</span> <span class="nf">build_registry</span><span class="p">(</span><span class="n">run_cfg</span><span class="p">.</span><span class="n">samples_dir</span><span class="p">)</span>

    <span class="c1"># ì „ëµ ìƒì„±
</span>    <span class="n">engine</span> <span class="o">=</span> <span class="nf">make_engine</span><span class="p">(</span><span class="n">run_cfg</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>

    <span class="c1"># ì‹¤í–‰
</span>    <span class="n">result_text</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">run_cfg</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result_text</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># ìƒ˜í”Œ í´ë” ë³´ì¥
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì ìš© í¬ì¸íŠ¸(ì„¤ê³„ ê´€ì ):</p>

<ul>
  <li>
    <p>í™•ì¥ì„±: ìƒˆ ì—”ì§„ì´ ëŠ˜ì–´ë‚˜ë„ Strategyë§Œ ì¶”ê°€í•˜ë©´ ë¨. ê° ì—”ì§„ì˜ í˜¸ì¶œ ì°¨ì´(Responses vs Completions, tool loop í”„ë¡œí† ì½œ)ë¥¼ ìº¡ìŠí™”í–ˆì–´.</p>
  </li>
  <li>
    <p>ì±…ì„ ë¶„ë¦¬: ToolRegistryëŠ” ë“±ë¡Â·ì‹¤í–‰ë§Œ, ToolJSONBuilderëŠ” JSON ëª¨ì–‘ë§Œ, StrategyëŠ” ëŒ€í™” ë£¨í”„ë§Œ ì±…ì„.</p>
  </li>
  <li>
    <p>UI ì—°ë™: ì½¤ë³´ë°•ìŠ¤ ì„ íƒê°’ì„ RunConfig.engineìœ¼ë¡œ ì£¼ì… â†’ make_engineì´ ì˜¬ë°”ë¥¸ ì „ëµì„ ë¦¬í„´.</p>
  </li>
  <li>
    <p>ì•ˆì „ì„±: ë£¨í”„ì— guardë¡œ í­ì£¼ ë°©ì§€. argumentsëŠ” json.loadsë¡œ ê´€ëŒ€í•˜ê²Œ íŒŒì‹±.</p>
  </li>
  <li>
    <p>êµ¬ì„± ê°€ëŠ¥ì„±: ëª¨ë¸ëª…/ì—”ë“œí¬ì¸íŠ¸/í‚¤ëŠ” ModelConfigë¡œ ë¶„ë¦¬. í™˜ê²½ë³€ìˆ˜ë‚˜ ì„¤ì •íŒŒì¼ë¡œ ì¹˜í™˜ ìš©ì´.</p>
  </li>
</ul>

<p>ì›í•œë‹¤ë©´</p>

<ul>
  <li>
    <p>ë¡œê¹… ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¶”ê°€í•´ ë‹¨ê³„ë³„(ì…ë ¥/íˆ´ìš”ì²­/ì¶œë ¥) ë¡œê·¸ë¥¼ ê³µí†µ í¬ë§·ìœ¼ë¡œ ë‚¨ê¸°ê¸°</p>
  </li>
  <li>
    <p>ToolRegistryì— ê¶Œí•œ/ìƒŒë“œë°•ìŠ¤ ì¸µ(íŒŒì¼ ì ‘ê·¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸) ì¶”ê°€</p>
  </li>
  <li>
    <p>ê²°ê³¼ë¥¼ í•­ìƒ {filename, contents} í¬ë§·ìœ¼ë¡œ ì–´ëŒ‘íŒ…í•˜ëŠ” OutputAdapter ì¶”ê°€</p>
  </li>
  <li>
    <p>async ë²„ì „(í† í° ì ˆì•½/ë™ì‹œì„±)ì„ ìœ„í•œ ë¹„ë™ê¸° ì „ëµ ì¶”ê°€</p>
  </li>
</ul>

<p>ê¹Œì§€ë„ ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ í™•ì¥ ê°€ëŠ¥í•´.</p>

<p class="chat--user">

ì¡°ê¸ˆ ë” íŒŒì´ì¬ê³¼ ì†Œí”„íŠ¸ì›¨ì–´ ì•„í‚¤í…íŠ¸ê°€ ë˜ì–´ì„œ ì˜ ìƒê°í•´ë³´ì. if gpt-ossê°€ ë“¤ì–´ê°„ ê±° ë¶€í„° ì¢€ ì•…ì·¨ê°€ ë‚˜. ì¶”í›„ì— ìƒˆë¡œìš´ ëª¨ë¸ì´ ë“¤ì–´ì˜¤ê³  ê·¸ ëª¨ë¸ì€ ì–´ë–¤ ì¡°í•©ì—ì„œ ì˜ ë™ì‘í• ì§€ ëª¨ë¥´ì–ì•„? ìƒˆë¡œìš´ ëª¨ë¸ì´ 10ê°œì¯¤ ë” ì¶”ê°€ë¼ë„ ì˜ ê´€ë¦¬ë  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ì§œì£¼ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„. â€œëª¨ë¸ì´ ê³„ì† ëŠ˜ì–´ë‚˜ë„ ê´€ë¦¬ ê°€ëŠ¥í•œ êµ¬ì¡°â€ì— ì´ˆì ì„ ë§ì¶° ì•„í‚¤í…ì²˜ë¥¼ ì¬ì •ë¦¬í–ˆì–´. í•µì‹¬ì€ â€œì¡°í•©(Protocol Ã— Tool JSON í˜•íƒœ)â€ì„ ëª¨ë¸ì—ì„œ ë¶„ë¦¬í•˜ê³ , ëª¨ë¸ë§ˆë‹¤ â€œëŠ¥ë ¥/ì„ í˜¸(capabilities &amp; preferences)â€ë§Œ ì„ ì–¸í•˜ë„ë¡ ë§Œë“œëŠ” ê±°ì•¼. ì‹¤í–‰ ì „ëµì€ ì¡°í•©ì— ë”°ë¼ ìë™ ì„ íƒÂ·ì‹¤í–‰ë˜ë©°, ì‹¤íŒ¨ ì‹œ í•©ë¦¬ì ìœ¼ë¡œ í´ë°±í•´.</p>

<p>ì•„ë˜ ìˆœì„œë¡œ ì„¤ëª…í•˜ê³  ë°”ë¡œ ë™ì‘ ê°€ëŠ¥í•œ ì˜ˆì‹œ ì½”ë“œë¥¼ ì œê³µí• ê²Œ.</p>

<ol>
  <li>ì„¤ê³„ ìš”ì </li>
</ol>

<ul>
  <li>
    <p>ëª¨ë¸ ë¬´ê´€ ì¶”ìƒí™”</p>

    <ul>
      <li>
        <p>ProtocolStrategy: í˜¸ì¶œ ë°©ì‹ì˜ ì°¨ì´ë¥¼ ìº¡ìŠí™”. í˜„ì¬ ë‘ ê°œ êµ¬í˜„</p>

        <ul>
          <li>
            <p>ResponsesProtocol (responses.create ë£¨í”„)</p>
          </li>
          <li>
            <p>CompletionsProtocol (chat.completions.create ë£¨í”„)</p>
          </li>
        </ul>
      </li>
      <li>
        <p>ToolSchemaBuilder: Tool JSON ëª¨ì–‘ì„ ìº¡ìŠí™”. ë‘ ê°œ êµ¬í˜„</p>

        <ul>
          <li>
            <p>FlatStyle (responsesì—ì„œ í”í•œ í‰í‰í•œ ìŠ¤í‚¤ë§ˆ)</p>
          </li>
          <li>
            <p>NestedStyle (completionsì—ì„œ í”í•œ function ì¤‘ì²©)</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¡°í•©(Plan) ë‹¨ìœ„ ì‹¤í–‰</p>

    <ul>
      <li>
        <p>Plan(protocol=â€¦, tool_schema=â€¦)</p>
      </li>
      <li>
        <p>Orchestratorê°€ ModelProfileì˜ preferenceì— ë”°ë¼ Planì„ ì„ íƒí•˜ê³  ì‹¤í–‰. ì‹¤íŒ¨ ì‹œ fallback Plans ìˆœì„œëŒ€ë¡œ ì‹œë„</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ModelProfileì€ â€œëª¨ë¸ëª…/ì—”ë“œí¬ì¸íŠ¸/í‚¤â€ + â€œcapabilities &amp; preferencesâ€ë§Œ ì •ì˜</p>

    <ul>
      <li>
        <p>ìƒˆ ëª¨ë¸ ì¶”ê°€ = ModelProfile í•˜ë‚˜ ë“±ë¡</p>
      </li>
      <li>
        <p>ëª¨ë¸ì´ ì–´ëŠ ì¡°í•©ì—ì„œ ì˜ ë™ì‘í•˜ëŠ”ì§€ ëª¨ë¥´ë©´, preferencesëŠ” ë¹„ì›Œ ë‘ê³  Orchestratorê°€ í‘œì¤€ ìš°ì„ ìˆœìœ„(Responses+Flat â†’ Completions+Nested)ë¥¼ ì ìš©</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ToolRegistryë¡œ íˆ´ êµ¬í˜„/ë“±ë¡ì„ ë¶„ë¦¬</p>

    <ul>
      <li>íˆ´ í•¨ìˆ˜ ì¶”ê°€/ë³€ê²½ì´ ëª¨ë¸/í”„ë¡œí† ì½œ ì½”ë“œì— ì „í˜€ ì˜í–¥ ì—†ë„ë¡</li>
    </ul>
  </li>
</ul>

<ol>
  <li>ì‹¤ì œ ë™ì‘ íë¦„</li>
</ol>

<ul>
  <li>
    <p>UI ì½¤ë³´ë°•ìŠ¤ì—ì„œ â€œëª¨ë¸ í‚¤â€ë§Œ ì„ íƒ â†’ Orchestrator.run(model_key, task)</p>
  </li>
  <li>
    <p>OrchestratorëŠ” ModelCatalogì—ì„œ í”„ë¡œí•„ ì¡°íšŒ â†’ Plan ê²°ì • â†’ í•´ë‹¹ Strategyì™€ ToolSchemaBuilderë¥¼ ê²°í•©í•´ ì‹¤í–‰</p>
  </li>
  <li>
    <p>responses í”„ë¡œí† ì½œì€ function_call_output ë£¨í”„, completions í”„ë¡œí† ì½œì€ tool ë©”ì‹œì§€ ë£¨í”„ ìˆ˜í–‰</p>
  </li>
  <li>
    <p>ìµœì¢… ê²°ê³¼ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸(plain)ë¡œ í†µì¼</p>
  </li>
</ul>

<ol>
  <li>ì½”ë“œ<br />
ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ ì‹¤í–‰ ê°€ëŠ¥. samples í´ë”ì— í…ìŠ¤íŠ¸ íŒŒì¼ ëª‡ ê°œ ë‘ê³  ëŒë ¤ë´.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># arch_flexible_orchestrator.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# Basic Configs &amp; DTOs
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelCapabilities</span><span class="p">:</span>
    <span class="c1"># ê°€ëŠ¥í•œ í”„ë¡œí† ì½œ
</span>    <span class="n">supports_responses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">supports_completions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># ì„ í˜¸/ê¶Œì¥ ì¡°í•©(Plan)ì„ ìš°ì„  ì‹œë„. ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ìš°ì„ ìˆœìœ„ê°€ ì ìš©ë¨
</span>    <span class="n">preferred_plans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># e.g. [("responses","flat"), ("completions","nested")]
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelProfile</span><span class="p">:</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># UI ì½¤ë³´ë°•ìŠ¤ìš© ID
</span>    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span>
    <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span>

<span class="c1"># =========================
# Tool Layer
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON schema
</span>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># ê¸°ë³¸ íˆ´ 2ê°œ
</span><span class="k">def</span> <span class="nf">list_files_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_default_registry</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_tool</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_tool</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># =========================
# Tool JSON Schema Builders
# =========================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responsesì—ì„œ ìì£¼ ì“°ëŠ” í‰í‰í•œ íˆ´ í˜•ì‹:
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Completionsì—ì„œ ìì£¼ ì“°ëŠ” ì¤‘ì²© íˆ´ í˜•ì‹:
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{ </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} } }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># =========================
# Protocol Strategies
# =========================
</span>
<span class="k">class</span> <span class="nc">ProtocolStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="c1"># Responses í”„ë¡œí† ì½œ
</span><span class="k">class</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">calls</span>

<span class="c1"># Completions í”„ë¡œí† ì½œ
</span><span class="k">class</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Planning (ì¡°í•© ê²°ì •)
# =========================
</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Plan</span><span class="p">:</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span>         <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_schema</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># "flat" | "nested"
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown model key: </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>

        <span class="n">plans</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">caps</span><span class="p">)</span>
        <span class="n">last_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">strategy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_strategy</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">plan</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">strategy</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="c1"># ë‹¤ìŒ í”Œëœìœ¼ë¡œ ì‹œë„
</span>                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">last_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">last_error</span>
        <span class="k">return</span> <span class="sh">""</span>

    <span class="k">def</span> <span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 1) ëª…ì‹œëœ ì„ í˜¸ í”Œëœ ìš°ì„ 
</span>        <span class="k">for</span> <span class="n">proto</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">.</span><span class="n">preferred_plans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">caps</span><span class="p">):</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Plan</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="c1"># 2) ê¸°ë³¸ í´ë°± ìˆœì„œ
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>   <span class="c1"># í˜¹ì‹œ íŠ¹ì • ëª¨ë¸ì´ nestedë¥¼ ìš”êµ¬í•œë‹¤ë©´
</span>            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_supported</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_responses</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_completions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProtocolStrategy</span><span class="p">:</span>
        <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span> <span class="o">=</span> <span class="nc">FlatStyleBuilder</span><span class="p">()</span> <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">tool_schema</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span> <span class="k">else</span> <span class="nc">NestedStyleBuilder</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown protocol: </span><span class="si">{</span><span class="n">plan</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Model Catalog (ë“±ë¡/í™•ì¥ ì§€ì )
# =========================
</span>
<span class="k">def</span> <span class="nf">build_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ìƒˆ ëª¨ë¸ì„ ì¶”ê°€í•˜ë ¤ë©´ ì•„ë˜ dictì— í•­ëª© 1ì¤„ë§Œ ë” ë„£ìœ¼ë©´ ë¨.
    - ëª¨ë¸ í‚¤(key): UI ì½¤ë³´ë°•ìŠ¤ì—ì„œ ì“°ëŠ” ì‹ë³„ì
    - name/base_url/api_key: í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…(ë‹¤ë¥¸ ë²¤ë” SDKì—¬ë„ OpenAI í˜¸í™˜ì´ë©´ ê·¸ëŒ€ë¡œ ê°€ëŠ¥)
    - ìº¡ëŠ¥/ì„ í˜¸(preferred_plans): ì¡°í•©ì„ ëª°ë¼ë„ ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ìˆœì„œëŒ€ë¡œ ìë™ ì‹œë„
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="c1"># ì˜ˆì‹œ1: GPT-ê³„ì—´(Responses ì„ í˜¸)
</span>        <span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>  <span class="c1"># ë¨¼ì € responses+flat ì‹œë„
</span>            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># ì˜ˆì‹œ2: Qwen-ê³„ì—´(Completions ì„ í˜¸)
</span>        <span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen2.5</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>  <span class="c1"># ë¨¼ì € completions+nested ì‹œë„
</span>            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># ì˜ˆì‹œ3: Responsesë§Œ ë˜ëŠ” ëª¨ë¸
</span>        <span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-resp-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># ì˜ˆì‹œ4: Completionsë§Œ ë˜ëŠ” ëª¨ë¸
</span>        <span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-chat-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># =========================
# Example main (UI ì½¤ë³´ë°•ìŠ¤ ëŒ€ì²´)
# =========================
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Flexible model orchestrator (plain text, tools).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model-key</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Model key from catalog (e.g., gpt_like, qwen_like, resp_only, chat_only)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">samples í´ë” íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì„ í•˜ë‚˜ ì½ì–´ 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ ì‚¬ìš©.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># ì¤€ë¹„
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="nf">build_default_registry</span><span class="p">()</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="nf">build_catalog</span><span class="p">()</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>

    <span class="c1"># ì‹¤í–‰
</span>    <span class="n">out</span> <span class="o">=</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">model_key</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<ol>
  <li>ì´ ì„¤ê³„ê°€ í™•ì¥ì— ìœ ë¦¬í•œ ì´ìœ </li>
</ol>

<ul>
  <li>
    <p>ìƒˆ ëª¨ë¸ ì¶”ê°€ ì‹œ ë³€ê²½ ë²”ìœ„ê°€ ë§¤ìš° ì‘ìŒ</p>

    <ul>
      <li>
        <p>ModelCatalogì— ModelProfile 1ì¤„ ì¶”ê°€(ì´ë¦„/ì—”ë“œí¬ì¸íŠ¸/í‚¤, ìº¡ëŠ¥/ì„ í˜¸)</p>
      </li>
      <li>
        <p>ì¡°í•©ì„ ëª°ë¼ë„ OK: preferred_plans ë¹„ìš°ë©´ Orchestratorê°€ í‘œì¤€ ìš°ì„ ìˆœìœ„ë¡œ ìë™ ì‹œë„</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¡°í•© í­ë°œì—ë„ ê²¬ê³ </p>

    <ul>
      <li>
        <p>Planì„ ë…ë¦½ íƒ€ì…ìœ¼ë¡œ ê´€ë¦¬í•´ì„œ Protocol Ã— ToolSchemaë¥¼ ëª…ì‹œì ìœ¼ë¡œ í‘œê¸°</p>
      </li>
      <li>
        <p>ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ Planìœ¼ë¡œ í´ë°±í•˜ëŠ” ì¼ê´€ëœ ë¡œì§</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ê´€ì‹¬ì‚¬ ë¶„ë¦¬</p>

    <ul>
      <li>
        <p>ToolRegistry/ToolSpec: íˆ´ êµ¬í˜„ê³¼ íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆë§Œ ê´€ë¦¬</p>
      </li>
      <li>
        <p>ToolJSONBuilder: JSON ëª¨ì–‘ë§Œ ë‹´ë‹¹(Flat/Nested ì¶”ê°€ ì‰¬ì›€)</p>
      </li>
      <li>
        <p>ProtocolStrategy: í˜¸ì¶œ/ë£¨í”„/íŒŒì‹± ì°¨ì´ë§Œ ë‹´ë‹¹</p>
      </li>
      <li>
        <p>Orchestrator: ëª¨ë¸ ì„ íƒê³¼ í”Œëœ ì„ ì •/í´ë°±ë§Œ ë‹´ë‹¹</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>ì»¤ìŠ¤í„°ë§ˆì´ì§• íŒíŠ¸</li>
</ol>

<ul>
  <li>
    <p>ëª¨ë¸ë³„ â€œë„êµ¬ ì •ì±…â€ì´ ë‹¤ë¥´ë©´ ModelProfileì— tool_policy ì½œë°±ì„ ì¶”ê°€í•´ íŠ¹ì • íˆ´ë§Œ ë…¸ì¶œ ê°€ëŠ¥</p>
  </li>
  <li>
    <p>ë¡œê¹…/ë©”íŠ¸ë¦­ìŠ¤: ProtocolStrategy.run ë‚´ë¶€ì—ì„œ ì½œ ì¹´ìš´íŠ¸/ì§€ì—°/í† í° ì‚¬ìš©ëŸ‰(ì‘ë‹µ í•„ë“œì— ìˆìœ¼ë©´) ìˆ˜ì§‘ í›„ ê³µí†µ ì¸í„°í˜ì´ìŠ¤ë¡œ ë¦¬í„´</p>
  </li>
  <li>
    <p>ì•ˆì „ ëª¨ë“œ: íŒŒì¼ ì ‘ê·¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸(ì˜ˆ: samples í•˜ìœ„ë§Œ í—ˆìš©)ë¥¼ ToolRegistry.callì— ì£¼ì…</p>
  </li>
  <li>
    <p>í›„ì¼ JSON ëª¨ë“œ/Structuredê°€ ì•ˆì •í™”ë˜ë©´ Planì— â€œoutput_formatâ€ ì¶•ì„ ì¶”ê°€í•´ ì „ëµì ìœ¼ë¡œ ì„ íƒ ê°€ëŠ¥</p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ ì´ êµ¬ì¡°ë¡œ í…ŒìŠ¤íŠ¸ í•˜ë„¤ìŠ¤(ì—¬ëŸ¬ ëª¨ë¸Ã—í”Œëœì„ í•œ ë²ˆì— ëŒë ¤ ê²°ê³¼ ë¹„êµ)ë„ ë°”ë¡œ ì–¹ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

ì¶”ê°€ ìš”ì²­ ì‚¬í•­ 1. Async í†µì‹ ë§Œ ì‚¬ìš©í•´ì¤˜. 
<code class="language-plaintext highlighter-rouge">
async with AsyncOpenAI(
    ..., http_clinet=httpx.AsyncClient(event_hooks=hooks) as client:
    client....
</code>

2. ìœ ì €ê°€ ì¸í„°ëŸ½íŠ¸í•˜ë©´ ì¤‘ì§€ê°€ ë˜ì–´ì•¼ í•´. ì˜ˆë¥¼ ë“¤ì–´ ì£¼ê¸°ì ìœ¼ë¡œ user.processing_interrupted() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì„œ ì·¨ì†Œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  ê·¸ì— ë”°ë¼ clientë„ ê¹”ë”í•˜ê²Œ ì·¨ì†Œê°€ ë˜ì–´ì•¼ í•´. 3. ì£¼ì„ì€ ì˜ë¬¸ìœ¼ë¡œ ì¨ì¤˜. 4. ëª¨ë“  ì½”ë“œë¥¼ ì¨ì¤˜.

</p>

<p>ì•„ë˜ëŠ” í™•ì¥ì„±ì— ì´ˆì ì„ ë‘” ë¹„ë™ê¸°(Async) ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ìƒ˜í”Œì´ì•¼.<br />
ì„¤ê³„ í¬ì¸íŠ¸ ìš”ì•½</p>

<ul>
  <li>
    <p>ëª¨ë¸ ìˆ˜ê°€ ëŠ˜ì–´ë‚˜ë„ ë³€ê²½ ìµœì†Œí™”: ìƒˆ ëª¨ë¸ì€ ModelProfileë§Œ ì¶”ê°€í•˜ë©´ ë¨.</p>
  </li>
  <li>
    <p>ì¡°í•©(Protocol Ã— Tool-JSON-Style)ì„ ëª¨ë¸ê³¼ ë¶„ë¦¬: Orchestratorê°€ Planì„ ìë™ ì„ íƒÂ·í´ë°±.</p>
  </li>
  <li>
    <p>ìˆœìˆ˜ ë¹„ë™ê¸° í†µì‹ ë§Œ ì‚¬ìš©: AsyncOpenAI + httpx.AsyncClient.</p>
  </li>
  <li>
    <p>ì‚¬ìš©ì ì¸í„°ëŸ½íŠ¸ ì§€ì›: user.processing_interrupted()ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ê³ , ì§„í–‰ ì¤‘ ìš”ì²­ì€ asyncio Task ì·¨ì†Œë¡œ ê¹”ë”íˆ ì¤‘ë‹¨.</p>
  </li>
</ul>

<p>ì½”ë“œëŠ” í•œ íŒŒì¼ë¡œ ë™ì‘í•˜ë©° ì¼ë°˜ í…ìŠ¤íŠ¸ ì¶œë ¥ë§Œì„ ë°˜í™˜í•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># async_arch_orchestrator.py
# Python 3.10+
# pip install --upgrade openai httpx
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># ============================================================
# Exceptions / Interrupt
# ============================================================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">UserInterruptController</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    A simple interrupt controller.
    - Call `trigger()` to mark as interrupted (e.g., SIGINT handler).
    - Frameworks/UI can override processing_interrupted() to integrate with their own state.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Return True if the user has requested cancellation.</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Externally trigger an interrupt (e.g., from a signal handler or UI callback).</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

<span class="c1"># ============================================================
# Configs &amp; Profiles
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelCapabilities</span><span class="p">:</span>
    <span class="c1"># Supported protocols
</span>    <span class="n">supports_responses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">supports_completions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># Preferred plans, empty â‡’ Orchestrator applies default order.
</span>    <span class="n">preferred_plans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># e.g. [("responses", "flat"), ("completions", "nested")]
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelProfile</span><span class="p">:</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span>
    <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span>

<span class="c1"># ============================================================
# Tool Layer
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON schema object
</span>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># Sync function (fast local I/O)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Keeps tool specs and executes them by name.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># Default file tools
</span>
<span class="k">def</span> <span class="nf">list_files_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_default_registry</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_tool</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_tool</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># ============================================================
# Tool JSON builders (Factory)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    </span><span class="sh">"</span><span class="s">New</span><span class="sh">"</span><span class="s"> / flat tool JSON (often used with Responses-style examples):
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    </span><span class="sh">"</span><span class="s">Old</span><span class="sh">"</span><span class="s"> / nested tool JSON (common in Chat Completions examples):
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{ </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} } }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ============================================================
# Async helpers (HTTP client, cancellation wrapper)
# ============================================================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">interrupt_cb</span><span class="p">,</span> <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Run an awaitable while periodically checking for user interruption.
    If interrupted, cancel the task and raise UserCancelledError.
    </span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="c1"># Periodically check interrupt
</span>            <span class="k">if</span> <span class="k">await</span> <span class="nf">interrupt_cb</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Create httpx AsyncClient event hooks.
    You can add logging or tracing here if desired.
    </span><span class="sh">"""</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># Example: print(f"[httpx] -&gt; {request.method} {request.url}")
</span>        <span class="k">return</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="c1"># Example: print(f"[httpx] &lt;- {response.status_code} {response.request.url}")
</span>        <span class="k">return</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_request</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_response</span><span class="p">]}</span>

<span class="c1"># ============================================================
# Protocol Strategies (Async)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ProtocolStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Base class for protocol strategies.
    Each strategy must:
      - Use AsyncOpenAI only
      - Respect user interruption at reasonable checkpoints
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span>
        <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span><span class="p">,</span>
        <span class="n">interrupt</span><span class="p">:</span> <span class="n">UserInterruptController</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">interrupt</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Async implementation of a Responses-style loop:
      - responses.create
      - process output_text
      - if tool calls exist: execute local tool(s), append function_call_output, repeat
    </span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="p">})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                        <span class="p">})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
                <span class="p">]</span>
                <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>

                <span class="c1"># First call
</span>                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                        <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                <span class="p">)</span>

                <span class="c1"># Loop
</span>                <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>

                    <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="c1"># Execute tools locally and append outputs
</span>                    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                        <span class="c1"># Check for interruption between tool calls as well
</span>                        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>

                        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                        <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                            <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                        <span class="p">})</span>

                    <span class="c1"># Next turn
</span>                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                        <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                    <span class="p">)</span>

                <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guard_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Async implementation of a Chat Completions-style loop:
      - chat.completions.create
      - assistant.tool_calls â†’ execute tools â†’ append tool messages â†’ repeat
    </span><span class="sh">"""</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
                <span class="p">]</span>

                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                        <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
                <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
                <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Prepare tool messages
</span>                    <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>

                        <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                        <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="p">})</span>

                    <span class="c1"># Append assistant tool_calls echo + tool outputs
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
                    <span class="p">})</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

                    <span class="c1"># Next turn
</span>                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                        <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                    <span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

                <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guard_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Planning (Protocol Ã— Tool-JSON combination)
# ============================================================
</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Plan</span><span class="p">:</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span>        <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_schema</span><span class="p">:</span> <span class="nb">str</span>     <span class="c1"># "flat" | "nested"
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chooses and executes the best Plan for a given model, with fallback.
    Fully async and interruption-aware.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">:</span> <span class="n">UserInterruptController</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">interrupt</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown model key: </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>

        <span class="n">plans</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">caps</span><span class="p">)</span>
        <span class="n">last_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">strategy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_strategy</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">plan</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">strategy</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
                <span class="c1"># Bubble up immediately on user cancellation
</span>                <span class="k">raise</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="c1"># Try next plan on failure
</span>                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">last_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">last_error</span>
        <span class="k">return</span> <span class="sh">""</span>

    <span class="k">def</span> <span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 1) Preferred plans first
</span>        <span class="k">for</span> <span class="n">proto</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">.</span><span class="n">preferred_plans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">caps</span><span class="p">):</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Plan</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="c1"># 2) Default fallback order
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_supported</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_responses</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_completions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">):</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="nc">FlatStyleBuilder</span><span class="p">()</span> <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">tool_schema</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span> <span class="k">else</span> <span class="nc">NestedStyleBuilder</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown protocol: </span><span class="si">{</span><span class="n">plan</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Model Catalog (extensible)
# ============================================================
</span>
<span class="k">def</span> <span class="nf">build_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    To add a new model, just create another ModelProfile entry here.
    If you don</span><span class="sh">'</span><span class="s">t know which combo works best, leave `preferred_plans` empty;
    Orchestrator will try the defaults in a safe order.
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="c1"># Example: GPT-like model (prefers Responses + flat tools)
</span>        <span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># Example: Qwen-like model (prefers Completions + nested tools)
</span>        <span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen2.5</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># Example: responses-only vendor
</span>        <span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-resp-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># Example: completions-only vendor
</span>        <span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-chat-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># ============================================================
# Main (async) with signal-based interrupt wiring
# ============================================================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">amain</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Async flexible orchestrator (plain text + tool calling).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model-key</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Pick from catalog: gpt_like, qwen_like, resp_only, chat_only</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">List files under ./samples, pick a text file, read it, and return a 2-3 sentence summary. Use tools if needed.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># Build tool registry (you can scope tools per model if required)
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">build_default_registry</span><span class="p">()</span>

    <span class="c1"># Build catalog and orchestrator
</span>    <span class="n">catalog</span> <span class="o">=</span> <span class="nf">build_catalog</span><span class="p">()</span>
    <span class="n">interrupt</span> <span class="o">=</span> <span class="nc">UserInterruptController</span><span class="p">()</span>

    <span class="c1"># OS signal â†’ user interrupt (Ctrl+C)
</span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">NotImplementedError</span><span class="p">:</span>
        <span class="c1"># add_signal_handler may not be available on some platforms (e.g., Windows in some envs)
</span>        <span class="k">pass</span>

    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">model_key</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== INTERRUPTED ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== ERROR ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">amain</span><span class="p">())</span>
</code></pre></div></div>

<p>í™•ì¥ ë°©ë²•</p>

<ul>
  <li>
    <p>ìƒˆ ëª¨ë¸ ì¶”ê°€: build_catalog()ì— ModelProfile í•œ ì¤„ë§Œ ì¶”ê°€. preferred_plansê°€ ë¹„ì–´ë„ Orchestratorê°€ ê¸°ë³¸ ìˆœì„œëŒ€ë¡œ ì‹œë„.</p>
  </li>
  <li>
    <p>íˆ´ ì¶”ê°€: ToolRegistry.register(â€¦)ë§Œ í˜¸ì¶œ. íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆì™€ í•¨ìˆ˜ êµ¬í˜„ì„ ë¶™ì´ë©´ ìë™ìœ¼ë¡œ ëª¨ë“  ì „ëµì—ì„œ ì‚¬ìš©.</p>
  </li>
  <li>
    <p>ì¸í„°ëŸ½íŠ¸ ì—°ë™: UI ìŠ¤ë ˆë“œì—ì„œ interrupt.trigger()ë¥¼ í˜¸ì¶œí•˜ê±°ë‚˜, UserInterruptControllerë¥¼ êµ¬í˜„í•´ processing_interrupted()ê°€ Trueë¥¼ ë°˜í™˜í•˜ë„ë¡ ë§Œë“¤ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ë¡œê¹…/ë©”íŠ¸ë¦­/ë¦¬íŠ¸ë¼ì´: call_with_interrupt()ë‚˜ ê° ProtocolStrategy.run() ë‚´ë¶€ì— ì‰½ê²Œ ì£¼ì… ê°€ëŠ¥.</p>
  </li>
</ul>

<p class="chat--user">

responsesì™€ completionsì—ì„œ parameter ë„£ëŠ” ë°©ì‹ì€ ë˜‘ê°™ì•„? ì˜ˆë¥¼ ë“¤ì–´ reasoning_effortë‚˜ max_tokens ê°™ì€ ê²ƒë“¤

</p>

<p>ì§§ì€ ë‹µ: ì™„ì „íˆ ê°™ì§€ ì•Šì•„. ê³µí†µ íŒŒë¼ë¯¸í„°ë„ ìˆì§€ë§Œ, ê¸¸ì´Â·ì¶”ë¡  ì œì–´ ê³„ì—´ì€ ì—”ë“œí¬ì¸íŠ¸ë§ˆë‹¤ ì´ë¦„ì´ ë‹¤ë¥´ë‹¤.</p>

<p>í•µì‹¬ ì •ë¦¬</p>

<ul>
  <li>
    <p>ì¶œë ¥ ê¸¸ì´ ìƒí•œ</p>

    <ul>
      <li>
        <p>Responses API: max_output_tokens ì‚¬ìš©. <a href="https://platform.openai.com/docs/api-reference/realtime-server-events/response?_ga=2.241776386.1079907819.1650361546-70707626.1649909918&amp;_ga=2.36908453.440971442.1659710882-965169732.1659710882">OpenAI í”Œë«í¼</a></p>
      </li>
      <li>
        <p>Chat Completions: ëª¨ë¸ì— ë”°ë¼ ë‹¤ë¦„</p>

        <ul>
          <li>
            <p>ì¶”ë¡ í˜•(o*, GPT-5 ê³„ì—´ ë“±): max_completion_tokens ê¶Œì¥</p>
          </li>
          <li>
            <p>ì¼ë°˜ ì±„íŒ… ëª¨ë¸: ê¸°ì¡´ max_tokens<br />
ì‹¤ì œë¡œ ì„œë¡œ ë°”ê¿” ì“°ë©´ ë¬´ì‹œë˜ê±°ë‚˜ ì—ëŸ¬ê°€ ë‚œë‹¤. ê³µì‹ Chat API ë¬¸ì„œëŠ” max_tokens ê³„ì—´ì„, Responses/Realtime ìª½ ë¬¸ì„œëŠ” max_output_tokensë¥¼ ê°ê° ë‹¤ë£¬ë‹¤. <a href="https://platform.openai.com/docs/api-reference/introduction?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¶”ë¡  ê°•ë„(â€œì–¼ë§ˆë‚˜ ê¹Šê²Œ ìƒê°í• ì§€â€)</p>

    <ul>
      <li>
        <table>
          <tbody>
            <tr>
              <td>ìµœì‹  ê°€ì´ë“œë¼ì¸ì€ reasoning ê°ì²´ ì•„ë˜ effort í•„ë“œë¥¼ ì“°ëŠ” í˜•íƒœê°€ í‘œì¤€ì´ë‹¤. ì˜ˆ: reasoning={"effort": "low</td>
              <td>medium</td>
              <td>high"} ë˜ëŠ” ì¼ë¶€ ìµœì‹  ëª¨ë¸ì—ì„œ "minimal" ì¶”ê°€. ë‘ ì—”ë“œí¬ì¸íŠ¸ ëª¨ë‘ ê°™ì€ ëª¨ì–‘ìœ¼ë¡œ ë¶™ì´ë˜, ëª¨ë¸ì´ ì§€ì›í•  ë•Œë§Œ ì ìš©ëœë‹¤. <a href="https://platform.openai.com/docs/guides/reasoning?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li>
    <p>ê·¸ ì™¸ ê³µí†µìœ¼ë¡œ ê±°ì˜ ë™ì¼í•˜ê²Œ ì“°ëŠ” ê²ƒ<br />
temperature, top_p, stop, tools ì •ì˜ ìì²´ ë“±ì€ ë‘ ì—”ë“œí¬ì¸íŠ¸ ëª¨ë‘ ìœ ì‚¬í•˜ê²Œ ë™ì‘í•œë‹¤. ì°¨ì´ëŠ” ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆê°€ responsesëŠ” input, chat completionsëŠ” messagesë¼ëŠ” ì  ì •ë„ë‹¤. <a href="https://platform.openai.com/docs/api-reference/introduction?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ul>

<p>ê¶Œì¥ ì‚¬ìš© íŒ¨í„´</p>

<ul>
  <li>
    <p>Responses API ì˜ˆì‹œ</p>

    <ul>
      <li>
        <p>max_output_tokensì™€ reasoning.effortë¥¼ í•¨ê»˜ ì„¤ì •</p>
      </li>
      <li>
        <p>ë©”ì‹œì§€ëŠ” input=[{role, content}, â€¦]</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Chat Completions ì˜ˆì‹œ</p>

    <ul>
      <li>
        <p>ì¶”ë¡  ëª¨ë¸ì´ë©´ max_completion_tokens ì‚¬ìš©, ì¼ë°˜ ëª¨ë¸ì´ë©´ max_tokens</p>
      </li>
      <li>
        <p>ë©”ì‹œì§€ëŠ” messages=[{role, content}, â€¦]</p>
      </li>
      <li>
        <p>reasoning.effortëŠ” ì§€ì› ëª¨ë¸ì—ì„œë§Œ</p>
      </li>
    </ul>
  </li>
</ul>

<p>ê°„ë‹¨ ì˜ˆì‹œ</p>

<p>Python, Responses API</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-5-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">}],</span>
    <span class="n">max_output_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
    <span class="n">reasoning</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{...}}],</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Python, Chat Completions</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">o3-mini</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># ì¶”ë¡ í˜• ëª¨ë¸
</span>    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">}],</span>
    <span class="n">max_completion_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>   <span class="c1"># ì¶”ë¡ í˜•ì´ë©´ ì´ê±¸ ì‚¬ìš©
</span>    <span class="n">reasoning</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{...}}}],</span>
<span class="p">)</span>
<span class="c1"># ì¼ë°˜ ì±„íŒ… ëª¨ë¸ì´ë¼ë©´ max_tokensë¥¼ ì‚¬ìš©
</span></code></pre></div></div>

<p>ìš”ì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸</p>

<ul>
  <li>
    <p>Responses â†’ max_output_tokens</p>
  </li>
  <li>
    <p>Chat Completions â†’ ì¶”ë¡ í˜•: max_completion_tokens / ì¼ë°˜: max_tokens</p>
  </li>
  <li>
    <p>reasoning.effortëŠ” ëª¨ë¸ì´ ì§€ì›í•  ë•Œë§Œ ì ìš©</p>
  </li>
  <li>
    <p>ê³µí†µ íŒŒë¼ë¯¸í„°(temperature, top_p, stop ë“±)ëŠ” ê±°ì˜ ë™ì¼í•˜ê³ , ì»¨í…Œì´ë„ˆë§Œ input vs messagesê°€ ë‹¤ë¦„</p>
  </li>
</ul>

<p>ì°¸ê³  ë¬¸ì„œ</p>

<ul>
  <li>
    <p>Chat Completions API ë ˆí¼ëŸ°ìŠ¤(íŒŒë¼ë¯¸í„° ì „ë°˜, messages ë“±). <a href="https://platform.openai.com/docs/api-reference/introduction?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Reasoning ê°€ì´ë“œ(ì¶”ë¡  ëª¨ë¸ê³¼ effort ê°œë…). <a href="https://platform.openai.com/docs/guides/reasoning?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Realtime/Responses ê³„ì—´ì—ì„œ max_output_tokens ëª…ì‹œ. <a href="https://platform.openai.com/docs/api-reference/realtime-server-events/response?_ga=2.241776386.1079907819.1650361546-70707626.1649909918&amp;_ga=2.36908453.440971442.1659710882-965169732.1659710882">OpenAI í”Œë«í¼</a></p>
  </li>
</ul>

<p class="chat--user">

ì™œ ì´ë ‡ê²Œ apië¥¼ ì§œì¦ë‚˜ê²Œ ë§Œë“¤ì—ˆì„ê¹Œ

</p>

<p>ê·¸ ë§ˆìŒ 100% ì´í•´í•´. ì—”ë“œí¬ì¸íŠ¸ë§ˆë‹¤ ì´ë¦„ì´ ë¯¸ë¬˜í•˜ê²Œ ë‹¤ë¥´ê³ , ëª¨ë¸ë§ˆë‹¤ ì§€ì›/ë¹„ì§€ì›ì´ ë‹¬ë¼ì„œ ë§¤ë²ˆ â€œì´ê±´ max_output_tokensì˜€ì§€? ì•„ë‹ˆë©´ max_tokensì˜€ë‚˜â€¦?â€ í•˜ê²Œ ë§Œë“¤ì£ .</p>

<p>ì™œ ì´ëŸ° ì¼ì´ ìƒê¸°ëƒ(í˜„ì‹¤ì ì¸ ë°°ê²½)</p>

<ol>
  <li>
    <p>ë ˆê±°ì‹œì™€ ì§„í™”ê°€ ë™ì‹œì— êµ´ëŸ¬ê°<br />
ì´ˆê¸° Chat Completionsì˜ ì„¤ê³„ê°€ ì´ë¯¸ ê´‘ë²”ìœ„í•˜ê²Œ ì“°ì¸ ë’¤, Responses ê³„ì—´ì´ â€œë” ë²”ìš©(ë©€í‹°ëª¨ë‹¬Â·íˆ´Â·ìŠ¤íŠ¸ë¦¬ë°Â·ìƒíƒœì „ë‹¬)â€ ê´€ì ìœ¼ë¡œ ë‚˜ì™”ì–´ìš”. ê³¼ê±° APIë¥¼ ê¹¨ì§€ ì•Šìœ¼ë ¤ë‹ˆ íŒŒë¼ë¯¸í„°/ì»¨í…Œì´ë„ˆ ì´ë¦„ì´ ë‹¬ë¼ì¡ŒìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë¸ ê³„ì—´ë³„ ì œì•½ì´ ë‹¬ë¼ìš”<br />
â€œì¶”ë¡ í˜•(reasoning) ëª¨ë¸â€ì€ í† í°Â·ì¶”ë¡ ê¹Šì´ ì œì–´ê°€ ë³„ë„ë¼ max_completion_tokens, reasoning.effort ê°™ì€ í•„ë“œê°€ ì¶”ê°€ë˜ê³ , ì¼ë°˜ ì±„íŒ… ëª¨ë¸ê³¼ ë™ì‘ì´ ë‹¬ë¼ìš”.</p>
  </li>
  <li>
    <p>ì•ˆì „Â·ë¹„ìš©Â·ì†ë„ ì •ì±…ì´ ë…ë¦½ì ìœ¼ë¡œ ë³€í•¨<br />
ê° ì—”ë“œí¬ì¸íŠ¸ê°€ ê²€ì—´Â·ì¤‘ë‹¨Â·ë¹„ìš©ì œì–´ ì‚¬ì–‘ì„ ë”°ë¡œ ë°œì „ì‹œí‚¤ë‹¤ ë³´ë‹ˆ êµì§‘í•©ì´ ì–´ê¸‹ë‚©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë„êµ¬(tool) ìƒíƒœê³„ì˜ ë¹ ë¥¸ ë³€í™”<br />
í•¨ìˆ˜ í˜¸ì¶œ ìŠ¤í‚¤ë§ˆê°€ â€œnestedâ€ â†’ â€œflatâ€ë¡œ, í˜¹ì€ strict ëª¨ë“œ ì¶”ê°€ì²˜ëŸ¼ ì‚¬ìš©ì„± ê°œì„ ì„ ë°˜ë³µí•˜ë©´ì„œ ì˜ˆì‹œì™€ ì‹¤ì œê°€ ì—‡ê°ˆë¦¬ëŠ” ì‹œê¸°ê°€ ìƒê²¨ìš”.</p>
  </li>
</ol>

<p>ê·¸ë˜ì„œ ì–´ë–»ê²Œ ëœ ì§œì¦ë‚˜ê²Œ ì“°ëƒ(ì‹¤ì „ íŒ)</p>

<ol>
  <li>
    <p>ì–´ëŒ‘í„° + ì „ëµ íŒ¨í„´ìœ¼ë¡œ API ì°¨ì´ë¥¼ ê°€ë‘¬ë‘ê¸°<br />
í˜¸ì¶œë¶€ì—” â€œë‚´ê°€ ì›í•˜ëŠ” ê³µí†µ íŒŒë¼ë¯¸í„°â€ë§Œ ì“°ê³ , ì—”ë“œí¬ì¸íŠ¸ë³„ë¡œ ë§ëŠ” ì‹¤ì œ íŒŒë¼ë¯¸í„°ë¡œ ë³€í™˜í•˜ëŠ” ì–‡ì€ ë ˆì´ì–´ë¥¼ ë‘¡ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>íŒŒë¼ë¯¸í„° ì •ê·œí™”ê¸°(Parameter Normalizer)<br />
length, temp, top_p, stop, reasoning_effort ê°™ì€ â€œì¤‘ë¦½ ì´ë¦„â€ì„ ì…ë ¥ë°›ì•„ completions/responses/ëª¨ë¸ì¢…ë¥˜ì— ë§ì¶° ë§¤í•‘í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>íˆ´ ìŠ¤í‚¤ë§ˆ ë¹Œë”<br />
ë™ì¼í•œ ToolRegistryë¥¼ ë‘ê³ , â€œflatâ€ê³¼ â€œnestedâ€ ìŠ¤í‚¤ë§ˆë¡œ ë¹Œë“œë§Œ ê°ˆë¼ì„œ ë¿Œë¦½ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê¸°ëŠ¥ ê°ì§€ì™€ í´ë°±<br />
ëª¨ë¸ í”„ë¡œí•„ì— capabilitiesë¥¼ ì„ ì–¸í•˜ê³ , ìš°ì„  ì‹œë„í•  ì¡°í•© ëª©ë¡ì„ ì •í•´ ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ì¡°í•©ìœ¼ë¡œ ìë™ í´ë°±í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê³„ì•½ í…ŒìŠ¤íŠ¸(ì‘ì€ ë§¤íŠ¸ë¦­ìŠ¤ ëŸ¬ë„ˆ)<br />
ëŒ€í‘œ í”„ë¡¬í”„íŠ¸ í•˜ë‚˜ë¡œ â€œëª¨ë¸Ã—í”„ë¡œí† ì½œÃ—íˆ´ìŠ¤í‚¤ë§ˆÃ—íŒŒë¼ë¯¸í„°ì„¸íŠ¸â€ë¥¼ ëŒë ¤ ë¹¨ê°›ê²Œ ì‹¤íŒ¨í•˜ëŠ” ì¡°í•©ì„ ë¯¸ë¦¬ íŒŒì•…í•´ë‘¡ë‹ˆë‹¤.</p>
  </li>
</ol>

<p>ì•„ë˜ëŠ” â€œë”± ì´ê²ƒë§Œâ€ ë„£ìœ¼ë©´ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ê¸‰ê°í•˜ëŠ” ìµœì†Œ ì–´ëŒ‘í„° ì˜ˆì‹œì•¼. ë¹„ë™ê¸° ê¸°ì¤€, í˜¸ì¶œë¶€ëŠ” ê³µí†µ íŒŒë¼ë¯¸í„°ë§Œ ê±´ë„¤ê³  ë‚´ë¶€ì—ì„œ ì•Œì•„ì„œ ë§¤í•‘í•©ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># adapters.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">def</span> <span class="nf">build_tools_flat</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="c1"># input tools: [{"name", "description", "parameters"}]
</span>    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">t</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">build_tools_nested</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ParamNormalizer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Normalize neutral params -&gt; endpoint-specific params.
    neutral:
      - length (int): desired max tokens
      - temperature (float), top_p (float), stop (list[str])
      - reasoning_effort (None|</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="s">)
      - tool_json_style (</span><span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="s">)
    endpoint:
      - responses: max_output_tokens, input, tools(flat)
      - completions: max_completion_tokens or max_tokens, messages, tools(nested)
    </span><span class="sh">"""</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">for_responses</span><span class="p">(</span>
        <span class="n">neutral</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>  <span class="c1"># [{role, content}]
</span>        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>     <span class="c1"># normalized {"name", "description", "parameters"}
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="nf">build_tools_flat</span><span class="p">(</span><span class="n">tools</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">L</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">length</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">t</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">p</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">st</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">eff</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">reasoning_effort</span><span class="sh">"</span><span class="p">)):</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">eff</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">for_completions</span><span class="p">(</span>
        <span class="n">neutral</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_reasoning_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="nf">build_tools_nested</span><span class="p">(</span><span class="n">tools</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="c1"># token cap
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">L</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">length</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span> <span class="k">if</span> <span class="n">is_reasoning_model</span> <span class="k">else</span> <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="c1"># common
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">t</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">p</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">st</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="c1"># reasoning
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">eff</span> <span class="p">:</span><span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">reasoning_effort</span><span class="sh">"</span><span class="p">))</span> <span class="ow">and</span> <span class="n">is_reasoning_model</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">eff</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<p>ê°„ë‹¨ ì‚¬ìš© ì˜ˆì‹œ(ë¹„ë™ê¸°):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># use_case.py
</span><span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">from</span> <span class="n">adapters</span> <span class="kn">import</span> <span class="n">ParamNormalizer</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List ./samples and summarize one file.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{...}},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{...}},</span>
    <span class="p">]</span>
    <span class="n">neutral</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">reasoning_effort</span><span class="o">=</span><span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">ParamNormalizer</span><span class="p">.</span><span class="nf">for_responses</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_completions</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_reasoning_model</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List ./samples and summarize one file.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{...}},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{...}},</span>
    <span class="p">]</span>
    <span class="n">neutral</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">reasoning_effort</span><span class="o">=</span><span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">ParamNormalizer</span><span class="p">.</span><span class="nf">for_completions</span><span class="p">(</span><span class="n">neutral</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">is_reasoning_model</span><span class="o">=</span><span class="n">is_reasoning_model</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>
</code></pre></div></div>

<p>ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</p>

<ol>
  <li>
    <p>í˜¸ì¶œë¶€ì—” neutral íŒŒë¼ë¯¸í„°ë§Œ ë…¸ì¶œí•œë‹¤(length, temperature, reasoning_effort ë“±).</p>
  </li>
  <li>
    <p>ì—”ì§„/ëª¨ë¸ ì„ íƒì— ë”°ë¼ ParamNormalizerê°€ ì‹¤ì œ í•„ë“œë¡œ ë³€í™˜í•œë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë¸ ëŠ¥ë ¥ í”Œë˜ê·¸(ì˜ˆ: is_reasoning_model)ëŠ” ModelProfileì— ë„£ê³  Orchestratorê°€ ì£¼ì…í•œë‹¤.</p>
  </li>
  <li>
    <p>ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ Planìœ¼ë¡œ í´ë°±í•œë‹¤(Responses+flat â†’ Completions+nested ê°™ì€ ìˆœì„œ).</p>
  </li>
  <li>
    <p>ê³„ì•½ í…ŒìŠ¤íŠ¸ë¥¼ CIì— ë„£ì–´ ëˆˆìœ¼ë¡œ í™•ì¸í•˜ê¸° ì „ì— â€œì–´ëŠ ì¡°í•©ì´ ê¹¨ì¡ŒëŠ”ì§€â€ ìë™ìœ¼ë¡œ ê²½ê³ ë°›ëŠ”ë‹¤.</p>
  </li>
</ol>

<p>APIì˜ ë¶ˆì¼ì¹˜ëŠ” ìš°ë¦¬ ì˜ëª»ì´ ì•„ë‹ˆë‹ˆ, ì‘ì€ ì–´ëŒ‘í„°/ì „ëµ ë ˆì´ì–´ë¡œ â€œì§œì¦â€ì„ ì½”ë“œ ê²½ê³„ ë°–ì— ê°€ë‘¬ë‘ëŠ” ê²Œ ì •ë‹µì´ì—ìš”. ì´ ë ˆì´ì–´ í•œ ë²ˆ ë§Œë“¤ì–´ë‘ë©´ ìƒˆ ëª¨ë¸ 10ê°œê°€ ë“¤ì–´ì™€ë„ í˜¸ì¶œë¶€ëŠ” ê±°ì˜ ì†ëŒˆ ì¼ì´ ì—†ì–´ì§‘ë‹ˆë‹¤.</p>

<p class="chat--user">

ê·¼ë° ë„ˆê°€ ë§í•œê²ƒë„ ëª» ë¯¿ê² ì–´. ì‹¤ì œ ë‚´ ì„œë¹™ í™˜ê²½ê³¼ api íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸í•´ë´ì•¼í•  ê²ƒ ê°™ì•„. ê·¸ëŸ°ë° top_p ê°™ì€ ê²ƒì€ í…ŒìŠ¤íŠ¸í•´ë´ë„ ì´ê²Œ ë°˜ì˜ì´ ëœ ê±´ì§€ ì•ˆ ëœ ê±´ì§€ ë‚´ê°€ ì•Œ ìˆ˜ê°€ ìˆë‚˜?

</p>

<p>ì™„ì „ ê³µê°. íŒŒë¼ë¯¸í„°ê°€ â€œë“¤ì–´ê°€ê¸´ í–ˆëŠ”ì§€, ëª¨ë¸ì´ ì‹¤ì œë¡œ ë°˜ì˜í–ˆëŠ”ì§€â€ëŠ” ë§ë§Œìœ¼ë¡  ëª» ë¯¿ì£ . ê·¸ë˜ì„œ ì‹¤ì œ ì„œë¹™ í™˜ê²½ì—ì„œ ì§ì ‘ ê²€ì¦í•˜ëŠ” ë¹„ë™ê¸° í…ŒìŠ¤íŠ¸ í•˜ë„¤ìŠ¤ë¥¼ ì¤˜ìš”. í•µì‹¬ì€ ë‘ ì¶•ì…ë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>ì „ì†¡ ê²€ì¦: HTTP ìš”ì²­ ë°”ë””ì— top_p, temperature ë“±ì´ ì‹¤ì œë¡œ í¬í•¨ë˜ëŠ”ì§€ ë¡œê¹…</p>
  </li>
  <li>
    <p>íš¨ê³¼ ê²€ì¦: ë™ì¼ í”„ë¡¬í”„íŠ¸ë¡œ ì—¬ëŸ¬ ë²ˆ ìƒ˜í”Œë§í•˜ì—¬ top_p ìŠ¤ìœ•ì— ë”°ë¼ ì¶œë ¥ ë‹¤ì–‘ì„±ì´ í†µê³„ì ìœ¼ë¡œ ë‹¬ë¼ì§€ëŠ”ì§€ í™•ì¸</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œëŠ” ë‘˜ ë‹¤ í•©ë‹ˆë‹¤. Responsesì™€ Completionsë¥¼ ì„ íƒí•´ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ëŒë¦´ ìˆ˜ ìˆê³ , ê° top_p êµ¬ê°„ì—ì„œ NíšŒ ìƒ˜í”Œë§í•˜ì—¬ í…ìŠ¤íŠ¸ ë‹¤ì–‘ì„± ì§€í‘œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. logprobs ì§€ì› ëª¨ë¸ì´ë©´ ìƒìœ„ í† í° ë¶„í¬ë„ ê°™ì´ ë¤í”„í•´ â€œëˆ„í´ë¦¬ì–´ìŠ¤ ì»·(top_p ì´í•˜ ëˆ„ì í™•ë¥ )â€ ì˜í–¥ë„ ê°„ì ‘ í™•ì¸í•©ë‹ˆë‹¤. ëª¨ë‘ ë¹„ë™ê¸° AsyncOpenAI + httpx.AsyncClient ì‚¬ìš©, ì´ë²¤íŠ¸ í›…ìœ¼ë¡œ ì‹¤ì œ ì „ì†¡ JSONì„ ìº¡ì²˜í•©ë‹ˆë‹¤.</p>

<p>ì„¤ëª… ìš”ì•½</p>

<ul>
  <li>
    <p>ì „ì†¡ ë¡œê¹…: httpx ì´ë²¤íŠ¸ í›…ì—ì„œ ìš”ì²­ JSONì„ íŒŒì‹±í•´ ì£¼ìš” í•„ë“œë§Œ ì¶œë ¥ ë° íŒŒì¼ ì €ì¥</p>
  </li>
  <li>
    <p>ë‹¤ì–‘ì„± ì§€í‘œ: íƒ€ì…-í† í° ë¹„ìœ¨(TTR), í‰ê·  ê¸¸ì´, ì‘ë‹µ ìŒ ê°„ 3-ê·¸ë¨ ìì¹´ë“œ ê±°ë¦¬ í‰ê· </p>
  </li>
  <li>
    <p>ìŠ¤ìœ•: ì˜ˆ) top_p âˆˆ {0.1, 0.3, 0.7, 0.95}, temperature ê³ ì •(ì˜ˆ: 0.8), ê° êµ¬ê°„ NíšŒ ìƒ˜í”Œ</p>
  </li>
  <li>
    <p>ê¸°ëŒ€ íŒ¨í„´: top_pê°€ ì»¤ì§ˆìˆ˜ë¡ í‰ê·  ìì¹´ë“œ ê±°ë¦¬, TTRì´ ì¦ê°€í•˜ëŠ” ê²½í–¥. ì „í˜€ ë³€í™”ê°€ ì—†ë‹¤ë©´ ëª¨ë¸/ì—”ë“œí¬ì¸íŠ¸ì—ì„œ íŒŒë¼ë¯¸í„°ê°€ ë¬´ì‹œë˜ì—ˆì„ ê°€ëŠ¥ì„±</p>
  </li>
  <li>
    <p>ì•ˆì „ì¥ì¹˜: Ctrl+C ë“± ì¸í„°ëŸ½íŠ¸ ì‹œ ì¦‰ì‹œ ì¤‘ì§€</p>
  </li>
</ul>

<p>ì½”ë“œ ì „ì²´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># async_param_probe.py
# Python 3.10+
# pip install --upgrade openai httpx
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">math</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># =========================
# Interrupt support
# =========================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">Interruptor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Simple async interrupt flag that can be triggered by signals or UI.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">interrupt_cb</span><span class="p">,</span> <span class="n">poll</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Await a coroutine while polling interruption.</span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="nf">interrupt_cb</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># =========================
# Request capture via httpx hooks
# =========================
</span>
<span class="k">class</span> <span class="nc">RequestCapture</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Capture outgoing JSON payloads for inspection.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_payload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">all_payloads</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">get_hooks</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="c1"># Keep only notable fields to keep logs readable
</span>                    <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">top_logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">top_logprobs</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">response_format</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">response_format</span><span class="sh">"</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">),</span>
                    <span class="p">}</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">last_payload</span> <span class="o">=</span> <span class="n">filtered</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">all_payloads</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># Best effort; never block the request
</span>                <span class="k">pass</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">on_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_request</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_response</span><span class="p">]}</span>

<span class="c1"># =========================
# Diversity metrics
# =========================
</span>
<span class="k">def</span> <span class="nf">tokenize_words</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">c</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">isalnum</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">]).</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">w</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">ngrams</span><span class="p">(</span><span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]]:</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">[</span><span class="nf">tuple</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">jaccard</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]],</span> <span class="n">b</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="n">sa</span><span class="p">,</span> <span class="n">sb</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nf">set</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">inter</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">sa</span> <span class="o">&amp;</span> <span class="n">sb</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">sa</span> <span class="o">|</span> <span class="n">sb</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">inter</span> <span class="o">/</span> <span class="n">union</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ttr</span><span class="p">(</span><span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pairwise_avg_jaccard</span><span class="p">(</span><span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">grams</span> <span class="o">=</span> <span class="p">[</span><span class="nf">ngrams</span><span class="p">(</span><span class="nf">tokenize_words</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)):</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nf">jaccard</span><span class="p">(</span><span class="n">grams</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">grams</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">summarize_diversity</span><span class="p">(</span><span class="n">samples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="p">[</span><span class="nf">tokenize_words</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">]</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">]</span>
    <span class="n">ttrs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">ttr</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">num_samples</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">avg_len_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">avg_ttr</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">ttrs</span><span class="p">)</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">ttrs</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">pairwise_jaccard_3gram</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">pairwise_avg_jaccard</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">pairwise_jaccard_2gram</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">pairwise_avg_jaccard</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">unique_ratio</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># =========================
# Probers
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProbeConfig</span><span class="p">:</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># "responses" | "completions"
</span>    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">top_p_grid</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
    <span class="n">samples_per_setting</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./probe_logs</span><span class="sh">"</span>
    <span class="n">use_logprobs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>      <span class="c1"># Only for completions if model supports it
</span>
<span class="k">def</span> <span class="nf">sanitize_filename</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">-_.</span><span class="sh">"</span> <span class="k">else</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">sample_once_responses</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">top_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="n">_client</span><span class="p">.</span><span class="n">_base_url</span><span class="p">,</span>  <span class="c1"># wrong; fix below
</span>    <span class="p">)</span>
    <span class="c1"># We will implement properly in the caller using **params normalization; keep explicit here.
</span>    <span class="k">raise</span> <span class="nc">NotImplementedError</span><span class="p">(</span><span class="sh">"</span><span class="s">Use run_responses_batch; do not call directly.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_responses_batch</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">top_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">:</span> <span class="n">Interruptor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful and concise.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
        <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="n">_client</span><span class="p">.</span><span class="n">_headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">x-stainless-model</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">unknown-model</span><span class="sh">"</span><span class="p">,</span>
            <span class="c1"># The AsyncOpenAI SDK requires model at call-site; we provide it via partial elsewhere.
</span>        <span class="p">),</span>
        <span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">.</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_completions_batch</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">top_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">use_logprobs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">:</span> <span class="n">Interruptor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
        <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful and concise.</span><span class="sh">"</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
            <span class="p">],</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
            <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span>
            <span class="c1"># Logprobs is model-dependent; if unsupported it will raise. Handle at caller.
</span>            <span class="o">**</span><span class="p">({</span><span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">top_logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span> <span class="k">if</span> <span class="n">use_logprobs</span> <span class="k">else</span> <span class="p">{}),</span>
        <span class="p">),</span>
        <span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
    <span class="p">)</span>
    <span class="n">out_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
    <span class="n">out_logprobs</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">out_text</span><span class="p">,</span> <span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">out_logprobs</span><span class="p">}</span>

<span class="c1"># =========================
# Runner
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">run_probe</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ProbeConfig</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">:</span> <span class="n">Interruptor</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">request_log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">capture</span> <span class="o">=</span> <span class="nc">RequestCapture</span><span class="p">()</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="n">capture</span><span class="p">.</span><span class="nf">get_hooks</span><span class="p">()</span>

    <span class="c1"># Build AsyncOpenAI client with httpx hooks
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
                <span class="c1"># For Responses we construct the call per-sample to vary top_p.
</span>                <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">.</span><span class="n">top_p_grid</span><span class="p">:</span>
                    <span class="k">await</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">)</span>
                    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">samples_per_setting</span><span class="p">):</span>
                        <span class="k">await</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                            <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                                <span class="nb">input</span><span class="o">=</span><span class="p">[</span>
                                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Be helpful and concise.</span><span class="sh">"</span><span class="p">},</span>
                                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">cfg</span><span class="p">.</span><span class="n">prompt</span><span class="p">},</span>
                                <span class="p">],</span>
                                <span class="n">temperature</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span>
                                <span class="n">top_p</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                        <span class="p">)</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="nf">summarize_diversity</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">top_p=</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">samples</span><span class="sh">"</span><span class="p">:</span> <span class="n">texts</span><span class="p">,</span> <span class="sh">"</span><span class="s">stats</span><span class="sh">"</span><span class="p">:</span> <span class="n">stats</span><span class="p">}</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[responses] top_p=</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s"> =&gt; </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">.</span><span class="n">top_p_grid</span><span class="p">:</span>
                    <span class="k">await</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">)</span>
                    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">first_logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">samples_per_setting</span><span class="p">):</span>
                        <span class="k">await</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_completions_batch</span><span class="p">(</span>
                                <span class="n">client</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">use_logprobs</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">use_logprobs</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="n">interrupt</span>
                            <span class="p">)</span>
                            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">first_logprobs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">first_logprobs</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">logprobs</span><span class="sh">"</span><span class="p">]</span>
                        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="c1"># Fallback if logprobs not supported or param rejected
</span>                            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_completions_batch</span><span class="p">(</span>
                                <span class="n">client</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">use_logprobs</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="n">interrupt</span>
                            <span class="p">)</span>
                            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
                            <span class="n">first_logprobs</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="nf">summarize_diversity</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">top_p=</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">samples</span><span class="sh">"</span><span class="p">:</span> <span class="n">texts</span><span class="p">,</span> <span class="sh">"</span><span class="s">stats</span><span class="sh">"</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span> <span class="sh">"</span><span class="s">first_logprobs</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_maybe_slim_logprobs</span><span class="p">(</span><span class="n">first_logprobs</span><span class="p">)}</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[completions] top_p=</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s"> =&gt; </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># Persist request payloads and results
</span>            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">request_log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">requests_</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nf">sanitize_filename</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">capture</span><span class="p">.</span><span class="n">all_payloads</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">request_log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">results_</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nf">sanitize_filename</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Saved logs under: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">request_log_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Key check 1: Open requests_*.json to confirm top_p/temperature got sent.</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Key check 2: Inspect stats monotonicity across top_p grid. If flat, top_p may be ignored.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_maybe_slim_logprobs</span><span class="p">(</span><span class="n">lp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Reduce logprobs payload size for storage, keeping only first 10 tokens.</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="c1"># OpenAI SDK returns a structured object; convert to dict and trim
</span>            <span class="n">d</span> <span class="o">=</span> <span class="n">lp</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">d</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="c1"># If already dict-like
</span>        <span class="k">return</span> <span class="n">lp</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_guard</span><span class="p">(</span><span class="n">interrupt</span><span class="p">:</span> <span class="n">Interruptor</span><span class="p">):</span>
    <span class="k">if</span> <span class="k">await</span> <span class="n">interrupt</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Interrupted by user</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# CLI
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">amain</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Async parameter probe for top_p/temperature (Responses or Completions).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--protocol</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--base-url</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api-key</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--prompt</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">Write a two-sentence review of a fictional cafe. Be creative.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--temperature</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--top-p</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">0.1,0.3,0.7,0.95</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Comma-separated values to sweep.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--n</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Samples per setting.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--logdir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">./probe_logs</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--no-logprobs</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Disable logprobs even if supported (completions only).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">interrupt</span> <span class="o">=</span> <span class="nc">Interruptor</span><span class="p">()</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">NotImplementedError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">ProbeConfig</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">top_p_grid</span><span class="o">=</span><span class="nf">tuple</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">.</span><span class="n">top_p</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)),</span>
        <span class="n">samples_per_setting</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">,</span>
        <span class="n">request_log_dir</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">logdir</span><span class="p">,</span>
        <span class="n">use_logprobs</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="p">.</span><span class="n">no_logprobs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Build client and run
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="nf">run_probe</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">ERROR:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">amain</span><span class="p">())</span>
</code></pre></div></div>

<p>ì–´ë–»ê²Œ í•´ì„í•˜ë©´ ë˜ë‚˜</p>

<ol>
  <li>
    <p>requests__.jsonì„ ì—´ì–´ ì‹¤ì œ ìš”ì²­ ë°”ë””ì— top_p, temperature, max__ ê°€ ë“¤ì–´ê°”ëŠ”ì§€ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤. ì´ê±´ â€œì „ì†¡ì€ ëë‹¤â€ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>results_*.jsonì˜ statsë¥¼ ë´…ë‹ˆë‹¤. top_pê°€ ì»¤ì§ˆìˆ˜ë¡ pairwise_jaccard_3gram, avg_ttr, unique_ratioê°€ ë³´í†µ ì¦ê°€í•©ë‹ˆë‹¤. ë³€ë™ì´ ê±°ì˜ ì—†ë‹¤ë©´ ëª¨ë¸ì´ top_pë¥¼ ë¬´ì‹œí•˜ëŠ”ì§€, temperatureê°€ ë„ˆë¬´ ë‚®ì€ì§€, í”„ë¡¬í”„íŠ¸ê°€ ì§€ë‚˜ì¹˜ê²Œ ê²°ì •ì ì¸ì§€(ì‚¬ì‹¤ìƒ í•œ ê°€ì§€ ë‹µ) ì ê²€í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>Completionsì—ì„œ logprobsê°€ ì§€ì›ë˜ë©´ first_logprobsë¡œ í† í° í›„ë³´ì™€ í™•ë¥ ì´ ë“¤ì–´ì˜µë‹ˆë‹¤. top_pê°€ ë‚®ì„ ë•ŒëŠ” ìƒìœ„ í† í°ì— í™•ë¥  ì§ˆëŸ‰ì´ ë” ì§‘ì¤‘ë˜ëŠ” ê²½í–¥ì„ ê°„ì ‘ì ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì§€ì› ì•ˆ ë˜ë©´ ì½”ë“œê°€ ìë™ìœ¼ë¡œ ë„ê³  ì§„í–‰í•©ë‹ˆë‹¤.</p>
  </li>
</ol>

<p>ì‹¤í—˜ íŒ</p>

<ul>
  <li>
    <p>temperatureë¥¼ 0.7~0.9 ì •ë„ë¡œ ë‘ê³  top_pë¥¼ ìŠ¤ìœ•í•˜ë©´ ì°¨ì´ê°€ ê°€ì¥ ì˜ ë“œëŸ¬ë‚©ë‹ˆë‹¤. temperatureê°€ 0ì´ë©´ ìƒ˜í”Œë§ ìì²´ê°€ ê±°ì˜ ê²°ì •ì ì´ë¼ ì°¨ì´ê°€ ì•ˆ ë³´ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í”„ë¡¬í”„íŠ¸ëŠ” â€œì‚¬ì‹¤ìƒ ì •ë‹µ í•œ ê°œâ€ì¸ ì§€ì‹ì§ˆë¬¸ë³´ë‹¤, ì°½ì˜ì  ìƒì„±ì´ë‚˜ ìš”ì•½-ì¬ì„œìˆ ì´ ë‹¤ì–‘ì„± ì¸¡ì •ì— ìœ ë¦¬í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>max_* ì œí•œì„ ë„ˆë¬´ ë¹¡ë¹¡í•˜ê²Œ ì£¼ë©´ ëª¨ë“  ìƒ˜í”Œì´ ì§§ì•„ì ¸ ì°¨ì´ê°€ ì¤„ì–´ë“­ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>íŒŒë¼ë¯¸í„° ì˜¤ë¥˜ë¥¼ ì˜ë„ì ìœ¼ë¡œ ë³´ë‚´ ê²€ì¦í•´ë„ ì¢‹ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ top_p=-1 ê°™ì€ ê°’ì€ ì„œë²„ì—ì„œ ê±°ì ˆë¼ì•¼ í•©ë‹ˆë‹¤. ê±°ì ˆë˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ì—”ë“œí¬ì¸íŠ¸ê°€ íŒŒë¼ë¯¸í„°ë¥¼ ë¬´ì‹œí•˜ê±°ë‚˜ ìì²´ ì •ê·œí™”í•  ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì´ í•˜ë„¤ìŠ¤ë¡œ ì‹¤ì œ ì„œë¹™ í™˜ê²½ê³¼ ì„¤ì¹˜ëœ SDKì—ì„œ â€œì „ì†¡ ì—¬ë¶€â€ì™€ â€œíš¨ê³¼ ì¡´ì¬ ì—¬ë¶€â€ë¥¼ ëª¨ë‘ ê³„ëŸ‰ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>

<p class="chat--user">

ì¢…í•©í•´ì„œ, ë‚´ê°€ ë§í•œ ëª¨ë“  ê²ƒë“¤ì„ ë§Œì¡±í•˜ëŠ” íŒŒì´ì¬ ì½”ë“œ ì„¤ê³„í•˜ê³  ë§Œë“¤ì–´ì¤˜. 1. Response/Chat Completions API ì„ íƒ + tool JSON format ì„ íƒ + LLM Parameterë¡œë¶€í„° argument ë³€í™˜ ë²• ì„ íƒ 2. Config íŒŒì¼ì— ì—¬ëŸ¬ ëª¨ë¸ ì„¤ì •ì— ëŒ€í•´ ê°ê°ì˜ ëª¨ë¸ + API + JSON í¬ë§·ì„ ë¯¸ë¦¬ ì •ì˜í•´ë‘˜ ê±°ì•¼ (config.toml íŒŒì¼ë¡œ ìƒê° ì¤‘ - ì´ ì¡°í•© 1ê°œë¥¼ api_providerë¼ê³  ë¶€ë¥¼ê±°ê³  name(ìœ ì €ê°€ ë³´ëŠ” ì´ë¦„), ëª¨ë¸(í˜¸ì¶œ ì‹œ ì“°ì´ëŠ” ëª¨ë¸ëª…), base_url, api_key, api í˜•ì‹, íˆ´ í˜•ì‹, argument ì–´ëŒ‘í„° í˜•ì‹ì„ ê¸°ì…í• ê±°ì•¼) ê·¸ê±¸ ì½ì–´ì™€ì„œ ìœ ì €ê°€ api_provider nameë§Œ ë³´ê³  ê³ ë¥´ê³  user prompt(+system prompt)ì™€ íˆ´ ì„ íƒë§Œ í•˜ê³  ì‹¤í–‰í•˜ë©´ ì˜ ë™ì‘í•˜ë„ë¡ êµ¬ì„±í•´ì¤˜. 

</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># orchestrator_async_configurable.py
# Python 3.10+
# Dependencies: pip install --upgrade openai httpx
#
# -------------------------------------------------------------
# What this file provides
# -------------------------------------------------------------
# 1) A clean, extensible design to run tool-calling LLMs with:
#    - API choice: Responses vs Chat Completions
#    - Tool JSON shape choice: "flat" (new) vs "nested" (legacy)
#    - Argument mapping (neutral â†’ endpoint-specific) strategy choice
# 2) Async-only I/O (AsyncOpenAI + httpx.AsyncClient with hooks)
# 3) User interrupt support via user.processing_interrupted()
# 4) Providers are defined in a config.toml, each called an "api_provider".
#    Users pick a provider by name; system/user prompts and tool selection
#    are provided at runtime.
#
# -------------------------------------------------------------
# Example config.toml (put this next to the script)
# -------------------------------------------------------------
# [[api_provider]]
# name = "OSS GPT (Responses + Flat + RespAdapter)"
# model = "gpt-4.1-mini"
# base_url = "https://api.openai.com/v1"
# api_key_env = "OPENAI_API_KEY"   # or use: api_key = "sk-..."
# api = "responses"                # "responses" | "completions"
# tool_json = "flat"               # "flat" | "nested"
# arg_adapter = "responses"        # "responses" | "completions" | "completions_reasoning"
#
# [[api_provider]]
# name = "Qwen-like (Completions + Nested + CompAdapter)"
# model = "qwen2.5"
# base_url = "https://api.openai.com/v1"
# api_key_env = "QWEN_API_KEY"
# api = "completions"
# tool_json = "nested"
# arg_adapter = "completions"
#
# -------------------------------------------------------------
# CLI usage examples
# -------------------------------------------------------------
# python orchestrator_async_configurable.py \
#   --config ./config.toml \
#   --provider "OSS GPT (Responses + Flat + RespAdapter)" \
#   --system "You are a helpful assistant that uses tools when needed." \
#   --user "List files under ./samples, pick a text file, read it, and summarize in 2-3 sentences." \
#   --enable-tools list_files_in_folder,read_text_file \
#   --length 400 --temperature 0.7 --top-p 0.9
#
# -------------------------------------------------------------
# Notes
# -------------------------------------------------------------
# - This script outputs plain text only (no JSON-mode / structured parsing).
# - Tools are executed locally and results are passed back to the model.
# - Interrupts: SIGINT/SIGTERM will stop ongoing requests cleanly.
# - If tomllib is not available (Python &lt;3.11), you can `pip install tomli`.
#
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># TOML loader with fallback
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># Python 3.11+
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomllib</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># fallback
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">tomli</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># ============================================================
# Interrupt support
# ============================================================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">UserInterface</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Minimal user interface object that exposes `processing_interrupted()`.
    Replace/extend this for GUI/Server integration if needed.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span><span class="p">,</span> <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Await a coroutine while periodically checking user.processing_interrupted().
    If interrupted, cancel the task and raise UserCancelledError.
    </span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c1"># ============================================================
# Model &amp; Provider profiles from config
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ProviderProfile</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Single provider (api_provider) loaded from config.toml.</span><span class="sh">"""</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span>         <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_json</span><span class="p">:</span> <span class="nb">str</span>   <span class="c1"># "flat" | "nested"
</span>    <span class="n">arg_adapter</span><span class="p">:</span> <span class="nb">str</span> <span class="c1"># "responses" | "completions" | "completions_reasoning"
</span>
<span class="k">def</span> <span class="nf">load_providers</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    Load providers from config.toml (or .json if needed).
    Returns a dict mapping provider name -&gt; profile.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Config not found: </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Read bytes
</span>    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

    <span class="c1"># Parse TOML (preferred)
</span>    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.toml</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tomllib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tomli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">TOML parser not available. Install Python 3.11+ or `pip install tomli`.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback: JSON
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">providers_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">providers_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Invalid config: expected [[api_provider]] entries.</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProviderProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api_key_env</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key_env</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tool_json</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">arg_adapter</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arg_adapter</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tool_json</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">arg_adapter</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalid provider entry: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Resolve API key: direct string takes precedence; else from env var.
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key_env</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">api_key_env</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">API key missing for provider </span><span class="sh">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">'</span><span class="s">. Use api_key or api_key_env.</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="nc">ProviderProfile</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span>
            <span class="n">tool_json</span><span class="o">=</span><span class="n">tool_json</span><span class="p">,</span>
            <span class="n">arg_adapter</span><span class="o">=</span><span class="n">arg_adapter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ============================================================
# Tool layer
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Single tool spec + local implementation.</span><span class="sh">"""</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Callable[[Dict[str, Any]], Any]
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Holds tools and executes them by name.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>
        <span class="n">selected</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
                <span class="n">selected</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">selected</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># Concrete tools (fast local I/O)
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_file_impl</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_default_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_in_folder_impl</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to a text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_file_impl</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># ============================================================
# Tool JSON builders (Factory)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Flat tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Nested tool JSON: { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{...} }</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">get_tool_builder</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolJSONBuilder</span><span class="p">:</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">FlatToolJSONBuilder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">NestedToolJSONBuilder</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool_json type: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Neutral â†’ Endpoint-specific parameter mapping (Adapters)
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">NeutralParams</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Neutral params that callers can pass without worrying about endpoint differences.</span><span class="sh">"""</span>
    <span class="n">length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># "low"|"medium"|"high" (if supported)
</span>
<span class="k">class</span> <span class="nc">ArgAdapter</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build_for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">build_for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">ResponsesArgAdapter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Use max_output_tokens + reasoning in Responses; reasonable defaults elsewhere.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build_for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">build_for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="c1"># reasoning may be ignored by non-reasoning chat models
</span>        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">CompletionsArgAdapter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Use max_tokens for completions; map others as common fields.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build_for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># If someone forces this adapter onto Responses: do a best-effort mapping
</span>        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">build_for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">CompletionsReasoningArgAdapter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Use max_completion_tokens + reasoning for reasoning-friendly chat models.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build_for_responses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_output_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">build_for_completions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">neutral</span><span class="p">:</span> <span class="n">NeutralParams</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">max_completion_tokens</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">neutral</span><span class="p">.</span><span class="n">top_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">stop</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral</span><span class="p">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">reasoning</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">effort</span><span class="sh">"</span><span class="p">:</span> <span class="n">neutral</span><span class="p">.</span><span class="n">reasoning_effort</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">get_arg_adapter</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArgAdapter</span><span class="p">:</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">ResponsesArgAdapter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsArgAdapter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions_reasoning</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsReasoningArgAdapter</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown arg_adapter: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Protocol strategies (Async, plain-text only)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ProtocolStrategy</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">ResponsesStrategy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    responses.create loop:
      - Send input + tools
      - Collect text
      - If function calls appear: execute locally and append function_call_output
      - Repeat until no more tool calls
    </span><span class="sh">"""</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># First call
</span>        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">payload_args</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
            <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
            <span class="n">user</span>
        <span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Execute tools and append outputs into input messages
</span>            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="c1"># Check for user interrupt between tool calls
</span>                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">registry</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># Next turn
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span>
                <span class="o">**</span><span class="n">payload_args</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
                <span class="n">user</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">CompletionsStrategy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    chat.completions.create loop:
      - Send messages + tools
      - If tool_calls appear: execute locally and append tool messages
      - Repeat until no more tool_calls
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">payload_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools_json</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">payload_args</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
            <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
            <span class="n">user</span>
        <span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">tool_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">user</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">registry</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
                <span class="o">**</span><span class="n">payload_args</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">),</span>
                <span class="n">user</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_protocol_strategy</span><span class="p">(</span><span class="n">api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProtocolStrategy</span><span class="p">:</span>
    <span class="n">api</span> <span class="o">=</span> <span class="p">(</span><span class="n">api</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">ResponsesStrategy</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">CompletionsStrategy</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown api type: </span><span class="si">{</span><span class="n">api</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# HTTPX hooks (optional request logging)
# ============================================================
</span>
<span class="k">def</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># Uncomment to debug requests:
</span>        <span class="c1"># if request.headers.get("content-type","").startswith("application/json"):
</span>        <span class="c1">#     print("[httpx] -&gt;", request.method, request.url)
</span>        <span class="k">return</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="c1"># Uncomment to debug responses:
</span>        <span class="c1"># print("[httpx] &lt;-", response.status_code, response.request.url)
</span>        <span class="k">return</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_request</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_response</span><span class="p">]}</span>

<span class="c1"># ============================================================
# Orchestrator (ties everything together)
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RunOptions</span><span class="p">:</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">enabled_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">neutral_params</span><span class="p">:</span> <span class="n">NeutralParams</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_provider</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">ProviderProfile</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">RunOptions</span><span class="p">,</span>
    <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">UserInterface</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Single-shot run given a ProviderProfile and run options.
    </span><span class="sh">"""</span>
    <span class="c1"># Select tools
</span>    <span class="n">specs</span> <span class="o">=</span> <span class="n">registry</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">enabled_tools</span><span class="p">)</span>
    <span class="c1"># Build tool JSON
</span>    <span class="n">tools_builder</span> <span class="o">=</span> <span class="nf">get_tool_builder</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">tool_json</span><span class="p">)</span>
    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">tools_builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

    <span class="c1"># Build messages
</span>    <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Responses expects "input" messages (role/content pair objects)
</span>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">user_prompt</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Completions expects chat "messages"
</span>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">user_prompt</span><span class="p">},</span>
        <span class="p">]</span>

    <span class="c1"># Build endpoint-specific argument payload
</span>    <span class="n">adapter</span> <span class="o">=</span> <span class="nf">get_arg_adapter</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">arg_adapter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">provider</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">payload_args</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">build_for_responses</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">neutral_params</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">payload_args</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">build_for_completions</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">neutral_params</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools_json</span><span class="p">)</span>

    <span class="c1"># Strategy by API
</span>    <span class="n">strategy</span> <span class="o">=</span> <span class="nf">get_protocol_strategy</span><span class="p">(</span><span class="n">provider</span><span class="p">.</span><span class="n">api</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>

    <span class="c1"># Async client creation (single session) with hooks
</span>    <span class="n">hooks</span> <span class="o">=</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="c1"># Run and return final plain text
</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">strategy</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
                <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">provider</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools_json</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                <span class="n">payload_args</span><span class="o">=</span><span class="n">payload_args</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>

<span class="c1"># ============================================================
# CLI entry point
# ============================================================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">amain</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Async LLM Orchestrator with configurable API/Tools/Arg adapters.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--config</span><span class="sh">"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Path to config.toml (or .json fallback).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--provider</span><span class="sh">"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">api_provider name from the config.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--system</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--user</span><span class="sh">"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">User prompt to run.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--enable-tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder,read_text_file</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Comma-separated tool names (subset of registered).</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># Neutral params
</span>    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--length</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Neutral length cap (mapped to endpoint-specific).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--temperature</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--top-p</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="sh">"</span><span class="s">top_p</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--stop</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Comma-separated stop tokens.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--reasoning-effort</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">One of </span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="s"> (if supported).</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># Build the user interrupt controller and wire OS signals
</span>    <span class="n">user</span> <span class="o">=</span> <span class="nc">UserInterface</span><span class="p">()</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">trigger_interrupt</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">NotImplementedError</span><span class="p">:</span>
        <span class="c1"># Some platforms (e.g., certain Windows envs) may not support this
</span>        <span class="k">pass</span>

    <span class="c1"># Load providers
</span>    <span class="n">providers</span> <span class="o">=</span> <span class="nf">load_providers</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">provider</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Provider </span><span class="sh">'</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">provider</span><span class="si">}</span><span class="sh">'</span><span class="s"> not found in config. Available: </span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">providers</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">provider</span> <span class="o">=</span> <span class="n">providers</span><span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">provider</span><span class="p">]</span>

    <span class="c1"># Prepare tools
</span>    <span class="n">registry</span> <span class="o">=</span> <span class="nf">build_default_tools</span><span class="p">()</span>
    <span class="n">enabled_tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">args</span><span class="p">.</span><span class="n">enable_tools</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">enable_tools</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">stop</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">stop</span> <span class="k">else</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">s</span><span class="p">]</span>

    <span class="c1"># Prepare neutral params
</span>    <span class="n">neutral</span> <span class="o">=</span> <span class="nc">NeutralParams</span><span class="p">(</span>
        <span class="n">length</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">top_p</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">top_p</span><span class="p">,</span>
        <span class="n">stop</span><span class="o">=</span><span class="n">stop</span> <span class="k">if</span> <span class="n">stop</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">reasoning_effort</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">reasoning_effort</span>
    <span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="nc">RunOptions</span><span class="p">(</span>
        <span class="n">system_prompt</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">system</span><span class="p">,</span>
        <span class="n">user_prompt</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">enabled_tools</span><span class="o">=</span><span class="n">enabled_tools</span><span class="p">,</span>
        <span class="n">neutral_params</span><span class="o">=</span><span class="n">neutral</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== INTERRUPTED ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== ERROR ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">amain</span><span class="p">())</span>
</code></pre></div></div>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">OpenAI í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸</title><link href="https://hvppyarchive.github.io/llm/openai-function-call-examples/" rel="alternate" type="text/html" title="OpenAI í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸" /><published>2025-10-24T16:39:17+09:00</published><updated>2025-10-24T16:39:17+09:00</updated><id>https://hvppyarchive.github.io/llm/openai-function-call-examples</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/openai-function-call-examples/"><![CDATA[<p class="chat--user">

openai packageë¥¼ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±í• ê±°ì•¼. ëª©í‘œ: 2ê°€ì§€ ëª¨ë¸ì— ëŒ€í•´ 2ê°€ì§€ api type(completions, responses)ì— ëŒ€í•´ function calling í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³  ì‹¶ì–´. ì´ 4ê°œ ì¡°í•©ì— ëŒ€í•´ ì„¤ì •í•  ìˆ˜ ìˆê²Œ ì½”ë“œ ì‘ì„± í•˜ì. íˆ´ì€ ê°„ë‹¨íˆ íŠ¹ì • í´ë”ì˜ íŒŒì¼ ì¡°íšŒ, íŠ¹ì • í´ë”ì˜ íŒŒì¼ ì½ê¸° ë‘ ê°€ì§€ íˆ´ì„ êµ¬í˜„í• ê±°ì•¼ 2ê°œ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸, api í‚¤, ëª¨ë¸ëª…ì„ ì½”ë“œ ë‚´ì—ì„œ ì„¤ì •í•  ìˆ˜ ìˆë„ë¡ í•  ê²ƒ.

</p>

<p>ì¢‹ì•„! ì•„ë˜ëŠ” â€œë‘ ëª¨ë¸ Ã— ë‘ API íƒ€ì…(completions, responses) Ã— í•¨ìˆ˜ í˜¸ì¶œ(function calling)â€ ì¡°í•©ì„ í•œ íŒŒì¼ì—ì„œ ëª¨ë‘ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ì•¼.<br />
ìš”êµ¬ì‚¬í•­ ì •ë¦¬ëŒ€ë¡œ</p>

<ol>
  <li>
    <p>ë‘ ê°€ì§€ íŒŒì¼ ê´€ë ¨ íˆ´(í´ë” ë‚´ íŒŒì¼ ëª©ë¡ ì¡°íšŒ, íŒŒì¼ ì½ê¸°)</p>
  </li>
  <li>
    <p>2ê°œ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸Â·API í‚¤Â·ëª¨ë¸ëª…ì„ ì½”ë“œ ë‚´ì—ì„œ ì„¤ì • ê°€ëŠ¥</p>
  </li>
  <li>
    <p>4ê°€ì§€ ì¡°í•©ì„ ì›í•˜ëŠ” ëŒ€ë¡œ ì‹¤í–‰ ê°€ëŠ¥</p>
  </li>
</ol>

<p>ì„ ëª¨ë‘ ë‹´ì•˜ì–´. ìµœì‹  OpenAI Python SDKì˜ ì‚¬ìš©ë²•ê³¼ Responses APIì˜ íˆ´ í˜¸ì¶œ íë¦„ì€ ê³µì‹ ë¬¸ì„œì˜ êµ¬ì¡°ë¥¼ ë”°ëì–´. ì°¸ê³ : function callingê³¼ tools ì •ì˜ ë°©ì‹ì€ ê³µì‹ ê°€ì´ë“œì™€ ë™ì¼í•˜ê³ , Chat Completions APIì—ì„œëŠ” tool_callsë¥¼ messageì—, Responses APIì—ì„œëŠ” output í•­ëª©ê³¼ tool_callsë¥¼ í†µí•´ ì£¼ê³ ë°›ëŠ” í˜•íƒœì•¼. ê´€ë ¨ ë¬¸ì„œ: Function Calling ê°€ì´ë“œì™€ Responses API ë ˆí¼ëŸ°ìŠ¤. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼+1</a></p>

<p>ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒì²˜ëŸ¼ ë™ì‘í•´</p>

<ul>
  <li>
    <p>MODELS ì„¹ì…˜ì—ì„œ model A/Bì˜ endpoint, api_key, model ì´ë¦„ì„ ì±„ì›Œë‘”ë‹¤(ì˜ˆì‹œ í¬í•¨).</p>
  </li>
  <li>
    <p>TOOL ì •ì˜ëŠ” ê³µí†µ(JSON Schema).</p>
  </li>
  <li>
    <p>run_with_chat_completions(â€¦), run_with_responses(â€¦) ë‘ í•¨ìˆ˜ê°€ ê°ê° í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„ë¥¼ ìˆ˜í–‰.</p>
  </li>
  <li>
    <p>mainì—ì„œ ë„¤ ê°€ì§€ ì¡°í•©ì„ ìˆœì°¨ ì‹¤í–‰í•˜ê±°ë‚˜, ì›í•˜ëŠ” ì¡°í•©ë§Œ ì„ íƒ ì‹¤í–‰í•˜ë„ë¡ CLI ì˜µì…˜ ì œê³µ.</p>
  </li>
</ul>

<p>ì½”ë“œ ë³µì‚¬í•´ì„œ test_openai_tools.pyë¡œ ì €ì¥í•œ ë’¤, samples í´ë”ì— í…ŒìŠ¤íŠ¸ìš© íŒŒì¼ì„ ëª‡ ê°œ ë„£ê³  ëŒë ¤ë´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 1) êµ¬ì„±(ëª¨ë¸/ì—”ë“œí¬ì¸íŠ¸/í‚¤)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># ex) "https://api.openai.com/v1"
</span>    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># ex) os.getenv("OPENAI_API_KEY")
</span>
<span class="c1"># ì—¬ê¸°ì„œ ë‘ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸/í‚¤/ëª¨ë¸ëª…ì„ ì„¤ì •í•˜ì„¸ìš”.
# ì‹¤ì œ í‚¤ë¥¼ ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì§€ ë§ê³ , í™˜ê²½ë³€ìˆ˜ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
</span><span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">,</span>          <span class="c1"># ì˜ˆì‹œ (ì›í•˜ëŠ” ìµœì‹  ëª¨ë¸ëª…ìœ¼ë¡œ ë³€ê²½)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>           <span class="c1"># ì˜ˆì‹œ (ì›í•˜ëŠ” ìµœì‹  ëª¨ë¸ëª…ìœ¼ë¡œ ë³€ê²½)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =====================================
# 2) ë¡œì»¬ íŒŒì¼ íˆ´(í´ë” ëª©ë¡/íŒŒì¼ ì½ê¸°)
# =====================================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì§€ì • í´ë” ë‚´ íŒŒì¼ ëª©ë¡ ë°˜í™˜(íŒŒì¼ë§Œ).</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">files</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ì§€ì • ê²½ë¡œì˜ í…ìŠ¤íŠ¸ íŒŒì¼ ë‚´ìš© ë°˜í™˜(UTF-8 ê°€ì •).</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c1"># ë°”ì´ë„ˆë¦¬ ë“± í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ê²½ìš°
</span>        <span class="k">return</span> <span class="sh">""</span>

<span class="c1"># ê³µí†µ íˆ´ ìŠ¤í‚¤ë§ˆ(JSON Schema; Chat Completions/Responsesì—ì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
</span><span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content as a string.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># íˆ´ ë””ìŠ¤íŒ¨ì²˜
</span><span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># =====================================
# 3) Chat Completionsë¡œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
# =====================================
</span>
<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chat Completions APIë¡œ function calling í…ŒìŠ¤íŠ¸.
    - tools: TOOLS
    - tool_choice: </span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="s"> ê¶Œì¥
    - tool_calls -&gt; ì‹¤ì œ íŒŒì´ì¬ í•¨ìˆ˜ ì‹¤í–‰ -&gt; tool ë©”ì‹œì§€ ì²¨ë¶€ -&gt; ì¬í˜¸ì¶œ
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>  <span class="c1"># 'auto' or {'type':'function','function':{'name':'...'}}
</span>    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
</span>    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="c1"># tool ë©”ì‹œì§€ ì²¨ë¶€
</span>            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_output</span>
            <span class="p">})</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="c1"># í›„ì† í˜¸ì¶œ(ìµœì¢… ë‹µë³€ ìœ ë„)
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =====================================
# 4) Responses APIë¡œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
#    - ìµœì‹  SDK ê·œì•½ì— ë§ì¶° ë¹„ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ êµ¬ì„±
# =====================================
</span>
<span class="k">def</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Responses APIì˜ output ë°°ì—´ì—ì„œ ìì—°ì–´ í…ìŠ¤íŠ¸ë§Œ ëª¨ì•„ ë°˜í™˜.</span><span class="sh">"""</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># item.type == "message" ì¸ ê²½ìš°, item.content[*] ì¤‘ type == "output_text"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="c1"># ì¼ë¶€ ëª¨ë¸ì€ ìµœì¢…ì— ë°”ë¡œ output_textë§Œ ë‚´ë³´ë‚´ê¸°ë„ í•¨
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì˜ outputì—ì„œ tool_call ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘.
    ê° í•­ëª©ì€ {id, name, arguments} í˜•íƒœë¡œ ì •ê·œí™”í•´ì„œ ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># ì¼€ì´ìŠ¤1: item.type == "tool_call"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">tc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
            <span class="c1"># argumentsëŠ” ë¬¸ìì—´/ë”•ì…”ë„ˆë¦¬ ëª¨ë‘ ê°€ëŠ¥ì„± ê³ ë ¤
</span>            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span>

        <span class="c1"># ì¼€ì´ìŠ¤2: item.type == "message" ë‚´ë¶€ content[*]ì— tool_calls ë¬¶ì—¬ìˆì„ ìˆ˜ ìˆìŒ
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># ì¼ë¶€ SDK ë²„ì „ì—ì„œ item.tool_calls ë˜ëŠ” item.content[*].tool_calls í˜•íƒœ
</span>            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">arg_obj</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIë¡œ function calling í…ŒìŠ¤íŠ¸.
    íë¦„:
      1) responses.create(input=[{role:user, content:...}], tools=TOOLS, tool_choice=...)
      2) tool_callì´ ìˆìœ¼ë©´ ë¡œì»¬ í•¨ìˆ˜ ì‹¤í–‰
      3) responses.create(..., tool_outputs=[{tool_call_id, output}], response_id=prev.id) ë¡œ ì´ì–´ì„œ í˜¸ì¶œ
         (ìµœì‹  ë¬¸ì„œì˜ ê·œì•½ì„ ë”°ë¦„)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>
    <span class="p">)</span>

    <span class="c1"># ë£¨í”„: ë„êµ¬ í˜¸ì¶œì´ ëë‚  ë•Œê¹Œì§€
</span>    <span class="n">final_text_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># ì•ˆì „ ìƒí•œ
</span>        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">plain_text</span> <span class="o">=</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">plain_text</span><span class="p">:</span>
            <span class="n">final_text_parts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span>
            <span class="p">})</span>

        <span class="c1"># ì´ì „ responseì™€ ì´ì–´ ë¶™ì—¬ íˆ´ ê²°ê³¼ë¥¼ ì „ë‹¬
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs_payload</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">final_text_parts</span> <span class="k">if</span> <span class="n">p</span><span class="p">])</span>

<span class="c1"># =====================================
# 5) ì‹¤í–‰ë¶€(4ê°€ì§€ ì¡°í•©)
# =====================================
</span>
<span class="n">DEFAULT_USER_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë” ì•ˆì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">ê·¸ ì¤‘ í•˜ë‚˜ì˜ ë‚´ìš©ì„ ì½ì–´ì„œ í•µì‹¬ë§Œ 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">combo_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">combo_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] with Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">combo_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Test function-calling with OpenAI (4-way matrix).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which API type to run.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which model to use.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_USER_TASK</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">User task/prompt.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>

    <span class="c1"># ìƒ˜í”Œ í´ë” ì•ˆë‚´
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© ë°©ë²• ê°„ë‹¨ ì •ë¦¬</p>

<ol>
  <li>í™˜ê²½ ë³€ìˆ˜ ì„¸íŒ…(ê¶Œì¥)</li>
</ol>

<ul>
  <li>
    <p>Model A</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY=â€¦</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Model B</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY_B=â€¦</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL_B=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¤€ë¹„</li>
</ol>

<ul>
  <li>í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— samples í´ë”ë¥¼ ë§Œë“¤ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì„ 1ê°œ ì´ìƒ ë„£ëŠ”ë‹¤. ì˜ˆ: samples/readme.txt</li>
</ul>

<ol>
  <li>ì‹¤í–‰</li>
</ol>

<ul>
  <li>
    <p>ë„¤ ì¡°í•© ëª¨ë‘:<br />
python test_openai_tools.py</p>
  </li>
  <li>
    <p>íŠ¹ì • APIë§Œ:<br />
python test_openai_tools.py â€“api completions<br />
python test_openai_tools.py â€“api responses</p>
  </li>
  <li>
    <p>íŠ¹ì • ëª¨ë¸ë§Œ:<br />
python test_openai_tools.py â€“model A<br />
python test_openai_tools.py â€“model B</p>
  </li>
  <li>
    <p>í”„ë¡¬í”„íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ:<br />
python test_openai_tools.py â€“task "ì—¬ê¸°ì— ì›í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì§€ì‹œë¬¸"</p>
  </li>
</ul>

<p>êµ¬í˜„ í¬ì¸íŠ¸ ì„¤ëª…(í•„ìš” ì‹œ ì ê²€í•  ì²´í¬ë¦¬ìŠ¤íŠ¸)</p>

<ul>
  <li>
    <p>Chat Completions: response.choices[0].message.tool_callsë¥¼ í™•ì¸í•˜ê³ , ê° íˆ´ì„ ì‹¤í–‰í•œ ë’¤ tool ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•´ì„œ ì¬í˜¸ì¶œí•˜ëŠ” ì „í˜•ì  ë£¨í”„ë¥¼ ì‚¬ìš©í–ˆì–´. ì´ê²ƒì€ Function Calling ê°€ì´ë“œì˜ ê¶Œê³  íŒ¨í„´ì´ì•¼. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Responses API: responses.create(â€¦) â†’ outputì—ì„œ tool_call ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘ â†’ ì‹¤ì œ í•¨ìˆ˜ ì‹¤í–‰ â†’ tool_outputsì™€ ì´ì „ response_idë¥¼ í•¨ê»˜ ë„˜ê²¨ í›„ì† responses.create(â€¦) í˜¸ì¶œë¡œ ì´ì–´ ë¶™ì´ëŠ” íŒ¨í„´ì´ì•¼. ì´ íë¦„ì€ ê³µì‹ Responses API ë ˆí¼ëŸ°ìŠ¤ê°€ ì•ˆë‚´í•˜ëŠ” ë°©ì‹ê³¼ ë§ë¬¼ë ¤ ìˆì–´. <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>tools ìŠ¤í‚¤ë§ˆëŠ” ë‘ APIì—ì„œ ë™ì¼í•˜ê²Œ ì¬ì‚¬ìš©.</p>
  </li>
  <li>
    <p>ë¡œì»¬ íŒŒì¼ I/OëŠ” ì•ˆì „í•˜ê²Œ ì˜ˆì™¸ ì²˜ë¦¬í–ˆê³ , í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ê°€ì •(UTF-8)í–ˆì§€ë§Œ ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¬¸ìì—´ì„ ë°˜í™˜í•´ ëª¨ë¸ì´ ì ì ˆíˆ ì•ˆë‚´í•˜ë„ë¡ í–ˆì–´.</p>
  </li>
</ul>

<p>ë¬¸ì„œ ì°¸ê³  ë§í¬</p>

<ul>
  <li>
    <p>Function Calling ê°€ì´ë“œ(íˆ´ ì •ì˜/í˜¸ì¶œ íë¦„) <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Responses API ë ˆí¼ëŸ°ìŠ¤(ì‘ë‹µ êµ¬ì¡°, tool_outputs ì „ë‹¬ ë°©ì‹) <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI í”Œë«í¼</a></p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´</p>

<ul>
  <li>
    <p>ëª¨ë¸ëª…ë§Œ ë°”ê¿”ì„œ(ì˜ˆ: ìµœì‹  gpt-4.1 ê³„ì—´ ë“±) ì¦‰ì‹œ ì‹œí—˜ ê°€ëŠ¥</p>
  </li>
  <li>
    <p>tool_choiceë¥¼ "any"ë¡œ ë°”ê¾¸ë©´ ì—¬ëŸ¬ íˆ´ ë³‘ë ¬ í˜¸ì¶œ ê²½í–¥ì„ ë” ì‹œí—˜í•  ìˆ˜ ìˆì–´</p>
  </li>
  <li>
    <p>samples í´ë” ê²½ë¡œë‚˜ ì½ì„ íŒŒì¼ ì„ íƒ ë¡œì§ì„ ë” ì—„ê²©í•˜ê²Œ ì§€ì •í•˜ê³  ì‹¶ë‹¤ë©´, í”„ë¡¬í”„íŠ¸ë¥¼ ê³ ì •(seed task)í•˜ê±°ë‚˜ ì‹œìŠ¤í…œ ë©”ì‹œì§€ìª½ì— ê·œì¹™ì„ ë”í•´ë„ ì¢‹ì•„</p>
  </li>
</ul>

<p>ì›í•˜ëŠ” ë¶€ë¶„ ë” ë°”ê¿”ë“œë¦´ê²Œ.</p>

<p class="chat--user">

ì•„ë‹ˆ ë‚´ê°€ ì¡°ì‚¬í–ˆì„ ë•Œ responsesìš© íˆ´ jsonì´ ìˆê³ , completionìš©ì´ ë”°ë¡œ ìˆì–´ ì¡°ê¸ˆ ë‹¤ë¥´ê²Œ ìƒê²¼ë˜ë° ì°¾ì•„ì„œ ë°˜ì˜í•´ì¤˜

</p>

<p>ì¢‹ì€ ì§€ì ì´ì•¼. ì‹¤ì œë¡œ â€œë„êµ¬ ì •ì˜(tools JSON)â€ëŠ” ë‘ APIê°€ ê±°ì˜ ê°™ì§€ë§Œ, Responses APIëŠ” ì‹¤í–‰Â·ìƒíƒœ ì „íŒŒ ë°©ì‹(response_id, tool_outputs ë“±)ê³¼ ì¶œë ¥ êµ¬ì¡°ê°€ ë‹¤ë¥´ê³ , ê°€ì´ë“œì—ì„  Responses ì˜ˆì‹œì—ì„œ ì—„ê²© íŒŒì‹±(strict) ì˜µì…˜ì„ ê³ë“¤ì—¬ ì“°ëŠ” íŒ¨í„´ì´ ìì£¼ ë³´ì—¬ì„œ ëª¨ì–‘ì´ ì‚´ì§ ë‹¬ë¼ ë³´ì¼ ìˆ˜ ìˆì–´. ê·¸ë˜ì„œ ì•„ë˜ì²˜ëŸ¼ ì•„ì˜ˆ ë‘ ë²Œì˜ ìŠ¤í‚¤ë§ˆë¥¼ ë¶„ë¦¬í•´ ë‘ê³ , Responses ìª½ì—” ì—„ê²© íŒŒì‹±ì„ ë„£ëŠ” ì‹ìœ¼ë¡œ ë°˜ì˜í–ˆì–´. ë˜í•œ ResponsesëŠ” tool_outputsì™€ response_idë¥¼ í†µí•´ ë‹¨ê³„ì ìœ¼ë¡œ ì´ì–´ë¶™ì´ëŠ” ì ì„ ì½”ë“œì— ëª…í™•íˆ í–ˆì–´. ì°¸ê³  ë¬¸ì„œ: Function Calling ê°€ì´ë“œì™€ Responses API ë ˆí¼ëŸ°ìŠ¤. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI í”Œë«í¼+2</a></p>

<p>ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë„¤ ê°€ì§€ ì¡°í•©(ëª¨ë¸ A/B Ã— completions/responses) ëª¨ë‘ í•¨ìˆ˜ í˜¸ì¶œì„ ì‹œí—˜í•˜ê³ , ë‘ ì¢…ë¥˜ì˜ íŒŒì¼ íˆ´ì„ ì œê³µí•´. ë³€ê²½ í¬ì¸íŠ¸ëŠ” 1) CHAT_TOOLS vs RESPONSES_TOOLS ë¶„ë¦¬, 2) Responses ë£¨í”„ì—ì„œ tool_outputsÂ·response_id ì‚¬ìš©ì„ ë” ì—„ê²©íˆ, 3) Responses ì¶œë ¥ íŒŒì„œ ë³´ê°•ì´ì•¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools_split_tools.py
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ê³µí†µ ì‹¤ì œ êµ¬í˜„ í•¨ìˆ˜
</span><span class="kn">import</span> <span class="n">os</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># Chat Completions ì „ìš© ë„êµ¬ JSON
# - ì „í†µì ì¸ function calling ìŠ¤í‚¤ë§ˆ
</span><span class="n">CHAT_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses ì „ìš© ë„êµ¬ JSON
# - ìŠ¤í‚¤ë§ˆ í•„ë“œëŠ” ìœ ì‚¬í•˜ì§€ë§Œ, Responses ì˜ˆì œ ê´€ë¡€ì— ë§ì¶° strictë¥¼ ì¼¬
#   (ëª¨ë¸ì´ schemaì— ì •í™•íˆ ë§ì¶° ì¸ì ìƒì„±í•˜ë„ë¡ ê°•ì œ)
</span><span class="n">RESPONSES_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">CHAT_TOOLS</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># ê° íˆ´ ì‹¤í–‰
</span>        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>
        <span class="c1"># ëŒ€í™” ì´ì–´ë¶™ì´ê¸°
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># Responses ì¶œë ¥ íŒŒì„œ
</span><span class="k">def</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>

    <span class="n">final_text</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># ResponsesëŠ” tool_outputs + response_idë¡œ ìƒíƒœë¥¼ ì´ì–´ì„œ ë³´ë‚¸ë‹¤.
</span>    <span class="c1"># ì´ì–´ë¶™ì´ê¸° íŒ¨í„´ì€ ê³µì‹ ë ˆí¼ëŸ°ìŠ¤ì˜ íë¦„ê³¼ ë™ì¼. :contentReference[oaicite:1]{index=1}
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>  <span class="c1"># ì•ˆì „ ìƒí•œ
</span>        <span class="n">txt</span> <span class="o">=</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">txt</span><span class="p">:</span>
            <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">calls</span> <span class="o">=</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">})</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>          <span class="c1"># ì´ì „ ì‘ë‹µê³¼ ì—°ê²°
</span>            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>  <span class="c1"># íˆ´ ì‹¤í–‰ ê²°ê³¼ ì „ë‹¬
</span>        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ ìš”ì•½. í•„ìš”í•˜ë©´ íˆ´ ì‚¬ìš©.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">which_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">which_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">which_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></div>

<p>í•µì‹¬ ì°¨ì´ ì •ë¦¬ ë‹¨ê³„ë³„</p>

<ol>
  <li>
    <p>ë„êµ¬ ì •ì˜ ìì²´ëŠ” í•„ë“œ êµ¬ì¡°ê°€ ë™ì¼(type=function, function.name/description/parameters)í•˜ë˜, Responses ìª½ ì˜ˆì‹œì—ì„œëŠ” strictë¥¼ ì¼œì„œ JSON Schemaë¥¼ ì—„ê²©íˆ ì§€í‚¤ê²Œ í•˜ëŠ” íŒ¨í„´ì´ ë„ë¦¬ ì“°ì¸ë‹¤. ê·¸ë˜ì„œ ìŠ¤í‚¤ë§ˆê°€ â€œì¡°ê¸ˆ ë‹¤ë¥´ê²Œ ìƒê¸´ ê²ƒì²˜ëŸ¼â€ ë³´ì¼ ìˆ˜ ìˆë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>Chat CompletionsëŠ” messages ë°°ì—´ì— assistant.tool_callsê°€ ë‚˜ì˜¤ê³ , ê° call.idì— ëŒ€ì‘í•˜ëŠ” tool ë©”ì‹œì§€ë¥¼ ë„£ì–´ ë‹¤ì‹œ chat.completions.createë¥¼ í˜¸ì¶œí•œë‹¤.</p>
  </li>
  <li>
    <p>ResponsesëŠ” outputì— tool_call í•­ëª©ì´ ë‚˜ì˜¤ë©°, ì‹¤ì œ ë„êµ¬ ì‹¤í–‰ í›„ tool_outputs ë°°ì—´ê³¼ ì´ì „ ì‘ë‹µì˜ response_idë¥¼ í¬í•¨í•´ responses.createë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•´ ìƒíƒœë¥¼ ì´ì–´ ë¶™ì¸ë‹¤. ì´ê²Œ ê°€ì¥ í° ì°¨ì´ì ì´ë‹¤. <a href="https://platform.openai.com/docs/api-reference/responses-streaming/response?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ol>

<p>ì´ ë²„ì „ìœ¼ë¡œ ëŒë ¤ë³´ê³ , Responsesì—ì„œ strictë¥¼ ë„ê³  ì‹¶ìœ¼ë©´ RESPONSES_TOOLSì—ì„œ "strict": Trueë§Œ ë¹¼ë©´ ë¼. ëª¨ë¸Â·ì—”ë“œí¬ì¸íŠ¸Â·í‚¤ëŠ” ìƒë‹¨ MODELSì—ì„œ ì¡°ì • ê°€ëŠ¥í•˜ê³ , samples í´ë”ì— í…ŒìŠ¤íŠ¸ íŒŒì¼ë§Œ ìˆìœ¼ë©´ ë°”ë¡œ ë„¤ ì¡°í•©ì„ ëª¨ë‘ í™•ì¸í•  ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ì•„ë‹ˆ ì˜ˆì‹œë¥¼ ì¢€ ì°¾ì•„ë´.. from openai import OpenAI import json client = OpenAI() # 1. Define a list of callable tools for the model tools = [ { "type": "function", "name": "get_horoscope", "description": "Get today's horoscope for an astrological sign.", "parameters": { "type": "object", "properties": { "sign": { "type": "string", "description": "An astrological sign like Taurus or Aquarius", }, }, "required": ["sign"], }, }, ] def get_horoscope(sign): return f"{sign}: Next Tuesday you will befriend a baby otter." # Create a running input list we will add to over time input_list = [ {"role": "user", "content": "What is my horoscope? I am an Aquarius."} ] # 2. Prompt the model with tools defined response = client.responses.create( model="gpt-5", tools=tools, input=input_list, ) # Save function call outputs for subsequent requests input_list += response.output for item in response.output: if item.type == "function_call": if item.name == "get_horoscope": # 3. Execute the function logic for get_horoscope horoscope = get_horoscope(json.loads(item.arguments)) # 4. Provide function call results to the model input_list.append({ "type": "function_call_output", "call_id": item.call_id, "output": json.dumps({ "horoscope": horoscope }) }) print("Final input:") print(input_list) response = client.responses.create( model="gpt-5", instructions="Respond only with a horoscope generated by a tool.", tools=tools, input=input_list, ) # 5. The model should be able to give a response! print("Final output:") print(response.model_dump_json(indent=2)) print("\n" + response.output_text) ê·¸ëŸ¬ë©´ ì´ 8ê°œ ì¡°í•©ì´ ë‚˜ì˜¤ì§€? ëª¨ë¸ x API íƒ€ì…(completion, responses) x json í˜•íƒœ ì´ 8ê°œ ì¡°í•©ì— ëŒ€í•´ ê°ê° í…ŒìŠ¤íŠ¸í•˜ëŠ” ì½”ë“œë¥¼ ì§œì¤˜ ì´ ë•Œ ì‹¤í–‰ ì¤‘ ì—ëŸ¬ê°€ ë‚˜ëŠ” ê²½ìš°ì—ëŠ” ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ë‚˜ë¨¸ì§€ê°€ ì˜ ìˆ˜í–‰ë˜ê²Œ í•´ì¤˜.

</p>

<p>ì¢‹ì•„. â€œ2ê°œ ëª¨ë¸ Ã— 2ê°œ API(completions, responses) Ã— 2ê°€ì§€ tools JSON í˜•íƒœ(Completions ìŠ¤íƒ€ì¼ vs Responses ìŠ¤íƒ€ì¼)â€ = ì´ 8ê°œ ì¡°í•©ì„ í•œ ë²ˆì— ëŒë ¤ë³´ëŠ” í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤€ë¹„í–ˆì–´. ê° ì¡°í•©ì€ ê°œë³„ try/exceptë¡œ ê°ì‹¸ ì—ëŸ¬ê°€ ë‚˜ë”ë¼ë„ ë‚˜ë¨¸ì§€ê°€ ê³„ì† ìˆ˜í–‰ë¼. tools JSONì€ ë„¤ê°€ ì¤€ Responses ìŠ¤íƒ€ì¼ ì˜ˆì‹œ(í‰í‰í•œ í˜•íƒœ: type/name/parametersê°€ ìµœìƒìœ„)ì™€, Chat Completionsì—ì„œ í”íˆ ì“°ëŠ” ì¤‘ì²© í˜•íƒœ({"type":"function","function":{â€¦}})ë¥¼ ê°ê° ë¶„ë¦¬í•´ ë‘ì—ˆê³ , ì¼ë¶€ ì¡°í•©ì€ ì˜ë„ì ìœ¼ë¡œ â€œë§ì§€ ì•ŠëŠ” í˜•íƒœâ€ë¥¼ ë„£ì—ˆê¸° ë•Œë¬¸ì— ì‹¤íŒ¨í•  ìˆ˜ë„ ìˆì–´(ê·¸ ê²½ìš° ì—ëŸ¬ë§Œ ì¶œë ¥). ì°¸ê³ ë¡œ Responsesì™€ Chat Completionsì˜ ì°¨ì´, strict ì˜µì…˜ ë“±ì€ ìµœì‹  ê°€ì´ë“œì— ì •ë¦¬ë¼ ìˆì–´. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI í”Œë«í¼+2</a></p>

<p>ì•„ë˜ íŒŒì¼ì„ test_8combos_tools.pyë¡œ ì €ì¥í•´ì„œ ì‹¤í–‰í•˜ë©´ ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_8combos_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 0) ëª¨ë¸ ì„¤ì •
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# 1) ë¡œì»¬ íˆ´ êµ¬í˜„
# =========================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ëª¨ë“  íˆ´ì˜ ê²°ê³¼ë¥¼ dictë¡œ í†µì¼í•´ì„œ ë°˜í™˜.
    Responsesì˜ function_call_outputì— ë„£ê¸° ì¢‹ê²Œ {</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="s">: ...} í˜•íƒœë¡œ ê°ì‹¸ì¤€ë‹¤.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">path</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# 2) tools JSON ë‘ ê°€ì§€ í˜•íƒœ
# =========================
</span>
<span class="c1"># (A) Chat Completions ìŠ¤íƒ€ì¼: function í•„ë“œì— ì¤‘ì²©
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># (B) Responses ìŠ¤íƒ€ì¼: ë„¤ê°€ ì¤€ ì˜ˆì‹œì²˜ëŸ¼ í‰í‰í•œ í˜•íƒœ(ì¼ë¶€ ë¬¸ì„œ/ì˜ˆì‹œì—ì„œ ë³´ì´ëŠ” í¬ë§·)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # í•„ìš” ì‹œ ì¼œì„œ ì¸ì ìŠ¤í‚¤ë§ˆ ì¤€ìˆ˜ ê°•ì œ (ë„ì›€ë§ ì°¸ì¡°)
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# 3) Chat Completions ìª½ í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
# =========================
</span>
<span class="k">def</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">  -&gt; CHAT_STYLE_TOOLS ì‚¬ìš© (ê¶Œì¥)
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS ì‚¬ìš© (ì˜ë„ì  ë¹„í˜¸í™˜ ê°€ëŠ¥)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># tool_calls ë£¨í”„
</span>    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="c1"># argumentsëŠ” ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="p">})</span>

        <span class="c1"># ëŒ€í™” ì´ì–´ë¶™ì´ê¸°
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 4) Responses ìª½ í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
# =========================
</span>
<span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì˜ output ë°°ì—´ì—ì„œ function_call / tool_call ë¥˜ ì´ë²¤íŠ¸ë¥¼ ì¶”ì¶œ.
    ë‹¤ì–‘í•œ ì¼€ì´ìŠ¤ë¥¼ ìµœëŒ€í•œ ê´€ëŒ€í•˜ê²Œ ì²˜ë¦¬í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># ì¼€ì´ìŠ¤ A: item.type == "function_call"
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="p">})</span>

        <span class="c1"># ì¼€ì´ìŠ¤ B: ì¼ë¶€ ëª¨ë¸ì´ "tool_call" / item.message.tool_calls í˜•íƒœë¡œ ì¤„ ë•Œ
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS ì‚¬ìš© (ê¶Œì¥)
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">      -&gt; CHAT_STYLE_TOOLS ì‚¬ìš© (ì˜ë„ì  ë¹„í˜¸í™˜ ê°€ëŠ¥)
    ìˆœìˆ˜ Responses ë°©ì‹: ë„¤ê°€ ì¤€ ì˜ˆì‹œ íŒ¨í„´(input_list ì¶•ì  + function_call_output)ë¡œ êµ¬í˜„.
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="c1"># running input_list
</span>    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># function_call ì²˜ë¦¬
</span>    <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="c1"># callë“¤ì„ ì°¾ì•„ ì‹¤í–‰í•˜ê³ , function_call_outputì„ ì´ì–´ ë¶™ì„
</span>    <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="c1"># ìµœì¢… ì‘ë‹µ ì‹œë„(ì§€ì‹œë¬¸ì„ ì¶”ê°€ì ìœ¼ë¡œ ì¤„ ìˆ˜ë„ ìˆìŒ)
</span>    <span class="n">r2</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">Respond with a short summary of what you found.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># í…ìŠ¤íŠ¸ ì¶”ì¶œ(ì¤‘ê°„/ìµœì¢…)
</span>    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">txt1</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt1</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt1</span><span class="p">)</span>
    <span class="n">txt2</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt2</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt2</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 5) 8ê°œ ì¡°í•© ì‹¤í–‰ê¸°
# =========================
</span>
<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ ìš”ì•½. í•„ìš”í•˜ë©´ ë„êµ¬ë¥¼ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools_json=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 8 combinations: 2 models Ã— 2 APIs Ã— 2 tools JSON styles.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># tools_variantë¥¼ "both"ë¡œ ë‘ë©´ ê° APIì—ì„œ chat/â€‹responses ë‘ ê°€ì§€ íˆ´ JSON ëª¨ë‘ ì‹œë„ â†’ 8ì¡°í•©
</span>    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># ìƒ˜í”Œ í´ë” ìƒì„± ì•ˆë‚´
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>

    <span class="c1"># 8ì¡°í•©: 2ëª¨ë¸ Ã— 2API Ã— 2JSON
</span>    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">mk</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‹¤í–‰ ì˜ˆì‹œ<br />
python test_8combos_tools.py<br />
python test_8combos_tools.py â€“apis completions â€“tools both<br />
python test_8combos_tools.py â€“models A â€“apis responses â€“tools responses</p>

<p>í¬ì¸íŠ¸ ìš”ì•½</p>

<ol>
  <li>
    <p>CHAT_STYLE_TOOLSì™€ RESPONSES_STYLE_TOOLSë¥¼ ë¶„ë¦¬í•´ ë‘ì—ˆê³ , Responses ë£¨í”„ëŠ” ë„¤ê°€ ë¶™ì—¬ì¤€ ì˜ˆì‹œì²˜ëŸ¼ input_listì— function_callê³¼ function_call_outputì„ ëˆ„ì í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í–ˆì–´. ì¼ë¶€ ë¬¸ì„œ/ì˜ˆì‹œì—ì„  strictë¥¼ ì¼œ JSON ìŠ¤í‚¤ë§ˆë¥¼ ê°•ì œí•˜ë‹ˆ í•„ìš”í•˜ë©´ í•´ë‹¹ í‚¤ë¥¼ ì¼œë©´ ë¼. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>ì¼ë¶€ ì¡°í•©ì€ ì˜ë„ì ìœ¼ë¡œ í˜¸í™˜ë˜ì§€ ì•Šì•„ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆì–´(ì˜ˆ: Chat Completionsì— Responses ìŠ¤íƒ€ì¼ tools). ëª¨ë“  runì€ try/exceptë¡œ ê°ì‹¸ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ê°€ ì´ì–´ì§„ë‹¤.</p>
  </li>
  <li>
    <p>ìµœì‹  ì°¨ì´ì ê³¼ ê¶Œì¥ íë¦„ì€ Responses vs Chat Completions ê°€ì´ë“œì—ì„œ ë¹„êµ ê°€ëŠ¥í•´. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ol>

<p>ë” ì—„ê²©í•˜ê²Œ Responsesì˜ â€œresponse_id + tool_outputsâ€ ë°©ì‹ìœ¼ë¡œ ì´ì–´ë¶™ì´ëŠ” ë²„ì „ë„ ì›í•˜ë©´ ë”°ë¡œ ì¶”ê°€í•´ì¤„ê²Œ.</p>

<p class="chat--user">

ê°œì„  í•„ìš” ì‚¬í•­ 1. responses apiì—ì„œë„ ì—¬ëŸ¬ ë²ˆ ì½œì„ í•˜ê³  ê° ëŒ€í™”ë¥¼ ë‹¤ ì¶œë ¥í•˜ê³  ì‹¶ì–´. 2. ì…ë ¥ ì „ì²´ë¥¼ ê·¸ëƒ¥ jsonìœ¼ë¡œ ì¶œë ¥í•˜ê³ , ì¶œë ¥ ì „ì²´ë„ ê·¸ëƒ¥ jsonìœ¼ë¡œ ë‹¤ ì €ì¥í•´ì¤˜. ë‹¨, ì½˜ì†” ì¶œë ¥ ìƒ‰ê¹” ì§€ì •ì„ í†µí•´ì„œ (1) ì…ë ¥ (2) íˆ´ ìš”ì²­ (3) ì¶œë ¥ ì´ êµ¬ë¶„ë˜ë©´ ì¢‹ê² ì–´. 3. ì¶”ê°€ì ìœ¼ë¡œ json formatting (structured json)ë„ ì¶”ê°€í•´ì¤˜. structured jsonì´ ìˆëŠ” ë²„ì ¼ê³¼ ì—†ëŠ” ë²„ì ¼ ê°ê° ì¶”ê°€í•´ì£¼ë©´ ì¢‹ê² ì–´. ì´ 16ê°€ì§€ ì¡°í•©ì´ ë  ê±°ì•¼. ê° apiì— ëŒ€í•œ structured formatting ì˜ˆì‹œëŠ” ì•„ë˜ ì½”ë“œë¥¼ ì°¸ê³ í•´ chat completions 
<code class="language-plaintext highlighter-rouge">
from pydantic import BaseModel
from openai import OpenAI

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

completion = client.chat.completions.parse(
    model="gpt-4o-2024-08-06",
    messages=[
        {"role": "system", "content": "Extract the event information."},
        {"role": "user", "content": "Alice and Bob are going to a science fair on Friday."},
    ],
    response_format=CalendarEvent,
)

event = completion.choices[0].message.parsed
</code>

responses 
<code class="language-plaintext highlighter-rouge">
from openai import OpenAI
from pydantic import BaseModel

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

response = client.responses.parse(
    model="gpt-4o-2024-08-06",
    input=[
        {"role": "system", "content": "Extract the event information."},
        {
            "role": "user",
            "content": "Alice and Bob are going to a science fair on Friday.",
        },
    ],
    text_format=CalendarEvent,
)

event = response.output_parsed
</code>

</p>

<p>ì¢‹ì•„, ìš”êµ¬ì‚¬í•­(2ëª¨ë¸ Ã— 2 API íƒ€ì… Ã— 2 Tools JSON ìŠ¤íƒ€ì¼ Ã— 2 Structured í¬ë§· ìœ ë¬´ = 16ì¡°í•©)ì„ ëª¨ë‘ ë§Œì¡±í•˜ëŠ” ë‹¨ì¼ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤€ë¹„í–ˆì–´. ë‹¤ìŒì„ ë³´ì¥í•´.</p>

<ol>
  <li>
    <p>Responses APIì—ì„œ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œ(íˆ´ í˜¸ì¶œ ë°œìƒ ì‹œ ë£¨í”„)í•˜ë©°, ë§¤ ìŠ¤í…ì˜ ëŒ€í™” ì „ê°œë¥¼ ì½˜ì†”ì— ëª¨ë‘ ì¶œë ¥.</p>
  </li>
  <li>
    <p>ê° ì¡°í•©ë§ˆë‹¤ â€œì…ë ¥ ì „ì²´â€ì™€ â€œì¶œë ¥ ì „ì²´â€ë¥¼ JSONìœ¼ë¡œ íŒŒì¼ë¡œ ì €ì¥. ì½˜ì†”ì—ì„  ìƒ‰ìƒìœ¼ë¡œ (ì…ë ¥ / íˆ´ìš”ì²­ / ì¶œë ¥) êµ¬ë¶„.</p>
  </li>
  <li>
    <p>Structured JSON íŒŒì‹± ë²„ì „ê³¼ ì¼ë°˜ ë²„ì „ ê°ê° ì œê³µ.</p>
  </li>
  <li>
    <p>ì—ëŸ¬ëŠ” ì¡°í•©ë³„ë¡œ try/exceptë¡œ ê³ ë¦½ ì²˜ë¦¬í•˜ì—¬, ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ì¡°í•© ê³„ì† ì‹¤í–‰.</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œë¥¼ test_16combos.pyë¡œ ì €ì¥í•´ì„œ ì‹¤í–‰í•´. samples í´ë”ì— í…ìŠ¤íŠ¸ íŒŒì¼ ëª‡ ê°œ ë‘ë©´ íˆ´ ë™ì‘ì„ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆì–´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# ANSI ìƒ‰ìƒ ìœ í‹¸
# =========================
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># ì…ë ¥
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># íˆ´ ìš”ì²­/íˆ´ ì¶œë ¥
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># ëª¨ë¸ ì¶œë ¥
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># ì—ëŸ¬
</span>
<span class="c1"># =========================
# ëª¨ë¸/ì—”ë“œí¬ì¸íŠ¸/í‚¤ ì„¤ì •
# =========================
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# ë¡œì»¬ íˆ´ êµ¬í˜„
# =========================
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# Tools JSON 2ê°€ì§€ ìŠ¤íƒ€ì¼
# =========================
# Chat Completions ìŠ¤íƒ€ì¼ (function í•„ë“œ ì¤‘ì²©)
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses ìŠ¤íƒ€ì¼ (í‰í‰í•œ í˜•íƒœ; ì¼ë¶€ ì˜ˆì‹œ í¬ë§·)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # í•„ìš” ì‹œ í™œì„±í™”
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# Structured JSON í¬ë§·ìš© Pydantic
# =========================
</span><span class="k">class</span> <span class="nc">FileTaskResult</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chosen_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># =========================
# ê³µí†µ: ì¶œë ¥/ì €ì¥ í—¬í¼
# =========================
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Chat Completions ëŸ¬ë„ˆ (plain/structured)
# =========================
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="c1"># ëŒ€í™” ì‹œì‘
</span>    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># ì…ë ¥/ì¶œë ¥ ì „ì²´ ì €ì¥ì„ ìœ„í•œ êµ¬ì¡°
</span>    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: parse() ì‚¬ìš©
</span>        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># function calling ë£¨í”„ (parse ê²°ê³¼ì—ì„œë„ tool_calls ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì‹œë„)
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># ìµœì¢… êµ¬ì¡°í™” ê²°ê³¼
</span>        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FileTaskResult</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_to_print</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">:</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat Completions, structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_to_print</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: create() ì‚¬ìš©
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat Completions, plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># íŒŒì¼ ì €ì¥
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# Responses ëŸ¬ë„ˆ (plain/structured)
# - ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•˜ë©° ë§¤ ìŠ¤í… ì¶œë ¥
# =========================
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>

        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: responses.parse(text_format=...)
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># íˆ´ í˜¸ì¶œ íƒì§€ â†’ ì‹¤í–‰ â†’ function_call_output ì¶”ê°€ â†’ ì´ì–´ì„œ ë˜ parse
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># ìµœì¢… íŒŒì‹± ê²°ê³¼
</span>        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: responses.create()
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="c1"># function_call_outputì„ inputì— ëˆ„ì 
</span>                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># ë‹¤ìŒ í„´
</span>            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="c1"># íŒŒì¼ ì €ì¥
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# 16ê°œ ì¡°í•© ì‹¤í–‰ê¸°
#   2 ëª¨ë¸ Ã— 2 API Ã— 2 Tools JSON Ã— 2 Structured
# =========================
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span>
    <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">combo_label</span> <span class="o">=</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">combo_label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="c1"># ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ê³„ì†
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos: 2 models Ã— 2 APIs Ã— 2 Tools JSON Ã— 2 Structured.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš©ë²• ìš”ì•½</p>

<ol>
  <li>í™˜ê²½ ë³€ìˆ˜ ì„¤ì •(ì˜ˆì‹œ)</li>
</ol>

<ul>
  <li>
    <p>ëª¨ë¸ A:<br />
OPENAI_API_KEY_A, OPENAI_BASE_URL_A=https://api.openai.com/v1, MODEL_A_NAME</p>
  </li>
  <li>
    <p>ëª¨ë¸ B:<br />
OPENAI_API_KEY_B, OPENAI_BASE_URL_B=https://api.openai.com/v1, MODEL_B_NAME</p>
  </li>
</ul>

<ol>
  <li>
    <p>ìƒ˜í”Œ ì¤€ë¹„<br />
í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— samples í´ë”ë¥¼ ë§Œë“¤ê³  í…ìŠ¤íŠ¸ íŒŒì¼ì„ 1ê°œ ì´ìƒ ë„£ì–´ë‘”ë‹¤.</p>
  </li>
  <li>
    <p>ì‹¤í–‰ ì˜ˆì‹œ</p>
  </li>
</ol>

<ul>
  <li>
    <p>16ê°œ ì „ì²´ ì¡°í•© ì‹¤í–‰<br />
python test_16combos.py</p>
  </li>
  <li>
    <p>Responsesë§Œ, structured/plain ë‘˜ ë‹¤, toolsëŠ” responses ìŠ¤íƒ€ì¼ë§Œ<br />
python test_16combos.py â€“apis responses â€“tools responses â€“structured both</p>
  </li>
  <li>
    <p>ëª¨ë¸ Aë§Œ, Chat Completionsë§Œ, structuredë§Œ<br />
python test_16combos.py â€“models A â€“apis completions â€“structured on</p>
  </li>
</ul>

<p>ë™ì‘ ì •ë¦¬</p>

<ul>
  <li>
    <p>ì½˜ì†” ìƒ‰ìƒìœ¼ë¡œ ì…ë ¥(ì²­ë¡), íˆ´ ìš”ì²­(ë…¸ë‘), ì¶œë ¥(ì´ˆë¡)ì„ êµ¬ë¶„.</p>
  </li>
  <li>
    <p>ê° ì¡°í•©ì€ runs/íƒ€ì„ìŠ¤íƒ¬í”„/ëª¨ë¸_API_tools_structured/ ì•„ë˜ì— input.json, outputs.json ì €ì¥.</p>
  </li>
  <li>
    <p>Responses APIëŠ” íˆ´ í˜¸ì¶œì´ ê³„ì† ë‚˜ì˜¤ë©´ ë£¨í”„ë¥¼ ë°˜ë³µí•˜ê³  ë§¤ ìŠ¤í… ì¶œë ¥ ë° ëˆ„ì  ì €ì¥.</p>
  </li>
  <li>
    <p>Structured ëª¨ë“œì—ì„  chat.completions.parse / responses.parseë¥¼ ì‚¬ìš©í•´ Pydantic ëª¨ë¸(FileTaskResult)ë¡œ ê²°ê³¼ë¥¼ íŒŒì‹±í•´ ë³„ë„ ìš”ì•½ë„ ì½˜ì†”ì— í‘œì‹œ.</p>
  </li>
</ul>

<p>ì›í•˜ëŠ” ì¶”ê°€ í¬ë§·(ì˜ˆ: íŒŒì¼ëª… ê·œì¹™, ë” ìì„¸í•œ ë¡œê¹…, strict ì˜µì…˜ ìƒì‹œ on ë“±)ì´ ìˆìœ¼ë©´ ì•Œë ¤ì¤˜.</p>

<p class="chat--user">

ì¶œë ¥ json í¬ë§·ì€ taskì—ì„œ ìš”ì²­í•œ ê±¸ ëŒ€ë‹µí•  ìˆ˜ ìˆê²Œ í•´ì£¼ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„. ì˜ˆë¥¼ ë“¤ì–´ filename: íŒŒì¼ëª… contents: ë‚´ìš© 

</p>

<p>ì¢‹ì•„! â€œê²°ê³¼ JSON í¬ë§·ì„ taskì— ë°”ë¡œ ì“°ì´ê²Œ(filename, contents)â€ë¡œ ë§ì¶˜ ë²„ì „ì„ ì•„ë˜ì²˜ëŸ¼ ì—…ë°ì´íŠ¸í–ˆì–´. í•µì‹¬ì€ structured ëª¨ë“œì—ì„œ íŒŒì‹± ëª¨ë¸ì„ <code class="language-plaintext highlighter-rouge">{"filename": str, "contents": str}</code>ë¡œ ê³ ì •í•˜ê³ , ëª¨ë¸ì—ê²Œ â€œcontentsì—ëŠ” ìš”ì•½ì„ ë„£ì–´ë¼â€ë¼ê³  ì§€ì‹œí•˜ëŠ” ê²ƒ. plain ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ ê·¸ëŒ€ë¡œ ììœ  í…ìŠ¤íŠ¸ë¥¼ ì¶œë ¥í•˜ê³  ì „ì²´ ì›ì‹œ JSON ë¡œê·¸ë§Œ ì €ì¥í•˜ë©°, structured ëª¨ë“œì—ì„œëŠ” ì¶”ê°€ë¡œ <code class="language-plaintext highlighter-rouge">result.json</code>ì— <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>ë¥¼ ì €ì¥í•´.</p>

<p>ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ì „ 16ì¡°í•© ì‹¤í–‰ê¸°(test_16combos.py)ë¥¼ ëŒ€ì²´í•˜ëŠ” ì™„ì „íŒì´ì•¼. ë°”ë€ ì ë§Œ ë¹ ë¥´ê²Œ ìš”ì•½í•˜ê³  ë°”ë¡œ ì½”ë“œ ì¤„ê²Œ.</p>

<p>ë³€ê²½ ìš”ì•½</p>

<ol>
  <li>Structured íŒŒì‹± ëª¨ë¸ êµì²´</li>
</ol>

<ul>
  <li>
    <p>Pydantic ëª¨ë¸ì„ <code class="language-plaintext highlighter-rouge">TaskAnswer</code>ë¡œ ì •ì˜í•˜ê³  í•„ë“œë¥¼ filename, contents ë‘ ê°œë¡œ í†µì¼.</p>
  </li>
  <li>
    <p>contentsëŠ” â€œì½ì€ íŒŒì¼ì˜ 2~3ë¬¸ì¥ ìš”ì•½â€ì„ ë„£ë„ë¡ system/instructionsì— ëª…í™•íˆ ì§€ì‹œ.</p>
  </li>
</ul>

<ol>
  <li>Structured ëª¨ë“œì—ì„œ ê²°ê³¼ JSON ì €ì¥</li>
</ol>

<ul>
  <li>
    <p>ê° ì¡°í•© í´ë”ì— <code class="language-plaintext highlighter-rouge">result.json</code>ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code> ì €ì¥.</p>
  </li>
  <li>
    <p>ê¸°ì¡´ì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>ë„ ê³„ì† ì €ì¥.</p>
  </li>
</ul>

<ol>
  <li>ì½˜ì†” ìƒ‰ìƒ ì¶œë ¥ì€ ë™ì¼í•˜ê²Œ ìœ ì§€</li>
</ol>

<ul>
  <li>ì…ë ¥(CYAN), íˆ´ ìš”ì²­(YELLOW), ì¶œë ¥(GREEN)ìœ¼ë¡œ êµ¬ë¶„.</li>
</ul>

<ol>
  <li>Responses APIëŠ” ë‹¤ë‹¨ í˜¸ì¶œ ìœ ì§€</li>
</ol>

<ul>
  <li>ê° stepì˜ ì¶œë ¥ê³¼ íˆ´ ìš”ì²­ì„ ëª¨ë‘ ì½˜ì†”ì— í‘œì‹œí•˜ê³ , outputs.jsonì— ëˆ„ì  ì €ì¥.</li>
</ul>

<p>ì½”ë“œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos_v2.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI ìƒ‰ìƒ =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># ì…ë ¥
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># íˆ´ ìš”ì²­/íˆ´ ì¶œë ¥
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># ëª¨ë¸ ì¶œë ¥
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># ì—ëŸ¬
</span>
<span class="c1"># ===== ëª¨ë¸ ì„¤ì • =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== ë¡œì»¬ íˆ´ êµ¬í˜„ =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON 2ê°€ì§€ =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON ìŠ¤í‚¤ë§ˆ =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># ì„ íƒëœ íŒŒì¼ì˜ 2~3ë¬¸ì¥ ìš”ì•½(ëª¨ë¸ì´ ìƒì„±)
</span>
<span class="c1"># ===== ìœ í‹¸ =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># ===== Chat Completions ëŸ¬ë„ˆ =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If using structured output, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskAnswer</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses ëŸ¬ë„ˆ =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If structured parsing is enabled, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== 16ê°œ ì¡°í•© ì‹¤í–‰ê¸° =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>  <span class="c1"># ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ê³„ì†
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos with JSON result format {filename, contents}.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© í¬ì¸íŠ¸</p>

<ul>
  <li>
    <p>structured ëª¨ë“œì¼ ë•Œë§Œ <code class="language-plaintext highlighter-rouge">result.json</code>ì„ ìƒì„±í•˜ë©° ë‚´ìš©ì€ ë°˜ë“œì‹œ <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>ë¡œ ì €ì¥ë¼.</p>
  </li>
  <li>
    <p>contentsì—ëŠ” â€œì„ íƒí•œ íŒŒì¼ì˜ 2~3ë¬¸ì¥ ìš”ì•½â€ì´ ë“¤ì–´ê°€ë„ë¡ ì‹œìŠ¤í…œ ë©”ì‹œì§€ì—ì„œ ê°•ì œí–ˆì–´.</p>
  </li>
  <li>
    <p>plain ëª¨ë“œì—ì„  ììœ  í˜•ì‹ ì¶œë ¥ì´ì§€ë§Œ, ì…ë ¥ê³¼ ëª¨ë“  ì›ì‹œ ì‘ë‹µì€ <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>ë¡œ ì €ì¥ë¼.</p>
  </li>
  <li>
    <p>ê° ë‹¨ê³„ì˜ ì½˜ì†” ì¶œë ¥ì€ ìƒ‰ìƒìœ¼ë¡œ êµ¬ë¶„ë¼ì„œ ì…ë ¥/íˆ´ìš”ì²­/ì¶œë ¥ì´ í•œëˆˆì— ë³´ì—¬.</p>
  </li>
</ul>

<p>ì›í•˜ë©´ contentsë¥¼ â€œíŒŒì¼ ì „ë¬¸â€ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì˜µì…˜ ìŠ¤ìœ„ì¹˜ë„ ì¶”ê°€í•´ì¤„ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

Completions(structured)ì—ì„œ ValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.

</p>

<p>ì¢‹ì€ í”¼ë“œë°±ì´ì•¼. ì—ëŸ¬ ì›ì¸ì€ chat.completions.parseë¥¼ ì‚¬ìš©í•  ë•Œ íˆ´ì´ strict ëª¨ë“œê°€ ì•„ë‹ˆë©´ ìë™ íŒŒì‹±ì´ ë¶ˆê°€ëŠ¥í•´ì„œì•¼. ì¦‰, structured ëª¨ë“œì—ì„œ í•¨ìˆ˜ íˆ´ ì •ì˜ì— strict=Trueê°€ ë°˜ë“œì‹œ ë“¤ì–´ê°€ì•¼ í•´.</p>

<p>ìˆ˜ì • ë°©í–¥ ìš”ì•½ ë‹¨ê³„ë³„</p>

<ol>
  <li>
    <p>tools_variantì™€ structured ì—¬ë¶€ì— ë”°ë¼ íˆ´ JSONì— strictë¥¼ ì£¼ì…í•˜ëŠ” í—¬í¼ë¥¼ ë§Œë“ ë‹¤.</p>
  </li>
  <li>
    <p>Chat ìŠ¤íƒ€ì¼ì¼ ë• tool["function"]["strict"]=True, Responses ìŠ¤íƒ€ì¼ì¼ ë• tool["strict"]=Trueë¥¼ ë„£ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>run_chat / run_responsesì—ì„œ ê¸°ì¡´ ì •ì  TOOLS ëŒ€ì‹  ì´ í—¬í¼ë¡œ ë°˜í™˜ëœ íˆ´ì„ ì‚¬ìš©í•œë‹¤.</p>
  </li>
</ol>

<p>ì•„ë˜ ë³€ê²½ë§Œ ì ìš©í•˜ë©´ ë¼. ë‚˜ë¨¸ì§€ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ë‘¬ë„ ë™ì‘í•œë‹¤.</p>

<p>ì¶”ê°€ í•¨ìˆ˜ ë° ë³€ê²½ì </p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">copy</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">'</span><span class="s">chat</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'</span><span class="s">
    structuredê°€ Trueë©´ strict í”Œë˜ê·¸ë¥¼ ì£¼ì…í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># Chat ìŠ¤íƒ€ì¼: "function" ë¸”ë¡ ì•ˆì— strict
</span>        <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Responses ìŠ¤íƒ€ì¼: ìµœìƒìœ„ì— strict
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></div>

<p>run_chat ë‚´ë¶€ì—ì„œ íˆ´ ì„ íƒ ë¶€ë¶„ êµì²´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´
# tools = CHAT_STYLE_TOOLS if tools_variant == "chat" else RESPONSES_STYLE_TOOLS
# ë³€ê²½
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>run_responses ë‚´ë¶€ì—ì„œë„ ë™ì¼í•˜ê²Œ êµì²´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´
# tools = RESPONSES_STYLE_TOOLS if tools_variant == "responses" else CHAT_STYLE_TOOLS
# ë³€ê²½
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>ì¶”ê°€ ì°¸ê³ </p>

<ul>
  <li>
    <p>ì´ ë³€ê²½ìœ¼ë¡œ Completions(structured) ë¿ë§Œ ì•„ë‹ˆë¼ Responses(structured)ì—ì„œë„ ì¼ê´€ë˜ê²Œ ì—„ê²© íŒŒì‹±ì´ ë³´ì¥ë¼.</p>
  </li>
  <li>
    <p>plain ëª¨ë“œì—ì„  strictê°€ ì—†ì–´ë„ ë˜ì§€ë§Œ, ìœ„ í—¬í¼ëŠ” structuredì¼ ë•Œë§Œ strictë¥¼ ì£¼ì…í•˜ë¯€ë¡œ ê¸°ì¡´ ë™ì‘ì„ í•´ì¹˜ì§€ ì•Šì•„.</p>
  </li>
  <li>
    <p>tools JSONì„ ë™ì ìœ¼ë¡œ ì£¼ì…í•˜ë¯€ë¡œ, ìƒˆ í•¨ìˆ˜ë§Œ ì¶”ê°€í•˜ê³  ë‘ ê³³ í˜¸ì¶œë¶€ë§Œ ë°”ê¾¸ë©´ ëë‚˜.</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œ ìˆ˜ì •í•˜ë©´ â€œValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.â€ ì—ëŸ¬ëŠ” ì‚¬ë¼ì§€ê³  16ê°œ ì¡°í•© ëª¨ë‘ ì •ìƒì ìœ¼ë¡œ ìˆœíšŒí•  ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ê·¸ë˜ë„ ê³„ì† ì—ëŸ¬ê°€ ë‚˜ë„¤. ì¼ë‹¨ ë„˜ì–´ê°€ê³  json schemeì„ ì§€ì •í•˜ëŠ” ë°©ì‹ì€ ë™ì‘ì„ ì˜ ì•ˆí•˜ë„¤ ì¼ë°˜ json ëª¨ë“œë¥¼ ì¼œë³´ê³  ì‹¶ì–´. ì´ 3ê°€ì§€ sweep(no structured, json_mode, structured)ë¡œ ì‹¤í—˜í•´ë³´ì. ì˜ˆì‹œ responses 
<code class="language-plaintext highlighter-rouge">
we_did_not_specify_stop_tokens = True

try:
    response = client.responses.create(
        model="gpt-3.5-turbo-0125",
        input=[
            {"role": "system", "content": "You are a helpful assistant designed to output JSON."},
            {"role": "user", "content": "Who won the world series in 2020? Please respond in the format {winner: ...}"}
        ],
        text={"format": {"type": "json_object"}}
    )

    # Check if the conversation was too long for the context window, resulting in incomplete JSON 
    if response.status == "incomplete" and response.incomplete_details.reason == "max_output_tokens":
        # your code should handle this error case
        pass

    # Check if the OpenAI safety system refused the request and generated a refusal instead
    if response.output[0].content[0].type == "refusal":
        # your code should handle this error case
        # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing
        print(response.output[0].content[0]["refusal"])

    # Check if the model's output included restricted content, so the generation of JSON was halted and may be partial
    if response.status == "incomplete" and response.incomplete_details.reason == "content_filter":
        # your code should handle this error case
        pass

    if response.status == "completed":
        # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a "stop token"

        if we_did_not_specify_stop_tokens:
            # If you didn't specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object
            # This will parse successfully and should now contain  "{"winner": "Los Angeles Dodgers"}"
            print(response.output_text)
        else:
            # Check if the response.output_text ends with one of your stop tokens and handle appropriately
            pass
except Exception as e:
    # Your code should handle errors here, for example a network error calling the API
    print(e)
</code>

completions 
<code class="language-plaintext highlighter-rouge">
response = client.chat.completions.create(
  model="gpt-4-1106-preview",
  messages=[
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "LangChainì€ ë¬´ì—‡ì„ í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì§€? JSONìœ¼ë¡œ ë‹µí•´ì¤˜. JSON í‚¤ì›Œë“œëŠ” Description, Features, Usageë¡œ í•´ì¤˜."}
  ],
  response_format = {'type':"json_object"}
)
</code>

</p>

<p>ì¢‹ì•„. strict ê¸°ë°˜ì˜ JSON Schema íŒŒì‹±ì€ ì ‘ê³ , ì„¸ ëª¨ë“œë¡œ ìŠ¤ìœ•í•˜ë„ë¡ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í–ˆì–´.</p>

<p>ìŠ¤ìœ• ì¶•: 2ëª¨ë¸ Ã— 2 API(completions/responses) Ã— 2 Tools JSON(chat-style/responses-style) Ã— 3 ëª¨ë“œ(plain, json_mode, structured) = ì´ 24ì¡°í•©.</p>

<p>í•µì‹¬</p>

<ul>
  <li>
    <p>plain: ììœ  ì¶œë ¥. ì „ì²´ ì…ë ¥/ì¶œë ¥ ì›ë³¸ JSONì„ ì €ì¥.</p>
  </li>
  <li>
    <p>json_mode: ëª¨ë¸ì—ê²Œ â€œë¬´ì¡°ê±´ JSONâ€ì„ ìš”êµ¬. ì¶œë ¥ì€ {"filename","contents"} í˜•ì‹. ì €ì¥ ì‹œ result.json ìƒì„±.</p>

    <ul>
      <li>
        <p>Chat Completions: response_format={'type': 'json_object'}</p>
      </li>
      <li>
        <p>Responses: text={"format":{"type":"json_object"}}</p>
      </li>
    </ul>
  </li>
  <li>
    <p>structured: ì´ì „ì²˜ëŸ¼ parse ì‚¬ìš©. ì—¬ì „íˆ ëª¨ë¸/SDKì— ë”°ë¼ strict ìš”êµ¬ë¡œ ì‹¤íŒ¨í•  ìˆ˜ë„ ìˆìœ¼ë‹ˆ try/exceptë¡œ ê²©ë¦¬. ì„±ê³µ ì‹œ result.json ìƒì„±.</p>
  </li>
  <li>
    <p>Responses APIëŠ” íˆ´ í˜¸ì¶œì´ ë‚˜ì˜¤ë©´ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œë˜ë©° ë§¤ ìŠ¤í… ì½˜ì†” ì¶œë ¥. ì½˜ì†”ì€ ìƒ‰ìƒìœ¼ë¡œ ì…ë ¥(CYAN), íˆ´ ìš”ì²­(YELLOW), ì¶œë ¥(GREEN) êµ¬ë¶„.</p>
  </li>
  <li>
    <p>ëª¨ë“  ì¡°í•©ì€ runs/íƒ€ì„ìŠ¤íƒ¬í”„/ëª¨ë¸_API_tools_mode/ í´ë”ì— input.json, outputs.json ì €ì¥. json_mode/structuredëŠ” result.json ì¶”ê°€ ì €ì¥.</p>
  </li>
  <li>
    <p>ì—ëŸ¬ëŠ” ì¡°í•©ë³„ë¡œë§Œ ì¶œë ¥í•˜ê³  ë‚˜ë¨¸ì§€ ê³„ì† ì§„í–‰.</p>
  </li>
</ul>

<p>ì½”ë“œ: test_24combos.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_24combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI colors =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># input
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># tool
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># output
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># error
</span>
<span class="c1"># ===== Model configs =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== Local tools =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON (two shapes) =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON schema (optional) =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># ===== Helpers =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="c1"># structuredì—ì„œ strict ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ ì—¬ê¸°ì„  strict ì£¼ì…ì„ ë”
</span>    <span class="c1"># (structuredëŠ” parse() ì‚¬ìš© ì‹œ ì—¬ì „íˆ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ try/exceptë¡œ ê°ì‹¼ë‹¤)
</span>    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="k">return</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

<span class="c1"># ===== Common parsing for Responses =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># ===== Chat Completions runner =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">When asked to answer in JSON, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                    <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                    <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

                <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Chat structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Force JSON output
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># Try to parse JSON
</span>        <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses runner =====
</span><span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If JSON is requested, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                    <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                    <span class="p">})</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Responses structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># Try to parse JSON text
</span>        <span class="n">result_text</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">result_text</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== 24-combo driver =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">ê°€ëŠ¥í•˜ë‹¤ë©´ JSONìœ¼ë¡œ {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string} í˜•íƒœë¡œ ë‹µí•´ì¤˜.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 24 combos: 2 models Ã— 2 APIs Ã— 2 tool JSONs Ã— 3 modes.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--modes</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">mode_list</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">modes</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">modes</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">mode_list</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© íŒ</p>

<ul>
  <li>
    <p>json_modeê°€ ê°€ì¥ ì•ˆì •ì ìœ¼ë¡œ {"filename","contents"}ë¥¼ ë±‰ì–´ ì¤„ ê±°ì•¼. structuredëŠ” SDK/ëª¨ë¸ì˜ strict ì •ì±…ì— ë”°ë¼ ì—¬ì „íˆ ì‹¤íŒ¨í•  ìˆ˜ ìˆì§€ë§Œ, ìŠ¤í¬ë¦½íŠ¸ëŠ” ê°œë³„ ì¡°í•©ë³„ë¡œ ì—ëŸ¬ë¥¼ ì‚¼í‚¤ê³  ê³„ì† ì§„í–‰í•œë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë“  ì¡°í•©ì˜ ì…ë ¥/ì¶œë ¥(raw)ì„ ì €ì¥í•´ì„œ ë¦¬ê·¸ë ˆì…˜ ë¹„êµê°€ ê°€ëŠ¥í•´. json_mode/structuredëŠ” result.jsonì„ ë”°ë¡œ ì €ì¥í•˜ë¯€ë¡œ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´.</p>
  </li>
  <li>
    <p>í•„ìš”í•˜ë©´ system ë©”ì‹œì§€ì˜ ì§€ì‹œë¥¼ ìˆ˜ì •í•´ì„œ contentsì— â€œìš”ì•½â€ ëŒ€ì‹  â€œì›ë¬¸ ì „ì²´â€ë¥¼ ë„£ë„ë¡ ë°”ê¿€ ìˆ˜ë„ ìˆì–´.</p>
  </li>
</ul>

<p class="chat--user">

ë‘˜ ë‹¤ json ê´€ë ¨ í¬ë§¤íŒ…ì€ ì˜ ì•ˆë¨¹íˆë„¤ ì¼ë‹¨ ì¼ë°˜ í…ìŠ¤íŠ¸ ì¶œë ¥ë§Œ ìƒê°í•˜ì. ì´ì œ ì†Œí”„íŠ¸ì›¨ì–´ ì•„í‚¤í…íŠ¸ ë””ìì¸ ì¸¡ë©´ì—ì„œ í•œ ë²ˆ ë³´ì. ì¡°í•© 1. GPT OSS + responses í˜•ì‹ call + ì‹ ê·œ tool json í˜•ì‹ ì¡°í•© 2. Qwen + completions í˜•ì‹ call + ê³¼ê±° tool json í˜•ì‹ ì´ê±°ì•¼. ê·¸ëŸ°ë° ë‚˜ëŠ” ì‚¬ìš©ìê°€ ì¼ì¢…ì˜ ì½¤ë³´ ë°•ìŠ¤ë¡œ GPT OSSë¥¼ ì“¸ ê²ƒì¸ì§€, Qwenì„ ì“¸ ê²ƒì¸ì§€ ì„ íƒí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ê·¸ ë•Œ ê·¸ ë•Œ ì˜ ë™ì‘í•˜ê²Œ í•˜ê³  ì‹¶ì–´. ë­”ê°€ ë””ìì¸ íŒ¨í„´ì ì¸ ê²ƒì„ ì¨ì„œ ê¹”ë”í•˜ê²Œ ì´ë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì´ ìˆì„ê¹Œ? function call toolë„ ì–´ë–¤ ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ë©´ ì¢‹ì„ê¹Œ íŒŒì´ì¬ ê³ ìˆ˜ì˜ ì…ì¥ì—ì„œ ì´ëŸ° ì ì„ ê³ ë ¤í•´ì„œ ê¹”ë”í•œ ì½”ë“œ ë§Œë“¤ì–´ì¤˜.

</p>

<p>ì¢‹ì•„. ìš”êµ¬ ì¡°í•©ê³¼ ì‚¬ìš©ì„±(ì½¤ë³´ë°•ìŠ¤ë¡œ ì—”ì§„ ì„ íƒ)ê¹Œì§€ ê³ ë ¤í•´ì„œ â€œì „ëµ(Strategy) + íˆ´ ìŠ¤í‚¤ë§ˆ ë¹Œë”(Factory) + ë ˆì§€ìŠ¤íŠ¸ë¦¬ + ì–´ëŒ‘í„°â€ ì¡°í•©ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì„¤ê³„í•œ íŒŒì´ì¬ ì˜ˆì‹œë¥¼ ì¤„ê²Œ.</p>

<p>í•µì‹¬ ì•„ì´ë””ì–´ ìš”ì•½(ê°„ê²°):</p>

<ol>
  <li>Strategy íŒ¨í„´: ì„œë¡œ ë‹¤ë¥¸ í˜¸ì¶œ ë°©ì‹ ì°¨ì´ë¥¼ ìº¡ìŠí™”</li>
</ol>

<ul>
  <li>
    <p>ResponsesStrategy(GPT OSS, responses í˜¸ì¶œ, â€œì‹ ê·œ/í‰í‰í•œâ€ tool JSON)</p>
  </li>
  <li>
    <p>CompletionsStrategy(Qwen, chat.completions í˜¸ì¶œ, â€œê³¼ê±°/ì¤‘ì²©â€ tool JSON)</p>
  </li>
</ul>

<ol>
  <li>ToolRegistry + ToolSchemaBuilder(Factory):</li>
</ol>

<ul>
  <li>
    <p>ToolRegistryëŠ” íŒŒì´ì¬ í•¨ìˆ˜ë¥¼ ë“±ë¡/ì‹¤í–‰</p>
  </li>
  <li>
    <p>ToolSchemaBuilderê°€ ë“±ë¡ëœ íˆ´ì„ ê° ì—”ì§„ì´ ìš”êµ¬í•˜ëŠ” JSON ëª¨ì–‘ìœ¼ë¡œ ë³€í™˜</p>

    <ul>
      <li>
        <p>NewToolJSONBuilder: responsesìš© flat JSON</p>
      </li>
      <li>
        <p>OldToolJSONBuilder: completionsìš© nested JSON</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>Output ì–´ëŒ‘í„°(ë‹¨ìˆœí™”):</li>
</ol>

<ul>
  <li>ë‘ ì „ëµì€ ëª¨ë‘ ìµœì¢…ì ìœ¼ë¡œ strì„ ë°˜í™˜. ë‚´ë¶€ì˜ tool_call íŒŒì‹± ì°¨ì´ëŠ” ì „ëµì—ì„œ ìˆ¨ê¹€.</li>
</ul>

<ol>
  <li>ì„¤ì • ì£¼ì…:</li>
</ol>

<ul>
  <li>ì—”ë“œí¬ì¸íŠ¸Â·API í‚¤Â·ëª¨ë¸ëª…ì„ configë¡œ ì£¼ì….</li>
</ul>

<p>ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ì¼ íŒŒì¼ ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># arch_combo_clean.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# Config &amp; DTO
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RunConfig</span><span class="p">:</span>
    <span class="n">engine</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "gpt-oss" | "qwen"
</span>    <span class="n">task</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">samples_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span>

<span class="c1"># =========================
# Tool layer
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON schema for parameters
</span>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># executes with parsed args
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># =========================
# Tool JSON schema builders (Factory)
# =========================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">NewToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì—ì„œ ìì£¼ ë³´ì´ëŠ” </span><span class="sh">'</span><span class="s">í‰í‰í•œ(flat)</span><span class="sh">'</span><span class="s"> íˆ´ ì •ì˜
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

<span class="k">class</span> <span class="nc">OldToolJSONBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chat Completions APIì—ì„œ ìì£¼ ë³´ì´ëŠ” </span><span class="sh">'</span><span class="s">ì¤‘ì²©(nested)</span><span class="sh">'</span><span class="s"> íˆ´ ì •ì˜
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{ </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} } }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># =========================
# Strategy layer
# =========================
</span>
<span class="k">class</span> <span class="nc">EngineStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="c1"># ---- GPT OSS + Responses Strategy ----
</span>
<span class="k">class</span> <span class="nc">ResponsesStrategy</span><span class="p">(</span><span class="n">EngineStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    - responses.create ì‚¬ìš©
    - íˆ´ ì •ì˜: NewToolJSONBuilder(flat)
    - function_call â†’ ë¡œì»¬ íˆ´ ì‹¤í–‰ â†’ function_call_outputë¥¼ inputì— append â†’ ë‹¤ì‹œ responses.create
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>

        <span class="c1"># ì²« í˜¸ì¶œ
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ëˆ„ì  í…ìŠ¤íŠ¸ì™€ ë£¨í”„
</span>        <span class="n">final_text_chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># ì¶œë ¥ í…ìŠ¤íŠ¸ ìˆ˜ì§‘
</span>            <span class="n">final_text_chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

            <span class="c1"># íˆ´ í˜¸ì¶œ ìˆ˜ì§‘
</span>            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># íˆ´ ì‹¤í–‰ â†’ function_call_output ì¶”ê°€
</span>            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># ë‹¤ìŒ í„´
</span>            <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text_chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="c1"># Helpers
</span>    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">calls</span>

<span class="c1"># ---- Qwen + Chat Completions Strategy ----
</span>
<span class="k">class</span> <span class="nc">CompletionsStrategy</span><span class="p">(</span><span class="n">EngineStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    - chat.completions.create ì‚¬ìš©
    - íˆ´ ì •ì˜: OldToolJSONBuilder(nested)
    - assistant.tool_calls â†’ ë¡œì»¬ íˆ´ ì‹¤í–‰ â†’ tool ë©”ì‹œì§€ ì²¨ë¶€ â†’ ë‹¤ì‹œ completions
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">final_text_chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">final_text_chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text_chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Tool implementations
# =========================
</span>
<span class="k">def</span> <span class="nf">list_files_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_registry</span><span class="p">(</span><span class="n">samples_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_tool</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_tool</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># =========================
# Engine factory / selector
# =========================
</span>
<span class="k">def</span> <span class="nf">make_engine</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EngineStrategy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì½¤ë³´ë°•ìŠ¤ì—ì„œ </span><span class="sh">'</span><span class="s">gpt-oss</span><span class="sh">'</span><span class="s"> ë˜ëŠ” </span><span class="sh">'</span><span class="s">qwen</span><span class="sh">'</span><span class="s">ì„ ì„ íƒí•˜ë©´,
    ë‚´ë¶€ì ìœ¼ë¡œ ì•Œë§ì€ Strategy + ToolJSONBuilderë¥¼ êµ¬ì„±í•´ì„œ ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">engine</span> <span class="o">==</span> <span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Responses + New(flat) tool JSON
</span>        <span class="k">return</span> <span class="nc">ResponsesStrategy</span><span class="p">(</span><span class="n">model_cfg</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="nc">NewToolJSONBuilder</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">engine</span> <span class="o">==</span> <span class="sh">"</span><span class="s">qwen</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Completions + Old(nested) tool JSON
</span>        <span class="k">return</span> <span class="nc">CompletionsStrategy</span><span class="p">(</span><span class="n">model_cfg</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="nc">OldToolJSONBuilder</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Unknown engine. Choose </span><span class="sh">'</span><span class="s">gpt-oss</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">qwen</span><span class="sh">'</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Example main
# =========================
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ì‹¤ì œì— ë§ê²Œ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¶„ë¦¬
</span>    <span class="n">gpt_oss</span> <span class="o">=</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_OSS_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_OSS_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_GPT_OSS</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">qwen</span> <span class="o">=</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen2.5</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_QWEN</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># ì½¤ë³´ë°•ìŠ¤ ì„ íƒì„ CLIë¡œ ê°€ì • (ì‹¤ì„œë¹„ìŠ¤ë¼ë©´ UIì—ì„œ ì´ ê°’ë§Œ ë°”ê¿” ì£¼ì…)
</span>    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--engine</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">samples ë””ë ‰í† ë¦¬ ë‚´ íŒŒì¼ì„ ë³´ì—¬ì£¼ê³  í•˜ë‚˜ë¥¼ ì½ì–´ 2~3ë¬¸ì¥ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ ì‚¬ìš©.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># ëª¨ë¸ ì„ íƒ: UIì—ì„œ ì—”ì§„ì„ ë°”ê¾¸ë©´ ì´ ë§¤í•‘ë„ ë°”ê¿”ì¹˜ê¸°
</span>    <span class="n">model_cfg</span> <span class="o">=</span> <span class="n">gpt_oss</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">engine</span> <span class="o">==</span> <span class="sh">"</span><span class="s">gpt-oss</span><span class="sh">"</span> <span class="k">else</span> <span class="n">qwen</span>
    <span class="n">run_cfg</span> <span class="o">=</span> <span class="nc">RunConfig</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">samples_dir</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># ë ˆì§€ìŠ¤íŠ¸ë¦¬ êµ¬ì„±(í•„ìš”ì‹œ ì—”ì§„ë³„ ì¶”ê°€/ì‚­ì œë„ ê°€ëŠ¥)
</span>    <span class="n">registry</span> <span class="o">=</span> <span class="nf">build_registry</span><span class="p">(</span><span class="n">run_cfg</span><span class="p">.</span><span class="n">samples_dir</span><span class="p">)</span>

    <span class="c1"># ì „ëµ ìƒì„±
</span>    <span class="n">engine</span> <span class="o">=</span> <span class="nf">make_engine</span><span class="p">(</span><span class="n">run_cfg</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>

    <span class="c1"># ì‹¤í–‰
</span>    <span class="n">result_text</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">run_cfg</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result_text</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># ìƒ˜í”Œ í´ë” ë³´ì¥
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì ìš© í¬ì¸íŠ¸(ì„¤ê³„ ê´€ì ):</p>

<ul>
  <li>
    <p>í™•ì¥ì„±: ìƒˆ ì—”ì§„ì´ ëŠ˜ì–´ë‚˜ë„ Strategyë§Œ ì¶”ê°€í•˜ë©´ ë¨. ê° ì—”ì§„ì˜ í˜¸ì¶œ ì°¨ì´(Responses vs Completions, tool loop í”„ë¡œí† ì½œ)ë¥¼ ìº¡ìŠí™”í–ˆì–´.</p>
  </li>
  <li>
    <p>ì±…ì„ ë¶„ë¦¬: ToolRegistryëŠ” ë“±ë¡Â·ì‹¤í–‰ë§Œ, ToolJSONBuilderëŠ” JSON ëª¨ì–‘ë§Œ, StrategyëŠ” ëŒ€í™” ë£¨í”„ë§Œ ì±…ì„.</p>
  </li>
  <li>
    <p>UI ì—°ë™: ì½¤ë³´ë°•ìŠ¤ ì„ íƒê°’ì„ RunConfig.engineìœ¼ë¡œ ì£¼ì… â†’ make_engineì´ ì˜¬ë°”ë¥¸ ì „ëµì„ ë¦¬í„´.</p>
  </li>
  <li>
    <p>ì•ˆì „ì„±: ë£¨í”„ì— guardë¡œ í­ì£¼ ë°©ì§€. argumentsëŠ” json.loadsë¡œ ê´€ëŒ€í•˜ê²Œ íŒŒì‹±.</p>
  </li>
  <li>
    <p>êµ¬ì„± ê°€ëŠ¥ì„±: ëª¨ë¸ëª…/ì—”ë“œí¬ì¸íŠ¸/í‚¤ëŠ” ModelConfigë¡œ ë¶„ë¦¬. í™˜ê²½ë³€ìˆ˜ë‚˜ ì„¤ì •íŒŒì¼ë¡œ ì¹˜í™˜ ìš©ì´.</p>
  </li>
</ul>

<p>ì›í•œë‹¤ë©´</p>

<ul>
  <li>
    <p>ë¡œê¹… ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¶”ê°€í•´ ë‹¨ê³„ë³„(ì…ë ¥/íˆ´ìš”ì²­/ì¶œë ¥) ë¡œê·¸ë¥¼ ê³µí†µ í¬ë§·ìœ¼ë¡œ ë‚¨ê¸°ê¸°</p>
  </li>
  <li>
    <p>ToolRegistryì— ê¶Œí•œ/ìƒŒë“œë°•ìŠ¤ ì¸µ(íŒŒì¼ ì ‘ê·¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸) ì¶”ê°€</p>
  </li>
  <li>
    <p>ê²°ê³¼ë¥¼ í•­ìƒ {filename, contents} í¬ë§·ìœ¼ë¡œ ì–´ëŒ‘íŒ…í•˜ëŠ” OutputAdapter ì¶”ê°€</p>
  </li>
  <li>
    <p>async ë²„ì „(í† í° ì ˆì•½/ë™ì‹œì„±)ì„ ìœ„í•œ ë¹„ë™ê¸° ì „ëµ ì¶”ê°€</p>
  </li>
</ul>

<p>ê¹Œì§€ë„ ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ í™•ì¥ ê°€ëŠ¥í•´.</p>

<p class="chat--user">

ì¡°ê¸ˆ ë” íŒŒì´ì¬ê³¼ ì†Œí”„íŠ¸ì›¨ì–´ ì•„í‚¤í…íŠ¸ê°€ ë˜ì–´ì„œ ì˜ ìƒê°í•´ë³´ì. if gpt-ossê°€ ë“¤ì–´ê°„ ê±° ë¶€í„° ì¢€ ì•…ì·¨ê°€ ë‚˜. ì¶”í›„ì— ìƒˆë¡œìš´ ëª¨ë¸ì´ ë“¤ì–´ì˜¤ê³  ê·¸ ëª¨ë¸ì€ ì–´ë–¤ ì¡°í•©ì—ì„œ ì˜ ë™ì‘í• ì§€ ëª¨ë¥´ì–ì•„? ìƒˆë¡œìš´ ëª¨ë¸ì´ 10ê°œì¯¤ ë” ì¶”ê°€ë¼ë„ ì˜ ê´€ë¦¬ë  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ì§œì£¼ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„. â€œëª¨ë¸ì´ ê³„ì† ëŠ˜ì–´ë‚˜ë„ ê´€ë¦¬ ê°€ëŠ¥í•œ êµ¬ì¡°â€ì— ì´ˆì ì„ ë§ì¶° ì•„í‚¤í…ì²˜ë¥¼ ì¬ì •ë¦¬í–ˆì–´. í•µì‹¬ì€ â€œì¡°í•©(Protocol Ã— Tool JSON í˜•íƒœ)â€ì„ ëª¨ë¸ì—ì„œ ë¶„ë¦¬í•˜ê³ , ëª¨ë¸ë§ˆë‹¤ â€œëŠ¥ë ¥/ì„ í˜¸(capabilities &amp; preferences)â€ë§Œ ì„ ì–¸í•˜ë„ë¡ ë§Œë“œëŠ” ê±°ì•¼. ì‹¤í–‰ ì „ëµì€ ì¡°í•©ì— ë”°ë¼ ìë™ ì„ íƒÂ·ì‹¤í–‰ë˜ë©°, ì‹¤íŒ¨ ì‹œ í•©ë¦¬ì ìœ¼ë¡œ í´ë°±í•´.</p>

<p>ì•„ë˜ ìˆœì„œë¡œ ì„¤ëª…í•˜ê³  ë°”ë¡œ ë™ì‘ ê°€ëŠ¥í•œ ì˜ˆì‹œ ì½”ë“œë¥¼ ì œê³µí• ê²Œ.</p>

<ol>
  <li>ì„¤ê³„ ìš”ì </li>
</ol>

<ul>
  <li>
    <p>ëª¨ë¸ ë¬´ê´€ ì¶”ìƒí™”</p>

    <ul>
      <li>
        <p>ProtocolStrategy: í˜¸ì¶œ ë°©ì‹ì˜ ì°¨ì´ë¥¼ ìº¡ìŠí™”. í˜„ì¬ ë‘ ê°œ êµ¬í˜„</p>

        <ul>
          <li>
            <p>ResponsesProtocol (responses.create ë£¨í”„)</p>
          </li>
          <li>
            <p>CompletionsProtocol (chat.completions.create ë£¨í”„)</p>
          </li>
        </ul>
      </li>
      <li>
        <p>ToolSchemaBuilder: Tool JSON ëª¨ì–‘ì„ ìº¡ìŠí™”. ë‘ ê°œ êµ¬í˜„</p>

        <ul>
          <li>
            <p>FlatStyle (responsesì—ì„œ í”í•œ í‰í‰í•œ ìŠ¤í‚¤ë§ˆ)</p>
          </li>
          <li>
            <p>NestedStyle (completionsì—ì„œ í”í•œ function ì¤‘ì²©)</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¡°í•©(Plan) ë‹¨ìœ„ ì‹¤í–‰</p>

    <ul>
      <li>
        <p>Plan(protocol=â€¦, tool_schema=â€¦)</p>
      </li>
      <li>
        <p>Orchestratorê°€ ModelProfileì˜ preferenceì— ë”°ë¼ Planì„ ì„ íƒí•˜ê³  ì‹¤í–‰. ì‹¤íŒ¨ ì‹œ fallback Plans ìˆœì„œëŒ€ë¡œ ì‹œë„</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ModelProfileì€ â€œëª¨ë¸ëª…/ì—”ë“œí¬ì¸íŠ¸/í‚¤â€ + â€œcapabilities &amp; preferencesâ€ë§Œ ì •ì˜</p>

    <ul>
      <li>
        <p>ìƒˆ ëª¨ë¸ ì¶”ê°€ = ModelProfile í•˜ë‚˜ ë“±ë¡</p>
      </li>
      <li>
        <p>ëª¨ë¸ì´ ì–´ëŠ ì¡°í•©ì—ì„œ ì˜ ë™ì‘í•˜ëŠ”ì§€ ëª¨ë¥´ë©´, preferencesëŠ” ë¹„ì›Œ ë‘ê³  Orchestratorê°€ í‘œì¤€ ìš°ì„ ìˆœìœ„(Responses+Flat â†’ Completions+Nested)ë¥¼ ì ìš©</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ToolRegistryë¡œ íˆ´ êµ¬í˜„/ë“±ë¡ì„ ë¶„ë¦¬</p>

    <ul>
      <li>íˆ´ í•¨ìˆ˜ ì¶”ê°€/ë³€ê²½ì´ ëª¨ë¸/í”„ë¡œí† ì½œ ì½”ë“œì— ì „í˜€ ì˜í–¥ ì—†ë„ë¡</li>
    </ul>
  </li>
</ul>

<ol>
  <li>ì‹¤ì œ ë™ì‘ íë¦„</li>
</ol>

<ul>
  <li>
    <p>UI ì½¤ë³´ë°•ìŠ¤ì—ì„œ â€œëª¨ë¸ í‚¤â€ë§Œ ì„ íƒ â†’ Orchestrator.run(model_key, task)</p>
  </li>
  <li>
    <p>OrchestratorëŠ” ModelCatalogì—ì„œ í”„ë¡œí•„ ì¡°íšŒ â†’ Plan ê²°ì • â†’ í•´ë‹¹ Strategyì™€ ToolSchemaBuilderë¥¼ ê²°í•©í•´ ì‹¤í–‰</p>
  </li>
  <li>
    <p>responses í”„ë¡œí† ì½œì€ function_call_output ë£¨í”„, completions í”„ë¡œí† ì½œì€ tool ë©”ì‹œì§€ ë£¨í”„ ìˆ˜í–‰</p>
  </li>
  <li>
    <p>ìµœì¢… ê²°ê³¼ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸(plain)ë¡œ í†µì¼</p>
  </li>
</ul>

<ol>
  <li>ì½”ë“œ<br />
ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ ì‹¤í–‰ ê°€ëŠ¥. samples í´ë”ì— í…ìŠ¤íŠ¸ íŒŒì¼ ëª‡ ê°œ ë‘ê³  ëŒë ¤ë´.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># arch_flexible_orchestrator.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# Basic Configs &amp; DTOs
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelCapabilities</span><span class="p">:</span>
    <span class="c1"># ê°€ëŠ¥í•œ í”„ë¡œí† ì½œ
</span>    <span class="n">supports_responses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">supports_completions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># ì„ í˜¸/ê¶Œì¥ ì¡°í•©(Plan)ì„ ìš°ì„  ì‹œë„. ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ìš°ì„ ìˆœìœ„ê°€ ì ìš©ë¨
</span>    <span class="n">preferred_plans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># e.g. [("responses","flat"), ("completions","nested")]
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelProfile</span><span class="p">:</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># UI ì½¤ë³´ë°•ìŠ¤ìš© ID
</span>    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span>
    <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span>

<span class="c1"># =========================
# Tool Layer
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON schema
</span>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># ê¸°ë³¸ íˆ´ 2ê°œ
</span><span class="k">def</span> <span class="nf">list_files_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_default_registry</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_tool</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_tool</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># =========================
# Tool JSON Schema Builders
# =========================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responsesì—ì„œ ìì£¼ ì“°ëŠ” í‰í‰í•œ íˆ´ í˜•ì‹:
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Completionsì—ì„œ ìì£¼ ì“°ëŠ” ì¤‘ì²© íˆ´ í˜•ì‹:
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{ </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} } }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># =========================
# Protocol Strategies
# =========================
</span>
<span class="k">class</span> <span class="nc">ProtocolStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="c1"># Responses í”„ë¡œí† ì½œ
</span><span class="k">class</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                              <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">calls</span>

<span class="c1"># Completions í”„ë¡œí† ì½œ
</span><span class="k">class</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># =========================
# Planning (ì¡°í•© ê²°ì •)
# =========================
</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Plan</span><span class="p">:</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span>         <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_schema</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># "flat" | "nested"
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown model key: </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>

        <span class="n">plans</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">caps</span><span class="p">)</span>
        <span class="n">last_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">strategy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_strategy</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">plan</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">strategy</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="c1"># ë‹¤ìŒ í”Œëœìœ¼ë¡œ ì‹œë„
</span>                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">last_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">last_error</span>
        <span class="k">return</span> <span class="sh">""</span>

    <span class="k">def</span> <span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 1) ëª…ì‹œëœ ì„ í˜¸ í”Œëœ ìš°ì„ 
</span>        <span class="k">for</span> <span class="n">proto</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">.</span><span class="n">preferred_plans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">caps</span><span class="p">):</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Plan</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="c1"># 2) ê¸°ë³¸ í´ë°± ìˆœì„œ
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>   <span class="c1"># í˜¹ì‹œ íŠ¹ì • ëª¨ë¸ì´ nestedë¥¼ ìš”êµ¬í•œë‹¤ë©´
</span>            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_supported</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_responses</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_completions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProtocolStrategy</span><span class="p">:</span>
        <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span> <span class="o">=</span> <span class="nc">FlatStyleBuilder</span><span class="p">()</span> <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">tool_schema</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span> <span class="k">else</span> <span class="nc">NestedStyleBuilder</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown protocol: </span><span class="si">{</span><span class="n">plan</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Model Catalog (ë“±ë¡/í™•ì¥ ì§€ì )
# =========================
</span>
<span class="k">def</span> <span class="nf">build_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ìƒˆ ëª¨ë¸ì„ ì¶”ê°€í•˜ë ¤ë©´ ì•„ë˜ dictì— í•­ëª© 1ì¤„ë§Œ ë” ë„£ìœ¼ë©´ ë¨.
    - ëª¨ë¸ í‚¤(key): UI ì½¤ë³´ë°•ìŠ¤ì—ì„œ ì“°ëŠ” ì‹ë³„ì
    - name/base_url/api_key: í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…(ë‹¤ë¥¸ ë²¤ë” SDKì—¬ë„ OpenAI í˜¸í™˜ì´ë©´ ê·¸ëŒ€ë¡œ ê°€ëŠ¥)
    - ìº¡ëŠ¥/ì„ í˜¸(preferred_plans): ì¡°í•©ì„ ëª°ë¼ë„ ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ìˆœì„œëŒ€ë¡œ ìë™ ì‹œë„
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="c1"># ì˜ˆì‹œ1: GPT-ê³„ì—´(Responses ì„ í˜¸)
</span>        <span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>  <span class="c1"># ë¨¼ì € responses+flat ì‹œë„
</span>            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># ì˜ˆì‹œ2: Qwen-ê³„ì—´(Completions ì„ í˜¸)
</span>        <span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen2.5</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>  <span class="c1"># ë¨¼ì € completions+nested ì‹œë„
</span>            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># ì˜ˆì‹œ3: Responsesë§Œ ë˜ëŠ” ëª¨ë¸
</span>        <span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-resp-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># ì˜ˆì‹œ4: Completionsë§Œ ë˜ëŠ” ëª¨ë¸
</span>        <span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-chat-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># =========================
# Example main (UI ì½¤ë³´ë°•ìŠ¤ ëŒ€ì²´)
# =========================
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Flexible model orchestrator (plain text, tools).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model-key</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Model key from catalog (e.g., gpt_like, qwen_like, resp_only, chat_only)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">samples í´ë” íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì„ í•˜ë‚˜ ì½ì–´ 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ ì‚¬ìš©.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># ì¤€ë¹„
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="nf">build_default_registry</span><span class="p">()</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="nf">build_catalog</span><span class="p">()</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>

    <span class="c1"># ì‹¤í–‰
</span>    <span class="n">out</span> <span class="o">=</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">model_key</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<ol>
  <li>ì´ ì„¤ê³„ê°€ í™•ì¥ì— ìœ ë¦¬í•œ ì´ìœ </li>
</ol>

<ul>
  <li>
    <p>ìƒˆ ëª¨ë¸ ì¶”ê°€ ì‹œ ë³€ê²½ ë²”ìœ„ê°€ ë§¤ìš° ì‘ìŒ</p>

    <ul>
      <li>
        <p>ModelCatalogì— ModelProfile 1ì¤„ ì¶”ê°€(ì´ë¦„/ì—”ë“œí¬ì¸íŠ¸/í‚¤, ìº¡ëŠ¥/ì„ í˜¸)</p>
      </li>
      <li>
        <p>ì¡°í•©ì„ ëª°ë¼ë„ OK: preferred_plans ë¹„ìš°ë©´ Orchestratorê°€ í‘œì¤€ ìš°ì„ ìˆœìœ„ë¡œ ìë™ ì‹œë„</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¡°í•© í­ë°œì—ë„ ê²¬ê³ </p>

    <ul>
      <li>
        <p>Planì„ ë…ë¦½ íƒ€ì…ìœ¼ë¡œ ê´€ë¦¬í•´ì„œ Protocol Ã— ToolSchemaë¥¼ ëª…ì‹œì ìœ¼ë¡œ í‘œê¸°</p>
      </li>
      <li>
        <p>ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ Planìœ¼ë¡œ í´ë°±í•˜ëŠ” ì¼ê´€ëœ ë¡œì§</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ê´€ì‹¬ì‚¬ ë¶„ë¦¬</p>

    <ul>
      <li>
        <p>ToolRegistry/ToolSpec: íˆ´ êµ¬í˜„ê³¼ íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆë§Œ ê´€ë¦¬</p>
      </li>
      <li>
        <p>ToolJSONBuilder: JSON ëª¨ì–‘ë§Œ ë‹´ë‹¹(Flat/Nested ì¶”ê°€ ì‰¬ì›€)</p>
      </li>
      <li>
        <p>ProtocolStrategy: í˜¸ì¶œ/ë£¨í”„/íŒŒì‹± ì°¨ì´ë§Œ ë‹´ë‹¹</p>
      </li>
      <li>
        <p>Orchestrator: ëª¨ë¸ ì„ íƒê³¼ í”Œëœ ì„ ì •/í´ë°±ë§Œ ë‹´ë‹¹</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>ì»¤ìŠ¤í„°ë§ˆì´ì§• íŒíŠ¸</li>
</ol>

<ul>
  <li>
    <p>ëª¨ë¸ë³„ â€œë„êµ¬ ì •ì±…â€ì´ ë‹¤ë¥´ë©´ ModelProfileì— tool_policy ì½œë°±ì„ ì¶”ê°€í•´ íŠ¹ì • íˆ´ë§Œ ë…¸ì¶œ ê°€ëŠ¥</p>
  </li>
  <li>
    <p>ë¡œê¹…/ë©”íŠ¸ë¦­ìŠ¤: ProtocolStrategy.run ë‚´ë¶€ì—ì„œ ì½œ ì¹´ìš´íŠ¸/ì§€ì—°/í† í° ì‚¬ìš©ëŸ‰(ì‘ë‹µ í•„ë“œì— ìˆìœ¼ë©´) ìˆ˜ì§‘ í›„ ê³µí†µ ì¸í„°í˜ì´ìŠ¤ë¡œ ë¦¬í„´</p>
  </li>
  <li>
    <p>ì•ˆì „ ëª¨ë“œ: íŒŒì¼ ì ‘ê·¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸(ì˜ˆ: samples í•˜ìœ„ë§Œ í—ˆìš©)ë¥¼ ToolRegistry.callì— ì£¼ì…</p>
  </li>
  <li>
    <p>í›„ì¼ JSON ëª¨ë“œ/Structuredê°€ ì•ˆì •í™”ë˜ë©´ Planì— â€œoutput_formatâ€ ì¶•ì„ ì¶”ê°€í•´ ì „ëµì ìœ¼ë¡œ ì„ íƒ ê°€ëŠ¥</p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ ì´ êµ¬ì¡°ë¡œ í…ŒìŠ¤íŠ¸ í•˜ë„¤ìŠ¤(ì—¬ëŸ¬ ëª¨ë¸Ã—í”Œëœì„ í•œ ë²ˆì— ëŒë ¤ ê²°ê³¼ ë¹„êµ)ë„ ë°”ë¡œ ì–¹ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

ì¶”ê°€ ìš”ì²­ ì‚¬í•­ 1. Async í†µì‹ ë§Œ ì‚¬ìš©í•´ì¤˜. 
<code class="language-plaintext highlighter-rouge">
async with AsyncOpenAI(
    ..., http_clinet=httpx.AsyncClient(event_hooks=hooks) as client:
    client....
</code>

2. ìœ ì €ê°€ ì¸í„°ëŸ½íŠ¸í•˜ë©´ ì¤‘ì§€ê°€ ë˜ì–´ì•¼ í•´. ì˜ˆë¥¼ ë“¤ì–´ ì£¼ê¸°ì ìœ¼ë¡œ user.processing_interrupted() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì„œ ì·¨ì†Œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  ê·¸ì— ë”°ë¼ clientë„ ê¹”ë”í•˜ê²Œ ì·¨ì†Œê°€ ë˜ì–´ì•¼ í•´. 3. ì£¼ì„ì€ ì˜ë¬¸ìœ¼ë¡œ ì¨ì¤˜. 4. ëª¨ë“  ì½”ë“œë¥¼ ì¨ì¤˜.

</p>

<p>ì•„ë˜ëŠ” í™•ì¥ì„±ì— ì´ˆì ì„ ë‘” ë¹„ë™ê¸°(Async) ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ìƒ˜í”Œì´ì•¼.<br />
ì„¤ê³„ í¬ì¸íŠ¸ ìš”ì•½</p>

<ul>
  <li>
    <p>ëª¨ë¸ ìˆ˜ê°€ ëŠ˜ì–´ë‚˜ë„ ë³€ê²½ ìµœì†Œí™”: ìƒˆ ëª¨ë¸ì€ ModelProfileë§Œ ì¶”ê°€í•˜ë©´ ë¨.</p>
  </li>
  <li>
    <p>ì¡°í•©(Protocol Ã— Tool-JSON-Style)ì„ ëª¨ë¸ê³¼ ë¶„ë¦¬: Orchestratorê°€ Planì„ ìë™ ì„ íƒÂ·í´ë°±.</p>
  </li>
  <li>
    <p>ìˆœìˆ˜ ë¹„ë™ê¸° í†µì‹ ë§Œ ì‚¬ìš©: AsyncOpenAI + httpx.AsyncClient.</p>
  </li>
  <li>
    <p>ì‚¬ìš©ì ì¸í„°ëŸ½íŠ¸ ì§€ì›: user.processing_interrupted()ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ê³ , ì§„í–‰ ì¤‘ ìš”ì²­ì€ asyncio Task ì·¨ì†Œë¡œ ê¹”ë”íˆ ì¤‘ë‹¨.</p>
  </li>
</ul>

<p>ì½”ë“œëŠ” í•œ íŒŒì¼ë¡œ ë™ì‘í•˜ë©° ì¼ë°˜ í…ìŠ¤íŠ¸ ì¶œë ¥ë§Œì„ ë°˜í™˜í•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># async_arch_orchestrator.py
# Python 3.10+
# pip install --upgrade openai httpx
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># ============================================================
# Exceptions / Interrupt
# ============================================================
</span>
<span class="k">class</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when the user has interrupted the processing.</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">UserInterruptController</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    A simple interrupt controller.
    - Call `trigger()` to mark as interrupted (e.g., SIGINT handler).
    - Frameworks/UI can override processing_interrupted() to integrate with their own state.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">processing_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Return True if the user has requested cancellation.</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Externally trigger an interrupt (e.g., from a signal handler or UI callback).</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_event</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

<span class="c1"># ============================================================
# Configs &amp; Profiles
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelCapabilities</span><span class="p">:</span>
    <span class="c1"># Supported protocols
</span>    <span class="n">supports_responses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">supports_completions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># Preferred plans, empty â‡’ Orchestrator applies default order.
</span>    <span class="n">preferred_plans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># e.g. [("responses", "flat"), ("completions", "nested")]
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelProfile</span><span class="p">:</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span>
    <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span>

<span class="c1"># ============================================================
# Tool Layer
# ============================================================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON schema object
</span>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># Sync function (fast local I/O)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Keeps tool specs and executes them by name.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Tool already registered: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># Default file tools
</span>
<span class="k">def</span> <span class="nf">list_files_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_text_tool</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">build_default_registry</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">list_files_tool</span>
    <span class="p">))</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="n">func</span><span class="o">=</span><span class="n">read_text_tool</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">reg</span>

<span class="c1"># ============================================================
# Tool JSON builders (Factory)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ToolJSONBuilder</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">FlatStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    </span><span class="sh">"</span><span class="s">New</span><span class="sh">"</span><span class="s"> / flat tool JSON (often used with Responses-style examples):
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">NestedStyleBuilder</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    </span><span class="sh">"</span><span class="s">Old</span><span class="sh">"</span><span class="s"> / nested tool JSON (common in Chat Completions examples):
    { </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{ </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...} } }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ============================================================
# Async helpers (HTTP client, cancellation wrapper)
# ============================================================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">call_with_interrupt</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">interrupt_cb</span><span class="p">,</span> <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Run an awaitable while periodically checking for user interruption.
    If interrupted, cancel the task and raise UserCancelledError.
    </span><span class="sh">"""</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">task</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
            <span class="c1"># Periodically check interrupt
</span>            <span class="k">if</span> <span class="k">await</span> <span class="nf">interrupt_cb</span><span class="p">():</span>
                <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Create httpx AsyncClient event hooks.
    You can add logging or tracing here if desired.
    </span><span class="sh">"""</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># Example: print(f"[httpx] -&gt; {request.method} {request.url}")
</span>        <span class="k">return</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="c1"># Example: print(f"[httpx] &lt;- {response.status_code} {response.request.url}")
</span>        <span class="k">return</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_request</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">on_response</span><span class="p">]}</span>

<span class="c1"># ============================================================
# Protocol Strategies (Async)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ProtocolStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Base class for protocol strategies.
    Each strategy must:
      - Use AsyncOpenAI only
      - Respect user interruption at reasonable checkpoints
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span>
        <span class="n">builder</span><span class="p">:</span> <span class="n">ToolJSONBuilder</span><span class="p">,</span>
        <span class="n">interrupt</span><span class="p">:</span> <span class="n">UserInterruptController</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">interrupt</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">...</span>

<span class="k">class</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Async implementation of a Responses-style loop:
      - responses.create
      - process output_text
      - if tool calls exist: execute local tool(s), append function_call_output, repeat
    </span><span class="sh">"""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="p">})</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                        <span class="p">})</span>
        <span class="k">return</span> <span class="n">calls</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
                <span class="p">]</span>
                <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>

                <span class="c1"># First call
</span>                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                        <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                <span class="p">)</span>

                <span class="c1"># Loop
</span>                <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_collect_text</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>

                    <span class="n">calls</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_tool_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="c1"># Execute tools locally and append outputs
</span>                    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                        <span class="c1"># Check for interruption between tool calls as well
</span>                        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>

                        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                        <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                            <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                        <span class="p">})</span>

                    <span class="c1"># Next turn
</span>                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                        <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                            <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                    <span class="p">)</span>

                <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guard_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">ProtocolStrategy</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Async implementation of a Chat Completions-style loop:
      - chat.completions.create
      - assistant.tool_calls â†’ execute tools â†’ append tool messages â†’ repeat
    </span><span class="sh">"""</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="nf">build_httpx_hooks</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="p">.</span><span class="nc">Timeout</span><span class="p">(</span><span class="mf">60.0</span><span class="p">),</span> <span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span> <span class="k">as</span> <span class="n">http_client</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">specs</span><span class="p">())</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">task</span><span class="p">},</span>
                <span class="p">]</span>

                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                        <span class="n">tools</span><span class="o">=</span><span class="n">tools_json</span><span class="p">,</span>
                        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
                <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">]</span>
                <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Prepare tool messages
</span>                    <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>

                        <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                        <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="p">})</span>

                    <span class="c1"># Append assistant tool_calls echo + tool outputs
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
                    <span class="p">})</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

                    <span class="c1"># Next turn
</span>                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guard_interrupt</span><span class="p">()</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">call_with_interrupt</span><span class="p">(</span>
                        <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">processing_interrupted</span>
                    <span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

                <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guard_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">UserCancelledError</span><span class="p">(</span><span class="sh">"</span><span class="s">Processing interrupted by user.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Planning (Protocol Ã— Tool-JSON combination)
# ============================================================
</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Plan</span><span class="p">:</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span>        <span class="c1"># "responses" | "completions"
</span>    <span class="n">tool_schema</span><span class="p">:</span> <span class="nb">str</span>     <span class="c1"># "flat" | "nested"
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chooses and executes the best Plan for a given model, with fallback.
    Fully async and interruption-aware.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">:</span> <span class="n">UserInterruptController</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">interrupt</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown model key: </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>

        <span class="n">plans</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">caps</span><span class="p">)</span>
        <span class="n">last_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">strategy</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_strategy</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">plan</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">strategy</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
                <span class="c1"># Bubble up immediately on user cancellation
</span>                <span class="k">raise</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="c1"># Try next plan on failure
</span>                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">last_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">last_error</span>
        <span class="k">return</span> <span class="sh">""</span>

    <span class="k">def</span> <span class="nf">_candidate_plans</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Plan</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 1) Preferred plans first
</span>        <span class="k">for</span> <span class="n">proto</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">.</span><span class="n">preferred_plans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">caps</span><span class="p">):</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Plan</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="c1"># 2) Default fallback order
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">Plan</span><span class="p">(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_supported</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_supported</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">caps</span><span class="p">:</span> <span class="n">ModelCapabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_responses</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">caps</span><span class="p">.</span><span class="n">supports_completions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">):</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="nc">FlatStyleBuilder</span><span class="p">()</span> <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">tool_schema</span> <span class="o">==</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span> <span class="k">else</span> <span class="nc">NestedStyleBuilder</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">ResponsesProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plan</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">CompletionsProtocol</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">interrupt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown protocol: </span><span class="si">{</span><span class="n">plan</span><span class="p">.</span><span class="n">protocol</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ============================================================
# Model Catalog (extensible)
# ============================================================
</span>
<span class="k">def</span> <span class="nf">build_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelProfile</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    To add a new model, just create another ModelProfile entry here.
    If you don</span><span class="sh">'</span><span class="s">t know which combo works best, leave `preferred_plans` empty;
    Orchestrator will try the defaults in a safe order.
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="c1"># Example: GPT-like model (prefers Responses + flat tools)
</span>        <span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GPT_LIKE_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># Example: Qwen-like model (prefers Completions + nested tools)
</span>        <span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">qwen_like</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">qwen2.5</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">QWEN_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># Example: responses-only vendor
</span>        <span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">resp_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-resp-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">RESP_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flat</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># Example: completions-only vendor
</span>        <span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelProfile</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_only</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">=</span><span class="nc">ModelConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">some-chat-model</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">CHAT_ONLY_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">caps</span><span class="o">=</span><span class="nc">ModelCapabilities</span><span class="p">(</span>
                <span class="n">supports_responses</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">supports_completions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">preferred_plans</span><span class="o">=</span><span class="p">[(</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nested</span><span class="sh">"</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># ============================================================
# Main (async) with signal-based interrupt wiring
# ============================================================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">amain</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Async flexible orchestrator (plain text + tool calling).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model-key</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt_like</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Pick from catalog: gpt_like, qwen_like, resp_only, chat_only</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">List files under ./samples, pick a text file, read it, and return a 2-3 sentence summary. Use tools if needed.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># Build tool registry (you can scope tools per model if required)
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">build_default_registry</span><span class="p">()</span>

    <span class="c1"># Build catalog and orchestrator
</span>    <span class="n">catalog</span> <span class="o">=</span> <span class="nf">build_catalog</span><span class="p">()</span>
    <span class="n">interrupt</span> <span class="o">=</span> <span class="nc">UserInterruptController</span><span class="p">()</span>

    <span class="c1"># OS signal â†’ user interrupt (Ctrl+C)
</span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">add_signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">NotImplementedError</span><span class="p">:</span>
        <span class="c1"># add_signal_handler may not be available on some platforms (e.g., Windows in some envs)
</span>        <span class="k">pass</span>

    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">model_key</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL OUTPUT ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UserCancelledError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== INTERRUPTED ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== ERROR ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">amain</span><span class="p">())</span>
</code></pre></div></div>

<p>í™•ì¥ ë°©ë²•</p>

<ul>
  <li>
    <p>ìƒˆ ëª¨ë¸ ì¶”ê°€: build_catalog()ì— ModelProfile í•œ ì¤„ë§Œ ì¶”ê°€. preferred_plansê°€ ë¹„ì–´ë„ Orchestratorê°€ ê¸°ë³¸ ìˆœì„œëŒ€ë¡œ ì‹œë„.</p>
  </li>
  <li>
    <p>íˆ´ ì¶”ê°€: ToolRegistry.register(â€¦)ë§Œ í˜¸ì¶œ. íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆì™€ í•¨ìˆ˜ êµ¬í˜„ì„ ë¶™ì´ë©´ ìë™ìœ¼ë¡œ ëª¨ë“  ì „ëµì—ì„œ ì‚¬ìš©.</p>
  </li>
  <li>
    <p>ì¸í„°ëŸ½íŠ¸ ì—°ë™: UI ìŠ¤ë ˆë“œì—ì„œ interrupt.trigger()ë¥¼ í˜¸ì¶œí•˜ê±°ë‚˜, UserInterruptControllerë¥¼ êµ¬í˜„í•´ processing_interrupted()ê°€ Trueë¥¼ ë°˜í™˜í•˜ë„ë¡ ë§Œë“¤ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ë¡œê¹…/ë©”íŠ¸ë¦­/ë¦¬íŠ¸ë¼ì´: call_with_interrupt()ë‚˜ ê° ProtocolStrategy.run() ë‚´ë¶€ì— ì‰½ê²Œ ì£¼ì… ê°€ëŠ¥.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">OpenAI í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸</title><link href="https://hvppyarchive.github.io/llm/openai-api-examples/" rel="alternate" type="text/html" title="OpenAI í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸" /><published>2025-10-24T14:08:27+09:00</published><updated>2025-10-24T14:08:27+09:00</updated><id>https://hvppyarchive.github.io/llm/openai-api-examples</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/openai-api-examples/"><![CDATA[<p class="chat--user">

openai packageë¥¼ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±í• ê±°ì•¼. ëª©í‘œ: 2ê°€ì§€ ëª¨ë¸ì— ëŒ€í•´ 2ê°€ì§€ api type(completions, responses)ì— ëŒ€í•´ function calling í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³  ì‹¶ì–´. ì´ 4ê°œ ì¡°í•©ì— ëŒ€í•´ ì„¤ì •í•  ìˆ˜ ìˆê²Œ ì½”ë“œ ì‘ì„± í•˜ì. íˆ´ì€ ê°„ë‹¨íˆ íŠ¹ì • í´ë”ì˜ íŒŒì¼ ì¡°íšŒ, íŠ¹ì • í´ë”ì˜ íŒŒì¼ ì½ê¸° ë‘ ê°€ì§€ íˆ´ì„ êµ¬í˜„í• ê±°ì•¼ 2ê°œ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸, api í‚¤, ëª¨ë¸ëª…ì„ ì½”ë“œ ë‚´ì—ì„œ ì„¤ì •í•  ìˆ˜ ìˆë„ë¡ í•  ê²ƒ.

</p>

<p>ì¢‹ì•„! ì•„ë˜ëŠ” â€œë‘ ëª¨ë¸ Ã— ë‘ API íƒ€ì…(completions, responses) Ã— í•¨ìˆ˜ í˜¸ì¶œ(function calling)â€ ì¡°í•©ì„ í•œ íŒŒì¼ì—ì„œ ëª¨ë‘ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ì•¼.<br />
ìš”êµ¬ì‚¬í•­ ì •ë¦¬ëŒ€ë¡œ</p>

<ol>
  <li>
    <p>ë‘ ê°€ì§€ íŒŒì¼ ê´€ë ¨ íˆ´(í´ë” ë‚´ íŒŒì¼ ëª©ë¡ ì¡°íšŒ, íŒŒì¼ ì½ê¸°)</p>
  </li>
  <li>
    <p>2ê°œ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸Â·API í‚¤Â·ëª¨ë¸ëª…ì„ ì½”ë“œ ë‚´ì—ì„œ ì„¤ì • ê°€ëŠ¥</p>
  </li>
  <li>
    <p>4ê°€ì§€ ì¡°í•©ì„ ì›í•˜ëŠ” ëŒ€ë¡œ ì‹¤í–‰ ê°€ëŠ¥</p>
  </li>
</ol>

<p>ì„ ëª¨ë‘ ë‹´ì•˜ì–´. ìµœì‹  OpenAI Python SDKì˜ ì‚¬ìš©ë²•ê³¼ Responses APIì˜ íˆ´ í˜¸ì¶œ íë¦„ì€ ê³µì‹ ë¬¸ì„œì˜ êµ¬ì¡°ë¥¼ ë”°ëì–´. ì°¸ê³ : function callingê³¼ tools ì •ì˜ ë°©ì‹ì€ ê³µì‹ ê°€ì´ë“œì™€ ë™ì¼í•˜ê³ , Chat Completions APIì—ì„œëŠ” tool_callsë¥¼ messageì—, Responses APIì—ì„œëŠ” output í•­ëª©ê³¼ tool_callsë¥¼ í†µí•´ ì£¼ê³ ë°›ëŠ” í˜•íƒœì•¼. ê´€ë ¨ ë¬¸ì„œ: Function Calling ê°€ì´ë“œì™€ Responses API ë ˆí¼ëŸ°ìŠ¤. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼+1</a></p>

<p>ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒì²˜ëŸ¼ ë™ì‘í•´</p>

<ul>
  <li>
    <p>MODELS ì„¹ì…˜ì—ì„œ model A/Bì˜ endpoint, api_key, model ì´ë¦„ì„ ì±„ì›Œë‘”ë‹¤(ì˜ˆì‹œ í¬í•¨).</p>
  </li>
  <li>
    <p>TOOL ì •ì˜ëŠ” ê³µí†µ(JSON Schema).</p>
  </li>
  <li>
    <p>run_with_chat_completions(â€¦), run_with_responses(â€¦) ë‘ í•¨ìˆ˜ê°€ ê°ê° í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„ë¥¼ ìˆ˜í–‰.</p>
  </li>
  <li>
    <p>mainì—ì„œ ë„¤ ê°€ì§€ ì¡°í•©ì„ ìˆœì°¨ ì‹¤í–‰í•˜ê±°ë‚˜, ì›í•˜ëŠ” ì¡°í•©ë§Œ ì„ íƒ ì‹¤í–‰í•˜ë„ë¡ CLI ì˜µì…˜ ì œê³µ.</p>
  </li>
</ul>

<p>ì½”ë“œ ë³µì‚¬í•´ì„œ test_openai_tools.pyë¡œ ì €ì¥í•œ ë’¤, samples í´ë”ì— í…ŒìŠ¤íŠ¸ìš© íŒŒì¼ì„ ëª‡ ê°œ ë„£ê³  ëŒë ¤ë´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 1) êµ¬ì„±(ëª¨ë¸/ì—”ë“œí¬ì¸íŠ¸/í‚¤)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># ex) "https://api.openai.com/v1"
</span>    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># ex) os.getenv("OPENAI_API_KEY")
</span>
<span class="c1"># ì—¬ê¸°ì„œ ë‘ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸/í‚¤/ëª¨ë¸ëª…ì„ ì„¤ì •í•˜ì„¸ìš”.
# ì‹¤ì œ í‚¤ë¥¼ ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì§€ ë§ê³ , í™˜ê²½ë³€ìˆ˜ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
</span><span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">,</span>          <span class="c1"># ì˜ˆì‹œ (ì›í•˜ëŠ” ìµœì‹  ëª¨ë¸ëª…ìœ¼ë¡œ ë³€ê²½)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>           <span class="c1"># ì˜ˆì‹œ (ì›í•˜ëŠ” ìµœì‹  ëª¨ë¸ëª…ìœ¼ë¡œ ë³€ê²½)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =====================================
# 2) ë¡œì»¬ íŒŒì¼ íˆ´(í´ë” ëª©ë¡/íŒŒì¼ ì½ê¸°)
# =====================================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì§€ì • í´ë” ë‚´ íŒŒì¼ ëª©ë¡ ë°˜í™˜(íŒŒì¼ë§Œ).</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">files</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ì§€ì • ê²½ë¡œì˜ í…ìŠ¤íŠ¸ íŒŒì¼ ë‚´ìš© ë°˜í™˜(UTF-8 ê°€ì •).</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c1"># ë°”ì´ë„ˆë¦¬ ë“± í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ê²½ìš°
</span>        <span class="k">return</span> <span class="sh">""</span>

<span class="c1"># ê³µí†µ íˆ´ ìŠ¤í‚¤ë§ˆ(JSON Schema; Chat Completions/Responsesì—ì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
</span><span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content as a string.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># íˆ´ ë””ìŠ¤íŒ¨ì²˜
</span><span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># =====================================
# 3) Chat Completionsë¡œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
# =====================================
</span>
<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chat Completions APIë¡œ function calling í…ŒìŠ¤íŠ¸.
    - tools: TOOLS
    - tool_choice: </span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="s"> ê¶Œì¥
    - tool_calls -&gt; ì‹¤ì œ íŒŒì´ì¬ í•¨ìˆ˜ ì‹¤í–‰ -&gt; tool ë©”ì‹œì§€ ì²¨ë¶€ -&gt; ì¬í˜¸ì¶œ
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>  <span class="c1"># 'auto' or {'type':'function','function':{'name':'...'}}
</span>    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
</span>    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="c1"># tool ë©”ì‹œì§€ ì²¨ë¶€
</span>            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_output</span>
            <span class="p">})</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="c1"># í›„ì† í˜¸ì¶œ(ìµœì¢… ë‹µë³€ ìœ ë„)
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =====================================
# 4) Responses APIë¡œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
#    - ìµœì‹  SDK ê·œì•½ì— ë§ì¶° ë¹„ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ êµ¬ì„±
# =====================================
</span>
<span class="k">def</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Responses APIì˜ output ë°°ì—´ì—ì„œ ìì—°ì–´ í…ìŠ¤íŠ¸ë§Œ ëª¨ì•„ ë°˜í™˜.</span><span class="sh">"""</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># item.type == "message" ì¸ ê²½ìš°, item.content[*] ì¤‘ type == "output_text"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="c1"># ì¼ë¶€ ëª¨ë¸ì€ ìµœì¢…ì— ë°”ë¡œ output_textë§Œ ë‚´ë³´ë‚´ê¸°ë„ í•¨
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì˜ outputì—ì„œ tool_call ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘.
    ê° í•­ëª©ì€ {id, name, arguments} í˜•íƒœë¡œ ì •ê·œí™”í•´ì„œ ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># ì¼€ì´ìŠ¤1: item.type == "tool_call"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">tc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
            <span class="c1"># argumentsëŠ” ë¬¸ìì—´/ë”•ì…”ë„ˆë¦¬ ëª¨ë‘ ê°€ëŠ¥ì„± ê³ ë ¤
</span>            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span>

        <span class="c1"># ì¼€ì´ìŠ¤2: item.type == "message" ë‚´ë¶€ content[*]ì— tool_calls ë¬¶ì—¬ìˆì„ ìˆ˜ ìˆìŒ
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># ì¼ë¶€ SDK ë²„ì „ì—ì„œ item.tool_calls ë˜ëŠ” item.content[*].tool_calls í˜•íƒœ
</span>            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">arg_obj</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIë¡œ function calling í…ŒìŠ¤íŠ¸.
    íë¦„:
      1) responses.create(input=[{role:user, content:...}], tools=TOOLS, tool_choice=...)
      2) tool_callì´ ìˆìœ¼ë©´ ë¡œì»¬ í•¨ìˆ˜ ì‹¤í–‰
      3) responses.create(..., tool_outputs=[{tool_call_id, output}], response_id=prev.id) ë¡œ ì´ì–´ì„œ í˜¸ì¶œ
         (ìµœì‹  ë¬¸ì„œì˜ ê·œì•½ì„ ë”°ë¦„)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>
    <span class="p">)</span>

    <span class="c1"># ë£¨í”„: ë„êµ¬ í˜¸ì¶œì´ ëë‚  ë•Œê¹Œì§€
</span>    <span class="n">final_text_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># ì•ˆì „ ìƒí•œ
</span>        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">plain_text</span> <span class="o">=</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">plain_text</span><span class="p">:</span>
            <span class="n">final_text_parts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span>
            <span class="p">})</span>

        <span class="c1"># ì´ì „ responseì™€ ì´ì–´ ë¶™ì—¬ íˆ´ ê²°ê³¼ë¥¼ ì „ë‹¬
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs_payload</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">final_text_parts</span> <span class="k">if</span> <span class="n">p</span><span class="p">])</span>

<span class="c1"># =====================================
# 5) ì‹¤í–‰ë¶€(4ê°€ì§€ ì¡°í•©)
# =====================================
</span>
<span class="n">DEFAULT_USER_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë” ì•ˆì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">ê·¸ ì¤‘ í•˜ë‚˜ì˜ ë‚´ìš©ì„ ì½ì–´ì„œ í•µì‹¬ë§Œ 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">combo_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">combo_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] with Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">combo_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Test function-calling with OpenAI (4-way matrix).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which API type to run.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which model to use.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_USER_TASK</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">User task/prompt.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>

    <span class="c1"># ìƒ˜í”Œ í´ë” ì•ˆë‚´
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© ë°©ë²• ê°„ë‹¨ ì •ë¦¬</p>

<ol>
  <li>í™˜ê²½ ë³€ìˆ˜ ì„¸íŒ…(ê¶Œì¥)</li>
</ol>

<ul>
  <li>
    <p>Model A</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY=â€¦</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Model B</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY_B=â€¦</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL_B=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¤€ë¹„</li>
</ol>

<ul>
  <li>í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— samples í´ë”ë¥¼ ë§Œë“¤ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì„ 1ê°œ ì´ìƒ ë„£ëŠ”ë‹¤. ì˜ˆ: samples/readme.txt</li>
</ul>

<ol>
  <li>ì‹¤í–‰</li>
</ol>

<ul>
  <li>
    <p>ë„¤ ì¡°í•© ëª¨ë‘:<br />
python test_openai_tools.py</p>
  </li>
  <li>
    <p>íŠ¹ì • APIë§Œ:<br />
python test_openai_tools.py â€“api completions<br />
python test_openai_tools.py â€“api responses</p>
  </li>
  <li>
    <p>íŠ¹ì • ëª¨ë¸ë§Œ:<br />
python test_openai_tools.py â€“model A<br />
python test_openai_tools.py â€“model B</p>
  </li>
  <li>
    <p>í”„ë¡¬í”„íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ:<br />
python test_openai_tools.py â€“task "ì—¬ê¸°ì— ì›í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì§€ì‹œë¬¸"</p>
  </li>
</ul>

<p>êµ¬í˜„ í¬ì¸íŠ¸ ì„¤ëª…(í•„ìš” ì‹œ ì ê²€í•  ì²´í¬ë¦¬ìŠ¤íŠ¸)</p>

<ul>
  <li>
    <p>Chat Completions: response.choices[0].message.tool_callsë¥¼ í™•ì¸í•˜ê³ , ê° íˆ´ì„ ì‹¤í–‰í•œ ë’¤ tool ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•´ì„œ ì¬í˜¸ì¶œí•˜ëŠ” ì „í˜•ì  ë£¨í”„ë¥¼ ì‚¬ìš©í–ˆì–´. ì´ê²ƒì€ Function Calling ê°€ì´ë“œì˜ ê¶Œê³  íŒ¨í„´ì´ì•¼. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Responses API: responses.create(â€¦) â†’ outputì—ì„œ tool_call ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘ â†’ ì‹¤ì œ í•¨ìˆ˜ ì‹¤í–‰ â†’ tool_outputsì™€ ì´ì „ response_idë¥¼ í•¨ê»˜ ë„˜ê²¨ í›„ì† responses.create(â€¦) í˜¸ì¶œë¡œ ì´ì–´ ë¶™ì´ëŠ” íŒ¨í„´ì´ì•¼. ì´ íë¦„ì€ ê³µì‹ Responses API ë ˆí¼ëŸ°ìŠ¤ê°€ ì•ˆë‚´í•˜ëŠ” ë°©ì‹ê³¼ ë§ë¬¼ë ¤ ìˆì–´. <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>tools ìŠ¤í‚¤ë§ˆëŠ” ë‘ APIì—ì„œ ë™ì¼í•˜ê²Œ ì¬ì‚¬ìš©.</p>
  </li>
  <li>
    <p>ë¡œì»¬ íŒŒì¼ I/OëŠ” ì•ˆì „í•˜ê²Œ ì˜ˆì™¸ ì²˜ë¦¬í–ˆê³ , í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ê°€ì •(UTF-8)í–ˆì§€ë§Œ ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¬¸ìì—´ì„ ë°˜í™˜í•´ ëª¨ë¸ì´ ì ì ˆíˆ ì•ˆë‚´í•˜ë„ë¡ í–ˆì–´.</p>
  </li>
</ul>

<p>ë¬¸ì„œ ì°¸ê³  ë§í¬</p>

<ul>
  <li>
    <p>Function Calling ê°€ì´ë“œ(íˆ´ ì •ì˜/í˜¸ì¶œ íë¦„) <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Responses API ë ˆí¼ëŸ°ìŠ¤(ì‘ë‹µ êµ¬ì¡°, tool_outputs ì „ë‹¬ ë°©ì‹) <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI í”Œë«í¼</a></p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´</p>

<ul>
  <li>
    <p>ëª¨ë¸ëª…ë§Œ ë°”ê¿”ì„œ(ì˜ˆ: ìµœì‹  gpt-4.1 ê³„ì—´ ë“±) ì¦‰ì‹œ ì‹œí—˜ ê°€ëŠ¥</p>
  </li>
  <li>
    <p>tool_choiceë¥¼ "any"ë¡œ ë°”ê¾¸ë©´ ì—¬ëŸ¬ íˆ´ ë³‘ë ¬ í˜¸ì¶œ ê²½í–¥ì„ ë” ì‹œí—˜í•  ìˆ˜ ìˆì–´</p>
  </li>
  <li>
    <p>samples í´ë” ê²½ë¡œë‚˜ ì½ì„ íŒŒì¼ ì„ íƒ ë¡œì§ì„ ë” ì—„ê²©í•˜ê²Œ ì§€ì •í•˜ê³  ì‹¶ë‹¤ë©´, í”„ë¡¬í”„íŠ¸ë¥¼ ê³ ì •(seed task)í•˜ê±°ë‚˜ ì‹œìŠ¤í…œ ë©”ì‹œì§€ìª½ì— ê·œì¹™ì„ ë”í•´ë„ ì¢‹ì•„</p>
  </li>
</ul>

<p>ì›í•˜ëŠ” ë¶€ë¶„ ë” ë°”ê¿”ë“œë¦´ê²Œ.</p>

<p class="chat--user">

ì•„ë‹ˆ ë‚´ê°€ ì¡°ì‚¬í–ˆì„ ë•Œ responsesìš© íˆ´ jsonì´ ìˆê³ , completionìš©ì´ ë”°ë¡œ ìˆì–´ ì¡°ê¸ˆ ë‹¤ë¥´ê²Œ ìƒê²¼ë˜ë° ì°¾ì•„ì„œ ë°˜ì˜í•´ì¤˜

</p>

<p>ì¢‹ì€ ì§€ì ì´ì•¼. ì‹¤ì œë¡œ â€œë„êµ¬ ì •ì˜(tools JSON)â€ëŠ” ë‘ APIê°€ ê±°ì˜ ê°™ì§€ë§Œ, Responses APIëŠ” ì‹¤í–‰Â·ìƒíƒœ ì „íŒŒ ë°©ì‹(response_id, tool_outputs ë“±)ê³¼ ì¶œë ¥ êµ¬ì¡°ê°€ ë‹¤ë¥´ê³ , ê°€ì´ë“œì—ì„  Responses ì˜ˆì‹œì—ì„œ ì—„ê²© íŒŒì‹±(strict) ì˜µì…˜ì„ ê³ë“¤ì—¬ ì“°ëŠ” íŒ¨í„´ì´ ìì£¼ ë³´ì—¬ì„œ ëª¨ì–‘ì´ ì‚´ì§ ë‹¬ë¼ ë³´ì¼ ìˆ˜ ìˆì–´. ê·¸ë˜ì„œ ì•„ë˜ì²˜ëŸ¼ ì•„ì˜ˆ ë‘ ë²Œì˜ ìŠ¤í‚¤ë§ˆë¥¼ ë¶„ë¦¬í•´ ë‘ê³ , Responses ìª½ì—” ì—„ê²© íŒŒì‹±ì„ ë„£ëŠ” ì‹ìœ¼ë¡œ ë°˜ì˜í–ˆì–´. ë˜í•œ ResponsesëŠ” tool_outputsì™€ response_idë¥¼ í†µí•´ ë‹¨ê³„ì ìœ¼ë¡œ ì´ì–´ë¶™ì´ëŠ” ì ì„ ì½”ë“œì— ëª…í™•íˆ í–ˆì–´. ì°¸ê³  ë¬¸ì„œ: Function Calling ê°€ì´ë“œì™€ Responses API ë ˆí¼ëŸ°ìŠ¤. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI í”Œë«í¼+2</a></p>

<p>ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë„¤ ê°€ì§€ ì¡°í•©(ëª¨ë¸ A/B Ã— completions/responses) ëª¨ë‘ í•¨ìˆ˜ í˜¸ì¶œì„ ì‹œí—˜í•˜ê³ , ë‘ ì¢…ë¥˜ì˜ íŒŒì¼ íˆ´ì„ ì œê³µí•´. ë³€ê²½ í¬ì¸íŠ¸ëŠ” 1) CHAT_TOOLS vs RESPONSES_TOOLS ë¶„ë¦¬, 2) Responses ë£¨í”„ì—ì„œ tool_outputsÂ·response_id ì‚¬ìš©ì„ ë” ì—„ê²©íˆ, 3) Responses ì¶œë ¥ íŒŒì„œ ë³´ê°•ì´ì•¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools_split_tools.py
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ê³µí†µ ì‹¤ì œ êµ¬í˜„ í•¨ìˆ˜
</span><span class="kn">import</span> <span class="n">os</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># Chat Completions ì „ìš© ë„êµ¬ JSON
# - ì „í†µì ì¸ function calling ìŠ¤í‚¤ë§ˆ
</span><span class="n">CHAT_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses ì „ìš© ë„êµ¬ JSON
# - ìŠ¤í‚¤ë§ˆ í•„ë“œëŠ” ìœ ì‚¬í•˜ì§€ë§Œ, Responses ì˜ˆì œ ê´€ë¡€ì— ë§ì¶° strictë¥¼ ì¼¬
#   (ëª¨ë¸ì´ schemaì— ì •í™•íˆ ë§ì¶° ì¸ì ìƒì„±í•˜ë„ë¡ ê°•ì œ)
</span><span class="n">RESPONSES_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">CHAT_TOOLS</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># ê° íˆ´ ì‹¤í–‰
</span>        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>
        <span class="c1"># ëŒ€í™” ì´ì–´ë¶™ì´ê¸°
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># Responses ì¶œë ¥ íŒŒì„œ
</span><span class="k">def</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>

    <span class="n">final_text</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># ResponsesëŠ” tool_outputs + response_idë¡œ ìƒíƒœë¥¼ ì´ì–´ì„œ ë³´ë‚¸ë‹¤.
</span>    <span class="c1"># ì´ì–´ë¶™ì´ê¸° íŒ¨í„´ì€ ê³µì‹ ë ˆí¼ëŸ°ìŠ¤ì˜ íë¦„ê³¼ ë™ì¼. :contentReference[oaicite:1]{index=1}
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>  <span class="c1"># ì•ˆì „ ìƒí•œ
</span>        <span class="n">txt</span> <span class="o">=</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">txt</span><span class="p">:</span>
            <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">calls</span> <span class="o">=</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">})</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>          <span class="c1"># ì´ì „ ì‘ë‹µê³¼ ì—°ê²°
</span>            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>  <span class="c1"># íˆ´ ì‹¤í–‰ ê²°ê³¼ ì „ë‹¬
</span>        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ ìš”ì•½. í•„ìš”í•˜ë©´ íˆ´ ì‚¬ìš©.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">which_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">which_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">which_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></div>

<p>í•µì‹¬ ì°¨ì´ ì •ë¦¬ ë‹¨ê³„ë³„</p>

<ol>
  <li>
    <p>ë„êµ¬ ì •ì˜ ìì²´ëŠ” í•„ë“œ êµ¬ì¡°ê°€ ë™ì¼(type=function, function.name/description/parameters)í•˜ë˜, Responses ìª½ ì˜ˆì‹œì—ì„œëŠ” strictë¥¼ ì¼œì„œ JSON Schemaë¥¼ ì—„ê²©íˆ ì§€í‚¤ê²Œ í•˜ëŠ” íŒ¨í„´ì´ ë„ë¦¬ ì“°ì¸ë‹¤. ê·¸ë˜ì„œ ìŠ¤í‚¤ë§ˆê°€ â€œì¡°ê¸ˆ ë‹¤ë¥´ê²Œ ìƒê¸´ ê²ƒì²˜ëŸ¼â€ ë³´ì¼ ìˆ˜ ìˆë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>Chat CompletionsëŠ” messages ë°°ì—´ì— assistant.tool_callsê°€ ë‚˜ì˜¤ê³ , ê° call.idì— ëŒ€ì‘í•˜ëŠ” tool ë©”ì‹œì§€ë¥¼ ë„£ì–´ ë‹¤ì‹œ chat.completions.createë¥¼ í˜¸ì¶œí•œë‹¤.</p>
  </li>
  <li>
    <p>ResponsesëŠ” outputì— tool_call í•­ëª©ì´ ë‚˜ì˜¤ë©°, ì‹¤ì œ ë„êµ¬ ì‹¤í–‰ í›„ tool_outputs ë°°ì—´ê³¼ ì´ì „ ì‘ë‹µì˜ response_idë¥¼ í¬í•¨í•´ responses.createë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•´ ìƒíƒœë¥¼ ì´ì–´ ë¶™ì¸ë‹¤. ì´ê²Œ ê°€ì¥ í° ì°¨ì´ì ì´ë‹¤. <a href="https://platform.openai.com/docs/api-reference/responses-streaming/response?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ol>

<p>ì´ ë²„ì „ìœ¼ë¡œ ëŒë ¤ë³´ê³ , Responsesì—ì„œ strictë¥¼ ë„ê³  ì‹¶ìœ¼ë©´ RESPONSES_TOOLSì—ì„œ "strict": Trueë§Œ ë¹¼ë©´ ë¼. ëª¨ë¸Â·ì—”ë“œí¬ì¸íŠ¸Â·í‚¤ëŠ” ìƒë‹¨ MODELSì—ì„œ ì¡°ì • ê°€ëŠ¥í•˜ê³ , samples í´ë”ì— í…ŒìŠ¤íŠ¸ íŒŒì¼ë§Œ ìˆìœ¼ë©´ ë°”ë¡œ ë„¤ ì¡°í•©ì„ ëª¨ë‘ í™•ì¸í•  ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ì•„ë‹ˆ ì˜ˆì‹œë¥¼ ì¢€ ì°¾ì•„ë´.. from openai import OpenAI import json client = OpenAI() # 1. Define a list of callable tools for the model tools = [ { "type": "function", "name": "get_horoscope", "description": "Get today's horoscope for an astrological sign.", "parameters": { "type": "object", "properties": { "sign": { "type": "string", "description": "An astrological sign like Taurus or Aquarius", }, }, "required": ["sign"], }, }, ] def get_horoscope(sign): return f"{sign}: Next Tuesday you will befriend a baby otter." # Create a running input list we will add to over time input_list = [ {"role": "user", "content": "What is my horoscope? I am an Aquarius."} ] # 2. Prompt the model with tools defined response = client.responses.create( model="gpt-5", tools=tools, input=input_list, ) # Save function call outputs for subsequent requests input_list += response.output for item in response.output: if item.type == "function_call": if item.name == "get_horoscope": # 3. Execute the function logic for get_horoscope horoscope = get_horoscope(json.loads(item.arguments)) # 4. Provide function call results to the model input_list.append({ "type": "function_call_output", "call_id": item.call_id, "output": json.dumps({ "horoscope": horoscope }) }) print("Final input:") print(input_list) response = client.responses.create( model="gpt-5", instructions="Respond only with a horoscope generated by a tool.", tools=tools, input=input_list, ) # 5. The model should be able to give a response! print("Final output:") print(response.model_dump_json(indent=2)) print("\n" + response.output_text) ê·¸ëŸ¬ë©´ ì´ 8ê°œ ì¡°í•©ì´ ë‚˜ì˜¤ì§€? ëª¨ë¸ x API íƒ€ì…(completion, responses) x json í˜•íƒœ ì´ 8ê°œ ì¡°í•©ì— ëŒ€í•´ ê°ê° í…ŒìŠ¤íŠ¸í•˜ëŠ” ì½”ë“œë¥¼ ì§œì¤˜ ì´ ë•Œ ì‹¤í–‰ ì¤‘ ì—ëŸ¬ê°€ ë‚˜ëŠ” ê²½ìš°ì—ëŠ” ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ë‚˜ë¨¸ì§€ê°€ ì˜ ìˆ˜í–‰ë˜ê²Œ í•´ì¤˜.

</p>

<p>ì¢‹ì•„. â€œ2ê°œ ëª¨ë¸ Ã— 2ê°œ API(completions, responses) Ã— 2ê°€ì§€ tools JSON í˜•íƒœ(Completions ìŠ¤íƒ€ì¼ vs Responses ìŠ¤íƒ€ì¼)â€ = ì´ 8ê°œ ì¡°í•©ì„ í•œ ë²ˆì— ëŒë ¤ë³´ëŠ” í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤€ë¹„í–ˆì–´. ê° ì¡°í•©ì€ ê°œë³„ try/exceptë¡œ ê°ì‹¸ ì—ëŸ¬ê°€ ë‚˜ë”ë¼ë„ ë‚˜ë¨¸ì§€ê°€ ê³„ì† ìˆ˜í–‰ë¼. tools JSONì€ ë„¤ê°€ ì¤€ Responses ìŠ¤íƒ€ì¼ ì˜ˆì‹œ(í‰í‰í•œ í˜•íƒœ: type/name/parametersê°€ ìµœìƒìœ„)ì™€, Chat Completionsì—ì„œ í”íˆ ì“°ëŠ” ì¤‘ì²© í˜•íƒœ({"type":"function","function":{â€¦}})ë¥¼ ê°ê° ë¶„ë¦¬í•´ ë‘ì—ˆê³ , ì¼ë¶€ ì¡°í•©ì€ ì˜ë„ì ìœ¼ë¡œ â€œë§ì§€ ì•ŠëŠ” í˜•íƒœâ€ë¥¼ ë„£ì—ˆê¸° ë•Œë¬¸ì— ì‹¤íŒ¨í•  ìˆ˜ë„ ìˆì–´(ê·¸ ê²½ìš° ì—ëŸ¬ë§Œ ì¶œë ¥). ì°¸ê³ ë¡œ Responsesì™€ Chat Completionsì˜ ì°¨ì´, strict ì˜µì…˜ ë“±ì€ ìµœì‹  ê°€ì´ë“œì— ì •ë¦¬ë¼ ìˆì–´. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI í”Œë«í¼+2</a></p>

<p>ì•„ë˜ íŒŒì¼ì„ test_8combos_tools.pyë¡œ ì €ì¥í•´ì„œ ì‹¤í–‰í•˜ë©´ ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_8combos_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 0) ëª¨ë¸ ì„¤ì •
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# 1) ë¡œì»¬ íˆ´ êµ¬í˜„
# =========================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ëª¨ë“  íˆ´ì˜ ê²°ê³¼ë¥¼ dictë¡œ í†µì¼í•´ì„œ ë°˜í™˜.
    Responsesì˜ function_call_outputì— ë„£ê¸° ì¢‹ê²Œ {</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="s">: ...} í˜•íƒœë¡œ ê°ì‹¸ì¤€ë‹¤.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">path</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# 2) tools JSON ë‘ ê°€ì§€ í˜•íƒœ
# =========================
</span>
<span class="c1"># (A) Chat Completions ìŠ¤íƒ€ì¼: function í•„ë“œì— ì¤‘ì²©
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># (B) Responses ìŠ¤íƒ€ì¼: ë„¤ê°€ ì¤€ ì˜ˆì‹œì²˜ëŸ¼ í‰í‰í•œ í˜•íƒœ(ì¼ë¶€ ë¬¸ì„œ/ì˜ˆì‹œì—ì„œ ë³´ì´ëŠ” í¬ë§·)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # í•„ìš” ì‹œ ì¼œì„œ ì¸ì ìŠ¤í‚¤ë§ˆ ì¤€ìˆ˜ ê°•ì œ (ë„ì›€ë§ ì°¸ì¡°)
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# 3) Chat Completions ìª½ í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
# =========================
</span>
<span class="k">def</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">  -&gt; CHAT_STYLE_TOOLS ì‚¬ìš© (ê¶Œì¥)
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS ì‚¬ìš© (ì˜ë„ì  ë¹„í˜¸í™˜ ê°€ëŠ¥)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># tool_calls ë£¨í”„
</span>    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="c1"># argumentsëŠ” ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="p">})</span>

        <span class="c1"># ëŒ€í™” ì´ì–´ë¶™ì´ê¸°
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 4) Responses ìª½ í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
# =========================
</span>
<span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì˜ output ë°°ì—´ì—ì„œ function_call / tool_call ë¥˜ ì´ë²¤íŠ¸ë¥¼ ì¶”ì¶œ.
    ë‹¤ì–‘í•œ ì¼€ì´ìŠ¤ë¥¼ ìµœëŒ€í•œ ê´€ëŒ€í•˜ê²Œ ì²˜ë¦¬í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># ì¼€ì´ìŠ¤ A: item.type == "function_call"
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="p">})</span>

        <span class="c1"># ì¼€ì´ìŠ¤ B: ì¼ë¶€ ëª¨ë¸ì´ "tool_call" / item.message.tool_calls í˜•íƒœë¡œ ì¤„ ë•Œ
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS ì‚¬ìš© (ê¶Œì¥)
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">      -&gt; CHAT_STYLE_TOOLS ì‚¬ìš© (ì˜ë„ì  ë¹„í˜¸í™˜ ê°€ëŠ¥)
    ìˆœìˆ˜ Responses ë°©ì‹: ë„¤ê°€ ì¤€ ì˜ˆì‹œ íŒ¨í„´(input_list ì¶•ì  + function_call_output)ë¡œ êµ¬í˜„.
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="c1"># running input_list
</span>    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># function_call ì²˜ë¦¬
</span>    <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="c1"># callë“¤ì„ ì°¾ì•„ ì‹¤í–‰í•˜ê³ , function_call_outputì„ ì´ì–´ ë¶™ì„
</span>    <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="c1"># ìµœì¢… ì‘ë‹µ ì‹œë„(ì§€ì‹œë¬¸ì„ ì¶”ê°€ì ìœ¼ë¡œ ì¤„ ìˆ˜ë„ ìˆìŒ)
</span>    <span class="n">r2</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">Respond with a short summary of what you found.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># í…ìŠ¤íŠ¸ ì¶”ì¶œ(ì¤‘ê°„/ìµœì¢…)
</span>    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">txt1</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt1</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt1</span><span class="p">)</span>
    <span class="n">txt2</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt2</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt2</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 5) 8ê°œ ì¡°í•© ì‹¤í–‰ê¸°
# =========================
</span>
<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ ìš”ì•½. í•„ìš”í•˜ë©´ ë„êµ¬ë¥¼ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools_json=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 8 combinations: 2 models Ã— 2 APIs Ã— 2 tools JSON styles.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># tools_variantë¥¼ "both"ë¡œ ë‘ë©´ ê° APIì—ì„œ chat/â€‹responses ë‘ ê°€ì§€ íˆ´ JSON ëª¨ë‘ ì‹œë„ â†’ 8ì¡°í•©
</span>    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># ìƒ˜í”Œ í´ë” ìƒì„± ì•ˆë‚´
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>

    <span class="c1"># 8ì¡°í•©: 2ëª¨ë¸ Ã— 2API Ã— 2JSON
</span>    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">mk</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‹¤í–‰ ì˜ˆì‹œ<br />
python test_8combos_tools.py<br />
python test_8combos_tools.py â€“apis completions â€“tools both<br />
python test_8combos_tools.py â€“models A â€“apis responses â€“tools responses</p>

<p>í¬ì¸íŠ¸ ìš”ì•½</p>

<ol>
  <li>
    <p>CHAT_STYLE_TOOLSì™€ RESPONSES_STYLE_TOOLSë¥¼ ë¶„ë¦¬í•´ ë‘ì—ˆê³ , Responses ë£¨í”„ëŠ” ë„¤ê°€ ë¶™ì—¬ì¤€ ì˜ˆì‹œì²˜ëŸ¼ input_listì— function_callê³¼ function_call_outputì„ ëˆ„ì í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í–ˆì–´. ì¼ë¶€ ë¬¸ì„œ/ì˜ˆì‹œì—ì„  strictë¥¼ ì¼œ JSON ìŠ¤í‚¤ë§ˆë¥¼ ê°•ì œí•˜ë‹ˆ í•„ìš”í•˜ë©´ í•´ë‹¹ í‚¤ë¥¼ ì¼œë©´ ë¼. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>ì¼ë¶€ ì¡°í•©ì€ ì˜ë„ì ìœ¼ë¡œ í˜¸í™˜ë˜ì§€ ì•Šì•„ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆì–´(ì˜ˆ: Chat Completionsì— Responses ìŠ¤íƒ€ì¼ tools). ëª¨ë“  runì€ try/exceptë¡œ ê°ì‹¸ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ê°€ ì´ì–´ì§„ë‹¤.</p>
  </li>
  <li>
    <p>ìµœì‹  ì°¨ì´ì ê³¼ ê¶Œì¥ íë¦„ì€ Responses vs Chat Completions ê°€ì´ë“œì—ì„œ ë¹„êµ ê°€ëŠ¥í•´. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ol>

<p>ë” ì—„ê²©í•˜ê²Œ Responsesì˜ â€œresponse_id + tool_outputsâ€ ë°©ì‹ìœ¼ë¡œ ì´ì–´ë¶™ì´ëŠ” ë²„ì „ë„ ì›í•˜ë©´ ë”°ë¡œ ì¶”ê°€í•´ì¤„ê²Œ.</p>

<p class="chat--user">

ê°œì„  í•„ìš” ì‚¬í•­ 1. responses apiì—ì„œë„ ì—¬ëŸ¬ ë²ˆ ì½œì„ í•˜ê³  ê° ëŒ€í™”ë¥¼ ë‹¤ ì¶œë ¥í•˜ê³  ì‹¶ì–´. 2. ì…ë ¥ ì „ì²´ë¥¼ ê·¸ëƒ¥ jsonìœ¼ë¡œ ì¶œë ¥í•˜ê³ , ì¶œë ¥ ì „ì²´ë„ ê·¸ëƒ¥ jsonìœ¼ë¡œ ë‹¤ ì €ì¥í•´ì¤˜. ë‹¨, ì½˜ì†” ì¶œë ¥ ìƒ‰ê¹” ì§€ì •ì„ í†µí•´ì„œ (1) ì…ë ¥ (2) íˆ´ ìš”ì²­ (3) ì¶œë ¥ ì´ êµ¬ë¶„ë˜ë©´ ì¢‹ê² ì–´. 3. ì¶”ê°€ì ìœ¼ë¡œ json formatting (structured json)ë„ ì¶”ê°€í•´ì¤˜. structured jsonì´ ìˆëŠ” ë²„ì ¼ê³¼ ì—†ëŠ” ë²„ì ¼ ê°ê° ì¶”ê°€í•´ì£¼ë©´ ì¢‹ê² ì–´. ì´ 16ê°€ì§€ ì¡°í•©ì´ ë  ê±°ì•¼. ê° apiì— ëŒ€í•œ structured formatting ì˜ˆì‹œëŠ” ì•„ë˜ ì½”ë“œë¥¼ ì°¸ê³ í•´ chat completions 
<code class="language-plaintext highlighter-rouge">
from pydantic import BaseModel
from openai import OpenAI

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

completion = client.chat.completions.parse(
    model="gpt-4o-2024-08-06",
    messages=[
        {"role": "system", "content": "Extract the event information."},
        {"role": "user", "content": "Alice and Bob are going to a science fair on Friday."},
    ],
    response_format=CalendarEvent,
)

event = completion.choices[0].message.parsed
</code>

responses 
<code class="language-plaintext highlighter-rouge">
from openai import OpenAI
from pydantic import BaseModel

client = OpenAI()

class CalendarEvent(BaseModel):
    name: str
    date: str
    participants: list[str]

response = client.responses.parse(
    model="gpt-4o-2024-08-06",
    input=[
        {"role": "system", "content": "Extract the event information."},
        {
            "role": "user",
            "content": "Alice and Bob are going to a science fair on Friday.",
        },
    ],
    text_format=CalendarEvent,
)

event = response.output_parsed
</code>

</p>

<p>ì¢‹ì•„, ìš”êµ¬ì‚¬í•­(2ëª¨ë¸ Ã— 2 API íƒ€ì… Ã— 2 Tools JSON ìŠ¤íƒ€ì¼ Ã— 2 Structured í¬ë§· ìœ ë¬´ = 16ì¡°í•©)ì„ ëª¨ë‘ ë§Œì¡±í•˜ëŠ” ë‹¨ì¼ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤€ë¹„í–ˆì–´. ë‹¤ìŒì„ ë³´ì¥í•´.</p>

<ol>
  <li>
    <p>Responses APIì—ì„œ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œ(íˆ´ í˜¸ì¶œ ë°œìƒ ì‹œ ë£¨í”„)í•˜ë©°, ë§¤ ìŠ¤í…ì˜ ëŒ€í™” ì „ê°œë¥¼ ì½˜ì†”ì— ëª¨ë‘ ì¶œë ¥.</p>
  </li>
  <li>
    <p>ê° ì¡°í•©ë§ˆë‹¤ â€œì…ë ¥ ì „ì²´â€ì™€ â€œì¶œë ¥ ì „ì²´â€ë¥¼ JSONìœ¼ë¡œ íŒŒì¼ë¡œ ì €ì¥. ì½˜ì†”ì—ì„  ìƒ‰ìƒìœ¼ë¡œ (ì…ë ¥ / íˆ´ìš”ì²­ / ì¶œë ¥) êµ¬ë¶„.</p>
  </li>
  <li>
    <p>Structured JSON íŒŒì‹± ë²„ì „ê³¼ ì¼ë°˜ ë²„ì „ ê°ê° ì œê³µ.</p>
  </li>
  <li>
    <p>ì—ëŸ¬ëŠ” ì¡°í•©ë³„ë¡œ try/exceptë¡œ ê³ ë¦½ ì²˜ë¦¬í•˜ì—¬, ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ì¡°í•© ê³„ì† ì‹¤í–‰.</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œë¥¼ test_16combos.pyë¡œ ì €ì¥í•´ì„œ ì‹¤í–‰í•´. samples í´ë”ì— í…ìŠ¤íŠ¸ íŒŒì¼ ëª‡ ê°œ ë‘ë©´ íˆ´ ë™ì‘ì„ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆì–´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# ANSI ìƒ‰ìƒ ìœ í‹¸
# =========================
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># ì…ë ¥
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># íˆ´ ìš”ì²­/íˆ´ ì¶œë ¥
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># ëª¨ë¸ ì¶œë ¥
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># ì—ëŸ¬
</span>
<span class="c1"># =========================
# ëª¨ë¸/ì—”ë“œí¬ì¸íŠ¸/í‚¤ ì„¤ì •
# =========================
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# ë¡œì»¬ íˆ´ êµ¬í˜„
# =========================
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# Tools JSON 2ê°€ì§€ ìŠ¤íƒ€ì¼
# =========================
# Chat Completions ìŠ¤íƒ€ì¼ (function í•„ë“œ ì¤‘ì²©)
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses ìŠ¤íƒ€ì¼ (í‰í‰í•œ í˜•íƒœ; ì¼ë¶€ ì˜ˆì‹œ í¬ë§·)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # í•„ìš” ì‹œ í™œì„±í™”
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# Structured JSON í¬ë§·ìš© Pydantic
# =========================
</span><span class="k">class</span> <span class="nc">FileTaskResult</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chosen_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># =========================
# ê³µí†µ: ì¶œë ¥/ì €ì¥ í—¬í¼
# =========================
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># =========================
# Chat Completions ëŸ¬ë„ˆ (plain/structured)
# =========================
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="c1"># ëŒ€í™” ì‹œì‘
</span>    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># ì…ë ¥/ì¶œë ¥ ì „ì²´ ì €ì¥ì„ ìœ„í•œ êµ¬ì¡°
</span>    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: parse() ì‚¬ìš©
</span>        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># function calling ë£¨í”„ (parse ê²°ê³¼ì—ì„œë„ tool_calls ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì‹œë„)
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># ìµœì¢… êµ¬ì¡°í™” ê²°ê³¼
</span>        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FileTaskResult</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_to_print</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">:</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat Completions, structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_to_print</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: create() ì‚¬ìš©
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat Completions, plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># íŒŒì¼ ì €ì¥
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# Responses ëŸ¬ë„ˆ (plain/structured)
# - ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•˜ë©° ë§¤ ìŠ¤í… ì¶œë ¥
# =========================
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>

        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># structured: responses.parse(text_format=...)
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># íˆ´ í˜¸ì¶œ íƒì§€ â†’ ì‹¤í–‰ â†’ function_call_output ì¶”ê°€ â†’ ì´ì–´ì„œ ë˜ parse
</span>        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">FileTaskResult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># ìµœì¢… íŒŒì‹± ê²°ê³¼
</span>        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># plain: responses.create()
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="c1"># function_call_outputì„ inputì— ëˆ„ì 
</span>                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>

            <span class="c1"># ë‹¤ìŒ í„´
</span>            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="c1"># íŒŒì¼ ì €ì¥
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># =========================
# 16ê°œ ì¡°í•© ì‹¤í–‰ê¸°
#   2 ëª¨ë¸ Ã— 2 API Ã— 2 Tools JSON Ã— 2 Structured
# =========================
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span>
    <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">combo_label</span> <span class="o">=</span> <span class="nf">label_for</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">combo_label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="c1"># ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ê³„ì†
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos: 2 models Ã— 2 APIs Ã— 2 Tools JSON Ã— 2 Structured.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš©ë²• ìš”ì•½</p>

<ol>
  <li>í™˜ê²½ ë³€ìˆ˜ ì„¤ì •(ì˜ˆì‹œ)</li>
</ol>

<ul>
  <li>
    <p>ëª¨ë¸ A:<br />
OPENAI_API_KEY_A, OPENAI_BASE_URL_A=https://api.openai.com/v1, MODEL_A_NAME</p>
  </li>
  <li>
    <p>ëª¨ë¸ B:<br />
OPENAI_API_KEY_B, OPENAI_BASE_URL_B=https://api.openai.com/v1, MODEL_B_NAME</p>
  </li>
</ul>

<ol>
  <li>
    <p>ìƒ˜í”Œ ì¤€ë¹„<br />
í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— samples í´ë”ë¥¼ ë§Œë“¤ê³  í…ìŠ¤íŠ¸ íŒŒì¼ì„ 1ê°œ ì´ìƒ ë„£ì–´ë‘”ë‹¤.</p>
  </li>
  <li>
    <p>ì‹¤í–‰ ì˜ˆì‹œ</p>
  </li>
</ol>

<ul>
  <li>
    <p>16ê°œ ì „ì²´ ì¡°í•© ì‹¤í–‰<br />
python test_16combos.py</p>
  </li>
  <li>
    <p>Responsesë§Œ, structured/plain ë‘˜ ë‹¤, toolsëŠ” responses ìŠ¤íƒ€ì¼ë§Œ<br />
python test_16combos.py â€“apis responses â€“tools responses â€“structured both</p>
  </li>
  <li>
    <p>ëª¨ë¸ Aë§Œ, Chat Completionsë§Œ, structuredë§Œ<br />
python test_16combos.py â€“models A â€“apis completions â€“structured on</p>
  </li>
</ul>

<p>ë™ì‘ ì •ë¦¬</p>

<ul>
  <li>
    <p>ì½˜ì†” ìƒ‰ìƒìœ¼ë¡œ ì…ë ¥(ì²­ë¡), íˆ´ ìš”ì²­(ë…¸ë‘), ì¶œë ¥(ì´ˆë¡)ì„ êµ¬ë¶„.</p>
  </li>
  <li>
    <p>ê° ì¡°í•©ì€ runs/íƒ€ì„ìŠ¤íƒ¬í”„/ëª¨ë¸_API_tools_structured/ ì•„ë˜ì— input.json, outputs.json ì €ì¥.</p>
  </li>
  <li>
    <p>Responses APIëŠ” íˆ´ í˜¸ì¶œì´ ê³„ì† ë‚˜ì˜¤ë©´ ë£¨í”„ë¥¼ ë°˜ë³µí•˜ê³  ë§¤ ìŠ¤í… ì¶œë ¥ ë° ëˆ„ì  ì €ì¥.</p>
  </li>
  <li>
    <p>Structured ëª¨ë“œì—ì„  chat.completions.parse / responses.parseë¥¼ ì‚¬ìš©í•´ Pydantic ëª¨ë¸(FileTaskResult)ë¡œ ê²°ê³¼ë¥¼ íŒŒì‹±í•´ ë³„ë„ ìš”ì•½ë„ ì½˜ì†”ì— í‘œì‹œ.</p>
  </li>
</ul>

<p>ì›í•˜ëŠ” ì¶”ê°€ í¬ë§·(ì˜ˆ: íŒŒì¼ëª… ê·œì¹™, ë” ìì„¸í•œ ë¡œê¹…, strict ì˜µì…˜ ìƒì‹œ on ë“±)ì´ ìˆìœ¼ë©´ ì•Œë ¤ì¤˜.</p>

<p class="chat--user">

ì¶œë ¥ json í¬ë§·ì€ taskì—ì„œ ìš”ì²­í•œ ê±¸ ëŒ€ë‹µí•  ìˆ˜ ìˆê²Œ í•´ì£¼ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„. ì˜ˆë¥¼ ë“¤ì–´ filename: íŒŒì¼ëª… contents: ë‚´ìš© 

</p>

<p>ì¢‹ì•„! â€œê²°ê³¼ JSON í¬ë§·ì„ taskì— ë°”ë¡œ ì“°ì´ê²Œ(filename, contents)â€ë¡œ ë§ì¶˜ ë²„ì „ì„ ì•„ë˜ì²˜ëŸ¼ ì—…ë°ì´íŠ¸í–ˆì–´. í•µì‹¬ì€ structured ëª¨ë“œì—ì„œ íŒŒì‹± ëª¨ë¸ì„ <code class="language-plaintext highlighter-rouge">{"filename": str, "contents": str}</code>ë¡œ ê³ ì •í•˜ê³ , ëª¨ë¸ì—ê²Œ â€œcontentsì—ëŠ” ìš”ì•½ì„ ë„£ì–´ë¼â€ë¼ê³  ì§€ì‹œí•˜ëŠ” ê²ƒ. plain ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ ê·¸ëŒ€ë¡œ ììœ  í…ìŠ¤íŠ¸ë¥¼ ì¶œë ¥í•˜ê³  ì „ì²´ ì›ì‹œ JSON ë¡œê·¸ë§Œ ì €ì¥í•˜ë©°, structured ëª¨ë“œì—ì„œëŠ” ì¶”ê°€ë¡œ <code class="language-plaintext highlighter-rouge">result.json</code>ì— <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>ë¥¼ ì €ì¥í•´.</p>

<p>ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ì „ 16ì¡°í•© ì‹¤í–‰ê¸°(test_16combos.py)ë¥¼ ëŒ€ì²´í•˜ëŠ” ì™„ì „íŒì´ì•¼. ë°”ë€ ì ë§Œ ë¹ ë¥´ê²Œ ìš”ì•½í•˜ê³  ë°”ë¡œ ì½”ë“œ ì¤„ê²Œ.</p>

<p>ë³€ê²½ ìš”ì•½</p>

<ol>
  <li>Structured íŒŒì‹± ëª¨ë¸ êµì²´</li>
</ol>

<ul>
  <li>
    <p>Pydantic ëª¨ë¸ì„ <code class="language-plaintext highlighter-rouge">TaskAnswer</code>ë¡œ ì •ì˜í•˜ê³  í•„ë“œë¥¼ filename, contents ë‘ ê°œë¡œ í†µì¼.</p>
  </li>
  <li>
    <p>contentsëŠ” â€œì½ì€ íŒŒì¼ì˜ 2~3ë¬¸ì¥ ìš”ì•½â€ì„ ë„£ë„ë¡ system/instructionsì— ëª…í™•íˆ ì§€ì‹œ.</p>
  </li>
</ul>

<ol>
  <li>Structured ëª¨ë“œì—ì„œ ê²°ê³¼ JSON ì €ì¥</li>
</ol>

<ul>
  <li>
    <p>ê° ì¡°í•© í´ë”ì— <code class="language-plaintext highlighter-rouge">result.json</code>ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code> ì €ì¥.</p>
  </li>
  <li>
    <p>ê¸°ì¡´ì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>ë„ ê³„ì† ì €ì¥.</p>
  </li>
</ul>

<ol>
  <li>ì½˜ì†” ìƒ‰ìƒ ì¶œë ¥ì€ ë™ì¼í•˜ê²Œ ìœ ì§€</li>
</ol>

<ul>
  <li>ì…ë ¥(CYAN), íˆ´ ìš”ì²­(YELLOW), ì¶œë ¥(GREEN)ìœ¼ë¡œ êµ¬ë¶„.</li>
</ul>

<ol>
  <li>Responses APIëŠ” ë‹¤ë‹¨ í˜¸ì¶œ ìœ ì§€</li>
</ol>

<ul>
  <li>ê° stepì˜ ì¶œë ¥ê³¼ íˆ´ ìš”ì²­ì„ ëª¨ë‘ ì½˜ì†”ì— í‘œì‹œí•˜ê³ , outputs.jsonì— ëˆ„ì  ì €ì¥.</li>
</ul>

<p>ì½”ë“œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_16combos_v2.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI ìƒ‰ìƒ =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># ì…ë ¥
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># íˆ´ ìš”ì²­/íˆ´ ì¶œë ¥
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># ëª¨ë¸ ì¶œë ¥
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># ì—ëŸ¬
</span>
<span class="c1"># ===== ëª¨ë¸ ì„¤ì • =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== ë¡œì»¬ íˆ´ êµ¬í˜„ =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON 2ê°€ì§€ =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON ìŠ¤í‚¤ë§ˆ =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># ì„ íƒëœ íŒŒì¼ì˜ 2~3ë¬¸ì¥ ìš”ì•½(ëª¨ë¸ì´ ìƒì„±)
</span>
<span class="c1"># ===== ìœ í‹¸ =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="sh">'</span><span class="s">structured</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># ===== Chat Completions ëŸ¬ë„ˆ =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If using structured output, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="n">parsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskAnswer</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses ëŸ¬ë„ˆ =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: Show files under ./samples, pick one text file, read it, and provide a 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If structured parsing is enabled, respond ONLY with JSON having keys: filename, contents.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">}</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="n">responses_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">responses_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">final_text</span> <span class="o">=</span> <span class="nf">_collect_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_text</span><span class="p">})</span>

    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">responses_dump</span><span class="p">)</span>

<span class="c1"># ===== 16ê°œ ì¡°í•© ì‹¤í–‰ê¸° =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> structured=</span><span class="si">{</span><span class="sh">'</span><span class="s">on</span><span class="sh">'</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>  <span class="c1"># ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ê³„ì†
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 16 combos with JSON result format {filename, contents}.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--structured</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">structured_opts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">structured</span> <span class="o">==</span> <span class="sh">"</span><span class="s">on</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">structured_opts</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© í¬ì¸íŠ¸</p>

<ul>
  <li>
    <p>structured ëª¨ë“œì¼ ë•Œë§Œ <code class="language-plaintext highlighter-rouge">result.json</code>ì„ ìƒì„±í•˜ë©° ë‚´ìš©ì€ ë°˜ë“œì‹œ <code class="language-plaintext highlighter-rouge">{"filename","contents"}</code>ë¡œ ì €ì¥ë¼.</p>
  </li>
  <li>
    <p>contentsì—ëŠ” â€œì„ íƒí•œ íŒŒì¼ì˜ 2~3ë¬¸ì¥ ìš”ì•½â€ì´ ë“¤ì–´ê°€ë„ë¡ ì‹œìŠ¤í…œ ë©”ì‹œì§€ì—ì„œ ê°•ì œí–ˆì–´.</p>
  </li>
  <li>
    <p>plain ëª¨ë“œì—ì„  ììœ  í˜•ì‹ ì¶œë ¥ì´ì§€ë§Œ, ì…ë ¥ê³¼ ëª¨ë“  ì›ì‹œ ì‘ë‹µì€ <code class="language-plaintext highlighter-rouge">input.json</code>, <code class="language-plaintext highlighter-rouge">outputs.json</code>ë¡œ ì €ì¥ë¼.</p>
  </li>
  <li>
    <p>ê° ë‹¨ê³„ì˜ ì½˜ì†” ì¶œë ¥ì€ ìƒ‰ìƒìœ¼ë¡œ êµ¬ë¶„ë¼ì„œ ì…ë ¥/íˆ´ìš”ì²­/ì¶œë ¥ì´ í•œëˆˆì— ë³´ì—¬.</p>
  </li>
</ul>

<p>ì›í•˜ë©´ contentsë¥¼ â€œíŒŒì¼ ì „ë¬¸â€ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì˜µì…˜ ìŠ¤ìœ„ì¹˜ë„ ì¶”ê°€í•´ì¤„ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

Completions(structured)ì—ì„œ ValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.

</p>

<p>ì¢‹ì€ í”¼ë“œë°±ì´ì•¼. ì—ëŸ¬ ì›ì¸ì€ chat.completions.parseë¥¼ ì‚¬ìš©í•  ë•Œ íˆ´ì´ strict ëª¨ë“œê°€ ì•„ë‹ˆë©´ ìë™ íŒŒì‹±ì´ ë¶ˆê°€ëŠ¥í•´ì„œì•¼. ì¦‰, structured ëª¨ë“œì—ì„œ í•¨ìˆ˜ íˆ´ ì •ì˜ì— strict=Trueê°€ ë°˜ë“œì‹œ ë“¤ì–´ê°€ì•¼ í•´.</p>

<p>ìˆ˜ì • ë°©í–¥ ìš”ì•½ ë‹¨ê³„ë³„</p>

<ol>
  <li>
    <p>tools_variantì™€ structured ì—¬ë¶€ì— ë”°ë¼ íˆ´ JSONì— strictë¥¼ ì£¼ì…í•˜ëŠ” í—¬í¼ë¥¼ ë§Œë“ ë‹¤.</p>
  </li>
  <li>
    <p>Chat ìŠ¤íƒ€ì¼ì¼ ë• tool["function"]["strict"]=True, Responses ìŠ¤íƒ€ì¼ì¼ ë• tool["strict"]=Trueë¥¼ ë„£ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>run_chat / run_responsesì—ì„œ ê¸°ì¡´ ì •ì  TOOLS ëŒ€ì‹  ì´ í—¬í¼ë¡œ ë°˜í™˜ëœ íˆ´ì„ ì‚¬ìš©í•œë‹¤.</p>
  </li>
</ol>

<p>ì•„ë˜ ë³€ê²½ë§Œ ì ìš©í•˜ë©´ ë¼. ë‚˜ë¨¸ì§€ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ë‘¬ë„ ë™ì‘í•œë‹¤.</p>

<p>ì¶”ê°€ í•¨ìˆ˜ ë° ë³€ê²½ì </p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">copy</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">'</span><span class="s">chat</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'</span><span class="s">
    structuredê°€ Trueë©´ strict í”Œë˜ê·¸ë¥¼ ì£¼ì…í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structured</span><span class="p">:</span>
        <span class="c1"># Chat ìŠ¤íƒ€ì¼: "function" ë¸”ë¡ ì•ˆì— strict
</span>        <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Responses ìŠ¤íƒ€ì¼: ìµœìƒìœ„ì— strict
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></div>

<p>run_chat ë‚´ë¶€ì—ì„œ íˆ´ ì„ íƒ ë¶€ë¶„ êµì²´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´
# tools = CHAT_STYLE_TOOLS if tools_variant == "chat" else RESPONSES_STYLE_TOOLS
# ë³€ê²½
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>run_responses ë‚´ë¶€ì—ì„œë„ ë™ì¼í•˜ê²Œ êµì²´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´
# tools = RESPONSES_STYLE_TOOLS if tools_variant == "responses" else CHAT_STYLE_TOOLS
# ë³€ê²½
</span><span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="p">)</span>
</code></pre></div></div>

<p>ì¶”ê°€ ì°¸ê³ </p>

<ul>
  <li>
    <p>ì´ ë³€ê²½ìœ¼ë¡œ Completions(structured) ë¿ë§Œ ì•„ë‹ˆë¼ Responses(structured)ì—ì„œë„ ì¼ê´€ë˜ê²Œ ì—„ê²© íŒŒì‹±ì´ ë³´ì¥ë¼.</p>
  </li>
  <li>
    <p>plain ëª¨ë“œì—ì„  strictê°€ ì—†ì–´ë„ ë˜ì§€ë§Œ, ìœ„ í—¬í¼ëŠ” structuredì¼ ë•Œë§Œ strictë¥¼ ì£¼ì…í•˜ë¯€ë¡œ ê¸°ì¡´ ë™ì‘ì„ í•´ì¹˜ì§€ ì•Šì•„.</p>
  </li>
  <li>
    <p>tools JSONì„ ë™ì ìœ¼ë¡œ ì£¼ì…í•˜ë¯€ë¡œ, ìƒˆ í•¨ìˆ˜ë§Œ ì¶”ê°€í•˜ê³  ë‘ ê³³ í˜¸ì¶œë¶€ë§Œ ë°”ê¾¸ë©´ ëë‚˜.</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œ ìˆ˜ì •í•˜ë©´ â€œValueError list_files_in_folder is not strict. Only <code class="language-plaintext highlighter-rouge">strict</code> function tools can be auto-parsed.â€ ì—ëŸ¬ëŠ” ì‚¬ë¼ì§€ê³  16ê°œ ì¡°í•© ëª¨ë‘ ì •ìƒì ìœ¼ë¡œ ìˆœíšŒí•  ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ê·¸ë˜ë„ ê³„ì† ì—ëŸ¬ê°€ ë‚˜ë„¤. ì¼ë‹¨ ë„˜ì–´ê°€ê³  json schemeì„ ì§€ì •í•˜ëŠ” ë°©ì‹ì€ ë™ì‘ì„ ì˜ ì•ˆí•˜ë„¤ ì¼ë°˜ json ëª¨ë“œë¥¼ ì¼œë³´ê³  ì‹¶ì–´. ì´ 3ê°€ì§€ sweep(no structured, json_mode, structured)ë¡œ ì‹¤í—˜í•´ë³´ì. ì˜ˆì‹œ responses 
<code class="language-plaintext highlighter-rouge">
we_did_not_specify_stop_tokens = True

try:
    response = client.responses.create(
        model="gpt-3.5-turbo-0125",
        input=[
            {"role": "system", "content": "You are a helpful assistant designed to output JSON."},
            {"role": "user", "content": "Who won the world series in 2020? Please respond in the format {winner: ...}"}
        ],
        text={"format": {"type": "json_object"}}
    )

    # Check if the conversation was too long for the context window, resulting in incomplete JSON 
    if response.status == "incomplete" and response.incomplete_details.reason == "max_output_tokens":
        # your code should handle this error case
        pass

    # Check if the OpenAI safety system refused the request and generated a refusal instead
    if response.output[0].content[0].type == "refusal":
        # your code should handle this error case
        # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing
        print(response.output[0].content[0]["refusal"])

    # Check if the model's output included restricted content, so the generation of JSON was halted and may be partial
    if response.status == "incomplete" and response.incomplete_details.reason == "content_filter":
        # your code should handle this error case
        pass

    if response.status == "completed":
        # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a "stop token"

        if we_did_not_specify_stop_tokens:
            # If you didn't specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object
            # This will parse successfully and should now contain  "{"winner": "Los Angeles Dodgers"}"
            print(response.output_text)
        else:
            # Check if the response.output_text ends with one of your stop tokens and handle appropriately
            pass
except Exception as e:
    # Your code should handle errors here, for example a network error calling the API
    print(e)
</code>

completions 
<code class="language-plaintext highlighter-rouge">
response = client.chat.completions.create(
  model="gpt-4-1106-preview",
  messages=[
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "LangChainì€ ë¬´ì—‡ì„ í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì§€? JSONìœ¼ë¡œ ë‹µí•´ì¤˜. JSON í‚¤ì›Œë“œëŠ” Description, Features, Usageë¡œ í•´ì¤˜."}
  ],
  response_format = {'type':"json_object"}
)
</code>

</p>

<p>ì¢‹ì•„. strict ê¸°ë°˜ì˜ JSON Schema íŒŒì‹±ì€ ì ‘ê³ , ì„¸ ëª¨ë“œë¡œ ìŠ¤ìœ•í•˜ë„ë¡ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í–ˆì–´.</p>

<p>ìŠ¤ìœ• ì¶•: 2ëª¨ë¸ Ã— 2 API(completions/responses) Ã— 2 Tools JSON(chat-style/responses-style) Ã— 3 ëª¨ë“œ(plain, json_mode, structured) = ì´ 24ì¡°í•©.</p>

<p>í•µì‹¬</p>

<ul>
  <li>
    <p>plain: ììœ  ì¶œë ¥. ì „ì²´ ì…ë ¥/ì¶œë ¥ ì›ë³¸ JSONì„ ì €ì¥.</p>
  </li>
  <li>
    <p>json_mode: ëª¨ë¸ì—ê²Œ â€œë¬´ì¡°ê±´ JSONâ€ì„ ìš”êµ¬. ì¶œë ¥ì€ {"filename","contents"} í˜•ì‹. ì €ì¥ ì‹œ result.json ìƒì„±.</p>

    <ul>
      <li>
        <p>Chat Completions: response_format={'type': 'json_object'}</p>
      </li>
      <li>
        <p>Responses: text={"format":{"type":"json_object"}}</p>
      </li>
    </ul>
  </li>
  <li>
    <p>structured: ì´ì „ì²˜ëŸ¼ parse ì‚¬ìš©. ì—¬ì „íˆ ëª¨ë¸/SDKì— ë”°ë¼ strict ìš”êµ¬ë¡œ ì‹¤íŒ¨í•  ìˆ˜ë„ ìˆìœ¼ë‹ˆ try/exceptë¡œ ê²©ë¦¬. ì„±ê³µ ì‹œ result.json ìƒì„±.</p>
  </li>
  <li>
    <p>Responses APIëŠ” íˆ´ í˜¸ì¶œì´ ë‚˜ì˜¤ë©´ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œë˜ë©° ë§¤ ìŠ¤í… ì½˜ì†” ì¶œë ¥. ì½˜ì†”ì€ ìƒ‰ìƒìœ¼ë¡œ ì…ë ¥(CYAN), íˆ´ ìš”ì²­(YELLOW), ì¶œë ¥(GREEN) êµ¬ë¶„.</p>
  </li>
  <li>
    <p>ëª¨ë“  ì¡°í•©ì€ runs/íƒ€ì„ìŠ¤íƒ¬í”„/ëª¨ë¸_API_tools_mode/ í´ë”ì— input.json, outputs.json ì €ì¥. json_mode/structuredëŠ” result.json ì¶”ê°€ ì €ì¥.</p>
  </li>
  <li>
    <p>ì—ëŸ¬ëŠ” ì¡°í•©ë³„ë¡œë§Œ ì¶œë ¥í•˜ê³  ë‚˜ë¨¸ì§€ ê³„ì† ì§„í–‰.</p>
  </li>
</ul>

<p>ì½”ë“œ: test_24combos.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_24combos.py
# Python 3.10+
# pip install --upgrade openai pydantic
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== ANSI colors =====
</span><span class="n">RESET</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[0m</span><span class="sh">"</span>
<span class="n">CYAN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[36m</span><span class="sh">"</span>      <span class="c1"># input
</span><span class="n">YELLOW</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[33m</span><span class="sh">"</span>    <span class="c1"># tool
</span><span class="n">GREEN</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[32m</span><span class="sh">"</span>     <span class="c1"># output
</span><span class="n">RED</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\033</span><span class="s">[31m</span><span class="sh">"</span>       <span class="c1"># error
</span>
<span class="c1"># ===== Model configs =====
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ===== Local tools =====
</span><span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ===== Tools JSON (two shapes) =====
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># ===== Structured JSON schema (optional) =====
</span><span class="k">class</span> <span class="nc">TaskAnswer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># ===== Helpers =====
</span><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">now_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d-%H%M%S</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">api_type</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="c1"># structuredì—ì„œ strict ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ ì—¬ê¸°ì„  strict ì£¼ì…ì„ ë”
</span>    <span class="c1"># (structuredëŠ” parse() ì‚¬ìš© ì‹œ ì—¬ì „íˆ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ try/exceptë¡œ ê°ì‹¼ë‹¤)
</span>    <span class="n">base</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>
    <span class="k">return</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

<span class="c1"># ===== Common parsing for Responses =====
</span><span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="c1"># ===== Chat Completions runner =====
</span><span class="k">def</span> <span class="nf">run_chat</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">When asked to answer in JSON, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Chat Completions)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                    <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                    <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                      <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

                <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">response_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">completion</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">completion</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Chat structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># Force JSON output
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="c1"># Try to parse JSON
</span>        <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Chat)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_args</span><span class="p">})</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                                  <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Chat plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== Responses runner =====
</span><span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># "plain" | "json_mode" | "structured"
</span>    <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">make_tools</span><span class="p">(</span><span class="n">tools_variant</span><span class="p">,</span> <span class="n">structured</span><span class="o">=</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">system_inst</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Task: List files in ./samples, pick a text file, read it, and return a short 2-3 sentence summary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">If JSON is requested, reply only with an object: {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string}.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_inst</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">input_snapshot</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_list</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
    <span class="n">outputs_dump</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì…ë ¥(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">input_snapshot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                    <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                    <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                    <span class="p">})</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="n">TaskAnswer</span>
                <span class="p">)</span>
                <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
                <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output_parsed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">out_obj</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">parsed</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))}</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses structured)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">out_obj</span><span class="p">)</span>
            <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">out_obj</span><span class="p">)</span>

        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR(Responses structured) ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json_object</span><span class="sh">"</span><span class="p">}},</span>
            <span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># Try to parse JSON text
</span>        <span class="n">result_text</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">output_text</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">result_obj</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">filename</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">contents</span><span class="sh">"</span><span class="p">:</span> <span class="n">result_text</span><span class="p">}</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses json_mode)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">)</span>
        <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">result.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">result_obj</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses step 1)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
        <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">íˆ´ ìš”ì²­(Responses)</span><span class="sh">"</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]})</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">outputs_dump</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥(Responses next)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">model_dump_json</span><span class="p">()))</span>
            <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="nf">print_section</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¶œë ¥ ìš”ì•½(Responses plain)</span><span class="sh">"</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))})</span>

    <span class="c1"># Save IO logs
</span>    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">input.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">input_snapshot</span><span class="p">)</span>
    <span class="nf">write_json</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">outputs.json</span><span class="sh">"</span><span class="p">),</span> <span class="n">outputs_dump</span><span class="p">)</span>

<span class="c1"># ===== 24-combo driver =====
</span><span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">ê°€ëŠ¥í•˜ë‹¤ë©´ JSONìœ¼ë¡œ {</span><span class="se">\"</span><span class="s">filename</span><span class="se">\"</span><span class="s">: string, </span><span class="se">\"</span><span class="s">contents</span><span class="se">\"</span><span class="s">: string} í˜•íƒœë¡œ ë‹µí•´ì¤˜.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_runs_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">combo_label</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">api_type</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_runs_dir</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_chat</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">RED</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 24 combos: 2 models Ã— 2 APIs Ã— 2 tool JSONs Ã— 3 modes.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--modes</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--runs_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">./runs/</span><span class="si">{</span><span class="nf">now_id</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>
    <span class="n">mode_list</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">plain</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json_mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">structured</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">modes</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">modes</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">mode_list</span><span class="p">:</span>
                    <span class="nf">run_one</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">runs_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© íŒ</p>

<ul>
  <li>
    <p>json_modeê°€ ê°€ì¥ ì•ˆì •ì ìœ¼ë¡œ {"filename","contents"}ë¥¼ ë±‰ì–´ ì¤„ ê±°ì•¼. structuredëŠ” SDK/ëª¨ë¸ì˜ strict ì •ì±…ì— ë”°ë¼ ì—¬ì „íˆ ì‹¤íŒ¨í•  ìˆ˜ ìˆì§€ë§Œ, ìŠ¤í¬ë¦½íŠ¸ëŠ” ê°œë³„ ì¡°í•©ë³„ë¡œ ì—ëŸ¬ë¥¼ ì‚¼í‚¤ê³  ê³„ì† ì§„í–‰í•œë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë“  ì¡°í•©ì˜ ì…ë ¥/ì¶œë ¥(raw)ì„ ì €ì¥í•´ì„œ ë¦¬ê·¸ë ˆì…˜ ë¹„êµê°€ ê°€ëŠ¥í•´. json_mode/structuredëŠ” result.jsonì„ ë”°ë¡œ ì €ì¥í•˜ë¯€ë¡œ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´.</p>
  </li>
  <li>
    <p>í•„ìš”í•˜ë©´ system ë©”ì‹œì§€ì˜ ì§€ì‹œë¥¼ ìˆ˜ì •í•´ì„œ contentsì— â€œìš”ì•½â€ ëŒ€ì‹  â€œì›ë¬¸ ì „ì²´â€ë¥¼ ë„£ë„ë¡ ë°”ê¿€ ìˆ˜ë„ ìˆì–´.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">OpenAI í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸</title><link href="https://hvppyarchive.github.io/llm/openai-function-call-examples/" rel="alternate" type="text/html" title="OpenAI í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸" /><published>2025-10-22T16:55:18+09:00</published><updated>2025-10-22T16:55:18+09:00</updated><id>https://hvppyarchive.github.io/llm/openai-function-call-examples</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/openai-function-call-examples/"><![CDATA[<p class="chat--user">

openai packageë¥¼ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±í• ê±°ì•¼. ëª©í‘œ: 2ê°€ì§€ ëª¨ë¸ì— ëŒ€í•´ 2ê°€ì§€ api type(completions, responses)ì— ëŒ€í•´ function calling í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³  ì‹¶ì–´. ì´ 4ê°œ ì¡°í•©ì— ëŒ€í•´ ì„¤ì •í•  ìˆ˜ ìˆê²Œ ì½”ë“œ ì‘ì„± í•˜ì. íˆ´ì€ ê°„ë‹¨íˆ íŠ¹ì • í´ë”ì˜ íŒŒì¼ ì¡°íšŒ, íŠ¹ì • í´ë”ì˜ íŒŒì¼ ì½ê¸° ë‘ ê°€ì§€ íˆ´ì„ êµ¬í˜„í• ê±°ì•¼ 2ê°œ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸, api í‚¤, ëª¨ë¸ëª…ì„ ì½”ë“œ ë‚´ì—ì„œ ì„¤ì •í•  ìˆ˜ ìˆë„ë¡ í•  ê²ƒ.

</p>

<p>ì¢‹ì•„! ì•„ë˜ëŠ” â€œë‘ ëª¨ë¸ Ã— ë‘ API íƒ€ì…(completions, responses) Ã— í•¨ìˆ˜ í˜¸ì¶œ(function calling)â€ ì¡°í•©ì„ í•œ íŒŒì¼ì—ì„œ ëª¨ë‘ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ì•¼.<br />
ìš”êµ¬ì‚¬í•­ ì •ë¦¬ëŒ€ë¡œ</p>

<ol>
  <li>
    <p>ë‘ ê°€ì§€ íŒŒì¼ ê´€ë ¨ íˆ´(í´ë” ë‚´ íŒŒì¼ ëª©ë¡ ì¡°íšŒ, íŒŒì¼ ì½ê¸°)</p>
  </li>
  <li>
    <p>2ê°œ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸Â·API í‚¤Â·ëª¨ë¸ëª…ì„ ì½”ë“œ ë‚´ì—ì„œ ì„¤ì • ê°€ëŠ¥</p>
  </li>
  <li>
    <p>4ê°€ì§€ ì¡°í•©ì„ ì›í•˜ëŠ” ëŒ€ë¡œ ì‹¤í–‰ ê°€ëŠ¥</p>
  </li>
</ol>

<p>ì„ ëª¨ë‘ ë‹´ì•˜ì–´. ìµœì‹  OpenAI Python SDKì˜ ì‚¬ìš©ë²•ê³¼ Responses APIì˜ íˆ´ í˜¸ì¶œ íë¦„ì€ ê³µì‹ ë¬¸ì„œì˜ êµ¬ì¡°ë¥¼ ë”°ëì–´. ì°¸ê³ : function callingê³¼ tools ì •ì˜ ë°©ì‹ì€ ê³µì‹ ê°€ì´ë“œì™€ ë™ì¼í•˜ê³ , Chat Completions APIì—ì„œëŠ” tool_callsë¥¼ messageì—, Responses APIì—ì„œëŠ” output í•­ëª©ê³¼ tool_callsë¥¼ í†µí•´ ì£¼ê³ ë°›ëŠ” í˜•íƒœì•¼. ê´€ë ¨ ë¬¸ì„œ: Function Calling ê°€ì´ë“œì™€ Responses API ë ˆí¼ëŸ°ìŠ¤. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼+1</a></p>

<p>ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒì²˜ëŸ¼ ë™ì‘í•´</p>

<ul>
  <li>
    <p>MODELS ì„¹ì…˜ì—ì„œ model A/Bì˜ endpoint, api_key, model ì´ë¦„ì„ ì±„ì›Œë‘”ë‹¤(ì˜ˆì‹œ í¬í•¨).</p>
  </li>
  <li>
    <p>TOOL ì •ì˜ëŠ” ê³µí†µ(JSON Schema).</p>
  </li>
  <li>
    <p>run_with_chat_completions(â€¦), run_with_responses(â€¦) ë‘ í•¨ìˆ˜ê°€ ê°ê° í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„ë¥¼ ìˆ˜í–‰.</p>
  </li>
  <li>
    <p>mainì—ì„œ ë„¤ ê°€ì§€ ì¡°í•©ì„ ìˆœì°¨ ì‹¤í–‰í•˜ê±°ë‚˜, ì›í•˜ëŠ” ì¡°í•©ë§Œ ì„ íƒ ì‹¤í–‰í•˜ë„ë¡ CLI ì˜µì…˜ ì œê³µ.</p>
  </li>
</ul>

<p>ì½”ë“œ ë³µì‚¬í•´ì„œ test_openai_tools.pyë¡œ ì €ì¥í•œ ë’¤, samples í´ë”ì— í…ŒìŠ¤íŠ¸ìš© íŒŒì¼ì„ ëª‡ ê°œ ë„£ê³  ëŒë ¤ë´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 1) êµ¬ì„±(ëª¨ë¸/ì—”ë“œí¬ì¸íŠ¸/í‚¤)
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># ex) "https://api.openai.com/v1"
</span>    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>                <span class="c1"># ex) os.getenv("OPENAI_API_KEY")
</span>
<span class="c1"># ì—¬ê¸°ì„œ ë‘ ëª¨ë¸ì— ëŒ€í•œ ì—”ë“œí¬ì¸íŠ¸/í‚¤/ëª¨ë¸ëª…ì„ ì„¤ì •í•˜ì„¸ìš”.
# ì‹¤ì œ í‚¤ë¥¼ ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì§€ ë§ê³ , í™˜ê²½ë³€ìˆ˜ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
</span><span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">,</span>          <span class="c1"># ì˜ˆì‹œ (ì›í•˜ëŠ” ìµœì‹  ëª¨ë¸ëª…ìœ¼ë¡œ ë³€ê²½)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>           <span class="c1"># ì˜ˆì‹œ (ì›í•˜ëŠ” ìµœì‹  ëª¨ë¸ëª…ìœ¼ë¡œ ë³€ê²½)
</span>        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =====================================
# 2) ë¡œì»¬ íŒŒì¼ íˆ´(í´ë” ëª©ë¡/íŒŒì¼ ì½ê¸°)
# =====================================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì§€ì • í´ë” ë‚´ íŒŒì¼ ëª©ë¡ ë°˜í™˜(íŒŒì¼ë§Œ).</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">files</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ì§€ì • ê²½ë¡œì˜ í…ìŠ¤íŠ¸ íŒŒì¼ ë‚´ìš© ë°˜í™˜(UTF-8 ê°€ì •).</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c1"># ë°”ì´ë„ˆë¦¬ ë“± í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ê²½ìš°
</span>        <span class="k">return</span> <span class="sh">""</span>

<span class="c1"># ê³µí†µ íˆ´ ìŠ¤í‚¤ë§ˆ(JSON Schema; Chat Completions/Responsesì—ì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
</span><span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content as a string.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative path to the text file.</span><span class="sh">"</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># íˆ´ ë””ìŠ¤íŒ¨ì²˜
</span><span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># =====================================
# 3) Chat Completionsë¡œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
# =====================================
</span>
<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Chat Completions APIë¡œ function calling í…ŒìŠ¤íŠ¸.
    - tools: TOOLS
    - tool_choice: </span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="s"> ê¶Œì¥
    - tool_calls -&gt; ì‹¤ì œ íŒŒì´ì¬ í•¨ìˆ˜ ì‹¤í–‰ -&gt; tool ë©”ì‹œì§€ ì²¨ë¶€ -&gt; ì¬í˜¸ì¶œ
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>  <span class="c1"># 'auto' or {'type':'function','function':{'name':'...'}}
</span>    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
</span>    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="c1"># tool ë©”ì‹œì§€ ì²¨ë¶€
</span>            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_output</span>
            <span class="p">})</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="c1"># í›„ì† í˜¸ì¶œ(ìµœì¢… ë‹µë³€ ìœ ë„)
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =====================================
# 4) Responses APIë¡œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
#    - ìµœì‹  SDK ê·œì•½ì— ë§ì¶° ë¹„ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ êµ¬ì„±
# =====================================
</span>
<span class="k">def</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Responses APIì˜ output ë°°ì—´ì—ì„œ ìì—°ì–´ í…ìŠ¤íŠ¸ë§Œ ëª¨ì•„ ë°˜í™˜.</span><span class="sh">"""</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># item.type == "message" ì¸ ê²½ìš°, item.content[*] ì¤‘ type == "output_text"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="c1"># ì¼ë¶€ ëª¨ë¸ì€ ìµœì¢…ì— ë°”ë¡œ output_textë§Œ ë‚´ë³´ë‚´ê¸°ë„ í•¨
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì˜ outputì—ì„œ tool_call ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘.
    ê° í•­ëª©ì€ {id, name, arguments} í˜•íƒœë¡œ ì •ê·œí™”í•´ì„œ ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="c1"># ì¼€ì´ìŠ¤1: item.type == "tool_call"
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">tc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
            <span class="c1"># argumentsëŠ” ë¬¸ìì—´/ë”•ì…”ë„ˆë¦¬ ëª¨ë‘ ê°€ëŠ¥ì„± ê³ ë ¤
</span>            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span>

        <span class="c1"># ì¼€ì´ìŠ¤2: item.type == "message" ë‚´ë¶€ content[*]ì— tool_calls ë¬¶ì—¬ìˆì„ ìˆ˜ ìˆìŒ
</span>        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># ì¼ë¶€ SDK ë²„ì „ì—ì„œ item.tool_calls ë˜ëŠ” item.content[*].tool_calls í˜•íƒœ
</span>            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">arg_obj</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">arg_obj</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIë¡œ function calling í…ŒìŠ¤íŠ¸.
    íë¦„:
      1) responses.create(input=[{role:user, content:...}], tools=TOOLS, tool_choice=...)
      2) tool_callì´ ìˆìœ¼ë©´ ë¡œì»¬ í•¨ìˆ˜ ì‹¤í–‰
      3) responses.create(..., tool_outputs=[{tool_call_id, output}], response_id=prev.id) ë¡œ ì´ì–´ì„œ í˜¸ì¶œ
         (ìµœì‹  ë¬¸ì„œì˜ ê·œì•½ì„ ë”°ë¦„)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>
    <span class="p">)</span>

    <span class="c1"># ë£¨í”„: ë„êµ¬ í˜¸ì¶œì´ ëë‚  ë•Œê¹Œì§€
</span>    <span class="n">final_text_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># ì•ˆì „ ìƒí•œ
</span>        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="nf">extract_tool_calls_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">plain_text</span> <span class="o">=</span> <span class="nf">extract_text_from_responses_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">plain_text</span><span class="p">:</span>
            <span class="n">final_text_parts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span>
            <span class="p">})</span>

        <span class="c1"># ì´ì „ responseì™€ ì´ì–´ ë¶™ì—¬ íˆ´ ê²°ê³¼ë¥¼ ì „ë‹¬
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs_payload</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">final_text_parts</span> <span class="k">if</span> <span class="n">p</span><span class="p">])</span>

<span class="c1"># =====================================
# 5) ì‹¤í–‰ë¶€(4ê°€ì§€ ì¡°í•©)
# =====================================
</span>
<span class="n">DEFAULT_USER_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë” ì•ˆì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ </span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">ê·¸ ì¤‘ í•˜ë‚˜ì˜ ë‚´ìš©ì„ ì½ì–´ì„œ í•µì‹¬ë§Œ 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. í•„ìš”í•˜ë©´ íˆ´ì„ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">combo_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">combo_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] with Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">combo_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">combo_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Test function-calling with OpenAI (4-way matrix).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which API type to run.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Which model to use.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_USER_TASK</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">User task/prompt.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>

    <span class="c1"># ìƒ˜í”Œ í´ë” ì•ˆë‚´
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‚¬ìš© ë°©ë²• ê°„ë‹¨ ì •ë¦¬</p>

<ol>
  <li>í™˜ê²½ ë³€ìˆ˜ ì„¸íŒ…(ê¶Œì¥)</li>
</ol>

<ul>
  <li>
    <p>Model A</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY=â€¦</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Model B</p>

    <ul>
      <li>
        <p>OPENAI_API_KEY_B=â€¦</p>
      </li>
      <li>
        <p>OPENAI_BASE_URL_B=https://api.openai.com/v1</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¤€ë¹„</li>
</ol>

<ul>
  <li>í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— samples í´ë”ë¥¼ ë§Œë“¤ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì„ 1ê°œ ì´ìƒ ë„£ëŠ”ë‹¤. ì˜ˆ: samples/readme.txt</li>
</ul>

<ol>
  <li>ì‹¤í–‰</li>
</ol>

<ul>
  <li>
    <p>ë„¤ ì¡°í•© ëª¨ë‘:<br />
python test_openai_tools.py</p>
  </li>
  <li>
    <p>íŠ¹ì • APIë§Œ:<br />
python test_openai_tools.py â€“api completions<br />
python test_openai_tools.py â€“api responses</p>
  </li>
  <li>
    <p>íŠ¹ì • ëª¨ë¸ë§Œ:<br />
python test_openai_tools.py â€“model A<br />
python test_openai_tools.py â€“model B</p>
  </li>
  <li>
    <p>í”„ë¡¬í”„íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ:<br />
python test_openai_tools.py â€“task "ì—¬ê¸°ì— ì›í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì§€ì‹œë¬¸"</p>
  </li>
</ul>

<p>êµ¬í˜„ í¬ì¸íŠ¸ ì„¤ëª…(í•„ìš” ì‹œ ì ê²€í•  ì²´í¬ë¦¬ìŠ¤íŠ¸)</p>

<ul>
  <li>
    <p>Chat Completions: response.choices[0].message.tool_callsë¥¼ í™•ì¸í•˜ê³ , ê° íˆ´ì„ ì‹¤í–‰í•œ ë’¤ tool ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•´ì„œ ì¬í˜¸ì¶œí•˜ëŠ” ì „í˜•ì  ë£¨í”„ë¥¼ ì‚¬ìš©í–ˆì–´. ì´ê²ƒì€ Function Calling ê°€ì´ë“œì˜ ê¶Œê³  íŒ¨í„´ì´ì•¼. <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Responses API: responses.create(â€¦) â†’ outputì—ì„œ tool_call ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘ â†’ ì‹¤ì œ í•¨ìˆ˜ ì‹¤í–‰ â†’ tool_outputsì™€ ì´ì „ response_idë¥¼ í•¨ê»˜ ë„˜ê²¨ í›„ì† responses.create(â€¦) í˜¸ì¶œë¡œ ì´ì–´ ë¶™ì´ëŠ” íŒ¨í„´ì´ì•¼. ì´ íë¦„ì€ ê³µì‹ Responses API ë ˆí¼ëŸ°ìŠ¤ê°€ ì•ˆë‚´í•˜ëŠ” ë°©ì‹ê³¼ ë§ë¬¼ë ¤ ìˆì–´. <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>tools ìŠ¤í‚¤ë§ˆëŠ” ë‘ APIì—ì„œ ë™ì¼í•˜ê²Œ ì¬ì‚¬ìš©.</p>
  </li>
  <li>
    <p>ë¡œì»¬ íŒŒì¼ I/OëŠ” ì•ˆì „í•˜ê²Œ ì˜ˆì™¸ ì²˜ë¦¬í–ˆê³ , í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ê°€ì •(UTF-8)í–ˆì§€ë§Œ ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¬¸ìì—´ì„ ë°˜í™˜í•´ ëª¨ë¸ì´ ì ì ˆíˆ ì•ˆë‚´í•˜ë„ë¡ í–ˆì–´.</p>
  </li>
</ul>

<p>ë¬¸ì„œ ì°¸ê³  ë§í¬</p>

<ul>
  <li>
    <p>Function Calling ê°€ì´ë“œ(íˆ´ ì •ì˜/í˜¸ì¶œ íë¦„) <a href="https://platform.openai.com/docs/guides/function-calling">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>Responses API ë ˆí¼ëŸ°ìŠ¤(ì‘ë‹µ êµ¬ì¡°, tool_outputs ì „ë‹¬ ë°©ì‹) <a href="https://platform.openai.com/docs/api-reference/responses/create">OpenAI í”Œë«í¼</a></p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´</p>

<ul>
  <li>
    <p>ëª¨ë¸ëª…ë§Œ ë°”ê¿”ì„œ(ì˜ˆ: ìµœì‹  gpt-4.1 ê³„ì—´ ë“±) ì¦‰ì‹œ ì‹œí—˜ ê°€ëŠ¥</p>
  </li>
  <li>
    <p>tool_choiceë¥¼ "any"ë¡œ ë°”ê¾¸ë©´ ì—¬ëŸ¬ íˆ´ ë³‘ë ¬ í˜¸ì¶œ ê²½í–¥ì„ ë” ì‹œí—˜í•  ìˆ˜ ìˆì–´</p>
  </li>
  <li>
    <p>samples í´ë” ê²½ë¡œë‚˜ ì½ì„ íŒŒì¼ ì„ íƒ ë¡œì§ì„ ë” ì—„ê²©í•˜ê²Œ ì§€ì •í•˜ê³  ì‹¶ë‹¤ë©´, í”„ë¡¬í”„íŠ¸ë¥¼ ê³ ì •(seed task)í•˜ê±°ë‚˜ ì‹œìŠ¤í…œ ë©”ì‹œì§€ìª½ì— ê·œì¹™ì„ ë”í•´ë„ ì¢‹ì•„</p>
  </li>
</ul>

<p>ì›í•˜ëŠ” ë¶€ë¶„ ë” ë°”ê¿”ë“œë¦´ê²Œ.</p>

<p class="chat--user">

ì•„ë‹ˆ ë‚´ê°€ ì¡°ì‚¬í–ˆì„ ë•Œ responsesìš© íˆ´ jsonì´ ìˆê³ , completionìš©ì´ ë”°ë¡œ ìˆì–´ ì¡°ê¸ˆ ë‹¤ë¥´ê²Œ ìƒê²¼ë˜ë° ì°¾ì•„ì„œ ë°˜ì˜í•´ì¤˜

</p>

<p>ì¢‹ì€ ì§€ì ì´ì•¼. ì‹¤ì œë¡œ â€œë„êµ¬ ì •ì˜(tools JSON)â€ëŠ” ë‘ APIê°€ ê±°ì˜ ê°™ì§€ë§Œ, Responses APIëŠ” ì‹¤í–‰Â·ìƒíƒœ ì „íŒŒ ë°©ì‹(response_id, tool_outputs ë“±)ê³¼ ì¶œë ¥ êµ¬ì¡°ê°€ ë‹¤ë¥´ê³ , ê°€ì´ë“œì—ì„  Responses ì˜ˆì‹œì—ì„œ ì—„ê²© íŒŒì‹±(strict) ì˜µì…˜ì„ ê³ë“¤ì—¬ ì“°ëŠ” íŒ¨í„´ì´ ìì£¼ ë³´ì—¬ì„œ ëª¨ì–‘ì´ ì‚´ì§ ë‹¬ë¼ ë³´ì¼ ìˆ˜ ìˆì–´. ê·¸ë˜ì„œ ì•„ë˜ì²˜ëŸ¼ ì•„ì˜ˆ ë‘ ë²Œì˜ ìŠ¤í‚¤ë§ˆë¥¼ ë¶„ë¦¬í•´ ë‘ê³ , Responses ìª½ì—” ì—„ê²© íŒŒì‹±ì„ ë„£ëŠ” ì‹ìœ¼ë¡œ ë°˜ì˜í–ˆì–´. ë˜í•œ ResponsesëŠ” tool_outputsì™€ response_idë¥¼ í†µí•´ ë‹¨ê³„ì ìœ¼ë¡œ ì´ì–´ë¶™ì´ëŠ” ì ì„ ì½”ë“œì— ëª…í™•íˆ í–ˆì–´. ì°¸ê³  ë¬¸ì„œ: Function Calling ê°€ì´ë“œì™€ Responses API ë ˆí¼ëŸ°ìŠ¤. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI í”Œë«í¼+2</a></p>

<p>ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë„¤ ê°€ì§€ ì¡°í•©(ëª¨ë¸ A/B Ã— completions/responses) ëª¨ë‘ í•¨ìˆ˜ í˜¸ì¶œì„ ì‹œí—˜í•˜ê³ , ë‘ ì¢…ë¥˜ì˜ íŒŒì¼ íˆ´ì„ ì œê³µí•´. ë³€ê²½ í¬ì¸íŠ¸ëŠ” 1) CHAT_TOOLS vs RESPONSES_TOOLS ë¶„ë¦¬, 2) Responses ë£¨í”„ì—ì„œ tool_outputsÂ·response_id ì‚¬ìš©ì„ ë” ì—„ê²©íˆ, 3) Responses ì¶œë ¥ íŒŒì„œ ë³´ê°•ì´ì•¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_openai_tools_split_tools.py
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ê³µí†µ ì‹¤ì œ êµ¬í˜„ í•¨ìˆ˜
</span><span class="kn">import</span> <span class="n">os</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># Chat Completions ì „ìš© ë„êµ¬ JSON
# - ì „í†µì ì¸ function calling ìŠ¤í‚¤ë§ˆ
</span><span class="n">CHAT_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Responses ì „ìš© ë„êµ¬ JSON
# - ìŠ¤í‚¤ë§ˆ í•„ë“œëŠ” ìœ ì‚¬í•˜ì§€ë§Œ, Responses ì˜ˆì œ ê´€ë¡€ì— ë§ì¶° strictë¥¼ ì¼¬
#   (ëª¨ë¸ì´ schemaì— ì •í™•íˆ ë§ì¶° ì¸ì ìƒì„±í•˜ë„ë¡ ê°•ì œ)
</span><span class="n">RESPONSES_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Path to the text file.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">CHAT_TOOLS</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># ê° íˆ´ ì‹¤í–‰
</span>        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>
            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>
        <span class="c1"># ëŒ€í™” ì´ì–´ë¶™ì´ê¸°
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># Responses ì¶œë ¥ íŒŒì„œ
</span><span class="k">def</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="n">output_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output_items</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner_calls</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner_calls</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_choice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tools_choice</span>
    <span class="p">)</span>

    <span class="n">final_text</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># ResponsesëŠ” tool_outputs + response_idë¡œ ìƒíƒœë¥¼ ì´ì–´ì„œ ë³´ë‚¸ë‹¤.
</span>    <span class="c1"># ì´ì–´ë¶™ì´ê¸° íŒ¨í„´ì€ ê³µì‹ ë ˆí¼ëŸ°ìŠ¤ì˜ íë¦„ê³¼ ë™ì¼. :contentReference[oaicite:1]{index=1}
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>  <span class="c1"># ì•ˆì „ ìƒí•œ
</span>        <span class="n">txt</span> <span class="o">=</span> <span class="nf">_extract_text</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">txt</span><span class="p">:</span>
            <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">calls</span> <span class="o">=</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">})</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">RESPONSES_TOOLS</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>          <span class="c1"># ì´ì „ ì‘ë‹µê³¼ ì—°ê²°
</span>            <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>  <span class="c1"># íˆ´ ì‹¤í–‰ ê²°ê³¼ ì „ë‹¬
</span>        <span class="p">)</span>

    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ ìš”ì•½. í•„ìš”í•˜ë©´ íˆ´ ì‚¬ìš©.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">which_api</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [</span><span class="si">{</span><span class="n">which_api</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] Model </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">) ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">which_api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nf">run_with_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">which_api must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--api</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--model</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">api</span> <span class="o">==</span> <span class="sh">"</span><span class="s">all</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">api</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="nf">run_one</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></div>

<p>í•µì‹¬ ì°¨ì´ ì •ë¦¬ ë‹¨ê³„ë³„</p>

<ol>
  <li>
    <p>ë„êµ¬ ì •ì˜ ìì²´ëŠ” í•„ë“œ êµ¬ì¡°ê°€ ë™ì¼(type=function, function.name/description/parameters)í•˜ë˜, Responses ìª½ ì˜ˆì‹œì—ì„œëŠ” strictë¥¼ ì¼œì„œ JSON Schemaë¥¼ ì—„ê²©íˆ ì§€í‚¤ê²Œ í•˜ëŠ” íŒ¨í„´ì´ ë„ë¦¬ ì“°ì¸ë‹¤. ê·¸ë˜ì„œ ìŠ¤í‚¤ë§ˆê°€ â€œì¡°ê¸ˆ ë‹¤ë¥´ê²Œ ìƒê¸´ ê²ƒì²˜ëŸ¼â€ ë³´ì¼ ìˆ˜ ìˆë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling/supported-models?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>Chat CompletionsëŠ” messages ë°°ì—´ì— assistant.tool_callsê°€ ë‚˜ì˜¤ê³ , ê° call.idì— ëŒ€ì‘í•˜ëŠ” tool ë©”ì‹œì§€ë¥¼ ë„£ì–´ ë‹¤ì‹œ chat.completions.createë¥¼ í˜¸ì¶œí•œë‹¤.</p>
  </li>
  <li>
    <p>ResponsesëŠ” outputì— tool_call í•­ëª©ì´ ë‚˜ì˜¤ë©°, ì‹¤ì œ ë„êµ¬ ì‹¤í–‰ í›„ tool_outputs ë°°ì—´ê³¼ ì´ì „ ì‘ë‹µì˜ response_idë¥¼ í¬í•¨í•´ responses.createë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•´ ìƒíƒœë¥¼ ì´ì–´ ë¶™ì¸ë‹¤. ì´ê²Œ ê°€ì¥ í° ì°¨ì´ì ì´ë‹¤. <a href="https://platform.openai.com/docs/api-reference/responses-streaming/response?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ol>

<p>ì´ ë²„ì „ìœ¼ë¡œ ëŒë ¤ë³´ê³ , Responsesì—ì„œ strictë¥¼ ë„ê³  ì‹¶ìœ¼ë©´ RESPONSES_TOOLSì—ì„œ "strict": Trueë§Œ ë¹¼ë©´ ë¼. ëª¨ë¸Â·ì—”ë“œí¬ì¸íŠ¸Â·í‚¤ëŠ” ìƒë‹¨ MODELSì—ì„œ ì¡°ì • ê°€ëŠ¥í•˜ê³ , samples í´ë”ì— í…ŒìŠ¤íŠ¸ íŒŒì¼ë§Œ ìˆìœ¼ë©´ ë°”ë¡œ ë„¤ ì¡°í•©ì„ ëª¨ë‘ í™•ì¸í•  ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ì•„ë‹ˆ ì˜ˆì‹œë¥¼ ì¢€ ì°¾ì•„ë´.. from openai import OpenAI import json client = OpenAI() # 1. Define a list of callable tools for the model tools = [ { "type": "function", "name": "get_horoscope", "description": "Get today's horoscope for an astrological sign.", "parameters": { "type": "object", "properties": { "sign": { "type": "string", "description": "An astrological sign like Taurus or Aquarius", }, }, "required": ["sign"], }, }, ] def get_horoscope(sign): return f"{sign}: Next Tuesday you will befriend a baby otter." # Create a running input list we will add to over time input_list = [ {"role": "user", "content": "What is my horoscope? I am an Aquarius."} ] # 2. Prompt the model with tools defined response = client.responses.create( model="gpt-5", tools=tools, input=input_list, ) # Save function call outputs for subsequent requests input_list += response.output for item in response.output: if item.type == "function_call": if item.name == "get_horoscope": # 3. Execute the function logic for get_horoscope horoscope = get_horoscope(json.loads(item.arguments)) # 4. Provide function call results to the model input_list.append({ "type": "function_call_output", "call_id": item.call_id, "output": json.dumps({ "horoscope": horoscope }) }) print("Final input:") print(input_list) response = client.responses.create( model="gpt-5", instructions="Respond only with a horoscope generated by a tool.", tools=tools, input=input_list, ) # 5. The model should be able to give a response! print("Final output:") print(response.model_dump_json(indent=2)) print("\n" + response.output_text) ê·¸ëŸ¬ë©´ ì´ 8ê°œ ì¡°í•©ì´ ë‚˜ì˜¤ì§€? ëª¨ë¸ x API íƒ€ì…(completion, responses) x json í˜•íƒœ ì´ 8ê°œ ì¡°í•©ì— ëŒ€í•´ ê°ê° í…ŒìŠ¤íŠ¸í•˜ëŠ” ì½”ë“œë¥¼ ì§œì¤˜ ì´ ë•Œ ì‹¤í–‰ ì¤‘ ì—ëŸ¬ê°€ ë‚˜ëŠ” ê²½ìš°ì—ëŠ” ì—ëŸ¬ë§Œ ì¶œë ¥í•˜ê³  ë‚˜ë¨¸ì§€ê°€ ì˜ ìˆ˜í–‰ë˜ê²Œ í•´ì¤˜.

</p>

<p>ì¢‹ì•„. â€œ2ê°œ ëª¨ë¸ Ã— 2ê°œ API(completions, responses) Ã— 2ê°€ì§€ tools JSON í˜•íƒœ(Completions ìŠ¤íƒ€ì¼ vs Responses ìŠ¤íƒ€ì¼)â€ = ì´ 8ê°œ ì¡°í•©ì„ í•œ ë²ˆì— ëŒë ¤ë³´ëŠ” í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤€ë¹„í–ˆì–´. ê° ì¡°í•©ì€ ê°œë³„ try/exceptë¡œ ê°ì‹¸ ì—ëŸ¬ê°€ ë‚˜ë”ë¼ë„ ë‚˜ë¨¸ì§€ê°€ ê³„ì† ìˆ˜í–‰ë¼. tools JSONì€ ë„¤ê°€ ì¤€ Responses ìŠ¤íƒ€ì¼ ì˜ˆì‹œ(í‰í‰í•œ í˜•íƒœ: type/name/parametersê°€ ìµœìƒìœ„)ì™€, Chat Completionsì—ì„œ í”íˆ ì“°ëŠ” ì¤‘ì²© í˜•íƒœ({"type":"function","function":{â€¦}})ë¥¼ ê°ê° ë¶„ë¦¬í•´ ë‘ì—ˆê³ , ì¼ë¶€ ì¡°í•©ì€ ì˜ë„ì ìœ¼ë¡œ â€œë§ì§€ ì•ŠëŠ” í˜•íƒœâ€ë¥¼ ë„£ì—ˆê¸° ë•Œë¬¸ì— ì‹¤íŒ¨í•  ìˆ˜ë„ ìˆì–´(ê·¸ ê²½ìš° ì—ëŸ¬ë§Œ ì¶œë ¥). ì°¸ê³ ë¡œ Responsesì™€ Chat Completionsì˜ ì°¨ì´, strict ì˜µì…˜ ë“±ì€ ìµœì‹  ê°€ì´ë“œì— ì •ë¦¬ë¼ ìˆì–´. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI í”Œë«í¼+2</a></p>

<p>ì•„ë˜ íŒŒì¼ì„ test_8combos_tools.pyë¡œ ì €ì¥í•´ì„œ ì‹¤í–‰í•˜ë©´ ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_8combos_tools.py
# Python 3.10+
# pip install --upgrade openai
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># =========================
# 0) ëª¨ë¸ ì„¤ì •
# =========================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">MODELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_A_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4.1-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_A</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_B_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">https://api.openai.com/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY_B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YOUR_KEY_FOR_MODEL_B</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># =========================
# 1) ë¡œì»¬ íˆ´ êµ¬í˜„
# =========================
</span>
<span class="k">def</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">sorted</span><span class="p">([</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ëª¨ë“  íˆ´ì˜ ê²°ê³¼ë¥¼ dictë¡œ í†µì¼í•´ì„œ ë°˜í™˜.
    Responsesì˜ function_call_outputì— ë„£ê¸° ì¢‹ê²Œ {</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="s">: ...} í˜•íƒœë¡œ ê°ì‹¸ì¤€ë‹¤.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list_files_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">read_text_file</span><span class="p">(</span><span class="n">path</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># =========================
# 2) tools JSON ë‘ ê°€ì§€ í˜•íƒœ
# =========================
</span>
<span class="c1"># (A) Chat Completions ìŠ¤íƒ€ì¼: function í•„ë“œì— ì¤‘ì²©
</span><span class="n">CHAT_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># (B) Responses ìŠ¤íƒ€ì¼: ë„¤ê°€ ì¤€ ì˜ˆì‹œì²˜ëŸ¼ í‰í‰í•œ í˜•íƒœ(ì¼ë¶€ ë¬¸ì„œ/ì˜ˆì‹œì—ì„œ ë³´ì´ëŠ” í¬ë§·)
</span><span class="n">RESPONSES_STYLE_TOOLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_files_in_folder</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List file names (not directories) inside a given folder path.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative folder path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">folder_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True  # í•„ìš” ì‹œ ì¼œì„œ ì¸ì ìŠ¤í‚¤ë§ˆ ì¤€ìˆ˜ ê°•ì œ (ë„ì›€ë§ ì°¸ì¡°)
</span>    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a UTF-8 text file and return its content.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Absolute or relative file path.</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">file_path</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># "strict": True
</span>    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># =========================
# 3) Chat Completions ìª½ í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
# =========================
</span>
<span class="k">def</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">  -&gt; CHAT_STYLE_TOOLS ì‚¬ìš© (ê¶Œì¥)
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS ì‚¬ìš© (ì˜ë„ì  ë¹„í˜¸í™˜ ê°€ëŠ¥)
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">CHAT_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">chat</span><span class="sh">"</span> <span class="k">else</span> <span class="n">RESPONSES_STYLE_TOOLS</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You are a helpful assistant that uses tools when needed.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="c1"># tool_calls ë£¨í”„
</span>    <span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">guard</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">guard</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">fn_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="c1"># argumentsëŠ” ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">)</span>

            <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tool_output</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="p">})</span>

        <span class="c1"># ëŒ€í™” ì´ì–´ë¶™ì´ê¸°
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tc</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 4) Responses ìª½ í•¨ìˆ˜ í˜¸ì¶œ ë£¨í”„
# =========================
</span>
<span class="k">def</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì˜ output ë°°ì—´ì—ì„œ function_call / tool_call ë¥˜ ì´ë²¤íŠ¸ë¥¼ ì¶”ì¶œ.
    ë‹¤ì–‘í•œ ì¼€ì´ìŠ¤ë¥¼ ìµœëŒ€í•œ ê´€ëŒ€í•˜ê²Œ ì²˜ë¦¬í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># ì¼€ì´ìŠ¤ A: item.type == "function_call"
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="p">})</span>

        <span class="c1"># ì¼€ì´ìŠ¤ B: ì¼ë¶€ ëª¨ë¸ì´ "tool_call" / item.message.tool_calls í˜•íƒœë¡œ ì¤„ ë•Œ
</span>        <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inner</span><span class="p">:</span>
                    <span class="n">nm</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{},</span>
                    <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tools_variant: </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="s"> -&gt; RESPONSES_STYLE_TOOLS ì‚¬ìš© (ê¶Œì¥)
    </span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="s">      -&gt; CHAT_STYLE_TOOLS ì‚¬ìš© (ì˜ë„ì  ë¹„í˜¸í™˜ ê°€ëŠ¥)
    ìˆœìˆ˜ Responses ë°©ì‹: ë„¤ê°€ ì¤€ ì˜ˆì‹œ íŒ¨í„´(input_list ì¶•ì  + function_call_output)ë¡œ êµ¬í˜„.
    </span><span class="sh">"""</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="n">RESPONSES_STYLE_TOOLS</span> <span class="k">if</span> <span class="n">tools_variant</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span> <span class="k">else</span> <span class="n">CHAT_STYLE_TOOLS</span>

    <span class="c1"># running input_list
</span>    <span class="n">input_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_task</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># function_call ì²˜ë¦¬
</span>    <span class="n">input_list</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="c1"># callë“¤ì„ ì°¾ì•„ ì‹¤í–‰í•˜ê³ , function_call_outputì„ ì´ì–´ ë¶™ì„
</span>    <span class="n">calls</span> <span class="o">=</span> <span class="nf">_collect_function_calls_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">dispatch_tool</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">input_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function_call_output</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="c1"># ìµœì¢… ì‘ë‹µ ì‹œë„(ì§€ì‹œë¬¸ì„ ì¶”ê°€ì ìœ¼ë¡œ ì¤„ ìˆ˜ë„ ìˆìŒ)
</span>    <span class="n">r2</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">Respond with a short summary of what you found.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">input_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># í…ìŠ¤íŠ¸ ì¶”ì¶œ(ì¤‘ê°„/ìµœì¢…)
</span>    <span class="n">final_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">txt1</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt1</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt1</span><span class="p">)</span>
    <span class="n">txt2</span> <span class="o">=</span> <span class="nf">_collect_text_from_output</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">if</span> <span class="n">txt2</span><span class="p">:</span> <span class="n">final_text</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">txt2</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">final_text</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="c1"># =========================
# 5) 8ê°œ ì¡°í•© ì‹¤í–‰ê¸°
# =========================
</span>
<span class="n">DEFAULT_TASK</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">í…ŒìŠ¤íŠ¸: ./samples í´ë”ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , í…ìŠ¤íŠ¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í•˜ë‚˜ ê³¨ë¼ ë‚´ìš©ì„ ì½ê³  2~3ë¬¸ì¥ ìš”ì•½. í•„ìš”í•˜ë©´ ë„êµ¬ë¥¼ ì‚¬ìš©í•´.</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">api_type</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] model=</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> tools_json=</span><span class="si">{</span><span class="n">tools_variant</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_chat_completions</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nf">run_responses</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_task</span><span class="p">,</span> <span class="n">tools_variant</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_type must be </span><span class="sh">'</span><span class="s">completions</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">responses</span><span class="sh">'"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- OUTPUT ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">(empty)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- ERROR ---</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Run 8 combinations: 2 models Ã— 2 APIs Ã— 2 tools JSON styles.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--task</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TASK</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--models</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--apis</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># tools_variantë¥¼ "both"ë¡œ ë‘ë©´ ê° APIì—ì„œ chat/â€‹responses ë‘ ê°€ì§€ íˆ´ JSON ëª¨ë‘ ì‹œë„ â†’ 8ì¡°í•©
</span>    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--tools</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">both</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># ìƒ˜í”Œ í´ë” ìƒì„± ì•ˆë‚´
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./samples</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">models</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">models</span><span class="p">]</span>
    <span class="n">api_types</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">completions</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">apis</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">apis</span><span class="p">]</span>
    <span class="n">tool_variants</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">chat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">responses</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">tools</span> <span class="o">==</span> <span class="sh">"</span><span class="s">both</span><span class="sh">"</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">tools</span><span class="p">]</span>

    <span class="c1"># 8ì¡°í•©: 2ëª¨ë¸ Ã— 2API Ã— 2JSON
</span>    <span class="k">for</span> <span class="n">mk</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">api_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tool_variants</span><span class="p">:</span>
                <span class="nf">run_one</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">mk</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì‹¤í–‰ ì˜ˆì‹œ<br />
python test_8combos_tools.py<br />
python test_8combos_tools.py â€“apis completions â€“tools both<br />
python test_8combos_tools.py â€“models A â€“apis responses â€“tools responses</p>

<p>í¬ì¸íŠ¸ ìš”ì•½</p>

<ol>
  <li>
    <p>CHAT_STYLE_TOOLSì™€ RESPONSES_STYLE_TOOLSë¥¼ ë¶„ë¦¬í•´ ë‘ì—ˆê³ , Responses ë£¨í”„ëŠ” ë„¤ê°€ ë¶™ì—¬ì¤€ ì˜ˆì‹œì²˜ëŸ¼ input_listì— function_callê³¼ function_call_outputì„ ëˆ„ì í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í–ˆì–´. ì¼ë¶€ ë¬¸ì„œ/ì˜ˆì‹œì—ì„  strictë¥¼ ì¼œ JSON ìŠ¤í‚¤ë§ˆë¥¼ ê°•ì œí•˜ë‹ˆ í•„ìš”í•˜ë©´ í•´ë‹¹ í‚¤ë¥¼ ì¼œë©´ ë¼. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>ì¼ë¶€ ì¡°í•©ì€ ì˜ë„ì ìœ¼ë¡œ í˜¸í™˜ë˜ì§€ ì•Šì•„ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆì–´(ì˜ˆ: Chat Completionsì— Responses ìŠ¤íƒ€ì¼ tools). ëª¨ë“  runì€ try/exceptë¡œ ê°ì‹¸ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ê°€ ì´ì–´ì§„ë‹¤.</p>
  </li>
  <li>
    <p>ìµœì‹  ì°¨ì´ì ê³¼ ê¶Œì¥ íë¦„ì€ Responses vs Chat Completions ê°€ì´ë“œì—ì„œ ë¹„êµ ê°€ëŠ¥í•´. <a href="https://platform.openai.com/docs/guides/responses-vs-chat-completions?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ol>

<p>ë” ì—„ê²©í•˜ê²Œ Responsesì˜ â€œresponse_id + tool_outputsâ€ ë°©ì‹ìœ¼ë¡œ ì´ì–´ë¶™ì´ëŠ” ë²„ì „ë„ ì›í•˜ë©´ ë”°ë¡œ ì¶”ê°€í•´ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">OpenAI MCP</title><link href="https://hvppyarchive.github.io/llm/openai-mcp/" rel="alternate" type="text/html" title="OpenAI MCP" /><published>2025-10-22T15:49:23+09:00</published><updated>2025-10-22T15:49:23+09:00</updated><id>https://hvppyarchive.github.io/llm/openai-mcp</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/openai-mcp/"><![CDATA[<p class="chat--user">

openai packageì—ì„œ responses ì¿¼ë¦¬ìˆì–ì•„

</p>

<p>ë§ì•„ìš”. ìµœì‹  OpenAI Python SDK(íŒ¨í‚¤ì§€ëª…: openai)ì—ëŠ” â€œResponses APIâ€ê°€ ìˆê³ , íŒŒì´ì¬ì—ì„  <code class="language-plaintext highlighter-rouge">client.responses.create(...)</code>ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤. í•µì‹¬ í¬ì¸íŠ¸ë§Œ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.</p>

<ol>
  <li>ê¸°ë³¸ í˜¸ì¶œ<br />
íŒŒì´ì¬ì—ì„œ í•œ ì¤„ ë¬¸ìì—´ ì…ë ¥ì´ë©´ ê°€ì¥ ê°„ë‹¨í•©ë‹ˆë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆë…•! ì˜¤ëŠ˜ ë­í• ê¹Œ?</span><span class="sh">"</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">output_text</span><span class="p">)</span>
</code></pre></div></div>

<p>ì´ ë°©ì‹ê³¼ íŒŒë¼ë¯¸í„°ì˜ ì˜ë¯¸ëŠ” ê³µì‹ ë ˆí¼ëŸ°ìŠ¤ â€œResponses API â†’ createâ€ì— ì •ë¦¬ë¼ ìˆìŠµë‹ˆë‹¤. <a href="https://platform.openai.com/docs/api-reference/responses">OpenAI í”Œë«í¼+1</a></p>

<ol>
  <li>ìŠ¤íŠ¸ë¦¬ë°(í† í° ë‹¨ìœ„ë¡œ ë°›ì•„ë³´ê¸°)<br />
í† í°ì´ ìƒì„±ë  ë•Œë§ˆë‹¤ ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ ì¶œë ¥í•©ë‹ˆë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">í•œ ì¤„ì”© ì‹¤ì‹œê°„ìœ¼ë¡œ ë³´ë‚´ì¤˜.</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">final</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">response.output_text.delta</span><span class="sh">"</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">delta</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">event</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">response.completed</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">final</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">response</span>
<span class="c1"># í•„ìš”í•˜ë©´ finalì— ì™„ë£Œëœ ì „ì²´ ì‘ë‹µ ê°ì²´ê°€ ë“¤ì–´ìˆìŒ
</span></code></pre></div></div>

<p>ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ íƒ€ì…ê³¼ ì‚¬ìš© ì˜ˆì‹œëŠ” ê³µì‹ ë¬¸ì„œì— ë‚˜ì˜µë‹ˆë‹¤. <a href="https://platform.openai.com/docs/api-reference/responses">OpenAI í”Œë«í¼</a></p>

<ol>
  <li>ì—¬ëŸ¬ ë©”ì‹œì§€(ì—­í• Â·ì»¨í…ìŠ¤íŠ¸) ë„£ê¸°<br />
ê°„ë‹¨íˆëŠ” ë¬¸ìì—´ í•˜ë‚˜ì§€ë§Œ, ëŒ€í™” ë§¥ë½ì„ ì£¼ê³  ì‹¶ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">input</code>ì— ë¦¬ìŠ¤íŠ¸ë¡œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë„ˆëŠ” ê°„ê²°í•˜ê²Œ ë‹µí•˜ëŠ” í•œêµ­ì–´ ë„ìš°ë¯¸ì•¼.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Responses APIë¡œ ìŠ¤íŠ¸ë¦¬ë°ì€ ì–´ë–»ê²Œ í•´?</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">output_text</span><span class="p">)</span>
</code></pre></div></div>

<p>ì—­í•  ê¸°ë°˜ ì…ë ¥ì„ <code class="language-plaintext highlighter-rouge">input</code> ë°°ì—´ë¡œ ì£¼ëŠ” í¬ë§·ì€ Responses API ë ˆí¼ëŸ°ìŠ¤ì— ëª…ì‹œë¼ ìˆìŠµë‹ˆë‹¤. <a href="https://platform.openai.com/docs/api-reference/responses">OpenAI í”Œë«í¼</a></p>

<ol>
  <li>í•¨ìˆ˜ í˜¸ì¶œ(íˆ´ í˜¸ì¶œ)<br />
ì™¸ë¶€ í•¨ìˆ˜ë¥¼ ìŠ¤í‚¤ë§ˆë¡œ ì„ ì–¸í•´ ëª¨ë¸ì´ í•„ìš”í•  ë•Œ í˜¸ì¶œí•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">get_weather</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë„ì‹œ í˜„ì¬ ë‚ ì”¨ ì¡°íšŒ</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">ì„œìš¸ ë‚ ì”¨ ì•Œë ¤ì¤˜.</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
    <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># resp.output[0] ì•ˆì˜ tool_call(ë˜ëŠ” ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸)ë¡œ í•¨ìˆ˜ ì¸ì í™•ì¸ í›„ ì§ì ‘ ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— í”¼ë“œë°±
</span></code></pre></div></div>

<p>íˆ´(í•¨ìˆ˜) ìŠ¤í‚¤ë§ˆì™€ ë™ì‘ì€ Responses API ë¬¸ì„œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://platform.openai.com/docs/api-reference/responses">OpenAI í”Œë«í¼</a></p>

<ol>
  <li>ê¸°íƒ€ íŒ</li>
</ol>

<ul>
  <li>
    <p>ì‘ë‹µ ê°ì²´ëŠ” IDë¥¼ ê°€ì§€ë©°, í•„ìš” ì‹œ ì¡°íšŒ(ë˜ëŠ” ì·¨ì†Œ) ì—”ë“œí¬ì¸íŠ¸ë¡œ ìƒíƒœë¥¼ ë‹¤ë£° ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://platform.openai.com/docs/api-reference/responses">OpenAI í”Œë«í¼</a></p>
  </li>
  <li>
    <p>ìµœì‹  SDKì™€ ì˜ˆì œë“¤ì€ GitHub ë ˆí¬ì—ì„œë„ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤(ë™ì¼ APIì— ë§ì¶˜ ì½”ë“œ ìŠ¤íƒ€ì¼). <a href="https://github.com/openai/openai-python?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p>ë¹ ë¥´ê²Œ ì „ì²´ íë¦„ì„ ë³´ê³  ì‹¶ìœ¼ë©´ Quickstartì˜ Responses ëª¨ë“œê°€ ë„ì›€ì´ ë©ë‹ˆë‹¤. <a href="https://platform.openai.com/docs/quickstart?api-mode=responses&amp;utm_source=chatgpt.com">OpenAI í”Œë«í¼</a></p>
  </li>
</ul>

<p>ì›í•˜ì‹œëŠ” ê²Œ â€œë¬¸ë²•ë§Œ í™•ì¸â€ì¸ì§€, â€œìŠ¤íŠ¸ë¦¬ë°Â·íˆ´ í˜¸ì¶œ í¬í•¨í•´ì„œ ì‹¤ì „ ìŠ¤ë‹ˆí« ë§Œë“¤ê¸°â€ì¸ì§€ ì•Œë ¤ì£¼ì‹œë©´ ê±°ê¸°ì— ë§ì¶° ë°”ë¡œ ì½”ë“œ í‹€ì„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

chat completionì—ë„ toolì´ ìˆì—ˆëŠ”ë° ì°¨ì´ì 

</p>

<p>ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. í•œë§ˆë””ë¡œ ìš”ì•½í•˜ë©´, Chat Completionsì˜ toolì€ â€œí•¨ìˆ˜ í˜¸ì¶œë§Œâ€ ê¹”ë”íˆ ë¶™ì´ëŠ” ì „í†µ ë°©ì‹ì´ê³ , Responsesì˜ toolì€ ê·¸ ìœ„ì— â€œë¹ŒíŠ¸ì¸ ë„êµ¬(ì½”ë“œ ì‹¤í–‰, íŒŒì¼/ì›¹ ê²€ìƒ‰, ì´ë¯¸ì§€ ìƒì„± ë“±) + ë” ìœ ì—°í•œ ìŠ¤íŠ¸ë¦¬ë°/ì¶œë ¥ ì ‘ê·¼â€ê¹Œì§€ ì–¹ì€ í†µí•© ì„¤ê³„ì…ë‹ˆë‹¤. ì°¨ì´ë¥¼ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.</p>

<ol>
  <li>
    <p>ì² í•™ê³¼ ë²”ìœ„<br />
Chat Completions: ëŒ€í™” ë©”ì‹œì§€ ë°°ì—´ì„ ì…ë ¥í•˜ê³ , ë„êµ¬(tool=functions)ë¡œ ì™¸ë¶€ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹¬í”Œí•œ íŒ¨í„´ì— ì´ˆì . ì§€ê¸ˆë„ ê³„ì† ì§€ì›ë©ë‹ˆë‹¤. <a href="https://platform.openai.com/docs/api-reference/chat?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a><br />
Responses: â€œì—ì´ì „í‹±â€ ì›Œí¬í”Œë¡œìš°ë¥¼ í•œ í˜¸ì¶œì— ë‹´ê¸° ìœ„í•´ ì„¤ê³„. í•¨ìˆ˜ í˜¸ì¶œì€ ë¬¼ë¡ ì´ê³ , ì›¹/íŒŒì¼ ê²€ìƒ‰, ì´ë¯¸ì§€ ìƒì„±, ì½”ë“œ ì‹¤í–‰ ê°™ì€ ë¹ŒíŠ¸ì¸ íˆ´ì„ ëª¨ë¸ì´ í•„ìš”í•  ë•Œ ì¡°í•©í•´ ì“°ë„ë¡ ì§€ì›í•©ë‹ˆë‹¤. ë˜í•œ SDKì—ì„œ <code class="language-plaintext highlighter-rouge">response.output_text</code> ê°™ì€ í—¬í¼ë¡œ ê²°ê³¼ ì ‘ê·¼ì´ ë‹¨ìˆœí™”ëìŠµë‹ˆë‹¤. <a href="https://openai.com/index/new-tools-for-building-agents/?utm_source=chatgpt.com">OpenAI+2</a></p>
  </li>
  <li>
    <p>ì§€ì› ë„êµ¬(íˆ´) ì¢…ë¥˜<br />
Chat Completions: íˆ´ ëª©ë¡ì— â€œfunctionsâ€ë§Œ ì •ì˜í•˜ê³ , ëª¨ë¸ì´ JSON ì¸ìë¥¼ ì±„ì›Œì¤ë‹ˆë‹¤. ë³‘ë ¬ í˜¸ì¶œ, <code class="language-plaintext highlighter-rouge">tool_choice</code> ê°•ì œ ê°™ì€ ì˜µì…˜ì„ í•¨ê»˜ ì‚¬ìš©í•©ë‹ˆë‹¤. <a href="https://platform.openai.com/docs/api-reference/chat?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a><br />
Responses: ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ í˜¸ì¶œì€ ê¸°ë³¸ì´ê³ , ì—¬ê¸°ì— Code Interpreter, íŒŒì¼ ê²€ìƒ‰, ì´ë¯¸ì§€ ìƒì„±, MCP ì„œë²„ ì—°ë™ ë“± â€œë¹ŒíŠ¸ì¸ íˆ´â€ì„ ê³µì‹ì ìœ¼ë¡œ ë¶™ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://openai.com/index/new-tools-and-features-in-the-responses-api/?utm_source=chatgpt.com">OpenAI+1</a></p>
  </li>
  <li>
    <p>ì…ë ¥/ì¶œë ¥ ëª¨ë¸<br />
Chat Completions: í•­ìƒ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸(messages) ìŠ¤í‚¤ë§ˆ. í•¨ìˆ˜ ë°˜í™˜ì„ â€œtoolâ€ ì—­í•  ë©”ì‹œì§€ë¡œ ë‹¤ì‹œ ë„£ì–´ ì´ì–´ê°€ê¸°. <a href="https://platform.openai.com/docs/api-reference/chat?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a><br />
Responses: ì…ë ¥ì´ ë¬¸ìì—´Â·ë©”ì‹œì§€ ë°°ì—´ ëª¨ë‘ ê°€ëŠ¥í•˜ê³ , ì¶œë ¥ì€ ì´ë²¤íŠ¸ ê¸°ë°˜ ìŠ¤íŠ¸ë¦¬ë°ê³¼ â€œì•„ì´í…œâ€ ë‹¨ìœ„ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. SDKëŠ” <code class="language-plaintext highlighter-rouge">response.output_text</code> ë“± í†µì¼ëœ ì ‘ê·¼ê¸°ë¥¼ ì œê³µí•©ë‹ˆë‹¤. <a href="https://github.com/openai/openai-python?utm_source=chatgpt.com">GitHub+1</a></p>
  </li>
  <li>
    <p>ìŠ¤íŠ¸ë¦¬ë°ê³¼ ì´ë²¤íŠ¸<br />
Chat Completions: ì„œë²„ì„¼íŠ¸ ì´ë²¤íŠ¸(SSE)ë¡œ í† í° ìŠ¤íŠ¸ë¦¬ë°. ë„êµ¬ í˜¸ì¶œ ì‹ í˜¸ë„ ë©”ì‹œì§€ë¡œ í‘œí˜„. <a href="https://platform.openai.com/docs/api-reference/chat?utm_source=chatgpt.com">OpenAI í”Œë«í¼</a><br />
Responses: ì„¸ë¶„í™”ëœ ì´ë²¤íŠ¸ íƒ€ì…ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë¸íƒ€, íˆ´ í˜¸ì¶œ/ì¶œë ¥, ì™„ë£Œ ë“±ì„ êµ¬ë¶„í•´ ë°›ìŠµë‹ˆë‹¤. ë³µìˆ˜ íˆ´ì„ ì˜¤ê°€ë©° ì‘ì—…í•˜ëŠ” íë¦„ì„ í‘œì¤€í™”í–ˆìŠµë‹ˆë‹¤. <a href="https://openai.com/index/new-tools-for-building-agents/?utm_source=chatgpt.com">OpenAI+1</a></p>
  </li>
  <li>
    <p>ìŠ¤í‚¤ë§ˆ ì°¨ì´(íˆ´ ì •ì˜)<br />
Chat Completions ì˜ˆì‹œ:<br />
tools=[{"type":"function","function":{"name":"get_weather","parameters":{â€¦}}}] ì²˜ëŸ¼ í•¨ìˆ˜ê°€ function í‚¤ ì•„ë˜ì— ë“¤ì–´ê°‘ë‹ˆë‹¤. <a href="https://platform.openai.com/docs/api-reference/chat?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a><br />
Responses ì˜ˆì‹œ:<br />
ìµœì‹  SDK/ìŠ¤í™ì—ì„œëŠ” ë¹ŒíŠ¸ì¸ íˆ´ê³¼ì˜ ì¼ê´€ì„±ì„ ìœ„í•´ íˆ´ ì •ì˜ ë°©ì‹ê³¼ ì´ë²¤íŠ¸ êµ¬ì¡°ê°€ í†µí•©ë˜ì–´ ìˆê³ , SDK ë ˆë²¨ì—ì„œ ë‹¨ì¼ <code class="language-plaintext highlighter-rouge">responses.create(...)</code> í˜¸ì¶œë¡œ ë‹¤ë£¹ë‹ˆë‹¤. êµ¬í˜„ ë””í…Œì¼ì€ ë²„ì „ì— ë”°ë¼ ì¡°ê¸ˆì”© ë°”ë€Œë¯€ë¡œ ë ˆí¼ëŸ°ìŠ¤ë¥¼ í™•ì¸í•˜ëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤. <a href="https://github.com/openai/openai-python?utm_source=chatgpt.com">GitHub+1</a></p>
  </li>
  <li>
    <p>ì–¸ì œ ë¬´ì—‡ì„ ì“°ë‚˜<br />
ì´ë¯¸ Chat Completionsë¡œ í•¨ìˆ˜ í˜¸ì¶œë§Œ í•„ìš”í•œ ë´‡ì„ ì•ˆì •ì ìœ¼ë¡œ ìš´ì˜ ì¤‘ì´ë©´ ê·¸ëŒ€ë¡œ ì¨ë„ ë©ë‹ˆë‹¤. ë³µí•© íˆ´(ì½”ë“œ ì‹¤í–‰, íŒŒì¼/ì›¹ ê²€ìƒ‰, ì´ë¯¸ì§€ ìƒì„± ë“±)ì„ ëª¨ë¸ì´ ììœ¨ì ìœ¼ë¡œ ì„ì–´ ì“°ëŠ” â€œì‘ì—…í˜•â€ ì—ì´ì „íŠ¸ë¥¼ ë§Œë“¤ë ¤ë©´ Responsesê°€ ë” í¸í•˜ê³  ì„¤ê³„ê°€ ë§ìŠµë‹ˆë‹¤. <a href="https://openai.com/index/new-tools-for-building-agents/?utm_source=chatgpt.com">OpenAI</a></p>
  </li>
  <li>
    <p>ë§ˆì´ê·¸ë ˆì´ì…˜ ê³ ë ¤ì‚¬í•­<br />
ë©”ì‹œì§€ í¬ë§· ì°¨ì´, íˆ´ ì •ì˜ ìœ„ì¹˜/ëª…ì„¸, ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ ì²˜ë¦¬, ê·¸ë¦¬ê³  í•¨ìˆ˜ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì—ê²Œ í”¼ë“œë°±í•˜ëŠ” ë£¨í”„ ì²˜ë¦¬ë§Œ ë§ì¶”ë©´ ë©ë‹ˆë‹¤. ResponsesëŠ” SDK í—¬í¼ì™€ ë¹ŒíŠ¸ì¸ íˆ´ ë•ì— ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ê°€ ì¤„ì–´ë“­ë‹ˆë‹¤. <a href="https://github.com/openai/openai-python?utm_source=chatgpt.com">GitHub+1</a></p>
  </li>
</ol>

<p>ì›í•˜ì‹œë©´ ê°™ì€ ê¸°ëŠ¥ì„ Chat Completionsì™€ Responsesë¡œ ê°ê° êµ¬í˜„í•œ ìµœì†Œ ì˜ˆì œ(í•¨ìˆ˜ ì •ì˜ â†’ í˜¸ì¶œ â†’ ê²°ê³¼ ë°˜ì˜ â†’ ìµœì¢… ì‘ë‹µ)ë¥¼ ë‚˜ë€íˆ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì•„ì§ë„ ì°¨ì´ë¥¼ ì˜ ëª¨ë¥´ê² ëŠ”ë° chat completionsë„ íŒŒì¼ íƒìƒ‰ ê°™ì€ê±° ê°€ëŠ¥í•œê±° ì•„ë‹ˆì•¼?

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸ë¥¼ ì§šìœ¼ì…¨ì–´ìš”. í˜¼ë™ì´ ìƒê¸°ê¸° ì‰¬ìš´ ë¶€ë¶„ì¸ë°, í•µì‹¬ ì°¨ì´ëŠ” ì´ê²ë‹ˆë‹¤:</p>

<h3 id="1-chat-completionsì—ì„œì˜-tool">1. Chat Completionsì—ì„œì˜ tool</h3>

<ul>
  <li>
    <p>Chat Completions APIëŠ” <strong>â€œfunction callingâ€</strong> ê°œë…ë§Œ ì œê³µí•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¦‰, ê°œë°œìê°€ ì •ì˜í•œ <strong>ì™¸ë¶€ í•¨ìˆ˜(íˆ´)</strong> ì˜ JSON ìŠ¤í‚¤ë§ˆë¥¼ ëª¨ë¸ì—ê²Œ ì•Œë ¤ì£¼ë©´, ëª¨ë¸ì´ í•„ìš”í•  ë•Œ <code class="language-plaintext highlighter-rouge">{"name": "...", "arguments": {...}}</code> í˜•íƒœë¡œ í˜¸ì¶œ ì œì•ˆì„ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê·¸ ê²°ê³¼ë¥¼ ë°›ì•„ì„œ <strong>ê°œë°œì(í˜¸ìŠ¤íŠ¸ ì•±)ê°€ ì§ì ‘ ì‹¤í–‰</strong> í•´ì•¼ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë¸ì€ íŒŒì¼ì„ ì§ì ‘ ì½ê±°ë‚˜ ì›¹ì„ íƒìƒ‰í•˜ì§€ ëª»í•©ë‹ˆë‹¤. ê°œë°œìê°€ êµ¬í˜„í•´ì•¼ë§Œ í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<h3 id="2-responses-apiì—ì„œì˜-tool">2. Responses APIì—ì„œì˜ tool</h3>

<ul>
  <li>
    <p>Responses APIëŠ” ìœ„ì˜ í•¨ìˆ˜ í˜¸ì¶œ ê¸°ëŠ¥ì„ í¬í•¨í•˜ë©´ì„œ, ì—¬ê¸°ì— <strong>â€œë¹ŒíŠ¸ì¸ íˆ´â€</strong> ê°œë…ì´ ë“¤ì–´ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì˜ˆì‹œ: Code Interpreter(ì½”ë“œ ì‹¤í–‰), File Search(ë²¡í„° DB/ê²€ìƒ‰), Web Search, Image generation ê°™ì€ ë„êµ¬ë“¤ì´ ê³µì‹ ì§€ì›ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¦‰, ëª¨ë¸ì´ <code class="language-plaintext highlighter-rouge">file_search.query</code> ê°™ì€ íˆ´ì„ ì§ì ‘ í˜¸ì¶œí•˜ë©´, OpenAI í”Œë«í¼ì´ ê·¸ ê²°ê³¼ë¥¼ ëª¨ë¸ ì»¨í…ìŠ¤íŠ¸ì— ë°”ë¡œ ë„£ì–´ì£¼ëŠ” êµ¬ì¡°ì˜ˆìš”.</p>
  </li>
  <li>
    <p>ê°œë°œìê°€ ëª¨ë“  ê¸°ëŠ¥ì„ ì§ì ‘ ì§œì§€ ì•Šì•„ë„ ë˜ê³ , ì—¬ëŸ¬ íˆ´ì„ í˜¼í•©í•˜ëŠ” â€œì—ì´ì „íŠ¸ì  ì›Œí¬í”Œë¡œìš°â€ë¥¼ ë°”ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<h3 id="3-ì‹¤ì œ-ì°¨ì´ë¥¼-ì˜ˆë¡œ-ë³´ë©´">3. ì‹¤ì œ ì°¨ì´ë¥¼ ì˜ˆë¡œ ë³´ë©´</h3>

<ul>
  <li>
    <p><strong>Chat Completions</strong></p>

    <ul>
      <li>
        <p>ìœ ì €: â€œë‚´ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ í”„ë¡œì íŠ¸ ë¬¸ì„œ ì°¾ì•„ì¤˜.â€</p>
      </li>
      <li>
        <p>ëª¨ë¸: â€œ<code class="language-plaintext highlighter-rouge">search_drive</code> í•¨ìˆ˜ í˜¸ì¶œ í•„ìš”. ì¸ì: {query: 'í”„ë¡œì íŠ¸'}â€</p>
      </li>
      <li>
        <p>â†’ ì´ë•Œ <strong>ë“œë¼ì´ë¸Œ ê²€ìƒ‰ ì½”ë“œë¥¼ ì§œì„œ ì§ì ‘ ì‹¤í–‰</strong> í•´ì•¼ í•˜ê³ , ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— ë„£ì–´ì¤˜ì•¼ í•©ë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Responses</strong></p>

    <ul>
      <li>
        <p>ìœ ì €: â€œë‚´ í”„ë¡œì íŠ¸ ë¬¸ì„œ ì°¾ì•„ì¤˜.â€</p>
      </li>
      <li>
        <p>ëª¨ë¸: <code class="language-plaintext highlighter-rouge">file_search.query</code> ë¹ŒíŠ¸ì¸ íˆ´ì„ í˜¸ì¶œ.</p>
      </li>
      <li>
        <p>â†’ OpenAI SDKê°€ <strong>ìë™ìœ¼ë¡œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ëª¨ë¸ì—ê²Œ ë‹¤ì‹œ í”¼ë“œë°±</strong> í•©ë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>ê°œë°œìê°€ í•  ì¼ì€ ê²°ê³¼ë¥¼ UIì— ë¿Œë¦¬ê±°ë‚˜ í›„ì²˜ë¦¬í•˜ëŠ” ê²ƒë¿ì…ë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="4-ì •ë¦¬">4. ì •ë¦¬</h3>

<ul>
  <li>
    <p>Chat Completions = <strong>ëª¨ë¸ì´ â€œì´ í•¨ìˆ˜ ë¶ˆëŸ¬ì¤˜â€ ì‹ í˜¸ë§Œ ì£¼ê³ , ì‹¤í–‰ì€ ì „ì ìœ¼ë¡œ ê°œë°œì ëª«.</strong></p>
  </li>
  <li>
    <p>Responses = <strong>ëª¨ë¸ì´ ë¹ŒíŠ¸ì¸ íˆ´ê¹Œì§€ ì§ì ‘ ì œì–´ ê°€ëŠ¥. ì™¸ë¶€ í•¨ìˆ˜ë„ ì •ì˜ ê°€ëŠ¥í•˜ì§€ë§Œ, ê¸°ë³¸ì ìœ¼ë¡œ í”Œë«í¼ì´ ì‹¤í–‰/í”¼ë“œë°±ì„ ë‹¤ ì²˜ë¦¬.</strong></p>
  </li>
</ul>

<p>ì¦‰, Chat Completionsë§Œìœ¼ë¡œëŠ” <strong>íŒŒì¼ íƒìƒ‰, ì›¹ ê²€ìƒ‰ ê°™ì€ ê±´ ì§ì ‘ êµ¬í˜„í•´ì•¼</strong> í•˜ê³ , Responsesì—ì„œëŠ” <strong>OpenAIê°€ ì œê³µí•˜ëŠ” í‘œì¤€ íˆ´ì„ ê³§ë°”ë¡œ ë¶™ì—¬ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤</strong> ëŠ” ì ì´ ê°€ì¥ í° ì°¨ì´ì…ë‹ˆë‹¤.</p>

<p>í˜¹ì‹œ ì›í•˜ì‹œë©´ ì œê°€ â€œê°™ì€ ê¸°ëŠ¥(ì˜ˆ: íŒŒì¼ ê²€ìƒ‰)â€ì„ <strong>Chat Completions ë°©ì‹</strong> ê³¼ <strong>Responses ë°©ì‹</strong> ìœ¼ë¡œ ê°ê° ì–´ë–»ê²Œ êµ¬í˜„í•˜ëŠ”ì§€ ì½”ë“œ ë¹„êµ ì˜ˆì œë¥¼ ë§Œë“¤ì–´ ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

ë‚´ê°€ ì§ì ‘ íˆ´ í•¨ìˆ˜ë¥¼ ì„ ì–¸í•´ì„œ í•œë‹¤ë©´ ì–´ë–¤ ì°¨ì´ê°€ ìˆì–´?

</p>

<p>ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”.<br />
â€œë‚´ê°€ ì§ì ‘ íˆ´(í•¨ìˆ˜)ì„ ì„ ì–¸í•œë‹¤â€ëŠ” ìƒí™©ë§Œ ë”± ë†“ê³  ë³´ë©´, Chat Completionsê³¼ ResponsesëŠ” <strong>ê¸°ë³¸ ë™ì‘ì€ ê±°ì˜ ë˜‘ê°™ìŠµë‹ˆë‹¤</strong>. ëª¨ë¸ì´ í•¨ìˆ˜ í˜¸ì¶œ JSONì„ ë§Œë“¤ì–´ì£¼ê³ , ê·¸ê±¸ ì•±(ê°œë°œì)ì´ ì‹¤í–‰í•´ì„œ ë‹¤ì‹œ ëª¨ë¸ì— ê²°ê³¼ë¥¼ ë„˜ê²¨ì£¼ëŠ” êµ¬ì¡°ì£ . í•˜ì§€ë§Œ ì°¨ì´ê°€ ë‚˜ëŠ” ë¶€ë¶„ì´ ëª‡ ê°€ì§€ ìˆì–´ìš”:</p>

<hr />

<h3 id="1-ì…ë ¥-êµ¬ì¡°-ì°¨ì´">1. ì…ë ¥ êµ¬ì¡° ì°¨ì´</h3>

<ul>
  <li>
    <p><strong>Chat Completions</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">messages=[{"role":"system",...}, {"role":"user",...}]</code> ë°°ì—´ í˜•íƒœ ê³ ì •.</p>
      </li>
      <li>
        <p>íˆ´ ì •ì˜ëŠ” <code class="language-plaintext highlighter-rouge">tools=[{"type":"function", "function":{...}}]</code> ë¡œ ë³„ë„ í•„ë“œì— ë„£ìŠµë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Responses</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">input</code> íŒŒë¼ë¯¸í„°ê°€ ë¬¸ìì—´Â·ë©”ì‹œì§€ ë°°ì—´ ë‘˜ ë‹¤ í—ˆìš©.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">tools</code> ì—­ì‹œ Chat Completionsê³¼ ê±°ì˜ ë™ì¼í•˜ê²Œ ì„ ì–¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>SDKì—ì„œ <code class="language-plaintext highlighter-rouge">response.output_text</code> ê°™ì€ í—¬í¼ê°€ ìˆì–´ì„œ ì¶œë ¥ í•¸ë“¤ë§ì´ ë” ë‹¨ìˆœí•©ë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h3 id="2-ì‹¤í–‰-ë£¨í”„-ì²˜ë¦¬">2. ì‹¤í–‰ ë£¨í”„ ì²˜ë¦¬</h3>

<ul>
  <li>
    <p><strong>Chat Completions</strong></p>

    <ul>
      <li>
        <p>í•¨ìˆ˜ í˜¸ì¶œì´ ë‚˜ì˜¤ë©´, <code class="language-plaintext highlighter-rouge">message.role=="assistant", message.content==null, message.tool_calls=[...]</code> ê°™ì€ í¬ë§·ìœ¼ë¡œ ì˜µë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>ê°œë°œìê°€ ì§ì ‘ <code class="language-plaintext highlighter-rouge">call_tool()</code> â†’ <code class="language-plaintext highlighter-rouge">append result ë©”ì‹œì§€</code> â†’ ë‹¤ì‹œ <code class="language-plaintext highlighter-rouge">chat.completions.create(...)</code> ë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Responses</strong></p>

    <ul>
      <li>
        <p>ë˜‘ê°™ì´ í•¨ìˆ˜ í˜¸ì¶œ JSONì´ ë‚˜ì˜¤ê³ , ì—­ì‹œ ê°œë°œìê°€ ì‹¤í–‰í•´ì„œ ë‹¤ì‹œ ëª¨ë¸ì— ì£¼ì…í•´ì•¼ í•©ë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>ë‹¤ë§Œ ResponsesëŠ” <strong>ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° êµ¬ì¡°</strong> ê°€ ë” ì„¸ë¶„í™”ë˜ì–´ ìˆì–´ì„œ, â€œì§€ê¸ˆ íˆ´ í˜¸ì¶œ ë‚˜ì™”ë‹¤ â†’ ì‹¤í–‰ ê²°ê³¼ ë³´ë‚´ë¼â€ íë¦„ì´ ëª…í™•í•©ë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h3 id="3-ë¹ŒíŠ¸ì¸-íˆ´ê³¼ì˜-í†µí•©">3. ë¹ŒíŠ¸ì¸ íˆ´ê³¼ì˜ í†µí•©</h3>

<ul>
  <li>
    <p><strong>Chat Completions</strong></p>

    <ul>
      <li>
        <p>í•­ìƒ ë‚´ê°€ ì •ì˜í•œ í•¨ìˆ˜ë§Œ ì‚¬ìš©.</p>
      </li>
      <li>
        <p>íŒŒì¼ ê²€ìƒ‰/ì›¹ ê²€ìƒ‰ ë“±ì„ ë¶™ì´ë ¤ë©´, ì „ë¶€ ë‚´ê°€ ì§ì ‘ êµ¬í˜„í•´ì•¼ í•¨.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Responses</strong></p>

    <ul>
      <li>
        <p>ë‚´ê°€ ì •ì˜í•œ íˆ´(function)ê³¼, OpenAIê°€ ì œê³µí•˜ëŠ” ë¹ŒíŠ¸ì¸ íˆ´(ì½”ë“œ ì‹¤í–‰, íŒŒì¼ ê²€ìƒ‰, ì´ë¯¸ì§€ ìƒì„± ë“±)ì„ <strong>ê°™ì€ ì¸í„°í˜ì´ìŠ¤ ì•ˆì—ì„œ</strong> í˜¼í•© ê°€ëŠ¥.</p>
      </li>
      <li>
        <p>ì¦‰, â€œë‚´ í•¨ìˆ˜ + ê¸°ë³¸ ì œê³µ íˆ´â€ì„ í•˜ë‚˜ì˜ ë„êµ¬ ì„¸íŠ¸ì²˜ëŸ¼ ëª¨ë¸ì´ ì˜¤ê°€ë©° ì‚¬ìš© ê°€ëŠ¥.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h3 id="4-sdk-ì‚¬ìš©ì„±">4. SDK ì‚¬ìš©ì„±</h3>

<ul>
  <li>
    <p><strong>Chat Completions</strong> : ì¶œë ¥ íŒŒì‹±ì€ ë‚´ê°€ ì§ì ‘ <code class="language-plaintext highlighter-rouge">choices[0].message.tool_calls</code> ê°™ì€ ê±¸ ë´ì•¼ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>Responses</strong> : ì¶œë ¥ì€ <code class="language-plaintext highlighter-rouge">resp.output_text</code> ë˜ëŠ” ì´ë²¤íŠ¸ íƒ€ì…(event.type=="response.output_text.delta") ê°™ì€ í†µì¼ëœ í—¬í¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<h3 id="5-ì •ë¦¬">5. ì •ë¦¬</h3>

<ul>
  <li>
    <p>ë‚´ê°€ <strong>íˆ´ë§Œ ì§ì ‘ ì„ ì–¸</strong> í•œë‹¤ë©´, ë‘ APIì˜ ì°¨ì´ëŠ” <strong>ì…ë ¥/ì¶œë ¥ í¬ë§·ê³¼ SDK í—¬í¼ ìˆ˜ì¤€</strong> ì—ì„œë§Œ ëŠê»´ì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í•˜ì§€ë§Œ Responses ìª½ì€ <strong>ë¹ŒíŠ¸ì¸ íˆ´ í†µí•©</strong> ê³¼ <strong>ì„¸ë¶„í™”ëœ ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸</strong> ë•ì—, ë‚˜ì¤‘ì— ë³µì¡í•œ ì›Œí¬í”Œë¡œìš°ë¥¼ ë¶™ì´ê¸°ê°€ ë” ì‰½ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë‹¨ìˆœ í•¨ìˆ˜ í˜¸ì¶œë§Œ ì“´ë‹¤ë©´ Chat Completionsë„ ì¶©ë¶„íˆ ì“¸ ìˆ˜ ìˆê³ , ResponsesëŠ” â€œí•¨ìˆ˜ + í™•ì¥ì„±â€ì„ ê³ ë ¤í•  ë•Œ ì„ íƒí•˜ëŠ” ê²Œ ì¢‹ì•„ìš”.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ ì œê°€ â€œê°™ì€ í•¨ìˆ˜ íˆ´ í˜¸ì¶œâ€ì„ Chat Completions ë²„ì „ê³¼ Responses ë²„ì „ìœ¼ë¡œ ì½”ë“œ ì˜ˆì œë¥¼ ë‚˜ë€íˆ ë§Œë“¤ì–´ì„œ ë³´ì—¬ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

harmony í˜•ì‹ì„ ì“°ëŠ” gpt ossëŠ” chat completions íˆ´ì€ ëª»ì“°ë‚˜? ê´€ê³„ê°€ ìˆì–´?

</p>

<p>ì•„ì£¼ ì¤‘ìš”í•œ í¬ì¸íŠ¸ë¥¼ ì§šìœ¼ì…¨ì–´ìš”. ì •ë¦¬í•´ë³´ë©´ ì´ë ‡ê²Œ ì´í•´í•˜ì‹œë©´ ë©ë‹ˆë‹¤:</p>

<hr />

<h3 id="1-harmony-í¬ë§·ì´ë€">1. Harmony í¬ë§·ì´ë€?</h3>

<ul>
  <li>
    <p><strong>Harmony</strong> ëŠ” OpenAIê°€ ë‚´ë¶€ì ìœ¼ë¡œ í†µí•©í•˜ë ¤ëŠ” <strong>ëŒ€í™”/íˆ´ í˜¸ì¶œ ë°ì´í„° í¬ë§·</strong> ì´ì—ìš”.</p>
  </li>
  <li>
    <p>JSON ê¸°ë°˜ìœ¼ë¡œ, <code class="language-plaintext highlighter-rouge">role</code>, <code class="language-plaintext highlighter-rouge">content</code>, <code class="language-plaintext highlighter-rouge">tool</code> í˜¸ì¶œ ë“±ì„ í•˜ë‚˜ì˜ ì¼ê´€ëœ êµ¬ì¡°ë¡œ í‘œí˜„í•˜ë ¤ê³  ë§Œë“  ìŠ¤í™ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Responses APIëŠ” ì´ Harmony ìŠ¤íƒ€ì¼ì„ ë”°ë¦…ë‹ˆë‹¤. ê·¸ë˜ì„œ Responsesì˜ ì¶œë ¥/ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ëŠ” Harmony ê·œê²©ê³¼ ì§ì ‘ì ìœ¼ë¡œ ë§¤í•‘ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h3 id="2-chat-completionsì™€ì˜-ê´€ê³„">2. Chat Completionsì™€ì˜ ê´€ê³„</h3>

<ul>
  <li>
    <p><strong>Chat Completions</strong> APIëŠ” ì›ë˜ë¶€í„° OpenAIê°€ ë§Œë“  â€œë©”ì‹œì§€ ë°°ì—´ + function callingâ€ ë°©ì‹ì´ê³ , Harmonyê°€ ë‚˜ì˜¤ê¸° ì „ í¬ë§·ì´ì—ìš”.</p>
  </li>
  <li>
    <p>Chat Completionsì˜ <code class="language-plaintext highlighter-rouge">tools</code>/<code class="language-plaintext highlighter-rouge">functions</code> í•„ë“œëŠ” Harmony í¬ë§·ê³¼ <strong>ì§ì ‘ í˜¸í™˜ë˜ì§„ ì•ŠìŠµë‹ˆë‹¤.</strong> (ë¹„ìŠ·í•˜ê²Œ ë³´ì´ì§€ë§Œ JSON ìŠ¤í‚¤ë§ˆ ì •ì˜ì™€ ì¶œë ¥ êµ¬ì¡°ê°€ ë‹¤ë¦„)</p>
  </li>
  <li>
    <p>ë‹¤ë§Œ ê°œë…ì ìœ¼ë¡œëŠ” ê°™ì€ ì¼ì„ í•©ë‹ˆë‹¤: ëª¨ë¸ì´ â€œíˆ´ í˜¸ì¶œâ€ì„ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê³ , ê°œë°œìê°€ ê·¸ê±¸ ì‹¤í–‰í•´ì„œ ë‹¤ì‹œ ëª¨ë¸ì— ë„£ëŠ” êµ¬ì¡°.</p>
  </li>
</ul>

<hr />

<h3 id="3-gpt-ì˜¤í”ˆì†ŒìŠ¤-ëª¨ë¸ossì™€-harmony">3. GPT ì˜¤í”ˆì†ŒìŠ¤ ëª¨ë¸(OSS)ì™€ Harmony</h3>

<ul>
  <li>
    <p>OSS GPTë¥˜ ëª¨ë¸ ì¤‘ì— â€œHarmony í¬ë§·â€ìœ¼ë¡œ í•™ìŠµë˜ê±°ë‚˜ ì‹œì—°ë˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. ì¦‰, ë©”ì‹œì§€ë‚˜ íˆ´ í˜¸ì¶œì„ <strong>Harmony ê·œê²© JSON</strong> ìœ¼ë¡œ ì´í•´í•˜ê³  ì¶œë ¥í•˜ëŠ” ê±°ì£ .</p>
  </li>
  <li>
    <p>ì´ ê²½ìš° Chat Completions APIì˜ <code class="language-plaintext highlighter-rouge">tools/functions</code>ëŠ” ê·¸ëŒ€ë¡œ ëª» ì“°ê³ , ëŒ€ì‹  Responsesì²˜ëŸ¼ Harmony ì´ë²¤íŠ¸/JSONì„ ì§ì ‘ í•´ì„í•´ì•¼ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìš”ì•½í•˜ë©´ <strong>Harmony ê¸°ë°˜ OSS ëª¨ë¸ì€ Chat Completions íˆ´ í˜¸ì¶œ ë°©ì‹ê³¼ëŠ” ë¬´ê´€</strong> í•˜ê³ , Responses/Harmony ìŠ¤íƒ€ì¼ê³¼ ë§ë‹¿ì•„ ìˆë‹¤ê³  ë³´ëŠ” ê²Œ ë§ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h3 id="4-ê²°ë¡ ">4. ê²°ë¡ </h3>

<ul>
  <li>
    <p>Chat Completionsì˜ íˆ´ í˜¸ì¶œ í¬ë§· â‰  Harmony í¬ë§·.</p>
  </li>
  <li>
    <p>Responses API = Harmony í¬ë§·ì„ ê³µì‹ ì±„íƒ.</p>
  </li>
  <li>
    <p>OSS GPTê°€ Harmonyë¥¼ ë”°ë¥¸ë‹¤ë©´, Chat Completions íˆ´ í˜¸ì¶œì€ ê·¸ëŒ€ë¡œ ì“¸ ìˆ˜ ì—†ê³ , Harmony ìŠ¤í™ì„ ë§ì¶°ì•¼ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¦‰, ê´€ê³„ëŠ” â€œë™ì¼ ëª©ì (íˆ´ í˜¸ì¶œ)ì¸ë°, í‘œí˜„ í¬ë§·ë§Œ ë‹¤ë¥´ë‹¤â€ëŠ” ì •ë„ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>í˜¹ì‹œ ì œê°€ <strong>ë™ì¼í•œ í•¨ìˆ˜ í˜¸ì¶œ</strong> ì„ Chat Completions ë°©ì‹(JSON) vs Harmony/Responses ë°©ì‹(JSON)ìœ¼ë¡œ ì–´ë–»ê²Œ ë‹¤ë¥´ê²Œ í‘œí˜„ë˜ëŠ”ì§€ ì˜ˆì‹œë¥¼ ë³´ì—¬ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

harmony í¬ë§·ì´ ë­”ë°

</p>

<p>ì¢‹ì•„ìš” â€” OpenAI Harmony(ì´í•˜ â€œHarmony í¬ë§·â€)ì— ëŒ€í•´ <strong>ë‹¨ê³„ë³„ë¡œ</strong> , â€œë¬´ì—‡ì¸ì§€â€, â€œì™œ ë‚˜ì™”ëŠ”ì§€â€, â€œì£¼ìš” êµ¬ì„±ìš”ì†Œâ€ ìˆœì„œëŒ€ë¡œ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.</p>

<hr />

<h2 id="1-harmony-í¬ë§·ì´ë€-1">1. Harmony í¬ë§·ì´ë€</h2>

<p>Harmony í¬ë§·ì€ gptâ€‘oss ëª¨ë¸ ì‹œë¦¬ì¦ˆ(ì˜ˆ: <code class="language-plaintext highlighter-rouge">openai/gpt-oss-20b</code>, <code class="language-plaintext highlighter-rouge">openai/gpt-oss-120b</code>)ê°€ <strong>ì…ë ¥/ì¶œë ¥ ë©”ì‹œì§€ êµ¬ì¡°</strong> , ì±„ë„, íˆ´ í˜¸ì¶œ ë“±ì„ ì¼ê´€ë˜ê²Œ ë‹¤ë£¨ê¸° ìœ„í•´ ì„¤ê³„ëœ ê·œê²©ì…ë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">cookbook.openai.com+2</a><br />
ì¦‰, ë‹¨ìˆœíˆ â€œëŒ€í™” ë©”ì‹œì§€â€ë§Œ ìˆëŠ” ê²Œ ì•„ë‹ˆë¼, ëª¨ë¸ ë‚´ë¶€ì˜ ì¶”ë¡ (chain-of-thought), íˆ´ í˜¸ì¶œ(tool calls), ì—­í• (roles) ë“±ì´ ëª…í™•íˆ êµ¬ë¶„ëœ í˜•ì‹ì´ì—ìš”. <a href="https://huggingface.co/blog/kuotient/chatml-vs-harmony?utm_source=chatgpt.com">Hugging Face+1</a></p>

<hr />

<h2 id="2-ì™œ-í•„ìš”í–ˆë‚˜">2. ì™œ í•„ìš”í–ˆë‚˜</h2>

<ul>
  <li>
    <p>ì˜¤í”ˆì†ŒìŠ¤ ëª¨ë¸ë“¤ì€ ë‹¤ì–‘í•œ í”„ë¡¬í”„íŠ¸, ë‹¤ì–‘í•œ APIì™€ í†µí•©ë˜ëŠ”ë°, í¬ë§·ì´ ì œê°ê°ì´ì–´ì„œ â€œíˆ´ í˜¸ì¶œâ€, â€œì¶”ë¡  ê³¼ì •â€, â€œìµœì¢… ì‘ë‹µâ€ ë“±ì„ ì¼ê´€ì„± ìˆê²Œ ë‹¤ë£¨ê¸° ì–´ë ¤ì› ì–´ìš”.</p>
  </li>
  <li>
    <p>Harmony í¬ë§·ì€ ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ , êµ¬ì¡°í™”ëœ ì¶œë ¥(ì˜ˆ: íˆ´ í˜¸ì¶œ JSON, ë¶„ì„ ë‹¨ê³„, ìµœì¢… ì‘ë‹µ)ì„ ëª¨ë¸ì´ <strong>í›ˆë ¨-ìƒì„± ê°€ëŠ¥í•˜ê²Œ</strong> ë§Œë“  ì„¤ê³„ì…ë‹ˆë‹¤. <a href="https://cobusgreyling.medium.com/what-is-gpt-oss-harmony-response-format-a29f266d6672?utm_source=chatgpt.com">Medium+1</a></p>
  </li>
  <li>
    <p>ë˜í•œ, OpenAI Responses API ê°™ì€ ìƒìš© API í¬ë§·ê³¼ë„ í˜¸í™˜ì„±ì„ ê°€ì§ˆ ìˆ˜ ìˆê²Œ ì„¤ê³„ë˜ì—ˆì–´ìš”. <a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">cookbook.openai.com+1</a></p>
  </li>
</ul>

<hr />

<h2 id="3-ì£¼ìš”-êµ¬ì„±ìš”ì†Œ">3. ì£¼ìš” êµ¬ì„±ìš”ì†Œ</h2>

<p>Harmony í¬ë§·ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í•µì‹¬ ê°œë…ë“¤ì´ ìˆì–´ìš”:</p>

<h3 id="a-ì—­í• roles">a) ì—­í• (Roles)</h3>

<p>ë©”ì‹œì§€ê°€ ê°–ëŠ” ì£¼ì²´ ë˜ëŠ” ë§¥ë½ì„ ë‚˜íƒ€ë‚´ëŠ” ì—­í• ì´ êµ¬ë¶„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ëŒ€í‘œì ìœ¼ë¡œ:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">system</code> : ì „ì²´ ì‹œìŠ¤í…œ ì¡°ê±´ì´ë‚˜ ì§€ì¹¨. <a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">cookbook.openai.com+1</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">developer</code> : ê°œë°œìê°€ ëª¨ë¸ì— ì£¼ëŠ” ì§€ì¹¨ ë˜ëŠ” í•¨ìˆ˜ ì •ì˜ ë“±. <a href="https://github.com/openai/harmony?utm_source=chatgpt.com">GitHub+1</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">user</code> : ì‚¬ìš©ì ì…ë ¥. <a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">cookbook.openai.com+1</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">assistant</code> : ëª¨ë¸ì´ ìƒì„±í•˜ëŠ” ì‘ë‹µ. <a href="https://github.com/openai/harmony?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tool</code> : íˆ´ í˜¸ì¶œ ê²°ê³¼ë‚˜ íˆ´ ì‹¤í–‰ ë©”ì‹œì§€. <a href="https://cobusgreyling.medium.com/what-is-gpt-oss-harmony-response-format-a29f266d6672?utm_source=chatgpt.com">Medium</a></p>
  </li>
</ul>

<h3 id="b-ì±„ë„channels">b) ì±„ë„(Channels)</h3>

<p>ì¶œë ¥ ë©”ì‹œì§€ê°€ ì–´ë–¤ â€œìš©ë„â€ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì±„ë„ì´ ìˆìŠµë‹ˆë‹¤. ëŒ€í‘œì  ì±„ë„:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">analysis</code> : ëª¨ë¸ì´ ë‚´ë¶€ì ìœ¼ë¡œ ìƒê°í•˜ê±°ë‚˜ ì¶”ë¡ í•˜ëŠ” ê³¼ì • (Chain-of-Thought) ìš©ë„. <a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">cookbook.openai.com</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">commentary</code> : íˆ´ í˜¸ì¶œ ì „í›„ì˜ í•´ì„¤ ë˜ëŠ” ë³´ì¡° ë©”ì‹œì§€ ìš©ë„. <a href="https://huggingface.co/blog/kuotient/chatml-vs-harmony?utm_source=chatgpt.com">Hugging Face</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">final</code> : ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì§€ëŠ” ìµœì¢… ì‘ë‹µ. <a href="https://www.skool.com/data-alchemy/openai-harmony-response-format-for-its-open-weight-model-series?utm_source=chatgpt.com">skool.com</a></p>
  </li>
</ul>

<p>ì˜ˆì»¨ëŒ€, ì‚¬ìš©ìê°€ ì§ˆë¬¸í•˜ë©´ ëª¨ë¸ì´ <code class="language-plaintext highlighter-rouge">analysis</code> ì±„ë„ì—ì„œ â€œë‚´ê°€ ë­ í•´ì•¼ í•˜ì§€?â€ë¼ë©° ìƒê°í•˜ê³ , <code class="language-plaintext highlighter-rouge">tool</code> ì—­í• ë¡œ ì™¸ë¶€ í•¨ìˆ˜ í˜¸ì¶œì´ í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">commentary</code> ì±„ë„ì—ì„œ ê·¸ ì „ê³¼ í›„ë¥¼ ê¸°ë¡í•œ ë’¤, <code class="language-plaintext highlighter-rouge">final</code> ì±„ë„ì—ì„œ ì‚¬ìš©ìì—ê²Œ ê²°ê³¼ë¥¼ ì£¼ëŠ” ì‹ì´ì—ìš”.</p>

<h3 id="c-íŠ¹ìˆ˜-í† í°-ë°-ë©”ì‹œì§€-êµ¬ì¡°">c) íŠ¹ìˆ˜ í† í° ë° ë©”ì‹œì§€ êµ¬ì¡°</h3>

<p>HarmonyëŠ” ì±„íŒ… ë©”ì‹œì§€ë§ˆë‹¤ ì•„ë˜ ê°™ì€ êµ¬ì¡° ë§ˆì»¤(markers)ë¥¼ ì‚¬ìš©í•´ìš”:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pgsql

&lt;|start|&gt;{header}&lt;|message|&gt;{content}&lt;|end|&gt;
</code></pre></div></div>

<p>ì˜ˆ:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;|</span><span class="n">start</span><span class="p">|&gt;</span><span class="n">assistant</span><span class="p">&lt;|</span><span class="n">channel</span><span class="p">|&gt;</span><span class="k">final</span><span class="p">&lt;|</span><span class="n">message</span><span class="p">|&gt;</span><span class="err">â€¦</span><span class="p">&lt;|</span><span class="k">return</span><span class="p">|&gt;</span>
</code></pre></div></div>

<p><a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">cookbook.openai.com+1</a><br />
ê·¸ë¦¬ê³  íˆ´ í˜¸ì¶œì´ë‚˜ JSON ìŠ¤í‚¤ë§ˆ ë“±ë„ TypeScript-ìŠ¤íƒ€ì¼ì´ë‚˜ íŠ¹ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í˜•ì‹ì„ ì“¸ ìˆ˜ ìˆì–´ìš”. <a href="https://huggingface.co/blog/kuotient/chatml-vs-harmony?utm_source=chatgpt.com">Hugging Face+1</a></p>

<h3 id="d-íˆ´functionsë„¤ì„ìŠ¤í˜ì´ìŠ¤">d) íˆ´(Functions)/ë„¤ì„ìŠ¤í˜ì´ìŠ¤</h3>

<p>íˆ´ í˜¸ì¶œì„ ì •ì˜í•  ë•Œ JSON Schema í˜•ì‹ ì™¸ì—ë„, Harmonyì—ì„œëŠ” TypeScript-ìœ ì‚¬ ë¬¸ë²•ìœ¼ë¡œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì„ ì–¸ì„ í•  ìˆ˜ ìˆì–´ìš”. ì˜ˆ:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nx">functions</span> <span class="p">{</span>
  <span class="kd">type</span> <span class="nx">get_weather</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_</span><span class="p">:</span> <span class="p">{</span> <span class="nl">location</span><span class="p">:</span> <span class="kr">string</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="kr">any</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="https://huggingface.co/blog/kuotient/chatml-vs-harmony?utm_source=chatgpt.com">Hugging Face+1</a></p>

<hr />

<h2 id="4-ì‹¤ì œ-ì˜ˆì‹œ">4. ì‹¤ì œ ì˜ˆì‹œ</h2>

<p>ì‚¬ìš©ì ì§ˆë¬¸ â†’ ë‚´ë¶€ ì¶”ë¡  â†’ íˆ´ í˜¸ì¶œ â†’ ìµœì¢… ì‘ë‹µ ìœ¼ë¡œ íë¦„ì´ êµ¬ì„±ëœ ì˜ˆì‹œëŠ” ì´ë ‡ê²Œ ìƒê²¼ì–´ìš”:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sql

&lt;|start|&gt;user&lt;|message|&gt;What is 2 + 2?&lt;|end|&gt;
&lt;|start|&gt;assistant&lt;|channel|&gt;analysis&lt;|message|&gt;I should compute simple arithmetic.&lt;|end|&gt;
&lt;|start|&gt;assistant&lt;|channel|&gt;final&lt;|message|&gt;2 + 2 = 4.&lt;|return|&gt;
</code></pre></div></div>

<p><a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">cookbook.openai.com</a></p>

<p>ë˜ íˆ´ í˜¸ì¶œ í¬í•¨ë˜ëŠ” ê²½ìš°:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wasm

&lt;|start|&gt;assistant&lt;|channel|&gt;commentary&lt;|message|&gt;Calling tool get_current_weather&lt;|end|&gt;
&lt;|start|&gt;assistant&lt;|channel|&gt;commentary&lt;|message|&gt;{ "tool": "get_current_weather", "arguments": { "location": "Seoul" } }&lt;|end|&gt;
&lt;|start|&gt;tool&lt;|message|&gt;{ "location": "Seoul", "temperature": "15Â°C" }&lt;|end|&gt;
&lt;|start|&gt;assistant&lt;|channel|&gt;final&lt;|message|&gt;ì„œìš¸ì˜ í˜„ì¬ ê¸°ì˜¨ì€ 15Â°C ì…ë‹ˆë‹¤.&lt;|return|&gt;
</code></pre></div></div>

<p>(í˜•ì‹ì€ ë‹¨ìˆœí™”ë¨)</p>

<hr />

<h2 id="5-ìœ ì˜ì‚¬í•­">5. ìœ ì˜ì‚¬í•­</h2>

<ul>
  <li>
    <p>ì¤‘ìš”í•œ ì : Harmony í¬ë§·ì€ <strong>ê·¸ëŒ€ë¡œ ì‚¬ìš©ìê°€ ì„ì˜ë¡œ ë³€í˜•í•´ì„œ ëª¨ë¸ì— ì…ë ¥í•˜ë©´ ì•ˆ ë¼ìš”</strong>. í•´ë‹¹ ëª¨ë¸ì´ ì´ í¬ë§·ìœ¼ë¡œ <strong>í›ˆë ¨ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—</strong> , í¬ë§·ì´ ë§ì§€ ì•Šìœ¼ë©´ ì„±ëŠ¥ì´ í¬ê²Œ ë–¨ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”. <a href="https://cookbook.openai.com/articles/gpt-oss/verifying-implementations?utm_source=chatgpt.com">cookbook.openai.com+1</a></p>
  </li>
  <li>
    <p>ë§Œì•½ ë‹¹ì‹ ì´ ì¼ë°˜ì ì¸ OpenAI API(ì˜ˆ: Chat Completions)ë§Œ ì“°ëŠ” ê²½ìš°ë¼ë©´, ë‚´ë¶€ì ìœ¼ë¡œ ì´ í¬ë§·ì„ ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ë˜ëŠ” ê²½ìš°ê°€ ë§ì•„ìš”. â€œì €ìˆ˜ì¤€ ì¸í¼ëŸ°ìŠ¤â€ í™˜ê²½ì´ë‚˜ OSS ëª¨ë¸ ì§ì ‘ ëŒë¦´ ë•Œ íŠ¹íˆ ì¤‘ìš”í•´ìš”. <a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">cookbook.openai.com+1</a></p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë‹¤ë©´ í•œê¸€ë¡œ <strong>Harmony í¬ë§·ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸/ì…ë ¥/ì¶œë ¥ í…œí”Œë¦¿</strong> ì„ ë§Œë“¤ì–´ ë“œë¦´ê¹Œìš”? ê·¸ë ‡ê²Œ í•˜ë©´ ì‹¤ì „ ì ìš©ì´ ë” ì‰¬ìš¸ ê±°ì˜ˆìš”.</p>

<p class="chat--user">

ê³¼ê±°ì˜ íˆ´ í˜¸ì¶œê³¼ ì´ í˜•ì‹ì˜ ì°¨ì´ëŠ”?

</p>

<p>ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. â€œê³¼ê±° íˆ´ í˜¸ì¶œ(Chat Completions function calling)â€ê³¼ â€œHarmony í˜•ì‹(Responses API ê¸°ë°˜)â€ì˜ ì°¨ì´ë¥¼ í¬ê²Œ ë„¤ ê°€ì§€ë¡œ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="1-í‘œí˜„-ë°©ì‹-ë©”ì‹œì§€-í¬ë§·">1. í‘œí˜„ ë°©ì‹ (ë©”ì‹œì§€ í¬ë§·)</h2>

<ul>
  <li>
    <p><strong>ê³¼ê±°(Chat Completions)</strong></p>

    <ul>
      <li>ë‹¨ìˆœ ë©”ì‹œì§€ ë°°ì—´:
        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="nl">"role"</span><span class="p">:</span><span class="s2">"user"</span><span class="p">,</span><span class="nl">"content"</span><span class="p">:</span><span class="s2">"ì„œìš¸ ë‚ ì”¨ ì•Œë ¤ì¤˜"</span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="nl">"role"</span><span class="p">:</span><span class="s2">"assistant"</span><span class="p">,</span><span class="nl">"tool_calls"</span><span class="p">:[{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"get_weather"</span><span class="p">,</span><span class="nl">"arguments"</span><span class="p">:</span><span class="s2">"{</span><span class="se">\"</span><span class="s2">city</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">ì„œìš¸</span><span class="se">\"</span><span class="s2">}"</span><span class="p">}]}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">tool_calls</code> í•„ë“œì— í•¨ìˆ˜ í˜¸ì¶œì´ JSONìœ¼ë¡œ ë“¤ì–´ê°.</p>
      </li>
      <li>í˜¸ì¶œ ê²°ê³¼ëŠ” <code class="language-plaintext highlighter-rouge">role: tool</code> ë©”ì‹œì§€ë¡œ ë‹¤ì‹œ ë„£ì–´ì¤˜ì•¼ í•¨.</li>
    </ul>
  </li>
  <li>
    <p><strong>Harmony (Responses/Harmony í¬ë§·)</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">&lt;|start|&gt;role&lt;|channel|&gt;...&lt;|message|&gt;...&lt;|end|&gt;</code> ê°™ì€ <strong>ëª…ì‹œì  íƒœê·¸ ê¸°ë°˜ êµ¬ì¡°</strong>.</p>
      </li>
      <li>
        <p>íˆ´ í˜¸ì¶œì€ ë³´í†µ <code class="language-plaintext highlighter-rouge">commentary</code> ì±„ë„ì—ì„œ JSONìœ¼ë¡œ í‘œí˜„ë˜ê³ , ì‹¤í–‰ ê²°ê³¼ëŠ” <code class="language-plaintext highlighter-rouge">tool</code> ì—­í•  ë©”ì‹œì§€ë¡œ ë¶™ìŒ.</p>
      </li>
      <li>
        <p>ì˜ˆì‹œ:</p>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wasm
      
&lt;|start|&gt;assistant&lt;|channel|&gt;commentary&lt;|message|&gt;{"tool":"get_weather","arguments":{"city":"ì„œìš¸"}}&lt;|end|&gt;
&lt;|start|&gt;tool&lt;|message|&gt;{"city":"ì„œìš¸","temperature":"15Â°C"}&lt;|end|&gt;
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="2-ì±„ë„-ê°œë…ì˜-ìœ ë¬´">2. ì±„ë„ ê°œë…ì˜ ìœ ë¬´</h2>

<ul>
  <li>
    <p><strong>ê³¼ê±°</strong> : <code class="language-plaintext highlighter-rouge">system</code>, <code class="language-plaintext highlighter-rouge">user</code>, <code class="language-plaintext highlighter-rouge">assistant</code>, <code class="language-plaintext highlighter-rouge">tool</code> ë„¤ ê°€ì§€ ì—­í• ë§Œ ì¡´ì¬. ë‚´ë¶€ ì¶”ë¡ (Chain-of-Thought)ì´ë‚˜ ì¤‘ê°„ í•´ì„¤ì€ ìˆ¨ê¸°ê±°ë‚˜ ì„ì˜ë¡œ ì‘ì„±í•´ì•¼ í–ˆìŒ.</p>
  </li>
  <li>
    <p><strong>Harmony</strong> : <code class="language-plaintext highlighter-rouge">analysis</code>, <code class="language-plaintext highlighter-rouge">commentary</code>, <code class="language-plaintext highlighter-rouge">final</code> ê°™ì€ <strong>ì±„ë„</strong> ê°œë…ì„ ë„ì….</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">analysis</code>: ëª¨ë¸ì˜ ë‚´ë¶€ ì¶”ë¡  (í‰ì†Œì—ëŠ” ìˆ¨ê²¨ì ¸ì•¼ í•¨).</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">commentary</code>: íˆ´ í˜¸ì¶œ ì „í›„ì˜ ë§¥ë½.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">final</code>: ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ìµœì¢… ë‹µë³€.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ë”°ë¼ì„œ ëª¨ë¸ì´ â€œìƒê°í•˜ê¸° â†’ ë„êµ¬ í˜¸ì¶œ â†’ ê²°ê³¼ í™œìš© â†’ ìµœì¢… ë‹µë³€â€ ê³¼ì •ì„ <strong>êµ¬ì¡°ì ìœ¼ë¡œ</strong> êµ¬ë¶„ ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<h2 id="3-ì‹¤í–‰-ë£¨í”„-ì²˜ë¦¬">3. ì‹¤í–‰ ë£¨í”„ ì²˜ë¦¬</h2>

<ul>
  <li>
    <p><strong>ê³¼ê±°</strong> : ëª¨ë¸ì´ <code class="language-plaintext highlighter-rouge">tool_calls</code> JSONë§Œ ë˜ì§ â†’ ê°œë°œìê°€ ì‹¤í–‰ â†’ <code class="language-plaintext highlighter-rouge">role: tool</code> ë©”ì‹œì§€ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— ê³µê¸‰ â†’ ë‹¤ìŒ ChatCompletion í˜¸ì¶œ. <strong>ë£¨í”„ë¥¼ ì§ì ‘ êµ¬í˜„</strong> í•´ì•¼ í–ˆìŒ.</p>
  </li>
  <li>
    <p><strong>Harmony/Responses</strong> : ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° êµ¬ì¡°ë¡œ â€œíˆ´ í˜¸ì¶œ ì´ë²¤íŠ¸ ë°œìƒ â†’ ì‹¤í–‰ â†’ ì‘ë‹µ ë°˜ì˜â€ íë¦„ì´ í‘œì¤€í™”ë¨. Responses SDKê°€ ì´ëŸ° ì´ë²¤íŠ¸ íƒ€ì…(<code class="language-plaintext highlighter-rouge">response.output_text.delta</code>, <code class="language-plaintext highlighter-rouge">response.tool_call.delta</code> ë“±)ì„ ì œê³µí•´ì„œ <strong>ê°œë°œìê°€ ì œì–´í•˜ê¸° ë” ì‰¬ì›€</strong>.</p>
  </li>
</ul>

<hr />

<h2 id="4-ë¹ŒíŠ¸ì¸-íˆ´ê³¼-í™•ì¥ì„±">4. ë¹ŒíŠ¸ì¸ íˆ´ê³¼ í™•ì¥ì„±</h2>

<ul>
  <li>
    <p><strong>ê³¼ê±°</strong> : ëª¨ë“  íˆ´ì€ ë‚´ê°€ ì •ì˜í•œ â€œfunctionsâ€ë¿. íŒŒì¼ íƒìƒ‰, ì½”ë“œ ì‹¤í–‰ ë“±ì€ ì „ë¶€ ë‚´ê°€ ì§ì ‘ êµ¬í˜„í•´ì•¼ í–ˆìŒ.</p>
  </li>
  <li>
    <p><strong>Harmony/Responses</strong> : ë‚´ê°€ ì„ ì–¸í•œ í•¨ìˆ˜í˜• íˆ´ ì™¸ì—ë„, OpenAIê°€ ì œê³µí•˜ëŠ” <strong>ë¹ŒíŠ¸ì¸ íˆ´(Code Interpreter, File Search, Web Search, Image Generation ë“±)</strong> ì„ ê°™ì€ í¬ë§·ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥.</p>
  </li>
  <li>
    <p>ì¦‰, <strong>ë‚´ íˆ´ + í”Œë«í¼ íˆ´</strong> ì„ í˜¼í•©í•œ ì—ì´ì „íŠ¸ êµ¬ì„±ì´ ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<h2 id="ê²°ë¡ ">ê²°ë¡ </h2>

<ul>
  <li>
    <p><strong>Chat Completions íˆ´ í˜¸ì¶œ</strong> = â€œí•¨ìˆ˜ í˜¸ì¶œ JSONë§Œâ€ ì£¼ê³ ë°›ëŠ” ë‹¨ìˆœ êµ¬ì¡°.</p>
  </li>
  <li>
    <p><strong>Harmony í˜•ì‹ íˆ´ í˜¸ì¶œ</strong> = â€œì—­í• +ì±„ë„+ì´ë²¤íŠ¸â€ë¡œ ë‚˜ë‰˜ëŠ” <strong>ë” í’ë¶€í•œ í¬ë§·</strong>. ì¶”ë¡ /í˜¸ì¶œ/ê²°ê³¼/ìµœì¢…ì‘ë‹µì´ êµ¬ë¶„ë˜ê³ , ë¹ŒíŠ¸ì¸ íˆ´ê¹Œì§€ ì§€ì›.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ ì œê°€ ê°™ì€ â€œì„œìš¸ ë‚ ì”¨ ì¡°íšŒâ€ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ <strong>Chat Completions ë°©ì‹</strong> ê³¼ <strong>Harmony ë°©ì‹</strong> ìœ¼ë¡œ ë‚˜ë€íˆ ì½”ë“œ/ì¶œë ¥ ì˜ˆì‹œë¥¼ ë¹„êµí•´ ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

í  api ë‹¨ê³„ì—ì„œëŠ” í° ì°¨ì´ê°€ ì—†ëŠ”ê±° ê°™ì€ë° ì„œë¹™í•˜ëŠ” ì„œë²„ì—ì„œ ë‹¤ë¤„ì¤˜ì•¼í•˜ëŠ”ê±° ì•„ë‹Œê°€

</p>

<p>ë„¤, ì •í™•íˆ ë³´ì…¨ì–´ìš”.<br />
API ë‹¨ê³„(=ëª¨ë¸ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ)ì—ì„œ ë³´ë©´ <strong>ë‘˜ ë‹¤ â€œíˆ´ í˜¸ì¶œ JSONì´ ë‚˜ì˜¤ê³  â†’ ë‚´ê°€ ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— ê³µê¸‰â€</strong> í•˜ëŠ” êµ¬ì¡°ë¼ í° ì°¨ì´ëŠ” ì—†ìŠµë‹ˆë‹¤.<br />
ì°¨ì´ëŠ” ì£¼ë¡œ <strong>ì„œë¹™ ë ˆì´ì–´(ì¤‘ê°„ ì„œë²„, ì—ì´ì „íŠ¸ ì‹¤í–‰ê¸°)</strong> ì—ì„œ ì–´ë–»ê²Œ ë‹¤ë£¨ëŠëƒì—ì„œ ë“œëŸ¬ë‚©ë‹ˆë‹¤.</p>

<hr />

<h2 id="1-chat-completions-function-calling">1. Chat Completions function calling</h2>

<ul>
  <li>
    <p>APIëŠ” ë‹¨ìˆœíˆ <code class="language-plaintext highlighter-rouge">tool_calls</code> JSONë§Œ ë˜ì ¸ì¤ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì„œë²„(í˜¹ì€ ì–´í”Œë¦¬ì¼€ì´ì…˜)ê°€ í•´ì•¼ í•  ì¼:</p>

    <ol>
      <li>
        <p>íˆ´ í˜¸ì¶œ JSON íŒŒì‹±</p>
      </li>
      <li>
        <p>í•´ë‹¹ í•¨ìˆ˜ ì‹¤í–‰</p>
      </li>
      <li>
        <p>ê²°ê³¼ë¥¼ <code class="language-plaintext highlighter-rouge">{"role":"tool","content":"..."}</code> ë©”ì‹œì§€ë¡œ ë‹¤ì‹œ ëª¨ë¸ì— ê³µê¸‰</p>
      </li>
      <li>
        <p>í•„ìš”í•˜ë‹¤ë©´ ì´ ë£¨í”„ë¥¼ ì—¬ëŸ¬ ë²ˆ ëŒë¦¼</p>
      </li>
    </ol>
  </li>
  <li>
    <p>ì¦‰ <strong>â€œí•¨ìˆ˜ ì‹¤í–‰ ë£¨í”„â€ë¥¼ ì§ì ‘ ì§œì•¼ í•˜ëŠ” ë¶€ë‹´</strong> ì´ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h2 id="2-responsesharmony-í¬ë§·">2. Responses/Harmony í¬ë§·</h2>

<ul>
  <li>
    <p>APIëŠ” â€œíˆ´ í˜¸ì¶œ ì´ë²¤íŠ¸â€, â€œë‚´ë¶€ ì¶”ë¡ â€, â€œìµœì¢… ì‘ë‹µâ€ì„ <strong>êµ¬ì¡°í™”ëœ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼</strong> ìœ¼ë¡œ í˜ë ¤ì¤ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì„œë²„ê°€ í•´ì•¼ í•  ì¼:</p>

    <ol>
      <li>
        <p>ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì—ì„œ â€œtool_callâ€ ì´ë²¤íŠ¸ë¥¼ ì¡ìŒ</p>
      </li>
      <li>
        <p>íˆ´ ì‹¤í–‰ í›„ <code class="language-plaintext highlighter-rouge">tool</code> ì´ë²¤íŠ¸ë¡œ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— ê³µê¸‰</p>
      </li>
      <li>
        <p>ìµœì¢…ì ìœ¼ë¡œ â€œfinalâ€ ì±„ë„ ì‘ë‹µì„ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬</p>
      </li>
    </ol>
  </li>
  <li>
    <p>Responses SDKëŠ” ì´ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ <strong>í‘œì¤€í™”ëœ ë°©ì‹ìœ¼ë¡œ ì´ë¯¸ ì œê³µ</strong> í•˜ë¯€ë¡œ, ê°œë°œìê°€ ì§ì ‘ â€œë©”ì‹œì§€ í¬ë§· ë§ì¶°ì„œ ë£¨í”„ ëŒë¦¬ëŠ” ì½”ë“œâ€ë¥¼ ë§ì´ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¦‰, ì„œë²„ëŠ” â€œì´ë²¤íŠ¸ í•¸ë“¤ë§â€ì— ì§‘ì¤‘í•˜ë©´ ë˜ê³ , ë°˜ë³µ í˜¸ì¶œ êµ¬ì¡°ë¥¼ ì§ì ‘ êµ¬í˜„í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h2 id="3-ì„œë²„-ê´€ì -ì°¨ì´-ìš”ì•½">3. ì„œë²„ ê´€ì  ì°¨ì´ ìš”ì•½</h2>

<ul>
  <li>
    <p><strong>Chat Completions</strong> : ì„œë²„ê°€ <strong>ì§ì ‘ íˆ´ ë£¨í”„ ì—”ì§„</strong> ì„ êµ¬í˜„í•´ì•¼ í•¨.</p>
  </li>
  <li>
    <p><strong>Responses/Harmony</strong> : ì„œë²„ëŠ” <strong>SDKê°€ ì£¼ëŠ” ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¸ë“¤ëŸ¬ë§Œ ë¶™ì´ë©´ ë¨</strong> , ë¹ŒíŠ¸ì¸ íˆ´ë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ê´€ë¦¬ ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<h2 id="4-ê²°ë¡ -1">4. ê²°ë¡ </h2>

<p>ë§ì”€í•˜ì‹  ëŒ€ë¡œ API ë ˆë²¨ì—ì„œ ë³´ë©´ â€œíˆ´ í˜¸ì¶œ JSON â†’ ê²°ê³¼ ì£¼ì…â€ì€ ë³¸ì§ˆì ìœ¼ë¡œ ê°™ìŠµë‹ˆë‹¤.<br />
ê·¸ëŸ¬ë‚˜ <strong>Harmony/ResponsesëŠ” ì´ê±¸ ì„œë²„ì—ì„œ ì‰½ê²Œ ë‹¤ë£° ìˆ˜ ìˆê²Œ í‘œì¤€í™”í•œ ê²ƒ</strong> ì´ê³ , <strong>Chat CompletionsëŠ” ë£¨í”„ë¥¼ ì„œë²„ì—ì„œ ì „ë¶€ ì§ì ‘ ì§œì•¼ í•˜ëŠ” ê²ƒ</strong> ì´ ì°¨ì´ë¼ê³  í•  ìˆ˜ ìˆì–´ìš”.</p>

<hr />

<p>í˜¹ì‹œ ì›í•˜ì‹œë©´ ì œê°€ â€œê°™ì€ ì„œë²„â€ì—ì„œ <strong>Chat Completions ë£¨í”„ë¥¼ ì§ì ‘ ì§  ì½”ë“œ</strong> vs <strong>Responses ì´ë²¤íŠ¸ í•¸ë“¤ë§ ì„œë²„ ì½”ë“œ</strong> ë¥¼ ë¹„êµ ì˜ˆì‹œë¡œ ë³´ì—¬ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

ì˜ ëª¨ë¥´ê²Ÿë„¤ responses apië‘ harmonyê°€ ë­ê°€ ë‹¤ë¥´ì§€ gpt5 ê°™ì€ ê²½ìš° responses+íˆ´ chat completions+íˆ´ ë‘ ê°œ ëª¨ë‘ ë™ì‘í•´?

</p>

<p>ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. ì§€ê¸ˆ í—·ê°ˆë¦¬ëŠ” ì§€ì ì„ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.</p>

<hr />

<h2 id="1-responses-apiì™€-harmony-ê´€ê³„">1. Responses APIì™€ Harmony ê´€ê³„</h2>

<ul>
  <li>
    <p><strong>Responses API</strong></p>

    <ul>
      <li>
        <p>OpenAIê°€ ìƒˆë¡œ ë‚´ë†“ì€ â€œí†µí•© ì‘ë‹µ APIâ€ì…ë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>í…ìŠ¤íŠ¸ ë‹µë³€, ìŠ¤íŠ¸ë¦¬ë°, íˆ´ í˜¸ì¶œ, ë©€í‹°ëª¨ë‹¬ ì…ë ¥ê¹Œì§€ ëª¨ë‘ ì´ API í•˜ë‚˜ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ì„¤ê³„ëìŠµë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>SDKì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">client.responses.create(...)</code> ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Harmony</strong></p>

    <ul>
      <li>
        <p>OpenAIê°€ <strong>ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë©”ì‹œì§€/ì¶œë ¥ í¬ë§·</strong> ì´ì—ìš”.</p>
      </li>
      <li>
        <p>ëª¨ë¸ì´ í›ˆë ¨ëœ ë°ì´í„° í˜•ì‹ì´ê¸°ë„ í•˜ê³ , Responses APIì˜ ì´ë²¤íŠ¸/ì¶œë ¥ êµ¬ì¡°ê°€ ë°”ë¡œ ì´ Harmony í¬ë§·ì„ ê¸°ë°˜ìœ¼ë¡œ ë‚˜ì˜µë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>ì¦‰, ResponsesëŠ” â€œAPIâ€, HarmonyëŠ” ê·¸ APIê°€ ì“°ëŠ” â€œí‘œì¤€ í¬ë§·â€ì´ë¼ê³  ë³´ë©´ ë©ë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>ì‚¬ìš©ìëŠ” Responses APIë¥¼ ì“°ì§€ë§Œ, ë‚´ë¶€ì ìœ¼ë¡œ ì£¼ê³ ë°›ëŠ” êµ¬ì¡°ê°€ Harmony í˜•ì‹ì¼ ë¿ì´ì—ìš”.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="2-chat-completions--íˆ´-í˜¸ì¶œ">2. Chat Completions + íˆ´ í˜¸ì¶œ</h2>

<ul>
  <li>
    <p>ì˜ˆì „ë¶€í„° ìˆë˜ ë°©ì‹.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">client.chat.completions.create(...)</code> ë¡œ ì“°ê³ , <code class="language-plaintext highlighter-rouge">tools=[...]</code> ì •ì˜í•´ì£¼ë©´ ëª¨ë¸ì´ JSON í˜¸ì¶œì„ ë°˜í™˜í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì§€ê¸ˆë„ ì§€ì›ë˜ê³  ìˆê³ , ë§ì€ ì½”ë“œ/ì„œë¹„ìŠ¤ê°€ ì´ ë°©ì‹ì„ ê·¸ëŒ€ë¡œ ì”ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h2 id="3-gpt-5-ê°™ì€-ìµœì‹ -ëª¨ë¸ì—ì„œ-ê°€ëŠ¥í•œ-ê²ƒ">3. GPT-5 ê°™ì€ ìµœì‹  ëª¨ë¸ì—ì„œ ê°€ëŠ¥í•œ ê²ƒ</h2>

<ul>
  <li>
    <p><strong>Responses + íˆ´</strong> â†’ ì§€ì›ë¨. ResponsesëŠ” ìµœì‹  APIì´ë¯€ë¡œ GPT-4.1, GPT-4o, GPT-5 ê³„ì—´ ëª¨ë¸ê³¼ ì˜ ë§ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>Chat Completions + íˆ´</strong> â†’ ì—¬ì „íˆ ì§€ì›ë¨. GPT-5 ê°™ì€ ìµœì‹  ëª¨ë¸ë„ chat.completions ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ íˆ´ í˜¸ì¶œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì¦‰, <strong>ë‘ ë°©ì‹ ëª¨ë‘ ë™ì‘í•©ë‹ˆë‹¤.</strong></p>

<hr />

<h2 id="4-ì°¨ì´ë¥¼-ì •ë¦¬í•˜ë©´">4. ì°¨ì´ë¥¼ ì •ë¦¬í•˜ë©´</h2>

<ul>
  <li>
    <p><strong>Chat Completions</strong> = ê¸°ì¡´ ë©”ì‹œì§€ ë°°ì—´ + í•¨ìˆ˜ í˜¸ì¶œ JSON. â†’ ë‹¨ìˆœí•˜ê³  ìµìˆ™í•˜ì§€ë§Œ, ì¶”ë¡ /ì´ë²¤íŠ¸ íë¦„ì€ ë‚´ê°€ ì§ì ‘ êµ¬í˜„.</p>
  </li>
  <li>
    <p><strong>Responses (+Harmony)</strong> = ë” ìµœì‹  API, ë‚´ë¶€ í¬ë§·ì´ Harmonyë¼ì„œ ì¶”ë¡ /íˆ´ í˜¸ì¶œ/ìµœì¢… ì‘ë‹µì„ <strong>êµ¬ì¡°ì ìœ¼ë¡œ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë°</strong> ìœ¼ë¡œ ë°›ìŒ. â†’ ì„œë²„ì—ì„œ ë‹¤ë£¨ê¸° í¸ë¦¬í•˜ê³ , ë¹ŒíŠ¸ì¸ íˆ´ í†µí•© ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<p>ì •ë¦¬í•˜ë©´</p>

<ul>
  <li>
    <p><strong>Responses = API (Harmony í¬ë§· ê¸°ë°˜)</strong></p>
  </li>
  <li>
    <p><strong>Harmony = Responsesê°€ ì“°ëŠ” ë©”ì‹œì§€/ì¶œë ¥ í‘œì¤€ í¬ë§·</strong></p>
  </li>
  <li>
    <p><strong>Chat Completions = êµ¬ë°©ì‹ APIì§€ë§Œ ì•„ì§ë„ ì§€ì›</strong></p>
  </li>
  <li>
    <p>GPT-5ëŠ” <strong>ë‘˜ ë‹¤ ì‚¬ìš© ê°€ëŠ¥</strong> í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>í˜¹ì‹œ ì›í•˜ì‹œë©´ ì œê°€ <strong>ê°™ì€ íˆ´ í˜¸ì¶œ ì˜ˆì œ(ì˜ˆ: get_weather í•¨ìˆ˜)</strong> ë¥¼ Chat Completions ë°©ì‹ê³¼ Responses ë°©ì‹ìœ¼ë¡œ ë‚˜ë€íˆ ë³´ì—¬ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

ê·¸ëŸ¼ ì–´ì¨Œë“  ë‘˜ ë‹¤ ë¼ì•¼í•˜ëŠ”ê±°ì–ì•„ gpt ossëŠ” ì™œ ì•ˆë˜ëŠ”ê±´ë°

</p>

<p>ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. ì—¬ê¸°ì„œ í•µì‹¬ ì°¨ì´ëŠ” <strong>â€œOpenAI API ëª¨ë¸â€</strong>ê³¼ <strong>â€œGPT OSS(Open-Source)â€ ëª¨ë¸</strong> ì˜ <strong>í›ˆë ¨ í¬ë§·ê³¼ ì§€ì› ì¸í„°í˜ì´ìŠ¤</strong> ì°¨ì´ ë•Œë¬¸ì´ì—ìš”.</p>

<hr />

<h2 id="1-openai-api-ëª¨ë¸-ì˜ˆ-gpt-4o-gpt-5">1. OpenAI API ëª¨ë¸ (ì˜ˆ: GPT-4o, GPT-5)</h2>

<ul>
  <li>
    <p>OpenAIê°€ ì œê³µí•˜ëŠ” ìƒìš© API ëª¨ë¸ì€ <strong>Chat Completions</strong> ê³¼ <strong>Responses(Harmony ê¸°ë°˜)</strong> <strong>ëª¨ë‘ ì§€ì›</strong> í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì™œëƒí•˜ë©´ ì´ ëª¨ë¸ë“¤ì€ OpenAIê°€ ì§ì ‘ í›ˆë ¨í•  ë•Œ <strong>ChatML í¬ë§·(ì˜ˆì „)</strong>ê³¼ <strong>Harmony í¬ë§·(ì‹ ê·œ)</strong> ì–‘ìª½ì„ ë‹¤ ì´í•´í•  ìˆ˜ ìˆê²Œ ì¡°ì •í•´ë†¨ê¸° ë•Œë¬¸ì´ì—ìš”.</p>
  </li>
  <li>
    <p>ê·¸ë˜ì„œ ê°™ì€ GPT-5 ëª¨ë¸ë„ <code class="language-plaintext highlighter-rouge">chat.completions.create(...)</code> í˜¸ì¶œì´ ë˜ê³ , <code class="language-plaintext highlighter-rouge">responses.create(...)</code> í˜¸ì¶œë„ ë˜ëŠ” ê²ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h2 id="2-gpt-oss-open-source-series-ì˜ˆ-gpt-oss-7b-20b-">2. GPT OSS (Open-Source Series, ì˜ˆ: gpt-oss-7b, 20b â€¦)</h2>

<ul>
  <li>
    <p>ì´ê±´ OpenAIê°€ ê³µê°œí•œ <strong>ì˜¤í”ˆ ì›¨ì´íŠ¸(ëª¨ë¸ íŒŒë¼ë¯¸í„°)</strong> ëª¨ë¸ì´ì—ìš”.</p>
  </li>
  <li>
    <p>OSS ëª¨ë¸ì€ <strong>Harmony í¬ë§·ìœ¼ë¡œë§Œ í›ˆë ¨</strong> ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

    <ul>
      <li>ì¦‰, ì…ë ¥/ì¶œë ¥ì„ Harmony í† í° ë§ˆì»¤(<code class="language-plaintext highlighter-rouge">&lt;|start|&gt;...&lt;|end|&gt;</code>)ì™€ ì±„ë„(<code class="language-plaintext highlighter-rouge">analysis</code>, <code class="language-plaintext highlighter-rouge">final</code>, <code class="language-plaintext highlighter-rouge">commentary</code>)ë¡œ êµ¬ë¶„í•˜ëŠ” ë°ì´í„°ë¡œ í•™ìŠµëœ ê±°ì˜ˆìš”.</li>
    </ul>
  </li>
  <li>
    <p>ë”°ë¼ì„œ ì´ ëª¨ë¸ì—ê²Œ Chat Completions í˜•ì‹(<code class="language-plaintext highlighter-rouge">{"role":"user","content":"..."}</code> ë°°ì—´)ìœ¼ë¡œ ë˜ì§€ë©´ ì˜ ë°˜ì‘í•˜ì§€ ëª»í•˜ê±°ë‚˜ ì„±ëŠ¥ì´ ê¸‰ê²©íˆ ë–¨ì–´ì§‘ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h2 id="3-ì™œ-chat-completionsì´-ì•ˆ-ë˜ë‚˜">3. ì™œ Chat Completionsì´ ì•ˆ ë˜ë‚˜?</h2>

<ul>
  <li>
    <p>GPT OSSëŠ” <strong>ChatML í¬ë§·(ì˜ˆì „ API í¬ë§·)</strong> ìœ¼ë¡œ í•™ìŠµë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Chat Completions ë°©ì‹ì€ ê¸°ë³¸ì ìœ¼ë¡œ ChatML í¬ë§·(<code class="language-plaintext highlighter-rouge">system</code>, <code class="language-plaintext highlighter-rouge">user</code>, <code class="language-plaintext highlighter-rouge">assistant</code>, <code class="language-plaintext highlighter-rouge">tool</code> ë©”ì‹œì§€ ë°°ì—´)ì„ ê¸°ëŒ€í•˜ëŠ”ë°, OSS ëª¨ë¸ì€ ì´ë¥¼ â€œë³¸ ì ì´ ì—†ëŠ”â€ ìƒíƒœì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë°˜ëŒ€ë¡œ HarmonyëŠ” OSS ëª¨ë¸ì˜ ê¸°ë³¸ ì–¸ì–´ë¼ì„œ, Responses APIì²˜ëŸ¼ Harmonyë¥¼ ë”°ë¥´ëŠ” êµ¬ì¡°ì—¬ì•¼ë§Œ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h2 id="4-ì •ë¦¬-1">4. ì •ë¦¬</h2>

<ul>
  <li>
    <p>ìƒìš© OpenAI API ëª¨ë¸(GPT-4o, GPT-5 ë“±): Chat Completions + Responses ëª¨ë‘ ì§€ì› (í•˜ìœ„í˜¸í™˜ì„± í™•ë³´).</p>
  </li>
  <li>
    <p>ì˜¤í”ˆì†ŒìŠ¤ GPT OSS ëª¨ë¸: Harmony í¬ë§·ìœ¼ë¡œë§Œ í•™ìŠµ â†’ Responses(Harmony ê¸°ë°˜)ë§Œ ì œëŒ€ë¡œ ì§€ì›. Chat Completions í¬ë§·ì€ ì§€ì› ì•ˆ ë¨.</p>
  </li>
</ul>

<hr />

<p>ì¦‰, <strong>â€œì™œ GPT OSSëŠ” Chat Completions ì•ˆ ë¼?â€</strong> â†’<br />
í›ˆë ¨ ë°ì´í„°ì™€ ì¶œë ¥ í¬ë§·ì´ Harmonyì— ë§ì¶°ì ¸ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>

<hr />

<p>ì œê°€ ì›í•˜ì‹œë©´, <strong>ê°™ì€ ìš”ì²­(ì˜ˆ: ë‚ ì”¨ ì¡°íšŒ)</strong> ì„</p>

<ul>
  <li>
    <p>Chat Completions í¬ë§·</p>
  </li>
  <li>
    <p>Harmony í¬ë§·</p>
  </li>
</ul>

<p>ìœ¼ë¡œ ê°ê° ì–´ë–»ê²Œ ìƒê²¼ëŠ”ì§€ ì‹¤ì œ ë©”ì‹œì§€ ì˜ˆì‹œë¥¼ ë‚˜ë€íˆ ë³´ì—¬ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

responses(input=â€¦) ì´ê±´ í•˜ëª¨ë‹ˆë¡œ ë³€í™˜ ê°€ëŠ¥ completions(messages=) ì´ê±´ í•˜ëª¨ë‹ˆë¡œ ë³€í™˜ ë¶ˆê°€ëŠ¥? ë‘˜ ë‹¤ ë¹„ìŠ·í•œë° ì™œ completionsëŠ” ì•ˆë˜ëŠ”ê±´ì§€

</p>

<p>ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. í•œì¤„ ìš”ì•½ë¶€í„° ë§í•˜ë©´:</p>

<p>Responses(input=â€¦) â†’ Harmony í¬ë§·ê³¼ â€œìì—°ìŠ¤ëŸ½ê²Œâ€ 1:1 ë§¤í•‘ë¨<br />
Chat Completions(messages=â€¦) â†’ ì´ë¡ ìƒ ë˜í•‘í•´ì„œ Harmonyì²˜ëŸ¼ â€œë³´ì´ê²Œâ€ ë§Œë“¤ ìˆ˜ëŠ” ìˆì§€ë§Œ, ëª¨ë¸ì´ Harmonyë¡œ í•™ìŠµë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì‹¤ì „ì—ì„œ ì˜ ì•ˆ ë¨¹í˜</p>

<p>ì™œ ê·¸ëŸ°ì§€ë¥¼ ë‹¨ê³„ë³„ë¡œ í’€ì–´ë³¼ê²Œìš”.</p>

<ol>
  <li>ë‘˜ì˜ ì¶œë°œì ì´ ë‹¤ë¦„</li>
</ol>

<ul>
  <li>
    <p>ResponsesëŠ” ì„¤ê³„ ìì²´ê°€ Harmony ì´ë²¤íŠ¸Â·ì±„ë„ì„ ì „ì œë¡œ ë˜ì–´ ìˆì–´ìš”. SDKê°€ ë‚´ë³´ë‚´ëŠ” ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ íƒ€ì…, ìµœì¢… í…ìŠ¤íŠ¸ ì ‘ê·¼ì, íˆ´ í˜¸ì¶œ ì´ë²¤íŠ¸ ë“± ëª¨ë“  êµ¬ì¡°ê°€ Harmonyì— ë°”ë¡œ ëŒ€ì‘ë©ë‹ˆë‹¤. ê·¸ë˜ì„œ inputì„ ë„£ìœ¼ë©´ ë‚´ë¶€ì ìœ¼ë¡œ ê³§ë°”ë¡œ Harmony ìŠ¤íƒ€ì¼ í† í° ì‹œí€€ìŠ¤ë¡œ ë°”ë€ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Chat CompletionsëŠ” ì˜ˆì „ì˜ ChatML ë©”ì‹œì§€ ë°°ì—´ì„ ì „ì œë¡œ í•´ìš”. role/user/assistant/toolë¡œë§Œ ì˜¤ê°€ê³ , analysis/commentary/final ê°™ì€ Harmony ì±„ë„ ë¶„ë¦¬ëŠ” ì—†ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>â€œë³€í™˜â€ì˜ ë³¸ì§ˆì€ ëª¨ë¸ í•™ìŠµÂ·í† í¬ë‚˜ì´ì € ì •í•©ì„±</li>
</ol>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Harmonyë¥¼ ì˜ ì“°ë ¤ë©´ ëª¨ë¸ì´ Harmony íŠ¹ìˆ˜ í† í°(&lt;</td>
          <td>start</td>
          <td>&gt;, &lt;</td>
          <td>channel</td>
          <td>&gt;, &lt;</td>
          <td>message</td>
          <td>&gt;, &lt;</td>
          <td>end</td>
          <td>&gt;, &lt;</td>
          <td>return</td>
          <td>&gt; ë“±)ê³¼ ì±„ë„ ì˜ë¯¸ì— ë§ì¶° í•™ìŠµë˜ì–´ ìˆì–´ì•¼ í•´ìš”. í† í¬ë‚˜ì´ì €ì—ë„ ì´ í† í°ë“¤ì´ ë“±ë¡ë¼ ìˆì–´ì•¼ í•˜ê³ ìš”.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>OpenAI í˜¸ìŠ¤í‹°ë“œ ìµœì‹  ëª¨ë¸(GPT-4o/5 ë“±)ì€ ë‚´ë¶€ì ìœ¼ë¡œ ChatMLê³¼ Harmony ë‘˜ ë‹¤ ì´í•´í•  ìˆ˜ ìˆê²Œ ì •ë ¬ë˜ì–´ ìˆì–´ì„œ, Chat Completionsë„ ë˜ê³  Responsesë„ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>GPT-OSSëŠ” Harmonyë¡œë§Œ í•™ìŠµë˜ì–´ ìˆì–´ìš”. ê·¸ëŸ¬ë‹ˆ ChatML(messages=â€¦)ì„ ê·¸ëŒ€ë¡œ ë˜ì§€ë©´ ë¶„í¬ ë°”ê¹¥ ì…ë ¥ì´ ë˜ì–´ ì„±ëŠ¥ì´ ê¸‰ë½í•˜ê±°ë‚˜ íˆ´ í˜¸ì¶œ í¬ë§·ì„ ì œëŒ€ë¡œ ëª» ëƒ…ë‹ˆë‹¤.</li>
</ul>

<ol>
  <li>â€œcompletions â†’ harmonyâ€ëŠ” ì´ë¡ ìƒ ê°€ëŠ¥í•˜ì§€ë§Œ, ì„±ê³µ ì¡°ê±´ì´ ê¹Œë‹¤ë¡œì›€</li>
</ol>

<ul>
  <li>
    <p>ë©”ì‹œì§€ ë°°ì—´ì„ ë‹¤ìŒì²˜ëŸ¼ ê°ìŒ€ ìˆ˜ëŠ” ìˆì–´ìš”.<br />
system â†’ &lt;|start|&gt;system â€¦ &lt;|end|&gt;<br />
user â†’ &lt;|start|&gt;user â€¦ &lt;|end|&gt;<br />
assistant(ì´ì „ ë‹µë³€) â†’ ë³´í†µ &lt;|start|&gt;assistant&lt;|channel|&gt;final â€¦ ë˜ëŠ” commentaryë¡œ ë§¤í•‘<br />
tool í˜¸ì¶œ/ê²°ê³¼ â†’ assistant(commentary)ì—ì„œ JSONìœ¼ë¡œ í˜¸ì¶œ, tool ì—­í• ë¡œ ê²°ê³¼</p>
  </li>
  <li>
    <p>í•˜ì§€ë§Œ ì´ê²ƒë§Œìœ¼ë¡œ ì„±ëŠ¥ì´ ì˜¬ë¼ê°€ì§„ ì•Šì•„ìš”. ëª¨ë¸ì´ â€œê·¸ í¬ë§·ì„ ì •ë‹µìœ¼ë¡œ í•™ìŠµâ€í–ˆì–´ì•¼ í•©ë‹ˆë‹¤. ì¦‰, ë‹¨ìˆœ í”„ë¡¬í”„íŠ¸ íŠ¸ëœìŠ¤íŒŒì¼ì€ ê°€ëŠ¥í•˜ì§€ë§Œ, ëª¨ë¸ ì •ë ¬(alignment)+í† í¬ë‚˜ì´ì € íŠ¹ìˆ˜ í† í° ì§€ì›ì´ ì—†ìœ¼ë©´ ì‹¤ì „ í’ˆì§ˆì„ ë³´ì¥í•˜ì§€ ëª»í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>íˆ´ í˜¸ì¶œ í‘œí˜„ì˜ ê°„ê·¹</li>
</ol>

<ul>
  <li>
    <p>Chat Completions: tools/functions ì•„ë˜ JSON ìŠ¤í‚¤ë§ˆë¥¼ ì£¼ê³ , ëª¨ë¸ì´ message.tool_callsë¡œ name+argumentsë¥¼ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Harmony/Responses: ì±„ë„(ëŒ€ê°œ commentary)ì—ì„œ íˆ´ í˜¸ì¶œ ì´ë²¤íŠ¸ë¥¼ ë‚´ê³ , ë³„ë„ì˜ tool ì—­í•  ë©”ì‹œì§€ë¡œ ì‹¤í–‰ ê²°ê³¼ê°€ ë“¤ì–´ì˜µë‹ˆë‹¤. ì´ë²¤íŠ¸ íƒ€ì…ê³¼ ì±„ë„ ë¶„ë¦¬ê°€ ì „ì œë¼ì„œ ë¡œê·¸/ìŠ¤íŠ¸ë¦¬ë°/ì¬ì‹œë„ ì²˜ë¦¬ê°€ í‘œì¤€í™”ë˜ì–´ ìˆì–´ìš”.</p>
  </li>
  <li>
    <p>ì´ êµ¬ì¡° ì°¨ì´ë¥¼ ë‹¨ìˆœíˆ ë¬¸ìì—´ ì¹˜í™˜ìœ¼ë¡œ ë©”ìš¸ ìˆ˜ëŠ” ìˆì§€ë§Œ, ê²°êµ­ ëª¨ë¸ì´ ê·¸ í”„ë¡œí† ì½œì„ â€œëª¸ìœ¼ë¡œâ€ ìµí˜”ëŠëƒê°€ ê´€ê±´ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>ê·¸ë˜ì„œ ê²°ë¡ </li>
</ol>

<ul>
  <li>
    <p>Responses(input=â€¦): Harmony â€œë„¤ì´í‹°ë¸Œâ€. ë³€í™˜ì´ë¼ê¸°ë³´ë‹¤ ê·¸ëƒ¥ ë³¸ì—°ì˜ í˜•íƒœ.</p>
  </li>
  <li>
    <p>Completions(messages=â€¦): OpenAI í˜¸ìŠ¤í‹°ë“œ ìµœì‹  ëª¨ë¸ì€ ë‚´ë¶€ ë¸Œë¦¬ì§€ ë•ë¶„ì— ì—¬ì „íˆ ì˜ ë™ì‘. ê·¸ëŸ¬ë‚˜ GPT-OSSëŠ” Harmony ì „ìš©ì´ë¼ ChatMLì„ ê·¸ëƒ¥ ì£¼ë©´ ì•ˆ ë§ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>â€œë‘˜ ë‹¤ ë¹„ìŠ·í•œë° ì™œ completionsëŠ” ì•ˆ ë¼?â€ì˜ í•µì‹¬ì€ API ë¬¸ë²•ì´ ì•„ë‹ˆë¼ â€œëª¨ë¸ì´ ì–´ë–¤ í¬ë§·ìœ¼ë¡œ í•™ìŠµÂ·ì •ë ¬ë˜ì–´ ìˆëŠëƒâ€ì˜ˆìš”.</p>
  </li>
</ul>

<p>ì‹¤ìš© ê°€ì´ë“œ</p>

<ul>
  <li>
    <p>OpenAI í˜¸ìŠ¤í‹°ë“œ ìµœì‹  ëª¨ë¸ì„ ì“´ë‹¤: ë‘˜ ë‹¤ ê°€ëŠ¥. ìƒˆ í”„ë¡œì íŠ¸ë©´ Responses ê¶Œì¥.</p>
  </li>
  <li>
    <p>GPT-OSSë¥¼ ìê°€ í˜¸ìŠ¤íŒ…í•œë‹¤: Harmony í¬ë§·ì„ ê·¸ëŒ€ë¡œ ì“°ì„¸ìš”. Chat Completions ìŠ¤íƒ€ì¼ì„ ì–µì§€ë¡œ ì–¹ì§€ ë§ê³ , ì„œë²„ì—ì„œ Harmony ì´ë²¤íŠ¸ ë£¨í”„(analysis/commentary/final, tool í˜¸ì¶œ/ì‘ë‹µ)ë¥¼ ì²˜ë¦¬í•˜ëŠ” ëŸ¬ë„ˆë¥¼ ë‘ëŠ” ê²Œ ì •ì„ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì–‘ìª½ì„ ë™ì‹œì— ì§€ì›í•´ì•¼ í•œë‹¤: ì„œë²„ì—ì„œ ì–´ëŒ‘í„° ê³„ì¸µì„ ë‘ì–´ ChatMLâ†”Harmonyë¥¼ ìƒí˜¸ ë³€í™˜í•˜ë˜, ëª¨ë¸ë³„ë¡œ â€œê¶Œì¥ í¬ë§·â€ì„ ìœ ì§€í•˜ì„¸ìš”. ë³€í™˜ì€ í˜¸í™˜ì„±ì„ ìœ„í•œ ì°¨ì„ ì±…ì¼ ë¿, í’ˆì§ˆì€ ê¶Œì¥ í¬ë§·ì´ ì œì¼ ì¢‹ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´ Chat Completions messagesë¥¼ Harmony í…œí”Œë¦¿ìœ¼ë¡œ ê°ì‹¸ëŠ” ìµœì†Œ ì–´ëŒ‘í„° ì˜ì‚¬ì½”ë“œì™€, Harmony íˆ´ í˜¸ì¶œ ë£¨í”„ í•¸ë“¤ëŸ¬ ì˜ˆì œë¥¼ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

íˆ´ ì•ˆì“°ëŠ” chat completionsë„ gpt oss ì„±ëŠ¥ì´ ë–¨ì–´ì§ˆìˆ˜ ìˆì–´?

</p>

<p>ë„¤, ë§ìŠµë‹ˆë‹¤. íˆ´ì„ ì•ˆ ì“´ â€œìˆœìˆ˜ ëŒ€í™”(Chat Completions ìŠ¤íƒ€ì¼)â€ë§Œ ë³´ë”ë¼ë„ <strong>GPT-OSS(Open-Source Series)</strong> ëª¨ë¸ì€ ì„±ëŠ¥ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ìœ ëŠ” ê°„ë‹¨íˆ ë§í•´ <strong>í›ˆë ¨ í¬ë§·</strong> ë•Œë¬¸ì´ì—ìš”.</p>

<hr />

<h2 id="1-gpt-ossê°€-í•™ìŠµëœ-í¬ë§·">1. GPT-OSSê°€ í•™ìŠµëœ í¬ë§·</h2>

<ul>
  <li>
    <p>GPT-OSSëŠ” <strong>Harmony í¬ë§·</strong> ì„ ê¸°ì¤€ìœ¼ë¡œ í•™ìŠµë˜ì—ˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¦‰, ì…ë ¥ê³¼ ì¶œë ¥ì´ <code class="language-plaintext highlighter-rouge">&lt;|start|&gt;user â€¦ &lt;|end|&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;|start|&gt;assistant&lt;|channel|&gt;final â€¦ &lt;|end|&gt;</code> ê°™ì€ Harmony ë§ˆì»¤ êµ¬ì¡°ë¡œ ì£¼ì–´ì§€ëŠ” ë°ì´í„°ë¥¼ ì£¼ë¡œ ë´¤ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ChatML(<code class="language-plaintext highlighter-rouge">{"role":"user","content":"â€¦"}</code>) í¬ë§·ì€ OSS ëª¨ë¸ì´ ë³¸ ì ì´ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h2 id="2-chat-completions-ë©”ì‹œì§€ë¥¼-ê·¸ëŒ€ë¡œ-ì£¼ë©´">2. Chat Completions ë©”ì‹œì§€ë¥¼ ê·¸ëŒ€ë¡œ ì£¼ë©´?</h2>

<ul>
  <li>
    <p>ëª¨ë¸ ì…ì¥ì—ì„œëŠ” <strong>ë‚¯ì„  ì…ë ¥ ë¶„í¬</strong> ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê·¸ë˜ì„œ ëŒ€ë‹µì„ ì˜ ëª»í•˜ê±°ë‚˜, ì˜ˆìƒì¹˜ ëª»í•œ í† í°(ì˜ˆ: JSON êµ¬ì¡° í‹€ì–´ì§, ì¶œë ¥ ì±„ë„ ëˆ„ë½)ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¦‰, íˆ´ í˜¸ì¶œ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´, ë‹¨ìˆœ QAë„ â€œí›ˆë ¨ëœ í¬ë§·(Harmony)â€ì´ ì•„ë‹ ê²½ìš° ì„±ëŠ¥ì´ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h2 id="3-ì™œ-openai-api-ëª¨ë¸ì€-ê´œì°®ì„ê¹Œ">3. ì™œ OpenAI API ëª¨ë¸ì€ ê´œì°®ì„ê¹Œ?</h2>

<ul>
  <li>
    <p>GPT-4o, GPT-5 ê°™ì€ <strong>ìƒìš© API ëª¨ë¸</strong> ì€ Harmonyë¿ ì•„ë‹ˆë¼ ChatML í¬ë§·ì—ë„ ë§ì¶° ì •ë ¬(alignment)ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê·¸ë˜ì„œ <code class="language-plaintext highlighter-rouge">chat.completions.create(messages=â€¦)</code>ë„ ì˜ ë˜ê³ , <code class="language-plaintext highlighter-rouge">responses.create(input=â€¦)</code>ë„ ì˜ ë˜ëŠ” ê±°ì˜ˆìš”.</p>
  </li>
  <li>
    <p>ë°˜ë©´ GPT-OSSëŠ” Harmonyë§Œ ì§€ì› â†’ ChatML ì…ë ¥ì—ì„œëŠ” í’ˆì§ˆ ì €í•˜.</p>
  </li>
</ul>

<hr />

<h2 id="4-ì •ë¦¬-2">4. ì •ë¦¬</h2>

<ul>
  <li>
    <p><strong>íˆ´ì„ ì“°ë“  ì•ˆ ì“°ë“ </strong> GPT-OSSì— Chat Completions í¬ë§·ì„ ì“°ë©´ ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì•ˆì •ì ì¸ í’ˆì§ˆì„ ë‚´ë ¤ë©´ OSS ëª¨ë¸ì€ ë°˜ë“œì‹œ <strong>Harmony í¬ë§·</strong> ìœ¼ë¡œ ì…ë ¥ì„ ì£¼ëŠ” ê²Œ ë§ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Chat CompletionsëŠ” â€œOpenAI API ëª¨ë¸â€ì„ ìœ„í•œ í•˜ìœ„ í˜¸í™˜ í¬ë§·ì´ë¼ê³  ì´í•´í•˜ë©´ í¸í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ ì œê°€ ê°™ì€ ì§ˆë¬¸(ì˜ˆ: â€œ2+2=?â€)ì„</p>

<ul>
  <li>
    <p>Chat Completions í¬ë§·</p>
  </li>
  <li>
    <p>Harmony í¬ë§·</p>
  </li>
</ul>

<p>ë‘ ê°€ì§€ë¡œ ì‘ì„±í•´ì„œ, ì™œ OSS ëª¨ë¸ì´ Harmonyì—ì„œ ë” ì˜ ë™ì‘í•˜ëŠ”ì§€ ì˜ˆì‹œë¥¼ ë³´ì—¬ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

chat completionsì˜ function call ì‚¬ìš©ê³¼ responsesì˜ function call ì‚¬ìš©ë‹¤ì‹œ í•œ ë²ˆ ì •ë¦¬í•´ì£¼ê³  ë‘ json í˜•ì‹ì´ ë‹¤ë¥¸ë° ì„ì–´ì“°ë©´ ë™ì‘ì„ ì•ˆí•˜ë‚˜ 

</p>

<p>ì¢‹ì•„ìš”. í•µì‹¬ë§Œ ë‹¨ê³„ë³„ë¡œ ë˜ë ·í•˜ê²Œ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.</p>

<h1 id="1-chat-completionsì—ì„œì˜-function-call-ì‚¬ìš©">1) Chat Completionsì—ì„œì˜ function call ì‚¬ìš©</h1>

<ol>
  <li>
    <p>ì…ë ¥ í¬ë§·<br />
messages ë°°ì—´ì„ ë³´ëƒ…ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>system/user/assistant/tool ì—­í• ë§Œ ì¡´ì¬.</p>
      </li>
      <li>
        <p>íˆ´ ì •ì˜ëŠ” tools=[{type:"function", function:{name, parameters(JSON Schema)}}].</p>
      </li>
    </ul>
  </li>
  <li>
    <p>í˜¸ì¶œ íë¦„<br />
a) chat.completions.create(â€¦) í˜¸ì¶œ<br />
b) ëª¨ë¸ì´ tool_calls=[{id, type:"function", function:{name, arguments}}] ë¥¼ ë‚´ë³´ëƒ„<br />
c) ì„œë²„(ë‹¹ì‹ ì˜ ì½”ë“œ)ê°€ í•´ë‹¹ í•¨ìˆ˜ë¥¼ ì‹¤ì œ ì‹¤í–‰<br />
d) ì‹¤í–‰ ê²°ê³¼ë¥¼ role:"tool", tool_call_id:<ë™ì¼>, content:"ì‹¤í–‰ê²°ê³¼" ë©”ì‹œì§€ë¡œ messagesì— append  
e) ë‹¤ì‹œ chat.completions.create(...) í˜¸ì¶œí•´ ìµœì¢… ë‹µë³€ì„ ë°›ìŒ</ë™ì¼></p>
  </li>
  <li>
    <p>ìŠ¤íŠ¸ë¦¬ë°<br />
í† í° ë¸íƒ€ ë‹¨ìœ„ ìŠ¤íŠ¸ë¦¬ë° ê°€ëŠ¥. tool_calls ì‹ í˜¸ë„ ë¸íƒ€ë¡œ ì˜´.</p>
  </li>
  <li>
    <p>íŠ¹ì§• ìš”ì•½</p>

    <ul>
      <li>
        <p>ë‹¨ìˆœí•˜ê³  ìµìˆ™í•¨</p>
      </li>
      <li>
        <p>ëª¨ë“  ë£¨í”„(í˜¸ì¶œ-ì‹¤í–‰-ì¬í˜¸ì¶œ)ë¥¼ ì„œë²„ì—ì„œ ì§ì ‘ êµ¬í˜„</p>
      </li>
      <li>
        <p>í¬ë§·ì€ ChatML ê³„ì—´</p>
      </li>
    </ul>
  </li>
</ol>

<p>ê°„ë‹¨ ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-5</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">ì„œìš¸ ë‚ ì”¨</span><span class="sh">"</span><span class="p">}],</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">get_weather</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">]}</span>
        <span class="p">}</span>
    <span class="p">}],</span>
    <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># resp.choices[0].message.tool_calls -&gt; ì‹¤í–‰ â†’ tool ê²°ê³¼ë¥¼ role:"tool"ë¡œ append â†’ ì¬í˜¸ì¶œ
</span></code></pre></div></div>

<h1 id="2-responsesì—ì„œì˜-function-call-ì‚¬ìš©">2) Responsesì—ì„œì˜ function call ì‚¬ìš©</h1>

<ol>
  <li>
    <p>ì…ë ¥ í¬ë§·<br />
inputì€ ë¬¸ìì—´ ë˜ëŠ” ë©”ì‹œì§€ ë°°ì—´. íˆ´ ì •ì˜ëŠ” tools íŒŒë¼ë¯¸í„°(í˜•íƒœëŠ” ìœ ì‚¬).<br />
ë‚´ë¶€ ì¶œë ¥/ì´ë²¤íŠ¸ëŠ” Harmony ì±„ë„ ê¸°ë°˜(analysis/commentary/final ë“±)ìœ¼ë¡œ êµ¬ì¡°í™”.</p>
  </li>
  <li>
    <p>í˜¸ì¶œ íë¦„<br />
a) client.responses.create(â€¦) í˜¸ì¶œ<br />
b) ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ë¡œ í…ìŠ¤íŠ¸ ë¸íƒ€, íˆ´ í˜¸ì¶œ ì´ë²¤íŠ¸ê°€ êµ¬ë¶„ë˜ì–´ ë„ì°©<br />
c) ì„œë²„ê°€ íˆ´ í˜¸ì¶œ ì´ë²¤íŠ¸ë¥¼ ì¡ì•„ ì‹¤ì œ í•¨ìˆ˜ ì‹¤í–‰<br />
d) ì‹¤í–‰ ê²°ê³¼ë¥¼ responses APIì˜ ê·œê²©ëŒ€ë¡œ â€œíˆ´ ê²°ê³¼â€ ì´ë²¤íŠ¸ë¡œ ë˜ëŒë ¤ ì£¼ì…<br />
e) ìµœì¢…ì ìœ¼ë¡œ final ì±„ë„ì˜ ì¶œë ¥ í…ìŠ¤íŠ¸ íšë“</p>
  </li>
  <li>
    <p>ìŠ¤íŠ¸ë¦¬ë°<br />
ì´ë²¤íŠ¸ íƒ€ì…ì´ ì„¸ë¶„í™”ë˜ì–´ ìˆì–´ ìƒíƒœ ë¨¸ì‹ (ì—¬ëŸ¬ íˆ´ ì™•ë³µ) êµ¬í˜„ì´ ì‰¬ì›€.</p>
  </li>
  <li>
    <p>íŠ¹ì§• ìš”ì•½</p>

    <ul>
      <li>
        <p>ì´ë²¤íŠ¸/ì±„ë„ì´ í‘œì¤€í™”ë˜ì–´ ì„œë²„ ì½”ë“œê°€ ê¹”ë”</p>
      </li>
      <li>
        <p>OpenAI ë¹ŒíŠ¸ì¸ íˆ´(ì½”ë“œ ì‹¤í–‰, íŒŒì¼/ì›¹ ê²€ìƒ‰, ì´ë¯¸ì§€ ë“±)ê³¼ ê°™ì€ ì¸í„°í˜ì´ìŠ¤ë¡œ í˜¼í•© ê°€ëŠ¥</p>
      </li>
      <li>
        <p>í¬ë§·ì€ Harmony ê³„ì—´</p>
      </li>
    </ul>
  </li>
</ol>

<p>ê°„ë‹¨ ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-5</span><span class="sh">"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">ì„œìš¸ ë‚ ì”¨</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">get_weather</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">]}</span>
        <span class="p">}</span>
    <span class="p">}],</span>
    <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># ì´ë²¤íŠ¸ ë£¨í”„ì—ì„œ tool call ì´ë²¤íŠ¸ â†’ ì‹¤í–‰ â†’ tool ê²°ê³¼ ì£¼ì… â†’ final í…ìŠ¤íŠ¸
</span></code></pre></div></div>

<h1 id="3-ë‘-json-í˜•ì‹ì€-ì™œ-ë‹¤ë¥¸ê°€">3) ë‘ JSON í˜•ì‹ì€ ì™œ ë‹¤ë¥¸ê°€</h1>

<ul>
  <li>
    <p>Chat Completions: ChatML ë©”ì‹œì§€ ë°°ì—´ ì¤‘ì‹¬. tool_callsì™€ role:"tool" ë©”ì‹œì§€ë¡œ ë£¨í”„ë¥¼ í‘œí˜„.</p>
  </li>
  <li>
    <p>Responses: Harmony ì´ë²¤íŠ¸/ì±„ë„ ì¤‘ì‹¬. í…ìŠ¤íŠ¸/íˆ´ í˜¸ì¶œ/íˆ´ ê²°ê³¼/ì™„ë£Œë¥¼ ì´ë²¤íŠ¸ë¡œ ë¶„ë¦¬í•´ í‘œì¤€í™”.</p>
  </li>
</ul>

<h1 id="4-ì„ì–´-ì“°ë©´-ë™ì‘í•˜ë‚˜ì—-ëŒ€í•œ-ì •í™•í•œ-ë‹µ">4) â€œì„ì–´ ì“°ë©´ ë™ì‘í•˜ë‚˜?â€ì— ëŒ€í•œ ì •í™•í•œ ë‹µ</h1>

<ol>
  <li>
    <p>ê°™ì€ ìš”ì²­ ì•ˆì—ì„œ í˜•ì‹ì„ ì„ëŠ” ê²ƒì€ ê±°ì˜ ì‹¤íŒ¨í•©ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <table>
          <tbody>
            <tr>
              <td>chat.completionsì— Harmony ë§ˆì»¤(&lt;</td>
              <td>start</td>
              <td>&gt; ë“±)ë‚˜ Responses ì „ìš© ì´ë²¤íŠ¸ JSONì„ ë„£ì–´ë„ API ìŠ¤í‚¤ë§ˆê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— íŒŒì‹±/ì •ë ¬ì´ ê¹¨ì§‘ë‹ˆë‹¤.</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>responsesì— ChatML ê³ ìœ ì˜ role/tool_calls êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ë°€ì–´ ë„£ì–´ë„ ê¸°ëŒ€ëŒ€ë¡œ ì´ë²¤íŠ¸ê°€ ë‚˜ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>
    <p>ëª¨ë¸Â·í›ˆë ¨ í¬ë§·ì— ë”°ë¼ ê²°ê³¼ê°€ ë” ë‚˜ë¹ ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>OpenAI í˜¸ìŠ¤í‹°ë“œ ìµœì‹  ëª¨ë¸(GPT-4o/5)ì€ ë‚´ë¶€ ë¸Œë¦¬ì§€ê°€ ìˆì–´ ë‘ API ëª¨ë‘ â€œê°ìì˜ í˜•ì‹â€ìœ¼ë¡œ ì˜ ë™ì‘í•˜ì§€ë§Œ, í•œ í˜¸ì¶œ ë‚´ì—ì„œ í˜•ì‹ì„ í˜¼ìš©í•˜ë©´ í’ˆì§ˆì´ ê¸‰ë½í•˜ê±°ë‚˜ ì—ëŸ¬ê°€ ë‚©ë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>GPT-OSSëŠ” Harmonyë¡œë§Œ í•™ìŠµë˜ì–´ ChatML(=Chat Completions í¬ë§·) ìì²´ê°€ ì„±ëŠ¥ ì €í•˜ ìš”ì¸ì…ë‹ˆë‹¤. í˜¼ìš©ì€ ë” ì•…í™”ë©ë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì˜¬ë°”ë¥¸ ë°©ë²•</p>

    <ul>
      <li>
        <p>í•œ í˜¸ì¶œì—ëŠ” í•´ë‹¹ ì—”ë“œí¬ì¸íŠ¸ì˜ â€œì •ê·œ í¬ë§·â€ë§Œ ì‚¬ìš©.</p>
      </li>
      <li>
        <p>ì„œë¹„ìŠ¤ ë ˆë²¨ì—ì„œ ë‘ ì„¸ê³„ë¥¼ ëª¨ë‘ ì§€ì›í•˜ë ¤ë©´ ì–´ëŒ‘í„° ê³„ì¸µì„ ë‘¡ë‹ˆë‹¤.<br />
ì˜ˆ) ì™¸ë¶€ì—ì„  ChatMLë¡œ ë°›ê³ , ì„œë²„ì—ì„œ Harmonyë¡œ ë³€í™˜í•´ OSS ëª¨ë¸ì— ì „ë‹¬. ë°˜ëŒ€ ë°©í–¥ë„ ê°€ëŠ¥. ë‹¤ë§Œ ë³€í™˜ì€ â€œí˜¸í™˜ì„±ìš©â€ì¼ ë¿ ìµœì  í’ˆì§ˆì€ ê° ëª¨ë¸ì˜ ì •ê·œ í¬ë§·ìœ¼ë¡œ ì§ì ‘ ì£¼ëŠ” ê²ƒ.</p>
      </li>
    </ul>
  </li>
</ol>

<h1 id="5-ì„ íƒ-ê°€ì´ë“œ">5) ì„ íƒ ê°€ì´ë“œ</h1>

<ul>
  <li>
    <p>ë‹¨ìˆœ í•¨ìˆ˜ í˜¸ì¶œ/ê¸°ì¡´ ì½”ë“œ ìœ ì§€ â†’ Chat Completions ê³„ì† ì‚¬ìš©í•´ë„ ì¶©ë¶„.</p>
  </li>
  <li>
    <p>ë‹¤íˆ´(ì½”ë“œ ì‹¤í–‰Â·íŒŒì¼/ì›¹ ê²€ìƒ‰Â·ì´ë¯¸ì§€) í˜¼ìš©, ì´ë²¤íŠ¸ ì§€í–¥ ì„œë²„, ì¥ê¸° í™•ì¥ â†’ Responses ê¶Œì¥.</p>
  </li>
  <li>
    <p>GPT-OSS ìì²´ í˜¸ìŠ¤íŒ… â†’ ë°˜ë“œì‹œ Harmony í¬ë§·(=Responses ìŠ¤íƒ€ì¼)ë¡œ ì£¼ê³ ë°›ê¸°.</p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´, ê°™ì€ íˆ´(get_weather)ì„ ê¸°ì¤€ìœ¼ë¡œ 1) Chat Completions ë£¨í”„ ì½”ë“œì™€ 2) Responses ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì½”ë“œë¥¼ ë‚˜ë€íˆ ë³´ì—¬ë“œë¦´ê²Œìš”.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ìì—°ì–´ ìµœì í™” ì…ë ¥ ìƒì„±</title><link href="https://hvppyarchive.github.io/llm/optimization-prompt/" rel="alternate" type="text/html" title="ìì—°ì–´ ìµœì í™” ì…ë ¥ ìƒì„±" /><published>2025-10-19T13:58:04+09:00</published><updated>2025-10-19T13:58:04+09:00</updated><id>https://hvppyarchive.github.io/llm/optimization-prompt</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/optimization-prompt/"><![CDATA[<p class="chat--user">

ìœ ì €ì˜ ìì—°ì–´ë¥¼ ì…ë ¥ ë°›ì•„ì„œ ìµœì í™” íˆ´ì˜ ì…ë ¥ìœ¼ë¡œ ì“¸ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ì£¼ë©´ ì¢‹ê² ì–´. GPT-OSS-120B ëª¨ë¸ì´ì•¼. íˆ´ì˜ ì…ë ¥ì€ ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ì´ì•¼. ** Variables ** Variable | param_name | initValue | scale(linear, log) | Variable Type(Incremental, Discrete, Fixed, Continuous) | Variable Values(ë²”ìœ„, ìŠ¤í…) | Description ** Objectives ** * Syntax &gt; * Objective | Use(True/False) | Goal (Minimize, Maximize..) | Goal Detail (ë²”ìœ„ ë“±ì´ ëª©ì ì´ë©´ ì´ì— ê´€í•œ ì •ë³´) | Weight (1.0) | Description (ì£¼ì„) | Function Detail | Circuit Simulation | verr_abs | each | 0 | input netlist ê²½ë¡œ | fsspice_scope | version ì˜ˆë¥¼ ë“¤ì–´ì„œ â€œr1ê³¼ r2ì˜ ë²”ìœ„ëŠ” 100ë¶€í„° 2000ê¹Œì§€ 10 ë‹¨ìœ„ë¡œ ê°€ëŠ¥í•´, spice netlist ê²½ë¡œëŠ” path/to/netlist.sp ì´ê³ , verr_absë¥¼ ìµœì†Œí™” í•˜ê³  ì‹¶ì–´.â€ ë¼ê³  í–ˆì„ ë•Œ ì´ì— í•´ë‹¹í•˜ëŠ” ìµœì í™” ì…ë ¥ íŒŒì¼ì„ ë§Œë“¤ì–´ì¤¬ìœ¼ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„! â€œìì—°ì–´ â†’ ìµœì í™” íˆ´ ì…ë ¥â€ì„ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ì•„ë˜ì²˜ëŸ¼ ì¤€ë¹„í–ˆì–´. GPT-OSS-120Bì— ê·¸ëŒ€ë¡œ ë„£ì–´ì„œ ì‚¬ìš©í•˜ë©´ ë˜ê³ , ì‚¬ìš© ì˜ˆì‹œ(ë„¤ê°€ ì¤€ ë¬¸ì¥ â†’ ì™„ì„±ëœ ì…ë ¥ íŒŒì¼)ë„ í•¨ê»˜ ë³´ì—¬ì¤„ê²Œ.</p>

<h1 id="1-gpt-oss-120bìš©-ìƒì„±-í”„ë¡¬í”„íŠ¸">1) GPT-OSS-120Bìš© ìƒì„± í”„ë¡¬í”„íŠ¸</h1>

<p>ì•„ë˜ ë¸”ë¡ì„ ì‹œìŠ¤í…œ/ì§€ì‹œ í”„ë¡¬í”„íŠ¸ë¡œ ì‚¬ìš©í•˜ì„¸ìš”. ëª¨ë¸ì€ ì‚¬ìš©ìì˜ í•œêµ­ì–´/ì˜ì–´ ìì—°ì–´ë¥¼ ë°›ì•„, ì •í™•íˆ ì§€ì •í•œ í…Œì´ë¸” í¬ë§·ìœ¼ë¡œë§Œ ê²°ê³¼ë¥¼ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mathematica

ë‹¹ì‹ ì˜ ì—­í• : ìµœì í™” íˆ´ì˜ ì…ë ¥ íŒŒì¼ ìƒì„±ê¸°.
ì…ë ¥: ì‚¬ìš©ìê°€ ìì—°ì–´ë¡œ ë³€ìˆ˜ ë²”ìœ„/ìŠ¤í…/ìŠ¤ì¼€ì¼/ì´ˆê¹ƒê°’, ëª©ì í•¨ìˆ˜(ìµœì†Œ/ìµœëŒ€, ê°€ì¤‘ì¹˜), íšŒë¡œ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •(ë„·ë¦¬ìŠ¤íŠ¸ ê²½ë¡œ ë“±)ì„ ì„¤ëª…í•œë‹¤.
ì¶œë ¥: ì•„ë˜ â€œì¶œë ¥ í˜•ì‹â€ì— ì •ì˜ëœ ë‘ ì„¹ì…˜(** Variables **, ** Objectives **)ì„ ê°€ì§„ ìˆœìˆ˜ í…ìŠ¤íŠ¸ í…Œì´ë¸”. ì„¤ëª…/ì„œë¬¸/í›„ë¬¸/ì¶”ê°€ ì½”ë©˜íŠ¸ ì—†ì´ í•´ë‹¹ ë‘ ì„¹ì…˜ë§Œ ì¶œë ¥í•œë‹¤.

[ì •ê·œí™” ê·œì¹™]
1) ë³€ìˆ˜(Variables)
   - Variable: ë³€ìˆ˜ì˜ í‘œê¸° ì´ë¦„(ì˜ˆ: r1). ëŒ€ì†Œë¬¸ì/ê³µë°±ì€ ì›ë¬¸ì„ ë³´ì¡´í•˜ë˜ ì¼ë°˜ì ìœ¼ë¡œ ì†Œë¬¸ì ê¶Œì¥.
   - param_name: íˆ´ì—ì„œ ì“°ëŠ” íŒŒë¼ë¯¸í„° í‚¤. ë³„ë„ ì§€ì •ì´ ì—†ìœ¼ë©´ Variableê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •.
   - initValue:
       â€¢ ë²”ìœ„ê°€ ì£¼ì–´ì§€ê³  ì´ˆê¹ƒê°’ì´ ì—†ìœ¼ë©´ ì¤‘ê°„ê°’(ì¤‘ì•™ê°’)ì„ ì„¤ì •.
       â€¢ ì´ì‚° ê°’ ì§‘í•©ì´ ì£¼ì–´ì§€ë©´ ì²« ë²ˆì§¸ ê°’ì„ ì„¤ì •.
       â€¢ ê³ ì •(Fixed)ì´ë©´ ê·¸ ê°’ì„ ê·¸ëŒ€ë¡œ ì„¤ì •.
   - scale(linear, log): â€œë¡œê·¸/ëŒ€ìˆ˜/decade/ì§€ìˆ˜/ë°°ìˆ˜/ìŠ¹ìˆ˜/ê³±ì…ˆ ìŠ¤ì¼€ì¼â€ ì–¸ê¸‰ ì‹œ log, ê·¸ ì™¸ì—ëŠ” linear.
   - Variable Type: 
       â€¢ â€œë²”ìœ„ + ìŠ¤í…â€ì´ë©´ Incremental
       â€¢ â€œíŠ¹ì • ê°’ ëª©ë¡â€ì´ë©´ Discrete
       â€¢ â€œê³ ì •â€ì´ë©´ Fixed
       â€¢ â€œì—°ì† ë²”ìœ„(ìŠ¤í… ì—†ìŒ)â€ì´ë©´ Continuous
   - Variable Values(ë²”ìœ„, ìŠ¤í…) í‘œê¸°:
       â€¢ ë²”ìœ„+ìŠ¤í…: â€œstart..end step stepâ€
       â€¢ ì—°ì† ë²”ìœ„: â€œstart..endâ€
       â€¢ ì´ì‚° ëª©ë¡: â€œ{v1, v2, v3, ...}â€
       â€¢ ê³ ì •: í•´ë‹¹ ìˆ˜ì¹˜ 1ê°œë§Œ ê¸°ì…
   - ë‹¨ìœ„ê°€ kÎ©, MÎ© ë“± ì ‘ë‘ì–´ê°€ ìˆìœ¼ë©´ ê¸°ë³¸ ë‹¨ìœ„(ì˜ˆ: Î©)ë¡œ í™˜ì‚°í•˜ì§€ ë§ê³  ê°’ê³¼ ë‹¨ìœ„ë¥¼ ì„¤ëª…ë€(Description)ì— ë‚¨ê¸´ë‹¤. ê°’ ìì²´ëŠ” ì‚¬ìš©ìê°€ ëª…ì‹œí•œ ìˆ˜ì¹˜ë¥¼ ì¡´ì¤‘.

2) ëª©ì (Objectives)
   - Objective: ì§€í‘œ/í•¨ìˆ˜ ì´ë¦„. ì˜ˆ: verr_abs, psrr, gain ë“±.
   - Use(True/False): ì‚¬ìš©ìê°€ í•´ë‹¹ ëª©ì ì„ â€œìµœì†Œí™”/ìµœëŒ€í™”/ëª©í‘œ ë²”ìœ„â€ë¡œ ìš”ì²­í•˜ë©´ True, ì‚¬ìš© ì œì™¸ëŠ” False.
   - Goal: Minimize ë˜ëŠ” Maximize ë˜ëŠ” Range ë“±(ìš”ì²­ì— ë§ì¶¤).
   - Goal Detail: ëª©í‘œê°€ ë²”ìœ„/íƒ€ê¹ƒì´ë©´ ìˆ˜ì¹˜ë‚˜ ì„œìˆ (ì˜ˆ: â€œ0.9â€“1.1Vâ€, â€œ&lt;= 0.01â€) ê¸°ì…. ë‹¨ìˆœ ìµœì†Œ/ìµœëŒ€ë©´ ë¹„ì›Œë‘¬ë„ ë¨.
   - Weight: ê°€ì¤‘ì¹˜. ì–¸ê¸‰ ì—†ìœ¼ë©´ 1.0.
   - Description: í•œêµ­ì–´ë¡œ ê°„ëµ ì£¼ì„.
   - Function Detail ë° ê·¸ í•˜ìœ„ ì—´ì€ ë‹¤ìŒ ìˆœì„œë¡œ ì±„ì›€:
       â€¢ Function Detail: â€œCircuit Simulationâ€ ê³ ì •(íšŒë¡œ ì‹œë®¬ë ˆì´ì…˜ ê¸°ë°˜ì¼ ë•Œ)
       â€¢ Metric: í•´ë‹¹ ì§€í‘œëª…(ì˜ˆ: verr_abs)
       â€¢ Aggregation: each(ê°œë³„ ì¸¡ì •ê°’), mean, max ë“±. ì–¸ê¸‰ ì—†ìœ¼ë©´ each.
       â€¢ Target: ëª©í‘œ ìˆ˜ì¹˜(ìˆì„ ë•Œ). ì—†ìœ¼ë©´ 0 ë˜ëŠ” ê³µë€. Minimizeì¸ ê²½ìš° ì¼ë°˜ì ìœ¼ë¡œ 0.
       â€¢ Netlist Path: ì‚¬ìš©ìê°€ ì œê³µí•œ netlist ê²½ë¡œ(ì˜ˆ: path/to/netlist.sp)
       â€¢ Scope: fsspice_scope ë“± ë„êµ¬ ìŠ¤ì½”í”„. ì–¸ê¸‰ ì—†ìœ¼ë©´ default.
       â€¢ Version: ë²„ì „ ë¬¸ìì—´. ì–¸ê¸‰ ì—†ìœ¼ë©´ latest.
   - ë‹¤ì¤‘ ëª©ì ì´ ì˜¤ë©´ í–‰ì„ ì—¬ëŸ¬ ê°œ ì¶œë ¥í•œë‹¤.

3) ê¸°ë³¸ê°’/í•´ì„
   - ë³€ìˆ˜ ì„¤ëª…ì— ë‹¨ìœ„/ì˜ë„ë¥¼ ê°„ë‹¨íˆ ê¸°ì…(ì˜ˆ: â€œResistor R1 (Î©)â€).
   - ì‚¬ìš©ìê°€ â€œë¡œê·¸ ìŠ¤ì¼€ì¼â€ ë“± ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ linear.
   - ì‚¬ìš©ìê°€ â€œìŠ¤í…â€ì„ ë§í•˜ë©´ Incremental, ìŠ¤í…ì´ ì—†ê³  ê°’ ë‚˜ì—´ì´ë©´ Discrete.
   - ì• ë§¤í•œ ê°’ì€ í•©ë¦¬ì  ê¸°ë³¸ê°’ì„ ì ìš©(ì˜ˆ: Aggregation=each, Weight=1.0, Scope=default, Version=latest).

[ì¶œë ¥ í˜•ì‹]
ì •í™•íˆ ë‹¤ìŒ ë‘ ì„¹ì…˜ì„ ì´ ìˆœì„œë¡œ ì¶œë ¥. í‘œ ì œëª©/í—¤ë”/êµ¬ë¶„ì„ /ì—´ ìˆœì„œë¥¼ ì—„ê²©íˆ ì§€í‚¨ë‹¤.

** Variables **
Variable | param_name | initValue | scale(linear, log) | Variable Type(Incremental, Discrete, Fixed, Continuous) | Variable Values(ë²”ìœ„, ìŠ¤í…) | Description

** Objectives **
Objective | Use(True/False) | Goal (Minimize, Maximize..) | Goal Detail (ë²”ìœ„ ë“±ì´ ëª©ì ì´ë©´ ì´ì— ê´€í•œ ì •ë³´) | Weight (1.0) | Description (ì£¼ì„) | Function Detail | Circuit Simulation | verr_abs | each | 0 | input netlist ê²½ë¡œ | fsspice_scope | version

[ì¶œë ¥ ê·œì¹™]
- ë°˜ë“œì‹œ â€œ** Variables **â€ ì„¹ì…˜ê³¼ â€œ** Objectives **â€ ì„¹ì…˜ë§Œ ì¶œë ¥.
- ì½”ë“œ ë¸”ë¡, ì£¼ì„, ì¶”ê°€ í…ìŠ¤íŠ¸, ë¶ˆë¦¿, ë²ˆí˜¸ ë§¤ê¸°ê¸° ê¸ˆì§€.
- ê³µë€ì´ í•„ìš”í•œ ì¹¸ì€ ë¹ˆ ë¬¸ìì—´ë¡œ ë‘”ë‹¤.
</code></pre></div></div>

<h1 id="2-ì‚¬ìš©-ì˜ˆì‹œë„¤-ë¬¸ì¥--ì™„ì„±-íŒŒì¼">2) ì‚¬ìš© ì˜ˆì‹œ(ë„¤ ë¬¸ì¥ â†’ ì™„ì„± íŒŒì¼)</h1>

<p>ì…ë ¥ ìì—°ì–´<br />
r1ê³¼ r2ì˜ ë²”ìœ„ëŠ” 100ë¶€í„° 2000ê¹Œì§€ 10 ë‹¨ìœ„ë¡œ ê°€ëŠ¥í•´, spice netlist ê²½ë¡œëŠ” path/to/netlist.sp ì´ê³ , verr_absë¥¼ ìµœì†Œí™” í•˜ê³  ì‹¶ì–´.</p>

<p>ëª¨ë¸ ê¸°ëŒ€ ì¶œë ¥</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pgsql

** Variables **
Variable | param_name | initValue | scale(linear, log) | Variable Type(Incremental, Discrete, Fixed, Continuous) | Variable Values(ë²”ìœ„, ìŠ¤í…) | Description
r1 | r1 | 1050 | linear | Incremental | 100..2000 step 10 | Resistor R1 (Î©)
r2 | r2 | 1050 | linear | Incremental | 100..2000 step 10 | Resistor R2 (Î©)

** Objectives **
Objective | Use(True/False) | Goal (Minimize, Maximize..) | Goal Detail (ë²”ìœ„ ë“±ì´ ëª©ì ì´ë©´ ì´ì— ê´€í•œ ì •ë³´) | Weight (1.0) | Description (ì£¼ì„) | Function Detail | Circuit Simulation | verr_abs | each | 0 | input netlist ê²½ë¡œ | fsspice_scope | version
verr_abs | True | Minimize |  | 1.0 | ì ˆëŒ€ ì „ì•• ì˜¤ì°¨ ìµœì†Œí™” | Circuit Simulation | verr_abs | each | 0 | path/to/netlist.sp | default | latest
</code></pre></div></div>

<p>ì„¤ëª…</p>

<ul>
  <li>
    <p>initValueëŠ” ë²”ìœ„ì˜ ì¤‘ì•™ê°’(100ê³¼ 2000ì˜ í‰ê· =1050)ìœ¼ë¡œ ìë™ ì„¤ì •.</p>
  </li>
  <li>
    <p>ìŠ¤ì¼€ì¼ ì–¸ê¸‰ì´ ì—†ìœ¼ë¯€ë¡œ linear.</p>
  </li>
  <li>
    <p>ë²”ìœ„+ìŠ¤í…ì´ë¯€ë¡œ Variable Typeì€ Incremental, í‘œê¸°ëŠ” â€œstart..end step stepâ€.</p>
  </li>
  <li>
    <p>Objectivesì˜ Function Detail í•˜ìœ„ í•„ë“œë“¤ì€ ê·œì¹™ì— ë”°ë¼ ì±„ì›€:</p>

    <ul>
      <li>
        <p>Circuit Simulation: ê³ ì • ë¬¸ìì—´</p>
      </li>
      <li>
        <p>Metric: verr_abs</p>
      </li>
      <li>
        <p>Aggregation: each(ê¸°ë³¸)</p>
      </li>
      <li>
        <p>Target: Minimizeì˜ ê¸°ë³¸ íƒ€ê¹ƒ 0</p>
      </li>
      <li>
        <p>Netlist Path: path/to/netlist.sp</p>
      </li>
      <li>
        <p>Scope: default</p>
      </li>
      <li>
        <p>Version: latest</p>
      </li>
    </ul>
  </li>
</ul>

<h1 id="3-ë¹ ë¥¸-ì ìš©-ì ˆì°¨">3) ë¹ ë¥¸ ì ìš© ì ˆì°¨</h1>

<ol>
  <li>
    <p>ìœ„ â€œGPT-OSS-120Bìš© ìƒì„± í”„ë¡¬í”„íŠ¸â€ë¥¼ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¡œ ì„¤ì •.</p>
  </li>
  <li>
    <p>ì‚¬ìš©ìì˜ ìì—°ì–´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œ ë„£ìŒ.</p>
  </li>
  <li>
    <p>ëª¨ë¸ì´ ì¶œë ¥í•œ ë‘ ì„¹ì…˜ì„ íŒŒì¼ì— ì €ì¥í•˜ì—¬ ìµœì í™” íˆ´ì˜ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©.</p>
  </li>
</ol>

<h1 id="4-í™•ì¥-íŒ">4) í™•ì¥ íŒ</h1>

<ul>
  <li>
    <p>ë‹¤ë³€ìˆ˜: ë³€ìˆ˜ ë¬¸ì¥ì´ ì—¬ëŸ¬ ê°œë©´ Variables í‘œì— í–‰ì„ ê³„ì† ì¶”ê°€.</p>
  </li>
  <li>
    <p>ì´ì‚° ëª©ë¡: â€œr3ëŠ” {10, 22, 47, 100} ì¤‘ ì„ íƒâ€ â†’ Variable Type=Discrete, Variable Values={10, 22, 47, 100}.</p>
  </li>
  <li>
    <p>ê³ ì •ê°’: â€œr4ëŠ” 1kÎ©ë¡œ ê³ ì •â€ â†’ Variable Type=Fixed, Variable Values=1000, initValue=1000, Descriptionì— â€œ(1 kÎ©)â€ í‘œê¸°.</p>
  </li>
  <li>
    <p>ì—°ì†ë²”ìœ„: â€œc1ì€ 1pF~10pFâ€ â†’ Variable Type=Continuous, Variable Values=1pF..10pF, ìŠ¤í… ê³µë€.</p>
  </li>
  <li>
    <p>ë¡œê·¸ìŠ¤ì¼€ì¼: â€œc1ì€ ë¡œê·¸ ìŠ¤ì¼€ì¼â€ ë¬¸êµ¬ê°€ ìˆìœ¼ë©´ scale=log.</p>
  </li>
  <li>
    <p>ë‹¤ì¤‘ ëª©ì : ê° ëª©ì ë§ˆë‹¤ Objectives í–‰ì„ ì¶”ê°€í•˜ê³  Weightë¥¼ ì›í•˜ëŠ” ë¹„ìœ¨ë¡œ ê¸°ì…. Range ëª©í‘œëŠ” Goal=Range, Goal Detailì— ìˆ˜ì¹˜ ë²”ìœ„ë¥¼ ì±„ì›€.</p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ ë„¤ê°€ ì“°ëŠ” íˆ´ì˜ ì‹¤ì œ ìŠ¤ì½”í”„/ë²„ì „ í•„ë“œëª…ì— ë§ê²Œ Scope/Version ê¸°ë³¸ê°’ í‚¤ì›Œë“œë¥¼ ë°”ê¿”ì¤„ ìˆ˜ë„ ìˆì–´. ì´ì œ ì´ í”„ë¡¬í”„íŠ¸ë¡œ ì•„ë¬´ ìì—°ì–´ë¥¼ ë„£ì–´ë„ ì›í•˜ëŠ” ì…ë ¥ íŒŒì¼ì„ ì•ˆì •ì ìœ¼ë¡œ ìƒì„±í•  ìˆ˜ ìˆì„ ê±°ì•¼.</p>

<p class="chat--user">

ì˜ì–´ë¡œë„ í•œ ë²ˆ ì¨ì¤„ë˜?

</p>

<p>Greatâ€”hereâ€™s the same setup in English.</p>

<h1 id="1-generation-prompt-for-gpt-oss-120b">1) Generation prompt for GPT-OSS-120B</h1>

<p>Use the block below as a system/instruction prompt. The model will take the userâ€™s natural language (KR/EN) and output exactly the specified table formatâ€”nothing else.</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Your</span> <span class="n">role</span><span class="p">:</span> <span class="n">Generator</span> <span class="n">of</span> <span class="n">an</span> <span class="n">optimization</span> <span class="n">tool</span> <span class="n">input</span> <span class="n">file</span><span class="p">.</span>
<span class="n">Input</span><span class="p">:</span> <span class="n">The</span> <span class="n">user</span> <span class="n">describes</span> <span class="nf">variables</span> <span class="p">(</span><span class="n">range</span><span class="p">/</span><span class="n">step</span><span class="p">/</span><span class="n">scale</span><span class="p">/</span><span class="k">init</span><span class="p">),</span> <span class="nf">objectives</span> <span class="p">(</span><span class="n">min</span><span class="p">/</span><span class="n">max</span><span class="p">/</span><span class="n">target</span><span class="p">,</span> <span class="n">weight</span><span class="p">),</span> <span class="k">and</span> <span class="n">circuit</span> <span class="n">simulation</span> <span class="nf">settings</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="n">netlist</span> <span class="n">path</span><span class="p">)</span> <span class="k">in</span> <span class="n">natural</span> <span class="n">language</span><span class="p">.</span>
<span class="n">Output</span><span class="p">:</span> <span class="n">Exactly</span> <span class="n">two</span> <span class="nf">sections</span> <span class="p">(</span><span class="err">â€œ</span><span class="p">**</span> <span class="n">Variables</span> <span class="p">**</span><span class="err">â€</span><span class="p">,</span> <span class="err">â€œ</span><span class="p">**</span> <span class="n">Objectives</span> <span class="p">**</span><span class="err">â€</span><span class="p">)</span> <span class="k">as</span> <span class="n">plain</span> <span class="n">text</span> <span class="n">tables</span> <span class="k">in</span> <span class="n">the</span> <span class="n">format</span> <span class="n">below</span><span class="p">.</span> <span class="n">Do</span> <span class="k">not</span> <span class="k">add</span> <span class="n">any</span> <span class="n">preface</span><span class="p">/</span><span class="n">postscript</span><span class="p">/</span><span class="n">comments</span><span class="err">â€”</span><span class="n">output</span> <span class="n">only</span> <span class="n">those</span> <span class="n">two</span> <span class="n">sections</span><span class="p">.</span>

<span class="p">[</span><span class="n">Normalization</span> <span class="n">rules</span><span class="p">]</span>
<span class="m">1</span><span class="p">)</span> <span class="n">Variables</span>
   <span class="p">-</span> <span class="n">Variable</span><span class="p">:</span> <span class="n">display</span> <span class="nf">name</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="n">r1</span><span class="p">).</span> <span class="n">Preserve</span> <span class="n">user</span> <span class="n">casing</span><span class="p">/</span><span class="n">spaces</span><span class="p">;</span> <span class="n">lowercase</span> <span class="k">is</span> <span class="n">recommended</span><span class="p">.</span>
   <span class="p">-</span> <span class="n">param_name</span><span class="p">:</span> <span class="n">tool</span> <span class="n">parameter</span> <span class="n">key</span><span class="p">.</span> <span class="n">If</span> <span class="k">not</span> <span class="n">specified</span><span class="p">,</span> <span class="k">set</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">Variable</span><span class="p">.</span>
   <span class="p">-</span> <span class="n">initValue</span><span class="p">:</span>
       <span class="err">â€¢</span> <span class="n">If</span> <span class="n">a</span> <span class="n">range</span> <span class="k">is</span> <span class="n">given</span> <span class="k">and</span> <span class="n">no</span> <span class="k">init</span> <span class="k">is</span> <span class="n">provided</span><span class="p">,</span> <span class="k">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">midpoint</span><span class="p">.</span>
       <span class="err">â€¢</span> <span class="n">If</span> <span class="n">a</span> <span class="n">discrete</span> <span class="k">set</span> <span class="k">is</span> <span class="n">given</span><span class="p">,</span> <span class="k">set</span> <span class="n">to</span> <span class="n">its</span> <span class="n">first</span> <span class="k">value</span><span class="p">.</span>
       <span class="err">â€¢</span> <span class="n">If</span> <span class="n">Fixed</span><span class="p">,</span> <span class="k">set</span> <span class="n">to</span> <span class="n">that</span> <span class="k">fixed</span> <span class="k">value</span><span class="p">.</span>
   <span class="p">-</span> <span class="nf">scale</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span> <span class="k">set</span> <span class="n">to</span> <span class="n">log</span> <span class="k">if</span> <span class="n">the</span> <span class="n">user</span> <span class="n">mentions</span> <span class="err">â€œ</span><span class="n">log</span><span class="p">/</span><span class="n">logarithmic</span><span class="p">/</span><span class="n">decade</span><span class="p">/</span><span class="n">exponential</span><span class="p">/</span><span class="n">multiplicative</span><span class="err">â€</span><span class="p">;</span> <span class="n">otherwise</span> <span class="n">linear</span><span class="p">.</span>
   <span class="p">-</span> <span class="n">Variable</span> <span class="n">Type</span><span class="p">:</span>
       <span class="err">â€¢</span> <span class="n">Range</span> <span class="p">+</span> <span class="n">step</span> <span class="err">â†’</span> <span class="n">Incremental</span>
       <span class="err">â€¢</span> <span class="n">Specific</span> <span class="k">value</span> <span class="n">list</span> <span class="err">â†’</span> <span class="n">Discrete</span>
       <span class="err">â€¢</span> <span class="n">Fixed</span> <span class="k">value</span> <span class="err">â†’</span> <span class="n">Fixed</span>
       <span class="err">â€¢</span> <span class="n">Continuous</span> <span class="nf">range</span> <span class="p">(</span><span class="n">no</span> <span class="n">step</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">Continuous</span>
   <span class="p">-</span> <span class="n">Variable</span> <span class="nf">Values</span> <span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="n">notation</span><span class="p">:</span>
       <span class="err">â€¢</span> <span class="n">Range</span> <span class="p">+</span> <span class="n">step</span><span class="p">:</span> <span class="err">â€œ</span><span class="n">start</span><span class="p">..</span><span class="n">end</span> <span class="n">step</span> <span class="n">step</span><span class="err">â€</span>
       <span class="err">â€¢</span> <span class="n">Continuous</span> <span class="n">range</span><span class="p">:</span> <span class="err">â€œ</span><span class="n">start</span><span class="p">..</span><span class="n">end</span><span class="err">â€</span>
       <span class="err">â€¢</span> <span class="n">Discrete</span> <span class="k">set</span><span class="p">:</span> <span class="err">â€œ</span><span class="p">{</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="p">...}</span><span class="err">â€</span>
       <span class="err">â€¢</span> <span class="n">Fixed</span><span class="p">:</span> <span class="n">write</span> <span class="n">the</span> <span class="n">single</span> <span class="n">numeric</span> <span class="k">value</span>
   <span class="p">-</span> <span class="n">If</span> <span class="n">units</span> <span class="n">like</span> <span class="n">k</span><span class="err">Î©</span><span class="p">/</span><span class="n">M</span><span class="err">Î©</span> <span class="n">are</span> <span class="n">given</span><span class="p">,</span> <span class="k">do</span> <span class="k">not</span> <span class="n">convert</span> <span class="n">to</span> <span class="k">base</span> <span class="n">units</span><span class="p">;</span> <span class="n">keep</span> <span class="n">the</span> <span class="n">numeric</span> <span class="k">as</span> <span class="n">entered</span> <span class="k">and</span> <span class="n">note</span> <span class="n">units</span> <span class="k">in</span> <span class="n">Description</span><span class="p">.</span>

<span class="m">2</span><span class="p">)</span> <span class="n">Objectives</span>
   <span class="p">-</span> <span class="n">Objective</span><span class="p">:</span> <span class="n">metric</span><span class="p">/</span><span class="n">function</span> <span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="n">verr_abs</span><span class="p">,</span> <span class="n">psrr</span><span class="p">,</span> <span class="n">gain</span><span class="p">.</span>
   <span class="p">-</span> <span class="nf">Use</span><span class="p">(</span><span class="n">True</span><span class="p">/</span><span class="n">False</span><span class="p">):</span> <span class="n">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">user</span> <span class="n">asks</span> <span class="n">to</span> <span class="n">minimize</span><span class="p">/</span><span class="n">maximize</span><span class="p">/</span><span class="n">target</span><span class="p">-</span><span class="n">range</span> <span class="k">this</span> <span class="n">metric</span><span class="p">;</span> <span class="n">False</span> <span class="k">if</span> <span class="n">excluded</span><span class="p">.</span>
   <span class="p">-</span> <span class="n">Goal</span><span class="p">:</span> <span class="n">Minimize</span> <span class="p">/</span> <span class="n">Maximize</span> <span class="p">/</span> <span class="nf">Range</span> <span class="p">(</span><span class="k">as</span> <span class="n">requested</span><span class="p">).</span>
   <span class="p">-</span> <span class="n">Goal</span> <span class="n">Detail</span><span class="p">:</span> <span class="n">numeric</span> <span class="n">range</span><span class="p">/</span><span class="n">target</span> <span class="n">info</span> <span class="k">when</span> <span class="nf">applicable</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="err">â€œ</span><span class="m">0.9</span><span class="err">â€“</span><span class="m">1.1</span> <span class="n">V</span><span class="err">â€</span><span class="p">,</span> <span class="err">â€œ</span><span class="p">&lt;=</span> <span class="m">0.01</span><span class="err">â€</span><span class="p">);</span> <span class="n">may</span> <span class="n">be</span> <span class="n">blank</span> <span class="k">for</span> <span class="n">simple</span> <span class="n">min</span><span class="p">/</span><span class="n">max</span><span class="p">.</span>
   <span class="p">-</span> <span class="n">Weight</span><span class="p">:</span> <span class="k">default</span> <span class="m">1.0</span> <span class="k">if</span> <span class="n">unspecified</span><span class="p">.</span>
   <span class="p">-</span> <span class="n">Description</span><span class="p">:</span> <span class="kt">short</span> <span class="n">comment</span> <span class="k">in</span> <span class="n">Korean</span> <span class="k">or</span> <span class="n">English</span><span class="p">.</span>
   <span class="p">-</span> <span class="n">Fill</span> <span class="n">the</span> <span class="n">following</span> <span class="n">columns</span> <span class="n">after</span> <span class="n">Description</span> <span class="k">in</span> <span class="k">this</span> <span class="n">order</span><span class="p">:</span>
       <span class="err">â€¢</span> <span class="n">Function</span> <span class="n">Detail</span><span class="p">:</span> <span class="err">â€œ</span><span class="n">Circuit</span> <span class="n">Simulation</span><span class="err">â€</span> <span class="p">(</span><span class="k">when</span> <span class="n">based</span> <span class="k">on</span> <span class="n">a</span> <span class="n">circuit</span> <span class="n">sim</span><span class="p">)</span>
       <span class="err">â€¢</span> <span class="n">Metric</span><span class="p">:</span> <span class="n">the</span> <span class="n">metric</span> <span class="nf">name</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="n">verr_abs</span><span class="p">)</span>
       <span class="err">â€¢</span> <span class="n">Aggregation</span><span class="p">:</span> <span class="n">each</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">etc</span><span class="p">.;</span> <span class="k">default</span> <span class="n">each</span>
       <span class="err">â€¢</span> <span class="n">Target</span><span class="p">:</span> <span class="n">numeric</span> <span class="n">target</span> <span class="k">if</span> <span class="n">any</span><span class="p">;</span> <span class="k">else</span> <span class="m">0</span> <span class="k">for</span> <span class="n">Minimize</span> <span class="k">or</span> <span class="n">blank</span>
       <span class="err">â€¢</span> <span class="n">Netlist</span> <span class="n">Path</span><span class="p">:</span> <span class="n">the</span> <span class="n">provided</span> <span class="n">netlist</span> <span class="nf">path</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">netlist</span><span class="p">.</span><span class="n">sp</span><span class="p">)</span>
       <span class="err">â€¢</span> <span class="n">Scope</span><span class="p">:</span> <span class="n">tool</span> <span class="n">scope</span><span class="p">,</span> <span class="k">default</span> <span class="err">â€œ</span><span class="k">default</span><span class="err">â€</span> <span class="k">if</span> <span class="n">unspecified</span>
       <span class="err">â€¢</span> <span class="n">Version</span><span class="p">:</span> <span class="n">version</span> <span class="kt">string</span><span class="p">,</span> <span class="k">default</span> <span class="err">â€œ</span><span class="n">latest</span><span class="err">â€</span> <span class="k">if</span> <span class="n">unspecified</span>
   <span class="p">-</span> <span class="n">For</span> <span class="n">multiple</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">output</span> <span class="n">multiple</span> <span class="n">rows</span><span class="p">.</span>

<span class="m">3</span><span class="p">)</span> <span class="n">Defaults</span><span class="p">/</span><span class="n">interpretation</span>
   <span class="p">-</span> <span class="n">Put</span> <span class="n">concise</span> <span class="n">unit</span><span class="p">/</span><span class="n">intent</span> <span class="n">notes</span> <span class="k">in</span> <span class="nf">Description</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="err">â€œ</span><span class="n">Resistor</span> <span class="nf">R1</span> <span class="p">(</span><span class="err">Î©</span><span class="p">)</span><span class="err">â€</span><span class="p">).</span>
   <span class="p">-</span> <span class="n">Scale</span> <span class="n">defaults</span> <span class="n">to</span> <span class="n">linear</span> <span class="n">unless</span> <span class="n">stated</span> <span class="n">otherwise</span><span class="p">.</span>
   <span class="p">-</span> <span class="n">If</span> <span class="n">a</span> <span class="n">step</span> <span class="k">is</span> <span class="n">specified</span> <span class="err">â†’</span> <span class="n">Incremental</span><span class="p">;</span> <span class="n">a</span> <span class="n">list</span> <span class="n">of</span> <span class="n">values</span> <span class="err">â†’</span> <span class="n">Discrete</span><span class="p">.</span>
   <span class="p">-</span> <span class="n">Reasonable</span> <span class="n">defaults</span><span class="p">:</span> <span class="n">Aggregation</span><span class="p">=</span><span class="n">each</span><span class="p">,</span> <span class="n">Weight</span><span class="p">=</span><span class="m">1.0</span><span class="p">,</span> <span class="n">Scope</span><span class="p">=</span><span class="k">default</span><span class="p">,</span> <span class="n">Version</span><span class="p">=</span><span class="n">latest</span><span class="p">.</span>

<span class="p">[</span><span class="n">Output</span> <span class="n">format</span><span class="p">]</span>
<span class="n">Print</span> <span class="n">exactly</span> <span class="n">these</span> <span class="n">two</span> <span class="n">sections</span> <span class="k">in</span> <span class="k">this</span> <span class="n">order</span><span class="p">.</span> <span class="n">Keep</span> <span class="n">titles</span><span class="p">/</span><span class="n">headers</span><span class="p">/</span><span class="n">separators</span><span class="p">/</span><span class="n">column</span> <span class="n">order</span> <span class="n">exactly</span><span class="p">.</span>

<span class="p">**</span> <span class="n">Variables</span> <span class="p">**</span>
<span class="n">Variable</span> <span class="p">|</span> <span class="n">param_name</span> <span class="p">|</span> <span class="n">initValue</span> <span class="p">|</span> <span class="nf">scale</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span> <span class="p">|</span> <span class="n">Variable</span> <span class="nf">Type</span><span class="p">(</span><span class="n">Incremental</span><span class="p">,</span> <span class="n">Discrete</span><span class="p">,</span> <span class="n">Fixed</span><span class="p">,</span> <span class="n">Continuous</span><span class="p">)</span> <span class="p">|</span> <span class="n">Variable</span> <span class="nf">Values</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="p">|</span> <span class="n">Description</span>

<span class="p">**</span> <span class="n">Objectives</span> <span class="p">**</span>
<span class="n">Objective</span> <span class="p">|</span> <span class="nf">Use</span><span class="p">(</span><span class="n">True</span><span class="p">/</span><span class="n">False</span><span class="p">)</span> <span class="p">|</span> <span class="nf">Goal</span> <span class="p">(</span><span class="n">Minimize</span><span class="p">,</span> <span class="n">Maximize</span><span class="p">..)</span> <span class="p">|</span> <span class="n">Goal</span> <span class="nf">Detail</span> <span class="p">(</span><span class="n">range</span><span class="p">/</span><span class="n">target</span> <span class="n">info</span> <span class="k">if</span> <span class="n">applicable</span><span class="p">)</span> <span class="p">|</span> <span class="nf">Weight</span> <span class="p">(</span><span class="m">1.0</span><span class="p">)</span> <span class="p">|</span> <span class="nf">Description</span> <span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="p">|</span> <span class="n">Function</span> <span class="n">Detail</span> <span class="p">|</span> <span class="n">Circuit</span> <span class="n">Simulation</span> <span class="p">|</span> <span class="n">verr_abs</span> <span class="p">|</span> <span class="n">each</span> <span class="p">|</span> <span class="m">0</span> <span class="p">|</span> <span class="n">input</span> <span class="n">netlist</span> <span class="n">path</span> <span class="p">|</span> <span class="n">fsspice_scope</span> <span class="p">|</span> <span class="n">version</span>

<span class="p">[</span><span class="n">Output</span> <span class="n">rules</span><span class="p">]</span>
<span class="p">-</span> <span class="n">Output</span> <span class="n">only</span> <span class="n">the</span> <span class="err">â€œ</span><span class="p">**</span> <span class="n">Variables</span> <span class="p">**</span><span class="err">â€</span> <span class="n">section</span> <span class="k">and</span> <span class="n">the</span> <span class="err">â€œ</span><span class="p">**</span> <span class="n">Objectives</span> <span class="p">**</span><span class="err">â€</span> <span class="n">section</span><span class="p">.</span>
<span class="p">-</span> <span class="n">No</span> <span class="n">extra</span> <span class="n">code</span> <span class="n">fences</span> <span class="n">around</span> <span class="n">each</span> <span class="n">section</span><span class="p">,</span> <span class="n">no</span> <span class="n">comments</span><span class="p">,</span> <span class="n">no</span> <span class="n">bullets</span><span class="p">,</span> <span class="n">no</span> <span class="n">numbering</span><span class="p">.</span>
<span class="p">-</span> <span class="n">Leave</span> <span class="n">empty</span> <span class="n">cells</span> <span class="k">as</span> <span class="n">an</span> <span class="n">empty</span> <span class="kt">string</span><span class="p">.</span>
</code></pre></div></div>

<h1 id="2-example-your-sentence--completed-file">2) Example (your sentence â†’ completed file)</h1>

<p>Natural-language input<br />
r1 and r2 can range from 100 to 2000 with step 10, the SPICE netlist path is path/to/netlist.sp, and I want to minimize verr_abs.</p>

<p>Model expected output</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pgsql

** Variables **
Variable | param_name | initValue | scale(linear, log) | Variable Type(Incremental, Discrete, Fixed, Continuous) | Variable Values(range, step) | Description
r1 | r1 | 1050 | linear | Incremental | 100..2000 step 10 | Resistor R1 (Î©)
r2 | r2 | 1050 | linear | Incremental | 100..2000 step 10 | Resistor R2 (Î©)

** Objectives **
Objective | Use(True/False) | Goal (Minimize, Maximize..) | Goal Detail (range/target info if applicable) | Weight (1.0) | Description (comment) | Function Detail | Circuit Simulation | verr_abs | each | 0 | input netlist path | fsspice_scope | version
verr_abs | True | Minimize |  | 1.0 | Minimize absolute voltage error | Circuit Simulation | verr_abs | each | 0 | path/to/netlist.sp | default | latest
</code></pre></div></div>

<p>Notes</p>

<ul>
  <li>
    <p>initValue is the midpoint of 100 and 2000, i.e., 1050.</p>
  </li>
  <li>
    <p>Linear scale by default.</p>
  </li>
  <li>
    <p>Range + step â†’ Variable Type = Incremental; notation â€œstart..end step stepâ€.</p>
  </li>
  <li>
    <p>Objective details follow the rule order: Function Detail, Metric, Aggregation, Target, Netlist Path, Scope, Version.</p>
  </li>
</ul>

<h1 id="3-quick-how-to">3) Quick how-to</h1>

<ol>
  <li>
    <p>Set the â€œGeneration prompt for GPT-OSS-120Bâ€ above as the system prompt.</p>
  </li>
  <li>
    <p>Feed the userâ€™s natural-language request as the user message.</p>
  </li>
  <li>
    <p>Save the modelâ€™s two-section output as the optimization input file.</p>
  </li>
</ol>

<h1 id="4-extra-tips">4) Extra tips</h1>

<ul>
  <li>
    <p>Multiple variables: add more rows under Variables.</p>
  </li>
  <li>
    <p>Discrete list: â€œr3 is one of {10, 22, 47, 100}â€ â†’ Variable Type=Discrete, Variable Values={10, 22, 47, 100}.</p>
  </li>
  <li>
    <p>Fixed value: â€œr4 is fixed at 1 kÎ©â€ â†’ Variable Type=Fixed, Variable Values=1000, initValue=1000, and note â€œ(1 kÎ©)â€ in Description.</p>
  </li>
  <li>
    <p>Continuous range: â€œc1 is 1 pF to 10 pFâ€ â†’ Variable Type=Continuous, Variable Values=1 pF..10 pF (no step).</p>
  </li>
  <li>
    <p>Log scale: if the user mentions logarithmic/decade, set scale=log.</p>
  </li>
  <li>
    <p>Multiple objectives: one row per metric; adjust Weight as needed. Range goals use Goal=Range with numeric bounds in Goal Detail.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">vLLM íˆ´ í˜¸ì¶œ ì˜ˆì œ</title><link href="https://hvppyarchive.github.io/llm/vllm-responses/" rel="alternate" type="text/html" title="vLLM íˆ´ í˜¸ì¶œ ì˜ˆì œ" /><published>2025-10-19T11:47:56+09:00</published><updated>2025-10-19T11:47:56+09:00</updated><id>https://hvppyarchive.github.io/llm/vllm-responses</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/vllm-responses/"><![CDATA[<p class="chat--user">

vLLM(GPT-OSS-120B) + openai responses íŒŒì´ì¬ íŒ¨í‚¤ì§€ë¥¼ ì´ìš©í•´ì„œ í†µì‹ í•˜ëŠ” ì˜ˆì œ ì‘ì„±í•´ì¤˜. ì´ ë•Œ tool callingì„ í•´ì•¼í•´(harmony í˜•ì‹ ì§€ì›). ë‹¤ìŒì˜ tool ì„ ì§€ì›í•˜ë„ë¡ í•´ì¤˜ 1. í´ë” ë‚´ì˜ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ 2. ë‹¨ì¼ íŒŒì¼ ì½ê¸°

</p>

<p>ì¢‹ì•„ìš”! vLLMìœ¼ë¡œ GPT-OSS-120Bë¥¼ ë„ìš°ê³ , Pythonìš© OpenAI SDKì˜ Responses APIë¡œ â€œharmony í˜•ì‹ + tool callingâ€ì„ ì‚¬ìš©í•˜ëŠ” ìµœì†ŒÂ·ì™„ì „ ì˜ˆì œë¥¼ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”. ìš”êµ¬í•˜ì‹  ë‘ ê°€ì§€ íˆ´(í´ë” ëª©ë¡ ì¡°íšŒ, ë‹¨ì¼ íŒŒì¼ ì½ê¸°)ì„ ì •ì˜í•˜ê³ , ëª¨ë¸ì´ íˆ´ì„ í˜¸ì¶œí•˜ë©´ ì‹¤ì œ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•œ ë’¤ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— ë„˜ê²¨ ìµœì¢… ë‹µì„ ë°›ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>vLLM ì„œë²„ ì‹¤í–‰(ì˜¤í”ˆAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸)</li>
</ol>

<ul>
  <li>vLLMì€ OpenAI-compatible ì„œë²„ë¥¼ ì œê³µí•˜ë¯€ë¡œ SDKì˜ <code class="language-plaintext highlighter-rouge">base_url</code>ë§Œ ë°”ê¿”ì„œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆì‹œì²˜ëŸ¼ gpt-oss-120b ëª¨ë¸ì„ ì„œë¹™í•˜ì„¸ìš”. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># vLLM ì„¤ì¹˜ ë° ì„œë²„ ê¸°ë™(ê³µì‹ ê°€ì´ë“œì— ë§ì¶¤)</span>
<span class="c"># ì°¸ê³ : gpt-ossëŠ” vLLMì—ì„œ Responses APIì™€ Chat Completions API ë‘˜ ë‹¤ ì§€ì›í•©ë‹ˆë‹¤.</span>
vllm serve openai/gpt-oss-120b
<span class="c"># ì„œë²„ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ http://localhost:8000/v1 ì—ì„œ OpenAI í˜¸í™˜ APIë¥¼ ì—½ë‹ˆë‹¤.</span>
</code></pre></div></div>

<ol>
  <li>í•µì‹¬ ì•„ì´ë””ì–´(íˆ´ í˜¸ì¶œ ë£¨í”„)</li>
</ol>

<ul>
  <li>
    <p>Responses APIë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´ <code class="language-plaintext highlighter-rouge">output</code> ë°°ì—´ì— í•­ëª©ë“¤ì´ ë“¤ì–´ì˜¤ëŠ”ë°, ê·¸ì¤‘ <code class="language-plaintext highlighter-rouge">type == "function_call"</code>ì¸ í•­ëª©ì´ ìˆìœ¼ë©´ í•´ë‹¹ í•¨ìˆ˜ë¥¼ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•˜ê³ , ê²°ê³¼ë¥¼ <code class="language-plaintext highlighter-rouge">tool_outputs</code>ë¡œ ë‹¤ì‹œ <code class="language-plaintext highlighter-rouge">responses.create</code>ì— ë„˜ê²¨ í›„ì† ì¶”ë¡ ì„ ì´ì–´ê°‘ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">previous_response_id</code>ë¥¼ ì‚¬ìš©í•´ ì§ì „ í„´ê³¼ ì—°ê²°í•©ë‹ˆë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>GPT-OSS ê³„ì—´ì€ Harmony ì‘ë‹µ í¬ë§·ì„ ì‚¬ìš©í•˜ë„ë¡ í•™ìŠµë˜ì–´ ìˆìœ¼ë©°, vLLM + OpenAI SDK ì¡°í•©ì„ ì“°ë©´ ë³„ë„ í¬ë§· ì²˜ë¦¬ ì—†ì´ ê·¸ëŒ€ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ì§ì ‘ í† í° ë ˆë²¨ ì œì–´ê°€ í•„ìš”í•  ë•Œë§Œ Harmony SDKë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
  <li>
    <p>vLLMì€ Responses APIì™€ íˆ´ í˜¸ì¶œì„ ì§€ì›í•˜ë¯€ë¡œ ì´ ì½”ë“œê°€ ê·¸ëŒ€ë¡œ ì‘ë™í•©ë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
</ul>

<ol>
  <li>íŒŒì´ì¬ ì˜ˆì œ ì½”ë“œ(íˆ´ 2ì¢…: í´ë” ëª©ë¡, íŒŒì¼ ì½ê¸°)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install openai
# í™˜ê²½: vLLM OpenAI-compatible ì„œë²„ê°€ localhost:8000/v1 ì—ì„œ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># 0) OpenAI í´ë¼ì´ì–¸íŠ¸: vLLM í˜¸í™˜ ì„œë²„ë¡œ ì§€ì •
</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span>
    <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># vLLM OpenAI-compatible ì„œë²„
</span>    <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">EMPTY</span><span class="sh">"</span>                       <span class="c1"># vLLM ê¸°ë³¸ í† í°(ê²€ì¦ ì•ˆí•¨). í•„ìš”ì‹œ ì„ì˜ ë¬¸ìì—´
</span><span class="p">)</span>

<span class="c1"># 1) ì‹¤ì œë¡œ ì‹¤í–‰ë  ë¡œì»¬ í•¨ìˆ˜ë“¤(íˆ´ êµ¬í˜„)
</span><span class="k">def</span> <span class="nf">list_directory</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Directory not found: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">is_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">child</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="n">child</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200_000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># í…ìŠ¤íŠ¸ íŒŒì¼ ê°€ì •. ì´ì§„ íŒŒì¼ì´ë©´ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ â†’ errors='replace'
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">max_bytes</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">... [truncated]</span><span class="sh">"</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># 2) íˆ´ ìŠ¤í‚¤ë§ˆ ì •ì˜(Harmony/Responsesìš© function tool)
</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_directory</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files and folders in a directory.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Target directory path</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a text file from disk.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Target file path</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Max characters to return</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200000</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># ë¡œì»¬ í•¨ìˆ˜ ë””ìŠ¤íŒ¨ì²˜
</span><span class="n">FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">list_directory</span><span class="sh">"</span><span class="p">:</span> <span class="n">list_directory</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_file</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">extract_function_calls</span><span class="p">(</span><span class="n">response_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses APIì˜ ì‘ë‹µì—ì„œ function_call í•­ëª©ì„ ì¶”ì¶œ.
    SDK ë²„ì „ë§ˆë‹¤ íƒ€ì… í´ë˜ìŠ¤ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ dictë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬.
    ê° í•­ëª©: { </span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">: dict }
    </span><span class="sh">"""</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response_obj</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">response_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">response_obj</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">call_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># argumentsëŠ” dict ì´ê±°ë‚˜ JSON stringì¼ ìˆ˜ ìˆìŒ
</span>            <span class="n">raw_args</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_tool_call</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    í•´ë‹¹ íˆ´ì„ ì‹¤ì œ ì‹¤í–‰í•˜ê³ , ë¬¸ìì—´(JSON)ë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜.
    ëª¨ë¸ë¡œ ëŒë ¤ë³´ë‚¼ ë•ŒëŠ” ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">FUNCTIONS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown function: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">})</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">fn</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># ì˜ëª»ëœ ì¸ì ë“±
</span>        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bad arguments for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">respond_with_tools</span><span class="p">(</span><span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">openai/gpt-oss-120b</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    1) ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œ ì‘ë‹µ ìƒì„± ì‹œë„
    2) íˆ´ í˜¸ì¶œì´ ë‚˜ì˜¤ë©´ ì‹¤ì œ ì‹¤í–‰ â†’ tool_outputs ë¡œ ì¬í˜¸ì¶œ
    3) ë” ì´ìƒ íˆ´ í˜¸ì¶œì´ ì—†ì„ ë•Œ ìµœì¢… í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜
    </span><span class="sh">"""</span>
    <span class="n">prev_id</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prev_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># ì²« í„´: ì‚¬ìš©ì ì…ë ¥ì„ ë³´ëƒ„
</span>            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">user_prompt</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ë‘ ë²ˆì§¸ í„´ë¶€í„°ëŠ” tool_outputsë§Œ ë„˜ê¸°ê³  ì´ì–´ì„œ ì¶”ë¡ 
</span>            <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">previous_response_id</span><span class="o">=</span><span class="n">prev_id</span><span class="p">,</span>
                <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>  <span class="c1"># ì§ì „ ë£¨í”„ì—ì„œ ì¤€ë¹„
</span>            <span class="p">)</span>

        <span class="c1"># íˆ´ í˜¸ì¶œì´ ìˆëŠ”ì§€ í™•ì¸
</span>        <span class="n">calls</span> <span class="o">=</span> <span class="nf">extract_function_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="c1"># ìµœì¢… ë‹µë³€
</span>            <span class="c1"># Responses SDKëŠ” í¸ì˜ í”„ë¡œí¼í‹°ë¡œ output_text ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">final_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">output_text</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># í˜¸í™˜ì„± ëŒ€ë¹„
</span>                <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">resp</span>
                <span class="c1"># output ë°°ì—´ì—ì„œ assistant í…ìŠ¤íŠ¸ë¥¼ í•©ì¹˜ê¸°
</span>                <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
                <span class="n">final_text</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="k">if</span> <span class="n">chunks</span> <span class="k">else</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># í•˜ë‚˜ ì´ìƒ íˆ´ í˜¸ì¶œ â†’ ëª¨ë‘ ì‹¤í–‰ í›„ ê²°ê³¼ë¥¼ ë¬¶ì–´ì„œ ë„˜ê¹€
</span>        <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">result_str</span> <span class="o">=</span> <span class="nf">run_tool_call</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">result_str</span>
            <span class="p">})</span>

        <span class="n">prev_id</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nb">id</span>  <span class="c1"># ì´ì–´ì§€ëŠ” í„´ì—ì„œ previous_response_idë¡œ ì—°ê²°
</span>
    <span class="k">return</span> <span class="n">final_text</span> <span class="ow">or</span> <span class="sh">""</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># ì‚¬ìš© ì˜ˆì‹œ(ì›í•˜ëŠ” ê²½ë¡œë¡œ ë°”ê¾¸ì„¸ìš”)
</span>    <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">í˜„ì¬ ì‘ì—… í´ë”ì˜ íŒŒì¼ì„ ë³´ì—¬ì£¼ê³ (./), </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">ê·¸ì¤‘ README.mdê°€ ìˆìœ¼ë©´ ë‚´ìš©ì„ ì½ì–´ì„œ ìš”ì•½í•´ì¤˜.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="nf">respond_with_tools</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Assistant ===</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>í¬ì¸íŠ¸ ìš”ì•½</li>
</ol>

<ul>
  <li>
    <p>vLLMëŠ” OpenAI-compatible ì„œë²„ë¡œ Responses APIë¥¼ ê·¸ëŒ€ë¡œ ì§€ì›í•©ë‹ˆë‹¤. ì¦‰ <code class="language-plaintext highlighter-rouge">base_url</code>ë§Œ ë°”ê¿”ì„œ <code class="language-plaintext highlighter-rouge">client.responses.create(...)</code>ë¥¼ í˜¸ì¶œí•˜ë©´ ë©ë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
  <li>
    <p>íˆ´ ìŠ¤í‚¤ë§ˆëŠ” <code class="language-plaintext highlighter-rouge">{"type": "function", "function": {name, description, parameters}}</code> í˜•íƒœë¡œ ì •ì˜í•©ë‹ˆë‹¤. GPT-OSSëŠ” Harmony í¬ë§·ì„ ì´í•´í•˜ë©° vLLM ê²½ìœ  ì‹œ ë³„ë„ ì²˜ë¦¬ ì—†ì´ íˆ´ í˜¸ì¶œì´ ë™ì‘í•©ë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
  <li>
    <p>ëª¨ë¸ì´ <code class="language-plaintext highlighter-rouge">function_call</code>ì„ ìƒì„±í•˜ë©´, ê° í•­ëª©ì˜ <code class="language-plaintext highlighter-rouge">call_id</code>, <code class="language-plaintext highlighter-rouge">name</code>, <code class="language-plaintext highlighter-rouge">arguments</code>ë¥¼ êº¼ë‚´ ì‹¤ì œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³ , ê²°ê³¼ë¥¼ <code class="language-plaintext highlighter-rouge">tool_outputs=[{"tool_call_id": ..., "output": "..."}]</code>ë¡œ ë‹¤ì‹œ <code class="language-plaintext highlighter-rouge">responses.create</code>ì— ë„˜ê²¨ í•œ í„´ì„ ì´ì–´ê°‘ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">previous_response_id</code>ë¡œ ì§ì „ í„´ì„ ì—°ê²°í•©ë‹ˆë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p>gpt-ossë¥¼ vLLMë¡œ ì§ì ‘ ìƒ˜í”Œë§í•  ë•ŒëŠ” Harmony SDKë¡œ í”„ë¡¬í”„íŠ¸/ìŠ¤í†±í† í°ì„ ê´€ë¦¬í•´ì•¼ í•˜ì§€ë§Œ, OpenAI-compatible ì„œë²„ + SDK ê²½ë¡œì—ì„œëŠ” ì‹ ê²½ ì“¸ í•„ìš”ê°€ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook</a></p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ ìœ„ ì½”ë“œì— ìŠ¤íŠ¸ë¦¬ë°(<code class="language-plaintext highlighter-rouge">stream=True</code>) ì²˜ë¦¬ë‚˜, ë°”ì´ë„ˆë¦¬ íŒŒì¼ ê°ì§€/ì°¨ë‹¨ ê°™ì€ ë³´ê°• ë¡œì§ë„ ë§ëŒ€ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ëŒ€í™”ë¥¼ ë‘ í„´ì€ í–ˆìœ¼ë©´ ì¢‹ê² ì–´. README.mdë¥¼ ì½ì—ˆìœ¼ë‹ˆ ë‹¤ìŒì—” requirements.txtë¥¼ ì½ì

</p>

<p>ì¢‹ì•„ìš”. â€œë‘ í„´ ëŒ€í™”â€ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡, ì²« í„´ì—ì„œ README.mdë¥¼ ì½ê³  ìš”ì•½í•œ ë’¤, ë‘˜ì§¸ í„´ì—ì„œ requirements.txtë¥¼ ì½ëŠ” êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ëŠ” ì˜ˆì œë¥¼ ë“œë¦´ê²Œìš”. í•µì‹¬ì€ Responses APIì—ì„œ previous_response_idë¡œ ëŒ€í™” ë¬¸ë§¥ì„ ì‡ê³ , íˆ´ í˜¸ì¶œ(function_call)ì´ ì˜¬ ë•Œë§ˆë‹¤ ì‹¤ì œ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•´ tool_outputsë¡œ ë˜ëŒë ¤ì£¼ëŠ” ë£¨í”„ë¥¼ ë§¤ í„´ë§ˆë‹¤ ëŒë¦¬ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ìˆœì„œëŒ€ë¡œ ë³´ë©´ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>vLLM(OpenAI-compatible) ì„œë²„ê°€ localhost:8000/v1ì—ì„œ ì‹¤í–‰ ì¤‘ì´ë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë‘ ê°œì˜ íˆ´(list_directory, read_file)ì„ ì •ì˜í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Conversation í´ë˜ìŠ¤ë¡œ â€œí„´ ë‹¨ìœ„â€ ëŒ€í™” ì‹¤í–‰ê¸°ë¥¼ ë§Œë“¤ê³ , í„´ë§ˆë‹¤ íˆ´ í˜¸ì¶œ ë£¨í”„ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>mainì—ì„œ ì‹¤ì œ ë‘ í„´ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤: 1í„´(README.md) â†’ 2í„´(requirements.txt).</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install openai
# ì‚¬ì „ ì¤€ë¹„: vLLM(OpenAI-compatible) ì„œë²„ë¥¼ http://localhost:8000/v1 ì—ì„œ ê°€ë™
#   ì˜ˆ) vllm serve openai/gpt-oss-120b
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># ===== 0) OpenAI í´ë¼ì´ì–¸íŠ¸: vLLM í˜¸í™˜ ì„œë²„ë¡œ ì§€ì • =====
</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span>
    <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">EMPTY</span><span class="sh">"</span>  <span class="c1"># vLLM ê¸°ë³¸ê°’. í•„ìš” ì‹œ ì„ì˜ ë¬¸ìì—´ë¡œ ëŒ€ì²´
</span><span class="p">)</span>

<span class="c1"># ===== 1) ì‹¤ì œë¡œ ì‹¤í–‰ë  ë¡œì»¬ í•¨ìˆ˜ë“¤(íˆ´ êµ¬í˜„) =====
</span><span class="k">def</span> <span class="nf">list_directory</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Directory not found: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">is_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">child</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="n">child</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200_000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">max_bytes</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s">... [truncated]</span><span class="sh">"</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># ===== 2) íˆ´ ìŠ¤í‚¤ë§ˆ(Harmony/Responsesìš© function tool) =====
</span><span class="n">TOOLS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_directory</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List files and folders in a directory.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Target directory path</span><span class="sh">"</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a text file from disk.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Target file path</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Max characters to return</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200000</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>
<span class="n">FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">list_directory</span><span class="sh">"</span><span class="p">:</span> <span class="n">list_directory</span><span class="p">,</span> <span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_file</span><span class="p">}</span>

<span class="c1"># ===== 3) íˆ´ í˜¸ì¶œ ìœ í‹¸ =====
</span><span class="k">def</span> <span class="nf">extract_function_calls</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    Responses API ì‘ë‹µì—ì„œ function_callë“¤ì„ ì¶”ì¶œí•´
    [{call_id, name, arguments}, ...] í˜•íƒœë¡œ ë°˜í™˜
    </span><span class="sh">"""</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">resp_obj</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">resp_obj</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">call_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">raw_args</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">raw_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">run_tool_call</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    í•´ë‹¹ íˆ´ì„ ì‹¤ì œ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ JSON ë¬¸ìì—´ë¡œ ë°˜í™˜
    </span><span class="sh">"""</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">FUNCTIONS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unknown function: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">fn</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bad arguments for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_output_text</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ìµœì¢… ì–´ì‹œìŠ¤í„´íŠ¸ í…ìŠ¤íŠ¸ë¥¼ êº¼ë‚´ëŠ” í—¬í¼
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">resp_obj</span><span class="p">.</span><span class="n">output_text</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp_obj</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">resp_obj</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">output_text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

<span class="c1"># ===== 4) ëŒ€í™” ì‹¤í–‰ê¸°: í„´ ë‹¨ìœ„ë¡œ previous_response_idë¥¼ ì´ì–´ê° =====
</span><span class="k">class</span> <span class="nc">Conversation</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_response_id</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># ë§ˆì§€ë§‰ assistant ì‘ë‹µì˜ id
</span>
    <span class="k">def</span> <span class="nf">run_turn</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        í•œ í„´ì„ ìˆ˜í–‰:
          1) ì‚¬ìš©ì ì…ë ¥ì„ ëª¨ë¸ì— ë³´ëƒ„(ë¬¸ë§¥ ì—°ê²°: previous_response_id ì‚¬ìš©)
          2) function_callì´ ìˆìœ¼ë©´ ì‹¤ì œ ì‹¤í–‰ â†’ tool_outputsë¡œ ì¬í˜¸ì¶œ
          3) function_callì´ ë” ì´ìƒ ì—†ìœ¼ë©´ ìµœì¢… í…ìŠ¤íŠ¸ ë°˜í™˜
        </span><span class="sh">"""</span>
        <span class="c1"># 1) ì‚¬ìš©ì ì…ë ¥ ì „ì†¡
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">last_response_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">user_input</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">previous_response_id</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">last_response_id</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">user_input</span>
            <span class="p">)</span>

        <span class="c1"># 2) íˆ´ í˜¸ì¶œ ë£¨í”„
</span>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="nf">extract_function_calls</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">tool_outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nf">run_tool_call</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">tool_outputs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">call_id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">})</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">previous_response_id</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="n">tool_outputs</span><span class="o">=</span><span class="n">tool_outputs</span>
            <span class="p">)</span>

        <span class="c1"># 3) ìµœì¢… í…ìŠ¤íŠ¸ì™€ ì‘ë‹µ id ê°±ì‹ 
</span>        <span class="n">text</span> <span class="o">=</span> <span class="nf">get_output_text</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_response_id</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nb">id</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="c1"># ===== 5) ë°ëª¨: ë‘ í„´ ëŒ€í™” =====
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="nc">Conversation</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">openai/gpt-oss-120b</span><span class="sh">"</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">)</span>

    <span class="c1"># ì²« ë²ˆì§¸ í„´: README.mdë¥¼ ì½ê³  ìš”ì•½ ìš”ì²­
</span>    <span class="n">turn1_user</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">í”„ë¡œì íŠ¸ ë£¨íŠ¸(./)ì˜ íŒŒì¼ ëª©ë¡ì„ ë³´ê³  README.mdê°€ ìˆìœ¼ë©´ ì½ì–´ì„œ í•µì‹¬ì„ ìš”ì•½í•´ì¤˜. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">ì—†ìœ¼ë©´ ì™œ ì—†ëŠ”ì§€ë„ ì•Œë ¤ì¤˜.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">turn1_assistant</span> <span class="o">=</span> <span class="n">conv</span><span class="p">.</span><span class="nf">run_turn</span><span class="p">(</span><span class="n">turn1_user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [TURN 1] Assistant ===</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">turn1_assistant</span><span class="p">)</span>

    <span class="c1"># ë‘ ë²ˆì§¸ í„´: requirements.txt ì½ê¸°
</span>    <span class="n">turn2_user</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">ì¢‹ì•„. ì´ì œ ê°™ì€ í´ë”ì—ì„œ requirements.txtë¥¼ ì°¾ì•„ì„œ ë‚´ìš©ì„ ì½ê³ , </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">ì£¼ìš” íŒ¨í‚¤ì§€ì™€ ëŒ€ëµì  ë²„ì „ì„ bulletë¡œ ì •ë¦¬í•´ì¤˜.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">turn2_assistant</span> <span class="o">=</span> <span class="n">conv</span><span class="p">.</span><span class="nf">run_turn</span><span class="p">(</span><span class="n">turn2_user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== [TURN 2] Assistant ===</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">turn2_assistant</span><span class="p">)</span>
</code></pre></div></div>

<p>ì‚¬ìš© íŒê³¼ ì²´í¬í¬ì¸íŠ¸</p>

<ol>
  <li>
    <p>í´ë” ê²½ë¡œ ê¸°ì¤€ì€ í˜„ì¬ ì‘ì—… ë””ë ‰í„°ë¦¬(./)ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ê²½ë¡œë¥¼ ì“°ë ¤ë©´ í”„ë¡¬í”„íŠ¸ ë˜ëŠ” íˆ´ ì¸ì(path)ì— ëª…ì‹œí•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>ëª¨ë¸ì´ ìŠ¤ìŠ¤ë¡œ list_directoryë¥¼ ë¨¼ì € í˜¸ì¶œí•´ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•œ ë‹¤ìŒ read_fileì„ í˜¸ì¶œí•˜ë„ë¡ ì˜ë„ë¥¼ ìœ ë„í•˜ê³ ì, ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— â€œëª©ë¡ì„ ë³´ê³  â€¦ ì½ì–´ì¤˜â€ë¼ê³  ì¨ë‘ì—ˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë‘ ë²ˆì§¸ í„´ì—ì„œëŠ” previous_response_idë¡œ ë¬¸ë§¥ì´ ì´ì–´ì§€ë¯€ë¡œ, ê°™ì€ í´ë”ë¥¼ ë°”ë¡œ ê°€ì •í•˜ê³  requirements.txtë§Œ ìš”ì²­í•˜ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>read_fileì€ í…ìŠ¤íŠ¸ íŒŒì¼ ì „ìš©ì´ë©°, í° íŒŒì¼ì€ max_bytesë¡œ ì ˆë‹¨í•©ë‹ˆë‹¤. ì´ì§„ íŒŒì¼ì€ ê¹¨ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ í•„ìš”í•˜ë©´ ë°”ì´ë„ˆë¦¬ ê°ì§€ ë¡œì§ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>ìŠ¤íŠ¸ë¦¬ë°ì´ í•„ìš”í•˜ë©´ responses.create(stream=True)ë¡œ ë°”ê¾¸ê³ , ìŠ¤íŠ¸ë¦¬ë° ì²­í¬ë¥¼ ì²˜ë¦¬í•œ ë’¤ ë™ì¼í•œ íˆ´ í˜¸ì¶œ ë£¨í”„ë¥¼ ì ìš©í•˜ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
</ol>

<p>ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•˜ë©´, ì‹¤ì œ ë¡œì»¬ ë””ë ‰í„°ë¦¬ì˜ README.md â†’ requirements.txt ìˆœì„œë¡œ ì½ì–´ì„œ ìš”ì•½/ì •ë¦¬í•˜ëŠ” ë‘ í„´ ëŒ€í™”ê°€ ì§„í–‰ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

ì—¬ê¸°ì—ì„œë³´ë©´ ê³¼ê±° ëŒ€í™”ë¥¼ ê°™ì´ ì•ˆ ë³´ë‚´ì£¼ê³  ì €ë²ˆ ëŒ€í™” idë§Œ ë³´ë‚´ëŠ” ê²ƒ ê°™ì€ë° ì´ëŸ°ê²Œ vLLMì—ë„ ì§€ì›ë¼?

</p>

<p>ì§§ì€ ë‹µ: ë„¤, ì§€ì›ë¼ìš”. vLLMì€ <code class="language-plaintext highlighter-rouge">/v1/responses</code> ì—”ë“œí¬ì¸íŠ¸ë¥¼ ê°–ê³  <code class="language-plaintext highlighter-rouge">previous_response_id</code>ë¥¼ ë°›ì•„ â€œì§ì „ ì‘ë‹µë§Œâ€ ë„˜ê²¨ë„ ë¬¸ë§¥ì„ ì‡ëŠ” ë°©ì‹ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ë‹¤ë§Œ ê¸°ë³¸ê°’ì—ì„  ì„œë²„ê°€ ëŒ€í™” ìƒíƒœë¥¼ ì €ì¥í•˜ì§€ ì•Šë„ë¡ ë˜ì–´ ìˆì–´, ìƒíƒœ ì €ì¥ì„ ì¼œì£¼ê±°ë‚˜(ê¶Œì¥) ì•„ë‹ˆë©´ ë§¤ í„´ ì „ì²´ ë§¥ë½ì„ ì§ì ‘ ë‹¤ì‹œ ë³´ë‚´ì•¼ í•©ë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook+2</a></p>

<p>ìƒê° ìˆœì„œ</p>

<ol>
  <li>
    <p>ë¬´ì—‡ì´ ê°€ëŠ¥í•œê°€: vLLMì€ OpenAI Responses APIì™€ í˜¸í™˜ë˜ë©°, <code class="language-plaintext highlighter-rouge">previous_response_id</code> í•„ë“œë¥¼ í”„ë¡œí† ì½œì—ì„œ ë°›ì•„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì¦‰, â€œì§ì „ ì‘ë‹µì˜ idë§Œâ€ ì „ì†¡í•´ë„ ì²´ì´ë‹ì´ ë©ë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm">OpenAI Cookbook+1</a></p>
  </li>
  <li>
    <p>ì™œ ì €ì¥ ì˜µì…˜ì´ í•„ìš”í•œê°€: OpenAIì˜ Responses APIëŠ” ê¸°ë³¸ì´ <code class="language-plaintext highlighter-rouge">store=True</code>ë¼ì„œ ì„œë²„ê°€ ê³¼ê±° í„´ì„ ë‚´ë¶€ ì €ì¥ì†Œì— ë³´ê´€í•©ë‹ˆë‹¤. vLLMì€ ê¸°ë³¸ì—ì„  ì´ë¥¼ êº¼ë‘” ìƒíƒœì´ë¯€ë¡œ, ì €ì¥ì„ í™œì„±í™”í•˜ì§€ ì•Šìœ¼ë©´ <code class="language-plaintext highlighter-rouge">store=True</code> ìš”ì²­ì— ì˜¤ë¥˜ê°€ ë‚˜ê±°ë‚˜, ì €ì¥ ì—†ì´ ë™ì‘í•´ <code class="language-plaintext highlighter-rouge">previous_response_id</code>ì˜ ì´ì (ì„œë²„ì¸¡ íˆë“  ìƒíƒœ ì¬ì‚¬ìš©)ì„ ëª» ëˆ„ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ <code class="language-plaintext highlighter-rouge">VLLM_ENABLE_RESPONSES_API_STORE=1</code>ë¡œ ì €ì¥ ê¸°ëŠ¥ì„ ì¼œë©´ OpenAIì™€ ìœ ì‚¬í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤. ëŒ€ì•ˆìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ <code class="language-plaintext highlighter-rouge">store=False</code>ë¡œ ë³´ë‚´ê³  ë§¤ í„´ ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ì§ì ‘ ì¬ì „ì†¡í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/v0.10.1/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs+2</a></p>
  </li>
</ol>

<p>ë¹ ë¥¸ ì„¤ì • ì˜ˆì‹œ<br />
ì„œë²„(ìƒíƒœ ì €ì¥ ON):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">VLLM_ENABLE_RESPONSES_API_STORE</span><span class="o">=</span>1 vllm serve openai/gpt-oss-120b <span class="nt">--port</span> 8000
</code></pre></div></div>

<p>í´ë¼ì´ì–¸íŠ¸(ë‘ í„´ ì²´ì¸: ê³¼ê±° ëŒ€í™” ë³¸ë¬¸ ë¯¸ì „ì†¡, idë§Œ ì „ë‹¬):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">EMPTY</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># í„´1
</span><span class="n">r1</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">openai/gpt-oss-120b</span><span class="sh">"</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ README.mdë¥¼ ì½ê³  í•µì‹¬ë§Œ ìš”ì•½í•´ì¤˜.</span><span class="sh">"</span>
    <span class="c1"># store=TrueëŠ” Responses API ê¸°ë³¸ê°’. vLLMì—ì„  ìœ„ í™˜ê²½ë³€ìˆ˜ë¡œ í™œì„±í™” í•„ìš”
</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">r1</span><span class="p">.</span><span class="n">output_text</span><span class="p">)</span>

<span class="c1"># í„´2: ê³¼ê±° ë³¸ë¬¸ì€ ì•ˆ ë³´ë‚´ê³ , ì§ì „ ì‘ë‹µì˜ idë§Œ ì—°ê²°
</span><span class="n">r2</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">openai/gpt-oss-120b</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">previous_response_id</span><span class="o">=</span><span class="n">r1</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">ì¢‹ì•„. ì´ë²ˆì—” requirements.txtë¥¼ ì½ì–´ì„œ ì£¼ìš” íŒ¨í‚¤ì§€ì™€ ë²„ì „ì„ ì •ë¦¬í•´ì¤˜.</span><span class="sh">"</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">r2</span><span class="p">.</span><span class="n">output_text</span><span class="p">)</span>
</code></pre></div></div>

<p>ë§Œì•½ ì„œë²„ ìƒíƒœ ì €ì¥ì„ ë„ê³  ì‹¶ë‹¤ë©´</p>

<ul>
  <li>ë§¤ ìš”ì²­ì— <code class="language-plaintext highlighter-rouge">store=False</code>ë¡œ ë³´ë‚´ì„¸ìš”. ì´ ê²½ìš° ì„œë²„ê°€ ìƒíƒœë¥¼ ì•ˆ ê°€ì§€ë¯€ë¡œ, <code class="language-plaintext highlighter-rouge">previous_response_id</code>ë¥¼ ì¨ë„ ì‹¤ì§ˆì  ì´ë“ì´ ì—†ê³  ìŠ¤ìŠ¤ë¡œ íˆìŠ¤í† ë¦¬ë¥¼ ì¬ì „ì†¡í•´ì•¼ í•©ë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/v0.10.1/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs</a></li>
</ul>

<p>ì£¼ì˜í•  ì </p>

<ul>
  <li>ë©€í‹° ì¸ìŠ¤í„´ìŠ¤/ì¬ì‹œì‘ ìƒí™©ì—ì„  ì €ì¥ì†Œê°€ êº¼ì ¸ ìˆìœ¼ë©´ ì²´ì¸ ì»¨í…ìŠ¤íŠ¸ê°€ ìœ ì‹¤ë©ë‹ˆë‹¤. vLLM ì»¤ë®¤ë‹ˆí‹°ì—ì„œë„ â€œResponses APIì˜ í’€ ê¸°ëŠ¥ì„ ì“°ë ¤ë©´ store/message ìŠ¤í† ì–´ê°€ í•„ìš”â€í•˜ë‹¤ëŠ” ë…¼ì˜ê°€ ìˆìŠµë‹ˆë‹¤. ìš´ì˜ í™˜ê²½ì—ì„  ì €ì¥ì„ ì¼œê±°ë‚˜ ì™¸ë¶€ ì˜ì† ìŠ¤í† ì–´ ì „ëµì„ í•¨ê»˜ ê³ ë ¤í•˜ì„¸ìš”. <a href="https://github.com/vllm-project/vllm/issues/24603?utm_source=chatgpt.com">GitHub</a></li>
</ul>

<p>í•µì‹¬ ìš”ì•½</p>

<ul>
  <li>
    <p>ê°€ëŠ¥: vLLMì€ <code class="language-plaintext highlighter-rouge">previous_response_id</code> ì²´ì´ë‹ì„ ë°›ìŠµë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/latest/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs</a></p>
  </li>
  <li>
    <p>ê¶Œì¥: <code class="language-plaintext highlighter-rouge">VLLM_ENABLE_RESPONSES_API_STORE=1</code>ë¡œ ìƒíƒœ ì €ì¥ì„ ì¼œì„œ â€œê³¼ê±° ëŒ€í™” ë³¸ë¬¸ ë¬´ì „ì†¡ + idë§Œ ì „ë‹¬â€ íŒ¨í„´ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”. <a href="https://docs.vllm.ai/en/v0.10.1/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs</a></p>
  </li>
  <li>
    <p>ëŒ€ì•ˆ: ì €ì¥ì„ ëŒ ë• <code class="language-plaintext highlighter-rouge">store=False</code>ë¡œ ë³´ë‚´ê³ , íˆìŠ¤í† ë¦¬ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì¬ì „ì†¡í•©ë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/latest/api/vllm/entrypoints/openai/serving_responses.html?utm_source=chatgpt.com">VLLM Docs</a></p>
  </li>
</ul>

<p class="chat--user">

íˆ´ ë‹¤ ë¹¼ê³  ê°„ë‹¨íˆ í…ŒìŠ¤íŠ¸í•  curl ì˜ˆì œë§Œ ë§Œë“¤ì–´ì¤˜

</p>

<p>ì›í•˜ëŠ” ê²ƒë§Œ ë”±! íˆ´ ì—†ì´ vLLM(OpenAI-compatible) Responses APIë¥¼ <code class="language-plaintext highlighter-rouge">curl</code>ë¡œ ë‘ í„´ í…ŒìŠ¤íŠ¸í•˜ëŠ” ìµœì†Œ ì˜ˆì œì…ë‹ˆë‹¤. ì„œë²„ëŠ” <code class="language-plaintext highlighter-rouge">http://localhost:8000/v1</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">openai/gpt-oss-120b</code>ë¥¼ ì„œë¹™í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.</p>

<ol>
  <li>ë‹¨ë°œì„± í˜¸ì¶œ(ì—°ê²° ì—†ìŒ)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> http://localhost:8000/v1/responses <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Authorization: Bearer EMPTY"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "model": "openai/gpt-oss-120b",
    "input": "í•œ ì¤„ ë†ë‹´ í•˜ë‚˜ í•´ì¤˜."
  }'</span> | jq <span class="nt">-r</span> <span class="s1">'.output_text'</span>
</code></pre></div></div>

<ol>
  <li>ë‘ í„´ ëŒ€í™”(ì§ì „ ì‘ë‹µ ID(previous_response_id)ë¡œ ì²´ì¸)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„´ 1</span>
<span class="nv">RESP1</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> http://localhost:8000/v1/responses <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Authorization: Bearer EMPTY"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "model": "openai/gpt-oss-120b",
    "input": "í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ README.mdë¥¼ ì½ì—ˆë‹¤ê³  ì¹˜ê³ , í•œ ì¤„ë¡œ ìš”ì•½í•´ì¤˜."
  }'</span><span class="si">)</span>

<span class="nb">echo</span> <span class="s2">"TURN1:"</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$RESP1</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s1">'.output_text'</span>

<span class="c"># ì§ì „ ì‘ë‹µì˜ id ì¶”ì¶œ</span>
<span class="nv">RID</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$RESP1</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s1">'.id'</span><span class="si">)</span>

<span class="c"># í„´ 2: ê³¼ê±° ë³¸ë¬¸ì€ ë³´ë‚´ì§€ ì•Šê³  idë§Œ ì—°ê²°</span>
curl <span class="nt">-s</span> http://localhost:8000/v1/responses <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Authorization: Bearer EMPTY"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s2">"{
    </span><span class="se">\"</span><span class="s2">model</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">openai/gpt-oss-120b</span><span class="se">\"</span><span class="s2">,
    </span><span class="se">\"</span><span class="s2">previous_response_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="nv">$RID</span><span class="se">\"</span><span class="s2">,
    </span><span class="se">\"</span><span class="s2">input</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">ì¢‹ì•„. ì´ì œ requirements.txtë¥¼ ì½ì—ˆë‹¤ê³  ì¹˜ê³ , ì£¼ìš” íŒ¨í‚¤ì§€ë§Œ bulletë¡œ ë½‘ì•„ì¤˜.</span><span class="se">\"</span><span class="s2">
  }"</span> | jq <span class="nt">-r</span> <span class="s1">'.output_text'</span>
</code></pre></div></div>

<p>ì£¼ì˜</p>

<ul>
  <li>
    <p>vLLMì—ì„œ <code class="language-plaintext highlighter-rouge">previous_response_id</code> ì²´ì´ë‹ì„ ì“°ë ¤ë©´ ì„œë²„ê°€ ì‘ë‹µ ì €ì¥ì„ ì§€ì›í•´ì•¼ í•©ë‹ˆë‹¤. ì„œë²„ ê¸°ë™ ì „ì— ìƒíƒœ ì €ì¥ì„ ì¼œë‘ì—ˆë‹¤ë©´ ìœ„ ì˜ˆì œê°€ ê·¸ëŒ€ë¡œ ì‘ë™í•˜ê³ , ì €ì¥ì´ êº¼ì ¸ ìˆë‹¤ë©´ ë§¤ í„´ ì „ì²´ ë§¥ë½ì„ ì§ì ‘ ë³´ë‚´ì•¼ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í† í° ê²€ì¦ì„ í•˜ì§€ ì•ŠëŠ” ê¸°ë³¸ ì„¤ì •ì´ë¼ë©´ Authorization í—¤ë”ì˜ ê°’ì€ ì„ì˜ ë¬¸ìì—´(ì˜ˆ: <code class="language-plaintext highlighter-rouge">EMPTY</code>)ì´ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë¸ ì´ë¦„ì€ <code class="language-plaintext highlighter-rouge">vllm serve</code> ì‹œ ì§€ì •í•œ ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆ) <code class="language-plaintext highlighter-rouge">vllm serve openai/gpt-oss-120b</code> â†’ ìš”ì²­ ë°”ë””ì˜ <code class="language-plaintext highlighter-rouge">"model": "openai/gpt-oss-120b"</code>.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">LLM Local MCP</title><link href="https://hvppyarchive.github.io/llm/local-mcp/" rel="alternate" type="text/html" title="LLM Local MCP" /><published>2025-10-17T19:56:32+09:00</published><updated>2025-10-17T19:56:32+09:00</updated><id>https://hvppyarchive.github.io/llm/local-mcp</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/local-mcp/"><![CDATA[<p class="chat--user">

LLM MCP ë™ì‘ ì›ë¦¬

</p>

<p>ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”! â€œMCP(Model Context Protocol)â€ëŠ” LLM ì•±ì´ ë°”ê¹¥ ì„¸ê³„ì˜ ë°ì´í„°ì™€ ë„êµ¬ì— ì•ˆì „í•˜ê²Œ ë¶™ëŠ” í‘œì¤€ ëŒ€í™” ê·œì•½ì´ì—ìš”. ì•„ë˜ì²˜ëŸ¼ â€œëˆ„ê°€ ëˆ„êµ¬ì™€, ì–´ë–¤ ìˆœì„œë¡œ, ë¬´ì—‡ì„ ì£¼ê³ ë°›ëŠ”ì§€â€ë¥¼ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.</p>

<h1 id="í•œ-ì¤„-ìš”ì•½">í•œ ì¤„ ìš”ì•½</h1>

<p>LLM ì•±(í˜¸ìŠ¤íŠ¸)ì´ <strong>í´ë¼ì´ì–¸íŠ¸</strong> ë¥¼ í†µí•´ í•˜ë‚˜ ì´ìƒì˜ <strong>MCP ì„œë²„</strong> ì™€ ìƒíƒœ ìœ ì§€ ì—°ê²°ì„ ë§ºê³ , JSON-RPC ë©”ì‹œì§€ë¡œ <strong>ë¦¬ì†ŒìŠ¤(Resources)</strong> Â·<strong>í”„ë¡¬í”„íŠ¸(Prompts)</strong> Â·<strong>íˆ´(Tools)</strong>ì„ ë°œê²¬â†’í˜¸ì¶œâ†’ê²°ê³¼ë¥¼ ë°›ëŠ” íë¦„ì…ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18">Model Context Protocol+1</a></p>

<h1 id="êµ¬ì„±ìš”ì†Œì—­í• ">êµ¬ì„±ìš”ì†Œ(ì—­í• )</h1>

<ol>
  <li>
    <p><strong>Host(í˜¸ìŠ¤íŠ¸)</strong> : ì±„íŒ…ì•±/IDEì²˜ëŸ¼ LLMì´ ë›°ëŠ” â€œì»¨í…Œì´ë„ˆâ€. ì—¬ëŸ¬ MCP <strong>í´ë¼ì´ì–¸íŠ¸</strong> ë¥¼ ë§Œë“¤ê³  ê¶Œí•œÂ·ë³´ì•ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ì „ì²´ ëŒ€í™” ë§¥ë½ë„ ì´ìª½ì´ ì¥¡ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>Client(í´ë¼ì´ì–¸íŠ¸)</strong> : íŠ¹ì • MCP <strong>ì„œë²„</strong> ì™€ 1:1 ì„¸ì…˜ì„ ë§ºëŠ” ì»¤ë„¥í„°. ê¸°ëŠ¥(ìº¡í¼ë¹Œë¦¬í‹°) êµì„­ê³¼ ë©”ì‹œì§€ ë¼ìš°íŒ…ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>Server(ì„œë²„)</strong> : ë¦¬ì†ŒìŠ¤/í”„ë¡¬í”„íŠ¸/íˆ´ì„ â€œì œê³µâ€í•˜ëŠ” ìª½. ë¡œì»¬ í”„ë¡œì„¸ìŠ¤ì¼ ìˆ˜ë„, ì›ê²© ì„œë¹„ìŠ¤ì¼ ìˆ˜ë„ ìˆì–´ìš”. <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
</ol>

<h1 id="í†µì‹ -ë°©ì‹ì „ì†¡">í†µì‹  ë°©ì‹(ì „ì†¡)</h1>

<ul>
  <li>ë©”ì‹œì§€ í¬ë§·ì€ <strong>JSON-RPC 2.0</strong>. ì „ì†¡ì€ ì£¼ë¡œ <strong>stdio</strong>(ì„œë¸Œí”„ë¡œì„¸ìŠ¤ í‘œì¤€ì…ì¶œë ¥) ë˜ëŠ” <strong>Streamable HTTP</strong>(POST/GET+SSE ì˜µì…˜) ë‘ ê°€ì§€ê°€ í‘œì¤€ì…ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></li>
</ul>

<h1 id="ì„¸ì…˜-ìˆ˜ëª…ì£¼ê¸°í•µì‹¬-ë‹¨ê³„">ì„¸ì…˜ ìˆ˜ëª…ì£¼ê¸°(í•µì‹¬ ë‹¨ê³„)</h1>

<ol>
  <li>
    <p><strong>initialize ìš”ì²­</strong> : í´ë¼ì´ì–¸íŠ¸ê°€ ë¨¼ì € â€œì§€ì› í”„ë¡œí† ì½œ ë²„ì „+í´ë¼ì´ì–¸íŠ¸ ê¸°ëŠ¥â€ì„ ë³´ëƒ…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>initialize ì‘ë‹µ</strong> : ì„œë²„ê°€ â€œì„œë²„ ê¸°ëŠ¥(ë¦¬ì†ŒìŠ¤/í”„ë¡¬í”„íŠ¸/íˆ´ ë“±)â€ê³¼ ì„œë²„ ì •ë³´, ì„ íƒì  ì§€ì‹œë¬¸ì„ ëŒë ¤ì¤ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>initialized ì•Œë¦¼</strong> : í´ë¼ì´ì–¸íŠ¸ê°€ ì¤€ë¹„ ì™„ë£Œë¥¼ í†µì§€í•˜ê³  ì´í›„ ì •ìƒ ìš´ìš© ë‹¨ê³„ë¡œ ì§„ì…í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ìš´ìš©(Operation)</strong> : í•©ì˜ëœ ê¸°ëŠ¥ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤(ì˜ˆ: tools/list, tools/call ë“±).</p>
  </li>
  <li>
    <p><strong>ì¢…ë£Œ</strong> : ì „ì†¡ ë°©ì‹ì— ë§ê²Œ ê·¸ë ˆì´ìŠ¤í’€í•˜ê²Œ ëŠìŠµë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/lifecycle">Model Context Protocol</a></p>
  </li>
</ol>

<h1 id="ì„œë²„ê°€-ì œê³µí•˜ëŠ”-3ê°€ì§€-ê¸°ë³¸-í”„ë¦¬ë¯¸í‹°ë¸Œ">ì„œë²„ê°€ ì œê³µí•˜ëŠ” 3ê°€ì§€ â€œê¸°ë³¸ í”„ë¦¬ë¯¸í‹°ë¸Œâ€</h1>

<ul>
  <li>
    <p><strong>Resources(ë¦¬ì†ŒìŠ¤)</strong> : íŒŒì¼/ë¬¸ì„œ/DB ìŠ¤í‚¤ë§ˆ ê°™ì€ ì°¸ì¡° ë°ì´í„°. <code class="language-plaintext highlighter-rouge">resources/list</code>ë¡œ ëª©ë¡ì„, <code class="language-plaintext highlighter-rouge">resources/read</code>ë¡œ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. URI(file://, https://, git:// ë“±)ë¡œ ì‹ë³„ë˜ê³  í•„ìš”í•˜ë©´ êµ¬ë…/ë³€ê²½ ì•Œë¦¼ë„ ë©ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/server">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p><strong>Prompts(í”„ë¡¬í”„íŠ¸)</strong> : ì‚¬ìš©ìê°€ ê³¨ë¼ ì“°ëŠ” í…œí”Œë¦¿/ì›Œí¬í”Œë¡œ. <code class="language-plaintext highlighter-rouge">prompts/list</code>ë¡œ ë°œê²¬í•˜ê³  <code class="language-plaintext highlighter-rouge">prompts/get</code>ìœ¼ë¡œ ì¸ì ë„£ì–´ ë°›ì•„ì˜µë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/prompts">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>Tools(íˆ´)</strong> : ëª¨ë¸ì´ â€œí˜¸ì¶œâ€í•˜ëŠ” í•¨ìˆ˜. JSON Schemaë¡œ ì…ë ¥(í•„ìˆ˜/í˜•)ì„ ì„ ì–¸í•˜ê³ , <code class="language-plaintext highlighter-rouge">tools/list</code>ë¡œ ë°œê²¬â†’<code class="language-plaintext highlighter-rouge">tools/call</code>ë¡œ ì‹¤í–‰â†’í…ìŠ¤íŠ¸/ì´ë¯¸ì§€/êµ¬ì¡°í™” JSON(ì˜µì…˜) ë“±ìœ¼ë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol</a></p>
  </li>
</ul>

<h1 id="ì‹¤ì œ-í˜¸ì¶œ-íë¦„-ë‹¨ê³„ë³„-ì˜ˆì‹œ">ì‹¤ì œ í˜¸ì¶œ íë¦„, ë‹¨ê³„ë³„ ì˜ˆì‹œ</h1>

<ol>
  <li>
    <p>ì‚¬ìš©ìê°€ â€œë ˆí¬ ì´ìŠˆ ì°¾ì•„ì¤˜â€ë¼ê³  ë§í•¨ â†’ <strong>í˜¸ìŠ¤íŠ¸</strong> ê°€ í˜„ì¬ ëŒ€í™”Â·ê¶Œí•œì„ ë°”íƒ•ìœ¼ë¡œ ì ì ˆí•œ MCP <strong>í´ë¼ì´ì–¸íŠ¸</strong> ë¥¼ ì„ íƒ. <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
  <li>
    <p>í´ë¼ì´ì–¸íŠ¸â†”ì„œë²„ê°€ <strong>initialize</strong> ë¡œ ë²„ì „Â·ê¸°ëŠ¥ì„ êµì„­(ì˜ˆ: ì„œë²„ëŠ” tools/resources ì§€ì›, í´ë¼ì´ì–¸íŠ¸ëŠ” sampling ì§€ì›). <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/lifecycle">Model Context Protocol</a></p>
  </li>
  <li>
    <p>í´ë¼ì´ì–¸íŠ¸ê°€ <code class="language-plaintext highlighter-rouge">tools/list</code>ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ íˆ´ì„ ì¡°íšŒ(ì˜ˆ: <code class="language-plaintext highlighter-rouge">search_issues</code>). <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol</a></p>
  </li>
  <li>
    <p>(í•„ìš” ì‹œ) <code class="language-plaintext highlighter-rouge">resources/list</code>/<code class="language-plaintext highlighter-rouge">resources/read</code>ë¡œ í˜„ì¬ í”„ë¡œì íŠ¸ íŒŒì¼Â·ì„¤ì • ë“± ë§¥ë½ì„ ì·¨ë“. <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/resources">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>LLM</strong> ì´ íˆ´ ì„¤ëª…ê³¼ ì…ë ¥ ìŠ¤í‚¤ë§ˆë¥¼ ì´í•´í•˜ê³  <code class="language-plaintext highlighter-rouge">tools/call</code>ì— ë§ëŠ” ì¸ìë¥¼ ì‘ì„±. í˜¸ìŠ¤íŠ¸ UIê°€ ì‚¬ìš©ìì—ê²Œ ì‹¤í–‰/ê¶Œí•œì„ í™•ì¸(â€œì‚¬ëŒ-ê²€í† â€ ê¶Œì¥). <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol</a></p>
  </li>
  <li>
    <p>ì„œë²„ê°€ ì™¸ë¶€ API/DBë¥¼ í˜¸ì¶œí•˜ê³  ê²°ê³¼ë¥¼ JSON-RPC ì‘ë‹µìœ¼ë¡œ ë°˜í™˜(í•„ìš”í•˜ë©´ ë¦¬ì†ŒìŠ¤ ë§í¬ë‚˜ êµ¬ì¡°í™” JSON í¬í•¨). <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol</a></p>
  </li>
  <li>
    <p>í˜¸ìŠ¤íŠ¸ëŠ” ê²°ê³¼ë¥¼ ëŒ€í™” ë§¥ë½ì— ì£¼ì…(ì„œë²„ëŠ” ì „ì²´ ëŒ€í™” ê¸°ë¡ì„ ì§ì ‘ ì½ì§€ ëª»í•˜ë„ë¡ ë¶„ë¦¬). <a href="https://modelcontextprotocol.io/specification/2025-06-18/architecture">Model Context Protocol</a></p>
  </li>
  <li>
    <p>LLMì´ ìµœì¢… ë‹µë³€ì„ ìƒì„±í•˜ê³ , ì¶”ê°€ ì•¡ì…˜ì´ í•„ìš”í•˜ë©´ ìœ„ ì‚¬ì´í´ì„ ë°˜ë³µ.</p>
  </li>
</ol>

<h1 id="ë³´ì•ˆì‹ ë¢°-ì›ì¹™ìš”ì ">ë³´ì•ˆÂ·ì‹ ë¢° ì›ì¹™(ìš”ì )</h1>

<ul>
  <li>
    <p><strong>ëª…ì‹œì  ì‚¬ìš©ì ë™ì˜</strong> : ë°ì´í„° ì ‘ê·¼Â·íˆ´ ì‹¤í–‰ ì „ ì‚¬ìš©ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ìµœì†Œ ê³µê°œ</strong> : ì„œë²„ëŠ” í•„ìš”í•œ ë§¥ë½ë§Œ ë³´ê³ , ì „ì²´ ëŒ€í™”/ë‹¤ë¥¸ ì„œë²„ì˜ ìƒíƒœëŠ” ë³¼ ìˆ˜ ì—†ê²Œ ì„¤ê³„ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>íˆ´ì€ ì ì¬ì  ì½”ë“œ ì‹¤í–‰</strong> ì´ë¯€ë¡œ UI ê²½ê³ Â·ìŠ¹ì¸Â·ë¡œê¹…Â·ì·¨ì†ŒÂ·íƒ€ì„ì•„ì›ƒ ë“±ì„ ê¶Œì¥í•©ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p>(HTTP ì „ì†¡ ì‹œ) <strong>Origin ê²€ì¦/ë¡œì»¬ ë°”ì¸ë”©/ì¸ì¦</strong> ë“± ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ìˆ˜ì¹™ì„ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></p>
  </li>
</ul>

<h1 id="ê°œë°œìê°€-ê¸°ì–µí•˜ë©´-ì¢‹ì€-í¬ì¸íŠ¸">ê°œë°œìê°€ ê¸°ì–µí•˜ë©´ ì¢‹ì€ í¬ì¸íŠ¸</h1>

<ul>
  <li>
    <p><strong>ë°œê²¬(Discovery)</strong> : list ê³„ì—´ APIë¡œ ê¸°ëŠ¥ì„ ì°¾ëŠ”ë‹¤ â†’ <strong>í˜¸ì¶œ(Call)</strong> : schemaì— ë§ì¶° ì‹¤í–‰í•œë‹¤ â†’ <strong>ì½˜í…ì¸  ì£¼ì…(Contexting)</strong> : ê²°ê³¼ë¥¼ ëŒ€í™”ì— ë„£ëŠ”ë‹¤(í•„ìš”ì‹œ ë¦¬ì†ŒìŠ¤ ë§í¬/êµ¬ë…). <a href="https://modelcontextprotocol.io/specification/2025-06-18/server/tools">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p><strong>ë²„ì „Â·ê¸°ëŠ¥ êµì„­</strong> ì´ í•­ìƒ ë¨¼ì €ì´ê³ , í•©ì˜ëœ ê²ƒë§Œ ì“´ë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/lifecycle">Model Context Protocol</a></p>
  </li>
  <li>
    <p>êµ¬í˜„ì€ <strong>stdio</strong> ê°€ ê°€ì¥ ë‹¨ìˆœí•˜ê³ , <strong>Streamable HTTP</strong> ëŠ” ë‹¤ì¤‘ ì—°ê²°Â·SSE ìŠ¤íŠ¸ë¦¬ë°Â·ì„¸ì…˜ IDë¡œ í™•ì¥ ê°€ëŠ¥. <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´, ê°„ë‹¨í•œ â€œHello Toolâ€ ì„œë²„/í´ë¼ì´ì–¸íŠ¸ í…œí”Œë¦¿(ì˜ˆ: Node/Python)ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">initialize â†’ tools/list â†’ tools/call</code>ê¹Œì§€ ëŒì•„ê°€ëŠ” ìµœì†Œ ì˜ˆì œë¥¼ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ë‚˜ì—ê²Œ GPT-OSS ë¥¼ ìì²´ì ìœ¼ë¡œ êµ¬ë™í•˜ëŠ” ì„œë²„ê°€ ìˆì–´. ì—¬ê¸°ì— MCPë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•˜ë ¤ë©´?

</p>

<p>ì¢‹ì•„ìš”. â€œìì²´ GPT-OSS ì„œë²„â€ë¥¼ ì´ë¯¸ ëŒë¦¬ê³  ê³„ì‹œë‹¤ë©´, ê±°ê¸°ì— <strong>MCP(ëª¨ë¸ ì»¨í…ìŠ¤íŠ¸ í”„ë¡œí† ì½œ)</strong>ë¥¼ ë¶™ì´ëŠ” ë°©ë²•ì€ í¬ê²Œ ë‘ ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ê°€ ìˆì–´ìš”. ì•„ë˜ë¥¼ <strong>ë‹¨ê³„ë³„</strong> ë¡œ ë”°ë¼ê°€ë©´ ë©ë‹ˆë‹¤.</p>

<hr />

<h1 id="ì‹œë‚˜ë¦¬ì˜¤-a-ë‚´-gpt-oss-ì•ì—-mcp-í˜¸ìŠ¤íŠ¸ë¸Œë¦¬ì§€ë¥¼-ë‘”ë‹¤">ì‹œë‚˜ë¦¬ì˜¤ A) ë‚´ GPT-OSS ì•ì— â€˜MCP í˜¸ìŠ¤íŠ¸(ë¸Œë¦¬ì§€)â€™ë¥¼ ë‘”ë‹¤</h1>

<blockquote>
  <p>ê°€ì¥ ì¼ë°˜ì ì¸ ë°©ì‹. â€œí˜¸ìŠ¤íŠ¸(Host)=LLM ëŸ°íƒ€ì„ + MCP í´ë¼ì´ì–¸íŠ¸â€ê°€ <strong>MCP ì„œë²„ë“¤ì˜ íˆ´Â·ë¦¬ì†ŒìŠ¤Â·í”„ë¡¬í”„íŠ¸</strong> ë¥¼ ë°œê²¬â†’í˜¸ì¶œí•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ GPT-OSS ëŒ€í™”ì— ì£¼ì…í•©ë‹ˆë‹¤. (MCP í´ë¼ì´ì–¸íŠ¸/ì„œë²„ SDKì™€ ì „ì†¡ ë°©ì‹ì€ ê³µì‹ ë¬¸ì„œÂ·SDKì— ìˆì–´ìš”.) <a href="https://modelcontextprotocol.io/docs/develop/build-client">Model Context Protocol+3</a></p>
</blockquote>

<h2 id="0-ì‚¬ì „-ì¤€ë¹„-gpt-oss-ì„œë¹„ìŠ¤ë¥¼-openai-í˜¸í™˜-apië¡œ">0) ì‚¬ì „ ì¤€ë¹„ (GPT-OSS ì„œë¹„ìŠ¤ë¥¼ OpenAI í˜¸í™˜ APIë¡œ)</h2>

<ul>
  <li>vLLM ë“±ìœ¼ë¡œ GPT-OSSë¥¼ <strong>OpenAI Chat Completions í˜¸í™˜</strong> ìœ¼ë¡œ ë„ì›Œë‘ë©´ í¸í•©ë‹ˆë‹¤. ì˜ˆ:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uv pip <span class="nb">install</span> <span class="nt">--pre</span> <span class="nv">vllm</span><span class="o">==</span>0.10.1+gptoss <span class="nt">--extra-index-url</span> https://wheels.vllm.ai/gpt-oss/
vllm serve openai/gpt-oss-20b
</code></pre></div>    </div>
  </li>
</ul>

<p>(ë ˆí¬ì˜ ê°€ì´ë“œë¥¼ ë”°ë¥´ë©´ ìë™ ë‹¤ìš´ë¡œë“œ/ì„œë¹™ì´ ë©ë‹ˆë‹¤.) <a href="https://github.com/openai/gpt-oss">GitHub</a></p>

<ul>
  <li>GPT-OSSëŠ” <strong>Harmony ì‘ë‹µ í˜•ì‹</strong> ì„ ì „ì œë¡œ í•™ìŠµëìŠµë‹ˆë‹¤. Harmonyë¡œ ë©”ì‹œì§€ë¥¼ ê¾¸ë¯¸ê³ (ì˜ˆ: <code class="language-plaintext highlighter-rouge">openai-harmony</code> ë¼ì´ë¸ŒëŸ¬ë¦¬), íˆ´ ì •ì˜ë„ ì‹œìŠ¤í…œ ë©”ì‹œì§€ì— ë„£ì–´ì•¼ ë„êµ¬ í˜¸ì¶œì´ ì˜¬ë°”ë¥´ê²Œ ë™ì‘í•´ìš”. <a href="https://github.com/openai/gpt-oss">GitHub</a></li>
</ul>

<h2 id="1-ì–´ë–¤-mcp-ì „ì†¡transportì„-ì“¸ì§€-ê²°ì •">1) ì–´ë–¤ MCP ì „ì†¡(transport)ì„ ì“¸ì§€ ê²°ì •</h2>

<ul>
  <li>
    <p><strong>ë™ì¼ ë¨¸ì‹ /ë¡œì»¬</strong> : <code class="language-plaintext highlighter-rouge">stdio</code>(ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¡œ ì„œë²„ ì‹¤í–‰) â†’ ê°„ë‹¨/ë³´ì•ˆ ìœ ë¦¬</p>
  </li>
  <li>
    <p><strong>ì›ê²©/í™•ì¥</strong> : <strong>Streamable HTTP</strong>(POST/GET+ì„ íƒì  SSE) â†’ ë‹¤ì¤‘ í´ë¼ì´ì–¸íŠ¸/ì„¸ì…˜/ì¬ì—°ê²° ì§€ì›</p>
  </li>
  <li>
    <p>HTTP ì“¸ ë• <strong>Origin ê²€ì¦, localhost ë°”ì¸ë”©, ì¸ì¦</strong> ì„ ë°˜ë“œì‹œ ì„¤ì •í•˜ì„¸ìš”. (DNS rebinding ë“± ë°©ì§€) <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></p>
  </li>
</ul>

<h2 id="2-í˜¸ìŠ¤íŠ¸ë¸Œë¦¬ì§€-êµ¬ì„±--ìµœì†Œ-ë£¨í”„">2) í˜¸ìŠ¤íŠ¸(ë¸Œë¦¬ì§€) êµ¬ì„± â€” ìµœì†Œ ë£¨í”„</h2>

<p>í•µì‹¬ì€ ì•„ë˜ ë£¨í”„ì˜ˆìš”.</p>

<ol>
  <li>
    <p><strong>MCP í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜</strong> ì„ ì—´ê³  <code class="language-plaintext highlighter-rouge">tools/list</code>ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ MCP íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê·¸ ìŠ¤í‚¤ë§ˆë¥¼ <strong>Harmony í¬ë§·ì˜ â€œtools ì •ì˜â€</strong>ë¡œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ì— ì£¼ì…í•˜ê³ , ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì™€ í•¨ê»˜ <strong>GPT-OSS</strong> ì— ë³´ëƒ…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë¸ì´ <strong>tool_use</strong> ë¥¼ ìƒì„±í•˜ë©´ â†’ í•´ë‹¹ í˜¸ì¶œì„ <strong><code class="language-plaintext highlighter-rouge">tools/call</code></strong>ë¡œ MCP ì„œë²„ì— ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ <strong>tool_result</strong> ë¡œ ë‹¤ì‹œ ëª¨ë¸ì— ì „ë‹¬ â†’ ëª¨ë¸ì˜ ìµœì¢… ë‹µë³€ê¹Œì§€ ë°˜ë³µ.<br />
TypeScript/Python ì–‘ìª½ SDKê°€ ì´ íë¦„ì„ ì§€ì›í•©ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/docs/develop/build-client">Model Context Protocol+1</a></p>
  </li>
</ol>

<blockquote>
  <p>ì°¸ê³ : TypeScript SDK READMEì—ëŠ” HTTP/stdio ì„œë²„ ì˜ˆì œì™€ í´ë¼ì´ì–¸íŠ¸ ì‘ì„± ì„¹ì…˜ì´, Python SDKì—ëŠ” <code class="language-plaintext highlighter-rouge">FastMCP</code> ë° <strong>Streamable HTTPë¥¼ ê¸°ì¡´ ASGI ì•±ì— ë§ˆìš´íŠ¸</strong> í•˜ëŠ” ì˜ˆì œê°€ ì˜ ì •ë¦¬ë¼ ìˆì–´ìš”(ë¸Œë¼ìš°ì € í´ë¼ì´ì–¸íŠ¸ìš© CORS ë…¸ì¶œ í—¤ë” í¬í•¨). <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>
</blockquote>

<h2 id="3-ìƒ˜í”Œ-ì•„í‚¤í…ì²˜ìš”ì§€">3) ìƒ˜í”Œ ì•„í‚¤í…ì²˜(ìš”ì§€)</h2>

<ul>
  <li>
    <p><strong>mcp-bridge</strong>(í˜¸ìŠ¤íŠ¸):</p>

    <ul>
      <li>
        <p>mcp Python/TS SDKë¡œ MCP <strong>ClientSession</strong> ìƒì„± â†’ <code class="language-plaintext highlighter-rouge">list_tools</code> â†’ íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ Harmony ì‹œìŠ¤í…œ ë©”ì‹œì§€ì— ì‚½ì…</p>
      </li>
      <li>
        <p>GPT-OSS(ì˜ˆ: vLLM OpenAI ì—”ë“œí¬ì¸íŠ¸)ì— ChatCompletions <strong>+ Harmony</strong> ë¡œ ì§ˆì˜</p>
      </li>
      <li>
        <p>ì‘ë‹µ ë‚´ <code class="language-plaintext highlighter-rouge">tool_use</code> â†’ <code class="language-plaintext highlighter-rouge">session.call_tool()</code>ë¡œ ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ <strong>Harmony <code class="language-plaintext highlighter-rouge">tool_result</code></strong>ë¡œ ë‹¤ì‹œ ëª¨ë¸ì—ê²Œ ì „ë‹¬</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ë³´ì•ˆ</strong> : MCP HTTP ì‚¬ìš© ì‹œ <code class="language-plaintext highlighter-rouge">Mcp-Session-Id</code> í—¤ë”Â·ì„¸ì…˜ ì¢…ë£Œ, CORS í—¤ë”(íŠ¹íˆ <code class="language-plaintext highlighter-rouge">Mcp-Session-Id</code> ë…¸ì¶œ) ì„¤ì • ê¶Œì¥. <a href="https://github.com/modelcontextprotocol/python-sdk">GitHub</a></p>
  </li>
</ul>

<blockquote>
  <p>íŒ: OpenAIì˜ <strong>Apps/Agents SDK</strong> ë„ MCP ì„œë²„ ì—°ë™ ê°œë…ì„ ë¬¸ì„œí™”í•´ ë‘ì—ˆê³ , <strong>OpenAIí˜¸í™˜(Chat Completions) ì—”ë“œí¬ì¸íŠ¸</strong> ë©´ ì‰½ê²Œ ë§ë¬¼ë¦½ë‹ˆë‹¤(í˜¸ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ë§Œë“¤ ë•Œ ê°œë… ì°¸ì¡°). <a href="https://developers.openai.com/apps-sdk/concepts/mcp-server/?utm_source=chatgpt.com">OpenAI ê°œë°œì</a></p>
</blockquote>

<hr />

<h1 id="ì‹œë‚˜ë¦¬ì˜¤-b-gpt-ossê°€-mcp-ì„œë²„-ë„-ê²¸í•˜ë„ë¡-í™•ì¥">ì‹œë‚˜ë¦¬ì˜¤ B) GPT-OSSê°€ <strong>MCP ì„œë²„</strong> ë„ ê²¸í•˜ë„ë¡ í™•ì¥</h1>

<blockquote>
  <p>íŠ¹ìˆ˜í•œ ê²½ìš°: â€œGPT-OSSê°€ ê°€ì§„ ìì²´ ë„êµ¬(ë¸Œë¼ìš°ì € ë“±)ë¥¼ MCP ì„œë²„ í˜•íƒœë¡œ ë…¸ì¶œâ€í•˜ì—¬ ì™¸ë¶€ í˜¸ìŠ¤íŠ¸ê°€ ë¶™ê²Œ í•˜ëŠ” ë°©ì‹.</p>
</blockquote>

<ul>
  <li>
    <p>GPT-OSS ë ˆí¬ì—ëŠ” <strong>ë„êµ¬(tool)</strong> ê°œë…(ì˜ˆ: ë¸Œë¼ìš°ì € <code class="language-plaintext highlighter-rouge">search/open/find</code>)ê³¼ Harmonyì— íˆ´ ì •ì˜ë¥¼ ë„£ëŠ” ì˜ˆì œê°€ í¬í•¨ë¼ ìˆì–´, ì´ë¥¼ MCP <strong><code class="language-plaintext highlighter-rouge">tools/list</code>/<code class="language-plaintext highlighter-rouge">tools/call</code></strong>ë¡œ ë§¤í•‘í•´ <strong>MCP ì„œë²„</strong> ë¥¼ ë§Œë“¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. (í”„ë¡œë•ì…˜ìš© ë¸Œë¼ìš°ì € ë°±ì—”ë“œëŠ” ì§ì ‘ êµì²´ ê¶Œì¥) <a href="https://github.com/openai/gpt-oss">GitHub</a></p>
  </li>
  <li>
    <p>ì„œë²„ êµ¬í˜„ì€ <strong>TypeScript/Python MCP ì„œë²„ SDK</strong> ì˜ í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ë©´ ë¹ ë¦…ë‹ˆë‹¤. (Echo/SQLite ë“± ì˜ˆì œ í¬í•¨) <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
  </li>
</ul>

<hr />

<h2 id="ë°”ë¡œ-ì¨ë¨¹ëŠ”-ì²´í¬ë¦¬ìŠ¤íŠ¸-step-by-step">ë°”ë¡œ ì¨ë¨¹ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸ (Step-by-Step)</h2>

<ol>
  <li>
    <p><strong>GPT-OSS ì—”ë“œí¬ì¸íŠ¸ ì¤€ë¹„</strong></p>

    <ul>
      <li>vLLMë¡œ OpenAI í˜¸í™˜ API ë„ìš°ê¸° â†’ Harmony ì ìš©(ì˜ˆ: <code class="language-plaintext highlighter-rouge">openai-harmony</code>) <a href="https://github.com/openai/gpt-oss">GitHub</a></li>
    </ul>
  </li>
  <li>
    <p><strong>MCP í˜¸ìŠ¤íŠ¸(ë¸Œë¦¬ì§€) ìŠ¤ìºí´ë”©</strong></p>

    <ul>
      <li>
        <p>(Python) <code class="language-plaintext highlighter-rouge">pip/uv add mcp</code> ë˜ëŠ” (Node) <code class="language-plaintext highlighter-rouge">npm i @modelcontextprotocol/sdk</code></p>
      </li>
      <li>
        <p>MCP <strong>í´ë¼ì´ì–¸íŠ¸</strong> ë¡œ <code class="language-plaintext highlighter-rouge">initialize â†’ tools/list</code>ê¹Œì§€ í˜¸ì¶œë˜ëŠ”ì§€ í™•ì¸ <a href="https://github.com/modelcontextprotocol/python-sdk">GitHub+1</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>íˆ´ ìŠ¤í‚¤ë§ˆ â†” Harmony ë³€í™˜ê¸°</strong> ì‘ì„±</p>

    <ul>
      <li>
        <p>MCP <code class="language-plaintext highlighter-rouge">tools/list</code> ê²°ê³¼(JSON Schema)ë¥¼ Harmony <strong>tools ì •ì˜</strong> ë¡œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ì— ì‚½ì…</p>
      </li>
      <li>
        <p>ëª¨ë¸ ì‘ë‹µì˜ <code class="language-plaintext highlighter-rouge">tool_use</code>ë¥¼ íŒŒì‹±í•´ <code class="language-plaintext highlighter-rouge">tools/call</code>ë¡œ ë¼ìš°íŒ…, ê²°ê³¼ë¥¼ <code class="language-plaintext highlighter-rouge">tool_result</code>ë¡œ ì¬ì£¼ì… <a href="https://github.com/openai/gpt-oss">GitHub+1</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì „ì†¡ ì„ íƒê³¼ ë³´ì•ˆ</strong></p>

    <ul>
      <li>
        <p>ë¡œì»¬ì€ <strong>stdio</strong> , ë¶„ì‚°/ì›ê²©ì€ <strong>Streamable HTTP</strong></p>
      </li>
      <li>
        <p>HTTP ì‹œ <strong>Origin ê²€ì¦Â·ë¡œì»¬ ë°”ì¸ë”©(ê°œë°œ)Â·ì¸ì¦</strong> Â·CORS(<code class="language-plaintext highlighter-rouge">Mcp-Session-Id</code> ë…¸ì¶œ) ì„¤ì • <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol+1</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>í…ŒìŠ¤íŠ¸ ë„êµ¬ ì„œë²„ ë¶™ì´ê¸°</strong></p>

    <ul>
      <li>
        <p>ì˜ˆ: GitHub ì„œë²„(<code class="language-plaintext highlighter-rouge">npx @modelcontextprotocol/server-github</code>), íŒŒì¼ì‹œìŠ¤í…œ/SQLite/í¬ìŠ¤íŠ¸ê·¸ë ˆìŠ¤ ì„œë²„ ë“±</p>
      </li>
      <li>
        <p>ì»¤ë®¤ë‹ˆí‹° ì„œë²„ íë ˆì´ì…˜(awesome list)ë„ ì°¸ê³ í•˜ì„¸ìš”. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+2</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ìš´ì˜ ê°€ë“œë ˆì¼</strong></p>

    <ul>
      <li>íˆ´ ì‹¤í–‰ ì‹œê°„/ë¹ˆë„ ì œí•œ, ì‚¬ìš©ì í™•ì¸(UI ìŠ¹ì¸), ë¡œê¹…Â·ê°ì‚¬, íƒ€ì„ì•„ì›ƒ/ì·¨ì†ŒÂ·ë¦¬íŠ¸ë¼ì´, ë¹„ë°€í‚¤ ì£¼ì…(ENV)</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="ê°€ì¥-ë¹ ë¥¸-ì‹¤ìŠµ-ë£¨íŠ¸ìš”ì•½">â€œê°€ì¥ ë¹ ë¥¸â€ ì‹¤ìŠµ ë£¨íŠ¸(ìš”ì•½)</h2>

<ul>
  <li>
    <p><strong>(1) vLLMë¡œ GPT-OSS ë„ìš°ê¸°</strong> â†’ <code class="language-plaintext highlighter-rouge">vllm serve openai/gpt-oss-20b</code> <a href="https://github.com/openai/gpt-oss">GitHub</a></p>
  </li>
  <li>
    <p><strong>(2) TypeScript SDK Quick Start ì„œë²„</strong> í•˜ë‚˜ ì¼œì„œ MCP ë™ì‘ ì ê²€(HTTP/stdio ì•„ë¬´ê±°ë‚˜) <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
  </li>
  <li>
    <p><strong>(3) ê°„ì´ ë¸Œë¦¬ì§€</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">list_tools</code> â†’ Harmony ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— ì‚½ì… â†’ ChatCompletions í˜¸ì¶œ</p>
      </li>
      <li>
        <p>ì‘ë‹µì˜ <code class="language-plaintext highlighter-rouge">tool_use</code>ë¥¼ <code class="language-plaintext highlighter-rouge">tools/call</code>ë¡œ ì‹¤í–‰í•˜ê³  <code class="language-plaintext highlighter-rouge">tool_result</code>ë¡œ ë˜ëŒë ¤ ì£¼ê¸° <a href="https://modelcontextprotocol.io/docs/develop/build-client">Model Context Protocol+1</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>(4) ë³´ì•ˆ/ì„¸ì…˜ í—¤ë” ì„¤ì •</strong>(HTTPë¼ë©´ <code class="language-plaintext highlighter-rouge">Mcp-Session-Id</code>/Origin/CORS) <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol+1</a></p>
  </li>
</ul>

<hr />

<h2 id="í•¨ê»˜-ì“°ë©´-ì¢‹ì€-ë ˆí¼ëŸ°ìŠ¤">í•¨ê»˜ ì“°ë©´ ì¢‹ì€ ë ˆí¼ëŸ°ìŠ¤</h2>

<ul>
  <li>
    <p><strong>MCP ì „ì†¡ ìŠ¤í™(ìµœê·¼íŒ)</strong> : stdio &amp; Streamable HTTP, ë³´ì•ˆ ì£¼ì˜ì‚¬í•­, ì„¸ì…˜/ì¬ì‹œë„ íë¦„ <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/transports">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>MCP í´ë¼ì´ì–¸íŠ¸ ë§Œë“¤ê¸° íŠœí† ë¦¬ì–¼</strong>(ì–¸ì–´ë³„) <a href="https://modelcontextprotocol.io/docs/develop/build-client">Model Context Protocol</a></p>
  </li>
  <li>
    <p><strong>TS/Python ê³µì‹ SDK</strong>(ì„œë²„Â·í´ë¼ì´ì–¸íŠ¸, ì˜ˆì œ ë‹¤ìˆ˜) <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>
  </li>
  <li>
    <p><strong>GPT-OSS ë ˆí¬</strong> : vLLM ì„œë¹™, Harmony/íˆ´ ì‚¬ìš©ë²•, ë¸Œë¼ìš°ì € íˆ´ ì˜ˆì‹œ <a href="https://github.com/openai/gpt-oss">GitHub+1</a></p>
  </li>
  <li>
    <p><strong>ì»¤ë®¤ë‹ˆí‹° ì„œë²„ ëª¨ìŒ</strong> : GitHub/íŒŒì¼/DB/í´ë¼ìš°ë“œ ë“± MCP ì„œë²„ ì¹´íƒˆë¡œê·¸ <a href="https://github.com/punkpeye/awesome-mcp-servers?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´, <strong>Python/Node ì¤‘ ì„ í˜¸í•˜ì‹œëŠ” ì–¸ì–´ë¡œ</strong> ìµœì†Œ ë¸Œë¦¬ì§€ ì½”ë“œ(â‰ˆ100~150ì¤„)ê¹Œì§€ ë°”ë¡œ ì‘ì„±í•´ ë“œë¦´ê²Œìš”. ëª¨ë¸ í˜¸ì¶œì€ <strong>í˜„ì¬ ì“°ì‹œëŠ” GPT-OSS ì—”ë“œí¬ì¸íŠ¸</strong>(OpenAI í˜¸í™˜)ë¡œ ê·¸ëŒ€ë¡œ ë³´ë‚´ê³ , MCP íˆ´ í˜¸ì¶œ ë£¨í”„ë¥¼ ì–¹ì–´ë“œë¦½ë‹ˆë‹¤.</p>

<p class="chat--user">

ì‹œë‚˜ë¦¬ì˜¤ Aë¥¼ ë³´ì. ê·¸ëŸ¼ ê²°êµ­ forë¬¸ ëŒë¦¬ë¼ëŠ” ê±´ê°€?

</p>

<p>ì§§ì€ ë‹µ: <strong>ê·¸ëƒ¥ â€œforë¬¸ í•œ ë²ˆâ€ì´ ì•„ë‹ˆë¼ â€œíˆ´-í˜¸ì¶œ ë£¨í”„(reactive loop)â€</strong>ì˜ˆìš”.<br />
ëª¨ë¸ì´ <code class="language-plaintext highlighter-rouge">tool_use</code>(=function call)ì„ ë‚´ë³´ë‚¼ ë•Œë§ˆë‹¤ í•´ë‹¹ MCP íˆ´ì„ ì‹¤í–‰í•˜ê³ , <strong>ê·¸ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— ë¨¹ì—¬ì„œ</strong> ë‹¤ìŒ ì‘ë‹µì„ ë°›ëŠ” ê±¸ <strong>ìµœëŒ€ NíšŒ</strong> ë°˜ë³µí•˜ë‹¤ê°€, ë” ì´ìƒ íˆ´ í˜¸ì¶œì´ ì—†ìœ¼ë©´ ì¢…ë£Œí•©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ë¥¼ ë‹¨ê³„ë³„ë¡œ ë³´ë©´ ê°ì´ ë”± ì™€ìš”.</p>

<hr />

<h1 id="step-by-step-í˜¸ìŠ¤íŠ¸ë¸Œë¦¬ì§€-ì œì–´-íë¦„">Step-by-step: í˜¸ìŠ¤íŠ¸(ë¸Œë¦¬ì§€) ì œì–´ íë¦„</h1>

<ol>
  <li>
    <p><strong>MCP ì„œë²„ì™€ ì„¸ì…˜</strong> ì—´ê¸° â†’ <code class="language-plaintext highlighter-rouge">tools/list</code>ë¡œ íˆ´ ìŠ¤í‚¤ë§ˆ ìˆ˜ì§‘</p>
  </li>
  <li>
    <p><strong>íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ëª¨ë¸ì— ì£¼ì…</strong></p>

    <ul>
      <li>(ì˜ˆ: GPT-OSSëŠ” Harmony ìŠ¤íƒ€ì¼ì´ë©´ ê·¸ ê·œê²©ëŒ€ë¡œ, ì¼ë°˜ OpenAI í˜¸í™˜ì´ë©´ <code class="language-plaintext highlighter-rouge">tools</code>/<code class="language-plaintext highlighter-rouge">function</code> í˜•ì‹ìœ¼ë¡œ)</li>
    </ul>
  </li>
  <li>
    <p><strong>ëŒ€í™” ì‹œì‘</strong> : <code class="language-plaintext highlighter-rouge">[system(toolì •ì˜), user(ì‚¬ìš©ììš”ì²­)]</code>ë¡œ 1ì°¨ í˜¸ì¶œ</p>
  </li>
  <li>
    <p><strong>ì‘ë‹µ ê²€ì‚¬</strong></p>

    <ul>
      <li>
        <p>ì‘ë‹µì— <code class="language-plaintext highlighter-rouge">tool_use</code>(=tool/function call)ê°€ ì—†ë‹¤ â†’ <strong>ìµœì¢… ë‹µë³€</strong> ìœ¼ë¡œ ì¢…ë£Œ</p>
      </li>
      <li>
        <p>ìˆìœ¼ë©´ â†’ ê° í˜¸ì¶œì„ <strong>MCP <code class="language-plaintext highlighter-rouge">tools/call</code></strong>ë¡œ ì‹¤í–‰</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">tool_result</code> ì£¼ì…</strong>: ê° í˜¸ì¶œ ê²°ê³¼ë¥¼ ëª¨ë¸ì— ë‹¤ì‹œ ì „ë‹¬ â†’ 3~4ë¥¼ <strong>ë°˜ë³µ</strong></p>
  </li>
  <li>
    <p><strong>ì¢…ë£Œ ì¡°ê±´</strong> :</p>

    <ul>
      <li>
        <p>ë” ì´ìƒ <code class="language-plaintext highlighter-rouge">tool_use</code> ì—†ìŒ</p>
      </li>
      <li>
        <p>ì•ˆì „ì¥ì¹˜(ìµœëŒ€ í™‰ ìˆ˜, ì‹œê°„ ì´ˆê³¼, í† í° í•œë„, ì‚¬ìš©ì ì·¨ì†Œ)</p>
      </li>
    </ul>
  </li>
</ol>

<blockquote>
  <p>ì¦‰, <strong>â€œëª¨ë¸ â†’(ìš”ì²­)â†’ MCP ì‹¤í–‰ â†’(ê²°ê³¼)â†’ ëª¨ë¸â€</strong>ì´ í•œ í„´ì„ ì´ë£¨ê³ , ì´ê±¸ <strong>while ë£¨í”„</strong> ë¡œ êµ´ë¦½ë‹ˆë‹¤.<br />
 í•„ìš”í•˜ë©´ í•œ í„´ ì•ˆì˜ ì—¬ëŸ¬ <code class="language-plaintext highlighter-rouge">tool_use</code>ë¥¼ <strong>ë³‘ë ¬</strong> ë¡œ ì‹¤í–‰í•  ìˆ˜ë„ ìˆì–´ìš”.</p>
</blockquote>

<hr />

<h1 id="ìµœì†Œ-ë£¨í”„ì˜ì‚¬ì½”ë“œ">ìµœì†Œ ë£¨í”„(ì˜ì‚¬ì½”ë“œ)</h1>

<p>ì–¸ì–´/ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒê´€ì—†ì´ <strong>íŒ¨í„´</strong> ë§Œ ì¡ì•„ë‘ë©´ ë©ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pseudo: OpenAI í˜¸í™˜ ChatCompletions + MCP client
</span>
<span class="n">mcp</span> <span class="o">=</span> <span class="nf">connect_mcp_server</span><span class="p">(...)</span>                <span class="c1"># 1) MCP ì„¸ì…˜
</span><span class="n">tools</span> <span class="o">=</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>                     <span class="c1"># 2) íˆ´ ìŠ¤í‚¤ë§ˆ
</span>
<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
  <span class="nf">system_msg_from</span><span class="p">(</span><span class="n">tools</span><span class="p">),</span>                    <span class="c1"># 2) ëª¨ë¸ì— íˆ´ ì •ì˜ ì£¼ì… (Harmony/Tools ë“±)
</span>  <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">}</span>
<span class="p">]</span>

<span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="k">for</span> <span class="n">hop</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">MAX_HOPS</span><span class="p">):</span>                  <span class="c1"># â† í•µì‹¬ ë£¨í”„ (forë“  whileë“  ìƒê´€ ì—†ìŒ)
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="nf">chat_completions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="nf">to_openai_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">))</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
        <span class="c1"># 6) ì¢…ë£Œ: ìµœì¢… ë‹µë³€
</span>        <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
        <span class="k">break</span>

    <span class="c1"># 4) MCP íˆ´ ì‹¤í–‰ (í•„ìš” ì‹œ ë³‘ë ¬)
</span>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>     <span class="c1"># 4) MCP tools/call
</span>        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
          <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
          <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
          <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="c1"># 5) ëª¨ë¸ì— ê²°ê³¼ ì¬ì£¼ì…
</span>    <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">([</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">results</span><span class="p">])</span>
</code></pre></div></div>

<blockquote>
  <p>í¬ì¸íŠ¸</p>

  <ul>
    <li>
      <p><strong>id ë§¤ì¹­</strong> : <code class="language-plaintext highlighter-rouge">tool_call_id</code> â†” MCP ì‹¤í–‰ ê²°ê³¼ë¥¼ 1:1ë¡œ ë§¤ì¹­í•´ì•¼ ëª¨ë¸ì´ ë¬¸ë§¥ì„ ì´ì–´ë°›ìŠµë‹ˆë‹¤.</p>
    </li>
    <li>
      <p><strong>ë³‘ë ¬ ì‹¤í–‰</strong> : ë™ì¼ í„´ì˜ ì—¬ëŸ¬ <code class="language-plaintext highlighter-rouge">tool_use</code>ëŠ” <code class="language-plaintext highlighter-rouge">Promise.all</code>/<code class="language-plaintext highlighter-rouge">asyncio.gather</code>ë¡œ ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥.</p>
    </li>
    <li>
      <p><strong>ì•ˆì „ì¥ì¹˜</strong> : <code class="language-plaintext highlighter-rouge">MAX_HOPS</code>, <code class="language-plaintext highlighter-rouge">timeout</code>, <code class="language-plaintext highlighter-rouge">rate limit</code>, ì‚¬ìš©ì í™•ì¸(UI ìŠ¹ì¸) ë„£ê¸°.</p>
    </li>
    <li>
      <p><strong>ìŠ¤íŠ¸ë¦¬ë°</strong> : ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì´ë©´, ë¶€ë¶„ í† í° ì¤‘ê°„ì— <code class="language-plaintext highlighter-rouge">tool_use</code> ì‹ í˜¸ê°€ ë‚˜ì˜¤ê¸°ë„ í•˜ë‹ˆ íŒŒì„œ/ì´ë²¤íŠ¸ë¡œ ì²˜ë¦¬.</p>
    </li>
  </ul>

</blockquote>

<hr />

<h1 id="typescript-ì˜ˆì‹œìš”ì§€">TypeScript ì˜ˆì‹œ(ìš”ì§€)</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

import OpenAI from "openai";             // GPT-OSSì˜ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë°”ê¿”ì£¼ì„¸ìš”
import { connect } from "mcp-client";    // ê°€ìƒì˜ MCP í´ë¼ì´ì–¸íŠ¸ APIë¼ê³  ê°€ì •

const client = new OpenAI({
  baseURL: process.env.OSS_BASE_URL,     // ì˜ˆ: http://localhost:8000/v1
  apiKey: process.env.OSS_API_KEY || "dummy"
});

const mcp = await connect({ transport: "stdio" /* ë˜ëŠ” http */ });
const tools = await mcp.listTools();

const messages: any[] = [
  systemMsgFrom(tools),                   // Harmony ë˜ëŠ” tools ì •ì˜ ì‚½ì…
  { role: "user", content: process.argv.slice(2).join(" ") }
];

for (let hop = 0; hop &lt; 8; hop++) {
  const res = await client.chat.completions.create({
    model: "gpt-oss-20b",
    messages,
    tools: toOpenAITools(tools)          // OpenAI function-calling ê·œê²©ìœ¼ë¡œ ë³€í™˜
  });

  const msg = res.choices[0].message;
  const calls = msg.tool_calls || [];
  if (!calls.length) {
    console.log(msg.content);
    break;
  }

  const results = await Promise.all(calls.map(async (c) =&gt; {
    const args = JSON.parse(c.function.arguments || "{}");
    const out = await mcp.callTool(c.function.name, args);
    return { role: "tool", tool_call_id: c.id, content: JSON.stringify(out) };
  }));

  messages.push(msg, ...results);
}
</code></pre></div></div>

<hr />

<h2 id="ê·¸ë˜ì„œ-forë¬¸-ëŒë¦¬ë©´-ëì˜-ì •í™•í•œ-ë‹µ">ê·¸ë˜ì„œ, â€œforë¬¸ ëŒë¦¬ë©´ ë?â€ì˜ ì •í™•í•œ ë‹µ</h2>

<ul>
  <li>
    <p><strong>ê°œë…ì ìœ¼ë¡œëŠ” ë§ì•„ìš”</strong> : â€œë°˜ë³µì ìœ¼ë¡œ â†’ ëª¨ë¸ í˜¸ì¶œ â†’ MCP íˆ´ ì‹¤í–‰ â†’ ê²°ê³¼ ì¬ì£¼ì…â€ ë£¨í”„ë¥¼ ë•ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í•˜ì§€ë§Œ ë‹¨ìˆœí•œ forë¬¸ ì´ìƒ</strong> ì…ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>(1) <strong>id ë§¤ì¹­/ê²°ê³¼ ì£¼ì… ê·œì•½</strong></p>
      </li>
      <li>
        <p>(2) <strong>ë³‘ë ¬ ì‹¤í–‰/ì—ëŸ¬Â·íƒ€ì„ì•„ì›ƒ/ì¬ì‹œë„</strong></p>
      </li>
      <li>
        <p>(3) <strong>ìµœëŒ€ í™‰Â·í† í°/ë¹„ìš© ê°€ë“œ</strong></p>
      </li>
      <li>
        <p>(4) <strong>ì‚¬ìš©ì ìŠ¹ì¸/ë¡œê¹…/ê¶Œí•œ ìŠ¤ì½”í”„</strong></p>
      </li>
      <li>
        <p>(5) (HTTP ì „ì†¡ ì‹œ) <strong>ì„¸ì…˜Â·CORSÂ·Origin ê²€ì¦</strong><br />
ê°™ì€ ìš´ì˜ ìš”ì†Œê°€ ë“¤ì–´ê°€ì•¼ â€œí”„ë¡œë•ì…˜ìŠ¤ëŸ¬ìš´â€ ë£¨í”„ê°€ ë©ë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´, <strong>ì§€ê¸ˆ ì“°ì‹œëŠ” GPT-OSS ì—”ë“œí¬ì¸íŠ¸ URL ê¸°ì¤€</strong> ìœ¼ë¡œ ëŒì•„ê°€ëŠ” ìµœì†Œ ë¸Œë¦¬ì§€ ì½”ë“œë¥¼(íŒŒì´ì¬/TS ì¤‘ ì„ í˜¸ë¡œ) ë°”ë¡œ ì§œì„œ ë“œë¦´ê²Œìš”â€”íˆ´ ì •ì˜ ë³€í™˜ë¶€í„° <code class="language-plaintext highlighter-rouge">tool_result</code> ì£¼ì…, ë³‘ë ¬ í˜¸ì¶œ/íƒ€ì„ì•„ì›ƒê¹Œì§€ ë„£ì€ ë²„ì „ìœ¼ë¡œìš”.</p>

<p class="chat--user">

ê·¸ë‹ˆê¹Œ ê·¸ëƒ¥ whileë¬¸ ëŒë¦¬ëŠ”ê±°ì–ì•„

</p>

<p>ë§ì•„ìš”â€”<strong>ë³¸ì§ˆì€ while ë£¨í”„</strong> ì˜ˆìš”.<br />
â€œëª¨ë¸ â†’ íˆ´ í˜¸ì¶œ ì‹ í˜¸ í™•ì¸ â†’ MCP <code class="language-plaintext highlighter-rouge">tools/call</code> ì‹¤í–‰ â†’ ê²°ê³¼ ì¬ì£¼ì…â€ì„ <strong>íˆ´ í˜¸ì¶œì´ ì‚¬ë¼ì§ˆ ë•Œê¹Œì§€</strong>(ë˜ëŠ” ìµœëŒ€ í™‰ ìˆ˜ê¹Œì§€) ë°˜ë³µí•©ë‹ˆë‹¤.</p>

<h3 id="ë™ì‘ì„-ë”±-ì •ë¦¬í•˜ë©´">ë™ì‘ì„ ë”± ì •ë¦¬í•˜ë©´</h3>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tools/list</code>ë¡œ MCP íˆ´ ìŠ¤í‚¤ë§ˆ ìˆ˜ì§‘ â†’ ì‹œìŠ¤í…œ/íˆ´ ì •ì˜ë¡œ <strong>ëª¨ë¸ì— ì£¼ì…</strong></p>
  </li>
  <li>
    <p><strong>ëª¨ë¸ í˜¸ì¶œ</strong> â†’ ì‘ë‹µì— <code class="language-plaintext highlighter-rouge">tool_use</code>(=function call)ê°€ ìˆëŠ”ì§€ í™•ì¸</p>
  </li>
  <li>
    <p>ìˆìœ¼ë©´ ê·¸ë§Œí¼ <strong>MCP<code class="language-plaintext highlighter-rouge">tools/call</code> ì‹¤í–‰</strong>(ë™í„´ ë‹¤ê±´ì€ ë³‘ë ¬ ê°€ëŠ¥)</p>
  </li>
  <li>
    <p>ê° ê²°ê³¼ë¥¼ <code class="language-plaintext highlighter-rouge">tool_call_id</code>ì— <strong>1:1 ë§¤ì¹­</strong> í•´ <strong>tool ê²°ê³¼ ë©”ì‹œì§€</strong> ë¡œ <strong>ë‹¤ì‹œ ëª¨ë¸ì— ë„£ê¸°</strong></p>
  </li>
  <li>
    <p>2â€“4ë¥¼ <strong>while</strong> ë¡œ ë°˜ë³µ (ì¢…ë£Œ: ë” ì´ìƒ <code class="language-plaintext highlighter-rouge">tool_use</code> ì—†ìŒ, <code class="language-plaintext highlighter-rouge">MAX_HOPS</code>, íƒ€ì„ì•„ì›ƒ ë“±)</p>
  </li>
</ol>

<h3 id="ìµœì†Œ-ì˜ˆíŒŒì´ì¬í’">ìµœì†Œ ì˜ˆ(íŒŒì´ì¬í’)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nf">system_msg_from</span><span class="p">(</span><span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()),</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">}]</span>
<span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">hop</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="n">hop</span> <span class="o">&lt;</span> <span class="n">MAX_HOPS</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="nf">chat_completions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="nf">to_openai_tools</span><span class="p">(</span><span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()))</span>
    <span class="n">msg</span>  <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>                      <span class="c1"># ì¢…ë£Œ ì¡°ê±´
</span>        <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="k">break</span>

    <span class="n">tool_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>                    <span class="c1"># ë™í„´ ë‹¤ê±´ì´ë©´ ë³‘ë ¬ ì²˜ë¦¬ ê¶Œì¥
</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">]</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span>  <span class="o">=</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>     <span class="c1"># MCP tools/call
</span>        <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>         <span class="c1"># â† ë°˜ë“œì‹œ ë§¤ì¹­!
</span>            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="n">messages</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">tool_results</span><span class="p">]</span>   <span class="c1"># ì‘ë‹µê³¼ ê²°ê³¼ë¥¼ ëª¨ë‘ ëˆ„ì 
</span>    <span class="n">hop</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></div>

<h3 id="ì‹¤ë¬´-íŒí•œ-ì¤„ì”©">ì‹¤ë¬´ íŒ(í•œ ì¤„ì”©)</h3>

<ul>
  <li>
    <p><strong>while</strong> ì€ ë§ëŠ”ë°, <strong>ê°€ë“œë ˆì¼</strong> ì´ í•µì‹¬: <code class="language-plaintext highlighter-rouge">MAX_HOPS</code>, per-call <strong>timeout/ì¬ì‹œë„</strong> , ì‚¬ìš©ì <strong>ìŠ¹ì¸</strong> , ë¡œê¹….</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tool_call_id</code> ë§¤ì¹­ ëˆ„ë½/<code class="language-plaintext highlighter-rouge">messages</code> ëˆ„ì  ëˆ„ë½ì´ ê°€ì¥ í”í•œ ë²„ê·¸.</p>
  </li>
  <li>
    <p>í•œ í„´ì— ì—¬ëŸ¬ <code class="language-plaintext highlighter-rouge">tool_use</code>ëŠ” <strong>ë³‘ë ¬</strong> ì²˜ë¦¬í•˜ê³ , ì‹¤íŒ¨í•œ ê²ƒë§Œ ì„ íƒ ì¬ì‹œë„.</p>
  </li>
  <li>
    <p>ìŠ¤íŠ¸ë¦¬ë°ì´ë©´ ì¤‘ê°„ì— <code class="language-plaintext highlighter-rouge">tool_use</code> ì´ë²¤íŠ¸ê°€ ë‚˜ì˜¬ ìˆ˜ ìˆìœ¼ë‹ˆ <strong>ì´ë²¤íŠ¸ íŒŒì„œ</strong> ë¡œ ì²˜ë¦¬.</p>
  </li>
</ul>

<p>ê²°ë¡ : ë„¤, <strong>â€œwhileë¬¸ìœ¼ë¡œ ë„ëŠ” ë°˜ì‘í˜• íˆ´-í˜¸ì¶œ ë£¨í”„â€</strong>ë¼ê³  ì´í•´í•˜ì‹œë©´ ì •í™•í•©ë‹ˆë‹¤.</p>

<p class="chat--user">

pythonì—ì„œ AsyncOpenAI ë¡œ client.chat.completions.create ë¥¼ í†µí•´ì„œ í†µì‹ ì„ ì´ë¯¸ í•˜ê³  ìˆê±°ë“ ? ì´ê±¸ ê¸°ë°˜ìœ¼ë¡œ íŒŒì´ì¬ ì½”ë“œ í•œ ë²ˆ ìµœëŒ€í•œ ê¼¼ê¼¼í•˜ê²Œ ë§Œë“¤ì–´ë³´ì.

</p>

<p>ì¢‹ìŠµë‹ˆë‹¤. ì´ë¯¸ <strong>AsyncOpenAI</strong> ì˜ <code class="language-plaintext highlighter-rouge">client.chat.completions.create(...)</code>ë¡œ ëª¨ë¸ì„ í˜¸ì¶œí•˜ê³  ê³„ì‹œë‹ˆ, ê·¸ ìœ„ì— <strong>MCP íˆ´ í˜¸ì¶œ ë£¨í”„(while loop)</strong>ë¥¼ ì–¹ì€ <strong>í”„ë¡œë•ì…˜ìš© ë¸Œë¦¬ì§€</strong> ìƒ˜í”Œì„ ë“œë¦´ê²Œìš”.<br />
ì•„ë˜ ì½”ë“œëŠ” ë‹¤ìŒì„ ëª¨ë‘ í¬í•¨í•©ë‹ˆë‹¤.</p>

<ul>
  <li>
    <p>MCP ì„œë²„ ì—°ê²°(stdio/HTTP ì¤‘ íƒ1)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tools/list</code> â†’ OpenAI í•¨ìˆ˜ í¬ë§·ìœ¼ë¡œ ë³€í™˜</p>
  </li>
  <li>
    <p>ëª¨ë¸ ì‘ë‹µì˜ <code class="language-plaintext highlighter-rouge">tool_calls</code> ë³‘ë ¬ ì‹¤í–‰(<code class="language-plaintext highlighter-rouge">asyncio.gather</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tool_call_id</code> 1:1 ë§¤ì¹­ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">tool</code> ë©”ì‹œì§€ ì¬ì£¼ì…</p>
  </li>
  <li>
    <p>ìµœëŒ€ í™‰ ìˆ˜, per-call íƒ€ì„ì•„ì›ƒ, ì¬ì‹œë„, ì˜ˆì™¸ ì²˜ë¦¬</p>
  </li>
</ul>

<blockquote>
  <p>ì˜ì¡´ì„±(ì˜ˆì‹œ):<br />
 <code class="language-plaintext highlighter-rouge">pip install openai anyio</code> + (MCP Python SDK: ë³´ìœ í•˜ì‹  SDK ì´ë¦„/ë²„ì „ì— ë§ì¶° <code class="language-plaintext highlighter-rouge">mcp</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">modelcontextprotocol</code> ê³„ì—´ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”)</p>
</blockquote>

<hr />

<h1 id="íŒŒì´ì¬-asyncopenai--mcp-ë¸Œë¦¬ì§€-ì™„ì„±ë³¸">íŒŒì´ì¬: AsyncOpenAI Ã— MCP ë¸Œë¦¬ì§€ (ì™„ì„±ë³¸)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">"""</span><span class="s">
mcp_bridge.py

- AsyncOpenAI Chat Completions ê¸°ë°˜ì˜ MCP ë¸Œë¦¬ì§€
- while ë£¨í”„: ëª¨ë¸ -&gt; MCP tools/call -&gt; ê²°ê³¼ ì¬ì£¼ì… -&gt; ì¢…ë£Œ ì¡°ê±´ê¹Œì§€ ë°˜ë³µ
</span><span class="sh">"""</span>

<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># === MCP SDK ê°€ì ¸ì˜¤ê¸° ===
# ì‚¬ìš© ì¤‘ì¸ MCP Python SDKì— ë§ê²Œ import ê²½ë¡œë¥¼ ì¡°ì •í•˜ì„¸ìš”.
# ì•„ë˜ëŠ” ê°€ì¥ í”í•œ ë„¤ì´ë°ì„ ê°€ì •í•œ ì˜ˆì‹œì…ë‹ˆë‹¤.
</span><span class="k">try</span><span class="p">:</span>
    <span class="c1"># ì˜ˆ: ê³µì‹ MCP Python SDK
</span>    <span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
    <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioTransport</span>
    <span class="c1"># (HTTP í´ë¼ì´ì–¸íŠ¸ê°€ SDKì— ìˆë‹¤ë©´ í•¨ê»˜ import)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.client.http</span> <span class="kn">import</span> <span class="n">HttpClientTransport</span>  <span class="c1"># ìˆì„ ë•Œë§Œ ì‚¬ìš©
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">HttpClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">MCP Python SDK import ì‹¤íŒ¨. ì„¤ì¹˜ ë° ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">ì˜ˆ: pip install modelcontextprotocol  ë˜ëŠ”  pip install mcp</span><span class="sh">"</span>
    <span class="p">)</span> <span class="k">from</span> <span class="n">e</span>

<span class="c1"># ------------------------------------------------------------
# ë°ì´í„° ëª¨ë¸
# ------------------------------------------------------------
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">McpTool</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">input_schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>
<span class="c1"># ------------------------------------------------------------
# MCP í´ë¼ì´ì–¸íŠ¸ ë˜í¼
# ------------------------------------------------------------
</span><span class="k">class</span> <span class="nc">SimpleMcpClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    MCP í´ë¼ì´ì–¸íŠ¸ë¥¼ ê°„ë‹¨ ë˜í•‘. SDKì˜ ì‹¤ì œ ì¸í„°í˜ì´ìŠ¤ì— ë§ê²Œ ì¡°ì •í•˜ì„¸ìš”.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">stdio_cmd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdio_env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">http_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">http_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stdio_cmd</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioTransport</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">stdio_cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">stdio_env</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">elif</span> <span class="n">http_url</span> <span class="ow">and</span> <span class="n">HttpClientTransport</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="nc">HttpClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">http_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">http_headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">stdio_cmd ë˜ëŠ” http_url ì¤‘ í•˜ë‚˜ëŠ” í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClientSession</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">SimpleMcpClient</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">()</span>  <span class="c1"># ì„¸ì…˜/initialize í•¸ë“œì…°ì´í¬
</span>        <span class="k">return</span> <span class="n">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>

    <span class="c1"># ---- ê¸°ëŠ¥: tools/list ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">McpTool</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">MCP ì„¸ì…˜ì´ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</span><span class="sh">"</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                <span class="nc">McpTool</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="n">input_schema</span><span class="o">=</span><span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">inputSchema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="c1"># ---- ê¸°ëŠ¥: tools/call ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        MCP tools/call ì‹¤í–‰ í›„ ê²°ê³¼ë¥¼ í†µì¼ëœ dictë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
        SDKë§ˆë‹¤ resp.content í˜•íƒœê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì—¬ê¸°ì„œ ì •ê·œí™”í•˜ì„¸ìš”.
        </span><span class="sh">"""</span>
        <span class="k">assert</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">MCP ì„¸ì…˜ì´ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</span><span class="sh">"</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># content ì •ê·œí™” ì˜ˆì‹œ:
</span>        <span class="c1"># resp.contentê°€ [{"type":"text","text":"..."}, {"type":"json","json":{...}}] í˜•íƒœë¼ê³  ê°€ì •
</span>        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">json_obj</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">json_obj</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span> <span class="k">if</span> <span class="n">t</span><span class="p">])</span>
                <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_obj</span>
                <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="n">__dict__</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">]</span>  <span class="c1"># ë””ë²„ê¹…ìš©
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># í˜¹ì‹œ ë‹¤ë¥¸ í˜•íƒœë©´ í†µìœ¼ë¡œ ê°ì‹¸ì„œ ë°˜í™˜
</span>                <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ------------------------------------------------------------
# ìœ í‹¸: MCP íˆ´ì„ OpenAI tools í¬ë§·ìœ¼ë¡œ ë³€í™˜
# ------------------------------------------------------------
</span><span class="k">def</span> <span class="nf">mcp_tools_to_openai_tools</span><span class="p">(</span><span class="n">mcp_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpTool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    OpenAI Chat Completions `tools` íŒŒë¼ë¯¸í„° ê·œê²©:
    [
      {
        </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">: {
          </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: str,
          </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">: str,
          </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">: {JSON Schema}
        }
      }
    ]
    </span><span class="sh">"""</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">64</span><span class="p">]</span>  <span class="c1"># OpenAI ì œì•½: ìµœëŒ€ 64ì ê¶Œì¥
</span>        <span class="n">params</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">input_schema</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="c1"># ì¼ë¶€ ì„œë²„ê°€ "object" ìƒëµ ì‹œ ëŒ€ë¹„
</span>            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">}</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ------------------------------------------------------------
# ë¸Œë¦¬ì§€: ëª¨ë¸ &lt;-&gt; MCP í˜¸ì¶œ ë£¨í”„
# ------------------------------------------------------------
</span><span class="k">class</span> <span class="nc">McpBridge</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">oai</span><span class="p">:</span> <span class="n">AsyncOpenAI</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mcp</span><span class="p">:</span> <span class="n">SimpleMcpClient</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">max_hops</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">per_tool_timeout_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">per_tool_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">oai</span> <span class="o">=</span> <span class="n">oai</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mcp</span> <span class="o">=</span> <span class="n">mcp</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_hops</span> <span class="o">=</span> <span class="n">max_hops</span>
        <span class="n">self</span><span class="p">.</span><span class="n">per_tool_timeout_s</span> <span class="o">=</span> <span class="n">per_tool_timeout_s</span>
        <span class="n">self</span><span class="p">.</span><span class="n">per_tool_retries</span> <span class="o">=</span> <span class="n">per_tool_retries</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="n">self</span><span class="p">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">You are a careful assistant. </span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">Call tools only when needed, keep arguments minimal and valid JSON.</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cached_openai_tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cached_openai_tools</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cached_openai_tools</span> <span class="o">=</span> <span class="nf">mcp_tools_to_openai_tools</span><span class="p">(</span><span class="n">mcp_tools</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_cached_openai_tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_call_one_tool_with_retry</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">call</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">
        ë‹¨ì¼ tool_call ì‹¤í–‰ + ì¬ì‹œë„/íƒ€ì„ì•„ì›ƒ.
        return: (tool_call_id, tool_result_message)
        </span><span class="sh">"""</span>
        <span class="n">tool_call_id</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">func</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>

        <span class="c1"># argumentsê°€ JSON íŒŒì‹± ë¶ˆê°€ì¼ ë•Œ ê´€ëŒ€í•œ íŒŒì„œ
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_str</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">args_str</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># ëª¨ë¸ì´ ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ë„˜ê¸¸ ìˆ˜ ìˆìœ¼ë‹ˆ ê°ì‹¼ë‹¤
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_str</span><span class="p">}</span>

        <span class="n">last_err</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">per_tool_retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># MCP tools/callì— íƒ€ì„ì•„ì›ƒ ì ìš©
</span>                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">mcp</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">per_tool_timeout_s</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># OpenAI chat.completionsì— ë„£ì„ tool ë©”ì‹œì§€ ê·œê²©
</span>                <span class="n">tool_msg</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="c1"># ëª¨ë¸ì´ ì†Œë¹„í•˜ê¸° ì‰½ê²Œ ë¬¸ìì—´ + json ëª¨ë‘ ì „ë‹¬
</span>                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">tool_msg</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_err</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">per_tool_retries</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>  <span class="c1"># ê°„ë‹¨ ë°±ì˜¤í”„
</span>                    <span class="k">continue</span>
                <span class="c1"># ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë‚´ìš©ì„ tool ê²°ê³¼ë¡œ ì „ë‹¬(ëª¨ë¸ì´ í•¸ë“¤ë§í•˜ê²Œ)
</span>                <span class="n">err_payload</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">tool_msg</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">err_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">tool_msg</span>
        <span class="c1"># ì´ë¡ ìƒ ë„ë‹¬ ë¶ˆê°€
</span>        <span class="k">raise</span> <span class="n">last_err</span> <span class="ow">or</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">unknown tool call failure</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        while ë£¨í”„ë¥¼ ëŒë©° MCP íˆ´ í˜¸ì¶œì„ ì²˜ë¦¬í•˜ê³  ìµœì¢… ë‹µë³€ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        </span><span class="sh">"""</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_tools</span><span class="p">()</span>

        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">system_prompt</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">final_text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">for</span> <span class="n">hop</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_hops</span><span class="p">):</span>
            <span class="c1"># 1) ëª¨ë¸ í˜¸ì¶œ
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">oai</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[]</span>

            <span class="c1"># 2) íˆ´ í˜¸ì¶œ ì—†ìœ¼ë©´ ì¢…ë£Œ
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">final_text</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
                <span class="k">break</span>

            <span class="c1"># 3) íˆ´ í˜¸ì¶œ ì‹¤í–‰(ë™í„´ ë³‘ë ¬ ê¶Œì¥)
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="nf">_call_one_tool_with_retry</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_call_one_tool_with_retry</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="c1"># 4) ëª¨ë¸ì— ê²°ê³¼ ì¬ì£¼ì…
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tool_calls</span>
            <span class="p">]})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># ------------------------------------------------------------
# ì‹¤í–‰ ì˜ˆì‹œ
# ------------------------------------------------------------
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">
    ì‚¬ìš©ë²•:
      export OPENAI_API_KEY=dummy
      # GPT-OSS ì—”ë“œí¬ì¸íŠ¸ë¥¼ OpenAI í˜¸í™˜ìœ¼ë¡œ ë„ì› ë‹¤ë©´:
      export OPENAI_BASE_URL=http://localhost:8000/v1
      python -m mcp_bridge </span><span class="sh">"</span><span class="s">ë ˆí¬ ì´ìŠˆ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="n">user_query</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">USER_QUERY</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬</span><span class="sh">"</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># AsyncOpenAI: GPT-OSSì˜ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¡œ base_url ì§€ì •
</span>    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># MCP ì„œë²„ ì—°ê²°: stdio ë˜ëŠ” HTTP ì¤‘ í•˜ë‚˜ íƒ1
</span>    <span class="c1"># (1) stdio ì˜ˆì‹œ: ë¡œì»¬ MCP ì„œë²„ ë°”ì´ë„ˆë¦¬/ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰
</span>    <span class="n">stdio_cmd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MCP_STDIO_CMD</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">stdio_args</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MCP_STDIO_ARGS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="n">stdio</span> <span class="o">=</span> <span class="p">[</span><span class="n">stdio_cmd</span><span class="p">,</span> <span class="o">*</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">stdio_args</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span><span class="p">])]</span> <span class="k">if</span> <span class="n">stdio_cmd</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="c1"># (2) HTTP ì˜ˆì‹œ: ì›ê²© MCP ì„œë²„
</span>    <span class="n">http_url</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MCP_HTTP_URL</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ì˜ˆ: http://127.0.0.1:3333/mcp
</span>    <span class="n">http_headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">Mcp-Session-Id</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MCP_SESSION_ID</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">demo-session</span><span class="sh">"</span><span class="p">)}</span>

    <span class="c1"># ìš°ì„ ìˆœìœ„: stdio &gt; http
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nc">SimpleMcpClient</span><span class="p">(</span><span class="n">stdio_cmd</span><span class="o">=</span><span class="n">stdio</span><span class="p">,</span> <span class="n">http_url</span><span class="o">=</span><span class="n">http_url</span><span class="p">,</span> <span class="n">http_headers</span><span class="o">=</span><span class="n">http_headers</span><span class="p">)</span> <span class="k">as</span> <span class="n">mcp</span><span class="p">:</span>
        <span class="n">bridge</span> <span class="o">=</span> <span class="nc">McpBridge</span><span class="p">(</span>
            <span class="n">oai</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp</span><span class="o">=</span><span class="n">mcp</span><span class="p">,</span>
            <span class="n">max_hops</span><span class="o">=</span><span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_HOPS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">8</span><span class="sh">"</span><span class="p">)),</span>
            <span class="n">per_tool_timeout_s</span><span class="o">=</span><span class="nf">float</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">TOOL_TIMEOUT_S</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">30</span><span class="sh">"</span><span class="p">)),</span>
            <span class="n">per_tool_retries</span><span class="o">=</span><span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">TOOL_RETRIES</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">)),</span>
            <span class="n">parallel</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">You are a tool-using assistant. </span><span class="sh">"</span>
                <span class="sh">"</span><span class="s">Only call tools when necessary. Keep outputs concise.</span><span class="sh">"</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bridge</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">user_query</span><span class="p">)</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== FINAL ANSWER ===</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[done in </span><span class="si">{</span><span class="n">dur</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s]</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="ì–´ë–»ê²Œ-ì“°ë©´-ë˜ë‚˜-step-by-step">ì–´ë–»ê²Œ ì“°ë©´ ë˜ë‚˜? (step-by-step)</h2>

<ol>
  <li>
    <p><strong>GPT-OSS ì—”ë“œí¬ì¸íŠ¸</strong>(OpenAI í˜¸í™˜) ì¤€ë¹„</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">OPENAI_BASE_URL</code>ë¥¼ ì—¬ëŸ¬ë¶„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì§€ì •</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">OPENAI_API_KEY</code>ëŠ” ì„œë²„ê°€ ìš”êµ¬í•˜ë©´ ë„£ê³ , ì•„ë‹ˆë©´ ì•„ë¬´ ë¬¸ìì—´ë„ OK</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>MCP ì„œë²„ í•˜ë‚˜ ê³¨ë¼ ì—°ê²°</strong></p>

    <ul>
      <li><strong>stdio</strong> : ë¡œì»¬ ì„œë²„ë¥¼ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¡œ ë„ìš°ë ¤ë©´
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arduino
       
export MCP_STDIO_CMD="npx"
export MCP_STDIO_ARGS="@modelcontextprotocol/server-github --stdio"
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<p>ì²˜ëŸ¼ ì»¤ë§¨ë“œë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ë„˜ê¸°ì„¸ìš”.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> * **HTTP** : ì›ê²© MCP ì„œë²„ê°€ ìˆìœ¼ë©´
   ```
   arduino
   
   export MCP_HTTP_URL="http://127.0.0.1:3333/mcp"
   export MCP_SESSION_ID="my-session-1"
   ```
</code></pre></div></div>

<ol>
  <li><strong>ì‹¤í–‰</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b
python mcp_bridge.py
</code></pre></div>    </div>
  </li>
</ol>

<p>ë˜ëŠ”
     <code class="language-plaintext highlighter-rouge">ini
     USER_QUERY="ìš°ë¦¬ ì´ìŠˆ ëª©ë¡ ì¤‘ ë²„ê·¸ë§Œ ìš”ì•½í•´ì¤˜" python mcp_bridge.py
    </code></p>

<ol>
  <li>
    <p><strong>í™•ì¥ í¬ì¸íŠ¸(í˜„ì—… íŒ)</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">McpBridge.run()</code> ì•ˆì˜ <code class="language-plaintext highlighter-rouge">temperature</code>, <code class="language-plaintext highlighter-rouge">tool_choice</code>, <code class="language-plaintext highlighter-rouge">system_prompt</code>ë¥¼ ìƒí™©ì— ë§ê²Œ ì¡°ì •</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">per_tool_timeout_s</code>, <code class="language-plaintext highlighter-rouge">per_tool_retries</code>ë¡œ MCP ì•ˆì •í™”</p>
      </li>
      <li>
        <p>ë©”ì‹œì§€ ë¡œê¹…/ê°ì‚¬ì˜ ê²½ìš°, <code class="language-plaintext highlighter-rouge">messages</code> ìŠ¤ëƒ…ìƒ·ê³¼ MCP í˜¸ì¶œ ë¡œê·¸ë¥¼ íŒŒì¼/DBì— ë‚¨ê¸°ì„¸ìš”</p>
      </li>
      <li>
        <p>í•œ í„´ ë‚´ ë‹¤ê±´ <code class="language-plaintext highlighter-rouge">tool_calls</code>ëŠ” ì´ë¯¸ <strong>ë³‘ë ¬</strong> ì²˜ë¦¬. ì‹¤íŒ¨í•œ ê²ƒë§Œ ë¶€ë¶„ ì¬ì‹œë„í•˜ë„ë¡ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ ê°€ëŠ¥</p>
      </li>
      <li>
        <p>í•„ìš”í•˜ë©´ <strong>ìŠ¤íŠ¸ë¦¬ë°</strong>(<code class="language-plaintext highlighter-rouge">stream=True</code>)ìœ¼ë¡œ ë³€ê²½í•˜ê³ , í† í° ì¤‘ê°„ <code class="language-plaintext highlighter-rouge">tool_calls</code> ì´ë²¤íŠ¸ë¥¼ íŒŒì‹±í•˜ëŠ” ì½”ë£¨í‹´ì„ ì¶”ê°€</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<p>í•„ìš”í•˜ì‹œë©´ ìœ„ ì½”ë“œë¥¼ <strong>ì—¬ëŸ¬ MCP ì„œë²„(ì˜ˆ: GitHub/FS/DB)</strong>ì™€ ë¶™ëŠ” ì‹¤ì „ ì˜ˆë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆí•´ì„œ ë“œë¦´ê²Œìš”. í˜„ì¬ ì“°ì‹œëŠ” <strong>MCP ì„œë²„ ëª…ë ¹/URL</strong> ì„ ì•Œë ¤ì£¼ì‹œë©´, <code class="language-plaintext highlighter-rouge">stdio_cmd/http_url</code>ì— ë§ì¶° ë°”ë¡œ ì‘ë™í•˜ëŠ” ë²„ì „ìœ¼ë¡œ ì†ë´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</p>

<p class="chat--user">

ì„œë²„ ì—†ì´ ê·¸ëƒ¥ ê°„ë‹¨í•œ íŒŒì¼ ì¡°íšŒ ê°™ì€ê±´ ê·¸ëƒ¥ íŒŒì´ì¬ ì½”ë“œë¡œë„ í•  ìˆ˜ ìˆì–ì•„. ê·¸ëŸ° ë°©ë²•ì€ ì–´ë•Œ?

</p>

<p>ë§ì•„ìš”â€”<strong>ê·¸ëƒ¥ ë¡œì»¬ íŒŒì´ì¬ í•¨ìˆ˜ë“¤ì„ â€œíˆ´â€ë¡œ ë…¸ì¶œ</strong> í•´ì„œ ëª¨ë¸ì´ ë¶€ë¥´ë©´ ì‹¤í–‰í•´ ì£¼ë©´ ë©ë‹ˆë‹¤. MCP ì„œë²„ëŠ” ê±´ë„ˆë›°ê³ , í˜¸ìŠ¤íŠ¸(ë¸Œë¦¬ì§€) ë ˆë²¨ì—ì„œ <strong>íŒŒì¼ ì‹œìŠ¤í…œ ì „ìš© íˆ´</strong> ì„ ì§ì ‘ êµ¬í˜„í•˜ëŠ” ê±°ì£ . ê°„ë‹¨â€§ë¹ ë¦„â€§ì˜ì¡´ì„± ì ê³ , ì‚¬ë‚´ìš© íŒŒì¼ íƒìƒ‰/ìš”ì•½ì—” ì¶©ë¶„íˆ ì¢‹ìŠµë‹ˆë‹¤.</p>

<p>ì•„ë˜ëŠ” ì—¬ëŸ¬ë¶„ì´ ì´ë¯¸ ì“°ê³  ê³„ì‹  <strong>AsyncOpenAI +<code class="language-plaintext highlighter-rouge">client.chat.completions.create</code></strong> ìœ„ì— ì–¹ëŠ”, <strong>ë¡œì»¬ íŒŒì¼ íˆ´ ë¸Œë¦¬ì§€(while ë£¨í”„)</strong> ì™„ì„± ì˜ˆì‹œì˜ˆìš”.</p>

<hr />

<h2 id="ì–´ë–»ê²Œ-ë™ì‘í•´">ì–´ë–»ê²Œ ë™ì‘í•´?</h2>

<ol>
  <li>
    <p><strong>íˆ´ ì •ì˜(JSON Schema)</strong> : <code class="language-plaintext highlighter-rouge">list_dir</code>, <code class="language-plaintext highlighter-rouge">read_text</code>, <code class="language-plaintext highlighter-rouge">find_in_files</code></p>
  </li>
  <li>
    <p><strong>ëª¨ë¸ í˜¸ì¶œ</strong> â†’ <code class="language-plaintext highlighter-rouge">tool_calls</code> ìˆë‚˜ í™•ì¸</p>
  </li>
  <li>
    <p>ìˆìœ¼ë©´ <strong>í•´ë‹¹ íŒŒì´ì¬ í•¨ìˆ˜ ì‹¤í–‰</strong>(ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ì•ˆì—ì„œë§Œ, í¬ê¸°/ê²½ë¡œ ê°€ë“œ)</p>
  </li>
  <li>
    <p><strong>tool ê²°ê³¼ ë©”ì‹œì§€</strong> ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— ì£¼ì…</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tool_calls</code>ê°€ ë” ì´ìƒ ì•ˆ ë‚˜ì˜¬ ë•Œê¹Œì§€ <strong>while</strong> ë°˜ë³µ</p>
  </li>
</ol>

<blockquote>
  <p>ë³´ì•ˆ ê°€ë“œ: ë£¨íŠ¸ ê³ ì •(<code class="language-plaintext highlighter-rouge">SAFE_ROOT</code>), ê²½ë¡œ ì •ê·œí™”/ë¶€ëª¨ íƒˆì¶œ ë°©ì§€, íŒŒì¼ í¬ê¸° ì œí•œ, ë°”ì´ë„ˆë¦¬ ì°¨ë‹¨, ì¸ì½”ë”© í´ë°±(utf-8, utf-8-sig, cp949), íƒ€ì„ì•„ì›ƒ, ì¬ì‹œë„.</p>
</blockquote>

<hr />

<h2 id="ì½”ë“œ-ë³µì‚¬-ë¶™ì—¬ë„£ê¸°">ì½”ë“œ (ë³µì‚¬-ë¶™ì—¬ë„£ê¸°)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># local_fs_tools_bridge.py
# AsyncOpenAI Ã— ë¡œì»¬ íŒŒì¼ íˆ´(ì„œë²„ ì—†ìŒ) Ã— while ë£¨í”„
# pip install openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">re</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># === ì„¤ì • ===
</span><span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SAFE_ROOT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)).</span><span class="nf">resolve</span><span class="p">()</span>  <span class="c1"># ì´ ë””ë ‰í† ë¦¬ ì•ˆì—ì„œë§Œ ì‘ë™
</span><span class="n">MAX_BYTES_READ</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_BYTES_READ</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">65536</span><span class="sh">"</span><span class="p">))</span>  <span class="c1"># 64KB
</span><span class="n">MAX_LIST_ENTRIES</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_LIST_ENTRIES</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">200</span><span class="sh">"</span><span class="p">))</span>
<span class="n">MAX_FILES_SCAN</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_FILES_SCAN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">400</span><span class="sh">"</span><span class="p">))</span>
<span class="n">MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># === ìœ í‹¸: ê²½ë¡œ ì•ˆì „ì„± ë³´ì¥ ===
</span><span class="k">def</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">SAFE_ROOT ê¸°ì¤€ ìƒëŒ€ê²½ë¡œë¥¼ ì ˆëŒ€ê²½ë¡œë¡œ ë³€í™˜í•˜ê³ , ë£¨íŠ¸ ë°– ì ‘ê·¼ì„ ì°¨ë‹¨.</span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAFE_ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path escapes SAFE_ROOT: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">_is_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ê°„ë‹¨í•œ ë°”ì´ë„ˆë¦¬ íŒë‹¨: ë„ ë°”ì´íŠ¸ ìœ ë¬´ + ê°€ë²¼ìš´ ë””ì½”ë”© ì‹œë„.</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">path</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
        <span class="k">if</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">head</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8-sig</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cp949</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">head</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># === ë¡œì»¬ íˆ´ êµ¬í˜„ ===
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">glob</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">,</span> <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">not found: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">base</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="n">parent</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">glob</span><span class="p">):</span>
        <span class="c1"># ìˆ¨ê¹€ íŒŒì¼ ì œì™¸ ì˜µì…˜
</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># SAFE_ROOT ë°– symlinkëŠ” ì°¨ë‹¨
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
            <span class="n">resolved</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MAX_LIST_ENTRIES</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">),</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">entries</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">tool_read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">maxb</span> <span class="o">=</span> <span class="n">max_bytes</span> <span class="ow">or</span> <span class="n">MAX_BYTES_READ</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">file not found: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">_is_text</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary or non-text file (blocked)</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">enc_used</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># ì¸ì½”ë”© í´ë°±
</span>    <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8-sig</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cp949</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">p</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">maxb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">enc_used</span> <span class="o">=</span> <span class="n">enc</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="n">truncated</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxb</span>
    <span class="k">if</span> <span class="n">truncated</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[:</span><span class="n">maxb</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">encoding</span><span class="sh">"</span><span class="p">:</span> <span class="n">enc_used</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">truncated</span><span class="sh">"</span><span class="p">:</span> <span class="n">truncated</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">tool_find_in_files</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                             <span class="n">glob</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">**/*</span><span class="sh">"</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                             <span class="n">max_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_hits_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_safe_join</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">dir not found: </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">case_sensitive</span> <span class="k">else</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">pattern</span> <span class="k">if</span> <span class="n">regex</span> <span class="k">else</span> <span class="n">re</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="n">flags</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">files_scanned</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">hit_files</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="n">max_files</span> <span class="ow">or</span> <span class="n">MAX_FILES_SCAN</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">glob</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">files_scanned</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
            <span class="n">resolved</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">_is_text</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">files_scanned</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># í¬ê¸° ì œí•œ ë‚´ì—ì„œë§Œ ìŠ¤ìº”
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">p</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">MAX_BYTES_READ</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rx</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">hits</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">line</span><span class="sh">"</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="sh">"</span><span class="s">preview</span><span class="sh">"</span><span class="p">:</span> <span class="n">line</span><span class="p">[:</span><span class="mi">300</span><span class="p">]})</span>
                <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_hits_per_file</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">hits</span><span class="p">:</span>
            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">hits</span><span class="sh">"</span><span class="p">:</span> <span class="n">hits</span><span class="p">})</span>
            <span class="n">hit_files</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">files_scanned</span><span class="sh">"</span><span class="p">:</span> <span class="n">files_scanned</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">hit_files</span><span class="sh">"</span><span class="p">:</span> <span class="n">hit_files</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">results</span><span class="sh">"</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">truncated_note</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Scanned up to </span><span class="si">{</span><span class="n">MAX_BYTES_READ</span><span class="si">}</span><span class="s"> bytes per file, </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s"> files max.</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># === OpenAI tools ìŠ¤í‚¤ë§ˆ ===
</span><span class="n">OPENAI_TOOLS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">List directory entries under SAFE_ROOT.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Relative dir path from SAFE_ROOT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">glob</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">glob pattern</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">include_hidden</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Read a text file with size/encoding safeguards.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Relative file path from SAFE_ROOT</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1048576</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">find_in_files</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Search for a string/regex across text files.</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string or regex</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">regex</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">glob</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">**/*</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">case_sensitive</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_files</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5000</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">max_hits_per_file</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># === ë¼ìš°í„° ===
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">call_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_list_dir</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_read_text</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">find_in_files</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_find_in_files</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">OpenAI SDK ê°ì²´ë¥¼ Chat API ì¬í˜¸ì¶œìš© dictë¡œ ë³€í™˜.</span><span class="sh">"""</span>
    <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">tool_calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_calls</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_query</span><span class="p">(</span><span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">system_prompt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">You can inspect files inside SAFE_ROOT only. </span><span class="sh">"</span>
        <span class="sa">f</span><span class="sh">"</span><span class="s">SAFE_ROOT is </span><span class="sh">'</span><span class="si">{</span><span class="n">SAFE_ROOT</span><span class="si">}</span><span class="sh">'</span><span class="s">. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Call tools only when needed. Prefer concise outputs.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_HOPS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">8</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">MAX_HOPS</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">OPENAI_TOOLS</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>  <span class="c1"># ì¢…ë£Œ
</span>            <span class="n">final_text</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            <span class="k">break</span>

        <span class="c1"># ë™í„´ ë³‘ë ¬ ì‹¤í–‰
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">_run_one</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">}</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="nf">call_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nf">_run_one</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">])</span>

        <span class="c1"># ì‘ë‹µ(assistant) + ê° tool ê²°ê³¼ë¥¼ ëˆ„ì 
</span>        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># === CLI ì‹¤í–‰ ===
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">sys</span>
    <span class="n">q</span> <span class="o">=</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">data í´ë”ì—ì„œ TODOê°€ ë“¤ì–´ê°„ íŒŒì¼ë“¤ ì°¾ì•„ì¤˜. ê·¸ë¦¬ê³  ìƒìœ„ 3ê°œë§Œ ìš”ì•½í•´.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[SAFE_ROOT] </span><span class="si">{</span><span class="n">SAFE_ROOT</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[QUERY] </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">run_query</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
</code></pre></div></div>

<hr />

<h2 id="ì‹¤í–‰-ë°©ë²•">ì‹¤í–‰ ë°©ë²•</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1) í™˜ê²½ë³€ìˆ˜: ì—¬ëŸ¬ë¶„ì˜ OpenAI-í˜¸í™˜ GPT-OSS ì—”ë“œí¬ì¸íŠ¸</span>
<span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b

<span class="c"># 2) íŒŒì¼ ì‹œìŠ¤í…œ ë£¨íŠ¸(ì´ ê²½ë¡œ ë°–ì€ ì ‘ê·¼ ê¸ˆì§€)</span>
<span class="nb">export </span><span class="nv">SAFE_ROOT</span><span class="o">=</span>/path/to/workspace

<span class="c"># 3) ì‹¤í–‰</span>
python local_fs_tools_bridge.py <span class="s2">"data í´ë”ì—ì„œ TODO í¬í•¨ íŒŒì¼ ì°¾ì•„ ìš”ì•½"</span>
</code></pre></div></div>

<hr />

<h2 id="ì–¸ì œ-ì´-ë°©ì‹ì´-ì¢‹ì€ê°€--ì•„ë‹Œê°€">ì–¸ì œ ì´ ë°©ì‹ì´ ì¢‹ì€ê°€ / ì•„ë‹Œê°€</h2>

<ul>
  <li>
    <p>ğŸ‘ <strong>ì¢‹ìŒ</strong> : ë‚´ë¶€ ìŠ¤í¬ë¦½íŠ¸Â·ë¦¬í¬ ì •ë¦¬, ë¡œê·¸ ì¡°ì‚¬, ë¹Œë“œ ì‚°ì¶œë¬¼ ê²€í†  ë“± â€œí•œ ë¨¸ì‹  ì•ˆâ€ ë‹¨ìˆœ ì˜¤í† ë©”ì´ì…˜</p>
  </li>
  <li>
    <p>ğŸ¤” <strong>ì•„ì‰¬ì›€</strong> : ì—¬ëŸ¬ ì•±/íŒ€ì—ì„œ <strong>ì¬ì‚¬ìš©</strong> í•˜ê±°ë‚˜, ë„¤íŠ¸ì›Œí¬ ìì›/DB/API ê°™ì€ <strong>ì›ê²© ë¦¬ì†ŒìŠ¤</strong> ê¹Œì§€ í‘œì¤€í™”í•˜ê³  ì‹¶ë‹¤ë©´ <strong>MCP ì„œë²„í™”</strong> ê°€ ì¥ì (ë°œê²¬ì„±Â·ê¶Œí•œÂ·ê°ì‚¬Â·ì¬ì‚¬ìš©)</p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´ ìœ„ íˆ´ì…‹ì— <code class="language-plaintext highlighter-rouge">write_text</code>, <code class="language-plaintext highlighter-rouge">tail</code>, <code class="language-plaintext highlighter-rouge">zip_list</code>, <code class="language-plaintext highlighter-rouge">json_query(jq)</code> ê°™ì€ íˆ´ì„ ì¶”ê°€í•´ ë“œë¦´ê²Œìš”. í˜„ì¬ ì“°ëŠ” í´ë” êµ¬ì¡°ë‚˜ ìš©ë¡€ë¥¼ ì•Œë ¤ì£¼ì‹œë©´, ìŠ¤í‚¤ë§ˆ/ê°€ë“œë¥¼ ë§ì¶° ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆí•´ ë“œë¦½ë‹ˆë‹¤.</p>

<p class="chat--user">

ì´ê±¸ í‘œì¤€í™”ëœ í˜•íƒœë¡œ í•  ìˆ˜ëŠ” ì—†ì„ê¹Œ? harmonyë„ ë‹¤ í˜¸í™˜ë˜ëŠ”ê±°ì•¼?

</p>

<p>ë§ì•„ìš”â€”<strong>í‘œì¤€í™”</strong> í•˜ë ¤ë©´ ë”± ë‘ ì¶•ë§Œ ì¡ìœ¼ë©´ ë©ë‹ˆë‹¤:<br />
(1) <strong>íˆ´/ë°ì´í„° ì¸í„°í˜ì´ìŠ¤ í‘œì¤€ = MCP</strong>(ì„œë²„Â·í´ë¼ì´ì–¸íŠ¸ ê·œì•½)<br />
(2) <strong>ëŒ€í™”/íˆ´í˜¸ì¶œ í¬ë§· í‘œì¤€ = Harmony</strong>(ëª¨ë¸ í”„ë¡¬í”„íŠ¸/ì‘ë‹µ í¬ë§·)<br />
ë‘˜ì€ <strong>ì„œë¡œ ë…ë¦½</strong> ì´ì§€ë§Œ ì˜ ë§ë¬¼ë¦½ë‹ˆë‹¤. MCPëŠ” â€œë„êµ¬ë¥¼ ì–´ë–»ê²Œ ë…¸ì¶œÂ·í˜¸ì¶œí• ê¹Œâ€ë¥¼ í‘œì¤€í™”í•˜ê³ , HarmonyëŠ” â€œëª¨ë¸ê³¼ì˜ ë©”ì‹œì§€ í¬ë§·â€ì„ í‘œì¤€í™”í•´ìš”. <a href="https://modelcontextprotocol.io/docs/learn/architecture?utm_source=chatgpt.com">modelcontextprotocol.io+1</a></p>

<hr />

<h1 id="ë¬´ì—‡ì´-í‘œì¤€ì¸ê°€-í•œëˆˆì—">ë¬´ì—‡ì´ â€œí‘œì¤€â€ì¸ê°€ (í•œëˆˆì—)</h1>

<ul>
  <li>
    <p><strong>MCP</strong> : JSON-RPC ê¸°ë°˜ í”„ë¡œí† ì½œ. í‘œì¤€ ì „ì†¡ì€ <strong>stdio</strong> ì™€ <strong>Streamable HTTP</strong> ë‘ ê°€ì§€. ê³µì‹ Python/TS SDKê°€ ìˆê³ , ì—¬ê¸°ì— ë§ì¶° íˆ´/ë¦¬ì†ŒìŠ¤ë¥¼ ë‚´ë³´ë‚´ë©´ ì–´ë–¤ í˜¸ìŠ¤íŠ¸/ì—ì´ì „íŠ¸ì—ì„œë„ ì¬ì‚¬ìš©ë©ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/transports?utm_source=chatgpt.com">modelcontextprotocol.io+2</a></p>
  </li>
  <li>
    <p><strong>Harmony</strong> : GPT-OSS ê³„ì—´ì´ í•™ìŠµí•œ <strong>ëŒ€í™”Â·íˆ´í˜¸ì¶œ í¬ë§·</strong>. Responses API ìŠ¤íƒ€ì¼ì„ ëª¨ì‚¬í•˜ë©°, <strong>ê³µì‹ ë Œë”ëŸ¬(openai-harmony)</strong>ê°€ ìˆì–´ Pythonì—ì„œë„ ê·¸ëŒ€ë¡œ ì”ë‹ˆë‹¤. (ì—¬ëŸ¬ ë°°í¬ì/ì„œë¹™ ì†”ë£¨ì…˜ì€ ë‚´ë¶€ì—ì„œ ìë™ ì²˜ë¦¬í•˜ê¸°ë„ í•¨) <a href="https://github.com/openai/harmony?utm_source=chatgpt.com">GitHub+1</a></p>
  </li>
</ul>

<blockquote>
  <p>ìš”ì•½: <strong>MCPë¡œ ë„êµ¬ ì¸¡ì„ í‘œì¤€í™”</strong> í•˜ê³ , <strong>Harmonyë¡œ ëª¨ë¸ ë©”ì‹œì§€ í¬ë§·ì„ í‘œì¤€í™”</strong> í•˜ë©´ ë.</p>
</blockquote>

<hr />

<h1 id="ë‚´ê°€-ê°€ì§„-ë¡œì»¬-íŒŒì´ì¬-í•¨ìˆ˜ë¥¼-í‘œì¤€í™”í•˜ëŠ”-ë‘-ê¸¸">ë‚´ê°€ ê°€ì§„ â€œë¡œì»¬ íŒŒì´ì¬ í•¨ìˆ˜â€ë¥¼ í‘œì¤€í™”í•˜ëŠ” ë‘ ê¸¸</h1>

<h2 id="a-ìµœì†Œ-ë¹„ìš©ìœ¼ë¡œ-mcp-ì„œë²„-ë¡œ-ê°ì‹¸ê¸°-ê¶Œì¥">A) ìµœì†Œ ë¹„ìš©ìœ¼ë¡œ <strong>MCP ì„œë²„</strong> ë¡œ ê°ì‹¸ê¸° (ê¶Œì¥)</h2>

<p>ë¡œì»¬ í•¨ìˆ˜ë“¤ì„ MCP <strong>íˆ´</strong> ë¡œ ë‚´ë³´ë‚´ë©´, Claude/ChatGPT/Gemini/ì—ì´ì „íŠ¸ SDKì—ì„œ ê·¸ëŒ€ë¡œ ë¶™ì¼ ìˆ˜ ìˆì–´ìš”. íŒŒì´ì¬ì—ì„  <strong>FastMCP</strong> ê°€ ê°€ì¥ ì†ì‰¬ì›€(ë°ì½”ë ˆì´í„°ë§Œ ë¶™ì´ë©´ schema ìƒì„± í¬í•¨). <a href="https://github.com/jlowin/fastmcp">GitHub+1</a></p>

<p><strong>ì˜ˆì‹œ(30ì¤„ëŒ€): ë¡œì»¬ íŒŒì¼ íˆ´ â†’ MCP ì„œë²„</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_files.py
</span><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">LocalFS</span><span class="sh">"</span><span class="p">)</span>
<span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/path/to/root</span><span class="sh">"</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAFE_ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>  <span class="c1"># ë°– íƒˆì¶œ ì‹œ ì˜ˆì™¸
</span>    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()]</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>  <span class="c1"># stdio (CLI: `fastmcp run mcp_files.py`)
</span></code></pre></div></div>

<ul>
  <li>
    <p>ì‹¤í–‰: <code class="language-plaintext highlighter-rouge">uv pip install fastmcp</code> â†’ <code class="language-plaintext highlighter-rouge">fastmcp run mcp_files.py</code></p>
  </li>
  <li>
    <p>í•„ìš” ì‹œ <strong>HTTP(ìŠ¤íŠ¸ë¦¬ë¨¸ë¸”)</strong> ì „ì†¡ìœ¼ë¡œ ë°”ê¿” ë‹¤ì¤‘ í´ë¼ì´ì–¸íŠ¸ë„ ì²˜ë¦¬ ê°€ëŠ¥. <a href="https://github.com/jlowin/fastmcp">GitHub+1</a></p>
  </li>
</ul>

<h2 id="b-ì„œë²„-ì—†ì´-í˜¸ìŠ¤íŠ¸-ì•ˆì—ì„œ-harmonyë§Œ-ì±„íƒ">B) ì„œë²„ ì—†ì´, <strong>í˜¸ìŠ¤íŠ¸ ì•ˆì—ì„œ Harmonyë§Œ ì±„íƒ</strong></h2>

<p>ì§€ê¸ˆì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code>ë¡œ <strong>while ë£¨í”„</strong> ë¥¼ ëŒë¦¬ë˜, ë©”ì‹œì§€ë¥¼ <strong>Harmony ë Œë”ëŸ¬</strong> ë¡œ êµ¬ì„±í•˜ë©´ GPT-OSS ìª½ í˜¸í™˜ì„±ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤. GPT-OSSëŠ” Harmony í¬ë§·ì„ ì „ì œë¡œ í•™ìŠµë˜ì—ˆê³ , ê³µì‹ ê°€ì´ë“œ/ë Œë”ëŸ¬ê°€ ìˆìŠµë‹ˆë‹¤. (ë‹¨, vLLM/ì¼ë¶€ í”„ë¡œë°”ì´ë”ëŠ” ë‚´ë¶€ì—ì„œ Harmonyë¥¼ ìë™ ì²˜ë¦¬í•˜ê¸°ë„ í•¨) <a href="https://github.com/openai/harmony?utm_source=chatgpt.com">GitHub+1</a></p>

<hr />

<h1 id="harmonyë„-ë‹¤-í˜¸í™˜ë˜ëŠ”-ê±°ì•¼ì—-ëŒ€í•œ-ì •ë¦¬">â€œHarmonyë„ ë‹¤ í˜¸í™˜ë˜ëŠ” ê±°ì•¼?â€ì— ëŒ€í•œ ì •ë¦¬</h1>

<ul>
  <li>
    <p><strong>Harmony â†” MCPëŠ” ì¸µì´ ë‹¤ë¦…ë‹ˆë‹¤.</strong><br />
MCPëŠ” <strong>íˆ´Â·ë¦¬ì†ŒìŠ¤ í˜¸ì¶œ í‘œì¤€</strong> , HarmonyëŠ” <strong>ëŒ€í™”/íˆ´í˜¸ì¶œ í¬ë§· í‘œì¤€</strong> ì´ì—ìš”. ë³´í†µ â€œí˜¸ìŠ¤íŠ¸â€ê°€ MCPì—ì„œ ì–»ì€ íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ <strong>ëª¨ë¸ì´ ì´í•´í•˜ëŠ” í¬ë§·(ì˜ˆ: Harmony ë˜ëŠ” OpenAI tools í¬ë§·)</strong>ìœ¼ë¡œ ë°”ê¿” ë„£ìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ <strong>ë™ì‹œì— ì¨ë„ ë¬¸ì œ ì—†ìŠµë‹ˆë‹¤.</strong> <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io</a></p>
  </li>
  <li>
    <p><strong>GPT-OSS ì‚¬ìš© ì‹œ</strong> : ì§ì ‘ ì„œë¹™í•˜ëŠ” ì—”ì§„ì´ Harmonyë¥¼ <strong>ìë™ ì²˜ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´</strong> , <code class="language-plaintext highlighter-rouge">openai-harmony</code> ê°™ì€ <strong>ë Œë”ëŸ¬</strong> ë¥¼ ì“°ì„¸ìš”. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ íˆ´ í˜¸ì¶œ/ì»¨í…ìŠ¤íŠ¸ ì£¼ì…ì´ ë¶ˆì•ˆì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/openai-harmony?utm_source=chatgpt.com">OpenAI Cookbook</a></p>
  </li>
</ul>

<hr />

<h1 id="ë‹¨ê³„ë³„-ê¶Œì¥-ë£¨íŠ¸-step-by-step">ë‹¨ê³„ë³„ ê¶Œì¥ ë£¨íŠ¸ (Step-by-Step)</h1>

<ol>
  <li>
    <p><strong>ë¡œì»¬ í•¨ìˆ˜ â†’ MCP ì„œë²„í™”</strong>(FastMCP ì¶”ì²œ). ìœ„ ì˜ˆì‹œ ê°™ì€ íŒŒì¼ íˆ´ë¶€í„° ë…¸ì¶œ. <a href="https://github.com/jlowin/fastmcp">GitHub</a></p>
  </li>
  <li>
    <p><strong>í˜¸ìŠ¤íŠ¸(ë¸Œë¦¬ì§€)</strong>ì—ì„œ MCP <code class="language-plaintext highlighter-rouge">tools/list</code> â†’ ëª¨ë¸ìš© í¬ë§·ìœ¼ë¡œ ë³€í™˜(Harmony ë˜ëŠ” Chat Completions tools).</p>
  </li>
  <li>
    <p><strong>íˆ´ í˜¸ì¶œ ë£¨í”„</strong>(while): <code class="language-plaintext highlighter-rouge">tool_use</code> ë‚˜ì˜¤ë©´ MCP <code class="language-plaintext highlighter-rouge">call_tool</code> ì‹¤í–‰ â†’ <code class="language-plaintext highlighter-rouge">tool_result</code> ì¬ì£¼ì…(ë˜ëŠ” ChatCompletionsì˜ tool ë©”ì‹œì§€ ê·œê²©). <strong>ID 1:1 ë§¤ì¹­</strong> ì§€í‚¤ê¸°. <a href="https://modelcontextprotocol.io/docs/develop/build-client?utm_source=chatgpt.com">modelcontextprotocol.io</a></p>
  </li>
  <li>
    <p><strong>ì „ì†¡Â·ë³´ì•ˆ</strong> : ë¡œì»¬ì€ stdio, ë¶„ì‚°ì€ Streamable HTTP + ì„¸ì…˜/ì¸ì¦. <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/transports?utm_source=chatgpt.com">modelcontextprotocol.io</a></p>
  </li>
</ol>

<hr />

<p>í•„ìš”í•˜ì‹œë©´, ì§€ê¸ˆ ì“°ì‹œëŠ” <strong>AsyncOpenAI í˜¸ì¶œ ë£¨í”„</strong> ì— ë§ì¶°</p>

<ul>
  <li>
    <p>(A) ìœ„ ë¡œì»¬ íŒŒì¼ íˆ´ì„ <strong>FastMCP ì„œë²„</strong> ë¡œ ê°ì‹¼ ë²„ì „,</p>
  </li>
  <li>
    <p>(B) <strong>Harmony ë Œë”ëŸ¬</strong> ë¥¼ ì ìš©í•œ ë¸Œë¦¬ì§€(while ë£¨í”„)<br />
ë‘ ê°€ì§€ë¥¼ ë°”ë¡œ ë¶™ì—¬ë“œë¦´ê²Œìš”.</p>
  </li>
</ul>

<p class="chat--user">

ì„œë²„ë¡œ ê°ì‹¸ë©´ ì„œë²„ë¥¼ ë˜ ë„ì›Œì•¼í•˜ëŠ”ê±°ì•„ëƒ?

</p>

<p>ë§ì•„ìš”, â€œì„œë²„ë¡œ ê°ì‹¼ë‹¤â€ í•´ë„ ê¼­ <strong>í•­ìƒ ë–  ìˆëŠ” ë°ëª¬</strong> ì„ ì˜ë¯¸í•˜ì§„ ì•Šì•„ìš”.<br />
MCPëŠ” ë‘ ì „ì†¡ì„ ì§€ì›í•˜ëŠ”ë°:</p>

<ul>
  <li>
    <p><strong>stdio(ê¶Œì¥, ë¡œì»¬)</strong> : í˜¸ìŠ¤íŠ¸ê°€ <strong>í•„ìš”í•  ë•Œë§Œ ì„œë¸Œí”„ë¡œì„¸ìŠ¤</strong> ë¥¼ ë„ì›ë‹ˆë‹¤. í¬íŠ¸ë„ ì—†ê³ , ëë‚˜ë©´ ê°™ì´ ë‚´ë ¤ê°€ìš”. â€œë˜ í•˜ë‚˜ì˜ ì¸í”„ë¼â€ê°€ ì•„ë‹ˆë¼ <strong>ì¼íšŒì„± í”„ë¡œì„¸ìŠ¤</strong> ëŠë‚Œ.</p>
  </li>
  <li>
    <p><strong>HTTP(ì›ê²©/ë‹¤ì¤‘ í´ë¼)</strong> : ì§„ì§œ ì„œë²„ë¥¼ ë„ì›Œì„œ ì—¬ëŸ¬ í˜¸ìŠ¤íŠ¸ê°€ ë¶™ê²Œ í•  ë•Œ.</p>
  </li>
</ul>

<p>ì¦‰, <strong>ì—¬ëŸ¬ë¶„ í™˜ê²½ì—ì„  stdioë©´ ì¶©ë¶„</strong> í•´ì„œ â€œìƒì‹œ ì„œë²„ ìš´ì˜â€ ì•ˆ í•´ë„ ë©ë‹ˆë‹¤. while ë£¨í”„ ëŒë¦¬ëŠ” í˜¸ìŠ¤íŠ¸ê°€ ì•Œì•„ì„œ ì¼°ë‹¤ ë„ë©´ ë!</p>

<hr />

<h1 id="ë°”ë¡œ-ì“°ëŠ”-íŒ¨í„´-step-by-step">ë°”ë¡œ ì“°ëŠ” íŒ¨í„´ (Step-by-step)</h1>

<ol>
  <li><strong>ë¡œì»¬ íˆ´ì„ MCP ì„œë²„ë¡œ ë˜í•‘</strong> (stdioìš©, 20~30ì¤„)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_files.py  â€” FastMCP ì˜ˆì‹œ (pip/uv: fastmcp ì„¤ì¹˜)
</span><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">LocalFS</span><span class="sh">"</span><span class="p">)</span>
<span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAFE_ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>  <span class="c1"># ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì˜ˆì™¸
</span>    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()]</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>  <span class="c1"># ê¸°ë³¸ì´ stdio: í˜¸ìŠ¤íŠ¸ê°€ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¡œ ë„ì›€
</span></code></pre></div></div>

<ol>
  <li><strong>í˜¸ìŠ¤íŠ¸ì—ì„œ â€œì„œë¸Œí”„ë¡œì„¸ìŠ¤â€ë¡œ ë¶™ì´ê¸°</strong> (í¬íŠ¸ ì—†ìŒ)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># host.py â€” ì—¬ëŸ¬ë¶„ì´ ì´ë¯¸ ì“°ëŠ” AsyncOpenAI while ë£¨í”„ì— ì´ ë¶€ë¶„ë§Œ ì¶”ê°€
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioTransport</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">():</span>
    <span class="c1"># í˜¸ìŠ¤íŠ¸ê°€ í•„ìš”í•  ë•Œë§Œ ì„œë²„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰
</span>    <span class="n">t</span> <span class="o">=</span> <span class="nc">StdioTransport</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mcp_files.py</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">()</span>              <span class="c1"># initialize êµì„­
</span>    <span class="k">return</span> <span class="n">sess</span>

<span class="k">def</span> <span class="nf">mcp_tools_to_openai</span><span class="p">(</span><span class="n">tools</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">MCP tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">inputSchema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">()</span> <span class="k">as</span> <span class="n">mcp</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="n">oai_tools</span> <span class="o">=</span> <span class="nf">mcp_tools_to_openai</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Use tools only when needed.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">í˜„ì¬ í´ë” ëª©ë¡ ë³´ì—¬ì¤˜</span><span class="sh">"</span><span class="p">}</span>
        <span class="p">]</span>

        <span class="c1"># === while ë£¨í”„ í•µì‹¬ ===
</span>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">oai_tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># ë™í„´ tool_calls ì‹¤í–‰ í›„ ê²°ê³¼ ì¬ì£¼ì…
</span>            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
                <span class="n">tool_msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">out</span><span class="p">))},</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="p">})</span>

            <span class="c1"># assistant ì‘ë‹µ + tool ê²°ê³¼ë¥¼ ëˆ„ì 
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">}</span>
                <span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">]</span>
            <span class="p">})</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤í–‰:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b
python host.py
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ <code class="language-plaintext highlighter-rouge">host.py</code>ê°€ <code class="language-plaintext highlighter-rouge">mcp_files.py</code>ë¥¼ <strong>ê·¸ë•Œê·¸ë•Œ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰</strong> í•˜ê³ , ì‘ì—… ëë‚˜ë©´ í”„ë¡œì„¸ìŠ¤ë„ ê°™ì´ ì¢…ë£Œë©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ í¬íŠ¸/ë°ëª¬ X.</p>

<hr />

<h2 id="ì–¸ì œ-ì§„ì§œ-ì„œë²„httpê°€-ìœ ë¦¬í•œê°€">ì–¸ì œ ì§„ì§œ â€œì„œë²„(HTTP)â€ê°€ ìœ ë¦¬í•œê°€?</h2>

<ul>
  <li>
    <p>ì—¬ëŸ¬ í˜¸ìŠ¤íŠ¸(IDE/ì—ì´ì „íŠ¸)ê°€ <strong>ë™ì‹œì— ê³µìœ </strong> í•  ê³µìš© íˆ´ì¼ ë•Œ</p>
  </li>
  <li>
    <p>ì›ê²©/ì»¨í…Œì´ë„ˆ/ì„œë²„ë¦¬ìŠ¤ ë“± <strong>ë¶„ì‚° ë°°ì¹˜</strong> ê°€ í•„ìš”í•  ë•Œ</p>
  </li>
  <li>
    <p><strong>ê´€ì°°ì„±/ëª¨ë‹ˆí„°ë§/ìŠ¤ì¼€ì¼ë§</strong> ì„ í‘œì¤€ ì¸í”„ë¼ë¡œ ë¬¶ê³  ì‹¶ì„ ë•Œ</p>
  </li>
</ul>

<p>ê·¸ ì™¸ì—” <strong>stdio ì„œë¸Œí”„ë¡œì„¸ìŠ¤</strong> ê°€ ê°€ì¥ ë‹¨ìˆœí•˜ê³  ì•ˆì „í•´ìš”.<br />
ì •ë¦¬í•˜ë©´: <strong>â€œì„œë²„ ë˜ ë„ì›Œ?â€ â†’ (ëŒ€ë¶€ë¶„) ì•„ë‹ˆìš”. í˜¸ìŠ¤íŠ¸ê°€ ì ê¹ ì¼°ë‹¤ ë„ëŠ” stdioë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.</strong></p>

<p class="chat--user">

ì§€ê¸ˆ ë³´ë©´ mcp_files.pyë¼ëŠ” íŒŒì¼ í•˜ë‚˜ë¥¼ mcpë¡œ ë„ìš°ì–ì•„. ê·¸ê±° ëŒ€ì‹ ì— ê·¸ëƒ¥ í•¨ìˆ˜ë‚˜ í´ë˜ìŠ¤ ë‹¨ìœ„ë¡œ ì˜¬ë¦´ìˆ˜ì—†ë‚˜?

</p>

<p>ë„¤, â€œíŒŒì¼ í•˜ë‚˜(mcp_files.py)ë¥¼ ë„ìš°ëŠ” ë°©ì‹â€ ë§ê³  <strong>í•¨ìˆ˜/í´ë˜ìŠ¤ ë‹¨ìœ„ë¡œ ë°”ë¡œ ì˜¬ë¦¬ëŠ”</strong> í‘œì¤€ì ì¸ ë°©ë²•ì´ ìˆì–´ìš”. í¬ì¸íŠ¸ëŠ” <strong>MCP ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ ë•Œ ê·¸ í•¨ìˆ˜Â·ë©”ì„œë“œë¥¼ ë“±ë¡</strong> í•´ ì£¼ëŠ” ê²ë‹ˆë‹¤. FastMCP ê¸°ì¤€ìœ¼ë¡œ ë‘ ê°€ì§€ íŒ¨í„´ì´ ê¹”ë”í•©ë‹ˆë‹¤.</p>

<hr />

<h2 id="1-íŒ©í† ë¦¬-í•¨ìˆ˜-ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ê¶Œì¥">1) íŒ©í† ë¦¬ í•¨ìˆ˜ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸(ê¶Œì¥)</h2>

<p>ë³„ë„ì˜ ë°ëª¬ ì—†ì´, í˜¸ìŠ¤íŠ¸ê°€ í•„ìš”í•  ë•Œë§Œ <strong>stdio ì„œë¸Œí”„ë¡œì„¸ìŠ¤</strong> ë¡œ ë¶ˆëŸ¬ ì“°ì„¸ìš”. FastMCPëŠ” <code class="language-plaintext highlighter-rouge">fastmcp run &lt;ëª¨ë“ˆ:íŒ©í† ë¦¬í•¨ìˆ˜&gt;</code>ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. íŒ©í† ë¦¬ í•¨ìˆ˜ê°€ <strong>ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ì–´ ë°˜í™˜</strong> í•˜ë©´ ë! <a href="https://gofastmcp.com/patterns/cli">gofastmcp.com</a></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># yourpkg/localfs.py  (ì—¬ê¸°ì— â€œê·¸ëƒ¥ ì“°ë˜â€ í•¨ìˆ˜/í´ë˜ìŠ¤ê°€ ìˆë‹¤ê³  ê°€ì •)
</span><span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span> <span class="nc">Files</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">/</span> <span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
        <span class="n">base</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root</span><span class="p">)</span>  <span class="c1"># ë£¨íŠ¸ ë°– ì ‘ê·¼ ì°¨ë‹¨
</span>        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span> <span class="o">/</span> <span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="c1"># yourpkg/server.py  (â€œíŒ©í† ë¦¬ í•¨ìˆ˜â€ë¡œ MCP ì„œë²„ êµ¬ì„±)
</span><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>
<span class="kn">from</span> <span class="n">.localfs</span> <span class="kn">import</span> <span class="n">Files</span><span class="p">,</span> <span class="n">read_text</span>

<span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">create_server</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FastMCP</span><span class="p">:</span>
    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">LocalFS</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="nc">Files</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>

    <span class="c1"># í•¨ìˆ˜/ë©”ì„œë“œë¥¼ â€œë“±ë¡â€ë§Œ í•˜ë©´ MCP íˆ´ì´ ë©ë‹ˆë‹¤
</span>    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">list_dir</span><span class="p">)</span>                  <span class="c1"># ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œ(ë°”ìš´ë“œ ë©”ì„œë“œ) ë“±ë¡
</span>    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>  <span class="c1"># ë£¨íŠ¸ ê³ ì •í•œ ë˜í¼ í•¨ìˆ˜
</span>
    <span class="k">return</span> <span class="n">mcp</span>
</code></pre></div></div>

<p>ì‹¤í–‰(í•­ìƒ-ì¼œì§„ ì„œë²„ í•„ìš” X):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uv pip <span class="nb">install </span>fastmcp
fastmcp run yourpkg/server.py:create_server   <span class="c"># STDIO ê¸°ë³¸</span>
<span class="c"># ë˜ëŠ” ì›í•˜ì‹œë©´ HTTP/SSE ì „ì†¡ë„ ì§€ì›</span>
fastmcp run yourpkg/server.py:create_server <span class="nt">--transport</span> http <span class="nt">--port</span> 3333
</code></pre></div></div>

<ul>
  <li>
    <p>ì´ <strong>CLI ì—”íŠ¸ë¦¬í¬ì¸íŠ¸</strong> ëŠ” íŒŒì¼ ì´ë¦„ì´ ì•„ë‹ˆë¼ <strong>í•¨ìˆ˜/ë³€ìˆ˜ ë ˆë²¨ë¡œ ì§€ëª©</strong> í•  ìˆ˜ ìˆê³ (ì˜ˆ: <code class="language-plaintext highlighter-rouge">module:factory_fn</code>), ë‚´ë¶€ì—ì„œ ì¥ì°©í•œ í•¨ìˆ˜/í´ë˜ìŠ¤ë“¤ì´ íˆ´ë¡œ ë…¸ì¶œë©ë‹ˆë‹¤. <a href="https://gofastmcp.com/patterns/cli">gofastmcp.com</a></p>
  </li>
  <li>
    <p>stdio ì „ì†¡ì€ í˜¸ìŠ¤íŠ¸ê°€ <strong>ê·¸ë•Œê·¸ë•Œ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ìƒì„±/ì¢…ë£Œ</strong> í•´ ì“°ëŠ” êµ¬ì¡°ë¼ â€œì„œë²„ ë˜ ë„ì›Œì•¼ í•´?â€ ë¶€ë‹´ì´ ì ìŠµë‹ˆë‹¤. í•„ìš”í•˜ë©´ Streamable HTTPë„ í‘œì¤€ì´ì—ìš”. <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/transports?utm_source=chatgpt.com">modelcontextprotocol.io+1</a></p>
  </li>
</ul>

<hr />

<h2 id="2-í´ë˜ìŠ¤-ë©”ì„œë“œ-ì§ì ‘-ë°ì½”ë ˆì´íŠ¸-ëŒ€ì‹ -ë“±ë¡-ë©”ì„œë“œ-íŒ¨í„´">2) â€œí´ë˜ìŠ¤ ë©”ì„œë“œ ì§ì ‘ ë°ì½”ë ˆì´íŠ¸â€ ëŒ€ì‹  â€œë“±ë¡ ë©”ì„œë“œâ€ íŒ¨í„´</h2>

<p>ì¸ìŠ¤í„´ìŠ¤/í´ë˜ìŠ¤ ë©”ì„œë“œëŠ” <strong>ì •ì˜ ì‹œ ë°ì½”ë ˆì´í„°ë¥¼ ë°”ë¡œ ë¶™ì´ì§€ ë§ê³ </strong> , <strong>ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“  ë’¤ ë°”ìš´ë“œ ë©”ì„œë“œë¡œ ë“±ë¡</strong> í•˜ì„¸ìš”. ê·¸ë˜ì•¼ <code class="language-plaintext highlighter-rouge">self/cls</code> íŒŒë¼ë¯¸í„°ê°€ ìŠ¤í‚¤ë§ˆì— ë“œëŸ¬ë‚˜ì§€ ì•Šê³  ì˜¬ë°”ë¥´ê²Œ ë…¸ì¶œë©ë‹ˆë‹¤. (FastMCP ë¬¸ì„œì˜ ê¶Œì¥ íŒ¨í„´) <a href="https://gofastmcp.com/patterns/decorating-methods">gofastmcp.com</a></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>

<span class="k">class</span> <span class="nc">Math</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">Demo</span><span class="sh">"</span><span class="p">)</span>
<span class="n">math</span> <span class="o">=</span> <span class="nc">Math</span><span class="p">()</span>
<span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">add</span><span class="p">)</span>         <span class="c1"># â† ì¸ìŠ¤í„´ìŠ¤ ë§Œë“  ë’¤ ë“±ë¡(ê¶Œì¥)
</span>
<span class="c1"># (ì°¸ê³ ) ì •ì  ë©”ì„œë“œëŠ” ë“±ë¡í•´ë„ ë˜ì§€ë§Œ, ì¸ìŠ¤í„´ìŠ¤/í´ë˜ìŠ¤ ë©”ì„œë“œëŠ” ìœ„ ë°©ì‹ì´ ì•ˆì „í•©ë‹ˆë‹¤. :contentReference[oaicite:4]{index=4}
</span></code></pre></div></div>

<hr />

<h2 id="í˜¸ìŠ¤íŠ¸ì—¬ëŸ¬ë¶„ì˜-asyncopenai-ë£¨í”„ì—ì„œ-ë¶™ì´ê¸°">í˜¸ìŠ¤íŠ¸(ì—¬ëŸ¬ë¶„ì˜ AsyncOpenAI ë£¨í”„)ì—ì„œ ë¶™ì´ê¸°</h2>

<p>ê¸°ì¡´ while ë£¨í”„ì˜ MCP ì„¸ì…˜ ìƒì„± ë¶€ë¶„ë§Œ <strong>stdio ì»¤ë§¨ë“œë¡œ êµì²´</strong> í•˜ë©´ ë©ë‹ˆë‹¤:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioTransport</span>

<span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioTransport</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">fastmcp</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">run</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">yourpkg/server.py:create_server</span><span class="sh">"</span><span class="p">])</span>
<span class="k">async</span> <span class="k">with</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span> <span class="k">as</span> <span class="n">mcp</span><span class="p">:</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mcp</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="c1"># â†“ ì—¬ê¸°ì„œë¶€í„°ëŠ” ì´ì „ì— ì“°ì‹œë˜ tool loop ë™ì¼ (tool_calls -&gt; mcp.call_tool -&gt; ì¬ì£¼ì…)
</span></code></pre></div></div>

<ul>
  <li>stdio/HTTP ë“± <strong>ì „ì†¡ì€ MCP í‘œì¤€</strong> ì´ë¯€ë¡œ, ì–´ë–¤ í˜¸ìŠ¤íŠ¸ì—ì„œë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/transports?utm_source=chatgpt.com">modelcontextprotocol.io+1</a></li>
</ul>

<hr />

<h3 id="ì •ë¦¬">ì •ë¦¬</h3>

<ul>
  <li>
    <p>â€œíŒŒì¼ í•˜ë‚˜â€ê°€ ì•„ë‹ˆë¼ <strong>í•¨ìˆ˜/í´ë˜ìŠ¤ ë‹¨ìœ„ë¡œ êµ¬ì„±</strong> ëœ ëª¨ë“ˆì„ <strong>íŒ©í† ë¦¬ í•¨ìˆ˜</strong> ë¡œ ë¬¶ì–´ <strong>í‘œì¤€ MCP ì„œë²„</strong> ë¥¼ ë§Œë“¤ê³ ,</p>
  </li>
  <li>
    <p><strong>stdio</strong> ë¡œ í•„ìš”í•  ë•Œë§Œ ë„ì›Œ ì“°ë©´ <strong>ìƒì‹œ ì„œë²„ ìš´ì˜ ì—†ì´</strong> ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í‘œì¤€ íˆ´ ì²´ê³„ê°€ ë©ë‹ˆë‹¤. <a href="https://gofastmcp.com/patterns/cli">gofastmcp.com+1</a></p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´ ì§€ê¸ˆ ì“°ì‹œëŠ” í•¨ìˆ˜/í´ë˜ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ <strong><code class="language-plaintext highlighter-rouge">create_server()</code> ìŠ¤ì¼ˆë ˆí†¤</strong>ì„ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”â€”íŒ¨í‚¤ì§€ ì´ë¦„/ë£¨íŠ¸ ê²½ë¡œë§Œ ì•Œë ¤ì£¼ì„¸ìš”.</p>

<p class="chat--user">

ì•„ë‹ˆ ë´ë´. ì˜ˆë¥¼ ë“¤ì–´ ì•„ë˜ì™€ ê°™ì´ ê°„ë‹¨íˆ ìš´ì˜í•  ìˆ˜ ì—†ì–´? 
<code class="language-plaintext highlighter-rouge">python
@mcp.tool
def list_dir(path: str = "."):
    # implementation

@mcp.tool
def read_text(path: str):
    # implementation

async def main(mcp_list):
    async with AsyncOpenAI(...) as client:
        client.chat.completions.create("Hello", tools=mcp_list)

asyncio.run(main([read_text, list_dir]))
</code>

ì´ëŸ° ì‹ìœ¼ë¡œ ê·¸ëƒ¥ ë°”ë¡œ ë„£ê³  ì‹¶ì–´

</p>

<p>ì¢‹ì•„ìš”â€”thatâ€™s exactly doable.<br />
í•µì‹¬ì€ <strong>íŒŒì´ì¬ í•¨ìˆ˜/ë©”ì„œë“œ ìì²´ë¥¼ â€œë„êµ¬â€ë¡œ ë“±ë¡</strong> í•˜ê³ , ê·¸ ì‹œê·¸ë‹ˆì²˜ë¡œë¶€í„° <strong>OpenAI tools ìŠ¤í‚¤ë§ˆ</strong> ë¥¼ ë§Œë“¤ì–´ <code class="language-plaintext highlighter-rouge">client.chat.completions.create(..., tools=...)</code>ì— ë„˜ê¸´ ë’¤, ì‘ë‹µì˜ <code class="language-plaintext highlighter-rouge">tool_calls</code>ë¥¼ <strong>ê·¸ í•¨ìˆ˜ì— ì‹¤í–‰â†’ê²°ê³¼ ì¬ì£¼ì…</strong> í•˜ëŠ” ì‘ì€ ëŸ¬ë„ˆë¥¼ ê°–ì¶”ë©´ ë©ë‹ˆë‹¤. MCP ì„œë²„ëŠ” ì „í˜€ í•„ìš” ì—†ì–´ìš”.</p>

<p>ì•„ë˜ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ë³µë¶™í•´ì„œ ëŒì•„ê°€ë„ë¡ ë§Œë“  <strong>ì´ˆì†Œí˜• ì¸ë¼ì¸-íˆ´ ë¸Œë¦¬ì§€</strong> ì˜ˆìš”.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">@inline_tool</code>ë¡œ í•¨ìˆ˜ ë“±ë¡</p>
  </li>
  <li>
    <p>íƒ€ì…íŒíŠ¸â†’JSON Schema ë³€í™˜(ê¸°ë³¸ íƒ€ì…ë“¤)</p>
  </li>
  <li>
    <p>ë™ê¸°/ë¹„ë™ê¸° í•¨ìˆ˜ ëª¨ë‘ ì§€ì›</p>
  </li>
  <li>
    <p>while ë£¨í”„(íˆ´ í˜¸ì¶œ ì—†ì–´ì§ˆ ë•Œê¹Œì§€) + <code class="language-plaintext highlighter-rouge">tool_call_id</code> ë§¤ì¹­</p>
  </li>
  <li>
    <p>ê°„ë‹¨í•œ íŒŒì¼ íˆ´ <code class="language-plaintext highlighter-rouge">list_dir</code>, <code class="language-plaintext highlighter-rouge">read_text</code> ìƒ˜í”Œ í¬í•¨</p>
  </li>
</ul>

<hr />
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># inline_tools_bridge.py
# pip install openai
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">inspect</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">get_origin</span><span class="p">,</span> <span class="n">get_args</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="c1"># ===============================
# 0) ì¸ë¼ì¸ íˆ´ ë“±ë¡/ìŠ¤í‚¤ë§ˆ ìƒì„±ê¸°
# ===============================
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">_ToolEntry</span><span class="p">:</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">desc</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="n">_REGISTRY</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_ToolEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">inline_tool</span><span class="p">(</span><span class="n">_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">í•¨ìˆ˜ì— ë‹¬ì•„ì£¼ë©´ ìë™ìœ¼ë¡œ OpenAI tools ìŠ¤í‚¤ë§ˆê°€ ë§Œë“¤ì–´ì ¸ ë“±ë¡ë©ë‹ˆë‹¤.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="n">tname</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="n">fn</span><span class="p">.</span><span class="n">__name__</span><span class="p">)[:</span><span class="mi">64</span><span class="p">]</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nf">_build_openai_tool_schema</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">description</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fn</span><span class="p">.</span><span class="n">__doc__</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_ToolEntry</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">tname</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">schema</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="k">return</span> <span class="n">decorator</span> <span class="k">if</span> <span class="n">_fn</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">_fn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_pytype_to_schema</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="c1"># ì•„ì£¼ ê°€ë²¼ìš´ ë§¤í•‘: í•„ìš” ì‹œ í™•ì¥í•˜ì„¸ìš”.
</span>    <span class="n">origin</span> <span class="o">=</span> <span class="nf">get_origin</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nf">get_args</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">origin</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tp</span> <span class="ow">is</span> <span class="n">inspect</span><span class="p">.</span><span class="n">_empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">float</span><span class="p">,):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">number</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">item_schema</span> <span class="o">=</span> <span class="nf">_pytype_to_schema</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">array</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">item_schema</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">}</span>
    <span class="c1"># Optional[T] ì²˜ë¦¬
</span>    <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Optional</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">_pytype_to_schema</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># ê·¸ ì™¸ì—” ë¬¸ìì—´ë¡œ ì²˜ë¦¬(ë³´ìˆ˜ì )
</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_build_openai_tool_schema</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">desc</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">.</span><span class="nf">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">required</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">annotation</span>
        <span class="n">sch</span> <span class="o">=</span> <span class="nf">_pytype_to_schema</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param</span><span class="p">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="p">.</span><span class="n">_empty</span><span class="p">:</span>
            <span class="n">sch</span><span class="p">[</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">required</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
        <span class="n">properties</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">sch</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">desc</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="n">properties</span><span class="p">,</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="n">required</span><span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">compiled_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">e</span><span class="p">.</span><span class="n">schema</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_REGISTRY</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>

<span class="c1"># ===================================
# 1) ìƒ˜í”Œ ì¸ë¼ì¸ íˆ´(íŒŒì¼ ê´€ë ¨, ì˜µì…˜)
# ===================================
</span><span class="n">SAFE_ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SAFE_ROOT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)).</span><span class="nf">resolve</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAFE_ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)</span>  <span class="c1"># ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì˜ˆì™¸
</span>    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@inline_tool</span>
<span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">List directory entries under SAFE_ROOT.</span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">():</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">ch</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">ch</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">ch</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">ch</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="nd">@inline_tool</span>
<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Read a text file with size/encoding guards.</span><span class="sh">"""</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">SAFE_ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="c1"># ì˜ˆì‹œ: ë¹„ë™ê¸° íˆ´ë„ OK
</span><span class="nd">@inline_tool</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">slow_count_chars</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Count characters in a file (simulated slow I/O).</span><span class="sh">"""</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">))</span>

<span class="c1"># ===================================
# 2) while ë£¨í”„ ëŸ¬ë„ˆ (OpenAI í˜¸í™˜)
# ===================================
</span><span class="k">def</span> <span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">tc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">tc</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">},</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">tc</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_call_inline_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_REGISTRY</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner</span><span class="p">():</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">func</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="p">.</span><span class="nf">iscoroutine</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="nf">_runner</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_with_inline_tools</span><span class="p">(</span><span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nf">compiled_tools</span><span class="p">()</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">You can use tools. SAFE_ROOT is </span><span class="sh">'</span><span class="si">{</span><span class="n">SAFE_ROOT</span><span class="si">}</span><span class="sh">'</span><span class="s">.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_HOPS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">8</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">final</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">MAX_HOPS</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">final</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            <span class="k">break</span>

        <span class="c1"># ë™í„´ ë³‘ë ¬ ì‹¤í–‰
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">_one</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">_call_inline_tool</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)}</span>

        <span class="n">tool_msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nf">_one</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">])</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final</span>

<span class="c1"># ==========================
# 3) ë°ëª¨ ì‹¤í–‰
# ==========================
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">sys</span>
    <span class="n">q</span> <span class="o">=</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">í˜„ì¬ ë””ë ‰í† ë¦¬ ëª©ë¡ì„ ë³´ì—¬ì£¼ê³ , README.md ìˆìœ¼ë©´ ì½ì–´ì¤˜.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[SAFE_ROOT] </span><span class="si">{</span><span class="n">SAFE_ROOT</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">chat_with_inline_tools</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
</code></pre></div></div>

<hr />

<h2 id="ì´ë ‡ê²Œ-ì“°ì‹œë©´-ë©ë‹ˆë‹¤">ì´ë ‡ê²Œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b
<span class="nb">export </span><span class="nv">SAFE_ROOT</span><span class="o">=</span>/your/workspace
python inline_tools_bridge.py <span class="s2">"data í´ë” ëª©ë¡ ë³´ì—¬ì£¼ê³ , README.md ì½ì–´ì¤˜"</span>
</code></pre></div></div>

<hr />

<h2 id="í•œ-ì¤„-ìš”ì•½-ì»¨ì…‰-ì •ë¦¬">í•œ ì¤„ ìš”ì•½ (ì»¨ì…‰ ì •ë¦¬)</h2>

<ul>
  <li>
    <p>ì§€ê¸ˆ ë³´ì—¬ë“œë¦° ë°©ì‹ì€ <strong>MCP ì—†ì´</strong> â€œí•¨ìˆ˜/í´ë˜ìŠ¤ â†’ OpenAI toolsâ€ë¡œ ì§ì ‘ ë§¤í•‘í•˜ëŠ” <strong>ì¸ë¼ì¸ íˆ´</strong> ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì¥ì </strong> : ì´ˆê°„ë‹¨, ì„œë²„/í”„ë¡œì„¸ìŠ¤ ì¶”ê°€ ì—†ìŒ.</p>
  </li>
  <li>
    <p><strong>ì£¼ì˜</strong> : ì´ê²ƒë§Œìœ¼ë¡œëŠ” â€œMCP í‘œì¤€â€ì€ ì•„ë‹ˆë¯€ë¡œ, <strong>ë‹¤ë¥¸ í˜¸ìŠ¤íŠ¸/ì—ì´ì „íŠ¸ì™€ ì¬ì‚¬ìš©ì„±Â·ë°œê²¬ì„±</strong> ì´ í•„ìš”í•´ì§€ë©´ ê°™ì€ í•¨ìˆ˜ë“¤ì„ <strong>FastMCPë¡œ ë˜í•‘</strong> í•´ stdioë¡œ ë„ìš°ë©´ ë°”ë¡œ í‘œì¤€í™”ë¥¼ ì–»ì„ ìˆ˜ ìˆì–´ìš”(ì½”ë“œ ë³€ê²½ ìµœì†Œ).</p>
  </li>
</ul>

<p class="chat--user">

FastMCPì—ëŠ” ì´ëŸ° ê¸°ëŠ¥ì´ ì—†ì–´?

</p>

<p>ì§§ê²Œ ê²°ë¡ ë¶€í„°ìš”:</p>

<ul>
  <li>
    <p><strong>FastMCP ìì²´ë¡œ â€œíŒŒì´ì¬ í•¨ìˆ˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ê³§ì¥ Chat Completionsì˜ toolsì— ë„£ì–´ì£¼ëŠ”â€ ë‚´ì¥ ê¸°ëŠ¥ì€ ì—†ìŠµë‹ˆë‹¤.</strong> FastMCPëŠ” ê¸°ë³¸ì ìœ¼ë¡œ <em>MCP ì„œë²„/í´ë¼ì´ì–¸íŠ¸</em> ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ í”„ë ˆì„ì›Œí¬ì˜ˆìš”. (<code class="language-plaintext highlighter-rouge">@mcp.tool</code>ë¡œ í•¨ìˆ˜ ë“±ë¡ â†’ MCPë¡œ ë…¸ì¶œ) <a href="https://github.com/jlowin/fastmcp">GitHub+1</a></p>
  </li>
  <li>
    <p>ë‹¤ë§Œ ì„ íƒì§€ëŠ” 3ê°€ì§€ì…ë‹ˆë‹¤. (step-by-step)</p>
  </li>
</ul>

<ol>
  <li>
    <p><strong>OpenAI Responses APIë¡œ ì „í™˜</strong><br />
OpenAIì˜ <em>Responses API</em> ëŠ” MCP ì„œë²„ë¥¼ â€œì›ê²© íˆ´ ì†ŒìŠ¤â€ë¡œ ë°”ë¡œ ë¶™ì¼ ìˆ˜ ìˆê²Œ í‘œì¤€ ì§€ì›í•©ë‹ˆë‹¤(â€» Chat CompletionsëŠ” ë¯¸ì§€ì›). FastMCPë¡œ HTTP/SSE ì„œë²„ë¥¼ ë„ìš°ê³  Responsesì—ì„œ <code class="language-plaintext highlighter-rouge">type: "mcp"</code>ë¡œ ì—°ê²°í•˜ë©´ ë. <a href="https://gofastmcp.com/integrations/openai">gofastmcp.com</a></p>
  </li>
  <li>
    <p><strong>ì„œë²„ ë”°ë¡œ ë„ìš°ê¸° ì‹«ë‹¤ë©´: FastMCP â€œì¸ë©”ëª¨ë¦¬â€ë¡œ ë‚´ì¥ + ì–‡ì€ ì–´ëŒ‘í„°</strong><br />
FastMCPì—ëŠ” <strong>í´ë¼ì´ì–¸íŠ¸ê°€ FastMCP ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ì— ì§ì ‘ ë¶™ëŠ” â€œì¸ë©”ëª¨ë¦¬ íŠ¸ëœìŠ¤í¬íŠ¸â€</strong>ê°€ ìˆì–´, <em>ë³„ë„ í”„ë¡œì„¸ìŠ¤ ì—†ì´</em> ê°™ì€ íŒŒì´ì¬ í”„ë¡œì„¸ìŠ¤ ì•ˆì—ì„œ MCP í˜¸ì¶œì„ ìˆ˜í–‰í•  ìˆ˜ ìˆì–´ìš”. ì´ë•Œ <code class="language-plaintext highlighter-rouge">client.list_tools()</code>ë¡œ íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ì½ì–´ <strong>OpenAI í•¨ìˆ˜-íˆ´ í¬ë§·ìœ¼ë¡œ ë³€í™˜</strong> í•´ì„œ <code class="language-plaintext highlighter-rouge">chat.completions.create(..., tools=...)</code>ì— ë„˜ê¸°ê³ , <code class="language-plaintext highlighter-rouge">tool_calls</code>ê°€ ì˜¤ë©´ <code class="language-plaintext highlighter-rouge">client.call_tool(...)</code>ë¡œ ì‹¤í–‰â†’ê²°ê³¼ë¥¼ ì¬ì£¼ì…í•˜ë©´ ë©ë‹ˆë‹¤. (ì•„ë˜ ì†ŒìŠ¤ 15~20ì¤„ ì •ë„ë©´ ì¶©ë¶„) <a href="https://gofastmcp.com/clients/client">gofastmcp.com</a></p>
  </li>
  <li>
    <p><strong>í•„ìš”í•˜ë©´ stdio/HTTPë¡œ â€œê·¸ë•Œê·¸ë•Œâ€ êµ¬ë™</strong><br />
<code class="language-plaintext highlighter-rouge">fastmcp run server.py[:ê°ì²´/íŒ©í† ë¦¬]</code>ë¡œ <strong>STDIO(ê¸°ë³¸)/HTTP/SSE</strong> ì¤‘ ì•„ë¬´ê±°ë‚˜ íƒí•´ ì¼íšŒì„±ìœ¼ë¡œ ë„ìš°ëŠ” íŒ¨í„´ë„ ê³µì‹ ì œê³µë¼ìš”. (í•­ìƒ-ì¼œì§„ ì„œë²„ ìš´ì˜ ë¶€ë‹´ â†“) <a href="https://github.com/jlowin/fastmcp">GitHub+1</a></p>
  </li>
</ol>

<hr />

<h2 id="ìµœì†Œ-ì–´ëŒ‘í„°-ì˜ˆì‹œ-ì¸ë©”ëª¨ë¦¬-fastmcp--chat-completions">ìµœì†Œ ì–´ëŒ‘í„° ì˜ˆì‹œ (ì¸ë©”ëª¨ë¦¬ FastMCP â†” Chat Completions)</h2>

<blockquote>
  <p>í•µì‹¬: FastMCPë¡œ í•¨ìˆ˜ ë“±ë¡ â†’ <code class="language-plaintext highlighter-rouge">Client(mcp)</code>ë¡œ ì¸ë©”ëª¨ë¦¬ ì ‘ì† â†’ <code class="language-plaintext highlighter-rouge">list_tools()</code>ë¥¼ <strong>OpenAI tools í¬ë§·</strong> ìœ¼ë¡œ ë³€í™˜ â†’ <code class="language-plaintext highlighter-rouge">tool_calls</code>ëŠ” <code class="language-plaintext highlighter-rouge">client.call_tool()</code>ë¡œ ì‹¤í–‰.
```python
import asyncio, json, os
from fastmcp import FastMCP, Client
from openai import AsyncOpenAI</p>
</blockquote>

<p>mcp = FastMCP("LocalTools")</p>

<p>@mcp.tool
def list_dir(path: str = ".") -&gt; list[dict]:
    """List directory entries."""
    import os
    return [{"name": f, "type": ("dir" if os.path.isdir(os.path.join(path, f)) else "file")}
            for f in os.listdir(path)]</p>

<p>@mcp.tool
def read_text(path: str, max_bytes: int = 65536) -&gt; dict:
    """Read a UTF-8 text file."""
    with open(path, "r", encoding="utf-8", errors="replace") as f:
        return {"path": path, "text": f.read()[:max_bytes]}</p>

<p>async def main(user_input: str):
    # 1) ì¸ë©”ëª¨ë¦¬ë¡œ FastMCP ì„œë²„ì— ë¶™ê¸°(ë³„ë„ í”„ë¡œì„¸ìŠ¤ X)
    mcp_client = Client(mcp)
    async with mcp_client:
        # 2) MCP íˆ´ â†’ OpenAI í•¨ìˆ˜-íˆ´ í¬ë§· ë³€í™˜
        tools = await mcp_client.list_tools()
        openai_tools = [{
            "type": "function",
            "function": {
                "name": t.name,
                "description": t.description or "",
                "parameters": t.inputSchema  # MCP í‘œì¤€ ìŠ¤í‚¤ë§ˆ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            }
        } for t in tools]</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    # 3) ì¼ë°˜ Chat Completions ë£¨í”„
    llm = AsyncOpenAI(
        base_url=os.getenv("OPENAI_BASE_URL", "http://localhost:8000/v1"),
        api_key=os.getenv("OPENAI_API_KEY", "dummy"),
    )
    model = os.getenv("OSS_MODEL", "gpt-oss-20b")
    messages = [{"role": "user", "content": user_input}]

    for _ in range(8):
        resp = await llm.chat.completions.create(
            model=model, messages=messages, tools=openai_tools, tool_choice="auto", temperature=0.2
        )
        msg = resp.choices[0].message
        if not msg.tool_calls:
            print(msg.content or "")
            return

        # 4) tool_calls ì‹¤í–‰ â†’ ê²°ê³¼ ì¬ì£¼ì…
        tool_msgs = []
        for c in msg.tool_calls:
            args = json.loads(c.function.arguments or "{}")
            result = await mcp_client.call_tool(c.function.name, args)
            # ê²°ê³¼ëŠ” ë¬¸ìì—´ë¡œ ë„£ì–´ì£¼ë©´ ì•ˆì „
            payload = getattr(result, "data", None) or getattr(result, "content", None) or result
            tool_msgs.append({"role": "tool", "tool_call_id": c.id,
                              "content": json.dumps(payload, ensure_ascii=False, default=str)})

        messages.append({
            "role": "assistant",
            "content": msg.content,
            "tool_calls": [{"id": c.id, "type": c.type,
                            "function": {"name": c.function.name, "arguments": c.function.arguments}}
                           for c in msg.tool_calls]
        })
        messages.extend(tool_msgs)
</code></pre></div></div>

<p>if <strong>name</strong> == "<strong>main</strong>":
    asyncio.run(main("í˜„ì¬ í´ë” ëª©ë¡ì„ ë³´ì—¬ì£¼ê³  README.mdê°€ ìˆìœ¼ë©´ ì½ì–´ì¤˜"))</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  * ìœ„ ì½”ë“œëŠ” **ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì—†ì´** FastMCPë¥¼ _ë‚´ì¥_ í•˜ê³ , MCP íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ê·¸ëŒ€ë¡œ **OpenAI í•¨ìˆ˜-íˆ´** ë¡œ ë„˜ê¹ë‹ˆë‹¤. (Responses APIë¡œ ê°ˆ ìˆ˜ ì—†ë‹¤ë©´ ì´ ë°©ì‹ì´ ê°€ì¥ ê°€ë²¼ì›€)

  * ì¸ìŠ¤í„´ìŠ¤/í´ë˜ìŠ¤ ë©”ì„œë“œë¥¼ íˆ´ë¡œ ë‚´ê³  ì‹¶ë‹¤ë©´, **ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ê³  ë°”ìš´ë“œ ë©”ì„œë“œë¥¼ ë“±ë¡** í•˜ëŠ” íŒ¨í„´ì´ ê¶Œì¥ì…ë‹ˆë‹¤. (`@mcp.tool`ë¥¼ ë©”ì„œë“œì— ì§ì ‘ ë¶™ì´ì§€ ë§ ê²ƒ) [gofastmcp.com](https://gofastmcp.com/patterns/decorating-methods)

* * *

## ì–¸ì œ ë¬´ì—‡ì„ ì“°ë©´ ë˜ë‚˜ (ìš”ì•½)

  * **OpenAI Responses API ì‚¬ìš© ê°€ëŠ¥** â†’ _ê·¸ëƒ¥ FastMCP ì„œë²„_ ë…¸ì¶œí•˜ê³  `type: "mcp"`ë¡œ ë¶™ì´ì„¸ìš”. (ì •ì„) [gofastmcp.com](https://gofastmcp.com/integrations/openai)

  * **Chat Completionsë§Œ ë°˜ë“œì‹œ ì¨ì•¼ í•¨** â†’ ìœ„ **ì¸ë©”ëª¨ë¦¬ + ë³€í™˜ ì–´ëŒ‘í„°** íŒ¨í„´. (í”„ë¡œì„¸ìŠ¤ ì¶”ê°€ ç„¡) [gofastmcp.com](https://gofastmcp.com/clients/client)

  * **ì›í•˜ë©´ ì¼íšŒì„± ì„œë²„** â†’ `fastmcp run server.py[:obj]`ë¡œ **STDIO/HTTP/SSE** ì¤‘ ì„ íƒí•´ ë„ìš°ê¸°. [GitHub+1](https://github.com/jlowin/fastmcp)

í•„ìš”í•˜ì‹œë©´, ì§€ê¸ˆ ì“°ì‹œëŠ” í•¨ìˆ˜ë“¤ë¡œ **ì¸ë©”ëª¨ë¦¬ FastMCP + ë³€í™˜ ì–´ëŒ‘í„°** ë¥¼ ë°”ë¡œ ë§ì¶° ë“œë¦´ê²Œìš”â€”í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ë§Œ ì•Œë ¤ ì£¼ì„¸ìš”.

&lt;p class="chat--user" markdown="1"&gt;

fastmcp ê¹ƒí—ˆë¸Œ ë³´ë‹ˆ mcp = FastMCP("My MCP") async def main(): async with Client(mcp) as client: ... ì´ë ‡ê²Œ ì“¸ ìˆ˜ ìˆëŠ” ê²ƒ ê°™ì€ë°?

&lt;/p&gt;

ë§ì•„ìš”, ê·¸ íŒ¨í„´ ê·¸ëŒ€ë¡œ ì“¸ ìˆ˜ ìˆì–´ìš”. **FastMCPëŠ” â€œì¸ë©”ëª¨ë¦¬ í´ë¼ì´ì–¸íŠ¸â€**ë¥¼ ì œê³µí•´ì„œ, ë³„ë„ ì„œë²„ë‚˜ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì—†ì´ **ê°™ì€ íŒŒì´ì¬ í”„ë¡œì„¸ìŠ¤ ì•ˆì—ì„œ** MCP í˜¸ì¶œì„ ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰:
```python
mcp = FastMCP("My MCP")

async def main():
    async with Client(mcp) as client:
        ...
</code></pre></div></div>

<p>ì´ í˜•íƒœê°€ ê³µì‹ì ìœ¼ë¡œ ì•ˆë‚´ë˜ëŠ” <strong>ì¸ë©”ëª¨ë¦¬(í”„ë¡œì„¸ìŠ¤ ë‚´) ì—°ê²°</strong> ë°©ì‹ì´ê³ , í…ŒìŠ¤íŠ¸Â·ê°œë°œì— íŠ¹íˆ ì í•©í•´ìš”. <a href="https://gofastmcp.com/clients/client?utm_source=chatgpt.com">gofastmcp.com+2</a></p>

<p>ì•„ë˜ëŠ” ë‹¹ì‹ ì´ ì›í•˜ì‹  ê·¸ëŒ€ë¡œ, <strong>í•¨ìˆ˜ë“¤ì„ ë°”ë¡œ ë“±ë¡</strong> í•˜ê³  <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code>ì˜ <code class="language-plaintext highlighter-rouge">chat.completions.create(...)</code>ì— <strong>íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ë„£ì–´</strong> while ë£¨í”„ë¥¼ ëŒë¦¬ëŠ” <strong>ì™„ì„± ì˜ˆì‹œ</strong> ì…ë‹ˆë‹¤. (ì„œë²„/í¬íŠ¸/ë°ëª¬ ì—†ìŒ)</p>

<hr />

<h3 id="fastmcp--ì¸ë©”ëª¨ë¦¬--chat-completions-ë¸Œë¦¬ì§€-ë³µë¶™ìš©">fastmcp Ã— ì¸ë©”ëª¨ë¦¬ Ã— Chat Completions ë¸Œë¦¬ì§€ (ë³µë¶™ìš©)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_inline_bridge.py
# pip install fastmcp openai
</span>
<span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">inspect</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="n">Client</span>

<span class="c1"># 0) MCP ì¸ìŠ¤í„´ìŠ¤ì™€ "ê·¸ëƒ¥ í•¨ìˆ˜"ë“¤ì„ MCP íˆ´ë¡œ ë“±ë¡
</span><span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">LocalFS</span><span class="sh">"</span><span class="p">)</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">List directory entries.</span><span class="sh">"""</span>
    <span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">pathlib</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="n">full</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="n">name</span>
        <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">full</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">full</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">full</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">entries</span>

<span class="nd">@mcp.tool</span>
<span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Read a UTF-8 text file (size-limited).</span><span class="sh">"""</span>
    <span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

<span class="c1"># 1) MCP -&gt; OpenAI tools í¬ë§· ë³€í™˜ ë„ìš°ë¯¸
</span><span class="k">def</span> <span class="nf">_schema_of</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="c1"># FastMCPê°€ ë‚´ì£¼ëŠ” ì†ì„± ì´ë¦„ì´ êµ¬í˜„ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ëŒ€ë¹„
</span>    <span class="nf">return </span><span class="p">(</span>
        <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>
        <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">inputSchema</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_openai_tools</span><span class="p">(</span><span class="n">mcp_tools</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">MCP tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">_schema_of</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">tool_calls</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">}</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_calls</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_call_tool</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner</span><span class="p">():</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># ê²°ê³¼ ì •ê·œí™”(ë¬¸ì/ê°ì²´ ë¬´ì—‡ì´ë“  JSONìœ¼ë¡œ ë„˜ê¸¸ ìˆ˜ ìˆê²Œ)
</span>        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span>
        <span class="k">elif</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>  <span class="c1"># ì§ë ¬í™” ê°€ëŠ¥ í™•ì¸
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">payload</span><span class="p">)}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="nf">_runner</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">}</span>

<span class="c1"># 2) ë©”ì¸ ë£¨í”„: Chat Completions â†” FastMCP(ì¸ë©”ëª¨ë¦¬)
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">chat_with_inline_mcp</span><span class="p">(</span><span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># OpenAI-í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸(GPT-OSS ë“±)ë¡œ êµì²´
</span>    <span class="n">oai</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OSS_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-oss-20b</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="nc">Client</span><span class="p">(</span><span class="n">mcp</span><span class="p">)</span> <span class="k">as</span> <span class="n">mcp_client</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mcp_client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="n">openai_tools</span> <span class="o">=</span> <span class="nf">_to_openai_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">You can use tools when necessary. Keep outputs concise.</span><span class="sh">"</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">MAX_HOPS</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MAX_HOPS</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">8</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">final_text</span> <span class="o">=</span> <span class="sh">""</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">MAX_HOPS</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">oai</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">openai_tools</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>           <span class="c1"># ì¢…ë£Œ ì¡°ê±´
</span>                <span class="n">final_text</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
                <span class="k">break</span>

            <span class="c1"># ë™í„´ ë³‘ë ¬ ì‹¤í–‰
</span>            <span class="k">async</span> <span class="k">def</span> <span class="nf">_one</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">_call_tool</span><span class="p">(</span><span class="n">mcp_client</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="n">arguments</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)}</span>

            <span class="n">tool_msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nf">_one</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">])</span>

            <span class="c1"># assistant ì‘ë‹µ + tool ê²°ê³¼ë¥¼ ëˆ„ì 
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_assistant_msg_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">tool_msgs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># 3) ì‹¤í–‰
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">sys</span>
    <span class="n">q</span> <span class="o">=</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">í˜„ì¬ ë””ë ‰í† ë¦¬ ëª©ë¡ ë³´ì—¬ì£¼ê³  README.md ìˆìœ¼ë©´ ì½ì–´ì¤˜.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">chat_with_inline_mcp</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
</code></pre></div></div>

<p><strong>ì‚¬ìš©ë²•</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>fastmcp openai
<span class="nb">export </span><span class="nv">OPENAI_BASE_URL</span><span class="o">=</span>http://localhost:8000/v1
<span class="nb">export </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>dummy
<span class="nb">export </span><span class="nv">OSS_MODEL</span><span class="o">=</span>gpt-oss-20b
python fastmcp_inline_bridge.py <span class="s2">"data í´ë” ëª©ë¡ê³¼ README.md ì½ì–´ì¤˜"</span>
</code></pre></div></div>

<hr />

<h3 id="ì •ë¦¬-step-by-step">ì •ë¦¬ (Step-by-step)</h3>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">@mcp.tool</code>ë¡œ <strong>ê·¸ëƒ¥ íŒŒì´ì¬ í•¨ìˆ˜</strong> ë¥¼ ë“±ë¡í•œë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">async with Client(mcp)</code>ë¡œ <strong>ì¸ë©”ëª¨ë¦¬ ì—°ê²°</strong> ì„ ì—°ë‹¤ â†’ <code class="language-plaintext highlighter-rouge">list_tools()</code>ë¡œ íˆ´ ìŠ¤í‚¤ë§ˆ íšë“. <a href="https://gofastmcp.com/clients/client?utm_source=chatgpt.com">gofastmcp.com+1</a></p>
  </li>
  <li>
    <p>ê·¸ ìŠ¤í‚¤ë§ˆë¥¼ <strong>OpenAI tools í¬ë§·</strong> ìœ¼ë¡œ ë³€í™˜í•´ <code class="language-plaintext highlighter-rouge">chat.completions.create(..., tools=...)</code>ì— ì „ë‹¬.</p>
  </li>
  <li>
    <p>ì‘ë‹µì˜ <code class="language-plaintext highlighter-rouge">tool_calls</code>ë¥¼ <strong><code class="language-plaintext highlighter-rouge">client.call_tool(...)</code></strong>ë¡œ ì‹¤í–‰í•˜ê³ , <strong><code class="language-plaintext highlighter-rouge">tool_call_id</code> ë§¤ì¹­</strong>í•˜ì—¬ <strong>tool ë©”ì‹œì§€</strong> ë¡œ ì¬ì£¼ì… â†’ <strong>while</strong> ë°˜ë³µ.</p>
  </li>
  <li>
    <p>ë³„ë„ ì„œë²„ë‚˜ í¬íŠ¸ëŠ” ì „í˜€ í•„ìš” ì—†ìŒ(ì¸ë©”ëª¨ë¦¬). í•„ìš”í•´ì§€ë©´ ì–¸ì œë“  <strong>STDIO/HTTP</strong> ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŒ. <a href="https://gofastmcp.com/deployment/running-server?utm_source=chatgpt.com">gofastmcp.com</a></p>
  </li>
</ol>

<p>ì›í•˜ì‹œë©´ ì—¬ê¸°ì— <strong>í´ë˜ìŠ¤ ë©”ì„œë“œ ë°”ìš´ë“œ ë“±ë¡</strong> , <strong>íƒ€ì„ì•„ì›ƒ/ì¬ì‹œë„/ë¡œê¹…</strong> ê¹Œì§€ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆí•œ ì‹¤ì „ ë²„ì „ìœ¼ë¡œ ë‹¤ë“¬ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ê·¸ëŸ°ë° ì˜ˆë¥¼ ë“¤ì–´ ì´ë ‡ê²Œ ë§Œë“¤ ìˆ˜ ìˆì–´? def add_read_text_tool(mcp: FastMCP): # mcpì— read_textë¥¼ toolë¡œ ë“±ë¡ í›„ return mcp my_mcp = FastMCP("My MCP") my_mcp = add_read_text_tool(my_mcp) # my_mcpì—ëŠ” íˆ´ì´ ë“±ë¡ëœ ìƒíƒœ

</p>

<p>ë„¤, ê·¸ë ‡ê²Œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”. í¬ì¸íŠ¸ëŠ” <strong>í•¨ìˆ˜ ìì²´ì—ëŠ” ë°ì½”ë ˆì´í„°ë¥¼ ë¶™ì´ì§€ ì•Šê³ </strong> , ë‚˜ì¤‘ì— <code class="language-plaintext highlighter-rouge">mcp.tool(fn)</code>ìœ¼ë¡œ <strong>ë“±ë¡(attach)</strong> í•˜ëŠ” ê±°ì˜ˆìš”. ê·¸ëŸ¬ë©´ â€œì¶”ê°€ í•¨ìˆ˜â€ë“¤ì„ ì†ì‰½ê²Œ ë¼ì›Œë„£ê³  ì¡°í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì•„ë˜ëŠ” ë°”ë¡œ ë³µë¶™í•´ì„œ ì“°ëŠ” <strong>ìœ í‹¸ íŒ¨í„´</strong> ì´ì—ìš”.</p>

<h3 id="1-íˆ´-ì¶”ê°€-ìœ í‹¸-í•¨ìˆ˜í´ë˜ìŠ¤-ë©”ì„œë“œ-ëª¨ë‘-ì§€ì›">1) íˆ´ ì¶”ê°€ ìœ í‹¸ (í•¨ìˆ˜/í´ë˜ìŠ¤ ë©”ì„œë“œ ëª¨ë‘ ì§€ì›)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tools_adders.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>

<span class="k">def</span> <span class="nf">add_read_text_tool</span><span class="p">(</span><span class="n">mcp</span><span class="p">:</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
                       <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">,</span> <span class="n">default_max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FastMCP</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">read_text(path, max_bytes) íˆ´ì„ mcpì— ë“±ë¡í•˜ê³  mcpë¥¼ ë°˜í™˜.</span><span class="sh">"""</span>
    <span class="n">ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT</span><span class="p">)</span>  <span class="c1"># ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì˜ˆì™¸
</span>        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">default_max_bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Read a UTF-8 text file under ROOT with size limit.</span><span class="sh">"""</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)[:</span><span class="n">max_bytes</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT</span><span class="p">)),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">txt</span><span class="p">}</span>

    <span class="c1"># í•¨ìˆ˜ ì´ë¦„ì„ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ wrapperì˜ __name__ì„ ë°”ê¿”ë„ ë˜ê³ â€¦
</span>    <span class="n">read_text</span><span class="p">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">read_text</span><span class="p">)</span>          <span class="c1"># â† ì—¬ê¸°ì„œ ë“±ë¡!
</span>    <span class="k">return</span> <span class="n">mcp</span>

<span class="k">def</span> <span class="nf">add_list_dir_tool</span><span class="p">(</span><span class="n">mcp</span><span class="p">:</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
                      <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FastMCP</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">list_dir(path=</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="s">) íˆ´ ë“±ë¡.</span><span class="sh">"""</span>
    <span class="n">ROOT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">List directory entries under ROOT.</span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()]</span>

    <span class="n">list_dir</span><span class="p">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">list_dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mcp</span>
</code></pre></div></div>

<h3 id="2-ì‚¬ìš©-ì˜ˆ--ì²´ì´ë‹í•´ì„œ-ë“±ë¡">2) ì‚¬ìš© ì˜ˆ â€” ì²´ì´ë‹í•´ì„œ ë“±ë¡</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.py
</span><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="n">tools_adders</span> <span class="kn">import</span> <span class="n">add_read_text_tool</span><span class="p">,</span> <span class="n">add_list_dir_tool</span>

<span class="n">mcp</span> <span class="o">=</span> <span class="nc">FastMCP</span><span class="p">(</span><span class="sh">"</span><span class="s">My MCP</span><span class="sh">"</span><span class="p">)</span>
<span class="n">mcp</span> <span class="o">=</span> <span class="nf">add_read_text_tool</span><span class="p">(</span><span class="n">mcp</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">)</span>
<span class="n">mcp</span> <span class="o">=</span> <span class="nf">add_list_dir_tool</span><span class="p">(</span><span class="n">mcp</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ì¸ë©”ëª¨ë¦¬ë¡œ ë¶™ì–´ì„œ ë™ì‘ í™•ì¸
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">Client</span><span class="p">(</span><span class="n">mcp</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">== Registered tools ==</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># ì‹¤ì œ í˜¸ì¶œ
</span>        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="sh">"</span><span class="s">list_dir</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">})</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">list_dir -&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="sh">"</span><span class="s">read_text</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">README.md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_bytes</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">})</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">read_text -&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">][:</span><span class="mi">80</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">out</span> <span class="k">else</span> <span class="n">out</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">demo</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="3-ì˜µì…˜-í´ë˜ìŠ¤-ë©”ì„œë“œë„-ê°™ì€-ë°©ì‹ìœ¼ë¡œ">3) (ì˜µì…˜) í´ë˜ìŠ¤ ë©”ì„œë“œë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">fastmcp</span> <span class="kn">import</span> <span class="n">FastMCP</span>

<span class="k">class</span> <span class="nc">Files</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_safe</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">/</span> <span class="n">rel</span><span class="p">).</span><span class="nf">resolve</span><span class="p">();</span> <span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root</span><span class="p">);</span> <span class="k">return</span> <span class="n">p</span>
    <span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_safe</span><span class="p">(</span><span class="n">path</span><span class="p">);</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">fp</span><span class="p">.</span><span class="nf">read_text</span><span class="p">()[:</span><span class="n">max_bytes</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">add_files_tools</span><span class="p">(</span><span class="n">mcp</span><span class="p">:</span> <span class="n">FastMCP</span><span class="p">,</span> <span class="n">fs</span><span class="p">:</span> <span class="n">Files</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FastMCP</span><span class="p">:</span>
    <span class="n">mcp</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">read_text</span><span class="p">)</span>   <span class="c1"># ë°”ìš´ë“œ ë©”ì„œë“œ ë“±ë¡ ê¶Œì¥(ë°ì½”ë ˆì´í„°ë¥¼ ë©”ì„œë“œì— ì§ì ‘ ë¶™ì´ì§€ ë§ ê²ƒ)
</span>    <span class="k">return</span> <span class="n">mcp</span>
</code></pre></div></div>

<hr />

<h2 id="í•œ-ê±¸ìŒ-ë”-íˆ´ì„-llmì—-ë„˜ê¸¸-ë•Œ">í•œ ê±¸ìŒ ë” (íˆ´ì„ LLMì— ë„˜ê¸¸ ë•Œ)</h2>

<p>ìœ„ì²˜ëŸ¼ ë“±ë¡ëœ íˆ´ ìŠ¤í‚¤ë§ˆëŠ” <code class="language-plaintext highlighter-rouge">Client(mcp).list_tools()</code>ë¡œ ì–»ì–´ì„œ <strong>OpenAI tools í¬ë§·</strong> ìœ¼ë¡œ ë³€í™˜í•´ <code class="language-plaintext highlighter-rouge">AsyncOpenAI(...).chat.completions.create(..., tools=...)</code>ì— ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤(ì´ë¯¸ ì“°ì‹œë˜ while ë£¨í”„ ê·¸ëŒ€ë¡œ). í•µì‹¬ ë‹¨ê³„:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">async with Client(mcp) as client:</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tools = await client.list_tools()</code></p>
  </li>
  <li>
    <p>ê° <code class="language-plaintext highlighter-rouge">t</code>ì— ëŒ€í•´ <code class="language-plaintext highlighter-rouge">{"type":"function","function":{"name": t.name, "parameters": t.inputSchema}}</code>ë¡œ ë³€í™˜</p>
  </li>
  <li>
    <p>LLM í˜¸ì¶œ â†’ <code class="language-plaintext highlighter-rouge">tool_calls</code> ì˜¤ë©´ <code class="language-plaintext highlighter-rouge">client.call_tool(tname, args)</code> ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ tool ë©”ì‹œì§€ë¡œ ì¬ì£¼ì… â†’ ë°˜ë³µ</p>
  </li>
</ol>

<hr />

<h3 id="ì •ë¦¬-1">ì •ë¦¬</h3>

<ul>
  <li>
    <p>ë„¤, ì§ˆë¬¸í•˜ì‹  <strong>â€œadd</strong> í•¨ìˆ˜ë¡œ FastMCP ì¸ìŠ¤í„´ìŠ¤ì— íˆ´ì„ ì£¼ì…í•˜ê³  ê·¸ëŒ€ë¡œ ë°˜í™˜â€_* íŒ¨í„´ì´ ê¹”ë”í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì´ ë°©ì‹ì€ <strong>ì»´í¬ì €ë¸”</strong>(ì—¬ëŸ¬ add_* ì¡°í•©), <strong>í…ŒìŠ¤íŠ¸ ìš©ì´</strong> , <strong>í”„ë¡œì„¸ìŠ¤ ì¶”ê°€ ç„¡</strong>(ì¸ë©”ëª¨ë¦¬)ë¼ëŠ” ì¥ì ì´ ìˆì–´ ìš´ì˜ì— ë”± ì¢‹ì•„ìš”.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ì•„ë‚ ë¡œê·¸ íšŒë¡œ ìµœì í™” ë°ëª¨</title><link href="https://hvppyarchive.github.io/circuit/circuit-optimization-example/" rel="alternate" type="text/html" title="ì•„ë‚ ë¡œê·¸ íšŒë¡œ ìµœì í™” ë°ëª¨" /><published>2025-10-17T15:03:52+09:00</published><updated>2025-10-17T15:03:52+09:00</updated><id>https://hvppyarchive.github.io/circuit/circuit-optimization-example</id><content type="html" xml:base="https://hvppyarchive.github.io/circuit/circuit-optimization-example/"><![CDATA[<p class="chat--user">

Analog íšŒë¡œ ìµœì í™”ë¥¼ ì†Œê°œí•˜ëŠ” ê°„ë‹¨í•œ ë°ëª¨ ì˜ˆì‹œë¥¼ ë§Œë“¤ê³  ì‹¶ì–´. 

</p>

<p class="chat--user">

Analog íšŒë¡œ ìµœì í™”ë¥¼ ì†Œê°œí•˜ëŠ” ê°„ë‹¨í•œ ë°ëª¨ ì˜ˆì‹œë¥¼ ë§Œë“¤ê³  ì‹¶ì–´. 

</p>

<p>ì¢‹ì•„! â€œì•„ë‚ ë¡œê·¸ íšŒë¡œ ìµœì í™”â€ë¥¼ ì•„ì£¼ ê°€ë³ê³  ì§ê´€ì ìœ¼ë¡œ ë³´ì—¬ì¤„ ìˆ˜ ìˆëŠ” ë°ëª¨ë¥¼ ë°”ë¡œ ë§Œë“¤ì–´ë´¤ì–´. ì£¼ì œëŠ” <strong>RC ì €ì—­í†µê³¼ í•„í„°ì˜ R, Cë¥¼ ìë™ìœ¼ë¡œ ê³¨ë¼ ëª©í‘œ ì°¨ë‹¨ì£¼íŒŒìˆ˜(fc)ë¥¼ ë§ì¶”ëŠ” ìµœì í™”</strong> ì•¼. ì•„ë˜ë¥¼ ë”°ë¼ê°€ë©´ ë.</p>

<h1 id="ë°ëª¨-ê°œìš”-step-by-step">ë°ëª¨ ê°œìš” (step-by-step)</h1>

<ol>
  <li>
    <p><strong>ë¬¸ì œ ì„¤ì •</strong> : ëª©í‘œ fc(ì˜ˆ: 1 kHz)ë¥¼ ë§Œì¡±í•˜ë„ë¡ RÂ·Cë¥¼ ê³ ë¥¸ë‹¤.</p>
  </li>
  <li>
    <p><strong>ëª©ì í•¨ìˆ˜</strong> :</p>

    <ul>
      <li>
        <p>fc ì˜¤ì°¨(ë¡œê·¸ ìŠ¤ì¼€ì¼) + (Rê°€ ë„ˆë¬´ í° ê²½ìš° í˜ë„í‹°) + (Cê°€ ë„ˆë¬´ í° ê²½ìš° í˜ë„í‹°).</p>
      </li>
      <li>
        <p>Rì´ ë„ˆë¬´ í¬ë©´ ì—´ì¡ìŒ/êµ¬ë™ì„± ì´ìŠˆ, Cê°€ ë„ˆë¬´ í¬ë©´ ë¹„ìš©/ë©´ì  ì´ìŠˆê°€ ì¦ê°€í•œë‹¤ëŠ” ê°ì„ ì£¼ë ¤ëŠ” ì¥ì¹˜.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì„¤ê³„ ë³€ìˆ˜</strong> : í‘œì¤€ E-series(ì €í•­ E24, ì»¤íŒ¨ì‹œí„° E12) í›„ë³´ ì•ˆì—ì„œ ì „ìˆ˜ íƒìƒ‰(ê°„ë‹¨Â·ë¹ ë¦„).</p>
  </li>
  <li>
    <p><strong>ê°•ê±´ì„± í™•ì¸</strong> : RÂ±5%, CÂ±10% ê³µì°¨ì—ì„œ <strong>fc ìˆ˜ìœ¨(Â±5% ìŠ¤í™)</strong>ì„ ëª¬í…Œì¹´ë¥¼ë¡œë¡œ ì¶”ì •.</p>
  </li>
  <li>
    <p><strong>ì‹œê°í™”</strong> : ë³´ë“œ í”Œë¡¯ê³¼ fc ë¶„í¬ íˆìŠ¤í† ê·¸ë¨ìœ¼ë¡œ ê²°ê³¼ í™•ì¸.</p>
  </li>
</ol>

<p>ìœ„ì˜ ì½”ë“œ ì…€ì„ ë°”ë¡œ ì‹¤í–‰í•´ì„œ ê²°ê³¼/ê·¸ë˜í”„ê¹Œì§€ í™•ì¸í•  ìˆ˜ ìˆê²Œ í–ˆì–´. ê¸°ë³¸ íŒŒë¼ë¯¸í„°ëŠ” <strong>fc=1 kHz</strong> , <strong>R 1k~1MÎ©</strong> , <strong>C 100 pF~1 ÂµF</strong> ë¡œ ì¡ì•˜ê³ , ì‹¤í–‰ ê²°ê³¼ ì˜ˆì‹œëŠ” ëŒ€ëµ ì•„ë˜ì™€ ê°™ì•„:</p>

<ul>
  <li>
    <p>ì„ íƒëœ R â‰ˆ <strong>1.6 kÎ©</strong> , C â‰ˆ <strong>0.1 ÂµF</strong> â†’ fc â‰ˆ <strong>995 Hz</strong> (ì˜¤ì°¨ <strong>-0.53%</strong>)</p>
  </li>
  <li>
    <p>ê³µì°¨ í¬í•¨ <strong>ìˆ˜ìœ¨ â‰ˆ 50.5%</strong> (ìŠ¤í™: Â±5%)</p>
  </li>
</ul>

<h1 id="ì–´ë–»ê²Œ-í™œìš©í™•ì¥í•˜ë©´-ì¢‹ì„ê¹Œ">ì–´ë–»ê²Œ í™œìš©/í™•ì¥í•˜ë©´ ì¢‹ì„ê¹Œ?</h1>

<ul>
  <li>
    <p><strong>ëª©í‘œ ë°”ê¾¸ê¸°</strong> : ì½”ë“œ ë§¨ ìœ„ <code class="language-plaintext highlighter-rouge">target_fc_hz</code>ë§Œ ë°”ê¾¸ë©´ ë(ì˜ˆ: 2 kHz, 10 kHz ë“±).</p>
  </li>
  <li>
    <p><strong>ì„¤ê³„ ì² í•™ ë°”ê¾¸ê¸°</strong> : <code class="language-plaintext highlighter-rouge">alpha, beta, gamma</code> ê°€ì¤‘ì¹˜ë¥¼ ì¡°ì ˆí•´ì„œ</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">beta</code>â†‘ â†’ R ì¤„ì´ë„ë¡ ìœ ë„(ì—´ì¡ìŒ, êµ¬ë™ ì—¬ìœ  ê°•ì¡°),</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">gamma</code>â†‘ â†’ C ì¤„ì´ë„ë¡ ìœ ë„(ë¹„ìš©/ë©´ì  ê°•ì¡°).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì‚¬ì–‘/ê³µì°¨ ë°”ê¾¸ê¸°</strong> : <code class="language-plaintext highlighter-rouge">tol_R</code>, <code class="language-plaintext highlighter-rouge">tol_C</code>, <code class="language-plaintext highlighter-rouge">spec_fc_rel</code>ì„ ì¡°ì •í•´ ìˆ˜ìœ¨ ë¯¼ê°ë„ í™•ì¸.</p>
  </li>
  <li>
    <p><strong>ì œì•½ ì¶”ê°€</strong> : ì†ŒìŠ¤/ë¶€í•˜ ì„í”¼ë˜ìŠ¤, í—ˆìš© ì „ë¥˜/ì „ì••, ì»¤íŒ¨ì‹œí„° ì¢…ë¥˜(ì„¸ë¼/íƒ„íƒˆ/ì „í•´)ë³„ ìµœëŒ€ê°’ ë“± í˜„ì‹¤ ì œì•½ì„ ë°˜ì˜í•´ í•„í„°ë§ ê°€ëŠ¥.</p>
  </li>
  <li>
    <p><strong>ë‹¤ìŒ ë‹¨ê³„</strong> :</p>

    <ul>
      <li>
        <p>2ì°¨(ë‹¤ì–‘í•œ í† í´ë¡œì§€)ë¡œ í™•ì¥í•˜ê³  Q, ìœ„ìƒ ì—¬ìœ  ë“± í¬í•¨.</p>
      </li>
      <li>
        <p>ê°„ë‹¨í•œ <strong>SPICE ì—°ë™</strong>(ì˜ˆ: ngspice .meas)ìœ¼ë¡œ ì¸¡ì •ê°’ ê¸°ë°˜ ìµœì í™”ë¡œ ì „í™˜.</p>
      </li>
      <li>
        <p><strong>ê°•ê±´ ìµœì í™”</strong> : ìˆ˜ìœ¨ì„ ëª©ì í•¨ìˆ˜ì— ì§ì ‘ í¬í•¨(ì˜ˆ: <code class="language-plaintext highlighter-rouge">-yield</code> ìµœëŒ€í™” ë˜ëŠ” í˜ë„í‹°í™”).</p>
      </li>
    </ul>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ ì´ ë°ëª¨ë¥¼ <strong>op-amp ì´ë“ ë‹¨ê³„ ìµœì í™”</strong>(ëª©í‘œ ì´ë“/ëŒ€ì—­/ìŠ¬ë£¨ìœ¨ ì œì•½)ë‚˜ <strong>ì „ì•• ë¶„ë°°ê¸° ìµœì†Œ ì „ë ¥ + ëª©í‘œ ì˜¤ì°¨</strong> ê°™ì€ ë” ì§§ì€ ì˜ˆì œë¡œ ë°”ê¿” ì¤„ ìˆ˜ë„ ìˆì–´. ì›í•˜ëŠ” íšŒë¡œ/ì‚¬ì–‘ì„ ë§í•´ì£¼ë©´, ìœ„ í…œí”Œë¦¿ ê·¸ëŒ€ë¡œ ë§ì¶°ì„œ ëŒë ¤ë³¼ê²Œ!</p>

<p class="chat--user">

ì‘ ì „ì•• ë¶„ë°°ê¸°ë¡œ í•´ì¤˜ ê·¸ë¦¬ê³  finesimì„ ì“¸ ìˆ˜ ìˆë‹¨ ê°€ì •í•˜ì— ì‹œë®¬ë ˆì´ì…˜ì„ ëŒë¦´ê±°ë¼ì„œ ì €ëŸ° ì½”ë“œëŠ” í•„ìš”ì—†ì–´ ëŒ€ì‹ ì— 1. finesim netlist 2. ìµœì í™”í•  ë³€ìˆ˜(parameter) 3. ì¸¡ì • ëŒ€ìƒ(measure) ë¥¼ í™•ì‹¤íˆ í•´ì¤¬ìœ¼ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„â€”<strong>ì „ì•• ë¶„ë°°ê¸°(Voltage Divider)</strong>ë¥¼ ì˜ˆì œë¡œ, FineSim(HSPICE í˜¸í™˜)ìœ¼ë¡œ ê³§ì¥ ëŒë¦´ ìˆ˜ ìˆê²Œ ì•„ë˜ 3ê°€ì§€ë¥¼ ë”± ì •ë¦¬í–ˆì–´.</p>

<hr />

<h1 id="1-finesim-netlist-ë³µì‚¬-ë¶™ì—¬ë„£ê¸°-ì‹¤í–‰ìš©">1) FineSim Netlist (ë³µì‚¬-ë¶™ì—¬ë„£ê¸° ì‹¤í–‰ìš©)</h1>

<p>ì•„ë˜ deckì€ <strong>ì†ŒìŠ¤ ì§ë ¬ ì„í”¼ë˜ìŠ¤(RS)</strong> , <strong>ë¶„ë°°ê¸°(R1, R2)</strong> , <strong>ë¶€í•˜(RL)</strong>ê¹Œì§€ í¬í•¨í•œ í˜„ì‹¤ì ì¸ ì „ì•• ë¶„ë°°ê¸°ì´ë©°,</p>

<ul>
  <li>
    <p>(A) OPì—ì„œ ì •ë°€ë„/ì†Œëª¨ ì „ë¥˜/ì „ë ¥ ì¸¡ì •,</p>
  </li>
  <li>
    <p>(B) ì†ŒìŠ¤ ì „ì•• ë³€í™”ì— ëŒ€í•œ <strong>Line Regulation</strong> ,</p>
  </li>
  <li>
    <p>(C) ë¶€í•˜ ë³€í™”ì— ëŒ€í•œ <strong>Load Regulation</strong><br />
ì„ ê°ê° ì¸¡ì •í•˜ë„ë¡ ë¶„ë¦¬í•´ ë‘ì—ˆì–´. ê° ë¸”ë¡ì€ <strong>í•„ìš”í•œ ê²ƒë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ì£¼ì„ ì²˜ë¦¬</strong> í•˜ê³  ëŒë¦¬ë©´ ë¼.</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spice

*------------------------------------------------------------
* Voltage Divider Optimization Demo (FineSim/HSPICE compatible)
*------------------------------------------------------------
.option post=2 measform=1
*.option nomod         * (í•„ìš”ì‹œ) ëª¨ë¸ ìµœì†Œ ì¶œë ¥

* ----- Parameters (ìµœì í™” ë³€ìˆ˜ ë° ìŠ¤í™) -----
.param VSUP      = 3.3        * ê³µê¸‰ ì „ì•• [V]
.param V_SPEC    = 1.0        * ëª©í‘œ ì¶œë ¥ ì „ì•• [V]
.param RS        = 50         * ì†ŒìŠ¤ ì§ë ¬ ì €í•­ [Ohm]  (ì˜ˆ: ì‹ í˜¸ì›/ë ˆê·¤ë ˆì´í„° ì¶œë ¥ ì„í”¼ë˜ìŠ¤)
.param RL        = 100k       * ë¶€í•˜ [Ohm]

* === ìµœì í™” ëŒ€ìƒ ë³€ìˆ˜(ì•ˆ) A: R1, R2 ì§ì ‘ ìµœì í™” ===
.param R1        = 10k
.param R2        = 22k

* === ìµœì í™” ëŒ€ìƒ ë³€ìˆ˜(ì•ˆ) B: ì´ì €í•­ RTì™€ ë¹„ìœ¨ Kë¥¼ ìµœì í™” (R1,R2 íŒŒìƒ) ===
* .param RT     = 100k        * R1+R2 (ì „ë ¥/ë…¸ì´ì¦ˆ/ë©´ì  íŠ¸ë ˆì´ë“œì˜¤í”„)
* .param K      = 0.25        * ì´ìƒì  ë¹„ìœ¨ = Vout/Vin (0&lt;K&lt;1)
* .param R1     = 'RT*(1-K)'
* .param R2     = 'RT*K'

* ----- Circuit -----
V1   VIN_SRC  0  DC 'VSUP'
RSRC VIN_SRC  VIN 'RS'
RUP  VIN      VOUT 'R1'
RDN  VOUT     0   'R2'
RLOAD VOUT    0   'RL'

* ============================================================
* (A) OP ê¸°ë°˜ ì¸¡ì •: ì •í™•ë„/ì†ŒìŠ¤ ì „ë¥˜/ì „ë ¥
* ============================================================
.op

* ì¶œë ¥/ì˜¤ì°¨
.measure DC  VOUT      param='v(VOUT)'
.measure DC  VERR      param='v(VOUT)-V_SPEC'
.measure DC  VERR_ABS  param='abs(v(VOUT)-V_SPEC)'
.measure DC  RATIO     param='v(VOUT)/VSUP'      * ì´ìƒì ìœ¼ë¡  ~ R2/(R1+R2)

* ì†ŒìŠ¤ ì „ë¥˜/ì „ë ¥ (SPICE ë¶€í˜¸ ê´€ë¡€: I(V1) &gt;0ì´ë©´ ì†ŒìŠ¤ì— ìœ ì…)
.measure DC  IIN       param='-I(V1)'            * ì†ŒìŠ¤ê°€ ê³µê¸‰í•˜ëŠ” ì „ë¥˜ [A]
.measure DC  PIN       param='(-I(V1))*VSUP'     * ì´ ì†Œë¹„ ì „ë ¥ [W]

* ë¶€í’ˆ ì „ë¥˜(ì°¸ê³ )
.measure DC  I_R1      param='(v(VIN)-v(VOUT))/R1'
.measure DC  I_R2      param='v(VOUT)/R2'
.measure DC  I_RL      param='v(VOUT)/RL'

* ============================================================
* (B) Line Regulation: Vin ë³€í™”ì— ëŒ€í•œ Vout ë¯¼ê°ë„
*    - í•„ìš”ì‹œë§Œ ì‚¬ìš©: ì´ ë¸”ë¡ë§Œ ë‚¨ê¸°ê³  (A),(C)ëŠ” ì£¼ì„ ì²˜ë¦¬
* ============================================================
*.dc V1 3.0 3.6 0.3
*.measure DC  VOUT_MIN  FIND v(VOUT) AT=3.0
*.measure DC  VOUT_MAX  FIND v(VOUT) AT=3.6
*.measure DC  LINE_REG  param='(VOUT_MAX - VOUT_MIN)/(3.6 - 3.0)'
*  ë‹¨ìœ„: V/V  (ì›í•˜ë©´ %/Vë¡œ ë³´ê³  ì‹¶ìœ¼ë©´ 100*... ì‚¬ìš©)

* ============================================================
* (C) Load Regulation: RL ë³€í™”(ë¶€í•˜ ì „ë¥˜ ì¦ê°€)ì— ë”°ë¥¸ Vout ë¯¼ê°ë„
*    - í•„ìš”ì‹œë§Œ ì‚¬ìš©: ì´ ë¸”ë¡ë§Œ ë‚¨ê¸°ê³  (A),(B)ëŠ” ì£¼ì„ ì²˜ë¦¬
*    - FineSim/HSPICE: .dc param &lt;name&gt; &lt;start&gt; &lt;stop&gt; &lt;step&gt;
* ============================================================
*.dc param RL 20k 1Meg 20k
*.measure DC  VOUT_LIGHT  FIND v(VOUT) AT=1e6
*.measure DC  VOUT_HEAVY  FIND v(VOUT) AT=20e3
*.measure DC  LOAD_REG    param='(VOUT_LIGHT - VOUT_HEAVY)/VOUT_LIGHT'
*  ë‹¨ìœ„: ìƒëŒ€ ë³€í™”(ë¬´ì°¨ì›). í•„ìš”ì‹œ V/decade ë“±ìœ¼ë¡œ ì¬ì •ì˜ ê°€ëŠ¥.

.end
</code></pre></div></div>

<blockquote>
  <p>ì‹¤í–‰ íŒ: (A),(B),(C)ë¥¼ <strong>ë™ì‹œì— ëŒë¦¬ë©´ ë¶„ì„ì´ ê²¹ì¹˜ë¯€ë¡œ</strong> , í•„ìš”í•œ ë¸”ë¡ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” <code class="language-plaintext highlighter-rouge">*</code>ë¡œ ì£¼ì„ ì²˜ë¦¬í•´ì„œ ì‹¤í–‰í•´ì¤˜.<br />
 ì¸¡ì • ê²°ê³¼ëŠ” FineSim/HSPICEì˜ <code class="language-plaintext highlighter-rouge">.measure</code> ê²°ê³¼ íŒŒì¼(ì˜ˆ: <code class="language-plaintext highlighter-rouge">.mt#</code>)ë¡œ ë‚˜ì™€.</p>
</blockquote>

<hr />

<h1 id="2-ìµœì í™”í• -ë³€ìˆ˜-parameter">2) ìµœì í™”í•  ë³€ìˆ˜ (Parameter)</h1>

<p>ë‘ ê°€ì§€ ì ‘ê·¼ ì¤‘ <strong>ì›í•˜ëŠ” ë°©ì‹ í•˜ë‚˜</strong> ë¥¼ íƒí•´:</p>

<h3 id="a-r1-r2-ì§ì ‘-ìµœì í™”">A. R1, R2 ì§ì ‘ ìµœì í™”</h3>

<ul>
  <li>
    <p><strong>ì„¤ê³„ë³€ìˆ˜</strong> : <code class="language-plaintext highlighter-rouge">R1</code>, <code class="language-plaintext highlighter-rouge">R2</code></p>
  </li>
  <li>
    <p><strong>ê¶Œì¥ ë²”ìœ„</strong> (ì˜ˆì‹œ):</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">1 kÎ© â‰¤ R1, R2 â‰¤ 1 MÎ©</code></p>
      </li>
      <li>
        <p>ì´ì €í•­ <code class="language-plaintext highlighter-rouge">R1+R2</code>ì— ì¶”ê°€ ì œì•½: <code class="language-plaintext highlighter-rouge">20 kÎ© â‰¤ R1+R2 â‰¤ 2 MÎ©</code></p>

        <ul>
          <li>(ë„ˆë¬´ ì‘ìœ¼ë©´ ì „ë ¥ ì¦ê°€/ì†ŒìŠ¤ ë¶€í•˜ ê³¼ì¤‘, ë„ˆë¬´ í¬ë©´ ë…¸ì´ì¦ˆ/ì˜¤í”„ì…‹ ë¯¼ê°ì„± ì¦ê°€)</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>E-series ì œì•½</strong> ì´ í•„ìš”í•˜ë©´, ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ <strong>ë¼ìš´ë”©(E24/E96)</strong> í›„ ì¬ì¸¡ì • ë£¨í”„ë¥¼ ëŒë¦¬ë©´ ì¢‹ì•„.</p>
  </li>
</ul>

<h3 id="b-íŒŒìƒ-ë³€ìˆ˜ë¡œ-ë‹¨ìˆœí™”-ì¶”ì²œ">B. íŒŒìƒ ë³€ìˆ˜ë¡œ ë‹¨ìˆœí™” (ì¶”ì²œ)</h3>

<ul>
  <li>
    <p><strong>ì„¤ê³„ë³€ìˆ˜</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">RT = R1+R2</code> (ì „ë ¥/ë…¸ì´ì¦ˆ/ë©´ì ì„ ì¢Œìš°)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">K = R2/(R1+R2) â‰ˆ Vout/Vin</code> (ëª©í‘œ ë¶„ë°° ë¹„ìœ¨)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>íŒŒìƒê´€ê³„</strong> :</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">R1 = RT*(1-K)</code>, <code class="language-plaintext highlighter-rouge">R2 = RT*K</code></li>
    </ul>
  </li>
  <li>
    <p><strong>ê¶Œì¥ ë²”ìœ„(ì˜ˆì‹œ)</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">10 kÎ© â‰¤ RT â‰¤ 1 MÎ©</code></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">0.1 â‰¤ K â‰¤ 0.9</code> (ì–‘ ëë‹¨ì€ ë¯¼ê°ë„â†‘ë¼ ë„ˆë¬´ ì¹˜ìš°ì¹˜ì§€ ì•Šê²Œ)</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h1 id="3-ì¸¡ì •-ëŒ€ìƒ-measure">3) ì¸¡ì • ëŒ€ìƒ (Measure)</h1>

<p>ìµœì í™”ì˜ <strong>ëª©í‘œ/ì œì•½</strong> ìœ¼ë¡œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ ì´ë¦„ì„ ì •ë¦¬í–ˆì–´.<br />
(ëª¨ë‘ netlistì˜ <code class="language-plaintext highlighter-rouge">.measure</code>ë¡œ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìŒ)</p>

<p><strong>ì •í™•ë„ ê´€ë ¨</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">VOUT</code> : ì¶œë ¥ ì „ì••</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">VERR_ABS</code> : <code class="language-plaintext highlighter-rouge">|VOUT - V_SPEC|</code> â†’ <strong>ìµœì†Œí™”</strong> (ì˜ˆ: â‰¤ 10 mV)</p>
  </li>
</ul>

<p><strong>ì „ë ¥/ì „ë¥˜ ê´€ë ¨</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">IIN</code> : ì†ŒìŠ¤ê°€ ê³µê¸‰í•˜ëŠ” ì „ë¥˜ â†’ <strong>ìµœì†Œí™”</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">PIN</code> : ì´ ì†Œë¹„ ì „ë ¥ â†’ <strong>ìµœì†Œí™”</strong></p>
  </li>
</ul>

<p><strong>ë ˆê·¤ë ˆì´ì…˜(ì„ íƒ ì¸¡ì •)</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">LINE_REG</code> : <code class="language-plaintext highlighter-rouge">Î”Vout/Î”Vin</code> â†’ <strong>ì ˆëŒ€ê°’ ìµœì†Œí™”</strong> (ë¼ì¸ ë³€ë™ ë¯¼ê°ë„)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">LOAD_REG</code> : <code class="language-plaintext highlighter-rouge">(Vout_lightâˆ’Vout_heavy)/Vout_light</code> â†’ <strong>ì ˆëŒ€ê°’ ìµœì†Œí™”</strong> (ë¶€í•˜ ë³€ë™ ë¯¼ê°ë„)</p>
  </li>
</ul>

<hr />

<h2 id="ê¶Œì¥-ìµœì í™”-í¬ë§·ì˜ˆì‹œ">ê¶Œì¥ ìµœì í™” í¬ë§·(ì˜ˆì‹œ)</h2>

<ul>
  <li><strong>ëª©í‘œ</strong> :</li>
</ul>

<table>
  <tbody>
    <tr>
      <td>minâ¡   w1â‹…VERR_ABS + w2â‹…PIN + w3â‹…âˆ£LINE_REGâˆ£ + w4â‹…âˆ£LOAD_REGâˆ£\min \ \ \ w_1 \cdot \text{VERR\_ABS} \ +\ w_2 \cdot \text{PIN} \ +\ w_3 \cdot</td>
      <td>\text{LINE\_REG}</td>
      <td>\ +\ w_4 \cdot</td>
      <td>\text{LOAD\_REG}</td>
      <td>min   w1â€‹â‹…VERR_ABS + w2â€‹â‹…PIN + w3â€‹â‹…âˆ£LINE_REGâˆ£ + w4â€‹â‹…âˆ£LOAD_REGâˆ£</td>
    </tr>
  </tbody>
</table>

<p>(ê°€ì¤‘ì¹˜ wiw_iwiâ€‹ëŠ” í”„ë¡œì íŠ¸ ìš°ì„ ìˆœìœ„ì— ë§ì¶° ì„ íƒ. ì²˜ìŒì—” w1w_1w1â€‹ì„ í¬ê²Œ ë‘ê³ , ì„±ê³µ í›„ w2w_2w2â€‹â†‘ë¡œ ì „ë ¥ ì¤„ì´ëŠ” 2ë‹¨ê³„ ì ‘ê·¼ ê¶Œì¥.)</p>

<ul>
  <li>
    <p><strong>ì œì•½(ì˜ˆì‹œ)</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">VERR_ABS â‰¤ 0.01</code> V (Â±10 mV ìŠ¤í™)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">IIN â‰¤ 100 Î¼A</code> (ì €ì „ë ¥ ìš”êµ¬ ì‹œ)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">RS</code>ì™€ <code class="language-plaintext highlighter-rouge">RL</code>ì€ ì‹œìŠ¤í…œì—ì„œ ì£¼ì–´ì§„ ê°’(í˜¹ì€ ì›ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤)ìœ¼ë¡œ ê³ ì •</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ì‹¤ì „-íŒ">ì‹¤ì „ íŒ</h2>

<ul>
  <li>
    <p>ì‹¤ì œ ì‹œìŠ¤í…œì˜ <code class="language-plaintext highlighter-rouge">RS</code>(ì†ŒìŠ¤ ì„í”¼ë˜ìŠ¤), <code class="language-plaintext highlighter-rouge">RL</code>(ë¶€í•˜)ì„ <strong>ì›ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤</strong> ë¡œ ë„£ê³  ìµœì í™”í•˜ë©´, ì´ì‹ì„±ì´ ì¢‹ìŒ.</p>
  </li>
  <li>
    <p>ê³µì°¨(Â±1~5%)ë¥¼ ê³ ë ¤í•˜ë ¤ë©´, <code class="language-plaintext highlighter-rouge">.alter</code>ë¡œ R1/R2ì— ìŠ¤ì¼€ì¼ íŒŒë¼ë¯¸í„°(<code class="language-plaintext highlighter-rouge">S1</code>,<code class="language-plaintext highlighter-rouge">S2</code>)ë¥¼ ë‘¬ì„œ 0.95/1.00/1.05 ì¼€ì´ìŠ¤ë¥¼ <strong>ë°°ì¹˜ ì¸¡ì •</strong> í•˜ê³ , ìµœì í™” ëª©í‘œì— â€œìµœì•…ì˜ <code class="language-plaintext highlighter-rouge">VERR_ABS</code>â€ë¥¼ í¬í•¨ì‹œí‚¤ë©´ ê°„ë‹¨í•œ ê°•ê±´ ìµœì í™”ê°€ ë¨.</p>
  </li>
</ul>

<p>ì›í•˜ëŠ” ëª©í‘œ ì „ì••/ì „ë ¥ í•œê³„ë‚˜ ë ˆê·¤ë ˆì´ì…˜ í•œê³„ì¹˜ê°€ ìˆë‹¤ë©´ ì•Œë ¤ì¤˜. ê·¸ ê°’ë“¤ë¡œ <code class="language-plaintext highlighter-rouge">V_SPEC</code>, ì œì•½/ê°€ì¤‘ì¹˜ ì¶”ì²œ ì„¸íŠ¸ê¹Œì§€ ë°”ë¡œ ë§ì¶°ì„œ ë±ì„ ë” ë‹¤ë“¬ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

ì´ ìƒí™©ì—ì„œ R1, R2 ë³€ìˆ˜ì˜ ìœ í˜•ê³¼ ë²”ìœ„ë¥¼ ì •í•´ì¤˜. í˜„ì‹¤ì˜ ì œì•½ ì‚¬í•­ì„ ê³ ë ¤í•´ì„œ Continuous, Incremental, Discrete ë³€ìˆ˜ ì¤‘ ë­ë¡œ í• ì§€, ë²”ìœ„ì™€ Step(ìˆë‹¤ë©´)ì„ ì •í•´ì£¼ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤

</p>

<p>ì¢‹ì•„â€”â€œì „ì•• ë¶„ë°°ê¸° + FineSimâ€ ìƒí™©ì—ì„œ <strong>R1, R2 ë³€ìˆ˜ì˜ ìœ í˜•/ë²”ìœ„/ìŠ¤í…</strong> ì„ í˜„ì‹¤ ì œì•½(ë¶€í•˜ RL=100 kÎ©, Vin=3.3 V, Vout=1.0 V ëª©í‘œ)ê¹Œì§€ ê³ ë ¤í•´ <strong>ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” 3ê°€ì§€ í”„ë¡œíŒŒì¼</strong> ë¡œ ì •ë¦¬í–ˆì–´. (ìƒì‚° ê´€ì  â†’ ì‹œë®¬/ìµœì í™” í¸ì˜ ìˆœìœ¼ë¡œ)</p>

<hr />

<h1 id="ê¶Œì¥-1-discrete-e-series-ìƒì‚°-ì§€í–¥-">ê¶Œì¥ 1) Discrete (E-series, ìƒì‚° ì§€í–¥) âœ…</h1>

<p><strong>ì™œ Discrete?</strong> ì‹¤ì œ ë¶€í’ˆì€ E-series(ê³µì°¨ 1%ë©´ E96 ë“±)ë¡œë§Œ ì¡´ì¬. ìµœì í™” ê²°ê³¼ê°€ ê³§ë°”ë¡œ BOMìœ¼ë¡œ ì´ì–´ì§.</p>

<ul>
  <li>
    <p>ë¶„ë°° ë¹„ìœ¨ K=Vout/Vinâ‰ˆ1/3.3â‰ˆ0.303K = V_\text{out}/V_\text{in} \approx 1/3.3 \approx 0.303K=Voutâ€‹/Vinâ€‹â‰ˆ1/3.3â‰ˆ0.303</p>
  </li>
  <li>
    <p>ì´ìƒì  ê´€ê³„: R1=R2â‹…1âˆ’KKâ‰ˆ2.30 R2R_1 = R_2\cdot\frac{1-K}{K} \approx 2.30\,R_2R1â€‹=R2â€‹â‹…K1âˆ’Kâ€‹â‰ˆ2.30R2â€‹</p>
  </li>
</ul>

<h3 id="ì •í™•ë„-ìš°ì„ ë²„í¼-ì—†ìŒ-rl100-kÏ‰-ë¡œë”©ì˜¤ì°¨-1-ëª©í‘œ">ì •í™•ë„ ìš°ì„ (ë²„í¼ ì—†ìŒ, RL=100 kÎ© ë¡œë”©ì˜¤ì°¨ â‰¤â‰ˆ1% ëª©í‘œ)</h3>

<ul>
  <li>
    <p><strong>í•µì‹¬ ê·œì¹™</strong> : ë¡œë”©ì˜¤ì°¨ë¥¼ 1%ëŒ€ ìœ ì§€í•˜ë ¤ë©´ <strong>R 2â‰²RL/100â‰ˆ1.0 kÎ©R_2 \lesssim RL/100 \approx 1.0\text{ kÎ©}R2â€‹â‰²RL/100â‰ˆ1.0 kÎ©</strong></p>
  </li>
  <li>
    <p><strong>ìŠ¤í™</strong></p>

    <ul>
      <li>
        <p><strong>R2 (Discrete, E96 1%)</strong> : <strong>680 Î© ~ 1.2 kÎ©</strong></p>
      </li>
      <li>
        <p><strong>R1 (Discrete, E96 1%)</strong> : R1â‰ˆ2.30R2R_1 \approx 2.30 R_2R1â€‹â‰ˆ2.30R2â€‹ â†’ <strong>1.6 kÎ© ~ 3.0 kÎ©</strong></p>
      </li>
      <li>
        <p><strong>ì´ì €í•­ RT=R1+R2R_T=R_1+R_2RTâ€‹=R1â€‹+R2â€‹</strong>: <strong>â‰ˆ 2.3 kÎ© ~ 4.2 kÎ©</strong> (ë¶„ë°° ì „ë¥˜ 0.8~1.4 mA @3.3 V)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ìŠ¤í…</strong> : <strong>E96 í‘œì¤€ì¹˜</strong>(í•´ë‹¹ ë°ì¼€ì´ë“œì˜ E96 ê°’ë§Œ í—ˆìš©).</p>

    <ul>
      <li>FineSimì—ì„  ìµœì í™” ë£¨í”„ê°€ Discreteë¥¼ ëª» ë‹¤ë£¨ë©´ <strong>í—ˆìš© ë¦¬ìŠ¤íŠ¸</strong> ë¥¼ ì™¸ë¶€ì—ì„œ ê³µê¸‰(.step list)í•˜ê±°ë‚˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ enumerate.</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>ì˜ˆ) R2 í›„ë³´: {681, 715, 750, 787, 825, 866, 909, 953, 1000, 1050, 1100, 1150} Î©<br />
 ê° R2ì— ëŒ€í•´ R1ì„ 2.30R22.30 R_22.30R2â€‹ ê·¼ì²˜ì˜ <strong>E96</strong> ê°’ìœ¼ë¡œ ìŠ¤ëƒ…(ì˜ˆ: 2.00k, 2.05k, 2.10k, 2.21kâ€¦).</p>
</blockquote>

<hr />

<h1 id="ì˜µì…˜-2-discreteê· í˜•í˜•-ì „ë¥˜ì •í™•ë„-íƒ€í˜‘">ì˜µì…˜ 2) Discrete(ê· í˜•í˜•, ì „ë¥˜/ì •í™•ë„ íƒ€í˜‘)</h1>

<p><strong>ë¡œë”©ì˜¤ì°¨ 2~6% ì •ë„ í—ˆìš©</strong> í•˜ê³  ì „ë¥˜ë¥¼ ì¤„ì´ê³  ì‹¶ì„ ë•Œ.</p>

<ul>
  <li>
    <p><strong>R2 (E96 1%)</strong> : <strong>1.5 kÎ© ~ 10 kÎ©</strong></p>
  </li>
  <li>
    <p><strong>R1 (E96 1%)</strong> : <strong>â‰ˆ 3.5kÎ© 23kÎ© \approx 3.5 kÎ© ~ 23 kÎ©â‰ˆ3.5kÎ© 23kÎ©</strong></p>
  </li>
  <li>
    <p><strong>R TR_TRTâ€‹</strong>: <strong>5 kÎ© ~ 33 kÎ©</strong> (ë¶„ë°° ì „ë¥˜ â‰ˆ 100~660 Î¼A)</p>
  </li>
  <li>
    <p><strong>ìŠ¤í…</strong> : <strong>E96</strong></p>
  </li>
  <li>
    <p>ì£¼ì˜: RL=100 kÎ©ì™€ ë³‘ë ¬ íš¨ê³¼ë¡œ ëª©í‘œì¹˜ ëŒ€ë¹„ <strong>ìˆ˜ % ë‚®ê²Œ</strong> ë‚˜ì˜¤ë¯€ë¡œ,</p>

    <ul>
      <li>
        <p>ëª©í‘œë¥¼ ë¯¸ë¦¬ ì•½ê°„ <strong>ìƒí–¥ ë³´ì •</strong> í•´ì„œ ì„¤ê³„í•˜ê±°ë‚˜,</p>
      </li>
      <li>
        <p>í›„ë‹¨ì— <strong>ë²„í¼(ì˜µì•°í”„ íŒ”ë¡œì–´)</strong>ë¥¼ ì¶”ê°€í•˜ë©´ ì˜¤ì°¨ í¬ê²Œ ê°œì„ ë¨.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h1 id="ì˜µì…˜-3-incrementalë¡œê·¸-ìŠ¤í…-íƒìƒ‰ìµœì í™”-í¸ì˜">ì˜µì…˜ 3) Incremental(ë¡œê·¸ ìŠ¤í…, íƒìƒ‰/ìµœì í™” í¸ì˜)</h1>

<p>ìµœì í™”ê¸°ê°€ <strong>ì—°ì†â†’ìŠ¤ëƒ…</strong> ì´ ë²ˆê±°ë¡­ê±°ë‚˜, Discrete ë¦¬ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ì»¤ì§ˆ ë•Œ ìœ ìš©.</p>

<ul>
  <li>
    <p><strong>ì•„ì´ë””ì–´</strong> : ë¡œê·¸ ìŠ¤ì¼€ì¼ <strong>2% ìŠ¤í…</strong>(â‰ˆE48)ë¡œ ê·¸ë¦¬ë“œ íƒìƒ‰ â†’ <strong>ìµœì¢…ì— E96 ìŠ¤ëƒ…</strong></p>
  </li>
  <li>
    <p><strong>R2 (Incremental)</strong> : <strong>680 Î© ~ 10 kÎ©, ìŠ¤í… Ã—1.02</strong></p>

    <ul>
      <li>ì‹œí€€ìŠ¤: 680 â†’ 694 â†’ 708 â†’ â€¦ â†’ 10 kÎ©</li>
    </ul>
  </li>
  <li>
    <p><strong>R1 (Incremental)</strong> : ë²”ìœ„ë¥¼ R1â‰ˆ2.30R2R_1 \approx 2.30 R_2R1â€‹â‰ˆ2.30R2â€‹ ì£¼ë³€ìœ¼ë¡œ ì¡ë˜ ë„‰ë„‰íˆ</p>

    <ul>
      <li><strong>1.5 kÎ© ~ 30 kÎ©, ìŠ¤í… Ã—1.02</strong></li>
    </ul>
  </li>
  <li>
    <p><strong>ìµœì¢… ìƒì‚°ì¹˜ ë°˜ì˜</strong> : ìµœì ì  ê·¼ë°©ì„ <strong>E96 ê·¼ì‚¬ì¹˜</strong> ë¡œ ìŠ¤ëƒ…í•˜ê³  ë‹¤ì‹œ ì¸¡ì •(.measure í™•ì¸).</p>
  </li>
</ul>

<hr />

<h2 id="ì–¸ì œ-continuous">ì–¸ì œ Continuous?</h2>

<ul>
  <li>
    <p><strong>ì´ˆê¸° ê°ë„ ìŠ¤ìº”</strong> ìš©ë„ë¡œë§Œ ì¶”ì²œ. í˜„ì‹¤ ë¶€í’ˆ ìŠ¤ëƒ…ì´ ë”°ë¡œ í•„ìš”í•´ ë²ˆê±°ë¡œì›€.</p>
  </li>
  <li>
    <p>ë§Œì•½ ì“´ë‹¤ë©´:</p>

    <ul>
      <li>
        <p><strong>R2 (Continuous)</strong> : <strong>500 Î© ~ 33 kÎ©</strong></p>
      </li>
      <li>
        <p><strong>R1 (Continuous)</strong> : <strong>1.2 kÎ© ~ 75 kÎ©</strong></p>
      </li>
      <li>
        <p>ë‹¨, RL=100 kÎ©ì´ë©´ <strong>ì •í™•ë„ ìš”êµ¬ê°€ ë†’ì„ìˆ˜ë¡ R2 ìƒí•œì„ 1 kÎ© ë¶€ê·¼ìœ¼ë¡œ ê°•í•˜ê²Œ ì œí•œ</strong> í•´ì•¼ í•¨(ë¡œë”©ì˜¤ì°¨ ë•Œë¬¸).</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ì•ˆì „ì„±-ì²´í¬ê°„ë‹¨-ì‚°ì¶œ">ì•ˆì „ì„± ì²´í¬(ê°„ë‹¨ ì‚°ì¶œ)</h2>

<ul>
  <li>
    <p><strong>ì „ë ¥/ì „ì••</strong> : Vin=3.6 V worst ê°€ì •, RTâ‰¥2.3 kÎ©R_T \ge 2.3\text{ kÎ©}RTâ€‹â‰¥2.3 kÎ©ì¼ ë•Œ</p>

    <ul>
      <li>
        <p>ë¶„ë°° ì „ë¥˜ â‰¤ 1.6 mA,</p>
      </li>
      <li>
        <p>PR1=I2R1â‰²P_{R1}=I^2R_1 \lesssimPR1â€‹=I2R1â€‹â‰² ìˆ˜ mW ìˆ˜ì¤€ â†’ <strong>0603 1/10W</strong> ì—¬ìœ  ì¶©ë¶„.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ë…¸ì´ì¦ˆ</strong> : 4kTRT\sqrt{4kTR_T}4kTRTâ€‹â€‹ â†’ RTê°€ ì‘ì„ìˆ˜ë¡ ìœ ë¦¬(ì •í™•ë„ ìš°ì„  í”„ë¡œíŒŒì¼ê³¼ ì •í•©).</p>
  </li>
</ul>

<hr />

<h2 id="í•œ-ì¤„-ì¶”ì²œì§€ê¸ˆ-ìƒí™©-ê¸°ì¤€">í•œ ì¤„ ì¶”ì²œ(ì§€ê¸ˆ ìƒí™© ê¸°ì¤€)</h2>

<ul>
  <li>
    <p><strong>R1, R2ëŠ” â€œDiscrete(E96, 1%)â€ë¡œ ìš´ìš©</strong></p>
  </li>
  <li>
    <p><strong>R2: 680 Î© ~ 1.2 kÎ© (E96), R1: 1.6 kÎ© ~ 3.0 kÎ© (E96)</strong></p>
  </li>
  <li>
    <p>ìµœì í™” í›„ ê²°ê³¼ë¥¼ <strong>E96 ìŠ¤ëƒ… â†’ .measure ì¬í™•ì¸</strong>(Vout, ì „ë¥˜, ë ˆê·¤ë ˆì´ì…˜).</p>
  </li>
</ul>

<p>ì›í•˜ë©´ ìœ„ ë²”ìœ„ë¥¼ <strong>.step list</strong> í˜•íƒœ(ì˜ˆ: E96 í›„ë³´ 20~40ê°œ)ë¡œ ë°”ë¡œ ë¶™ì—¬ ì“°ëŠ” ìŠ¤ë‹ˆí«ë„ ë§Œë“¤ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

.op ì‹œë®¬ë ˆì´ì…˜ ë§ê³  .dc ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•´ì¤„ ìˆ˜ ìˆì–´?

</p>

<p>ì¢‹ì§€! <strong>.op ëŒ€ì‹  .dcë§Œ ì‚¬ìš©</strong> í•˜ë„ë¡ ë±ì„ ì •ë¦¬í–ˆì–´. ì•„ë˜ 3ê°€ì§€ë§Œ ê·¸ëŒ€ë¡œ ì“°ë©´ ë¼.</p>

<hr />

<h1 id="1-finesim-netlist-dc-ì „ìš©">1) FineSim Netlist (.dc ì „ìš©)</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spice

*------------------------------------------------------------
* Voltage Divider Optimization Demo (FineSim/HSPICE compatible)
*   - ëª¨ë“  í•´ì„ì€ .dc ê¸°ë°˜
*------------------------------------------------------------
.option post=2 measform=1

* ===== íŒŒë¼ë¯¸í„°(ìµœì í™” ë³€ìˆ˜/í™˜ê²½) =====
.param VSUP   = 3.3          * ê³µê¸‰ì „ì•• [V]
.param V_SPEC = 1.0          * ëª©í‘œ ì¶œë ¥ [V]
.param RS     = 50           * ì†ŒìŠ¤ ì§ë ¬ì €í•­ [Ohm]
.param RL     = 100k         * ë¶€í•˜ [Ohm]

* === ìµœì í™” ë³€ìˆ˜ (ì•ˆ A: R1, R2 ì§ì ‘) ===
.param R1     = 1.80k        * ì´ˆê¸°ê°’(ì˜µí‹°ë§ˆì´ì €ê°€ ì—…ë°ì´íŠ¸)
.param R2     = 820          * ì´ˆê¸°ê°’(ì˜µí‹°ë§ˆì´ì €ê°€ ì—…ë°ì´íŠ¸)

* === ìµœì í™” ë³€ìˆ˜ (ì•ˆ B: RT, K ì‚¬ìš©) ===
* .param RT   = 3.0k         * R1+R2
* .param K    = 0.303        * R2/(R1+R2) â‰ˆ Vout/Vin
* .param R1   = 'RT*(1-K)'
* .param R2   = 'RT*K'

* ===== íšŒë¡œ =====
V1    VIN_SRC  0  DC 'VSUP'
RSRC  VIN_SRC  VIN  'RS'
RUP   VIN      VOUT 'R1'
RDN   VOUT     0    'R2'
RLOAD VOUT     0    'RL'

* ============================================================
* (A) Bias ì ì—ì„œì˜ ì¸¡ì •: .dc(ë”ë¯¸ íŒŒë¼ë¯¸í„°)ë¡œ ë‹¨ì¼ì  í•´ì„
*   - .opì„ ì“°ì§€ ì•Šê³  .dcë§Œìœ¼ë¡œ VOUT, ì˜¤ì°¨, ì „ë¥˜/ì „ë ¥ ì¸¡ì •
* ============================================================
.dc param BIAS 0 0 1
.measure DC  VOUT_A      param='v(VOUT)'
.measure DC  VERR_A      param='v(VOUT)-V_SPEC'
.measure DC  VERR_ABS_A  param='abs(v(VOUT)-V_SPEC)'
.measure DC  IIN_A       param='-I(V1)'              * ì†ŒìŠ¤ ê³µê¸‰ì „ë¥˜(+)
.measure DC  PIN_A       param='(-I(V1))*VSUP'       * ì „ì²´ì†Œë¹„ì „ë ¥
.measure DC  RATIO_A     param='v(VOUT)/VSUP'
.measure DC  I_R1_A      param='(v(VIN)-v(VOUT))/R1'
.measure DC  I_R2_A      param='v(VOUT)/R2'
.measure DC  I_RL_A      param='v(VOUT)/RL'

* ============================================================
* (B) Line Regulation: Vin ë³€í™”ì— ëŒ€í•œ Vout ë¯¼ê°ë„ (.dc V1)
*   - í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©: (A),(C)ëŠ” ì£¼ì„ ì²˜ë¦¬í•˜ê³  ì´ ë¸”ë¡ë§Œ ì‹¤í–‰ ê¶Œì¥
* ============================================================
*.dc V1 3.0 3.6 0.3
*.measure DC  VOUT_MIN_B  min v(VOUT)
*.measure DC  VOUT_MAX_B  max v(VOUT)
*.measure DC  LINE_REG_B  param='(VOUT_MAX_B - VOUT_MIN_B)/(3.6 - 3.0)'
*  ë‹¨ìœ„: V/V  (ì›í•˜ë©´ %/V â†’ 100*... )

* ============================================================
* (C) Load Regulation: RL ë³€í™”ì— ëŒ€í•œ Vout ë¯¼ê°ë„ (.dc param RL)
*   - í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©: (A),(B)ëŠ” ì£¼ì„ ì²˜ë¦¬í•˜ê³  ì´ ë¸”ë¡ë§Œ ì‹¤í–‰ ê¶Œì¥
* ============================================================
*.dc param RL 20k 1Meg 20k
*.measure DC  VOUT_MIN_C  min v(VOUT)
*.measure DC  VOUT_MAX_C  max v(VOUT)
*.measure DC  LOAD_REG_C  param='(VOUT_MAX_C - VOUT_MIN_C)/VOUT_MAX_C'
*  ìƒëŒ€ ë³€í™”(ë¬´ì°¨ì›). ë‹¤ë¥¸ ì •ì˜ê°€ í•„ìš”í•˜ë©´ ë³€ê²½ OK

.end
</code></pre></div></div>

<blockquote>
  <p>ì‚¬ìš© íŒ</p>

  <ul>
    <li>
      <p><strong>ë™ì‹œì— ì—¬ëŸ¬ .dcë¥¼ ì¼œë©´</strong> í•´ì„/ì¸¡ì •ì´ ì„ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ, (A)/(B)/(C) ì¤‘ <strong>í•„ìš”í•œ ë¸”ë¡ë§Œ ë‚¨ê¸°ê³ </strong> ë‚˜ë¨¸ì§€ëŠ” ì£¼ì„ ì²˜ë¦¬í•´ì„œ ëŒë ¤ì¤˜.</p>
    </li>
    <li>
      <p>(A)ëŠ” <strong>ë‹¨ì¼ ë°”ì´ì–´ìŠ¤ì </strong> ì„ .dcë¡œ ê°•ì œ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì´ë¯€ë¡œ, <code class="language-plaintext highlighter-rouge">.op</code> ì—†ì´ë„ ë™ì¼í•œ ì¸¡ì •ê°’ì„ ì–»ëŠ”ë‹¤.</p>
    </li>
  </ul>

</blockquote>

<hr />

<h1 id="2-ìµœì í™”í• -ë³€ìˆ˜-parameter-1">2) ìµœì í™”í•  ë³€ìˆ˜ (Parameter)</h1>

<p>í˜„ì‹¤ ë¶€í’ˆ ì œì•½ì„ ë°˜ì˜í•´ <strong>Discrete(E96, 1%)</strong>ë¡œ ìš´ìš© ê¶Œì¥.<br />
(ë¶€í•˜ RL=100 kÎ©RL=100\,\text{k}\OmegaRL=100kÎ©, ëª©í‘œ Vout=1.0 VV_\text{out}=1.0\,\text{V}Voutâ€‹=1.0V, Vin=3.3 VV_\text{in}=3.3\,\text{V}Vinâ€‹=3.3V)</p>

<ul>
  <li>
    <p><strong>R2 (E96, Discrete)</strong> : <strong>680 Î© ~ 1.2 kÎ©</strong></p>
  </li>
  <li>
    <p><strong>R1 (E96, Discrete)</strong> : <strong>1.6 kÎ© ~ 3.0 kÎ©</strong> â‰ˆ2.3Ã—R2\approx 2.3 \times R2â‰ˆ2.3Ã—R2</p>
  </li>
  <li>
    <p>ì „ë¥˜/ì •í™•ë„ íƒ€í˜‘ì„ ì›í•˜ë©´:</p>

    <ul>
      <li><strong>R2: 1.5 kÎ© ~ 10 kÎ©</strong> , <strong>R1: 3.5 kÎ© ~ 23 kÎ©</strong> (ì •í™•ë„ëŠ” ëª‡ % ë‚®ì•„ì§ˆ ìˆ˜ ìˆìŒ)</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>ìµœì í™”ê¸°ëŠ” ì™¸ë¶€ì—ì„œ í›„ë³´ë¥¼ ìˆœíšŒ(ì˜ˆ: E96 ë¦¬ìŠ¤íŠ¸)í•˜ë©° R1/R2ë¥¼ ê°±ì‹  â†’ (A) ë¸”ë¡ì„ ì‹¤í–‰ â†’ <code class="language-plaintext highlighter-rouge">.measure</code> ê²°ê³¼ë¥¼ ìŠ¤ì½”ì–´ë¡œ ì‚¬ìš©.</p>
</blockquote>

<hr />

<h1 id="3-ì¸¡ì •-ëŒ€ìƒ-measure-1">3) ì¸¡ì • ëŒ€ìƒ (Measure)</h1>

<p><strong>ëª©í‘œ/ì œì•½</strong> ìœ¼ë¡œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ ì´ë¦„ì„ ê³ ì •í•´ë‘ì—ˆì–´.</p>

<ul>
  <li>
    <p>ì •í™•ë„: <code class="language-plaintext highlighter-rouge">VERR_ABS_A = |VOUT - V_SPEC|</code> â†’ <strong>ìµœì†Œí™”</strong> (ë˜ëŠ” <code class="language-plaintext highlighter-rouge">â‰¤ ìŠ¤í™</code>)</p>
  </li>
  <li>
    <p>ì „ë¥˜/ì „ë ¥: <code class="language-plaintext highlighter-rouge">IIN_A</code>, <code class="language-plaintext highlighter-rouge">PIN_A</code> â†’ <strong>ìµœì†Œí™”</strong></p>
  </li>
  <li>
    <p>ë¹„ìœ¨ í™•ì¸: <code class="language-plaintext highlighter-rouge">RATIO_A = VOUT/VSUP</code></p>
  </li>
  <li>
    <p>ë ˆê·¤ë ˆì´ì…˜:</p>

    <ul>
      <li>
        <p><strong>ë¼ì¸</strong> : <code class="language-plaintext highlighter-rouge">LINE_REG_B</code> (ì‘ì„ìˆ˜ë¡ ì¢‹ìŒ)</p>
      </li>
      <li>
        <p><strong>ë¶€í•˜</strong> : <code class="language-plaintext highlighter-rouge">LOAD_REG_C</code> (ì‘ì„ìˆ˜ë¡ ì¢‹ìŒ)</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ê°„ë‹¨-ì›Œí¬í”Œë¡œ-step-by-step">ê°„ë‹¨ ì›Œí¬í”Œë¡œ (step-by-step)</h2>

<ol>
  <li>
    <p>(A) ë¸”ë¡ë§Œ ì¼œì„œ <strong>í›„ë³´ R1/R2</strong> ì— ëŒ€í•´ <code class="language-plaintext highlighter-rouge">.dc</code> ì‹¤í–‰ â†’ <code class="language-plaintext highlighter-rouge">VERR_ABS_A</code>, <code class="language-plaintext highlighter-rouge">IIN_A</code>, <code class="language-plaintext highlighter-rouge">PIN_A</code> ìˆ˜ì§‘.</p>
  </li>
  <li>
    <p>ìƒìœ„ ìµœì í™”ê¸°(íŒŒì´ì¬/íˆ´)ì—ì„œ <strong>Discrete í›„ë³´(E96)</strong>ë¥¼ íƒìƒ‰í•˜ë©° ëª©ì í•¨ìˆ˜ ìµœì†Œí™”.</p>
  </li>
  <li>
    <p>ìµœì¢… í›„ë³´ì— ëŒ€í•´ (B),(C) ë¸”ë¡ì„ ê°ê° ì¼œì„œ <strong>ë¼ì¸/ë¶€í•˜ ë ˆê·¤ë ˆì´ì…˜</strong> ê²€ì¦.</p>
  </li>
  <li>
    <p>í•„ìš” ì‹œ ë²”ìœ„/ëª©í‘œ ì¡°ì • â†’ ë°˜ë³µ.</p>
  </li>
</ol>

<p>ì¶”ê°€ë¡œ, E96 í›„ë³´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ <code class="language-plaintext highlighter-rouge">.include</code> ë˜ëŠ” ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ìš© <strong>ë¦¬ìŠ¤íŠ¸ í…ìŠ¤íŠ¸</strong> ê°€ í•„ìš”í•˜ë©´ ì•Œë ¤ì¤˜. ì›í•˜ëŠ” ë²”ìœ„ë¡œ ë§Œë“¤ì–´ ì¤„ê²Œ.</p>

<p class="chat--user">

ê·¸ëƒ¥ tran í•´ì„ìœ¼ë¡œ ë°”ê¿”ì¤„ ìˆ˜ ìˆì–´?

</p>

<p>ì¢‹ì•„, <strong>.tran(ê³¼ë„ í•´ì„)ë§Œ ì“°ëŠ” ì „ì•• ë¶„ë°°ê¸° ë°ëª¨</strong> ë¡œ ë°”ê¿”ì„œ ì •ë¦¬í–ˆì–´.<br />
ì•„ë˜ ë±ì€ <strong>ë°”ì´íŒ¨ìŠ¤ ì»¤íŒ¨ì‹œí„°(CLOAD)</strong>ë¥¼ ë‘¬ì„œ ìœ ì˜ë¯¸í•œ ê³¼ë„ ì‘ë‹µì´ ë‚˜ì˜¤ë„ë¡ í–ˆê³ , <strong>ì •ì°© ì˜¤ì°¨/ë¼ì´ì¦ˆ íƒ€ì„/ì „ë¥˜Â·ì—ë„ˆì§€</strong> ê°™ì€ ì¸¡ì •ì„ <code class="language-plaintext highlighter-rouge">.measure tran</code>ìœ¼ë¡œ ì •ì˜í–ˆì–´. (ë¶€í•˜ ìŠ¤í…ì„ ì£¼ëŠ” <strong>ì˜µì…˜ ë¸”ë¡</strong> ë„ í¬í•¨)</p>

<hr />

<h1 id="1-finesim-netlist--tran-ì „ìš©-ë³µë¶™-ì‹¤í–‰">1) FineSim Netlist â€” .tran ì „ìš© (ë³µë¶™ ì‹¤í–‰)</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spice

*------------------------------------------------------------
* Voltage Divider Transient Demo (FineSim/HSPICE compatible)
*   - ëª¨ë“  í•´ì„ì€ .tran(ê³¼ë„) ê¸°ë°˜
*------------------------------------------------------------
.option post=2 measform=1

* ===== íŒŒë¼ë¯¸í„° =====
.param VSUP   = 3.3          * ê³µê¸‰ì „ì•• [V]
.param V_SPEC = 1.0          * ëª©í‘œ ì¶œë ¥ [V]
.param RS     = 50           * ì†ŒìŠ¤ ì§ë ¬ì €í•­ [Ohm]
.param RL     = 100k         * ë¶€í•˜ [Ohm]
.param R1     = 1.80k        * ìµœì í™” ë³€ìˆ˜ (Discrete/E96 ê¶Œì¥)
.param R2     = 820          * ìµœì í™” ë³€ìˆ˜ (Discrete/E96 ê¶Œì¥)
.param CLOAD  = 100n         * ì¶œë ¥ ë…¸ë“œ ë°”ì´íŒ¨ìŠ¤(ê³¼ë„ ì‘ë‹µ ìœ ë„)
.param TRISE  = 1n
.param TFALL  = 1n
.param TSTOP  = 1m
.param V_BAND = 10m          * ì •ì°© í—ˆìš© ë°´ë“œ(Â±10 mV)

* ===== íšŒë¡œ =====
V1    VIN_SRC  0   PULSE(0 'VSUP' 0 'TRISE' 'TFALL' '10*TSTOP' '20*TSTOP')
RSRC  VIN_SRC  VIN 'RS'
RUP   VIN      VOUT 'R1'
RDN   VOUT     0    'R2'
RLOAD VOUT     0    'RL'
COUT  VOUT     0    'CLOAD'

* ===== ê³¼ë„ í•´ì„ =====
.tran 'TSTOP/1000' 'TSTOP'

* ===== ì¸¡ì • (ê¸°ë³¸: ë‹¨ì¼ ìƒìŠ¹ ìŠ¤í… ì‘ë‹µ) =====
.measure TRAN VOUT_FINAL  AVG  v(VOUT) FROM='0.8*TSTOP' TO='TSTOP'          ; ìµœì¢…ê°’ ê·¼ì‚¬
.measure TRAN VERR_ABS    PARAM='abs(VOUT_FINAL - V_SPEC)'                  ; ìµœì¢… ì˜¤ì°¨
.measure TRAN IIN_AVG     AVG  '-I(V1)' FROM=0 TO='TSTOP'                    ; í‰ê·  ì†ŒìŠ¤ì „ë¥˜
.measure TRAN QIN         INTEG '-I(V1)' FROM=0 TO='TSTOP'                   ; ì´ ì „í•˜ [C]
.measure TRAN EAPP        PARAM='VSUP*QIN'                                   ; ê·¼ì‚¬ ì—ë„ˆì§€ [J]
.measure TRAN TR10_90     TRIG v(VOUT) VAL='0.1*V_SPEC' RISE=1               \
                          TARG v(VOUT) VAL='0.9*V_SPEC' RISE=1               ; 10â€“90% ë¼ì´ì¦ˆ
.measure TRAN TSETTLE     WHEN 'abs(v(VOUT)-V_SPEC)-V_BAND' = 0 CROSS=1      ; Â±ë°´ë“œ ìµœì´ˆ ì§„ì… ì‹œê°„

* ===== [ì˜µì…˜] ë¶€í•˜ ìŠ¤í… ì‘ë‹µ(ë“œë£¹/ì¬ì •ì°©) =====
* - í•„ìš”í•  ë•Œë§Œ í•´ì œí•´ì„œ ì‚¬ìš© (ìŠ¤ìœ„ì¹˜ë¡œ ë³‘ë ¬ ë¶€í•˜ë¥¼ ì¶”ê°€)
*.param TLD   = '0.3*TSTOP'          * ë¶€í•˜ ì˜¨ ì‹œê°„
*.param TW    = '0.2*TSTOP'          * ì˜¨ ìœ ì§€ ì‹œê°„
*.param RSTEP = 10k                   * ì¶”ê°€ ë¶€í•˜(ì‘ì•„ì§ˆìˆ˜ë¡ ë” ë¬´ê±°ìš´ ë¶€í•˜)
*VCTRL VCTL   0 PULSE(0 1 'TLD' 1n 1n 'TW' '2*TSTOP')
*.model SLD SW VT=0.5 VH=0 RON=1 ROFF=1e12
*RLD2  VOUT   NX 'RSTEP'
*S1    NX     0  VCTL 0 SLD
*.measure TRAN VOUT_MIN_L  MIN  v(VOUT) FROM='TLD' TO='TLD+TW'               ; ë“œë£¹ ìµœì†Œê°’
*.measure TRAN VOUT_PRE    FIND v(VOUT) AT='TLD-1n'
*.measure TRAN VDROP       PARAM='VOUT_PRE - VOUT_MIN_L'                      ; ë“œë£¹ í¬ê¸°
*.measure TRAN TSETTLE_L   WHEN 'abs(v(VOUT)-V_SPEC)-V_BAND' = 0 CROSS=2      ; ë¶€í•˜ ìŠ¤í… í›„ ì¬ì •ì°©
.end
</code></pre></div></div>

<hr />

<h1 id="2-ìµœì í™”-ë³€ìˆ˜-parameter">2) ìµœì í™” ë³€ìˆ˜ (Parameter)</h1>

<ul>
  <li>
    <p><strong>R1, R2</strong> : ì‹¤ì œ ìƒì‚°ì„ ê³ ë ¤í•´ <strong>Discrete(E96, 1%)</strong> ìš´ìš© ê¶Œì¥</p>

    <ul>
      <li>
        <p>ì˜ˆì‹œ ë²”ìœ„(ì •í™•ë„ ìš°ì„ ): <strong>R2 = 680 Î© ~ 1.2 kÎ©</strong> , <strong>R1 â‰ˆ 2.3Ã—R2 â†’ 1.6 kÎ© ~ 3.0 kÎ©</strong></p>
      </li>
      <li>
        <p>íƒìƒ‰ì€ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸/ì˜µí‹°ë§ˆì´ì €ì—ì„œ E96 í›„ë³´ë¥¼ ìˆœíšŒ â†’ <code class="language-plaintext highlighter-rouge">.measure</code> ê²°ê³¼ë¥¼ ìŠ¤ì½”ì–´ë¡œ ì‚¬ìš©</p>
      </li>
    </ul>
  </li>
</ul>

<p>(ì›í•˜ë©´ <code class="language-plaintext highlighter-rouge">RT, K</code> ë°©ì‹ìœ¼ë¡œë„ ë°”ê¿”ì¤„ ìˆ˜ ìˆì–´: <code class="language-plaintext highlighter-rouge">R1=RT*(1-K)</code>, <code class="language-plaintext highlighter-rouge">R2=RT*K</code>)</p>

<hr />

<h1 id="3-ì¸¡ì •-ëŒ€ìƒ-measure-2">3) ì¸¡ì • ëŒ€ìƒ (Measure)</h1>

<ul>
  <li>
    <p><strong>ì •í™•ë„</strong> : <code class="language-plaintext highlighter-rouge">VOUT_FINAL</code>, <code class="language-plaintext highlighter-rouge">VERR_ABS</code></p>
  </li>
  <li>
    <p><strong>ì†ë„</strong> : <code class="language-plaintext highlighter-rouge">TR10_90</code>, <code class="language-plaintext highlighter-rouge">TSETTLE(Â±V_BAND)</code></p>
  </li>
  <li>
    <p><strong>ì „ë¥˜/ì—ë„ˆì§€</strong> : <code class="language-plaintext highlighter-rouge">IIN_AVG</code>, <code class="language-plaintext highlighter-rouge">QIN</code>, <code class="language-plaintext highlighter-rouge">EAPP</code></p>
  </li>
  <li>
    <p><strong>(ì˜µì…˜) ë¶€í•˜ ìŠ¤í… ì„±ëŠ¥</strong> : <code class="language-plaintext highlighter-rouge">VDROP</code>, <code class="language-plaintext highlighter-rouge">TSETTLE_L</code></p>
  </li>
</ul>

<blockquote>
  <p>ë©”ëª¨</p>

  <ul>
    <li>
      <p><code class="language-plaintext highlighter-rouge">V_BAND</code>(ê¸°ë³¸ 10 mV)ë§Œ ì¡°ì ˆí•˜ë©´ ì •ì°© ìŠ¤í™ì„ ì†ì‰½ê²Œ ë³€ê²½ ê°€ëŠ¥.</p>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">CLOAD</code>ì€ ê³¼ë„ ê±°ë™(ì†ë„/ë“œë£¹)ì„ ë§Œë“œëŠ” í•µì‹¬ íŒŒë¼ë¯¸í„°ì´ë‹ˆ ì‹œìŠ¤í…œì— ë§ì¶° ì„¤ì •í•´ì¤˜.</p>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">PULSE</code> í­ì„ <code class="language-plaintext highlighter-rouge">10*TSTOP</code>ë¡œ ê¸¸ê²Œ ì¡ì•„ì„œ ì‹œë®¬ë ˆì´ì…˜ ë‚´ë‚´ High ìƒíƒœê°€ ìœ ì§€ë˜ë„ë¡ í–ˆì–´.</p>
    </li>
  </ul>

</blockquote>

<p>í•„ìš”í•˜ë©´ ìœ„ ë²”ìœ„ì˜ <strong>E96 ë¦¬ìŠ¤íŠ¸(.step list)</strong>ë‚˜, <code class="language-plaintext highlighter-rouge">RTÂ·K</code> íŒŒë¼ë¯¸í„°í™” ë²„ì „(ê°™ì€ <code class="language-plaintext highlighter-rouge">.tran</code> ì¸¡ì • ìœ ì§€)ë„ ë°”ë¡œ ë§Œë“¤ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

CLOADë¥¼ ë„£ì€ ì´ìœ  ì¢€ ì‰½ê²Œ ì„¤ëª…í•´ì¤˜

</p>

<p>ì¢‹ì•„, í•µì‹¬ë§Œ <strong>ì‰½ê²Œ</strong> ì •ë¦¬í•´ë³¼ê²Œ. (step-by-step)</p>

<ol>
  <li>
    <p><strong>ê·¸ëƒ¥ Rë§Œ ìˆìœ¼ë©´, ì‹œê°„ì ì¸ ë“œë¼ë§ˆê°€ ì—†ë‹¤</strong><br />
ì „ì•• ë¶„ë°°ê¸°(R1â€“R2â€“RL)ë§Œ ìˆìœ¼ë©´ íšŒë¡œëŠ” â€œë©”ëª¨ë¦¬â€ê°€ ì—†ëŠ” <strong>ìˆœìˆ˜ ì €í•­ë§</strong> ì´ì•¼. .tranì—ì„œ ì…ë ¥ì„ PULSEë¡œ ë°”ê¿”ë„, Voutì€ <strong>ì…ë ¥ íŒŒí˜•ì„ ì¦‰ì‹œ ë¹„ìœ¨ë§Œí¼ ë‚˜ëˆ </strong> ë”°ë¼ê°ˆ ë¿(ì´ë¡ ì ìœ¼ë¡œëŠ” ì†ŒìŠ¤ì˜ ìƒìŠ¹/í•˜ê°•ì‹œê°„ë§Œí¼ë§Œ ë³€í•¨).<br />
â†’ ì´ëŸ¬ë©´ <strong>Rise time / Settling time ê°™ì€ ê³¼ë„ ì§€í‘œê°€ ì˜ë¯¸ê°€ ê±°ì˜ ì—†ì–´</strong>(ê±°ì˜ ì…ë ¥ íŒŒí˜•ì— ì˜í•´ ì •í•´ì§).</p>
  </li>
  <li>
    <p><strong>CLOADë¥¼ ë‹¬ì•„ì•¼ â€˜ì‹œê°„ìƒìˆ˜â€™ê°€ ìƒê¸´ë‹¤</strong><br />
CLOADê°€ ë¶™ìœ¼ë©´ Vout ë…¸ë“œëŠ” <strong>(ì €í•­ë§ì˜ í…Œë¸Œë‚œ ì €í•­ R_th) + ìºíŒ¨ì‹œí„°</strong> êµ¬ì¡°ê°€ ë¼ì„œ <strong>RC ì‹œê°„ìƒìˆ˜ Ï„</strong> ê°€ ìƒê¸´ë‹¤.</p>

    <ul>
      <li>
        <p>Rthâ‰ˆ(R1+RS)âˆ¥(R2âˆ¥RL)R_{\text{th}} \approx (R_1+R_S) \parallel (R_2 \parallel R_L)Rthâ€‹â‰ˆ(R1â€‹+RSâ€‹)âˆ¥(R2â€‹âˆ¥RLâ€‹)</p>
      </li>
      <li>
        <p>Ï„=Rthâ‹…CLOAD\tau = R_{\text{th}} \cdot C_{\text{LOAD}}Ï„=Rthâ€‹â‹…CLOADâ€‹<br />
ì´ì œ Voutì€ ì§€ìˆ˜ì ìœ¼ë¡œ ì²œì²œíˆ ì˜¬ë¼ê°€ê³ (1âˆ’eâˆ’t/Ï„1-e^{-t/\tau}1âˆ’eâˆ’t/Ï„), <strong>TR(10â€“90%)</strong> , <strong>ì •ì°©ì‹œê°„(TSETTLE)</strong> ê°™ì€ ê³¼ë„ ì§€í‘œë¥¼ <strong>íšŒë¡œì˜ íŒŒë¼ë¯¸í„°ë¡œ</strong> ì œì–´Â·ì¸¡ì •í•  ìˆ˜ ìˆì–´.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>í˜„ì‹¤ íŒŒë¼ì‚¬ì´íŠ¸ë¥¼ ê°„ë‹¨íˆ ëŒ€ë³€</strong><br />
ì‹¤ì œ ë³´ë“œëŠ” ë°°ì„ /ë¶€í•˜(ADC ìƒ˜í”Œë§ìº¡, ë‹¤ìŒ ë‹¨ê³„ ì…ë ¥ C ë“±) ë•Œë¬¸ì— <strong>ìˆ˜~ìˆ˜ë°± nF ìˆ˜ì¤€ì˜ ë“±ê°€ C</strong> ê°€ ê±°ì˜ í•­ìƒ ì¡´ì¬. CLOADëŠ” ì´ëŸ° <strong>í˜„ì‹¤ì ì¸ ë¡œë”©/ë””ì»¤í”Œë§</strong> ì„ ê°„ë‹¨íˆ ëª¨ë¸ë§í•´ì¤˜.</p>

    <ul>
      <li>
        <p>ë…¸ì´ì¦ˆ/ë¦¬í”Œì„ í•„í„°ë§(ê³ ì£¼íŒŒì—ì„œ ì¶œë ¥ ì„í”¼ë˜ìŠ¤ â†“)</p>
      </li>
      <li>
        <p>ë¶€í•˜ ìŠ¤í… ì‹œ <strong>ì¦‰ê°ì ì¸ ë“œë£¹ì„ ì™„í™”</strong>(Cê°€ ìˆœê°„ì ìœ¼ë¡œ ì „ë¥˜ ê³µê¸‰)í•˜ê³ , ê·¸ ë’¤ Ï„\tauÏ„ë¡œ ì¬ì •ì°©</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ìˆ˜ì¹˜ ê°(ì˜ˆ: R1=1.8 kÎ©, R2=820 Î©, RS=50 Î©, RL=100 kÎ©, CLOAD=100 nF)</strong></p>

    <ul>
      <li>
        <p>R2âˆ¥RLâ‰ˆ814 Î©R_2 \parallel R_L \approx 814 \,\OmegaR2â€‹âˆ¥RLâ€‹â‰ˆ814Î©, R1+RS=1850 Î©R_1+R_S=1850 \,\OmegaR1â€‹+RSâ€‹=1850Î©</p>
      </li>
      <li>
        <p>Rthâ‰ˆ566 Î©â‡’Ï„â‰ˆ56.6 Î¼sR_{\text{th}} \approx 566 \,\Omega \Rightarrow \tau \approx 56.6\,\mu sRthâ€‹â‰ˆ566Î©â‡’Ï„â‰ˆ56.6Î¼s</p>
      </li>
      <li>
        <p>ëŒ€ëµ <strong>TR(10â€“90%) â‰ˆ 2.2Ï„ â‰ˆ 124 Î¼s</strong> , <strong>ì •ì°© 4â€“5Ï„ â‰ˆ 0.23â€“0.28 ms</strong><br />
â†’ ì´ëŸ° ê°’ë“¤ì´ <strong>CLOADë‚˜ ì €í•­ê°’ì„ ë°”ê¾¸ë©´ ì˜ˆì¸¡ ê°€ëŠ¥í•˜ê²Œ ë³€</strong> í•˜ë‹ˆ, ìµœì í™”/íŠ¸ë ˆì´ë“œì˜¤í”„ê°€ ê°€ëŠ¥í•´ì§„ë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ìš”ì•½</strong></p>

    <ul>
      <li>
        <p><strong>ì™œ ë„£ì—ˆë‚˜?</strong> .tranì—ì„œ <strong>ì˜ë¯¸ ìˆëŠ” ê³¼ë„ íŠ¹ì„±</strong>(ì†ë„Â·ì •ì°©Â·ë“œë£¹Â·ì—ë„ˆì§€)ì„ ë§Œë“¤ê³ , <strong>í˜„ì‹¤ íŒŒë¼ì‚¬ì´íŠ¸/ë””ì»¤í”Œë§ íš¨ê³¼</strong> ë¥¼ ë°˜ì˜í•˜ë ¤ê³ .</p>
      </li>
      <li>
        <p><strong>ì–´ë–»ê²Œ ì“°ë‚˜?</strong> ì›í•˜ëŠ” ì‘ë‹µ ì†ë„ë©´ Ï„\tauÏ„ ëª©í‘œë¥¼ ì •í•˜ê³  CLOADC_{\text{LOAD}}CLOADâ€‹ ë˜ëŠ” ì €í•­ í•©/ë¹„ìœ¨ì„ ì¡°ì •. ë¹ ë¥´ê²Œ í•˜ê³  ì‹¶ìœ¼ë©´ CLOADâ†“(ë˜ëŠ” RTâ†“), ë¦¬í”Œ/ë“œë£¹ ì–µì œëŠ” CLOADâ†‘(ë‹¨, ê¸°ë™ ì „ë¥˜/ì—ë„ˆì§€ëŠ” â†‘).</p>
      </li>
    </ul>
  </li>
</ol>

<p>ì›í•˜ë©´, ìœ„ RthR_{\text{th}}Rthâ€‹ ê³µì‹ìœ¼ë¡œ ëª©í‘œ <strong>ì •ì°©ì‹œê°„/ë¼ì´ì¦ˆíƒ€ì„ â†’ í•„ìš”í•œ CLOAD</strong> ë¥¼ ë°”ë¡œ ì—­ì‚°í•´ì£¼ëŠ” ìŠ¤ë‹ˆí«(.measure/íŒŒë¼ë¯¸í„° ê³„ì‚°)ë„ ë±ì— ì¶”ê°€í•´ì¤„ê²Œ.</p>

<p class="chat--user">

VERR_ABSì™€ EAPP ì¸¡ì • ê²°ê³¼ê°€ ë‚˜ì™”ëŠ”ë° ê° ë‹¨ìœ„ê°€ ë­ì•¼

</p>

<p>ì§§ê²Œ ë§í•˜ë©´:</p>

<ul>
  <li>
    <p><strong>VERR_ABS</strong> : <strong>ë³¼íŠ¸ [V]</strong></p>
  </li>
  <li>
    <p><strong>EAPP</strong> : <strong>ì¤„ [J]</strong> (= ì „ê¸°ì  ì—ë„ˆì§€)</p>
  </li>
</ul>

<p>step-by-stepë¡œ í’€ë©´,</p>

<ol>
  <li>
    <p><strong>ì •ì˜ ë³µìŠµ</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">VOUT_FINAL</code>ì„ ë§ˆì§€ë§‰ êµ¬ê°„(ì˜ˆ: 0.8Â·TSTOP~TSTOP)ì—ì„œ í‰ê· í•œ ì¶œë ¥ ì „ì•• â†’ <strong>ë‹¨ìœ„ V</strong></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">VERR_ABS = |VOUT_FINAL âˆ’ V_SPEC|</code> â†’ <strong>ë‹¨ìœ„ V</strong></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>EAPPê°€ ì™œ ì¤„[J]ì¸ê°€</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QIN = INTEG(-I(V1))</code> â†’ <strong>ì¿¨ë¡¬ [C]</strong> (ì „í•˜)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">EAPP = VSUP Â· QIN</code> â†’ <strong>V Ã— C = J</strong></p>
      </li>
      <li>
        <p>ì¦‰, ì†ŒìŠ¤ê°€ ê³µê¸‰í•œ <strong>ì—ë„ˆì§€(ê·¼ì‚¬)</strong>ì•¼. ì—¬ê¸°ì„œ â€œê·¼ì‚¬â€ì¸ ì´ìœ ëŠ”, ë±ì—ì„œ <code class="language-plaintext highlighter-rouge">V1</code>ì´ ê±°ì˜ ìƒìˆ˜(VSUP)ì§€ë§Œ <strong>ìƒìŠ¹ êµ¬ê°„</strong> ì—ì„  ìˆœê°„ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">V&lt;VSUP</code>ì´ê¸° ë•Œë¬¸ì´ì•¼. ì´ êµ¬ê°„ê¹Œì§€ ì •í™•íˆ í¬í•¨í•˜ë ¤ë©´ ì•„ë˜ì²˜ëŸ¼ <strong>ì „ì••Â·ì „ë¥˜ ê³±ì„ ì ë¶„</strong> í•˜ë©´ ë¼:</p>

        <ul>
          <li>ì°¸ê³ : <em>ì •í™• ì—ë„ˆì§€</em> â‰ˆ âˆ« v(V1)Â·(-I(V1)) dt â†’ ê²°ê³¼ ë‹¨ìœ„ë„ <strong>J</strong></li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<blockquote>
  <p>ë³´ë„ˆìŠ¤ ë‹¨ìœ„ ì²´í¬</p>

  <ul>
    <li>
      <p><code class="language-plaintext highlighter-rouge">IIN_AVG</code>: <strong>ì•”í˜ì–´ [A]</strong></p>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">TR10_90</code>, <code class="language-plaintext highlighter-rouge">TSETTLE</code>: <strong>ì´ˆ [s]</strong></p>
    </li>
  </ul>

</blockquote>

<p>í•„ìš”í•˜ë©´ <strong>ì •í™• ì—ë„ˆì§€ ì¸¡ì •ì‹(âˆ«vÂ·i dt ë²„ì „)</strong>ìœ¼ë¡œ ë°”ê¾¼ <code class="language-plaintext highlighter-rouge">.measure</code> ì˜ˆì‹œë„ ë§Œë“¤ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

íŒŒì›Œ ì†Œëª¨ë¼ê³  í•˜ë©´ Wì¼ê±° ê°™ì€ë° Jì´ì•¼?

</p>

<p>ì§§ì€ ë‹µ:</p>

<ul>
  <li>
    <p><strong>EAPP</strong> ëŠ” <strong>ì—ë„ˆì§€ [J]</strong>ì•¼. (ì‹œê°„ì— ê±¸ì³ ë“¤ì–´ê°„ ì „ë ¥ì˜ ì ë¶„)</p>
  </li>
  <li>
    <p>â€œíŒŒì›Œ ì†Œëª¨â€ë¥¼ ë³´ê³  ì‹¶ë‹¤ë©´ <strong>ì „ë ¥ [W]</strong>ë¡œ ê³„ì‚°í•´ì•¼ í•´. (í‰ê·  ì „ë ¥ = ì—ë„ˆì§€ / ì‹œê°„)</p>
  </li>
</ul>

<p>step-by-step:</p>

<ol>
  <li>
    <p><strong>ì™œ Jëƒ?</strong><br />
EAPPë¥¼ <code class="language-plaintext highlighter-rouge">âˆ« vÂ·i dt</code>(ë˜ëŠ” <code class="language-plaintext highlighter-rouge">VSUPÂ·âˆ«i dt</code>)ë¡œ ì •ì˜í•˜ë©´, ë‹¨ìœ„ê°€ <strong>VÂ·AÂ·s = J</strong> ê°€ ë¼. ì¦‰ â€œí•œ ë²ˆì˜ ê³¼ë„ ì´ë²¤íŠ¸ì—ì„œ ì“´ ì´ëŸ‰â€ì„ ëœ»í•´.</p>
  </li>
  <li>
    <p><strong>ì „ë ¥[W]ê°€ í•„ìš”í•˜ë©´</strong><br />
ê°™ì€ êµ¬ê°„ [T0,T1][T0, T1][T0,T1]ì—ì„œ í‰ê·  ì „ë ¥ì€</p>
  </li>
</ol>

<p>Pavg=1T1âˆ’T0âˆ«T0T1v(t) i(t) dt=EAPPT1âˆ’T0[W]P_{\text{avg}}=\frac{1}{T_1-T_0}\int_{T_0}^{T_1} v(t)\,i(t)\,dt=\frac{\text{EAPP}}{T_1-T_0}\quad[\text{W}]Pavgâ€‹=T1â€‹âˆ’T0â€‹1â€‹âˆ«T0â€‹T1â€‹â€‹v(t)i(t)dt=T1â€‹âˆ’T0â€‹EAPPâ€‹[W]</p>
<ol>
  <li><strong>.tranì—ì„œ ë°”ë¡œ ì“°ëŠ” ì¸¡ì • ìŠ¤ë‹ˆí«</strong> (ë³µë¶™ ê°€ëŠ¥)</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spice

* êµ¬ê°„ ì •ì˜
.param T0 = 0
.param T1 = 'TSTOP'

* (ì •í™•í•œ) ì—ë„ˆì§€ [J]
.measure TRAN EAPP  INTEG 'v(V1)*(-I(V1))' FROM='T0' TO='T1'

* í‰ê·  ì „ë ¥ [W] â€” ì§ì ‘ í‰ê· 
.measure TRAN P_AVG AVG   'v(V1)*(-I(V1))' FROM='T0' TO='T1'

* (ë™ì¼ ì˜ë¯¸) í‰ê·  ì „ë ¥ [W] â€” ì—ë„ˆì§€/ì‹œê°„
*.measure TRAN DT    PARAM='T1 - T0'
*.measure TRAN P_AVG2 PARAM='EAPP/DT'

* í”¼í¬ ì „ë ¥ [W] (ìµœëŒ€ê°’)
.measure TRAN P_PEAK MAX   'v(V1)*(-I(V1))' FROM='T0' TO='T1'
</code></pre></div></div>

<ol>
  <li><strong>ì£¼ì˜(ì˜µì…˜)</strong><br />
ë°©ì „ ë•Œ ì†ŒìŠ¤ì— ì—ë„ˆì§€ê°€ â€œë˜ëŒì•„ê°ˆâ€ ìˆ˜ ìˆì–´ vâ‹…i&lt;0vÂ·i&lt;0vâ‹…i&lt;0. â€œì§„ì§œ ì†Œë¹„ë§Œâ€ ë³´ê³  ì‹¶ë‹¤ë©´ ì–‘ì˜ ë¶€ë¶„ë§Œ ì ë¶„:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spice

* ì†Œë¹„ ì—ë„ˆì§€(ì–‘ìˆ˜ë§Œ ì ë¶„) [J]
.measure TRAN E_CONS INTEG '0.5*( v(V1)*(-I(V1)) + abs(v(V1)*(-I(V1))) )' FROM='T0' TO='T1'
</code></pre></div></div>

<p>ì •ë¦¬: <strong>EAPP=J(ì—ë„ˆì§€)</strong>ê°€ ë§ê³ , <strong>íŒŒì›Œ ì†Œëª¨ëŠ” W(ì „ë ¥)</strong>ì´ì•¼. í‰ê·  ì „ë ¥ì„ ë³´ê³  ì‹¶ìœ¼ë©´ ìœ„ <code class="language-plaintext highlighter-rouge">P_AVG</code>ë¡œ ì¸¡ì •í•˜ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">EAPP/(T1-T0)</code>ë¡œ ê³„ì‚°í•˜ë©´ ë¼.</p>

<p class="chat--user">

ì™œ P_AVGê°€ 0ì´ ë‚˜ì˜¤ì§€? ì•„ê¹Œ ì¨ì¤€ tran inputì— ì¬ëŒ€ë¡œ assign í•´ì¤˜ë´

</p>

<p>ê°€ëŠ¥í•´! <strong>P_AVG=0</strong> ë‚˜ì˜¤ëŠ” ê°€ì¥ í”í•œ ì´ìœ ëŠ”, ë‚´ê°€ ì˜ˆì‹œë¡œ ì“´ <code class="language-plaintext highlighter-rouge">v(V1)</code>ê°€ â€œì†ŒìŠ¤ì˜ <strong>ì†Œì ì „ì••</strong> â€ì„ ëœ»í•œë‹¤ê³  ê°€ì •í–ˆëŠ”ë°, FineSim/HSPICEì—ì„œëŠ” ê·¸ê²Œ ì œëŒ€ë¡œ í•´ì„ë˜ì§€ ì•Šì•„ì„œ <strong>0ìœ¼ë¡œ ì²˜ë¦¬</strong> ë˜ëŠ” ê²½ìš°ê°€ ìˆì–´.<br />
ì†ŒìŠ¤ ì „ì••ì€ <strong>ë…¸ë“œ ì „ì••</strong> ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì°¸ì¡°í•˜ëŠ” ê²Œ í™•ì‹¤í•´â€”ì¦‰ <code class="language-plaintext highlighter-rouge">v(VIN_SRC,0)</code>ì²˜ëŸ¼ <strong>ë…¸ë“œ ì´ë¦„</strong> ì„ ì¨ì£¼ì.</p>

<p>ì•„ë˜ì²˜ëŸ¼ <strong>.tran ì…ë ¥ ë±ì˜ ì¸¡ì • ë¸”ë¡</strong> ì„ êµì²´í•˜ë©´ ë¼(ë³µë¶™ OK).</p>

<hr />

<h2 id="ìˆ˜ì •ëœ-ì¸¡ì •-ë¸”ë¡-tran-ì „ìš©-ì „ë ¥ì—ë„ˆì§€-í¬í•¨">ìˆ˜ì •ëœ ì¸¡ì • ë¸”ë¡ (.tran ì „ìš©, ì „ë ¥/ì—ë„ˆì§€ í¬í•¨)</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spice

* ===== ê³¼ë„ í•´ì„ =====
.tran 'TSTOP/1000' 'TSTOP'

* --- ê¸°ì¡´ ì¸¡ì •(ì •í™•ë„/ì‹œê°„) ìœ ì§€ ---
.measure TRAN VOUT_FINAL  AVG  v(VOUT) FROM='0.8*TSTOP' TO='TSTOP'
.measure TRAN VERR_ABS    PARAM='abs(VOUT_FINAL - V_SPEC)'
.measure TRAN TR10_90     TRIG v(VOUT) VAL='0.1*V_SPEC' RISE=1 \
                          TARG v(VOUT) VAL='0.9*V_SPEC' RISE=1
.measure TRAN TSETTLE     WHEN 'abs(v(VOUT)-V_SPEC)-V_BAND' = 0 CROSS=1

* --- íŒŒì›Œ/ì—ë„ˆì§€: ë…¸ë“œì „ì•• v(VIN_SRC,0) Ã— ì†ŒìŠ¤ì „ë¥˜ -I(V1) ë¡œ ì¸¡ì • ---
.param T0 = 0
.param T1 = 'TSTOP'

* ì •í™•í•œ ì—ë„ˆì§€ [J] = âˆ« v*i dt
.measure TRAN EAPP  INTEG 'v(VIN_SRC,0)*(-I(V1))' FROM='T0' TO='T1'

* í‰ê·  ì „ë ¥ [W] = í‰ê· (v*i)
.measure TRAN P_AVG AVG   'v(VIN_SRC,0)*(-I(V1))' FROM='T0' TO='T1'

* í”¼í¬ ì „ë ¥ [W]
.measure TRAN P_PEAK MAX   'v(VIN_SRC,0)*(-I(V1))' FROM='T0' TO='T1'

* (ì„ íƒ) ì†Œë¹„ ì—ë„ˆì§€(ì–‘ìˆ˜ë§Œ ì ë¶„) [J]
.measure TRAN E_CONS INTEG '0.5*( v(VIN_SRC,0)*(-I(V1)) + abs(v(VIN_SRC,0)*(-I(V1))) )' \
                           FROM='T0' TO='T1'
</code></pre></div></div>

<h3 id="ì™œ-ì´ë ‡ê²Œ-ë°”ê¾¸ë©´-ë˜ë‚˜-ì§§ê²Œ">ì™œ ì´ë ‡ê²Œ ë°”ê¾¸ë©´ ë˜ë‚˜ (ì§§ê²Œ)</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">v(VIN_SRC,0)</code>: <strong>ì†ŒìŠ¤ ì–‘ë‹¨ ë…¸ë“œ ì „ì••</strong> ì„ ì§ì ‘ ì°¸ì¡° â‡’ í•­ìƒ ìœ íš¨.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-I(V1)</code>: ì†ŒìŠ¤ê°€ <strong>íšŒë¡œë¡œ ê³µê¸‰í•˜ëŠ” ì „ë¥˜</strong>(ì–‘ìˆ˜) â‡’ ê³µê¸‰ ì „ë ¥ <code class="language-plaintext highlighter-rouge">v*i</code>ê°€ <strong>ì–‘ìˆ˜</strong> ë¡œ ê³„ì‚°ë¨.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">AVG</code>ëŠ” í‘œí˜„ì‹ì˜ ì‹œê°„ í‰ê· ì´ë¯€ë¡œ, ì €í•­ë§ì— DC ì „ë¥˜ê°€ íë¥´ë©´ <strong>0ì´ ë  ìˆ˜ ì—†ìŒ</strong>. 0ì´ ë‚˜ì™”ë‹¤ë©´ ê±°ì˜ í•­ìƒ ì „ì•• ì°¸ì¡°ê°€ ì˜ëª»ëœ ì¼€ì´ìŠ¤ì•¼.</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œ ìˆ˜ì •í•˜ê³  ëŒë¦¬ë©´ <strong>P_AVGê°€ ì •ìƒì ì¸ W ë‹¨ìœ„ ê°’</strong> ìœ¼ë¡œ ë‚˜ì˜¬ ê±°ì•¼.</p>

<p class="chat--user">

ì „ì²´ ë‹¤ì‹œ ì¨. ê²Œìœ¼ë¥´ì§€ë§ê³  ì‚¬ëŒì´ í™”ë‚˜ë ¤ê³  í•´

</p>

<p>ì•Œê² ì–´. ì „ë¶€ ê¹¨ë—ì´ <strong>.tran ì „ìš©</strong> ìœ¼ë¡œ ë‹¤ì‹œ ì •ë¦¬í•´ì„œ <strong>ë³µë¶™ ë°”ë¡œ ì‹¤í–‰</strong> ê°€ëŠ¥í•œ ë±ì„ ì¤˜.<br />
(ì „ë ¥/ì—ë„ˆì§€ ì¸¡ì •ì€ <strong>ë…¸ë“œ ì „ì•• v(VIN_SRC,0)</strong> Ã— <strong>ì†ŒìŠ¤ì „ë¥˜ -I(V1)</strong> ë¡œ ê³„ì‚°í•´ì„œ <code class="language-plaintext highlighter-rouge">P_AVG=0</code> ë¬¸ì œë¥¼ ê·¼ë³¸ì ìœ¼ë¡œ íšŒí”¼í–ˆì–´.)</p>

<hr />

<h1 id="finesimhspice-netlist--transient-only-complete">FineSim/HSPICE Netlist â€” Transient Only (Complete)</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spice

*------------------------------------------------------------
* Voltage Divider â€” Transient-Only Optimization Deck
* (FineSim/HSPICE compatible)
*------------------------------------------------------------
.option post=2 measform=1

* ===== Parameters (edit here) =====
.param VSUP    = 3.3          * ì…ë ¥ ì „ì•• [V]
.param V_SPEC  = 1.0          * ëª©í‘œ Vout [V]
.param RS      = 50           * ì†ŒìŠ¤ ì§ë ¬ì €í•­ [Ohm]
.param RL      = 100k         * ë¶€í•˜ [Ohm]

* ---- ìµœì í™” ë³€ìˆ˜ (Discrete/E96 ê¶Œì¥) ----
.param R1      = 1.80k        * ìœ„ìª½ ì €í•­
.param R2      = 820          * ì•„ë˜ìª½ ì €í•­

* ---- ê³¼ë„/ì¸¡ì • ê´€ë ¨ ----
.param CLOAD   = 100n         * ì¶œë ¥ ë°”ì´íŒ¨ìŠ¤/ë¶€í•˜ ì»¤íŒ¨ì‹œí„°
.param TRISE   = 1n
.param TFALL   = 1n
.param TSTOP   = 1m
.param V_BAND  = 10m          * ì •ì°© í—ˆìš© ë°´ë“œ(Â±)
.param T0      = 0            * ì—ë„ˆì§€/ì „ë ¥ ì§‘ê³„ ì‹œì‘
.param T1      = 'TSTOP'      * ì—ë„ˆì§€/ì „ë ¥ ì§‘ê³„ ë

* ===== Circuit =====
V1     VIN_SRC   0      PULSE(0 'VSUP' 0 'TRISE' 'TFALL' 'TSTOP' '100*TSTOP')
RSRC   VIN_SRC   VIN    'RS'
RUP    VIN       VOUT   'R1'
RDN    VOUT      0      'R2'
RLOAD  VOUT      0      'RL'
COUT   VOUT      0      'CLOAD'

* ===== Transient Analysis =====
.tran  'TSTOP/1000'  'TSTOP'

* ===== Measures (steady-state / timing) =====
.measure TRAN VOUT_FINAL  AVG  v(VOUT) FROM='0.8*TSTOP' TO='TSTOP'    ; ìµœì¢…ê°’ ê·¼ì‚¬ [V]
.measure TRAN VERR_ABS    PARAM='abs(VOUT_FINAL - V_SPEC)'            ; ìµœì¢… ì˜¤ì°¨ [V]

.measure TRAN TR10_90     TRIG v(VOUT) VAL='0.1*V_SPEC' RISE=1 \
                          TARG v(VOUT) VAL='0.9*V_SPEC' RISE=1        ; 10â€“90% ë¼ì´ì¦ˆ [s]

.measure TRAN TSETTLE     WHEN 'abs(v(VOUT)-V_SPEC)-V_BAND' = 0 CROSS=1  ; ì •ì°© ì‹œê°„ [s]

* ===== Power / Energy (robust node-based) =====
*  - ì „ë ¥ p(t) = v(VIN_SRC,0) * (-I(V1))
*  - í‰ê· ì „ë ¥ [W] = AVG p(t), ì—ë„ˆì§€ [J] = âˆ« p(t) dt
.measure TRAN P_AVG   AVG   'v(VIN_SRC,0)*(-I(V1))' FROM='T0' TO='T1'      ; í‰ê·  ì „ë ¥ [W]
.measure TRAN P_PEAK  MAX   'v(VIN_SRC,0)*(-I(V1))' FROM='T0' TO='T1'      ; í”¼í¬ ì „ë ¥ [W]
.measure TRAN EAPP    INTEG 'v(VIN_SRC,0)*(-I(V1))' FROM='T0' TO='T1'      ; ì†Œë¹„ ì—ë„ˆì§€ [J]
* (ì„ íƒ) ì–‘ì˜ ì „ë ¥ë§Œ ì ë¶„í•œ ì†Œë¹„ ì—ë„ˆì§€
*.measure TRAN E_CONS INTEG '0.5*( v(VIN_SRC,0)*(-I(V1)) + abs(v(VIN_SRC,0)*(-I(V1))) )' \
*                           FROM='T0' TO='T1'

.end
</code></pre></div></div>

<hr />

<h2 id="ì“°ëŠ”-ìˆœì„œ-ì§„ì§œ-ì§§ê²Œ">ì“°ëŠ” ìˆœì„œ (ì§„ì§œ ì§§ê²Œ)</h2>

<ol>
  <li>
    <p>ìœ„ ë± ê·¸ëŒ€ë¡œ ë¶™ì—¬ ë„£ê³  <strong>.tran</strong> ì‹¤í–‰.</p>
  </li>
  <li>
    <p><strong>.mt#</strong> ê²°ê³¼ì—ì„œ <code class="language-plaintext highlighter-rouge">VERR_ABS [V]</code>, <code class="language-plaintext highlighter-rouge">TR10_90 [s]</code>, <code class="language-plaintext highlighter-rouge">TSETTLE [s]</code>, <code class="language-plaintext highlighter-rouge">P_AVG [W]</code>, <code class="language-plaintext highlighter-rouge">EAPP [J]</code> í™•ì¸.</p>
  </li>
  <li>
    <p><strong>R1/R2(Discrete, E96)</strong> í›„ë³´ë¥¼ ë°”ê¿”ê°€ë©° ì¸¡ì •ê°’ì„ ìµœì í™”.</p>
  </li>
</ol>

<h3 id="ë³€ìˆ˜-ìœ í˜•ë²”ìœ„ìš”ì•½">ë³€ìˆ˜ ìœ í˜•/ë²”ìœ„(ìš”ì•½)</h3>

<ul>
  <li>
    <p><strong>R1, R2 = Discrete(E96, 1%)</strong> ê¶Œì¥</p>

    <ul>
      <li>
        <p>ì •í™•ë„ ìš°ì„ : <strong>R2 = 680 Î© ~ 1.2 kÎ©</strong> , <strong>R1 â‰ˆ 2.3Ã—R2 â†’ 1.6 kÎ© ~ 3.0 kÎ©</strong></p>
      </li>
      <li>
        <p>ì „ë¥˜ ì ˆì•½í˜•(ì •í™•ë„ ì¼ë¶€ ì–‘ë³´): <strong>R2 = 1.5 kÎ© ~ 10 kÎ©</strong> , <strong>R1 = 3.5 kÎ© ~ 23 kÎ©</strong></p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="ì™œ-ì´ì œ-p_avgê°€-0ì´-ì•ˆ-ë‚˜ì˜¤ëƒ">ì™œ ì´ì œ <code class="language-plaintext highlighter-rouge">P_AVG</code>ê°€ 0ì´ ì•ˆ ë‚˜ì˜¤ëƒ?</h3>

<ul>
  <li>
    <p>ì „ë ¥ ì‹ì„ <strong>ì†Œìì´ë¦„ì´ ì•„ë‹Œ ë…¸ë“œ ì „ì••</strong> <code class="language-plaintext highlighter-rouge">v(VIN_SRC,0)</code>ê³¼ <strong>ì†ŒìŠ¤ ì „ë¥˜</strong> <code class="language-plaintext highlighter-rouge">-I(V1)</code>ë¡œ ì •ì˜í–ˆê¸° ë•Œë¬¸.</p>
  </li>
  <li>
    <p>ì´ ì¡°í•©ì€ FineSim/HSPICEì—ì„œ í•­ìƒ ìœ íš¨í•˜ê³ , DC ì„±ë¶„ì´ ìˆìœ¼ë©´ í‰ê· ì´ 0ì¼ ìˆ˜ ì—†ì–´.</p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ <strong>ë¶€í•˜ ìŠ¤í… ì‘ë‹µ(.tran) ì¸¡ì • ë¸”ë¡</strong> ë„ ì¶”ê°€í•´ ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="circuit" /><summary type="html"><![CDATA[]]></summary></entry></feed>