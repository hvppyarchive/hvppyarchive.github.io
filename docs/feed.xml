<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://hvppyarchive.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://hvppyarchive.github.io/" rel="alternate" type="text/html" /><updated>2025-11-13T12:24:10+09:00</updated><id>https://hvppyarchive.github.io/feed.xml</id><title type="html">ARCHIVE</title><subtitle>An amazing archive.</subtitle><author><name>hvppyarchive</name></author><entry><title type="html"></title><link href="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/" rel="alternate" type="text/html" title="" /><published>2025-11-13T12:24:10+09:00</published><updated>2025-11-13T12:24:10+09:00</updated><id>https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str</id><content type="html" xml:base="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/"><![CDATA[<p class="chat--user">

Python에서 <code class="language-plaintext highlighter-rouge">__repr__</code> 함수와 <code class="language-plaintext highlighter-rouge">__str__</code> 함수의 차이점

</p>

<p>Python에서 <code class="language-plaintext highlighter-rouge">__repr__</code> 과 <code class="language-plaintext highlighter-rouge">__str__</code> 의 차이점은 <strong>객체를 문자열로 표현하는 목적</strong> 에서 달라집니다. 차이를 단계적으로 정리해드릴게요.</p>

<hr />

<h2 id="1-__repr__-의-목적">1. <code class="language-plaintext highlighter-rouge">__repr__</code> 의 목적</h2>

<ul>
  <li>
    <p><strong>개발자 중심</strong> : 객체를 "개발자"가 보고 이해할 수 있도록 표현합니다.</p>
  </li>
  <li>
    <p><strong>재현 가능(reproducible)</strong> : 가능한 한 객체를 다시 만들 수 있는 코드 형태로 보여주는 것이 목표입니다.</p>
  </li>
  <li>
    <p>보통 <code class="language-plaintext highlighter-rouge">eval(repr(obj)) == obj</code> 가 성립하는 형태를 지향합니다 (꼭 항상 그런 건 아니지만 권장).</p>
  </li>
  <li>
    <p>디버깅할 때 주로 사용됩니다.</p>
  </li>
</ul>

<p>예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Person(name=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">'</span><span class="s">, age=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># Person(name='Alice', age=30)
</span></code></pre></div></div>

<hr />

<h2 id="2-__str__-의-목적">2. <code class="language-plaintext highlighter-rouge">__str__</code> 의 목적</h2>

<ul>
  <li>
    <p><strong>사용자 중심</strong> : 객체를 "사용자"가 보기 좋은 문자열로 표현합니다.</p>
  </li>
  <li>
    <p>읽기 쉽고 깔끔하게 출력하는 데 초점을 둡니다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">print(obj)</code> 를 호출했을 때 보여지는 값이 <code class="language-plaintext highlighter-rouge">__str__</code> 입니다.</p>
  </li>
</ul>

<p>예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s"> years old)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Alice (30 years old)
</span></code></pre></div></div>

<hr />

<h2 id="3-__repr__-vs-__str__-비교">3. <code class="language-plaintext highlighter-rouge">__repr__</code> vs <code class="language-plaintext highlighter-rouge">__str__</code> 비교</h2>

<table>
  <thead>
    <tr>
      <th>특징</th>
      <th><code class="language-plaintext highlighter-rouge">__repr__</code></th>
      <th><code class="language-plaintext highlighter-rouge">__str__</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>목적</td>
      <td>개발자용, 디버깅</td>
      <td>사용자용, 가독성</td>
    </tr>
    <tr>
      <td>출력 대상</td>
      <td><code class="language-plaintext highlighter-rouge">repr(obj)</code>, 대화형 쉘에서 기본</td>
      <td><code class="language-plaintext highlighter-rouge">str(obj)</code>, <code class="language-plaintext highlighter-rouge">print(obj)</code></td>
    </tr>
    <tr>
      <td>형식</td>
      <td>객체 재현 가능하거나 상세</td>
      <td>읽기 쉬운 설명 위주</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="4-구현-시-주의사항">4. 구현 시 주의사항</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code> 가 없으면 <code class="language-plaintext highlighter-rouge">__repr__</code> 가 대신 사용</strong>됩니다.</p>
  </li>
  <li>
    <p>따라서 최소한 <code class="language-plaintext highlighter-rouge">__repr__</code> 은 정의해 두는 것이 좋습니다.</p>
  </li>
</ul>

<hr />

<p>👉 정리하면,</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__repr__</code></strong> : “개발자가 디버깅할 때” 객체의 정확한 표현.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code></strong> : “사용자가 출력물을 볼 때” 보기 좋게 표현.</p>
  </li>
</ul>

<hr />

<p>원하시면 <code class="language-plaintext highlighter-rouge">__repr__</code> 와 <code class="language-plaintext highlighter-rouge">__str__</code> 를 동시에 구현했을 때 <code class="language-plaintext highlighter-rouge">print(obj)</code> 와 <code class="language-plaintext highlighter-rouge">obj</code> (쉘 출력) 의 차이를 직접 실행해 보여드릴 수도 있는데, 예제 코드 시연을 원하시나요?</p>]]></content><author><name>hvppyarchive</name></author></entry><entry><title type="html">QFileDialog 설명</title><link href="https://hvppyarchive.github.io/qt/qfiledialog-study/" rel="alternate" type="text/html" title="QFileDialog 설명" /><published>2025-11-13T12:24:00+09:00</published><updated>2025-11-13T12:24:00+09:00</updated><id>https://hvppyarchive.github.io/qt/qfiledialog-study</id><content type="html" xml:base="https://hvppyarchive.github.io/qt/qfiledialog-study/"><![CDATA[<p class="chat--user">

QFileDialog 알아?

</p>

<p>응, 알아! Qt에서 파일 열기/저장할 때 나오는 그 “파일 선택 창” 만드는 클래스야.</p>

<p>조금 정리해보면:</p>

<ol>
  <li>
    <p>어디에 속해 있냐</p>

    <ul>
      <li>
        <p>Qt Widgets 쪽 클래스고 이름은 <code class="language-plaintext highlighter-rouge">QFileDialog</code>.</p>
      </li>
      <li>
        <p>C++에선 <code class="language-plaintext highlighter-rouge">#include &lt;QFileDialog&gt;</code></p>
      </li>
      <li>
        <p>PyQt/PySide에선 <code class="language-plaintext highlighter-rouge">from PyQt5.QtWidgets import QFileDialog</code> 같은 식으로 가져와.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>주 역할</p>

    <ul>
      <li>
        <p>파일 열기: 사용자에게 파일 하나/여러 개 선택하게 해서 경로를 돌려줌</p>
      </li>
      <li>
        <p>파일 저장: 저장할 파일 이름/경로 선택</p>
      </li>
      <li>
        <p>폴더 선택: 디렉터리만 고르도록 할 수도 있음</p>
      </li>
    </ul>
  </li>
  <li>
    <p>자주 쓰는 정적 메서드들 (PyQt 스타일로 예시 줄게)</p>
  </li>
</ol>

<p>파일 하나 열기:
     ```python
     fname, _ = QFileDialog.getOpenFileName(
         parent,
         "파일 열기",
         "",
         "이미지 파일 (<em>.png *.jpg *.bmp);;모든 파일 (</em>.*)"
     )</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> if fname:
     print("선택된 파일:", fname)
 ```
</code></pre></div></div>

<p>파일 여러 개 열기:
     ```python
     fnames, _ = QFileDialog.getOpenFileNames(
         parent,
         "여러 파일 열기",
         "",
         "텍스트 파일 (<em>.txt);;모든 파일 (</em>.*)"
     )</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> for f in fnames:
     print(f)
 ```
</code></pre></div></div>

<p>파일 저장:
     ```python
     save_name, _ = QFileDialog.getSaveFileName(
         parent,
         "파일 저장",
         "untitled.txt",
         "텍스트 파일 (<em>.txt);;모든 파일 (</em>.*)"
     )</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> if save_name:
     print("저장할 경로:", save_name)
 ```
</code></pre></div></div>

<p>폴더 선택:
     ```python
     dir_path = QFileDialog.getExistingDirectory(
         parent,
         "폴더 선택",
         ""
     )</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> if dir_path:
     print("선택된 폴더:", dir_path)
 ```
</code></pre></div></div>

<ol>
  <li>
    <p>필터(파일 형식) 문법</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">"설명 (*.확장자1 *.확장자2);;다른 설명 (*.다른확장자)"</code></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">;;</code> 로 여러 그룹을 나누는 구조야.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>모달/비모달</p>

    <ul>
      <li>
        <p>위에처럼 <code class="language-plaintext highlighter-rouge">getOpenFileName</code> 같은 정적 메서드는 모달 다이얼로그를 띄우고, 사용자가 닫으면 바로 결과를 돌려줘.</p>
      </li>
      <li>
        <p>직접 <code class="language-plaintext highlighter-rouge">dlg = QFileDialog(parent)</code> 해서 만들어놓고 옵션 세팅하고, <code class="language-plaintext highlighter-rouge">dlg.exec()</code>나 <code class="language-plaintext highlighter-rouge">dlg.open()</code>으로 쓸 수도 있어.</p>
      </li>
    </ul>
  </li>
</ol>

<p>원하면 C++ 버전 코드로도 예시 같이 짜 줄 수 있어.</p>

<p class="chat--user">

소스코드도 알아?

</p>

<p>“소스코드”가 QFileDialog 내부 구현 얘기면 → Qt 소스는 공개돼 있지만, 여기서 그대로 긁어다 장문으로 보여줄 수는 없어.<br />
대신 “QFileDialog를 어떻게 쓰는 예제 소스코드”라면 마음껏 보여줄 수 있다. 그게 보통 사람들이 말하는 소스코드이기도 하고.</p>

<p>아래는 사용 예제들!</p>

<hr />

<h2 id="1-c--qt-widgets-예제">1. C++ / Qt Widgets 예제</h2>

<p>버튼 하나 있는 창에서 버튼 누르면 <code class="language-plaintext highlighter-rouge">QFileDialog</code> 띄워서 파일 하나 고르고, 선택된 파일 경로를 라벨에 표시하는 예제:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;QApplication&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;QWidget&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;QPushButton&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;QLabel&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;QVBoxLayout&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;QFileDialog&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">MainWindow</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QWidget</span>
<span class="p">{</span>
    <span class="n">Q_OBJECT</span>

<span class="nl">public:</span>
    <span class="n">MainWindow</span><span class="p">(</span><span class="n">QWidget</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">QWidget</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="o">*</span><span class="n">layout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

        <span class="n">button</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s">"파일 선택"</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="n">label</span>  <span class="o">=</span> <span class="k">new</span> <span class="n">QLabel</span><span class="p">(</span><span class="s">"아직 파일을 선택하지 않았습니다."</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="n">layout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">button</span><span class="p">);</span>
        <span class="n">layout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">);</span>

        <span class="n">connect</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QPushButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">onSelectFile</span><span class="p">);</span>
    <span class="p">}</span>

<span class="k">private</span> <span class="n">slots</span><span class="o">:</span>
    <span class="kt">void</span> <span class="nf">onSelectFile</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">QString</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">::</span><span class="n">getOpenFileName</span><span class="p">(</span>
            <span class="k">this</span><span class="p">,</span>
            <span class="s">"파일 열기"</span><span class="p">,</span>
            <span class="s">""</span><span class="p">,</span>
            <span class="s">"이미지 파일 (*.png *.jpg *.bmp);;모든 파일 (*.*)"</span>
        <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fileName</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">label</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="s">"선택한 파일: "</span> <span class="o">+</span> <span class="n">fileName</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
    <span class="n">QPushButton</span> <span class="o">*</span><span class="n">button</span><span class="p">;</span>
    <span class="n">QLabel</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">QApplication</span> <span class="n">app</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

    <span class="n">MainWindow</span> <span class="n">w</span><span class="p">;</span>
    <span class="n">w</span><span class="p">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s">"QFileDialog 예제"</span><span class="p">);</span>
    <span class="n">w</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>
    <span class="n">w</span><span class="p">.</span><span class="n">show</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">app</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#include</span> <span class="cpf">"main.moc"</span><span class="cp">
</span></code></pre></div></div>

<p>이 정도 구조면:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileDialog::getOpenFileName</code> 정적 메서드로 간단하게 파일 선택</p>
  </li>
  <li>
    <p>필터 문자열로 확장자 제한</p>
  </li>
  <li>
    <p>반환된 <code class="language-plaintext highlighter-rouge">QString</code>이 비어있지 않으면 라벨에 표시</p>
  </li>
</ul>

<p>딱 교과서적인 사용 패턴이야.</p>

<hr />

<h2 id="2-pyqt5--pyside6-예제-python">2. PyQt5 / PySide6 예제 (Python)</h2>

<p>비슷한 동작을 파이썬으로:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">QApplication</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span>
    <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QFileDialog</span>
<span class="p">)</span>
<span class="c1"># PySide6 쓰면 from PySide6.QtWidgets import ... 로 바꾸면 됨
</span>
<span class="k">class</span> <span class="nc">MainWindow</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">QFileDialog 예제</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button</span> <span class="o">=</span> <span class="nc">QPushButton</span><span class="p">(</span><span class="sh">"</span><span class="s">파일 선택</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">아직 파일을 선택하지 않았습니다.</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>

        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">label</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">on_select_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_select_file</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">file_name</span><span class="p">,</span> <span class="n">selected_filter</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="p">.</span><span class="nf">getOpenFileName</span><span class="p">(</span>
            <span class="n">self</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">파일 열기</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">""</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">이미지 파일 (*.png *.jpg *.bmp);;모든 파일 (*.*)</span><span class="sh">"</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">label</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">선택한 파일: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="nc">MainWindow</span><span class="p">()</span>
    <span class="n">w</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="nf">exec</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="3-디렉터리-선택-예제-pyqt-기준">3. 디렉터리 선택 예제 (PyQt 기준)</h2>

<p>디렉터리만 고르는 간단 코드:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dir_path</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="p">.</span><span class="nf">getExistingDirectory</span><span class="p">(</span>
    <span class="n">parent</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">폴더 선택</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">""</span><span class="p">,</span>
    <span class="n">QFileDialog</span><span class="p">.</span><span class="n">ShowDirsOnly</span> <span class="o">|</span> <span class="n">QFileDialog</span><span class="p">.</span><span class="n">DontResolveSymlinks</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">dir_path</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">선택된 폴더:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<p>만약 네가 궁금한 “소스코드”가<br />
“QFileDialog 안에서 플랫폼별로 어떻게 네이티브 파일 다이얼로그를 불러오는지” 같은 <strong>내부 구현</strong> 이라면, 그건 Qt 소스 트리에서 <code class="language-plaintext highlighter-rouge">src/widgets/dialogs/qfiledialog*</code> 쪽 C++ 파일들을 보는 식으로 파보는 영역이야.<br />
사용자 입장에선 위처럼 쓰는 예제 코드 정도면 대부분의 실전 상황은 커버된다.</p>

<p>다음 단계로는 <code class="language-plaintext highlighter-rouge">setFileMode</code>, <code class="language-plaintext highlighter-rouge">setNameFilters</code>, <code class="language-plaintext highlighter-rouge">setAcceptMode</code> 같은 옵션을 객체 방식으로 세팅하는 커스텀 다이얼로그 예제를 볼 만하지.</p>

<p class="chat--user">

난 내부 구현이 궁금해

</p>

<p>좋은 포인트에 꽂혔네. 내부 구현은 겉모습보다 훨씬 재밌다.</p>

<p>QFileDialog 내부 동작을 “대략 어떻게 생겼는지” 구조 위주로 풀어볼게. 실제 소스는 수천 줄이라 여기서 그대로 다 줄 수는 없고, 핵심 메커니즘을 해부하는 느낌으로.</p>

<hr />

<h2 id="1-큰-그림-껍데기-api--두-종류의-엔진">1. 큰 그림: “껍데기 API + 두 종류의 엔진”</h2>

<p>QFileDialog는 겉으로는 하나의 클래스지만, 안에서는 대략 두 가지 구현으로 갈라져 있어:</p>

<ol>
  <li>
    <p>플랫폼 네이티브 파일 다이얼로그</p>

    <ul>
      <li>
        <p>Windows: Win32 / COM 기반의 공용 파일 대화상자</p>
      </li>
      <li>
        <p>macOS: NSOpenPanel / NSSavePanel 계열</p>
      </li>
      <li>
        <p>일부 플랫폼의 네이티브 picker들</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Qt 위젯으로 만든 커스텀 파일 다이얼로그</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QFileDialog</code> 위젯 자체 + <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> + <code class="language-plaintext highlighter-rouge">QTreeView/QListView</code> 등</p>
      </li>
      <li>
        <p>옵션 또는 환경(플래그) 따라 이쪽을 사용</p>
      </li>
    </ul>
  </li>
</ol>

<p>기본값은 “가능하면 네이티브 다이얼로그를 사용”이고,<br />
<code class="language-plaintext highlighter-rouge">DontUseNativeDialog</code> 옵션이나 글로벌 앱 속성으로 강제로 Qt 위젯 기반 구현을 쓰게 할 수 있어. <a href="https://codebrowser.dev/qt6/qtbase/src/widgets/dialogs/qfiledialog.cpp.html?utm_source=chatgpt.com">Code Browser+1</a></p>

<p>그러니까, <code class="language-plaintext highlighter-rouge">getOpenFileName()</code> 같은 static 함수 한 번 부르면 내부에선:</p>

<ol>
  <li>
    <p>어떤 플랫폼인지, 옵션이 뭔지 보고</p>
  </li>
  <li>
    <p>“네이티브로 갈까? Qt 위젯으로 만들까?” 결정</p>
  </li>
  <li>
    <p>적절한 백엔드 구현을 생성해서 <code class="language-plaintext highlighter-rouge">exec()</code> 돌리고</p>
  </li>
  <li>
    <p>선택된 파일 리스트를 <code class="language-plaintext highlighter-rouge">QStringList</code>로 받아서 사용자한테 전달</p>
  </li>
</ol>

<p>이런 흐름이야.</p>

<hr />

<h2 id="2-클래스-구조-public--private-분리">2. 클래스 구조: public / private 분리</h2>

<p>Qt 소스 보면 <code class="language-plaintext highlighter-rouge">QFileDialog</code> 옆에 <code class="language-plaintext highlighter-rouge">QFileDialogPrivate</code>가 있어. 이게 진짜 뇌다. <a href="https://codebrowser.dev/qt6/qtbase/src/widgets/dialogs/qfiledialog.cpp.html?utm_source=chatgpt.com">Code Browser+1</a></p>

<p>대략 구조는:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">QFileDialog</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QDialog</span> <span class="p">{</span>
    <span class="n">Q_OBJECT</span>
<span class="nl">public:</span>
    <span class="c1">// public API들: setDirectory, setNameFilters, selectedFiles, ...</span>
<span class="nl">protected:</span>
    <span class="n">QFileDialog</span><span class="p">(</span><span class="n">QFileDialogPrivate</span> <span class="o">&amp;</span><span class="n">dd</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// d-pointer 패턴</span>
<span class="nl">private:</span>
    <span class="n">Q_DECLARE_PRIVATE</span><span class="p">(</span><span class="n">QFileDialog</span><span class="p">)</span>
    <span class="n">Q_PRIVATE_SLOT</span><span class="p">(</span><span class="n">d_func</span><span class="p">(),</span> <span class="kt">void</span> <span class="n">_q_currentChanged</span><span class="p">(</span><span class="k">const</span> <span class="n">QModelIndex</span> <span class="o">&amp;</span><span class="p">))</span>
    <span class="c1">// ... 등등</span>
<span class="p">};</span>
</code></pre></div></div>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">QFileDialogPrivate</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QDialogPrivate</span> <span class="p">{</span>
    <span class="n">Q_DECLARE_PUBLIC</span><span class="p">(</span><span class="n">QFileDialog</span><span class="p">)</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="k">const</span> <span class="n">QString</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="n">QString</span> <span class="o">&amp;</span><span class="n">filter</span><span class="p">,</span> <span class="k">const</span> <span class="n">QString</span> <span class="o">&amp;</span><span class="n">caption</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">createWidgets</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">createMenuActions</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">createToolButtons</span><span class="p">();</span>
    <span class="c1">// 시그널/슬롯 핸들러</span>
    <span class="kt">void</span> <span class="n">_q_currentChanged</span><span class="p">(</span><span class="k">const</span> <span class="n">QModelIndex</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">_q_selectionChanged</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">_q_enterDirectory</span><span class="p">(</span><span class="k">const</span> <span class="n">QModelIndex</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">_q_goToDirectory</span><span class="p">(</span><span class="k">const</span> <span class="n">QString</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">_q_updateOkButton</span><span class="p">();</span>
    <span class="c1">// ...</span>
    <span class="n">QFileSystemModel</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>
    <span class="n">QAbstractProxyModel</span> <span class="o">*</span><span class="n">proxyModel</span><span class="p">;</span>
    <span class="n">QList</span><span class="o">&lt;</span><span class="n">QUrl</span><span class="o">&gt;</span> <span class="n">history</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">currentHistoryLocation</span><span class="p">;</span>
    <span class="c1">// UI 포인터들: listView, treeView, comboBox, buttonBox ...</span>
<span class="p">};</span>
</code></pre></div></div>

<p>요런 식으로:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileDialog</code>는 “외부에 보이는 껍데기 + 신호/슬롯 선언”</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileDialogPrivate</code>는 “실제 동작, 상태, UI 구성, 모델 관리”</p>
  </li>
</ul>

<p>Qt의 d-pointer 패턴(Q_D, Q_Q 매크로)로 둘이 얽혀 있어.</p>

<hr />

<h2 id="3-qt-위젯-기반-구현-쪽-로직">3. Qt 위젯 기반 구현 쪽 로직</h2>

<p>네이티브 다이얼로그가 아닌 경우, <code class="language-plaintext highlighter-rouge">QFileDialogPrivate::createWidgets()</code>에서 직접 위젯들을 만든다. <a href="https://dreamswork.github.io/qt4/classQFileDialogPrivate.html?utm_source=chatgpt.com">DreamSworK</a></p>

<p>대략적인 구성:</p>

<ol>
  <li>
    <p>모델</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 사용</p>
      </li>
      <li>
        <p>루트 디렉터리, 필터, 정렬 방식 등을 설정</p>
      </li>
      <li>
        <p>디렉터리/파일 리스트 관리</p>
      </li>
    </ul>
  </li>
  <li>
    <p>뷰</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QTreeView</code> (디렉터리 트리)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QListView</code> (파일 리스트)</p>
      </li>
      <li>
        <p>둘 다 모델을 공유하거나 적절히 proxy를 씌움</p>
      </li>
    </ul>
  </li>
  <li>
    <p>상단 UI</p>

    <ul>
      <li>
        <p>주소 입력용 <code class="language-plaintext highlighter-rouge">QLineEdit</code> 또는 <code class="language-plaintext highlighter-rouge">QComboBox</code> (경로 표시/입력)</p>
      </li>
      <li>
        <p>뒤로/앞으로/위로 가기 버튼들 (history 관리)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>하단 UI</p>

    <ul>
      <li>
        <p>파일 이름 입력 <code class="language-plaintext highlighter-rouge">QLineEdit</code></p>
      </li>
      <li>
        <p>파일 타입 필터 <code class="language-plaintext highlighter-rouge">QComboBox</code> (name filters)</p>
      </li>
      <li>
        <p>OK/Cancel 버튼 (QDialogButtonBox)</p>
      </li>
    </ul>
  </li>
</ol>

<p>그리고 각종 비공개 슬롯들(<code class="language-plaintext highlighter-rouge">_q_...</code>)이 시그널에 연결되어 있다: <a href="https://dreamswork.github.io/qt4/classQFileDialogPrivate.html?utm_source=chatgpt.com">DreamSworK</a></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_currentChanged(const QModelIndex &amp;index)</code></p>

    <ul>
      <li>
        <p>리스트에서 현재 항목 바뀔 때 호출</p>
      </li>
      <li>
        <p>OK 버튼 활성/비활성 상태 갱신, <code class="language-plaintext highlighter-rouge">currentChanged()</code> 신호 발행</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_selectionChanged()</code></p>

    <ul>
      <li>
        <p>선택이 바뀔 때 호출</p>
      </li>
      <li>
        <p>선택된 파일 이름들을 하단 라인에 반영, OK 버튼 업데이트</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_enterDirectory(const QModelIndex &amp;index)</code></p>

    <ul>
      <li>
        <p>더블클릭/엔터 누를 때 호출</p>
      </li>
      <li>
        <p>디렉터리면 그 디렉터리로 들어가고</p>
      </li>
      <li>
        <p>파일이면 “선택 후 OK 처리” 같은 동작 준비</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_goToDirectory(const QString &amp;path)</code></p>

    <ul>
      <li>
        <p>경로 바뀌었을 때 실제 모델 루트 디렉터리 변경</p>
      </li>
      <li>
        <p>존재 여부 체크하고, 에러 시 메시지박스 띄우기도</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_pathChanged(const QString &amp;newPath)</code></p>

    <ul>
      <li>history 스택 관리, “뒤로 / 앞으로” 버튼 활성 상태 업데이트</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_showContextMenu(const QPoint &amp;pos)</code></p>

    <ul>
      <li>우클릭 메뉴 생성 (삭제, 이름 변경, 숨김 파일 보기 등)</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_deleteCurrent()</code>, <code class="language-plaintext highlighter-rouge">_q_renameCurrent()</code></p>

    <ul>
      <li>파일 삭제/이름 변경 로직. 모델이 readOnly면 막고, 아니면 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 통해 변경</li>
    </ul>
  </li>
</ul>

<p>요런 내부 슬롯들 위에 public API가 앉아 있는 구조야:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">setDirectory()</code> → d-&gt;model-&gt;setRootPath(…), 경로 UI 업데이트</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">setNameFilters()</code> → d-&gt;model-&gt;setNameFilters(…), 필터 콤보 갱신</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">selectedFiles()</code> → 현재 선택된 <code class="language-plaintext highlighter-rouge">QModelIndex</code>들을 걸러서 파일 path 리스트 반환</p>
  </li>
</ul>

<hr />

<h2 id="4-네이티브-다이얼로그-경로">4. 네이티브 다이얼로그 경로</h2>

<p>네이티브 활용 시에는 위젯들을 거의 안 만든다. 그래서 문서에 이런 말이 있다: “네이티브 다이얼로그를 사용하는 경우에는 레이아웃/위젯 관련 접근자들이 null을 반환할 수 있다.” <a href="https://codebrowser.dev/qt6/qtbase/src/widgets/dialogs/qfiledialog.cpp.html?utm_source=chatgpt.com">Code Browser</a></p>

<p>흐름은 대략 이렇다:</p>

<ol>
  <li>static 함수 호출
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QString</span> <span class="n">QFileDialog</span><span class="o">::</span><span class="n">getOpenFileName</span><span class="p">(</span>
    <span class="n">QWidget</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">QString</span> <span class="o">&amp;</span><span class="n">caption</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">QString</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">QString</span> <span class="o">&amp;</span><span class="n">filter</span><span class="p">,</span>
    <span class="n">QString</span> <span class="o">*</span><span class="n">selectedFilter</span><span class="p">,</span>
    <span class="n">Options</span> <span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 내부에서 helper 호출</span>
    <span class="c1">// 플랫폼별 native dialog helper에게 위임</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>플랫폼별 구현으로 위임</p>

    <ul>
      <li>
        <p>Windows: <code class="language-plaintext highlighter-rouge">IFileOpenDialog</code> / <code class="language-plaintext highlighter-rouge">GetOpenFileNameW</code> 계열 사용</p>
      </li>
      <li>
        <p>macOS: NSOpenPanel</p>
      </li>
      <li>
        <p>일부 Unix/플랫폼: Qt 위젯 기반 쓰거나, 적당한 native wrapper</p>
      </li>
    </ul>
  </li>
  <li>
    <p>옵션 변환</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QFileDialog::ExistingFile</code>, <code class="language-plaintext highlighter-rouge">Directory</code>, <code class="language-plaintext highlighter-rouge">AcceptSave</code> 등 enum을<br />
각 플랫폼 호출에 맞게 flag 변환</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">DontResolveSymlinks</code>, <code class="language-plaintext highlighter-rouge">DontUseCustomDirectoryIcons</code> 같은 것도 여기서 처리</p>
      </li>
    </ul>
  </li>
  <li>네이티브 다이얼로그에서 얻은 경로 목록을 <code class="language-plaintext highlighter-rouge">QStringList</code>로 변환해 반환</li>
</ol>

<p>이 경우 내부의 <code class="language-plaintext highlighter-rouge">QFileDialogPrivate::createWidgets()</code>는 아예 호출되지 않거나 최소화된다.</p>

<hr />

<h2 id="5-파일-시스템-연동-모델뷰-관점에서-정리">5. 파일 시스템 연동: 모델/뷰 관점에서 정리</h2>

<p>Qt 위젯 구현일 때를 모델/뷰 관점에서 한 번 요약해보면:</p>

<ul>
  <li>
    <p>모델: <code class="language-plaintext highlighter-rouge">QFileSystemModel</code></p>

    <ul>
      <li>
        <p>실제 디스크의 디렉터리 구조를 비동기적으로 탐색</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QDir::Filters</code>로 숨김 파일, 디렉터리만, 파일만 등의 필터 적용</p>
      </li>
      <li>
        <p>컬럼: 파일명, 크기, 타입, 수정일 등</p>
      </li>
    </ul>
  </li>
  <li>
    <p>proxy (선택적):</p>

    <ul>
      <li>정렬, 필터링, 사용자 정의 로직 넣을 수 있음</li>
    </ul>
  </li>
  <li>
    <p>뷰: <code class="language-plaintext highlighter-rouge">QTreeView</code> / <code class="language-plaintext highlighter-rouge">QListView</code></p>

    <ul>
      <li>
        <p>같은 모델을 서로 다른 방식으로 보여줌</p>
      </li>
      <li>
        <p>선택 모델 공유해서, 트리에서 선택하면 리스트도 바뀌는 식</p>
      </li>
    </ul>
  </li>
</ul>

<p>슬롯 <code class="language-plaintext highlighter-rouge">_q_rowsInserted(const QModelIndex &amp;parent)</code>를 보면, “루트에 처음 자식이 생기면 첫 항목을 선택한다” 같은 초기화 로직도 들어 있다. <a href="https://dreamswork.github.io/qt4/classQFileDialogPrivate.html?utm_source=chatgpt.com">DreamSworK</a></p>

<hr />

<h2 id="6-히스토리-뒤로가기앞으로가기">6. 히스토리, 뒤로가기/앞으로가기</h2>

<p>내부에 <code class="language-plaintext highlighter-rouge">currentHistory</code>, <code class="language-plaintext highlighter-rouge">currentHistoryLocation</code> 같은 멤버가 있고: <a href="https://dreamswork.github.io/qt4/classQFileDialogPrivate.html?utm_source=chatgpt.com">DreamSworK</a></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_pathChanged()</code>에서:</p>

    <ul>
      <li>
        <p>새 path를 history 벡터에 push</p>
      </li>
      <li>
        <p>현재 인덱스 이동</p>
      </li>
      <li>
        <p>뒤/앞 버튼 enable / disable 처리</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_navigateBackward()</code>, <code class="language-plaintext highlighter-rouge">_q_navigateForward()</code>에서:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">currentHistoryLocation</code> 조정</p>
      </li>
      <li>
        <p>해당 위치의 path로 <code class="language-plaintext highlighter-rouge">_q_goToDirectory()</code> 호출</p>
      </li>
    </ul>
  </li>
</ul>

<p>사실 브라우저 히스토리랑 거의 비슷한 구조야.</p>

<hr />

<h2 id="7-버튼ok-처리">7. 버튼/OK 처리</h2>

<p>OK 버튼은 “선택한 파일이 유효한가?”에 따라 활성/비활성 상태가 계속 업데이트된다:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_updateOkButton()</code>에서:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">fileMode</code>가 <code class="language-plaintext highlighter-rouge">ExistingFile</code>이면 실제 존재 여부, 읽기 가능 여부 체크</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">AnyFile</code>이면 그냥 허용</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">Directory</code> 모드면 디렉터리인지 확인</p>
      </li>
      <li>
        <p>선택이 없으면 비활성화</p>
      </li>
    </ul>
  </li>
</ul>

<p>사용자가 OK를 누르면:</p>

<ol>
  <li>
    <p>현재 선택된 <code class="language-plaintext highlighter-rouge">QModelIndex</code> 리스트를 가져오고</p>
  </li>
  <li>
    <p>모드에 맞게 필터링해서 <code class="language-plaintext highlighter-rouge">QStringList</code>로 저장</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">accept()</code> 호출해서 다이얼로그 닫음</p>
  </li>
  <li>
    <p>호출한 쪽에서 <code class="language-plaintext highlighter-rouge">selectedFiles()</code>로 최종 결과를 가져감</p>
  </li>
</ol>

<hr />

<h2 id="8-실제-소스가-궁금하다면-보는-위치">8. 실제 소스가 궁금하다면 보는 위치</h2>

<p>Qt 6 기준: <code class="language-plaintext highlighter-rouge">qtbase/src/widgets/dialogs/qfiledialog.cpp</code>에 구현이 대부분 들어 있다. <a href="https://codebrowser.dev/qt6/qtbase/src/widgets/dialogs/qfiledialog.cpp.html?utm_source=chatgpt.com">Code Browser+1</a></p>

<p>그 안에서:</p>

<ul>
  <li>
    <p>public API 구현</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileDialogPrivate</code> 정의</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_...</code> 슬롯들 정의</p>
  </li>
  <li>
    <p>네이티브/위젯 구현 분기</p>
  </li>
  <li>
    <p>각종 enum, 옵션 처리</p>
  </li>
</ul>

<p>를 전부 볼 수 있다.</p>

<hr />

<p>요약하자면:</p>

<ul>
  <li>
    <p>QFileDialog는 “플랫폼 네이티브 다이얼로그를 감싸는 래퍼” + “Qt 위젯으로 만든 파일 탐색기” 두 개의 얼굴을 가진다.</p>
  </li>
  <li>
    <p>d-pointer 패턴으로 public/내부 구현이 분리돼 있고, 내부는 <code class="language-plaintext highlighter-rouge">QFileDialogPrivate</code>가 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 기반의 모델/뷰 구조를 돌리고 있다.</p>
  </li>
  <li>
    <p>각종 <code class="language-plaintext highlighter-rouge">_q_...</code> 슬롯들이 파일 선택, 디렉터리 이동, 히스토리, 숨김 파일 표시 등 UI 행동을 구체적으로 처리한다.</p>
  </li>
</ul>

<p>이 정도면 내부 구조의 뼈대는 꽤 잡혔을 거야.<br />
이제부터는 “소스 열고 한 줄씩 뜯어보는 고행 모드”로 들어가면, 자신만의 커스텀 파일 다이얼로그 위젯을 만드는 데에도 꽤 도움 된다.</p>

<p class="chat--user">

QFileSystemModel 은 어떻게 되어있어?

</p>

<p>QFileSystemModel은 한마디로 “비동기 파일 시스템 트리 모델”이야.<br />
QFileDialog에서 썼던 그 친구 맞고, 내부는 꽤 묵직하게 구성돼 있다.</p>

<p>큰 흐름부터 → 점점 디테일로 파고들어볼게.</p>

<hr />

<h2 id="1-역할-정리부터">1. 역할 정리부터</h2>

<p>QFileSystemModel은 <code class="language-plaintext highlighter-rouge">QAbstractItemModel</code>을 상속한 트리형 모델이고, 로컬 파일 시스템(디렉터리/파일)을 보여주기 위한 표준 구현이야.<br />
파일/폴더 이름, 아이콘, 크기, 타입, 수정 시간 같은 데이터를 제공하고, 필요하면 rename/mkdir/remove 같은 조작도 해 준다. <a href="https://doc.qt.io/qt-6/qfilesystemmodel.html?utm_source=chatgpt.com">Qt 문서+1</a></p>

<p>QDirModel의 “느리고 동기적인” 방식 대신, 이쪽은 비동기 스캔 + 캐시 구조라 큰 트리에도 버티도록 만들어져 있음.</p>

<hr />

<h2 id="2-클래스-구조-모델--프라이빗--노드-트리">2. 클래스 구조: 모델 + 프라이빗 + 노드 트리</h2>

<p>겉으로는:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">QFileSystemModel</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QAbstractItemModel</span> <span class="p">{</span>
    <span class="n">Q_OBJECT</span>
<span class="nl">public:</span>
    <span class="c1">// setRootPath, filePath, isDir, data, index, parent, ...</span>
<span class="p">};</span>
</code></pre></div></div>

<p>하지만 실제 뇌는 <code class="language-plaintext highlighter-rouge">QFileSystemModelPrivate</code>와 그 안의 <code class="language-plaintext highlighter-rouge">QFileSystemNode</code> 트리다. <a href="https://dreamswork.github.io/qt4/classQFileSystemModel.html?utm_source=chatgpt.com">DreamSworK</a></p>

<p>대략 구조는 이런 느낌:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">QFileSystemModelPrivate</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QAbstractItemModelPrivate</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">struct</span> <span class="nc">QFileSystemNode</span> <span class="p">{</span>
        <span class="n">QFileInfo</span> <span class="n">info</span><span class="p">;</span>                      <span class="c1">// 경로, 이름, 사이즈, 시간, 퍼미션 등</span>
        <span class="n">QHash</span><span class="o">&lt;</span><span class="n">QString</span><span class="p">,</span> <span class="n">QFileSystemNode</span><span class="o">*&gt;</span> <span class="n">children</span><span class="p">;</span> <span class="c1">// 이름 -&gt; 자식 노드</span>
        <span class="n">QList</span><span class="o">&lt;</span><span class="n">QFileSystemNode</span><span class="o">*&gt;</span> <span class="n">visibleChildren</span><span class="p">;</span>   <span class="c1">// 필터 통과한 애들</span>
        <span class="n">QFileSystemNode</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">populatedChildren</span><span class="p">;</span>
        <span class="c1">// isDir(), permissions() 등 헬퍼들</span>
    <span class="p">};</span>

    <span class="n">QFileSystemNode</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>          <span class="c1">// 루트 노드</span>
    <span class="n">QFileInfoGatherer</span> <span class="n">fileInfoGatherer</span><span class="p">;</span>
    <span class="n">QList</span><span class="o">&lt;</span><span class="n">QRegExp</span><span class="o">&gt;</span> <span class="n">nameFilters</span><span class="p">;</span>
    <span class="n">QDir</span><span class="o">::</span><span class="n">Filters</span> <span class="n">filters</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">readOnly</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">forceSort</span><span class="p">;</span>
    <span class="c1">// 정렬, 캐시, persistent index 관리 등등...</span>
<span class="p">};</span>
</code></pre></div></div>

<p>즉:</p>

<ul>
  <li>
    <p>파일 시스템 = <code class="language-plaintext highlighter-rouge">QFileSystemNode</code> 트리</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QModelIndex</code> ↔ <code class="language-plaintext highlighter-rouge">QFileSystemNode*</code> 를 서로 매핑</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">row</code>, <code class="language-plaintext highlighter-rouge">column</code>, <code class="language-plaintext highlighter-rouge">parent/child</code> 계산은 전부 이 노드 트리를 기반으로 돌림 <a href="https://dreamswork.github.io/qt4/classQFileSystemModel.html?utm_source=chatgpt.com">DreamSworK</a></p>
  </li>
</ul>

<hr />

<h2 id="3-비동기-스캔-qfileinfogatherer">3. 비동기 스캔: QFileInfoGatherer</h2>

<p>핵심 포인트는 “디렉터리 목록과 파일 정보 수집을 별도 스레드에서 돌린다”는 거야. <a href="https://dreamswork.github.io/qt4/qfilesystemmodel_8cpp_source.html?utm_source=chatgpt.com">DreamSworK+1</a></p>

<p>대략 흐름:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">setRootPath("/some/path")</code> 호출</p>

    <ul>
      <li>private 쪽에서 루트 노드를 만들고, 그 경로를 <code class="language-plaintext highlighter-rouge">fileInfoGatherer</code>에게 넘김.</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileInfoGatherer</code>는 별도 스레드에서 <code class="language-plaintext highlighter-rouge">QDir</code>를 돌리면서</p>

    <ul>
      <li>하위 파일 목록, 파일 정보(QFileInfo)를 쭉 읽어옴.</li>
    </ul>
  </li>
  <li>
    <p>읽어온 결과를 신호로 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>에 보냄</p>

    <ul>
      <li>“이 디렉터리 밑에 이런 애들 있음” 같은 리스트.</li>
    </ul>
  </li>
  <li>
    <p>모델 쪽에서:</p>

    <ul>
      <li>
        <p>해당 디렉터리 노드의 <code class="language-plaintext highlighter-rouge">children</code>/<code class="language-plaintext highlighter-rouge">visibleChildren</code> 갱신</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">beginInsertRows</code> / <code class="language-plaintext highlighter-rouge">endInsertRows</code> 호출</p>
      </li>
      <li>
        <p>필요하면 <code class="language-plaintext highlighter-rouge">dataChanged</code>/<code class="language-plaintext highlighter-rouge">layoutChanged</code>도 발행</p>
      </li>
    </ul>
  </li>
</ol>

<p>그래서:</p>

<ul>
  <li>
    <p>UI 스레드는 “일단 비어 있는 트리/리스트”를 먼저 그리고</p>
  </li>
  <li>
    <p>백그라운드에서 디렉터리 스캔이 진행되면서 항목이 차츰차츰 나타나는 구조.</p>
  </li>
</ul>

<p>큰 디렉터리 열어도 UI가 버벅이지 않는 이유가 이거다.</p>

<hr />

<h2 id="4-재정의하는-핵심-가상-함수들">4. 재정의하는 핵심 가상 함수들</h2>

<p>QFileSystemModel은 <code class="language-plaintext highlighter-rouge">QAbstractItemModel</code>의 필수 함수들을 전부 구현해. <a href="https://dreamswork.github.io/qt4/classQFileSystemModel.html?utm_source=chatgpt.com">DreamSworK+1</a></p>

<p>대표적으로:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">QFileSystemModel</span><span class="o">::</span><span class="n">rowCount</span><span class="p">(</span><span class="k">const</span> <span class="n">QModelIndex</span> <span class="o">&amp;</span><span class="n">parent</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">Q_D</span><span class="p">(</span><span class="k">const</span> <span class="n">QFileSystemModel</span><span class="p">);</span>
    <span class="k">auto</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">visibleChildren</span><span class="p">.</span><span class="n">count</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">QFileSystemModel</span><span class="o">::</span><span class="n">columnCount</span><span class="p">(</span><span class="k">const</span> <span class="n">QModelIndex</span> <span class="o">&amp;</span><span class="n">parent</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">Q_UNUSED</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// Name, Size, Type, Date Modified</span>
<span class="p">}</span>

<span class="n">QModelIndex</span> <span class="n">QFileSystemModel</span><span class="o">::</span><span class="n">index</span><span class="p">(</span><span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="k">const</span> <span class="n">QModelIndex</span> <span class="o">&amp;</span><span class="n">parent</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">Q_D</span><span class="p">(</span><span class="k">const</span> <span class="n">QFileSystemModel</span><span class="p">);</span>
    <span class="k">auto</span> <span class="o">*</span><span class="n">parentNode</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
    <span class="k">auto</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="n">parentNode</span><span class="o">-&gt;</span><span class="n">visibleChildren</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">createIndex</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">QModelIndex</span> <span class="n">QFileSystemModel</span><span class="o">::</span><span class="n">parent</span><span class="p">(</span><span class="k">const</span> <span class="n">QModelIndex</span> <span class="o">&amp;</span><span class="n">child</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">Q_D</span><span class="p">(</span><span class="k">const</span> <span class="n">QFileSystemModel</span><span class="p">);</span>
    <span class="k">auto</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
    <span class="k">auto</span> <span class="o">*</span><span class="n">parentNode</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parentNode</span> <span class="o">||</span> <span class="n">parentNode</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">QModelIndex</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">parentNode</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">visibleChildren</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="n">parentNode</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">createIndex</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">parentNode</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>실제 구현은 더 방어적이지만, 구조는 이런 느낌이지.</p>

<hr />

<h2 id="5-data--역할--컬럼">5. data() / 역할 / 컬럼</h2>

<p>컬럼 4개는 대략 이렇게 쓰인다: <a href="https://doc.qt.io/qt-6/qfilesystemmodel.html?utm_source=chatgpt.com">Qt 문서+1</a></p>

<ol>
  <li>
    <p>0: 파일 이름</p>
  </li>
  <li>
    <p>1: 파일 크기</p>
  </li>
  <li>
    <p>2: 타입(폴더/텍스트 파일/그 외)</p>
  </li>
  <li>
    <p>3: 수정 시간</p>
  </li>
</ol>

<p><code class="language-plaintext highlighter-rouge">data(const QModelIndex &amp;index, int role)</code>에서:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Qt::DisplayRole</code></p>

    <ul>
      <li>
        <p>column 0 → <code class="language-plaintext highlighter-rouge">fileName</code></p>
      </li>
      <li>
        <p>column 1 → 사람이 읽기 좋은 사이즈(“1.2 KB” 이런 식)</p>
      </li>
      <li>
        <p>column 2 → 타입 문자열</p>
      </li>
      <li>
        <p>column 3 → 날짜/시간 포맷팅</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Qt::DecorationRole</code></p>

    <ul>
      <li>column 0 → <code class="language-plaintext highlighter-rouge">QFileIconProvider</code>로부터 가져온 아이콘 (폴더, 드라이브, 파일 등)</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Qt::CheckStateRole</code>, <code class="language-plaintext highlighter-rouge">Qt::ToolTipRole</code> 등은 상황에 따라 제공</p>
  </li>
</ul>

<p>아이콘은 <code class="language-plaintext highlighter-rouge">QFileIconProvider</code>를 통해 OS 스타일에 맞춰 가져온다. <a href="https://doc.qt.io/qt-6/qfilesystemmodel.html?utm_source=chatgpt.com">Qt 문서+1</a></p>

<hr />

<h2 id="6-필터링-qdirfilters--namefilters">6. 필터링: QDir::Filters + nameFilters</h2>

<p>두 가지 레벨의 필터가 있어: <a href="https://dreamswork.github.io/qt4/classQFileSystemModel.html?utm_source=chatgpt.com">DreamSworK</a></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">setFilter(QDir::Filters filters)</code></p>

    <ul>
      <li>
        <p>파일/디렉터리/숨김파일 등 포함 여부</p>
      </li>
      <li>
        <p>예: <code class="language-plaintext highlighter-rouge">QDir::AllDirs | QDir::NoDotAndDotDot | QDir::Files</code></p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">setNameFilters(QStringList patterns)</code></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">"*.cpp"</code>, <code class="language-plaintext highlighter-rouge">"*.h"</code> 같은 패턴들</p>
      </li>
      <li>
        <p>내부에서는 <code class="language-plaintext highlighter-rouge">QRegExp</code> 리스트로 바꿔서 저장해두고, 노드 추가 시 <code class="language-plaintext highlighter-rouge">passNameFilters()</code>로 체크</p>
      </li>
    </ul>
  </li>
</ul>

<p>필터가 바뀌면:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">forceSort = true</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">delayedSort()</code> 호출해서</p>

    <ul>
      <li>
        <p>visibleChildren 재구성</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">layoutChanged()</code> 같은 신호로 뷰 갱신</p>
      </li>
    </ul>
  </li>
</ul>

<p>그래서 필터를 막 바꿔도 모델/뷰 구조는 유지되면서 “보이는 애들만” 갈아끼우는 방식.</p>

<hr />

<h2 id="7-읽기-전용--쓰기-가능-모드">7. 읽기 전용 / 쓰기 가능 모드</h2>

<p>기본은 read-only 모델이지만, <code class="language-plaintext highlighter-rouge">setReadOnly(false)</code>를 주면 직접 파일 시스템을 수정할 수도 있다. <a href="https://doc.qt.io/qt-6/qfilesystemmodel.html?utm_source=chatgpt.com">Qt 문서+1</a></p>

<p>예:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">setData()</code>에서 이름 변경 (DisplayRole, column 0 변경)</p>

    <ul>
      <li>
        <p>내부적으로 <code class="language-plaintext highlighter-rouge">QFile::rename</code> 사용</p>
      </li>
      <li>
        <p>성공하면 노드의 QFileInfo 갱신 + persistent index 재맵핑</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mkdir(const QModelIndex &amp;parent, const QString &amp;name)</code></p>

    <ul>
      <li>QDir로 디렉터리 생성 → 새 노드 추가</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">remove(const QModelIndex &amp;index)</code></p>

    <ul>
      <li>파일/디렉터리 삭제 시도 → 성공 시 노드를 children에서 제거</li>
    </ul>
  </li>
</ul>

<p>이 때 readOnly 플래그는 이렇게 쓰여:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="n">QFileSystemModel</span><span class="o">::</span><span class="n">isReadOnly</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">Q_D</span><span class="p">(</span><span class="k">const</span> <span class="n">QFileSystemModel</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">readOnly</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">flags()</code>에서도, 쓰기 가능 + 디렉터리일 때 <code class="language-plaintext highlighter-rouge">Qt::ItemIsDropEnabled</code>를 켜서 드래그앤드롭으로 이동 같은 걸 허용한다. <a href="https://dreamswork.github.io/qt4/classQFileSystemModel.html?utm_source=chatgpt.com">DreamSworK+1</a></p>

<hr />

<h2 id="8-파일-변화-감시-watcher">8. 파일 변화 감시 (watcher)</h2>

<p>QFileSystemModel은 파일이 추가/삭제/이동될 때 자동으로 뷰가 따라가도록 만들어져 있어.</p>

<p>그걸 담당하는 게 아까 봤던 <code class="language-plaintext highlighter-rouge">QFileInfoGatherer</code> 쪽인데, 내부적으로 <code class="language-plaintext highlighter-rouge">QFileSystemWatcher</code>를 써서 디렉터리 변화를 감시하고, 바뀌면 다시 디렉터리 내용을 읽어와서 노드 트리를 업데이트한다. <a href="https://doc.qt.io/qt-6/qfilesystemmodel.html?utm_source=chatgpt.com">Qt 문서+1</a></p>

<p>그래서 외부에서 파일을 하나 생성해도, 트리/리스트 뷰가 “툭” 하고 새 줄이 생기는 것처럼 보이는 거지.</p>

<hr />

<h2 id="9-뷰와의-연결-방식">9. 뷰와의 연결 방식</h2>

<p>모델/뷰 세계에서 QFileSystemModel은 그냥 트리 모델일 뿐이라, QTreeView / QListView / QColumnView 등에 그대로 물린다. <a href="https://doc.qt.io/qt-6/model-view-programming.html?utm_source=chatgpt.com">Qt 문서+1</a></p>

<p>주로 쓰는 API는:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QFileSystemModel</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QFileSystemModel</span><span class="p">;</span>
<span class="n">model</span><span class="o">-&gt;</span><span class="n">setRootPath</span><span class="p">(</span><span class="s">"C:/"</span><span class="p">);</span>  <span class="c1">// 여기서부터 스캔 시작</span>

<span class="n">treeView</span><span class="o">-&gt;</span><span class="n">setModel</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
<span class="n">treeView</span><span class="o">-&gt;</span><span class="n">setRootIndex</span><span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">(</span><span class="s">"C:/Users"</span><span class="p">));</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">index(const QString &amp;path)</code>는 내부적으로 <code class="language-plaintext highlighter-rouge">d-&gt;node(path)</code>를 찾고, 그걸로 <code class="language-plaintext highlighter-rouge">createIndex</code>를 만들어 주는 유틸리티. <a href="https://dreamswork.github.io/qt4/classQFileSystemModel.html?utm_source=chatgpt.com">DreamSworK</a></p>

<hr />

<p>정리하자면:</p>

<ul>
  <li>
    <p>QFileSystemModel은 <code class="language-plaintext highlighter-rouge">QFileSystemNode</code> 트리 + 비동기 <code class="language-plaintext highlighter-rouge">QFileInfoGatherer</code> + <code class="language-plaintext highlighter-rouge">QFileSystemModelPrivate</code>가 합쳐진 꽤 복잡한 모델이고,</p>
  </li>
  <li>
    <p>파일 시스템을 “트리 모델”로 래핑해서 뷰(QTreeView, QListView 등)에 꽂으면 바로 파일 탐색기가 되는 구조야.</p>
  </li>
  <li>
    <p>필터링, 정렬, rename/mkdir/remove, 파일 변경 감시까지 다 들어 있어서, 기본 파일 브라우저는 이걸로 거의 다 구현 가능하다.</p>
  </li>
</ul>

<p>여기까지 이해하면, 직접 <code class="language-plaintext highlighter-rouge">QAbstractItemModel</code>을 상속해서 “나만의 가짜 파일 시스템”을 만드는 쪽으로도 사고를 확장해볼 수 있어. 실제 디스크 대신 DB나 네트워크 리소스를 물려도 되고. 모델/뷰의 맛있는 활용 영역이지.</p>

<p class="chat--user">

os.path.isfile 이랑 유사한 함수를 호출하는데가 어디야? /user/j 를 다이얼로그에 입력하면 컴퓨터가 멈춰버려 네트워크 드라이브라 그런가

</p>

<p>좋은 지점 찝었네. “os.path.isfile 같은 거를 어디서 부르냐 + 왜 /user/j 치면 멈추냐”를 정확히 짚어보자.</p>

<p>요약 먼저:</p>

<ul>
  <li>
    <p>Qt 쪽에서 <code class="language-plaintext highlighter-rouge">os.path.isfile</code>에 가장 가까운 건 <code class="language-plaintext highlighter-rouge">QFileInfo::isFile()</code>, <code class="language-plaintext highlighter-rouge">QFileInfo::isDir()</code>, <code class="language-plaintext highlighter-rouge">QFileInfo::exists()</code> 같은 애들이고,</p>
  </li>
  <li>
    <p>그 위에 <code class="language-plaintext highlighter-rouge">QDir::exists()</code>, <code class="language-plaintext highlighter-rouge">QFileSystemModel::isDir()</code> 같은 래퍼들이 올라가 있고,</p>
  </li>
  <li>
    <p>이게 내부적으로는 결국 OS의 <code class="language-plaintext highlighter-rouge">stat()</code>/<code class="language-plaintext highlighter-rouge">lstat()</code> 같은 시스템 콜이라, 느린 네트워크 경로에서 그냥 뻗어버릴 수 있어. <a href="https://doc.qt.io/qt-6/qfileinfo.html?utm_source=chatgpt.com">Qt 문서+1</a></p>
  </li>
</ul>

<p>그리고 <code class="language-plaintext highlighter-rouge">/user/j</code> 입력했을 때 멈추는 건 “Qt가 이상해서”라기보다, “그 경로에 접근하는 OS 호출이 네트워크 드라이브 때문에 오래 걸려서”일 가능성이 매우 높다.</p>

<hr />

<h2 id="1-실제로-어디서-isfile-같은-걸-부르냐">1. 실제로 어디서 <code class="language-plaintext highlighter-rouge">isfile</code> 같은 걸 부르냐</h2>

<p>QFileDialog + QFileSystemModel 조합일 때 중요한 포인트들만 찍어볼게.</p>

<h3 id="1-디렉터리-이동할-때-_q_gotodirectory">1) 디렉터리 이동할 때: <code class="language-plaintext highlighter-rouge">_q_goToDirectory</code></h3>

<p>파일 다이얼로그 상단의 콤보박스/경로 입력으로 디렉터리 이동할 때 호출되는 내부 슬롯이 있어:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QFileDialogPrivate::_q_goToDirectory(const QString &amp;path)</code> <a href="https://codebrowser.dev/qt5/qtbase/src/widgets/dialogs/qfiledialog.cpp.html">Code Browser+1</a></li>
</ul>

<p>이 함수 안에서:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QDir dir(path2);</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">dir.exists()</code>로 “이 디렉터리가 실제로 존재하는가?” 확인</p>
  </li>
</ol>

<p>여기서 <code class="language-plaintext highlighter-rouge">QDir::exists()</code>는 내부적으로 그 경로에 대해 <code class="language-plaintext highlighter-rouge">QFileInfo</code>를 만들고, OS의 파일 시스템 통계를 가져오는 호출(유닉스면 <code class="language-plaintext highlighter-rouge">stat()</code>, 윈도면 <code class="language-plaintext highlighter-rouge">GetFileAttributesW</code> 같은 것)을 한다고 보면 된다. <a href="https://doc.qt.io/qt-6/qfileinfo.html?utm_source=chatgpt.com">Qt 문서+1</a></p>

<p>즉, 네가 <code class="language-plaintext highlighter-rouge">/user/j</code> 치고 엔터를 치면:</p>

<ul>
  <li>
    <p>QFileDialog → <code class="language-plaintext highlighter-rouge">_q_goToDirectory("/user/j")</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_q_goToDirectory</code> → <code class="language-plaintext highlighter-rouge">QDir("/user/j").exists()</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QDir::exists()</code> → OS에게 “/user/j 정보 좀 줘”</p>
  </li>
  <li>
    <p>이때 /user가 느린 NFS/SMB/자동 마운트 포인트면, 여기서 뻗어버리는 것.</p>
  </li>
</ul>

<h3 id="2-항목-더블클릭엔터-_q_enterdirectory">2) 항목 더블클릭/엔터: <code class="language-plaintext highlighter-rouge">_q_enterDirectory</code></h3>

<p>리스트/트리에서 디렉터리 더블클릭할 때:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileDialogPrivate::_q_enterDirectory(const QModelIndex &amp;index)</code>가 호출되고,</p>
  </li>
  <li>
    <p>이 안에서 <code class="language-plaintext highlighter-rouge">QFileSystemModel::isDir(index)</code> 호출해서 “이게 폴더냐 파일이냐”를 구분한다. <a href="https://codebrowser.dev/qt5/qtbase/src/widgets/dialogs/qfiledialog.cpp.html">Code Browser+1</a></p>
  </li>
</ul>

<p><code class="language-plaintext highlighter-rouge">QFileSystemModel::isDir()</code>은:</p>

<ul>
  <li>
    <p>내부 노드에 캐시된 <code class="language-plaintext highlighter-rouge">QFileInfo</code>가 있으면 그걸 쓰고,</p>
  </li>
  <li>
    <p>없으면 새로 <code class="language-plaintext highlighter-rouge">QFileInfo</code>를 만들면서 OS 파일 정보를 가져온다.</p>
  </li>
</ul>

<p>이것도 결국 <code class="language-plaintext highlighter-rouge">stat()</code> 계열.</p>

<h3 id="3-ok-버튼-활성화-체크-_q_updateokbutton">3) OK 버튼 활성화 체크: <code class="language-plaintext highlighter-rouge">_q_updateOkButton</code></h3>

<p>사용자가 파일 이름을 텍스트로 입력할 때, OK 버튼 활성/비활성 상태를 계속 업데이트하는 <code class="language-plaintext highlighter-rouge">_q_updateOkButton</code>도 중요하다. 이 함수 안에서:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel::index(path)</code>로 인덱스 찾고,</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">isDir()</code>인지, 파일인지, 존재하는지 등을 확인해서 “지금 상태에서 OK를 눌러도 되는지” 계산한다. <a href="https://codebrowser.dev/qt5/qtbase/src/widgets/dialogs/qfiledialog.cpp.html">Code Browser</a></p>
  </li>
</ul>

<p>여기서도 결국 <code class="language-plaintext highlighter-rouge">QFileInfo</code>/<code class="language-plaintext highlighter-rouge">QDir</code> 기반의 존재 여부 체크 호출이 들어간다.</p>

<h3 id="4-자동완성컴플리터-qfscompleter">4) 자동완성/컴플리터: QFSCompleter</h3>

<p>QFileDialog는 파일 이름 입력란에 파일 시스템 자동완성(<code class="language-plaintext highlighter-rouge">QFSCompleter</code>)을 붙인다. 위에서 봤듯이: <a href="https://codebrowser.dev/qt5/qtbase/src/widgets/dialogs/qfiledialog.cpp.html">Code Browser+1</a></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFSCompleter</code>는 내부에 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>을 쓰고,</p>
  </li>
  <li>
    <p>사용자가 <code class="language-plaintext highlighter-rouge">/user/j</code> 같은 걸 타이핑하면,</p>
  </li>
  <li>
    <p>해당 경로에 대해 모델이 인덱스를 만들고, 디렉터리 내용을 읽어서 후보를 찾으려고 한다.</p>
  </li>
</ul>

<p>결론: 타이핑만 해도 백그라운드에서 “이 경로가 존재하냐, 디렉터리냐, 안에 뭐 있냐”를 쉴 새 없이 때린다.</p>

<hr />

<h2 id="2-왜-userj-에서-컴퓨터가-멈추는가-네트워크-드라이브-의심">2. 왜 /user/j 에서 컴퓨터가 멈추는가 (네트워크 드라이브 의심)</h2>

<p>정황상 이런 시나리오가 매우 그럴듯하다:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/user</code>가 로컬이 아니라, 자동 마운트되는 네트워크 경로 (NFS, SMB, autofs 등)다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/user/j</code>에 접근하려고 OS가 마운트/네트워크 연결을 시도한다.</p>
  </li>
  <li>
    <p>네트워크가 죽어있거나 응답이 느려서 <code class="language-plaintext highlighter-rouge">stat("/user/j")</code> 같은 호출이 수 초~수십 초 동안 블록된다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileDialog::_q_goToDirectory</code>는 이 <code class="language-plaintext highlighter-rouge">QDir::exists()</code> 호출을 UI 스레드에서 그냥 호출한다.</p>
  </li>
  <li>
    <p>그 순간 UI 스레드가 OS 콜에 붙잡혀서 “앱이 멈춘 것처럼” 보인다.</p>
  </li>
</ol>

<p>QFileSystemModel 자체는 파일 스캔을 별도 스레드에서 돌리지만,<br />
“디렉터리가 존재하는지 한번 체크” 같은 부분은 종종 UI 스레드에서 동기적으로 호출된다. 네트워크가 느리면 그냥 같이 끌려들어감. <a href="https://stackoverflow.com/questions/15661696/qfilesystemmodel-freezes-ui?utm_source=chatgpt.com">Stack Overflow+1</a></p>

<p>파이썬으로 치면:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="sh">"</span><span class="s">/user/j</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 이 한 줄이 NFS 때문에 10초 동안 리턴이 안 됨
</span></code></pre></div></div>

<p>이걸 메인 스레드에서 GUI 돌리는 와중에 직접 호출하는 느낌이다.</p>

<hr />

<h2 id="3-어떻게-피할-수-있나-현실적인-우회책">3. 어떻게 피할 수 있나 (현실적인 우회책)</h2>

<p>Qt 소스 자체를 바꾸지 않는 선에서 쓸 수 있는 카드들 몇 개만 정리해볼게.</p>

<ol>
  <li>다이얼로그 시작 위치를 안전한 곳으로 고정</li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileDialog</code> 생성할 때 <code class="language-plaintext highlighter-rouge">QDir::homePath()</code> 같은 로컬 경로를 initial directory로 주고,</p>
  </li>
  <li>
    <p>문제의 <code class="language-plaintext highlighter-rouge">/user/j</code> 같은 경로는 아예 안 건드리게 UX를 설계하는 방법.</p>
  </li>
  <li>
    <p>예:</p>
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QFileDialog</span> <span class="nf">dlg</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">"Open"</span><span class="p">,</span> <span class="n">QDir</span><span class="o">::</span><span class="n">homePath</span><span class="p">());</span>
</code></pre></div>    </div>
  </li>
</ul>

<ol>
  <li>네이티브/비네이티브 다이얼로그 바꿔보기</li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">DontUseNativeDialog</code> 옵션을 켜거나 끄면,</p>

    <ul>
      <li>OS 네이티브 다이얼로그 vs Qt 위젯 기반 다이얼로그를 바꿀 수 있다. <a href="https://codebrowser.dev/qt5/qtbase/src/widgets/dialogs/qfiledialog.cpp.html">Code Browser</a></li>
    </ul>
  </li>
  <li>
    <p>둘 다 결국 <code class="language-plaintext highlighter-rouge">stat()</code>는 부르지만, 네이티브 쪽이 네트워크 드라이브 처리에 좀 더 관대한 경우도 있고, 반대로 더 느릴 수도 있다. 두 쪽 다 테스트해볼 가치 있음.</p>
  </li>
</ul>

<ol>
  <li>커스텀 파일 다이얼로그 만들기</li>
</ol>

<ul>
  <li>
    <p>아주 빡세게 튜닝하려면 <code class="language-plaintext highlighter-rouge">QFileDialog</code> 안 쓰고:</p>

    <ul>
      <li>
        <p>직접 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 붙인 <code class="language-plaintext highlighter-rouge">QTreeView/QListView</code> 기반 위젯을 만들고,</p>
      </li>
      <li>
        <p>“경로 존재 여부 체크”를 직접 제어할 수 있다.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>예를 들면:</p>

    <ul>
      <li>
        <p>텍스트 입력 시 실시간으로 <code class="language-plaintext highlighter-rouge">QDir::exists()</code> 안 부르고,</p>
      </li>
      <li>
        <p>유저가 엔터를 눌렀을 때만 별도 스레드에서 경로 체크 후, 성공하면 UI에 반영.</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>네트워크 쪽 문제라면 OS 레벨에서 해결</li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/user</code>가 죽은 NFS 마운트라면, 애플리케이션 레벨에서 할 수 있는 건 사실 거의 없다.</p>
  </li>
  <li>
    <p>마운트 옵션에 <code class="language-plaintext highlighter-rouge">soft</code>/타임아웃 조정, 또는 해당 네트워크 드라이브를 빼버리는 식으로 해결하는 게 근본적.</p>
  </li>
</ul>

<hr />

<h2 id="4-ospathisfile-비슷한-함수를-정리하면">4. “os.path.isfile 비슷한 함수”를 정리하면</h2>

<p>Qt 쪽에서 파일/디렉터리 존재 여부를 확인하는 주요 포인트는 이런 애들:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileInfo::exists()</code> / <code class="language-plaintext highlighter-rouge">QFileInfo::isFile()</code> / <code class="language-plaintext highlighter-rouge">QFileInfo::isDir()</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QDir::exists()</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel::isDir()</code> / <code class="language-plaintext highlighter-rouge">fileInfo()</code></p>
  </li>
  <li>
    <p>QFileDialog 내부에서 이들을 쓰는 <code class="language-plaintext highlighter-rouge">_q_goToDirectory</code>, <code class="language-plaintext highlighter-rouge">_q_enterDirectory</code>, <code class="language-plaintext highlighter-rouge">_q_updateOkButton</code> 등 슬롯들 <a href="https://codebrowser.dev/qt5/qtbase/src/widgets/dialogs/qfiledialog.cpp.html">Code Browser+1</a></p>
  </li>
</ul>

<p>이 애들이 전부 “os.path.isfile 같은 일을 한다”고 보면 된다.<br />
그리고 <code class="language-plaintext highlighter-rouge">/user/j</code>에서 멈추는 건 이 함수들이 네트워크/자동 마운트 때문에 블록되는 구조라고 생각하면 이해가 딱 맞게 떨어진다.</p>

<p>파일 다이얼로그가 “느린 경로에 잘못된 stat 한 번 던졌다가 UI가 같이 죽는 상황”은, OS + 네트워크 + GUI가 합작해서 만든 고전적인 함정이라, 디버깅할 땐 <code class="language-plaintext highlighter-rouge">strace</code>/<code class="language-plaintext highlighter-rouge">Process Monitor</code> 같은 걸로 실제 어떤 system call에서 붙잡히는지 보는 것도 꽤 도움 된다.</p>

<p class="chat--user">

그런데 소스를 보니 QFileSystemModel이랑 QCompleter랑 같이 쓸 수 있던데 원리가 뭐야? 둘이 어떤 방식으로 소통하는지 전혀 이해가 안돼

</p>

<p>좋은 데 꽂혔다. 여기 이해하면 “Qt 모델/뷰/컴플리터 삼각관계”를 거의 깨우친 셈이야.</p>

<p>질문 요약하면:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>이랑 <code class="language-plaintext highlighter-rouge">QCompleter</code>를 같이 쓸 수 있다는데</p>
  </li>
  <li>
    <p>둘이 도대체 어떻게 붙어 있는지 / 누가 누구한테 뭘 물어보는지 감이 안 온다</p>
  </li>
</ul>

<p>그래서 구조를 단계별로 풀어볼게.</p>

<hr />

<h2 id="1-기본-그림-qcompleter는-모델-소비자">1. 기본 그림: QCompleter는 “모델 소비자”</h2>

<p>핵심 아이디어 하나만 먼저 박아두자:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QCompleter</code>는 <strong>직접 데이터를 들고 있지 않고</strong> ,</p>
  </li>
  <li>
    <p>“아무 <code class="language-plaintext highlighter-rouge">QAbstractItemModel</code>이나 받아서 거기서 자동완성 후보를 뽑아 쓰는 객체”야.</p>
  </li>
</ul>

<p>즉:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QFileSystemModel</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QFileSystemModel</span><span class="p">;</span>
<span class="n">model</span><span class="o">-&gt;</span><span class="n">setRootPath</span><span class="p">(</span><span class="s">"/"</span><span class="p">);</span>

<span class="n">QCompleter</span> <span class="o">*</span><span class="n">completer</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">QCompleter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
<span class="n">lineEdit</span><span class="o">-&gt;</span><span class="n">setCompleter</span><span class="p">(</span><span class="n">completer</span><span class="p">);</span>
</code></pre></div></div>

<p>이렇게 하면:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>은 평소처럼 “파일 트리”를 제공하고</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QCompleter</code>는 “모델을 탐색하면서 ‘지금 텍스트에 맞는 아이템’을 골라주는 역할”만 한다.</p>
  </li>
</ul>

<p>그래서 소통 방향은 아주 단순하게 말하면:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QCompleter</code> → <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>에게 계속 <code class="language-plaintext highlighter-rouge">data()</code>, <code class="language-plaintext highlighter-rouge">index()</code>, <code class="language-plaintext highlighter-rouge">rowCount()</code>, <code class="language-plaintext highlighter-rouge">parent()</code> 등을 호출해가며 후보를 찾는다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>은 그냥 “평소처럼 모델을 구현했을 뿐”. “나 지금 컴플리터랑 대화 중이야”라는 특별한 인식은 없다.</p>
  </li>
</ul>

<p>QCompleter 입장에서 보면 “QFileSystemModel이냐 QStandardItemModel이냐”는 관심 없고, 그저 <code class="language-plaintext highlighter-rouge">QAbstractItemModel</code>일 뿐이다.</p>

<hr />

<h2 id="2-qcompleter-내부에서-벌어지는-일-간단-버전">2. QCompleter 내부에서 벌어지는 일 간단 버전</h2>

<p>텍스트 입력 흐름을 머릿속에서 재생해보자.</p>

<ol>
  <li>
    <p>사용자가 <code class="language-plaintext highlighter-rouge">lineEdit</code>에 뭔가를 타이핑한다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QLineEdit</code>는 <code class="language-plaintext highlighter-rouge">textEdited(QString)</code> 같은 시그널을 낸다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QCompleter</code>가 이 신호에 연결돼 있어서 <code class="language-plaintext highlighter-rouge">setCompletionPrefix(prefix)</code> 비슷한 처리를 한다고 생각하면 된다.</p>
  </li>
  <li>
    <p>QCompleter는 “지금 prefix로 시작하는 모델 아이템”을 찾기 위해,</p>

    <ul>
      <li>
        <p>내부적으로 <code class="language-plaintext highlighter-rouge">QModelIndex</code>들을 쭉 훑거나,</p>
      </li>
      <li>
        <p>특정 column만 보고 <code class="language-plaintext highlighter-rouge">data(index, Qt::DisplayRole)</code>를 읽는다.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>걸러진 애들로 팝업 리스트(작은 리스트뷰)를 만들어 보여준다.</p>
  </li>
</ol>

<p>즉, QCompleter는:</p>

<ul>
  <li>
    <p>“prefix를 기준으로 모델 아이템 필터링 + 결과를 팝업으로 보여주기” 역할</p>
  </li>
  <li>
    <p>모델은 그냥 “데이터 창고”</p>
  </li>
</ul>

<p>이 구조 덕에, <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>처럼 복잡한 모델도, <code class="language-plaintext highlighter-rouge">QCompleter</code> 한 방에 “파일 경로 자동완성기”로 바뀐다.</p>

<hr />

<h2 id="3-그럼-qfilesystemmodel이랑-붙으면-어떤-식으로-보일까">3. 그럼 QFileSystemModel이랑 붙으면 어떤 식으로 보일까?</h2>

<p>보통 파일 경로 자동완성은 이렇게 쓰게 돼:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QFileSystemModel</span><span class="p">;</span>
<span class="n">model</span><span class="o">-&gt;</span><span class="n">setRootPath</span><span class="p">(</span><span class="n">QDir</span><span class="o">::</span><span class="n">rootPath</span><span class="p">());</span>  <span class="c1">// "/" 혹은 "C:/"</span>

<span class="k">auto</span> <span class="o">*</span><span class="n">completer</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">QCompleter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="c1">// 경로처럼 보이게 설정 ("/usr", "/usr/local" 같은 느낌)</span>
<span class="n">completer</span><span class="o">-&gt;</span><span class="n">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="o">::</span><span class="n">PopupCompletion</span><span class="p">);</span>
<span class="n">completer</span><span class="o">-&gt;</span><span class="n">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">CaseInsensitive</span><span class="p">);</span>
<span class="n">completer</span><span class="o">-&gt;</span><span class="n">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">MatchContains</span><span class="p">);</span> <span class="c1">// 또는 StartsWith</span>

<span class="n">lineEdit</span><span class="o">-&gt;</span><span class="n">setCompleter</span><span class="p">(</span><span class="n">completer</span><span class="p">);</span>
</code></pre></div></div>

<p>그러면:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>이 디스크의 디렉터리/파일 목록을 비동기로 채워 넣고</p>
  </li>
  <li>
    <p>QCompleter는 사용자가 <code class="language-plaintext highlighter-rouge">"/usr"</code> 치기 시작할 때마다:</p>

    <ul>
      <li>
        <p>모델에서 <code class="language-plaintext highlighter-rouge">"/"</code> 밑 자식들 <code class="language-plaintext highlighter-rouge">/usr</code>, <code class="language-plaintext highlighter-rouge">/opt</code>, <code class="language-plaintext highlighter-rouge">/home</code> … 같은 애들을 보고</p>
      </li>
      <li>
        <p>prefix(예: <code class="language-plaintext highlighter-rouge">/u</code>)에 맞는 것만 골라서 팝업에 올린다.</p>
      </li>
    </ul>
  </li>
</ul>

<p>사실 이게 QFileDialog 안에서 쓰이는 <code class="language-plaintext highlighter-rouge">QFSCompleter</code>의 정체랑도 비슷해.<br />
<code class="language-plaintext highlighter-rouge">QFSCompleter</code>는 “QFileSystemModel을 내장해서 경로 완성을 해주는 QCompleter 서브클래스” 정도로 상상하면 된다.</p>

<hr />

<h2 id="4-구체적으로-누가-어떤-함수를-호출하냐">4. 구체적으로 누가 어떤 함수를 호출하냐</h2>

<p>조금 더 “호출 관계” 느낌으로 써보면:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QCompleter::setModel(QAbstractItemModel *model)</code></p>

    <ul>
      <li>내부에 모델 포인터를 저장하고, 필요하면 시그널(<code class="language-plaintext highlighter-rouge">modelReset</code>, <code class="language-plaintext highlighter-rouge">rowsInserted</code> 등)에 연결한다.</li>
    </ul>
  </li>
  <li>
    <p>사용자가 글자를 입력할 때마다</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QCompleter::setCompletionPrefix(const QString &amp;prefix)</code>가 불리고,</p>
      </li>
      <li>
        <p>이 함수가 <code class="language-plaintext highlighter-rouge">updateCompletionModel()</code> 같은 내부 함수로 넘어간다고 치자.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">updateCompletionModel()</code>에서는:</p>

    <ul>
      <li>
        <p>모델 전체 또는 특정 서브트리에 대해</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">rowCount</code>, <code class="language-plaintext highlighter-rouge">index</code>, <code class="language-plaintext highlighter-rouge">data(index, completionRole)</code> 등을 호출한다.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">data(..., role)</code>에서 QFileSystemModel은 파일 이름을 돌려준다.</p>
      </li>
      <li>
        <p>이 문자열이 prefix와 매칭되는지를 <code class="language-plaintext highlighter-rouge">Qt::MatchFlags</code> 규칙에 따라 검사.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>매칭된 인덱스들을 QCompleter 안의 “보이는 목록”으로 채운다.</p>

    <ul>
      <li>
        <p>팝업이 필요하면, 내부적으로 작은 <code class="language-plaintext highlighter-rouge">QAbstractItemView</code> (보통 QListView)를 써서 <code class="language-plaintext highlighter-rouge">setModel()</code> 해준다.</p>
      </li>
      <li>
        <p>이때 QCompleter는 “원본 모델에서 이 인덱스, 팝업 모델에서는 이 줄” 이런 매핑을 관리한다.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>사용자가 팝업에서 하나 선택하면:</p>

    <ul>
      <li>
        <p>QCompleter는 그 인덱스에 해당하는 문자열(<code class="language-plaintext highlighter-rouge">data(index, completionRole)</code>)을 가져와서</p>
      </li>
      <li>
        <p>원래 <code class="language-plaintext highlighter-rouge">QLineEdit</code>의 text를 그걸로 바꾼다.</p>
      </li>
    </ul>
  </li>
</ol>

<p>여기 어디에도 “QFileSystemModel 전용 API”는 없다.<br />
전부 “QAbstractItemModel 표준 메서드”만 호출한다는 게 포인트다.</p>

<hr />

<h2 id="5-파일-경로처럼-완성되게-만드는-트릭들">5. 파일 경로처럼 완성되게 만드는 트릭들</h2>

<p>“파일 이름만” 자동완성하면 재미없고, 보통은 <code class="language-plaintext highlighter-rouge">"C:/Users/Jo"</code> 같은 전체 경로를 자동완성하고 싶잖아?</p>

<p>이때 보통은:</p>

<ol>
  <li>
    <p>QCompleter의 <strong>completionColumn</strong> 을 파일 이름 컬럼에 맞춰 놓고</p>
  </li>
  <li>
    <p>텍스트를 조작해서 “디렉터리 부분 + 마지막 토큰”으로 쪼갠다.</p>
  </li>
</ol>

<p>예를 들면:</p>

<ul>
  <li>
    <p>사용자가 <code class="language-plaintext highlighter-rouge">"C:/Users/Jo"</code>를 입력한다.</p>
  </li>
  <li>
    <p>코드에서 이걸 <code class="language-plaintext highlighter-rouge">"dir = C:/Users"</code>, <code class="language-plaintext highlighter-rouge">"last = Jo"</code>로 나눈다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel::index(dir)</code>로 그 디렉터리의 인덱스를 찾는다.</p>
  </li>
  <li>
    <p>QCompleter에게 “이 디렉터리 인덱스를 root로 삼아라”라고 알려준다.</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">completer-&gt;setRootIndex(model-&gt;index(dir));</code></li>
    </ul>
  </li>
  <li>
    <p>그 상태에서 prefix를 <code class="language-plaintext highlighter-rouge">"Jo"</code>로 주면,</p>

    <ul>
      <li>
        <p>QCompleter는 <code class="language-plaintext highlighter-rouge">C:/Users</code> 밑의 자식(John, Josh, etc)을 찾는다.</p>
      </li>
      <li>
        <p>선택하면 <code class="language-plaintext highlighter-rouge">"C:/Users/John"</code> 같은 완성된 문자열을 다시 합쳐서 lineEdit에 넣어준다.</p>
      </li>
    </ul>
  </li>
</ul>

<p>이런 식으로 “경로 처리 로직”은 대부분 QCompleter보다 <strong>외부에서</strong> 짜고, QCompleter는 그냥 “지금 디렉터리의 아이템 중에 prefix로 시작하는 거 찾아줘” 역할만 맡긴다.</p>

<p>QFileDialog 안의 <code class="language-plaintext highlighter-rouge">QFSCompleter</code>도 이런 패턴을 더 복잡하게 확장해서:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/user</code>를 입력하면 <code class="language-plaintext highlighter-rouge">/user/</code>로 맞추고</p>
  </li>
  <li>
    <p>디렉터리와 파일을 상황에 따라 다르게 보여주고</p>
  </li>
  <li>
    <p>이름 필터/숨김 파일 처리 등을 곁들여서 동작한다.</p>
  </li>
</ul>

<hr />

<h2 id="6-요약-둘이-무슨-사적인-프로토콜-쓰는-거-아님">6. 요약: 둘이 무슨 사적인 프로토콜 쓰는 거 아님</h2>

<p>정리하면:</p>

<ul>
  <li>
    <p>QCompleter는 그냥 “모델을 탐색하는 소비자 역할”을 하는 객체</p>
  </li>
  <li>
    <p>QFileSystemModel은 “파일 시스템 트리를 제공하는 모델”</p>
  </li>
  <li>
    <p>둘의 소통은 <code class="language-plaintext highlighter-rouge">QAbstractItemModel</code>이 정해준 메서드들</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">rowCount</code>, <code class="language-plaintext highlighter-rouge">index</code>, <code class="language-plaintext highlighter-rouge">parent</code>, <code class="language-plaintext highlighter-rouge">data</code> 등등</li>
    </ul>
  </li>
  <li>
    <p>특별한 “QFileSystemModel 전용 훅” 같은 건 없고,</p>

    <ul>
      <li>
        <p>파일 시스템에 특화된 건 전부 QFileSystemModel 내부에서 <code class="language-plaintext highlighter-rouge">QFileInfo</code>, <code class="language-plaintext highlighter-rouge">QDir</code>로 처리</p>
      </li>
      <li>
        <p>QCompleter는 그냥 “문자열”만 본다.</p>
      </li>
    </ul>
  </li>
</ul>

<p>그래서 원리를 한 줄로 말하면:</p>

<p>경로 자동완성 = “QFileSystemModel이 제공하는 트리를 QCompleter가 필터링해서 보여주는 것”</p>

<p>이 패턴을 이해하면, 나중에 “DB기반 자동완성”, “네트워크 리소스 자동완성” 같은 것도 똑같이 구현할 수 있다. 모델만 갈아끼우고, QCompleter는 그대로 재활용하는 식으로.</p>

<p class="chat--user">

구체적으로 QModelIndex들을 쭉 훑는다는게 무슨 말이야

</p>

<p>QCompleter가 “QModelIndex들을 훑는다”는 말을 들으면, 마치 트리 전체를 완전히 DFS로 도는 느낌처럼 상상할 수도 있는데, 실제로는 <strong>그보다 단순하면서도 상황에 따라 꽤 잦은 호출이 일어나는 구조</strong> 다.<br />
구조 자체는 어렵지 않은데, Qt가 이걸 꽤 은근하게 자동으로 돌리기 때문에 감이 잘 안 오는 것뿐이야.</p>

<p>차근차근, 실제 내부에서 어떤 일이 벌어지는지를 <strong>눈에 보이게</strong> 만들어볼게.</p>

<hr />

<h1 id="1-qcompleter는-모델을-탐색할-능력만-가진-객체다">1. QCompleter는 모델을 “탐색할 능력만 가진 객체”다</h1>

<p>QCompleter는 <strong>모델의 데이터를 직접 저장하지 않는다.</strong><br />
대신, 자동완성 후보를 찾을 때마다 <strong>모델한테 직접 물어본다.</strong></p>

<p>모델이 어떤 종류든 상관없다.<br />
QCompleter는 딱 세 가지 정도만 알고 싶어 한다:</p>

<ul>
  <li>
    <p>rowCount(여기 몇 줄 있어?)</p>
  </li>
  <li>
    <p>index(i번째 줄의 모델 인덱스 좀 줄래?)</p>
  </li>
  <li>
    <p>data(index) (그 모델 인덱스의 문자열 뭐야?)</p>
  </li>
</ul>

<p>그리고 필요하면 parent(), columnCount() 등을 부른다.</p>

<p>즉, QCompleter는 자신이 가진 prefix(사용자가 입력한 문자열)를 가지고:</p>

<p>이 아이템이 prefix와 맞나?<br />
그럼 후보 목록에 넣자.</p>

<p>이걸 반복하는 구조.</p>

<hr />

<h1 id="2-훑는다는-것을-구체화해보자">2. “훑는다는 것”을 구체화해보자</h1>

<p>예를 들어, 모델이 이런 구조라고 하자:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>폴더<span class="o">)</span>  /home
  <span class="o">(</span>파일<span class="o">)</span> a.txt
  <span class="o">(</span>파일<span class="o">)</span> apple.png
  <span class="o">(</span>파일<span class="o">)</span> notes.docx
</code></pre></div></div>

<p>그리고 사용자가 lineEdit에 <code class="language-plaintext highlighter-rouge">"a"</code>라고 입력했다.</p>

<p>QCompleter는 사용자가 입력할 때마다 이렇게 움직인다:</p>

<h3 id="1-일단-현재-rootindex-밑에-있는-row들을-알아낸다">1) 일단 “현재 rootIndex” 밑에 있는 row들을 알아낸다</h3>

<p>보통 경로 자동완성에서는 rootIndex가 “현재 보고 있는 디렉터리”를 뜻한다.</p>

<p>QCompleter 내부 과정(개념적 의사 코드):</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">root</span> <span class="o">=</span> <span class="n">completer</span><span class="o">-&gt;</span><span class="n">rootIndex</span><span class="p">();</span>  <span class="c1">// 예: /home 디렉터리 인덱스</span>

<span class="kt">int</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">rowCount</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>    <span class="c1">// 예: 3개 (a.txt, apple.png, notes.docx)</span>
</code></pre></div></div>

<h3 id="2-0부터-rows-1까지-반복하면서-index를-만든다">2) 0부터 rows-1까지 반복하면서 index를 만든다</h3>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="p">;</span> <span class="o">++</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">QModelIndex</span> <span class="n">child</span> <span class="o">=</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">completionColumn</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>completionColumn은 보통 “이름이 들어 있는 column 0”.</p>

<h3 id="3-각-인덱스의-data를-읽는다">3) 각 인덱스의 data()를 읽는다</h3>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QString</span> <span class="n">text</span> <span class="o">=</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Qt</span><span class="o">::</span><span class="n">DisplayRole</span><span class="p">).</span><span class="n">toString</span><span class="p">();</span>
</code></pre></div></div>

<p>QFileSystemModel이면 여기서 파일 이름이 온다.</p>

<h3 id="4-prefix와-비교한다">4) prefix와 비교한다</h3>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">caseSensitivity</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">addToCompletionList</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>이 전체 과정이 바로 “QModelIndex들 훑기”다.</p>

<p><strong>그냥 rowCount()로 개수를 알아내고, row마다 index() 부르고, data()를 읽고, prefix와 비교하는 반복문.</strong></p>

<p>딱 이거다.</p>

<hr />

<h1 id="3-트리-전체를-훑는-것이-아니다">3. “트리 전체를 훑는 것”이 아니다</h1>

<p>많은 사람이 오해하는 부분.</p>

<p>QCompleter는 <strong>트리 전체를 자동으로 DFS/BFS 같은 걸 돌지 않는다.</strong></p>

<ul>
  <li>기본 QCompleter는 “한 레벨”만 훑는다.<br />
즉, rootIndex의 자식들만 본다.</li>
</ul>

<p>파일 경로 완성처럼 디렉터리가 중요한 경우:</p>

<ul>
  <li>프로그래머가 입력 문자열에서 디렉터리 부분을 분해해서<br />
rootIndex를 원하는 디렉터리에 직접 세팅한다.</li>
</ul>

<p>예:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">completer</span><span class="o">-&gt;</span><span class="n">setRootIndex</span><span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">(</span><span class="s">"/home"</span><span class="p">));</span>
<span class="n">completer</span><span class="o">-&gt;</span><span class="n">setCompletionPrefix</span><span class="p">(</span><span class="s">"a"</span><span class="p">);</span>
</code></pre></div></div>

<p>이렇게 해주면 QCompleter는 <strong>/home 밑의 자식들만</strong> 훑는 것.</p>

<p>트리를 재귀적으로 전부 뒤지는 일은 없다.</p>

<hr />

<h1 id="4-qcompleter가-정말-호출하는-함수들-정확하게">4. QCompleter가 정말 호출하는 함수들 (정확하게)</h1>

<p>QCompleter는 자동완성 탐색 중 이런 모델 함수를 실제로 부른다:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">rowCount(parentIndex)</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">index(row, column, parentIndex)</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">data(index, completionRole)</code></p>
  </li>
  <li>
    <p>(필요하면) <code class="language-plaintext highlighter-rouge">parent(index)</code></p>
  </li>
  <li>
    <p>(필요하면) <code class="language-plaintext highlighter-rouge">model-&gt;match(...)</code><br />
이건 일부 구현에서 문자열 찾는 데 쓰인다.</p>
  </li>
</ul>

<p>두 객체 사이의 소통은 <strong>전부 이 표준 함수들로만</strong> 이루어진다.<br />
QFileSystemModel은 아무 특별한 콜백도 제공하지 않는다.</p>

<hr />

<h1 id="5-qfilesystemmodel이-자동완성에서-잘-돌아가는-이유">5. QFileSystemModel이 자동완성에서 잘 돌아가는 이유</h1>

<p>QFileSystemModel은 모델/뷰 규약을 아주 충실히 구현한 모델이다.</p>

<ul>
  <li>
    <p>index(row, column, parent) → 디스크의 파일/디렉터리 정보</p>
  </li>
  <li>
    <p>data(index) → 파일 이름, 아이콘, 타입 등</p>
  </li>
  <li>
    <p>rowCount(parent) → 그 디렉터리 안의 파일 개수</p>
  </li>
  <li>
    <p>parent(index) → 상위 디렉터리 인덱스</p>
  </li>
</ul>

<p>즉, <strong>QCompleter가 모델에게 요구하는 모든 정보가 이미 제공되고 있다.</strong></p>

<p>그래서 QCompleter 입장에서는:</p>

<p>“얘가 파일 시스템인지 텍스트 목록인지 전혀 상관없다.<br />
난 그냥 모델을 탐색할 뿐.”</p>

<p>이 상태가 된다.</p>

<hr />

<h1 id="6-실제-슬롯시그널-기반의-연동은-거의-없다">6. 실제 슬롯/시그널 기반의 연동은 거의 없다</h1>

<p>중요한 사실:</p>

<ul>
  <li>
    <p>QCompleter와 QFileSystemModel 사이에는 “특별한 연결”이 없다.</p>
  </li>
  <li>
    <p>시그널/슬롯로 직접 통신하지 않는다.</p>
  </li>
  <li>
    <p>QCompleter는 모델의 변화를 감지하기 위해 새로운 row가 생기면<br />
modelReset(), rowsInserted(), rowsRemoved() 같은 것만 받는다.</p>
  </li>
  <li>
    <p>이것도 모든 모델이 따라야 하는 기본 규약이다.</p>
  </li>
</ul>

<p>즉, 특별한 협력 개발이 아니라 <strong>Qt 모델/뷰 패턴이 가진 보편적 구조</strong> 안에서 서로 협력할 뿐이다.</p>

<hr />

<h1 id="7-직관적-비유">7. 직관적 비유</h1>

<p>QFileSystemModel을 “커다란 책”이라고 생각하고,<br />
QCompleter를 “사서”라고 생각해보자.</p>

<ul>
  <li>
    <p>사서는 책 안의 글자를 직접 가지지 않는다.</p>
  </li>
  <li>
    <p>책이 어떤 구조인지 몰라도 된다.</p>
  </li>
  <li>
    <p>단지 “이 챕터의 페이지들을 하나씩 보여줘”라고 요청하고,</p>
  </li>
  <li>
    <p>그 페이지에 prefix가 들어 있으면 목록에 추가한다.</p>
  </li>
</ul>

<p>이게 “QModelIndex를 훑는다”는 말의 실제 의미다.</p>

<hr />

<h1 id="다음-단계로-생각할-만한-지점">다음 단계로 생각할 만한 지점</h1>

<p>지금 이해한 구조를 바탕으로,<br />
왜 네트워크 드라이브(NFS/SMB/AutoFS)에서 컴플리터가 멈출 때가 있는지,<br />
왜 model-&gt;data() 한 번이 stat()을 부를 수 있는지가<br />
이제 자연스럽게 연결될 거다.</p>

<p>원하면 “경로 자동완성에서 QFileSystemModel이 네트워크 드라이브 때문에 얼어붙을 때 우회하는 방법”도 자세히 파헤쳐 줄게.</p>

<p class="chat--user">

QCompleter를 안 쓰고 QFileSystemModel을 직접 사용하며 파일 뒤지는 예시 만들어 줄래? PySide6로

</p>

<p>좋지, 이번엔 <code class="language-plaintext highlighter-rouge">QCompleter</code> 싹 빼고 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>만 써서<br />
“디렉터리 하나를 통째로 뒤져서 파일 이름으로 검색”하는 예제를 만들어볼게.<br />
(PySide6 기준)</p>

<p>구조는 이런 식이다:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>에 루트 디렉터리 하나 세팅</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">검색어</code> 입력하고 버튼 누르면</p>
  </li>
  <li>
    <p>모델을 직접 재귀적으로 돌면서(=QModelIndex들을 훑으면서)</p>
  </li>
  <li>
    <p>파일 이름에 검색어가 들어가는 애들을 찾아 리스트에 표시</p>
  </li>
</ul>

<hr />

<h2 id="전체-예제-코드-pyside6">전체 예제 코드 (PySide6)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">QApplication</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span>
    <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QListWidget</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QLabel</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QModelIndex</span>
<span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="n">QFileSystemModel</span>

<span class="k">class</span> <span class="nc">FileSearchWindow</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">QFileSystemModel 직접 검색 예제 (PySide6)</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="c1"># 읽기 전용으로 둘게 (실제 파일 삭제/이름 변경 같은 거 안 할 거라서)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setReadOnly</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">current_root_path</span> <span class="o">=</span> <span class="sh">""</span>

        <span class="n">main_layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>

        <span class="c1"># 1) 검색 대상 디렉터리 선택 영역
</span>        <span class="n">dir_layout</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dir_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dir_edit</span><span class="p">.</span><span class="nf">setPlaceholderText</span><span class="p">(</span><span class="sh">"</span><span class="s">검색할 루트 디렉터리를 선택하세요</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">browse_btn</span> <span class="o">=</span> <span class="nc">QPushButton</span><span class="p">(</span><span class="sh">"</span><span class="s">폴더 선택</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">browse_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">choose_directory</span><span class="p">)</span>

        <span class="n">dir_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">루트 폴더:</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">))</span>
        <span class="n">dir_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dir_edit</span><span class="p">)</span>
        <span class="n">dir_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">browse_btn</span><span class="p">)</span>

        <span class="c1"># 2) 검색어 입력 영역
</span>        <span class="n">search_layout</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">keyword_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">keyword_edit</span><span class="p">.</span><span class="nf">setPlaceholderText</span><span class="p">(</span><span class="sh">"</span><span class="s">파일명에 포함될 문자열</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">search_btn</span> <span class="o">=</span> <span class="nc">QPushButton</span><span class="p">(</span><span class="sh">"</span><span class="s">검색</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">search_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">search_files</span><span class="p">)</span>

        <span class="n">search_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">검색어:</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">))</span>
        <span class="n">search_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">keyword_edit</span><span class="p">)</span>
        <span class="n">search_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">search_btn</span><span class="p">)</span>

        <span class="c1"># 3) 결과 리스트
</span>        <span class="n">self</span><span class="p">.</span><span class="n">result_list</span> <span class="o">=</span> <span class="nc">QListWidget</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>

        <span class="n">main_layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">dir_layout</span><span class="p">)</span>
        <span class="n">main_layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">search_layout</span><span class="p">)</span>
        <span class="n">main_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">검색 결과:</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">))</span>
        <span class="n">main_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">result_list</span><span class="p">)</span>

    <span class="c1"># 루트 디렉터리 선택
</span>    <span class="k">def</span> <span class="nf">choose_directory</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="p">.</span><span class="nf">getExistingDirectory</span><span class="p">(</span>
            <span class="n">self</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">검색할 루트 디렉터리 선택</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">""</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">self</span><span class="p">.</span><span class="n">current_root_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dir_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># QFileSystemModel에 루트 설정
</span>        <span class="c1"># setRootPath는 내부적으로 스캔을 시작하고, 해당 경로에 대한 인덱스를 반환한다.
</span>        <span class="n">root_index</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">root_index</span> <span class="o">=</span> <span class="n">root_index</span>  <span class="c1"># 나중에 검색 시작점으로 사용
</span>
    <span class="c1"># QFileSystemModel을 직접 돌면서 파일 찾기
</span>    <span class="k">def</span> <span class="nf">search_files</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">result_list</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">current_root_path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">result_list</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="sh">"</span><span class="s">먼저 루트 디렉터리를 선택하세요.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">keyword</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">keyword_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keyword</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">result_list</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="sh">"</span><span class="s">검색어를 입력하세요.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">keyword_lower</span> <span class="o">=</span> <span class="n">keyword</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>

        <span class="c1"># 재귀적으로 모델을 순회하는 헬퍼 호출
</span>        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">walk_model</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root_index</span><span class="p">,</span> <span class="n">keyword_lower</span><span class="p">,</span> <span class="n">matches</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">result_list</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="sh">"</span><span class="s">결과 없음.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">result_list</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">walk_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">parent_index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">,</span> <span class="n">keyword_lower</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matches</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        QFileSystemModel을 직접 순회하면서
        파일 이름에 keyword가 들어가는 항목을 찾는다.
        </span><span class="sh">"""</span>
        <span class="n">row_count</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">rowCount</span><span class="p">(</span><span class="n">parent_index</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">row_count</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">parent_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="p">.</span><span class="nf">isValid</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="n">file_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">fileName</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">keyword_lower</span> <span class="ow">in</span> <span class="n">file_name</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
                <span class="n">matches</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="c1"># 디렉터리라면 재귀적으로 들어가기
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">isDir</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">walk_model</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">keyword_lower</span><span class="p">,</span> <span class="n">matches</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="n">w</span> <span class="o">=</span> <span class="nc">FileSearchWindow</span><span class="p">()</span>
    <span class="n">w</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="nf">exec</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="이-코드에서-중요한-포인트만-콕-집어서-설명">이 코드에서 중요한 포인트만 콕 집어서 설명</h2>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>은 여전히 “파일 시스템 트리”를 들고 있는 모델일 뿐이고<br />
우리는 <code class="language-plaintext highlighter-rouge">rowCount</code>, <code class="language-plaintext highlighter-rouge">index</code>, <code class="language-plaintext highlighter-rouge">isDir</code>, <code class="language-plaintext highlighter-rouge">fileName</code>, <code class="language-plaintext highlighter-rouge">filePath</code>만 써서 직접 순회하고 있다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">walk_model</code> 함수가 바로<br />
“QModelIndex들을 쭉 훑는다”를 수동으로 구현한 부분이다.</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">rowCount(parent_index)</code>로 자식 개수 얻고</p>
      </li>
      <li>
        <p>각 row에 대해 <code class="language-plaintext highlighter-rouge">index(row, 0, parent_index)</code>로 자식 인덱스 만들고</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">fileName(index)</code> / <code class="language-plaintext highlighter-rouge">isDir(index)</code> 등을 사용</p>
      </li>
      <li>
        <p>디렉터리면 재귀 호출</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QCompleter</code>는 전혀 안 쓰이고,<br />
“검색어에 맞는 파일을 쭉 찾아서 리스트에 뿌리는” 일을 전부 우리가 직접 하고 있다.</p>
  </li>
  <li>
    <p>이 예제는 단순화를 위해 메인 스레드에서 전부 돌리는 구조라<br />
매우 큰 디렉터리를 루트로 잡으면 GUI가 버벅거릴 수 있다.</p>
  </li>
</ol>

<p>실제 앱에서 쓸 땐:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> * 검색을 `QThread`나 `QtConcurrent`로 빼서 백그라운드에서 돌리거나

 * 깊이 제한, 파일 개수 제한 등을 두는 식으로 최적화하는 게 좋다.
</code></pre></div></div>

<p>그래도 이 정도면 “QFileSystemModel만 들고 QModelIndex를 직접 굴려서 파일을 찾는 구조”는 감 잡을 수 있을 거야.<br />
여기서 살짝만 변형하면 확장자 필터, 날짜 필터, 사이즈 필터 같은 것도 전부 커스텀으로 붙일 수 있다.</p>

<p class="chat--user">

GUI 말고 간단히 input으로만 받도록 해줘.

</p>

<p>좋지, 이번엔 진짜 콘솔 앱 스타일로 가보자.<br />
QCompleter, 위젯 다 빼고 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> + <code class="language-plaintext highlighter-rouge">input()</code>만 사용하는 예제야.</p>

<p>완전 순수 CLI는 아니고, <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>이 Qt 객체라서 최소한 <code class="language-plaintext highlighter-rouge">QCoreApplication</code>은 필요해.<br />
그래도 화면에는 어떤 GUI도 안 뜨고, 터미널에서만 입출력한다.</p>

<p>아래는:</p>

<ul>
  <li>
    <p>루트 디렉터리 입력</p>
  </li>
  <li>
    <p>검색어 입력</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>을 재귀적으로 돌면서 파일명에 검색어가 포함된 경로를 전부 출력</p>
  </li>
</ul>

<p>하는 예제다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QCoreApplication</span><span class="p">,</span> <span class="n">QModelIndex</span>
<span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="n">QFileSystemModel</span>

<span class="k">def</span> <span class="nf">walk_model</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">QFileSystemModel</span><span class="p">,</span> <span class="n">parent_index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">,</span>
               <span class="n">keyword_lower</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matches</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    QFileSystemModel을 직접 순회하면서
    파일 이름에 keyword가 포함된 항목을 찾는다.
    </span><span class="sh">"""</span>
    <span class="n">row_count</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">rowCount</span><span class="p">(</span><span class="n">parent_index</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">row_count</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">parent_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="p">.</span><span class="nf">isValid</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">fileName</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword_lower</span> <span class="ow">in</span> <span class="n">file_name</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">matches</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># 디렉터리라면 재귀적으로 들어가기
</span>        <span class="k">if</span> <span class="n">model</span><span class="p">.</span><span class="nf">isDir</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="nf">walk_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">keyword_lower</span><span class="p">,</span> <span class="n">matches</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QCoreApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="n">root_path</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">검색할 루트 디렉터리를 입력하세요: </span><span class="sh">"</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">root_path</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">루트 디렉터리를 입력하지 않았습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">keyword</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">파일명에 포함될 검색어를 입력하세요: </span><span class="sh">"</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keyword</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">검색어를 입력하지 않았습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">keyword_lower</span> <span class="o">=</span> <span class="n">keyword</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">setReadOnly</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># setRootPath는 내부적으로 스캔을 시작하고,
</span>    <span class="c1"># 그 경로에 대한 인덱스를 반환한다.
</span>    <span class="n">root_index</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">walk_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">root_index</span><span class="p">,</span> <span class="n">keyword_lower</span><span class="p">,</span> <span class="n">matches</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">검색 결과가 없습니다.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">총 </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s">개 발견:</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Qt 이벤트 루프 안 돌리고 바로 종료
</span>    <span class="c1"># (여기선 비동기 업데이트를 적극적으로 쓰지 않으니 이 정도로 충분)
</span>    <span class="n">app</span><span class="p">.</span><span class="nf">quit</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>핵심 포인트만 다시 정리하면:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>은 여전히 “파일 시스템 트리 모델”이고<br />
우리는 <code class="language-plaintext highlighter-rouge">rowCount</code>, <code class="language-plaintext highlighter-rouge">index</code>, <code class="language-plaintext highlighter-rouge">fileName</code>, <code class="language-plaintext highlighter-rouge">filePath</code>, <code class="language-plaintext highlighter-rouge">isDir</code>만 써서 수동으로 순회한다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">walk_model</code>이 바로 “QModelIndex들을 직접 훑는” 부분이다.</p>
  </li>
  <li>
    <p>GUI 위젯은 전혀 안 만들고, <code class="language-plaintext highlighter-rouge">QCoreApplication</code>만 써서 Qt 내부 스레드/이벤트 준비만 해준다.</p>
  </li>
</ul>

<p>여기서 응용해서, 확장자 필터, 크기/날짜 필터, 최대 깊이 제한, 스레드 분리 같은 것들을 추가하면 꽤 그럴듯한 파일 검색 도구로 키울 수 있다.</p>]]></content><author><name>hvppyarchive</name></author><category term="qt" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">CFileDialog 구현 방법</title><link href="https://hvppyarchive.github.io/python/custom-pyside-filedialog/" rel="alternate" type="text/html" title="CFileDialog 구현 방법" /><published>2025-11-12T19:33:35+09:00</published><updated>2025-11-12T19:33:35+09:00</updated><id>https://hvppyarchive.github.io/python/custom-pyside-filedialog</id><content type="html" xml:base="https://hvppyarchive.github.io/python/custom-pyside-filedialog/"><![CDATA[<p class="chat--user">

PySide6(PyQt6)를 이용해서 나만의 QFileDialog를 만들고 싶어. 이름은 CFileDialog라고 하자. 그냥 Qt의 내장 다이얼로그와 비슷하면 돼 ## UI 설명 가장 위에는 현재 경로가 콤보 박스로 있고, 콤보박스를 누르면 하위 경로들을 선택할 수 있게 된다 예를 들어 지금 /a/b/c/d 에서 시작했으면 /a/b/c/d /a/b/c /a/b /a / 이런 식으로 나와야하고, 경로 클릭 시 그 경로로 다이얼로그 이동할 것. 그 옆에는 Back, Forward, Parent Directory, Create New Folder 버튼이 있다. 가운데 리스트뷰에는 현재 폴더의 하위 폴더, 파일들이 보인다. (모드에 따라 보이는게 다름, 폴더 선택 모드냐 파일 선택 모드냐) 아래에는 경로를 입력을 할 수 있는 LineEdit이 있고 경로 입력 시에 자동완성 될만한게 QCompleter로 나타난다. 이 때 네트워크 드라이브를 사용하므로 QCompleter가 매우 느릴 수 있는데, QCompleter의 역할을 쓰레드로 빼면 좋을 것 같음. 현재 경로에서 가장 일치하는 상위 10개 정도 경로만 Completer로 사용하고 경로가 완성되면 다시 리프레시 해서 상위 10개를 찾는 식으로 하면 좋을 것 같음. (중요) 그 아래에는 Type 선택 콤보박스가 있다. 그 외 사용법은 QFileDialog와 거의 동일하게 하면 좋겠음. 파일/폴더 얻을 지 Save용인지 Load용인지

</p>

<p>좋아요. 이건 꽤 본격적인 커스텀 다이얼로그 설계예요.<br />
PySide6(PyQt6 동일 구조)에서 Qt의 기본 <code class="language-plaintext highlighter-rouge">QFileDialog</code>를 재현하면서 더 유연하게 만들기 위해선 <strong>QDialog 기반의 클래스</strong> 로 직접 구현하는 게 가장 깔끔합니다.<br />
아래는 전체적인 구조와 주요 포인트를 단계별로 설명할게요.</p>

<hr />

<h2 id="핵심-구조-개요">핵심 구조 개요</h2>

<p><code class="language-plaintext highlighter-rouge">CFileDialog</code>는 기본적으로 <code class="language-plaintext highlighter-rouge">QDialog</code>를 상속받습니다.<br />
내부 구성요소는 다음과 같습니다.</p>

<ul>
  <li>
    <p><strong>상단 영역</strong> :</p>

    <ul>
      <li>
        <p>경로 콤보박스 (<code class="language-plaintext highlighter-rouge">QComboBox</code>)</p>
      </li>
      <li>
        <p>Back / Forward / Up / New Folder 버튼 (<code class="language-plaintext highlighter-rouge">QToolButton</code>)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>중앙 영역</strong> :</p>

    <ul>
      <li>
        <p>파일/폴더 목록 (<code class="language-plaintext highlighter-rouge">QListView</code> or <code class="language-plaintext highlighter-rouge">QTreeView</code>)</p>
      </li>
      <li>
        <p>모델은 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 사용</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>하단 영역</strong> :</p>

    <ul>
      <li>
        <p>경로 입력창 (<code class="language-plaintext highlighter-rouge">QLineEdit</code>) + 자동완성 (<code class="language-plaintext highlighter-rouge">QCompleter</code>)</p>
      </li>
      <li>
        <p>Type 선택 콤보박스 (<code class="language-plaintext highlighter-rouge">QComboBox</code>)</p>
      </li>
      <li>
        <p>확인/취소 버튼 (<code class="language-plaintext highlighter-rouge">QDialogButtonBox</code>)</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="주요-동작-설계">주요 동작 설계</h2>

<h3 id="1-경로-콤보박스">1. 경로 콤보박스</h3>

<p>현재 경로를 <code class="language-plaintext highlighter-rouge">/a/b/c/d</code> 형태로 표시하고, 클릭 시 아래처럼 보여야 함:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/</span><span class="nt">a</span><span class="o">/</span><span class="nt">b</span><span class="o">/</span><span class="nt">c</span><span class="o">/</span><span class="nt">d</span>
<span class="o">/</span><span class="nt">a</span><span class="o">/</span><span class="nt">b</span><span class="o">/</span><span class="nt">c</span>
<span class="o">/</span><span class="nt">a</span><span class="o">/</span><span class="nt">b</span>
<span class="o">/</span><span class="nt">a</span>
<span class="o">/</span>
</code></pre></div></div>

<p>이건 <code class="language-plaintext highlighter-rouge">QComboBox</code>를 매번 경로 변경 시 갱신하는 방식으로 구현 가능.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parts</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">subpath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="n">subpath</span><span class="p">)</span>
</code></pre></div></div>

<p>콤보박스에서 항목 선택 시 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>의 root를 해당 경로로 변경.</p>

<hr />

<h3 id="2-탐색-버튼들">2. 탐색 버튼들</h3>

<ul>
  <li>
    <p><strong>Back / Forward</strong> : 간단히 <code class="language-plaintext highlighter-rouge">deque</code>를 이용한 히스토리 관리.</p>
  </li>
  <li>
    <p><strong>Up (Parent)</strong> : <code class="language-plaintext highlighter-rouge">os.path.dirname(current_path)</code>로 이동.</p>
  </li>
  <li>
    <p><strong>New Folder</strong> : <code class="language-plaintext highlighter-rouge">QInputDialog.getText()</code>로 폴더명 받아 <code class="language-plaintext highlighter-rouge">os.makedirs()</code>.</p>
  </li>
</ul>

<hr />

<h3 id="3-파일폴더-리스트">3. 파일/폴더 리스트</h3>

<p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code> + <code class="language-plaintext highlighter-rouge">QListView</code> 또는 <code class="language-plaintext highlighter-rouge">QTreeView</code> 사용.<br />
선택 모드에 따라 표시되는 항목 제한 가능:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllDirs</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllEntries</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">QListView.clicked</code> 시 <code class="language-plaintext highlighter-rouge">LineEdit</code> 업데이트.</p>

<hr />

<h3 id="4-경로-입력--자동완성">4. 경로 입력 + 자동완성</h3>

<p>핵심 포인트는 <strong>QCompleter를 별도 쓰레드로 관리</strong> 하는 부분이에요.<br />
대용량 네트워크 드라이브에서 디렉토리 자동완성은 느리므로,<br />
다음과 같은 비동기 구조를 씁니다.</p>

<h4 id="worker-thread">Worker Thread</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathCompleterWorker</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="n">paths_ready</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">base_path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">walk</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">):</span>
                    <span class="n">matches</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">self</span><span class="p">.</span><span class="n">paths_ready</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">CFileDialog</code>에서 입력창 내용이 바뀔 때마다 이 쓰레드 실행 → <code class="language-plaintext highlighter-rouge">QCompleter</code> 갱신.</p>

<hr />

<h3 id="5-type-선택-콤보박스">5. Type 선택 콤보박스</h3>

<p>일반 파일 다이얼로그처럼 <code class="language-plaintext highlighter-rouge">*.txt</code>, <code class="language-plaintext highlighter-rouge">*.png</code> 등의 필터를 표시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">([</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Text Files (*.txt)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Images (*.png *.jpg)</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">currentTextChanged</code> 시 모델 필터 갱신.</p>

<hr />

<h3 id="6-qfiledialog처럼-동작하게-만들기">6. QFileDialog처럼 동작하게 만들기</h3>

<p>외부 인터페이스는 기존 QFileDialog와 유사하게:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dlg</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">dlg</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
    <span class="n">selected_path</span> <span class="o">=</span> <span class="n">dlg</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">()</span>
</code></pre></div></div>

<p>옵션:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mode</code>: <code class="language-plaintext highlighter-rouge">"open"</code> / <code class="language-plaintext highlighter-rouge">"save"</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">select_mode</code>: <code class="language-plaintext highlighter-rouge">"file"</code> / <code class="language-plaintext highlighter-rouge">"folder"</code></p>
  </li>
</ul>

<hr />

<h2 id="전체-구조-코드-예시-요약-버전">전체 구조 코드 예시 (요약 버전)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">PySide6.QtGui</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="k">class</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">select_mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_stack</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">start_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_ui</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_connect_signals</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_ui</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">CFileDialog</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 상단
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">←</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">→</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">↑</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">top_layout</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">)</span>

        <span class="c1"># 중앙
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="nc">QListView</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># 하단
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">([</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span> <span class="o">=</span> <span class="nc">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Cancel</span><span class="p">)</span>

        <span class="n">bottom_layout</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">bottom_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">)</span>
        <span class="n">bottom_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">top_layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">bottom_layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect_signals</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="n">currentTextChanged</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_load_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_up</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_back</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_forward</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_create_folder</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_clicked</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">accepted</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">rejected</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reject</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">return</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">update_path_combo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parts</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_item_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">selected_path</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>

    <span class="c1"># 기타 버튼 함수 생략 (Back, Forward, Up, etc.)
</span></code></pre></div></div>

<hr />

<p>이 설계대로라면 Qt 내장 <code class="language-plaintext highlighter-rouge">QFileDialog</code>와 거의 동일한 인터페이스를 가지되,<br />
확장성과 사용자 지정성이 훨씬 높습니다.</p>

<p>다음 단계로는 <strong>Completer를 쓰레드로 실제 연결하는 부분</strong> 을 구현해보면 완성형에 가까워집니다.<br />
원한다면 그 부분만 이어서 구체적으로 작성해드릴게요 — 쓰레드 관리(<code class="language-plaintext highlighter-rouge">QThreadPool</code> + <code class="language-plaintext highlighter-rouge">QRunnable</code>) 방식으로.</p>

<p class="chat--user">

다음 단계로 진행해줘.

</p>

<p>좋아, 바로 “자동완성 + 스레드” 단계까지 붙여서 동작하는 전체 예제를 만들어줄게.<br />
아래 코드는 PySide6 기준이며, <code class="language-plaintext highlighter-rouge">QThreadPool + QRunnable</code>로 완성 후보 10개를 비동기로 찾고, 입력이 바뀔 때마다 최신 검색만 반영되도록 <code class="language-plaintext highlighter-rouge">task_id</code>로 레이스 컨디션을 막았어. 경로 콤보/뒤로·앞으로·상위·새폴더, 파일/폴더 모드, Open/Save, Type 필터, 히스토리, 디바운스까지 들어있어.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">import</span> <span class="n">traceback</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Qt</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QModelIndex</span><span class="p">,</span>
                                 <span class="n">QTimer</span><span class="p">,</span> <span class="n">QRunnable</span><span class="p">,</span> <span class="n">QThreadPool</span><span class="p">,</span> <span class="n">QMetaObject</span><span class="p">,</span> <span class="n">Q_ARG</span><span class="p">)</span>
    <span class="kn">from</span> <span class="n">PySide6.QtGui</span> <span class="kn">import</span> <span class="n">QIcon</span>
    <span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">QApplication</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QToolButton</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span>
        <span class="n">QListView</span><span class="p">,</span> <span class="n">QTreeView</span><span class="p">,</span> <span class="n">QFileSystemModel</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QCompleter</span><span class="p">,</span>
        <span class="n">QDialogButtonBox</span><span class="p">,</span> <span class="n">QInputDialog</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QSizePolicy</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6가 필요합니다. pip install PySide6</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># --------------------------
# 비동기 컴플리터 작업자
# --------------------------
</span>
<span class="k">class</span> <span class="nc">_CompleterResultEmitter</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="n">resultsReady</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>  <span class="c1"># task_id, results 리스트(str)
</span>
<span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    입력 문자열을 기반으로 base_dir 아래에서 이름이 prefix로 시작하는 경로(파일/폴더)를
    최대 top_k개까지 찾아서 내보내는 작업. (가벼운 BFS, 얕은 탐색)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">want_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">emitter</span><span class="p">:</span> <span class="n">_CompleterResultEmitter</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="o">=</span> <span class="n">want_files</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="o">=</span> <span class="n">want_dirs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span> <span class="o">=</span> <span class="n">depth_limit</span>
        <span class="n">self</span><span class="p">.</span><span class="n">emitter</span> <span class="o">=</span> <span class="n">emitter</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="c1"># 베이스 디렉터리가 없으면 상위들을 타고 올라가며 존재하는 곳부터
</span>                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">).</span><span class="nf">resolve</span><span class="p">().</span><span class="n">parents</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># 우선 1순위: base_dir의 직접 하위
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                        <span class="c1"># 시작 접두사 매칭 (대소문자 구분 없음)
</span>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                            <span class="k">return</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># 2순위: 얕은 깊이 탐색 (depth_limit)
</span>            <span class="c1"># BFS 큐: (Path, depth)
</span>            <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">()</span>
            <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">([</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)])</span>

            <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                    <span class="c1"># 디렉터리 자체가 매칭되면 결과에
</span>                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                                            <span class="k">return</span>
                                    <span class="c1"># 하위로 진행
</span>                                    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                        <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                                        <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                                            <span class="k">return</span>
                            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                                <span class="k">continue</span>
                <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 에러는 무시하고 빈 결과
</span>            <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="c1"># UI 스레드로 안전하게 신호
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">QMetaObject</span><span class="p">.</span><span class="nf">invokeMethod</span><span class="p">(</span>
                <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">resultsReady</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
                <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">),</span>
                <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># --------------------------
# CFileDialog 본체
# --------------------------
</span>
<span class="k">class</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    모드:
      mode: </span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">save</span><span class="sh">"</span><span class="s">
      select_mode: </span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="s">
    QFileDialog와 유사한 사용법:
        dlg = CFileDialog(mode=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">, select_mode=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="s">, filters=[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">Images (*.png *.jpg)</span><span class="sh">"</span><span class="s">])
        if dlg.exec():
            print(dlg.selected_path())
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
                 <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">CFileDialog</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>  <span class="c1"># open/save
</span>        <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">select_mode</span>  <span class="c1"># file/folder
</span>        <span class="n">self</span><span class="p">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">start_path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span> <span class="k">if</span> <span class="n">start_path</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>

        <span class="c1"># completer state
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span> <span class="o">=</span> <span class="nf">_CompleterResultEmitter</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_completer_results</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span> <span class="o">=</span> <span class="n">QThreadPool</span><span class="p">.</span><span class="nf">globalInstance</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span> <span class="o">=</span> <span class="nc">QTimer</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setSingleShot</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_spawn_completer_task</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_build_ui</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_connect_signals</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_configure_modes</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- UI 구성 ----------
</span>    <span class="k">def</span> <span class="nf">_build_ui</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># 상단 툴바
</span>        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">Back</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">Forward</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">Parent</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">New Folder</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Fixed</span><span class="p">)</span>

        <span class="n">top</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">)</span>

        <span class="c1"># 중앙 파일 뷰
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>  <span class="c1"># 전체 파일 시스템
</span>        <span class="c1"># 필터는 모드에 따라 아래에서 설정
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="nc">QTreeView</span><span class="p">()</span>  <span class="c1"># 트리로 쓰되, 루트 인덱스를 현재 경로로 심어 1계층처럼 사용
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIsDecorated</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSortingEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">sortByColumn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">AscendingOrder</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSelectionBehavior</span><span class="p">(</span><span class="n">QTreeView</span><span class="p">.</span><span class="n">SelectRows</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setUniformRowHeights</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># 보조 컬럼 정리
</span>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setColumnWidth</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

        <span class="c1"># 하단: 경로 입력 + Type + 버튼
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setPlaceholderText</span><span class="p">(</span><span class="sh">"</span><span class="s">경로를 입력하세요…</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer_model</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 유지용 (디버그)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>  <span class="c1"># prefix 기반이지만 substring도 보여주면 편함
</span>        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span> <span class="o">=</span> <span class="nc">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Cancel</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

        <span class="n">bottom_row1</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">경로:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">)</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Type:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">bottom_row1</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">)</span>

    <span class="c1"># ---------- 시그널 연결 ----------
</span>    <span class="k">def</span> <span class="nf">_connect_signals</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_back</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_forward</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_up</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_create_folder</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="n">activated</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_combo_jump</span><span class="p">)</span>  <span class="c1"># 인덱스 선택 시 이동
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">doubleClicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_double_clicked</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_clicked</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="n">textEdited</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_path_edited</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="n">currentTextChanged</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_filter_changed</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">accepted</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_accept_if_valid</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">rejected</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reject</span><span class="p">)</span>

    <span class="c1"># ---------- 모드/필터 ----------
</span>    <span class="k">def</span> <span class="nf">_configure_modes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># 폴더만
</span>            <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QDir</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllDirs</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QDir</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllEntries</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>

        <span class="c1"># 이름 필터(패턴) 적용
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilterDisables</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_apply_name_filters_from_combo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># "Images (*.png *.jpg)" -&gt; ["*.png", "*.jpg"]
</span>        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">p</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">?</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilters</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_filter_changed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="c1"># ---------- 경로 로딩 ----------
</span>    <span class="k">def</span> <span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">push_history</span><span class="p">:</span>
            <span class="c1"># 히스토리 푸시
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIndex</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="c1"># OK 버튼 활성화 상태 갱신
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_combo_jump</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">itemText</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parts</span>
        <span class="c1"># 예: /, /a, /a/b, /a/b/c ... 혹은 Windows: C:\, C:\Users, ...
</span>        <span class="n">acc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
            <span class="n">acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">joined</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="o">*</span><span class="n">acc</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">joined</span><span class="p">))</span>
        <span class="c1"># 현재 경로가 가장 아래쪽에 오도록 선택
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setCurrentIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- 탐색 버튼 ----------
</span>    <span class="k">def</span> <span class="nf">_go_back</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_forward</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_up</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_folder</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="p">.</span><span class="nf">getText</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">새 폴더</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">폴더명:</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c1"># 새 폴더로 포커스 이동
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">FileExistsError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">경고</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">동일한 이름의 폴더가 이미 존재합니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">오류</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">폴더를 만들 권한이 없습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">오류</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">폴더 생성 실패: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- 뷰 클릭/더블클릭 ----------
</span>    <span class="k">def</span> <span class="nf">_item_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># 미리보듯 경로창에 반영
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_item_double_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 파일이면 경로창에 넣고 OK
</span>            <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>

    <span class="c1"># ---------- OK 유효성 ----------
</span>    <span class="k">def</span> <span class="nf">_is_selection_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># 폴더 선택 모드
</span>            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="c1"># Save 모드에서는 새 폴더명도 허용할지? 여기선 폴더 존재만 허용
</span>            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># 파일 선택 모드
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># 존재하고, 파일이어야 함
</span>            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="c1"># 필터도 통과해야 함
</span>                <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># save 모드: 존재 여부 무관, 상위 폴더가 있어야 함
</span>            <span class="n">parent</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">parent</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">parent</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
                <span class="c1"># 파일명 필터도 통과하는지(선택한 필터와 맞지 않아도 저장 허용할지 정책 결정)
</span>                <span class="c1"># 여기서는 허용(사용자가 필터 바꾸지 않고 확장자 직접 입력 가능)
</span>                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_match_type_filters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="c1"># 괄호 안 패턴들 추출
</span>        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_update_ok_enabled</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">ok_btn</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="nf">button</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span><span class="p">)</span>
        <span class="n">ok_btn</span><span class="p">.</span><span class="nf">setEnabled</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_accept_if_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택 확인</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택이 유효하지 않습니다.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- 경로 입력 + 비동기 자동완성 ----------
</span>    <span class="k">def</span> <span class="nf">_on_path_edited</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="c1"># 디바운스 후 검색 태스크 실행
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="c1"># 입력 중에도 OK 버튼 상태 적절히 조정
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">model</span><span class="p">().</span><span class="nf">setStringList</span><span class="p">([])</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">model</span><span class="p">()</span> <span class="k">else</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="nc">QCompleter</span><span class="p">([],</span> <span class="n">self</span><span class="p">).</span><span class="nf">model</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="c1"># base_dir와 prefix 분리
</span>        <span class="c1"># 예: "/a/b/pa" -&gt; base="/a/b", prefix="pa"
</span>        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">!=</span> <span class="sh">""</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

        <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># 항상 디렉터리도 제안: 경로 완성에 중요
</span>        <span class="n">top_k</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">depth_limit</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 너무 깊이 들어가면 느려짐
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span>
        <span class="n">task</span> <span class="o">=</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                              <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">,</span>
                              <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># 최신 요청만 반영
</span>        <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># 결과를 가까운 경로부터 정렬(문자열 길이/사전식)
</span>        <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
        <span class="c1"># QCompleter 갱신
</span>        <span class="n">model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">model</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">and</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="sh">'</span><span class="s">setStringList</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">model</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">string_list_model</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">model</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">string_list_model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>  <span class="c1"># 팝업 열기 시도
</span>
    <span class="c1"># ---------- 외부 API ----------
</span>    <span class="k">def</span> <span class="nf">selected_path</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>

<span class="c1"># --------------------------
# 실행 예시
# --------------------------
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># 사용 예시 1: 파일 Open
</span>    <span class="n">dlg1</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Text Files (*.txt *.md)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Images (*.png *.jpg *.jpeg *.bmp *.gif)</span><span class="sh">"</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OPEN FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># 사용 예시 2: 폴더 선택
</span>    <span class="n">dlg2</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SELECT FOLDER:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># 사용 예시 3: 파일 Save
</span>    <span class="n">dlg3</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">save</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Python (*.py)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SAVE FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>설명 포인트 정리</p>

<ul>
  <li>
    <p>자동완성 비동기화<br />
입력이 바뀌면 200ms 디바운스 후 <code class="language-plaintext highlighter-rouge">QThreadPool</code>에 <code class="language-plaintext highlighter-rouge">PathSearchTask</code>를 던져서, 현재 입력 기준 <code class="language-plaintext highlighter-rouge">base_dir</code> 아래에서 이름이 접두사로 맞는 경로들을 최대 10개 찾는다. 결과는 <code class="language-plaintext highlighter-rouge">task_id</code>로 최신성 확인 후에만 <code class="language-plaintext highlighter-rouge">QCompleter</code> 모델을 갱신한다. 네트워크 드라이브처럼 느린 환경에서도 메인 스레드를 막지 않으면서 점진적으로 후보를 보여준다.</p>
  </li>
  <li>
    <p>후보 품질<br />
1순위로 현재 폴더의 직속 항목을 살피고, 부족하면 얕은 깊이(기본 2)만 BFS로 확장해 근처 경로를 제안한다. 정렬은 길이→사전식으로 해서 더 “가까운” 경로가 먼저 온다.</p>
  </li>
  <li>
    <p>필터<br />
<code class="language-plaintext highlighter-rouge">Type</code> 콤보박스의 패턴을 <code class="language-plaintext highlighter-rouge">QFileSystemModel.setNameFilters</code>로 적용했다. Open 파일 모드에서는 OK 직전에도 파일명이 패턴과 맞는지 빠르게 확인한다.</p>
  </li>
  <li>
    <p>동작 정책<br />
Open+File: 존재하는 파일만 OK.<br />
Open+Folder: 존재하는 폴더만 OK.<br />
Save+File: 상위 폴더만 존재하면 OK(파일은 없어도 됨).<br />
Save+Folder 정책은 예제에선 막아두었는데, 원하면 옵션으로 허용 로직을 추가할 수 있다.</p>
  </li>
  <li>
    <p>경로 콤보<br />
현재 경로의 루트부터 단계적으로 쌓아서 표시한다. 항목 선택 시 해당 경로로 점프한다. 히스토리 Back/Forward, 상위 이동, 새 폴더도 지원한다.</p>
  </li>
</ul>

<p>다음 확장 아이디어</p>

<ul>
  <li>
    <p>네트워크 드라이브에서 <code class="language-plaintext highlighter-rouge">depth_limit</code>를 동적으로 조절(지연 길이에 따라 1↔3).</p>
  </li>
  <li>
    <p>숨김 파일 토글, 최근 위치/즐겨찾기 사이드바 추가.</p>
  </li>
  <li>
    <p>멀티 선택 지원(파일 다중 선택 모드).</p>
  </li>
  <li>
    <p>Windows 드라이브 루트(“C:\”, “D:\”) 목록을 콤보에 자동 삽입.</p>
  </li>
</ul>

<p>추가로 원하는 동작 정책이나 세부 UX가 있으면 말해줘. 바로 코드에 녹여서 완성도를 더 끌어올려볼게.</p>

<p class="chat--user">

혹시 더 좋은 개발 방향 있어?

</p>

<p>좋지! 지금도 꽤 쓸만하지만, “더 견고하고 빠르고 확장 가능한” 방향으로 다듬을 수 있는 포인트들을 제안할게. 당장 적용할 수 있는 것부터 중장기적인 리팩터링 아이디어까지, 실전적인 순서로 정리했어.</p>

<h1 id="성능안정성">성능·안정성</h1>

<ol>
  <li>캐싱과 취소 토큰</li>
</ol>

<ul>
  <li>
    <p>자동완성 후보 탐색 결과를 디렉터리 단위로 캐시하고, mtime(디렉터리 수정 시간) + 사이즈로 신선도 체크.</p>
  </li>
  <li>
    <p>현재 task_id 방식은 최신성 보장은 되지만, 쓰레드가 불필요하게 계속 돈다는 단점이 있어. <code class="language-plaintext highlighter-rouge">PathSearchTask</code>에 <code class="language-plaintext highlighter-rouge">cancelled</code> 플래그(쓰레드 안전) 넣어서 오래 걸리는 네트워크 디렉터리 탐색을 중간 취소 가능하게 만들면 대기시간을 크게 줄일 수 있어.</p>
  </li>
</ul>

<ol>
  <li>점진적 자동완성(Incremental feed)</li>
</ol>

<ul>
  <li>한 번에 10개를 찾을 때까지 도는 대신, 3개 단위로 먼저 emit → UI 갱신 → 남은 후보 계속 탐색. 사용자는 즉시 반응을 보게 되고, 나머지는 뒤늦게 채워진다.</li>
</ul>

<ol>
  <li>QFileSystemWatcher 연동</li>
</ol>

<ul>
  <li>루트 인덱스 기준으로 하위 디렉터리에 변화가 생기면 캐시를 무효화하고 리스트뷰를 부드럽게 갱신. 네트워크 환경에서도 변화를 즉시 반영할 수 있다.</li>
</ul>

<ol>
  <li>아이콘·메타데이터 지연 로딩</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>의 아이콘 로딩은 느릴 수 있다. <code class="language-plaintext highlighter-rouge">QFileIconProvider</code>를 상속해 썸네일·아이콘을 별도 스레드에서 지연 로딩하고, 임시 기본 아이콘을 먼저 보여주면 스크롤 지연이 줄어든다.</li>
</ul>

<ol>
  <li>대용량 폴더 가상화</li>
</ol>

<ul>
  <li>수만 개 항목이 있는 디렉터리에서는 모든 항목을 모델에 올리는 것만으로도 느려진다. <code class="language-plaintext highlighter-rouge">QSortFilterProxyModel</code>로 가볍게 필터링하고, 스크롤 위치에 따라 보이는 구간만 프리페치하는 “페이징/윈도우링” 기법을 적용하면 체감 성능이 크게 좋아진다.</li>
</ul>

<h1 id="아키텍처유지보수">아키텍처·유지보수</h1>

<ol>
  <li>모델/뷰 분리 강화</li>
</ol>

<ul>
  <li>현재는 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 하나로 대부분 해결 중. 여기에 “선택 정책”, “필터 정책”, “히스토리/네비게이션 정책”을 얹은 서비스 계층(작은 클래스로) 분리하면 테스트 용이성↑.<br />
예) <code class="language-plaintext highlighter-rouge">NavigationHistory</code>, <code class="language-plaintext highlighter-rouge">FilterPolicy</code>, <code class="language-plaintext highlighter-rouge">SelectionValidator</code>, <code class="language-plaintext highlighter-rouge">CompleterProvider</code>.</li>
</ul>

<ol>
  <li>인터페이스 호환성 레이어</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QFileDialog.getOpenFileName()</code> 같은 정적 API와 호환되는 래퍼 제공.<br />
예) <code class="language-plaintext highlighter-rouge">CFileDialog.getOpenFileName(parent, caption, dir, filter)</code> 형태로 반환 타입도 동일하게 맞춰주면 기존 코드 치환이 쉽다.</li>
</ul>

<ol>
  <li>유연한 플러그인 필터</li>
</ol>

<ul>
  <li>단순 패턴 필터(“*.png”) 외에 사용자 정의 필터 콜백을 지원.<br />
예) “최근 24시간 수정” “크기 100MB 이상” 같은 조건을 추가 필터로 끼워 넣기.</li>
</ul>

<ol>
  <li>테스트 전략</li>
</ol>

<ul>
  <li>로컬/네트워크 파일시스템을 흉내내는 가짜 파일시스템(fsys) 어댑터 도입. 비즈니스 로직을 fs 어댑터 인터페이스에 의존하게 하고, 테스트에서는 메모리상 가짜 트리로 검증.</li>
</ul>

<h1 id="ux탐색성">UX·탐색성</h1>

<ol>
  <li>브레드크럼(breadcrumbs) 위젯</li>
</ol>

<ul>
  <li>현재 경로 콤보는 좋지만, 클릭 가능한 조각(폴더 단추들)로 표시하면 상위로 점프가 더 직관적. 드래그로 하위 펼치기까지 지원하면 금상첨화.</li>
</ul>

<ol>
  <li>Places/사이드바</li>
</ol>

<ul>
  <li>홈, 데스크톱, 다운로드, 드라이브 루트, 즐겨찾기(핀), 최근 위치 섹션 추가. Qt의 <code class="language-plaintext highlighter-rouge">QFileDialog</code>가 주는 경험을 재현하면서도 커스텀화 가능.</li>
</ul>

<ol>
  <li>키보드 내비게이션</li>
</ol>

<ul>
  <li>F2: 이름 바꾸기, Del: 삭제(옵션), Alt+↑: 상위, Alt+←/→: 뒤/앞, Ctrl+L: 경로 포커스 같은 단축키. 텍스트 사용자가 특히 빨라진다.</li>
</ul>

<ol>
  <li>멀티선택</li>
</ol>

<ul>
  <li>파일 모드에서 다중 선택을 옵션으로 지원하고, 하단에 선택 개수/합계 크기 표시. 저장 모드에서도 “여러 개를 한 번에”는 보통 허용하지 않지만 옵션으로 노출 가능.</li>
</ul>

<ol>
  <li>자동완성 UX 디테일</li>
</ol>

<ul>
  <li>탭(Tab)으로 첫 후보 자동완성, 오른쪽 화살표로 경로 구분자 자동 삽입, 끝에 구분자 입력 시 즉시 상위 10개 하위 디렉터리 재검색 등 타자 흐름 최적화.</li>
</ul>

<h1 id="네트워크플랫포옴-고려">네트워크·플랫포옴 고려</h1>

<ol>
  <li>UNC/SMB·리눅스 마운트·맥 볼륨</li>
</ol>

<ul>
  <li>Windows UNC 경로(\server\share) 파싱과 자동완성, Linux의 /mnt, macOS의 /Volumes 감지. 네트워크 드라이브는 depth_limit을 기본 1로, 지연 시간 측정 후 동적 확장.</li>
</ul>

<ol>
  <li>심볼릭 링크·순환 방지</li>
</ol>

<ul>
  <li>BFS에서 symlink는 별도 세트로 추적, 같은 inode/경로 해시 재방문 방지. 네트워크에서 링크 루프가 있을 수 있으니 필수.</li>
</ul>

<ol>
  <li>긴 경로 지원(Windows)</li>
</ol>

<ul>
  <li>260자 제한 우회(\?\ prefix) 처리 옵션.</li>
</ul>

<ol>
  <li>권한·락 대응</li>
</ol>

<ul>
  <li>PermissionError는 이미 처리했지만, 저장 모드에서 파일 덮어쓰기 경고, 읽기전용 폴더 알림, 네트워크 타임아웃 후 재시도 버튼 같은 UX를 추가.</li>
</ul>

<h1 id="접근성현지화브랜딩">접근성·현지화·브랜딩</h1>

<ol>
  <li>접근성</li>
</ol>

<ul>
  <li>각 버튼에 <code class="language-plaintext highlighter-rouge">accessibleName/Description</code> 설정, 포커스 인디케이터 가시성 강화, 스크린리더 라벨링.</li>
</ul>

<ol>
  <li>현지화(i18n)</li>
</ol>

<ul>
  <li>문자열 분리와 <code class="language-plaintext highlighter-rouge">QTranslator</code> 적용 포인트 마련.</li>
</ul>

<ol>
  <li>테마/다크모드</li>
</ol>

<ul>
  <li>아이콘 대비, 선택 하이라이트, 고해상도 스케일링(HiDPI) 보정.</li>
</ul>

<h1 id="디테일-코드-아이디어">디테일 코드 아이디어</h1>

<ol>
  <li>취소 가능한 탐색 태스크 스텁</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">...,</span> <span class="n">cancel_flag</span><span class="p">):</span>
        <span class="bp">...</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="n">cancel_flag</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nf">slow_scan</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">.</span><span class="nf">is_set</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="bp">...</span>
</code></pre></div></div>

<ul>
  <li>새 요청이 들어오면 이전 태스크의 <code class="language-plaintext highlighter-rouge">cancel_flag.set()</code> 호출.</li>
</ul>

<ol>
  <li>캐시 키와 무효화</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">)</span>
<span class="n">entries</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span> <span class="ow">or</span> <span class="n">meta</span> <span class="o">!=</span> <span class="p">(</span><span class="nf">mtime</span><span class="p">(</span><span class="n">base_dir</span><span class="p">),</span> <span class="nf">dir_size_estimate</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)):</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="nf">list_dir_fast</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="p">(</span><span class="nf">mtime</span><span class="p">(...),</span> <span class="nf">dir_size_estimate</span><span class="p">(...)))</span>
</code></pre></div></div>

<ol>
  <li>사용자 정의 필터 콜백</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">set_custom_filters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predicates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">QFileInfo</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]):</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_predicates</span> <span class="o">=</span> <span class="n">predicates</span>
<span class="c1"># proxy model의 filterAcceptsRow에서 모든 predicate AND 매칭
</span></code></pre></div></div>

<ol>
  <li>브레드크럼</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QToolButton</code>들을 동적으로 생성하고, 눌렀을 때 그 조각까지의 경로로 이동. 버튼에 메뉴(하위 디렉터리 미리보기) 연결하면 빠른 점프 가능.</li>
</ul>

<h1 id="단계별-적용-추천">단계별 적용 추천</h1>

<ul>
  <li>
    <p>1단계: 자동완성 취소·캐시·점진적 갱신</p>
  </li>
  <li>
    <p>2단계: 브레드크럼 + Places 사이드바 + 단축키</p>
  </li>
  <li>
    <p>3단계: 아이콘 지연 로딩 + 대용량 폴더 가상화</p>
  </li>
  <li>
    <p>4단계: 플러그인 필터·테스트 인프라·i18n</p>
  </li>
</ul>

<p>원하면 1단계(취소 가능한 자동완성 + 캐시 + 점진 emit) 코드를 네 가지 메소드만 바꿔서 바로 패치 가능한 형태로 제공할게.</p>

<p class="chat--user">

Q_ARG에서 에러나

</p>

<p>문제 포인트는 여기예요:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QMetaObject</span><span class="p">.</span><span class="nf">invokeMethod</span><span class="p">(</span>
    <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">,</span> <span class="sh">"</span><span class="s">resultsReady</span><span class="sh">"</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
    <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">),</span>
    <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div>

<p>PySide6에서 <code class="language-plaintext highlighter-rouge">Q_ARG(list, …)</code>는 자주 실패합니다. Qt 메타시스템이 Python의 <code class="language-plaintext highlighter-rouge">list</code> 타입을 몰라서예요. 또한 이 경우 굳이 <code class="language-plaintext highlighter-rouge">QMetaObject.invokeMethod</code>를 쓸 필요가 없습니다. 스레드 간 <code class="language-plaintext highlighter-rouge">Signal.emit()</code> 자체가 안전하게 큐드(queued)로 동작합니다.</p>

<p>가장 간단하고 견고한 수정은 다음 두 가지 중 하나입니다.</p>

<h1 id="해결-a-그냥-시그널-emit으로-바꾸기권장">해결 A: 그냥 시그널 emit으로 바꾸기(권장)</h1>

<p><code class="language-plaintext highlighter-rouge">PathSearchTask._emit()</code>을 이렇게 바꾸세요:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="c1"># 워커(쓰레드)에서 emit하면 자동으로 QueuedConnection으로 전달됨
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>그리고 <code class="language-plaintext highlighter-rouge">from PySide6.QtCore import QMetaObject, Q_ARG</code> 임포트는 제거해도 됩니다.</p>

<p>이게 가장 깔끔하고 PySide6에서 권장되는 방식입니다.</p>

<h1 id="해결-b-invokemethod를-꼭-쓰고-싶다면">해결 B: invokeMethod를 꼭 쓰고 싶다면</h1>

<p><code class="language-plaintext highlighter-rouge">list</code> 같은 파이썬 컨테이너는 메타시스템에 등록되어 있지 않아서 타입 자리에 <code class="language-plaintext highlighter-rouge">object</code>를 써야 합니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QMetaObject</span><span class="p">,</span> <span class="n">Q_ARG</span>

<span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">QMetaObject</span><span class="p">.</span><span class="nf">invokeMethod</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">,</span> <span class="sh">"</span><span class="s">resultsReady</span><span class="sh">"</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
            <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">),</span>
            <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span>   <span class="c1"># 핵심: list 대신 object
</span>        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>이 방식도 동작하긴 하지만, A안처럼 그냥 <code class="language-plaintext highlighter-rouge">emit()</code>을 쓰는 편이 덜 번거롭고 실전에서 오류가 적습니다.</p>

<h1 id="추가로-함께-고치면-좋은-부분">추가로 함께 고치면 좋은 부분</h1>

<p><code class="language-plaintext highlighter-rouge">QCompleter</code>에 문자열 목록을 넣을 때는 <code class="language-plaintext highlighter-rouge">QStringListModel</code> 하나를 재사용하는 게 좋아요.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QStringListModel</span>

<span class="c1"># __init__에서
</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

<span class="c1"># 결과 수신 슬롯에서
</span><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<p>이렇게 하면 모델 재생성에 따른 깜빡임·오버헤드도 줄고, 타입 문제도 사라집니다.</p>

<p>원인 요약: <code class="language-plaintext highlighter-rouge">Q_ARG(list, …)</code> 때문에 생긴 타입 미스매치입니다. 스레드-세이프 신호를 직접 <code class="language-plaintext highlighter-rouge">emit()</code>하거나, <code class="language-plaintext highlighter-rouge">Q_ARG(object, …)</code>로 바꾸면 해결됩니다. 다음에 끊기는 곳이 있으면 에러 메시지 전문을 알려줘요. traceback 기준으로 맞는 패치를 바로 찍어드릴게요.</p>

<p class="chat--user">

아니 왜 툴이 멈추는거지 자꾸 /user/ 만 치면 멈춰

</p>

<p>멈춤 증상은 보통 세 가지 원인에서 터집니다.</p>

<ol>
  <li>
    <p>비존재/네트워크 경로에서의 과도한 스캔</p>
  </li>
  <li>
    <p>결과 적용 시 메인 스레드 쪽 재진입(Completer 팝업/모델 갱신)</p>
  </li>
  <li>
    <p>이전 태스크가 계속 돌아가는 상태에서 새 태스크가 누적(취소 불가)</p>
  </li>
</ol>

<p>아래 패치로 한 번에 잡을 수 있어요. 핵심은 취소 토큰, 안전한 모델 갱신, 루트(/)·빈 접두사에서의 스캔 억제입니다.</p>

<h1 id="1-취소-가능한-태스크--qstringlistmodel-재사용">1) 취소 가능한 태스크 + QStringListModel 재사용</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__ 에 추가
</span><span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QStringListModel</span>
<span class="kn">import</span> <span class="n">threading</span>

<span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

<span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># 태스크 취소 토큰
</span></code></pre></div></div>

<h1 id="2-빈-접두사루트-경로에서의-스캔-제한">2) 빈 접두사/루트 경로에서의 스캔 제한</h1>

<p>접두사가 비거나 1글자일 때, 그리고 베이스가 루트일 때는 “직접 하위만” 보거나 아예 스캔을 건너뜁니다. 특히 “/user/” 같이 존재하지 않는 경로를 입력하면 베이스가 “/”로 폴백되는데, 이때 전체 BFS가 급발진할 수 있어서 막아야 해요.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span>
                 <span class="n">top_k</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">,</span> <span class="n">emitter</span><span class="p">,</span> <span class="n">cancel_flag</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="o">=</span> <span class="n">want_files</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="o">=</span> <span class="n">want_dirs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span> <span class="o">=</span> <span class="n">depth_limit</span>
        <span class="n">self</span><span class="p">.</span><span class="n">emitter</span> <span class="o">=</span> <span class="n">emitter</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cancel_flag</span> <span class="o">=</span> <span class="n">cancel_flag</span>

    <span class="k">def</span> <span class="nf">_cancelled</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">cancel_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">cancel_flag</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">)</span>
            <span class="c1"># resolve()는 네트워크/비존재 경로에서 멈출 수 있어 생략하고 exists()만 사용
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="c1"># 존재하는 가장 가까운 상위로 폴백
</span>                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">base</span><span class="p">.</span><span class="n">parents</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>

            <span class="c1"># 안전장치: 루트에서 접두사 길이 &lt; 2 인 경우는 탐색하지 않음
</span>            <span class="n">is_root</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 윈도는 필요 시 확장
</span>            <span class="n">shallow_only</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">is_root</span>

            <span class="c1"># 1) 직속 항목만 먼저
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># 2) 접두사가 충분히 길고 루트가 아니면 얕은 BFS
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">shallow_only</span><span class="p">:</span>
                <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">()</span>
                <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
                <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                    <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                                <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                        <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
                    <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                        <span class="k">continue</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="c1"># 스레드에서 emit하면 자동으로 QueuedConnection
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<h1 id="3-새-입력이-오면-이전-태스크-즉시-취소">3) 새 입력이 오면 이전 태스크 즉시 취소</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
        <span class="k">return</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

    <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">top_k</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">depth_limit</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># 이전 태스크 취소
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span>
    <span class="n">task</span> <span class="o">=</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                          <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">,</span>
                          <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="4-결과-적용은-가볍게-팝업-열기는-조건부">4) 결과 적용은 가볍게, 팝업 열기는 조건부</h1>

<p>팝업을 무조건 열면 입력 중 포커스/선택과 충돌할 수 있어요. 결과가 있을 때, 에디트가 포커스를 가지고 있을 때만 팝업을 열도록 합니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results_sorted</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="5-디바운스-상향--user-같은-오타-보호">5) 디바운스 상향 + “/user/” 같은 오타 보호</h1>

<p>입력이 루트로 폴백될 상황에서 자주 스캔하지 않도록 디바운스를 300~400ms로 올리고, 잘 알려진 루트 후보가 아닌 경우 빈 결과를 줍니다. 예를 들어 macOS는 “/Users”, Linux는 “/usr”, Windows는 “\server\share” 패턴만 허용.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__
</span><span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>

<span class="c1"># _spawn_completer_task 시작부
</span><span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">/user/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/usr/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/Users</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">):</span>  <span class="c1"># 필요 시 규칙 확장
</span>    <span class="c1"># 루트/의심 경로는 빈 후보로
</span>    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
    <span class="k">return</span>
</code></pre></div></div>

<p>이 정도만 반영해도 “/user/” 타이핑 시 전체가 멈추는 현상은 사라질 겁니다. 그래도 멈춘다면 로그를 잠깐 추가해서 어느 단계에서 막히는지 보죠.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">logging</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="c1"># PathSearchTask.run() 주요 단계마다
</span><span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">scan base=</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s"> prefix=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="si">}</span><span class="sh">'</span><span class="s"> shallow_only=</span><span class="si">{</span><span class="n">shallow_only</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># _on_completer_results
</span><span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">results[</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s">]: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>추가 힌트<br />
QFileSystemModel도 대용량 루트에서 초기 스캔이 무겁습니다. 입력창 타이핑만으로 멈춘다면, 뷰의 루트 인덱스를 건드리는 코드가 텍스트 편집 흐름 중에 불려서 모델 프리페치가 겹치는지 확인하세요. 타이핑 중에는 <code class="language-plaintext highlighter-rouge">_load_path()</code>가 호출되지 않게(즉, <code class="language-plaintext highlighter-rouge">textEdited</code> 경로에서 루트 변경 금지) 한 번 더 점검하면 좋아요.</p>

<p class="chat--user">

근데 어디서 freeze가 발생하는건지 모르겠어

</p>

<p>가능한 “멈춤 지점”을 빨리 pinpoint하려면, 추측 말고 관측 장비를 꽂아야 해요. 아래 순서대로 넣으면 어디서 멈추는지 10분 안에 알아냅니다.</p>

<h1 id="어디서-얼어붙는지-지도-만들기">어디서 얼어붙는지 지도 만들기</h1>

<p>관찰 포인트는 보통 이 6곳입니다.</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">textEdited</code> → 디바운스 타이머</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_spawn_completer_task</code> 진입부</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">PathSearchTask.run()</code>의 <code class="language-plaintext highlighter-rouge">os.scandir</code> 루프</p>
  </li>
  <li>
    <p>워커 → 메인으로 전달(<code class="language-plaintext highlighter-rouge">emit</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_on_completer_results</code>에서 모델 갱신(<code class="language-plaintext highlighter-rouge">QStringListModel.setStringList</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QCompleter.complete()</code> 팝업 열기</p>
  </li>
</ol>

<p>여기부터는 바로 붙여 넣을 수 있는 계측 코드예요.</p>

<h2 id="1-전역-로깅스톱워치-설정">1) 전역 로깅/스톱워치 설정</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 파일 맨 위쪽
</span><span class="kn">import</span> <span class="n">logging</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">faulthandler</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="sh">"</span><span class="s">%(asctime)s.%(msecs)03d [%(threadName)s] %(levelname)s: %(message)s</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">datefmt</span><span class="o">=</span><span class="sh">"</span><span class="s">%H:%M:%S</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># GUI 스레드가 정지했을 때 스택 덤프하기 (리눅스/맥)
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">faulthandler</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGUSR1</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>터미널에서 멈췄다고 느낄 때 리눅스/맥이면 <code class="language-plaintext highlighter-rouge">kill -USR1 &lt;pid&gt;</code>를 치면 모든 스레드 스택이 출력돼요. 윈도우라면 아래 단축키로 덤프하게 하면 됩니다.</p>

<h2 id="2-gui-이벤트-루프가-실제로-멈췄는지-감지워치독">2) GUI 이벤트 루프가 실제로 멈췄는지 감지(워치독)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CFileDialog.__init__ 끝에 추가
</span><span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span> <span class="o">=</span> <span class="nc">QTimer</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>  <span class="c1"># 0.2초마다 heartbeat++
</span><span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nf">setattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">_heartbeat</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="c1"># 1초마다 GUI가 살아있는지 백그라운드 스레드에서 체크
</span><span class="k">def</span> <span class="nf">_watch_gui</span><span class="p">():</span>
    <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">GUI event loop stalled ≥1s</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">cur</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_watch_gui</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">GUI-Watchdog</span><span class="sh">"</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">t</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre></div></div>

<p>로그에 “stalled”가 찍히면 진짜 메인스레드가 멈춘 겁니다. 안 찍히면 워커가 오래 걸리거나, <code class="language-plaintext highlighter-rouge">complete()</code> 같은 호출이 포커스 충돌로 느려지는 케이스일 가능성이 큽니다.</p>

<h2 id="3-각-단계-계측-로그">3) 각 단계 계측 로그</h2>

<h3 id="3-1-입력태스크-생성">3-1) 입력→태스크 생성</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_on_path_edited</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">EDIT text=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SPAWN text=</span><span class="sh">'</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
    <span class="n">start_t</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>

    <span class="c1"># 기존 취소
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="c1"># base_dir, prefix 계산
</span>    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">text</span><span class="p">,</span> <span class="sh">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SPAWN base=</span><span class="sh">'</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="sh">'</span><span class="s"> prefix=</span><span class="sh">'</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span>
    <span class="n">task</span> <span class="o">=</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                          <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SPAWN dispatched in </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">start_t</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-2-워커-내부">3-2) 워커 내부</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] start base=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="si">}</span><span class="sh">'</span><span class="s"> prefix=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">)</span>  <span class="c1"># resolve()는 멈출 수 있어 생략
</span>            <span class="c1"># 1) 직속
</span>            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> 
                            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] cancelled during scandir</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">return</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] direct children took </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; results=</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># 2) BFS는 길면 여기서 오래 걸림
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,):</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
                <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">([(</span><span class="n">base</span><span class="p">,</span><span class="mi">0</span><span class="p">)])</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
                <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span>
                        <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] cancelled during BFS</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                                <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span> <span class="k">break</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                        <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span> <span class="k">break</span>
                    <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] BFS took </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; results=</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] total </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; emit </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-3-결과-적용부">3-3) 결과 적용부</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">RESULTS task=</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s"> latest=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="si">}</span><span class="s"> count=</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s"> focus=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">results_sorted</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">APPLY setStringList </span><span class="si">{</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; complete </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="4-루트의심-경로-차단-규칙-추가">4) 루트·의심 경로 차단 규칙 추가</h2>

<p>“/user/” 같은 오타가 루트 스캔으로 번지는 걸 방지합니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">/user/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/users</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/usr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">SPAWN short-circuit: suspicious root-ish path</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
        <span class="k">return</span>
    <span class="bp">...</span>
</code></pre></div></div>

<h2 id="5-수사-가이드라인">5) 수사 가이드라인</h2>

<p>로그를 켠 상태에서 직접 타이핑해 보세요.</p>

<ul>
  <li>
    <p>로그가 <code class="language-plaintext highlighter-rouge">RESULTS ...</code>까진 잘 나오는데 화면이 버벅이면, <code class="language-plaintext highlighter-rouge">setStringList</code>나 <code class="language-plaintext highlighter-rouge">complete()</code>가 범인입니다.<br />
해결: 후보가 0개일 땐 <code class="language-plaintext highlighter-rouge">complete()</code> 호출 금지, 후보 수를 200개 이상으로 만들지 않기, 팝업이 열려 있을 때만 <code class="language-plaintext highlighter-rouge">complete()</code> 호출.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">TASK ... direct children took ... BFS took ...</code>가 수백~수천 ms로 길면 워커가 네트워크 경로를 훑느라 오래 걸립니다.<br />
해결: <code class="language-plaintext highlighter-rouge">depth_limit=1</code>, prefix 길이 2 미만이면 BFS 금지, 혹은 “직속 하위만”으로 제한.</p>
  </li>
  <li>
    <p>“GUI event loop stalled ≥1s”가 뜨면 메인 스레드가 막힌 겁니다. 이때 SIGUSR1(리눅스/맥)이나 아래 단축키로 스택을 덤프해 원인을 봅니다.</p>
  </li>
</ul>

<h2 id="6-모든-스레드-스택을-단축키로-덤프윈도우-포함">6) 모든 스레드 스택을 단축키로 덤프(윈도우 포함)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CFileDialog._build_ui() 마지막쯤
</span><span class="n">QShortcut</span> <span class="o">=</span> <span class="nf">__import__</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6.QtGui</span><span class="sh">"</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">QShortcut</span><span class="sh">"</span><span class="p">]).</span><span class="n">QShortcut</span>
<span class="n">QKeySequence</span> <span class="o">=</span> <span class="nf">__import__</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6.QtGui</span><span class="sh">"</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">QKeySequence</span><span class="sh">"</span><span class="p">]).</span><span class="n">QKeySequence</span>
<span class="n">dump_shortcut</span> <span class="o">=</span> <span class="nc">QShortcut</span><span class="p">(</span><span class="nc">QKeySequence</span><span class="p">(</span><span class="sh">"</span><span class="s">F12</span><span class="sh">"</span><span class="p">),</span> <span class="n">self</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_dump</span><span class="p">():</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">=== STACK DUMP REQUESTED ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">faulthandler</span><span class="p">.</span><span class="nf">dump_traceback</span><span class="p">(</span><span class="n">all_threads</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">faulthandler dump failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">dump_shortcut</span><span class="p">.</span><span class="n">activated</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">_dump</span><span class="p">)</span>
</code></pre></div></div>

<p>F12를 누르면 현재 모든 스레드의 파이썬 스택이 출력됩니다. 거기에 <code class="language-plaintext highlighter-rouge">QFileSystemModel.index()</code>, <code class="language-plaintext highlighter-rouge">QCompleter.complete()</code>, <code class="language-plaintext highlighter-rouge">os.scandir()</code> 등이 보이면 범인이 명확해져요.</p>

<hr />

<p>이 계측을 넣고 타이핑해 보면, 멈춤이 1) 워커 과부하인지, 2) 결과 적용(모델/컴플리터)에서 포커스 재진입 문제인지, 3) 루트 스캔 폭주인지 바로 드러납니다. 로그 몇 줄만 붙여 주면, 그에 맞춰 해당 지점을 수술해서 완전히 고정해 드릴게요.</p>

<p class="chat--user">

너무 많이 찾을까봐 10개로 줄였잖아

</p>

<p>맞아요, “10개만”으로 제한해도 멈출 수 있어요. 이유는 “개수”가 아니라 “나열(열기) 자체”가 막히기 때문이에요. 네트워크/루트 경로에서 <code class="language-plaintext highlighter-rouge">os.scandir()</code>(혹은 존재 확인) 자체가 블로킹되면 결과를 1개만 원해도 그 1개를 얻기 전에 스레드가 붙잡혀요. 심지어 <code class="language-plaintext highlighter-rouge">Path(...).resolve()</code>도 원격 경로에서 멈출 수 있습니다.</p>

<p>아래처럼 바꾸면 멈춤 원인을 사실상 제거할 수 있습니다. 변화량은 작고 효과는 큽니다.</p>

<h1 id="멈춤을-유발하는-지점">멈춤을 유발하는 지점</h1>

<ul>
  <li>
    <p>루트(<code class="language-plaintext highlighter-rouge">/</code>, <code class="language-plaintext highlighter-rouge">C:\</code>, <code class="language-plaintext highlighter-rouge">\\server\</code>) 또는 잘못된 상위에서 <code class="language-plaintext highlighter-rouge">scandir()</code> 시도</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">resolve()</code>로 네트워크/심볼릭 링크 추적</p>
  </li>
  <li>
    <p>짧은 접두사(예: “/us”)일 때 광범위 탐색</p>
  </li>
  <li>
    <p>이전 작업을 취소해도 실제 <code class="language-plaintext highlighter-rouge">scandir()</code>가 이미 막혔으면 스레드가 오래 살아있음(새 입력과 경합)</p>
  </li>
</ul>

<h1 id="안전장치-6종-세트">안전장치 6종 세트</h1>

<ol>
  <li>절대 <code class="language-plaintext highlighter-rouge">resolve()</code> 금지<br />
자동완성 워커에서는 경로 정규화가 필요 없습니다. 존재 확인만 느슨하게:</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># base = Path(self.base_dir).resolve()  # 금지
</span><span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">)</span>              <span class="c1"># 그대로 둠
# 존재 확인도 느리면 건너뜀
</span><span class="n">exists_try</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">260</span> <span class="k">else</span> <span class="bp">True</span>
</code></pre></div></div>

<ol>
  <li>“루트 + 짧은 접두사”는 스캔하지 않기<br />
루트에서 길이 0~1 접두사는 거의 항상 과탐색을 유도합니다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">is_unc</span>   <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">).</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
<span class="n">is_root</span>  <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_unc</span> <span class="ow">or</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">).</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">)</span>
<span class="n">short_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">if</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="n">short_prefix</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">([]);</span> <span class="k">return</span>
</code></pre></div></div>

<ol>
  <li>직속 항목만 “가능할 때만” 확인<br />
<code class="language-plaintext highlighter-rouge">scandir()</code> 호출 자체가 막히면 답이 없으니, 먼저 “짧은 시간 예열” 후 넘깁니다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
            <span class="c1"># … 필터링 …
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span> <span class="k">break</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="c1"># 50ms 이상 쓰면 중단
</span>                <span class="k">break</span>
<span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">except</span> <span class="nb">OSError</span><span class="p">:</span>
    <span class="c1"># 원격 타임아웃/연결 문제 등
</span>    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
</code></pre></div></div>

<p>시간 예산을 50~100ms로 두면 “타자 중” 응답성이 유지됩니다.</p>

<ol>
  <li>BFS 완전 금지(혹은 매우 엄격히)<br />
자동완성에서 BFS는 체감가치 대비 리스크가 큽니다. 최소 요건을 이렇게:</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="c1"># BFS 생략
</span>    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
<span class="c1"># 그래도 하려면 depth_limit=1, 그리고 동일한 50ms 타임박스 내로
</span></code></pre></div></div>

<ol>
  <li>별도 스레드풀 + 단일 스레드<br />
이전 작업이 막히더라도 새 작업이 또 채워지지 않도록 자동완성 전용 풀을 만들어 1개만 돌립니다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__
</span><span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span> <span class="o">=</span> <span class="nc">QThreadPool</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span><span class="p">.</span><span class="nf">setMaxThreadCount</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 동시에 1개만
</span>
<span class="c1"># _spawn_completer_task 끝
</span><span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>  <span class="c1"># 기존 globalInstance() 대신
</span></code></pre></div></div>

<ol>
  <li>입력 정책: “확실할 때만 자동완성”<br />
네트워크 경로/루트에서 접두사 2글자 미만이면 아예 후보를 내지 않습니다. UX적으로도 납득이 됩니다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># _spawn_completer_task 초반
</span><span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
<span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([]);</span> <span class="k">return</span>

<span class="c1"># UNC나 /Volumes, /mnt, /net 등에서 prefix&lt;2면 스킵
</span><span class="n">s</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
<span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">):</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">name</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([]);</span> <span class="k">return</span>
</code></pre></div></div>

<h1 id="작게-고쳐도-큰-효과가-나는-포인트">작게 고쳐도 큰 효과가 나는 포인트</h1>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QCompleter</code> 갱신은 최대 10개라도, 팝업을 매번 열면 메인 스레드가 레이아웃·측정으로 바빠집니다. 결과가 비었으면 <code class="language-plaintext highlighter-rouge">complete()</code> 호출 금지, 이미 열려 있으면만 갱신:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">popup</span><span class="p">().</span><span class="nf">isVisible</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">textEdited</code>에서 절대 <code class="language-plaintext highlighter-rouge">_load_path()</code>를 호출하지 말 것. 입력 중 루트 인덱스 변경은 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>의 백그라운드 스캔을 유발해 같이 굳습니다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">exists()</code>도 원격에서 느릴 수 있으니, 자동완성 워커에서는 사용을 최소화하고, 최종 OK 검증 때만 엄격히 확인하세요.</p>
  </li>
</ul>

<h1 id="한-번에-적용하는-최소-패치-요약">한 번에 적용하는 최소 패치 요약</h1>

<ul>
  <li>
    <p>워커에서 <code class="language-plaintext highlighter-rouge">resolve()</code> 제거</p>
  </li>
  <li>
    <p>루트+짧은 접두사면 바로 빈 결과 반환</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">scandir()</code>에 50~100ms 타임박스</p>
  </li>
  <li>
    <p>BFS 끄기(혹은 prefix≥3 &amp; depth=1 &amp; 타임박스)</p>
  </li>
  <li>
    <p>자동완성 전용 <code class="language-plaintext highlighter-rouge">QThreadPool(max=1)</code> 사용</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">complete()</code>는 팝업 열려 있을 때만</p>
  </li>
</ul>

<p>이렇게만 바꿔도 “/user/만 치면 멈춤” 류가 사라집니다.<br />
개수 제한은 “열거가 끝난 뒤”에나 의미가 있으니, 열거 자체가 막히지 않게 설계를 틀어주는 게 핵심입니다.</p>

<p class="chat--user">

근데 쓰레드에서 요청하는건데 왜 gui도 freeze 되는거임

</p>

<p>짚고 넘어가자면, “워커 스레드에서 돌리는데도 GUI가 얼어붙는” 건 꽤 흔한 현상이에요. 원인은 보통 아래 네 가지 중 하나(혹은 복합)입니다. 핵심은 GUI가 진짜 멈춘 게 아니라, 메인 스레드가 일을 못 하거나 대기 상태에 빠져 “멈춘 것처럼 보이는” 겁니다.</p>

<h1 id="왜-멈추는가">왜 멈추는가</h1>

<ol>
  <li>
    <p>GIL(파이썬 전역 락) 점유로 메인 스레드가 굶주림<br />
워커 스레드가 파일 시스템을 훑으면서 Python 레벨 루프를 오래 돌면 GIL을 오래 쥐고 있게 됩니다. Qt의 이벤트 루프 자체는 C++이라 돌아가지만, 메인 스레드에서 실행되는 Python 슬롯/타이머/paint 이벤트 처리에는 GIL이 필요합니다. 워커가 GIL을 오래 잡고 있으면 메인 쪽 Python 코드가 실행되지 못해 “프리즈처럼” 보입니다.<br />
증상: 타이머 콜백, 슬롯이 늦게 오거나 아예 멈춘 것처럼 보임.</p>
  </li>
  <li>
    <p>메인 스레드 쪽에서 무거운 작업이 실행됨<br />
신호는 큐드(queued)로 잘 왔는데, 결과를 적용하는 슬롯에서 무거운 일을 하면(대량 리스트를 <code class="language-plaintext highlighter-rouge">QStringListModel.setStringList()</code>로 교체, <code class="language-plaintext highlighter-rouge">QCompleter.complete()</code> 반복 호출, <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 루트 변경 등) 그 순간만큼 메인 스레드가 바빠 보입니다. 특히 팝업 열기와 레이아웃 재계산은 생각보다 비쌉니다.</p>
  </li>
  <li>
    <p>Qt 객체를 워커 스레드에서 건드림<br />
Qt 위젯/모델은 “그 객체가 속한 스레드”에서만 만져야 합니다. 워커 내부에서 Qt 객체를 직접 건드리면 undefined behavior → 교착/프리즈. 반드시 워커는 파이썬의 순수 데이터(list[str])만 만들고, 메인 슬롯에서만 Qt 객체를 수정하세요.</p>
  </li>
  <li>
    <p>I/O가 “스레드가 아니라 OS 레벨”에서 막힘<br />
네트워크 경로, UNC, 루트 등에서 <code class="language-plaintext highlighter-rouge">Path.resolve()</code>나 <code class="language-plaintext highlighter-rouge">os.scandir()</code> 첫 호출이 OS 쪽에서 오래 블록될 수 있습니다. 스레드에서 막히는 것이 맞지만, 그 사이 결과를 기다리며 메인에서 계속 팝업을 열고 닫고, 모델을 비우고 채우는 작업이 연쇄되면 체감상 전체가 굼벵이처럼 느립니다.</p>
  </li>
</ol>

<h1 id="확인-체크리스트">확인 체크리스트</h1>

<ul>
  <li>
    <p>워커 코드가 CPU 루프를 오래 잡지 않게 타임박스 적용(예: <code class="language-plaintext highlighter-rouge">scandir</code> 50~100ms 한도).</p>
  </li>
  <li>
    <p>워커 루프 중 주기적으로 <code class="language-plaintext highlighter-rouge">time.sleep(0)</code> 또는 아주 짧은 <code class="language-plaintext highlighter-rouge">time.sleep(0.001)</code> 넣어 GIL 양보. <code class="language-plaintext highlighter-rouge">sleep()</code>은 GIL을 놓습니다.</p>
  </li>
  <li>
    <p>워커에서는 절대 Qt 객체 접근 금지. 신호로 순수 파이썬 자료만 전달.</p>
  </li>
  <li>
    <p>메인 슬롯에서의 작업을 O(候補수)로 유지. <code class="language-plaintext highlighter-rouge">setStringList</code> 후 즉시 <code class="language-plaintext highlighter-rouge">complete()</code>를 매번 호출하지 말고, 팝업이 이미 열려 있을 때만, 결과가 변했을 때만 갱신.</p>
  </li>
  <li>
    <p>입력 중에는 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 루트 변경 금지. 루트 변경은 별도 액션(엔터, 버튼, 더블클릭)에서만.</p>
  </li>
</ul>

<h1 id="바로-적용-가능한-수습-팁">바로 적용 가능한 수습 팁</h1>

<ul>
  <li>워커 루프 타임박스와 GIL 양보:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>  <span class="c1"># scandir 루프
</span>    <span class="c1"># ... 필터링/수집 ...
</span>    <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="c1"># 50ms 예산
</span>        <span class="k">break</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># GIL 양보
</span></code></pre></div></div>

<ul>
  <li>
    <p>결과 적용 최소화:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QStringListModel</code> 재사용(이미 하셨다면 유지).</p>
      </li>
      <li>
        <p>이전 결과와 새 결과가 같으면 아무것도 하지 않기.</p>
      </li>
      <li>
        <p>팝업이 열려 있을 때만 <code class="language-plaintext highlighter-rouge">complete()</code> 호출.</p>
      </li>
      <li>
        <p>후보가 0개면 <code class="language-plaintext highlighter-rouge">complete()</code> 호출 금지.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>루트·짧은 접두사 스킵: 루트(‘/’, ‘\’)에서 prefix 길이 &lt; 2면 아예 탐색하지 않고 빈 후보 반환.</p>
  </li>
  <li>
    <p>자동완성 전용 <code class="language-plaintext highlighter-rouge">QThreadPool</code>을 1스레드로 제한해서 태스크 적체 방지:</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span> <span class="o">=</span> <span class="nc">QThreadPool</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span><span class="p">.</span><span class="nf">setMaxThreadCount</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># self._auto_pool.start(task)
</span></code></pre></div></div>

<h1 id="왜의-핵심-요약">“왜”의 핵심 요약</h1>

<ul>
  <li>
    <p>스레드라서 GUI가 절대 안 멈추는 게 아닙니다.<br />
파이썬은 GIL 때문에 워커가 오래 점유하면 메인의 Python 코드가 멈춘 듯 보입니다.</p>
  </li>
  <li>
    <p>신호가 메인에 도착해도, 그걸 처리하는 슬롯이 무겁거나 자주 불리면 메인이 바빠져서 역시 “멈춘 느낌”이 납니다.</p>
  </li>
  <li>
    <p>Qt 객체는 메인에서만 만지세요. 워커는 데이터만 만들고, 짧게, 타임박스 안에서, GIL을 주기적으로 놓으면서 돌리면 체감 프리즈가 사라집니다.</p>
  </li>
</ul>

<p>원하면 당신 코드의 워커 부분과 결과 적용 슬롯 부분을 딱 10줄 내로 패치한 버전을 만들어서 붙여드릴게요.</p>

<p class="chat--user">

그러면 쓰레드 말고 멀티 프로세싱으로 가자

</p>

<p>좋아, 자동완성만 “멀티프로세싱”으로 빼서 GIL 영향을 원천 차단하는 쪽으로 정리하자. 핵심은 다음 셋업이야.</p>

<ol>
  <li>
    <p>워커는 프로세스. 입력 문자열을 받아서 경로 후보 10개만 계산해 순수 파이썬 리스트로 반환.</p>
  </li>
  <li>
    <p>GUI는 여전히 메인 스레드에서만 Qt 객체를 만짐. 결과는 시그널로만 반영.</p>
  </li>
  <li>
    <p>위험 구간(루트·짧은 접두사·네트워크 루트)의 탐색을 타임박스(예: 50~100ms)로 제한.</p>
  </li>
</ol>

<p>아래는 너의 기존 코드에서 “컴플리터 스레드” 부분만 교체하면 되는 드롭인 패치야. PySide6 그대로, <code class="language-plaintext highlighter-rouge">ProcessPoolExecutor(max_workers=1)</code>를 사용해 요청을 순서대로 처리하고, 이전 요청은 task_id로 무시한다.</p>

<h2 id="0-주의사항">0) 주의사항</h2>

<ul>
  <li>
    <p>Windows/macOS에서 프로세스는 spawn이 기본이라, 워커 함수는 반드시 모듈 최상위에 있어야 하고(피클링), <code class="language-plaintext highlighter-rouge">if __name__ == "__main__":</code> 가드 안에서 앱 실행해야 해. 아래 예제는 그 규칙을 지킨 형태야.</p>
  </li>
  <li>
    <p>Qt 객체는 절대 워커에서 접근하지 말 것. 경로 문자열만 주고 문자열 리스트만 받는다.</p>
  </li>
  <li>
    <p>프로세스 쪽에서 <code class="language-plaintext highlighter-rouge">resolve()</code>는 금지. 네트워크에서 막힐 수 있다.</p>
  </li>
</ul>

<h2 id="1-모듈-최상위-워커-함수-추가">1) 모듈 최상위: 워커 함수 추가</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- 모듈 최상위에 추가 ---
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span> <span class="nf">_collect_completions</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">want_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                         <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="n">time_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    멀티프로세스 워커. 순수 함수.
    - 루트 + 짧은 접두사면 바로 빈 리스트.
    - 직속 항목만 우선, 필요시 얕은 BFS(depth&lt;=1)로 보강.
    - scandir 루프는 타임박스(기본 80ms) 내에서만 실행.
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">sbase</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">is_unc</span> <span class="o">=</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">is_root</span> <span class="o">=</span> <span class="n">sbase</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_unc</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">short_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="n">short_prefix</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># 존재 확인은 느릴 수 있으므로 무조건 강행하지 말고 가볍게 시도
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c1"># 가까운 상위로 폴백
</span>            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">time_budget_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>

        <span class="c1"># 1) 직속
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                        <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">want_dirs</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">want_files</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># 2) 보강 BFS(아주 얕게, 조건부)
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">([(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
            <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">depth_limit</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                            <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_dirs</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                    <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_files</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="c1"># 정렬은 짧은 경로 우선
</span>        <span class="n">results</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))[:</span><span class="n">top_k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></div>

<h2 id="2-다이얼로그-프로세스-풀과-시그널-준비">2) 다이얼로그: 프로세스 풀과 시그널 준비</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__ 안에 (기존 스레드풀·워커 관련 코드 제거하고) 추가
</span><span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QStringListModel</span>

<span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">)</span>

<span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 자동완성 전용 1프로세스
</span><span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># 결과를 Qt로 넘길 emitter
</span><span class="k">class</span> <span class="nc">_ProcEmitter</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="n">resultsReady</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span> <span class="o">=</span> <span class="nf">_ProcEmitter</span><span class="p">()</span>
<span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_proc_results</span><span class="p">)</span>
</code></pre></div></div>

<p>다이얼로그가 닫힐 때 풀을 정리해 줘야 해.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nf">super</span><span class="p">().</span><span class="nf">closeEvent</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="3-작업-투입-로직-교체">3) 작업 투입 로직 교체</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
        <span class="k">return</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

    <span class="c1"># 루트·의심 경로 단축 리턴
</span>    <span class="n">sbase</span> <span class="o">=</span> <span class="n">base_dir</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
            <span class="k">return</span>

    <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1"># 이전 요청 무시(취소 시도)
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>  <span class="c1"># 이미 실행 중이면 취소가 보장되진 않지만 결과는 무시할 거라 OK
</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span>

    <span class="c1"># 제출
</span>    <span class="n">fut</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_collect_completions</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="n">fut</span>

    <span class="c1"># 완료 콜백: 워커 스레드에서 실행→Qt 시그널로 메인에 전달
</span>    <span class="k">def</span> <span class="nf">_on_done</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
    <span class="n">fut</span><span class="p">.</span><span class="nf">add_done_callback</span><span class="p">(</span><span class="n">_on_done</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="4-결과-적용-슬롯">4) 결과 적용 슬롯</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_proc_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">seq</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># 최신 요청만 반영
</span>    <span class="c1"># 경량 갱신
</span>    <span class="n">items</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="c1"># 이전과 동일하면 갱신 생략
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">stringList</span><span class="p">()</span> <span class="o">==</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="c1"># 팝업은 필요할 때만
</span>    <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">popup</span><span class="p">().</span><span class="nf">isVisible</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="5-엔트리-포인트-가드">5) 엔트리 포인트 가드</h2>

<p>멀티프로세싱을 쓰면 메인 진입을 가드해야 해.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="c1"># ... 다이얼로그 실행 ...
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># 필요시: from multiprocessing import set_start_method; set_start_method("spawn", force=True)
</span>    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="6-왜-이-구성이-안전한가">6) 왜 이 구성이 안전한가</h2>

<ul>
  <li>
    <p>GIL: 후보 수집은 별도 프로세스에서 돌아서 메인의 파이썬 슬롯·타이머가 굶지 않는다.</p>
  </li>
  <li>
    <p>Qt 스레드 규칙: 워커는 순수 데이터만 반환하고, Qt 객체 갱신은 시그널 슬롯에서만 처리.</p>
  </li>
  <li>
    <p>블로킹 I/O: 네트워크에서 <code class="language-plaintext highlighter-rouge">scandir()</code>가 잠시 멈춰도 GUI는 독립적. 타임박스로 장기 블로킹을 더 줄였다.</p>
  </li>
  <li>
    <p>폭주 방지: <code class="language-plaintext highlighter-rouge">max_workers=1</code>로 큐 누적을 제한하고, task_seq로 오래된 결과를 무시한다.</p>
  </li>
</ul>

<h2 id="확장-팁">확장 팁</h2>

<ul>
  <li>
    <p>네트워크 드라이브에서 더 여유가 필요하면 <code class="language-plaintext highlighter-rouge">time_budget_ms</code>를 120~150으로, 대신 <code class="language-plaintext highlighter-rouge">depth_limit=0</code>으로 유지(직속만).</p>
  </li>
  <li>
    <p>macOS 앱 번들로 배포할 때는 워커 함수를 별도 <code class="language-plaintext highlighter-rouge">.py</code> 모듈로 분리하면 스폰 안정성이 올라간다.</p>
  </li>
  <li>
    <p>후보 캐싱을 추가하면 같은 <code class="language-plaintext highlighter-rouge">base_dir</code>에서 접두사가 길어질수록 재사용 가능(프로세스 메모리에도 캐시를 둘지, 메인에서 최근 결과를 재활용할지 선택).</p>
  </li>
</ul>

<p>이대로 붙여서 돌려보고, 여전히 특정 경로에서 체감 지연이 있으면 로그 한두 줄만 공유해줘. 타임박스·깊이·루트 규칙을 경로별로 미세 조정해 더 민첩하게 만들 수 있어.</p>

<p class="chat--user">

전체 코드 좀

</p>

<p>좋아. 아래는 멀티프로세싱 기반 자동완성(컴플리터)을 포함한 전체 동작 예제야.<br />
PySide6 기준이고, <code class="language-plaintext highlighter-rouge">ProcessPoolExecutor(max_workers=1)</code>로 자동완성만 별도 프로세스에서 처리해서 GIL·블로킹 영향을 차단해. 경로 콤보/Back·Forward·Parent·New Folder, 파일·폴더 모드, Open/Save, Type 필터, 히스토리, 디바운스, 그리고 안전장치(루트+짧은 접두사 차단, <code class="language-plaintext highlighter-rouge">scandir()</code> 타임박스)까지 포함했어.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: utf-8 -*-
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>

<span class="c1"># ==========================================
# 멀티프로세스 워커 함수 (모듈 최상위에 있어야 함)
# ==========================================
</span><span class="k">def</span> <span class="nf">_collect_completions</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">want_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                         <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="n">time_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    자동완성 후보를 수집하는 순수 함수(별도 프로세스에서 실행).
    - 루트 + 짧은 접두사면 빈 리스트 반환
    - 직속 항목 우선, 필요 시 매우 얕은 BFS(depth&lt;=1)로 보강
    - os.scandir 루프는 타임박스 내에서만 동작
    - Qt 객체 접근 절대 금지 (문자열 리스트만 반환)
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">sbase</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

        <span class="c1"># 플랫폼별 루트 판단
</span>        <span class="n">is_unc</span> <span class="o">=</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">is_root_like</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sbase</span> <span class="o">==</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span> <span class="ow">or</span>
            <span class="n">sbase</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">F:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">is_unc</span> <span class="ow">or</span>
            <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">sbase</span> <span class="o">==</span> <span class="sh">"</span><span class="s">/</span><span class="sh">"</span>
        <span class="p">)</span>

        <span class="n">short_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_root_like</span> <span class="ow">and</span> <span class="n">short_prefix</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># 존재 확인은 네트워크에서 느릴 수 있으니 조심스럽게
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c1"># 가까운 상위로 폴백
</span>            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">time_budget_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>

        <span class="c1"># 1) 직속 항목 스캔 (타임박스)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                        <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">want_dirs</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">want_files</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># PermissionError, OSError 등은 무시
</span>            <span class="k">pass</span>

        <span class="c1"># 2) 보강 BFS (조건부, 매우 얕게, 타임박스)
</span>        <span class="nf">if </span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_root_like</span>
            <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span>
            <span class="ow">and</span> <span class="n">depth_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">([(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
            <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">depth_limit</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                            <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="c1"># 매칭 확인
</span>                            <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_dirs</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                    <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                                    <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_files</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">results</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))[:</span><span class="n">top_k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="c1"># ==========================================
# Qt 임포트
# ==========================================
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QModelIndex</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QStringListModel</span>
    <span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">QApplication</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QToolButton</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span>
        <span class="n">QTreeView</span><span class="p">,</span> <span class="n">QFileSystemModel</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QCompleter</span><span class="p">,</span> <span class="n">QDialogButtonBox</span><span class="p">,</span>
        <span class="n">QInputDialog</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QSizePolicy</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6가 필요합니다. pip install PySide6</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># ==========================================
# CFileDialog 본체
# ==========================================
</span><span class="k">class</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    mode: </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">save</span><span class="sh">'</span><span class="s">
    select_mode: </span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="s">

    사용 예:
        dlg = CFileDialog(mode=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">, select_mode=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="s">,
                          filters=[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">Images (*.png *.jpg)</span><span class="sh">"</span><span class="s">])
        if dlg.exec():
            print(dlg.selected_path())
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
                 <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">CFileDialog (Multiprocessing Completer)</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="mi">960</span><span class="p">,</span> <span class="mi">640</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">select_mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">start_path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span> <span class="k">if</span> <span class="n">start_path</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>

        <span class="c1"># 자동완성 상태
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span> <span class="o">=</span> <span class="nc">QTimer</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 입력 디바운스
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setSingleShot</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_spawn_completer_task</span><span class="p">)</span>

        <span class="c1"># 프로세스 풀: 자동완성 전용, 동시 1개
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># 프로세스 결과를 Qt로 전달하는 emitter
</span>        <span class="k">class</span> <span class="nc">_ProcEmitter</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
            <span class="n">resultsReady</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span> <span class="o">=</span> <span class="nf">_ProcEmitter</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_proc_results</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_build_ui</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_connect_signals</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_configure_modes</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- UI 구성 ----------
</span>    <span class="k">def</span> <span class="nf">_build_ui</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># 상단 툴바
</span>        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">Back</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">Forward</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">Parent</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">New Folder</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Fixed</span><span class="p">)</span>

        <span class="n">top</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">)</span>

        <span class="c1"># 중앙 뷰
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>  <span class="c1"># 전체 FS
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="nc">QTreeView</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIsDecorated</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSortingEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">sortByColumn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">AscendingOrder</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSelectionBehavior</span><span class="p">(</span><span class="n">QTreeView</span><span class="p">.</span><span class="n">SelectRows</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setUniformRowHeights</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setColumnWidth</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

        <span class="c1"># 하단: 경로 입력 + Type + 버튼들
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setPlaceholderText</span><span class="p">(</span><span class="sh">"</span><span class="s">경로를 입력하세요…</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># QCompleter + QStringListModel 재사용
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span> <span class="o">=</span> <span class="nc">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Cancel</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

        <span class="n">bottom</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">경로:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">)</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Type:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">bottom</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">)</span>

    <span class="c1"># ---------- 시그널 ----------
</span>    <span class="k">def</span> <span class="nf">_connect_signals</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_back</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_forward</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_up</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_create_folder</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="n">activated</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_combo_jump</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">doubleClicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_double_clicked</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_clicked</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="n">textEdited</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_path_edited</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="n">currentTextChanged</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_filter_changed</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">accepted</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_accept_if_valid</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">rejected</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reject</span><span class="p">)</span>

    <span class="c1"># ---------- 모드/필터 ----------
</span>    <span class="k">def</span> <span class="nf">_configure_modes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QDir</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllDirs</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllEntries</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilterDisables</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_apply_name_filters_from_combo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilters</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_filter_changed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="c1"># ---------- 경로 로딩 ----------
</span>    <span class="k">def</span> <span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># resolve()는 메인에서만 사용 (UI 반응 느려지면 생략해도 됨)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">push_history</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_combo_jump</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">itemText</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parts</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
            <span class="n">acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="o">*</span><span class="n">acc</span><span class="p">)))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setCurrentIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- 탐색 ----------
</span>    <span class="k">def</span> <span class="nf">_go_back</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_forward</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_up</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_folder</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="p">.</span><span class="nf">getText</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">새 폴더</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">폴더명:</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">FileExistsError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">경고</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">동일한 이름의 폴더가 이미 존재합니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">오류</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">폴더를 만들 권한이 없습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">오류</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">폴더 생성 실패: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- 뷰 상호작용 ----------
</span>    <span class="k">def</span> <span class="nf">_item_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_item_double_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>

    <span class="c1"># ---------- 선택 유효성 ----------
</span>    <span class="k">def</span> <span class="nf">_is_selection_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">parent</span>
            <span class="k">return</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">parent</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_match_type_filters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_update_ok_enabled</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">ok_btn</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="nf">button</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span><span class="p">)</span>
        <span class="n">ok_btn</span><span class="p">.</span><span class="nf">setEnabled</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_accept_if_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택 확인</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택이 유효하지 않습니다.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- 경로 입력/자동완성(멀티프로세싱) ----------
</span>    <span class="k">def</span> <span class="nf">_on_path_edited</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="c1"># 입력 중에는 루트 변경 금지. 자동완성만 트리거.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
            <span class="k">return</span>

        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

        <span class="c1"># 루트/의심 경로에서 짧은 접두사면 미리 차단
</span>        <span class="n">sbase</span> <span class="o">=</span> <span class="n">base_dir</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
                <span class="k">return</span>

        <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># 이전 요청 취소 시도 (spawn된 프로세스 작업은 즉시 안 꺼질 수 있으나, 우리는 결과를 무시)
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span>

        <span class="c1"># 제출
</span>        <span class="n">fut</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_collect_completions</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="n">fut</span>

        <span class="c1"># 완료 콜백: 워커 스레드에서 실행되므로 Qt로 신호 전달
</span>        <span class="k">def</span> <span class="nf">_on_done</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="n">fut</span><span class="p">.</span><span class="nf">add_done_callback</span><span class="p">(</span><span class="n">_on_done</span><span class="p">)</span>

    <span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_proc_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># 최신 요청만 반영
</span>        <span class="n">items</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># 이전과 동일하면 갱신 생략
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">stringList</span><span class="p">()</span> <span class="o">==</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="c1"># 팝업은 조건부로만 호출
</span>        <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">popup</span><span class="p">().</span><span class="nf">isVisible</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>

    <span class="c1"># ---------- 종료 처리 ----------
</span>    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">closeEvent</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="c1"># ---------- 외부 API ----------
</span>    <span class="k">def</span> <span class="nf">selected_path</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>

<span class="c1"># ==========================================
# 실행 예시
# ==========================================
</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># 예시 1: 파일 Open
</span>    <span class="n">dlg1</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Text Files (*.txt *.md)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Images (*.png *.jpg *.jpeg *.bmp *.gif)</span><span class="sh">"</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OPEN FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># 예시 2: 폴더 선택
</span>    <span class="n">dlg2</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SELECT FOLDER:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># 예시 3: 파일 Save
</span>    <span class="n">dlg3</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">save</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Python (*.py)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SAVE FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># 멀티프로세싱 스폰 모드 사용 시 필요하다면 주석 해제
</span>    <span class="c1"># from multiprocessing import set_start_method
</span>    <span class="c1"># set_start_method("spawn", force=True)
</span>    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>메모</p>

<ul>
  <li>
    <p>자동완성은 별도 프로세스에서 돌고, GUI는 메인 스레드에서만 Qt 객체를 건드려서 안전해.</p>
  </li>
  <li>
    <p>루트 경로에서 접두사가 짧을 때는 탐색을 생략해 폭주를 막았고, <code class="language-plaintext highlighter-rouge">scandir()</code>에 80ms 타임박스를 걸어 타자 중 지연을 억제했어.</p>
  </li>
  <li>
    <p>이전 요청은 <code class="language-plaintext highlighter-rouge">cancel()</code>하고 <code class="language-plaintext highlighter-rouge">seq</code>로 최신성만 보장해 결과 레이스를 제거했어.</p>
  </li>
  <li>
    <p>필요하면 <code class="language-plaintext highlighter-rouge">time_budget_ms</code>나 <code class="language-plaintext highlighter-rouge">depth_limit</code>을 조절해서 네트워크 드라이브에서 더 보수적으로 동작하게 만들 수 있어.</p>
  </li>
</ul>

<p>특정 OS나 네트워크 공유에서 튜닝이 더 필요하면, 문제 재현 경로와 함께 알려줘. 타임박스·깊이·루트 규칙을 미세조정한 패치를 바로 만들어줄게.</p>

<p class="chat--user">

원인을 좀 더 좁힌거 같아. os.path.isfile("/user/j") 이게 너무 느려 안 끝나

</p>

<p>맞아, 핵심 원인은 <code class="language-plaintext highlighter-rouge">os.path.isfile("/user/j")</code> 같은 “경로 자체에 대한 stat 호출”이 네트워크·자동마운트(autofs)·SMB/UNC 같은 느린 파일시스템에서 블로킹되기 때문이야. 특히 <code class="language-plaintext highlighter-rouge">/user</code> 가 자동마운트 지점이면, <code class="language-plaintext highlighter-rouge">isfile</code> 한 번만으로도 커널이 마운트를 시도→DNS 탐색→타임아웃까지 기다리느라 GUI가 얼어붙은 것처럼 느껴져. 스레드로 돌려도 GIL·결과 반영 타이밍·연쇄 호출 때문에 체감 프리즈가 나오는 거고.</p>

<p>해법은 “타이핑 중에는 절대 <code class="language-plaintext highlighter-rouge">isfile</code>/<code class="language-plaintext highlighter-rouge">exists</code> 같은 직접 stat을 하지 않는다”야. 검증이 필요해도 경량 우회로를 쓰거나, 별도 프로세스에서 타임박스로 돌리고 결과가 늦으면 그냥 “모름”으로 처리하는 정책이 안전해.</p>

<p>아래처럼 바꾸면 바로 효과를 볼 수 있어.</p>

<h1 id="전략-요약">전략 요약</h1>

<ol>
  <li>
    <p>입력 중에는 <code class="language-plaintext highlighter-rouge">isfile</code> 완전 금지. 자동완성은 문자열 매칭만.</p>
  </li>
  <li>
    <p>최종 OK 검증에서만 “빠른 존재 확인”을 시도하되, 경로에 직접 stat 하지 말고 상위 폴더를 짧게 나열해 이름 비교한다.</p>
  </li>
  <li>
    <p>그래도 네트워크일 수 있으니 타임박스(예: 50ms)를 넘기면 “미확인”으로 간주하고 OK을 잠시 비활성화하거나, 메시지로 알려준다.</p>
  </li>
  <li>
    <p>필요하면 멀티프로세싱으로 “느릴 수 있는 stat”을 분리하고 100~150ms 타임아웃을 둔다.</p>
  </li>
  <li>
    <p>autofs·네트워크 루트 프리픽스를 블록리스트로 두고, 접두사가 짧을 땐 아예 검증을 스킵한다.</p>
  </li>
</ol>

<h1 id="코드-패치-1-빠른-파일-확인기로-교체">코드 패치 1: 빠른 파일 확인기로 교체</h1>

<p><code class="language-plaintext highlighter-rouge">_is_selection_valid()</code>에서 쓰던 <code class="language-plaintext highlighter-rouge">os.path.isfile()</code>를 아래 함수로 바꿔 호출해.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_fast_isfile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">경로 자체를 stat하지 않고, 부모 디렉터리를 짧게 나열해서 이름으로 판단.</span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># 위험 프리픽스는 즉시 포기(autofs/네트워크 루트)
</span>    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">parent</span><span class="p">).</span><span class="nf">lower</span><span class="p">()</span>
    <span class="n">risky_roots</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/nfs</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/afs</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/users</span><span class="sh">"</span><span class="p">,</span>
                   <span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span> <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">risky_roots</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># 접두사가 짧으면 스캔하지 않음
</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="c1"># 타임박스 초과 시 즉시 포기
</span>                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="c1"># 여기서도 stat 대신 dir 여부만 확인(캐시 활용)
</span>                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>  <span class="c1"># 파일로 가정
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>그리고 <code class="language-plaintext highlighter-rouge">_is_selection_valid()</code>를 이렇게 조정.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_is_selection_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
        <span class="c1"># 폴더 검증도 빠른 버전으로(직접 stat 대신 상위 나열)
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fast_isdir</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">:</span>
        <span class="c1"># 느린 환경에서 isfile 금지 → 빠른 확인기 사용
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fast_isfile</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">parent</span>
        <span class="c1"># 저장은 상위 폴더만 확인(이것도 빠른 판정 사용)
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fast_isdir</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_fast_isdir</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">parent</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="c1"># 루트 등: 대개 디렉터리로 취급
</span>        <span class="k">return</span> <span class="bp">True</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>설명: <code class="language-plaintext highlighter-rouge">os.path.isfile(target)</code> 대신, 부모 디렉터리를 아주 짧게 나열하면서 이름이 같은 엔트리만 판정한다. 이러면 커널이 문제의 경로 자체를 접근(=자동마운트 트리거)하지 않고도 대부분의 케이스를 해결한다.</p>

<h1 id="코드-패치-2-최종-검증을-비동기타임아웃으로">코드 패치 2: 최종 검증을 비동기·타임아웃으로</h1>

<p>그래도 원격 부모 폴더 나열이 느릴 수 있어. 그럴 땐 프로세스 풀로 “안전 판정”을 돌리고, 120ms 안에 답이 없으면 OK 버튼을 잠깐 비활성화하거나 경고 배지를 띄우자.</p>

<p>최상위에 워커 함수 추가:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_safe_isfile_worker</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>다이얼로그 <code class="language-plaintext highlighter-rouge">__init__</code>에서 재사용용 풀 하나:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="n">self</span><span class="p">.</span><span class="n">_check_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div>

<p>OK 직전 확인(예: <code class="language-plaintext highlighter-rouge">_accept_if_valid</code>에서):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_accept_if_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">:</span>
        <span class="c1"># 빠른 판정으로 충분하면 바로 통과
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fast_isfile</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">();</span> <span class="k">return</span>
        <span class="c1"># 느리면 프로세스로 120ms만 시도
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_check_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_safe_isfile_worker</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.12</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택 확인</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">파일이 존재하지 않거나 접근할 수 없습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># 나머지 케이스는 기존 로직
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택 확인</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택이 유효하지 않습니다.</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>닫을 때 풀 정리:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_check_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nf">super</span><span class="p">().</span><span class="nf">closeEvent</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="정책-팁">정책 팁</h1>

<ul>
  <li>
    <p>“루트/네트워크 루트 + 접두사 짧음”에서는 어떤 판정도 하지 말고, 자동완성과 OK 둘 다 보수적으로 막아라. 타자 몇 글자 더 치면 자연스럽게 풀린다.</p>
  </li>
  <li>
    <p>저장 모드에서는 존재 확인이 필요 없다. 상위 폴더만 빠르게 확인하면 된다.</p>
  </li>
  <li>
    <p>자동완성·검증 모두 “경로 자체 stat”을 피하고, 가능하면 “부모 나열”로 판정하라.</p>
  </li>
  <li>
    <p>조직 환경에서 <code class="language-plaintext highlighter-rouge">/user</code>, <code class="language-plaintext highlighter-rouge">/net</code>, <code class="language-plaintext highlighter-rouge">/home</code>, <code class="language-plaintext highlighter-rouge">/nfs</code> 같은 autofs 지점이 있다면, 그 접두사는 공격적으로 스킵하도록 블록리스트에 올려라.</p>
  </li>
  <li>
    <p>리눅스라면 <code class="language-plaintext highlighter-rouge">/proc/mounts</code>를 읽어 <code class="language-plaintext highlighter-rouge">autofs</code> 타입 마운트 목록을 만들어두고, 그 경로 밑은 접두사 길이 3 미만이면 무조건 스킵하는 게 최선이다.</p>
  </li>
</ul>

<p>정리하면, 지금 보이는 병목은 <code class="language-plaintext highlighter-rouge">isfile</code> 한 방으로 autofs를 찌르면서 발생해. 위 패치처럼 “경로 자체 stat 금지 + 부모 디렉터리 짧게 나열 + 타임박스 + 필요시 프로세스 타임아웃”으로 바꾸면 같은 환경에서도 프리즈가 사라질 거야. 원하는 형태로 바로 붙일 수 있게, 네 코드의 <code class="language-plaintext highlighter-rouge">_is_selection_valid()</code> 부분을 기반으로 한 미니 패치도 만들어줄 수 있어.</p>

<p class="chat--user">

음 오케이오케이. 결국 내가 원하는건 내부에서 어떻게 동작하든 깔끔하게 isfile 같은 함수를 다 구현해주면 돼. 파일 확인 함수 모두 구현해줘

</p>

<p>좋아. 내부 구현이 어떻게 돌아가든—UI는 몰라도 되도록—파일 확인용 유틸을 한 덩어리로 정리해줄게. 핵심 목표는 다음이야.</p>

<ul>
  <li>
    <p>타이핑 중엔 느린 stat 계열 호출을 피한다.</p>
  </li>
  <li>
    <p>부모 디렉터리 나열로 빠르게 추정한다(타임박스).</p>
  </li>
  <li>
    <p>필요하면 멀티프로세싱으로 짧은 타임아웃 내 “확정” 검증을 한다.</p>
  </li>
  <li>
    <p>호출자가 정치(빠름/정확)만 고르면 된다.</p>
  </li>
</ul>

<p>아래 모듈은 바로 붙여서 쓸 수 있어. 반환 정책은 세 가지로 나눈다.</p>

<ul>
  <li>
    <p>빠른 추정 계열(<code class="language-plaintext highlighter-rouge">quick_…</code>): True/False/None(None=시간 초과/판단 불가)</p>
  </li>
  <li>
    <p>확정 검증 계열(<code class="language-plaintext highlighter-rouge">confirm_…</code>): 멀티프로세싱 + 타임아웃으로 True/False</p>
  </li>
  <li>
    <p>안전 래퍼(<code class="language-plaintext highlighter-rouge">safe_…</code>): quick이 결정 못 하면 confirm을 짧게 시도</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># file_checks.py
# -*- coding: utf-8 -*-
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="nb">TimeoutError</span>

<span class="c1"># ---------------------------------------
# 내부 설정
# ---------------------------------------
# autofs/네트워크 루트 등 "건드리면 느릴" 수 있는 접두사
</span><span class="n">_RISKY_PREFIXES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span>                <span class="c1"># "/"
</span>    <span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/nfs</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/afs</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/media</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">/user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/users</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/home</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">,</span>            <span class="c1"># macOS
</span>    <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">,</span>                <span class="c1"># Windows UNC
</span><span class="p">)</span>
<span class="c1"># Windows 드라이브 루트 후보 (필요시 추가)
</span><span class="n">_WIN_ROOTS</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s">:</span><span class="se">\\</span><span class="sh">"</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">ABCDEFGHIJKLMNOPQRSTUVWXYZ</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_is_risky_root</span><span class="p">(</span><span class="n">path_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">path_str</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">).</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_RISKY_PREFIXES</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path_str</span> <span class="ow">in</span> <span class="n">_WIN_ROOTS</span>

<span class="c1"># ---------------------------------------
# 빠른 부모-나열 기반 판정(타임박스)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    부모 디렉터리를 os.scandir로 짧게 훑어 파일/디렉터리/기타 여부를 추정한다.
    반환: </span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="s"> | None(판단불가/시간초과)
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">parent</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="c1"># 루트 같은 케이스: 디렉터리 취급
</span>        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
                    <span class="k">elif</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_file</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="c1"># entry 질의 실패 시 파일로 가정할 수도 있지만 보수적으로 기타 처리
</span>                    <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    빠른 추정: 부모 나열만으로 파일 여부를 판단.
    True/False 또는 None(시간초과/판단불가) 반환.
    </span><span class="sh">"""</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="p">))</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="c1"># ---------------------------------------
# 멀티프로세싱 확정 검증(타임아웃)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">_mp_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_mp_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_mp_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="c1"># 프로세스를 매 호출마다 만드는 방식: 누수 없음, 간결
</span>    <span class="n">timeout_s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="k">with</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">confirm_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_isdir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">confirm_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_exists</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 안전 래퍼: 빠름→(필요 시)확정
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">safe_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                <span class="n">risky_skip_minlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    권장 사용: 타자 중엔 빠르게, 확정이 필요하면 짧게 confirm.
    - 위험 루트 + 이름이 짧으면(기본 2) 바로 False로 간주(탐색 회피).
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">_is_risky_root</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">))</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">risky_skip_minlen</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q</span>
    <span class="k">return</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
               <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
               <span class="n">risky_skip_minlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">_is_risky_root</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">))</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">risky_skip_minlen</span><span class="p">:</span>
        <span class="c1"># 루트 자체는 디렉터리 취급
</span>        <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q</span>
    <span class="k">return</span> <span class="nf">confirm_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                <span class="n">risky_skip_minlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">_is_risky_root</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">))</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">risky_skip_minlen</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q</span>
    <span class="k">return</span> <span class="nf">confirm_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 접근/권한 체크(빠른 버전)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">quick_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    접근 권한 추정. 존재 여부를 확정하지 않고 부모 나열로 보수 판정.
    파일이면 os.R_OK, os.W_OK, os.X_OK 의미 동일.
    </span><span class="sh">"""</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c1"># 존재한다고 가정하고 접근 모드는 낙관적으로 추정할 수도 있지만,
</span>    <span class="c1"># 네트워크/권한 이슈는 확인 비용이 큼 → None 반환이 안전
</span>    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">confirm_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_mp_access</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">access</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="n">timeout_s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="k">with</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_mp_access</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">safe_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c1"># q is True/None → 필요 시 짧게 확인
</span>    <span class="k">return</span> <span class="nf">confirm_access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 편의: 파일/폴더 모드에서 OK 활성화 판정
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">can_accept_open_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">require_filter_match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                         <span class="n">name_patterns</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(),</span>
                         <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                         <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Open+File 모드의 OK 가능 여부.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">safe_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">require_filter_match</span> <span class="ow">and</span> <span class="n">name_patterns</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">fnmatch</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">name</span>
        <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">name_patterns</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">can_accept_open_folder</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                           <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">can_accept_save_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                         <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Save+File: 상위 폴더만 존재하면 OK.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">)</span>
</code></pre></div></div>

<p>간단 사용 예시는 아래처럼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 예시
</span><span class="kn">from</span> <span class="n">file_checks</span> <span class="kn">import</span> <span class="n">safe_isfile</span><span class="p">,</span> <span class="n">safe_isdir</span><span class="p">,</span> <span class="n">safe_exists</span><span class="p">,</span> <span class="n">can_accept_open_file</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">safe_isfile</span><span class="p">(</span><span class="sh">"</span><span class="s">/user/j</span><span class="sh">"</span><span class="p">))</span>                 <span class="c1"># autofs 환경에서도 프리즈 없이 빠른 반환
</span><span class="nf">print</span><span class="p">(</span><span class="nf">safe_isdir</span><span class="p">(</span><span class="sh">"</span><span class="s">/some/dir</span><span class="sh">"</span><span class="p">))</span>                <span class="c1"># 빠른 추정 → 필요시 150ms 타임아웃으로 확정
</span><span class="nf">print</span><span class="p">(</span><span class="nf">safe_exists</span><span class="p">(</span><span class="sh">"</span><span class="s">/network/share/file.txt</span><span class="sh">"</span><span class="p">))</span> <span class="c1"># 동일 정책
</span><span class="nf">print</span><span class="p">(</span><span class="nf">can_accept_open_file</span><span class="p">(</span><span class="sh">"</span><span class="s">/path/a.png</span><span class="sh">"</span><span class="p">,</span>
                           <span class="n">require_filter_match</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                           <span class="n">name_patterns</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">*.png</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">*.jpg</span><span class="sh">"</span><span class="p">)))</span>
</code></pre></div></div>

<p>핵심 포인트 정리</p>

<ul>
  <li>
    <p>quick 단계는 부모 디렉터리만 짧게 나열해서 추정하므로 autofs/UNC에서도 안전하다.</p>
  </li>
  <li>
    <p>confirm 단계는 별도 프로세스로 <code class="language-plaintext highlighter-rouge">os.path.isfile</code> 같은 “진짜 stat”을 돌리되, 타임아웃을 걸어 GUI가 멈추지 않게 한다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">safe_*</code>는 quick→confirm 순으로 처리해서 UI 코드가 간단해진다.</p>
  </li>
  <li>
    <p>위험 루트에서 이름이 너무 짧으면(기본 2) 아예 건드리지 않고 False를 돌려 탐욕적 마운트를 피한다. 필요하면 이 기준을 조정하면 된다.</p>
  </li>
</ul>

<p>원하면 이 모듈을 너의 <code class="language-plaintext highlighter-rouge">CFileDialog</code>에 바로 끼워 넣을 수 있도록 <code class="language-plaintext highlighter-rouge">_is_selection_valid()</code> 패치 버전도 만들어서 붙여줄게.</p>

<p class="chat--user">

risky root를 하드코딩으로 하는건 별로 안하고 싶네. 그 부분은 빼줘

</p>

<p>좋아. 하드코딩된 “risky root” 판단을 싹 제거한 버전이야.<br />
정책은 오직 시간 예산(타임박스)과 멀티프로세싱 타임아웃으로만 안전성을 보장해. 필요하면 호출 시 파라미터로 시간 값을 조절해 쓰면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># file_checks.py
# -*- coding: utf-8 -*-
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="nb">TimeoutError</span>

<span class="c1"># ---------------------------------------
# 부모-나열 기반 빠른 추정(타임박스)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    부모 디렉터리를 짧게 나열해 대상이 파일/디렉터리/기타인지 추정.
    반환: </span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="s"> | None(시간초과/판단불가)
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">parent</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="c1"># 루트 같은 케이스는 디렉터리로 간주
</span>        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
                    <span class="k">elif</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_file</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="p">))</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="c1"># ---------------------------------------
# 멀티프로세싱 확정 검증(타임아웃)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">_mp_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_mp_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_mp_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">timeout_s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="c1"># 호출 단위 풀 생성: 간단하고 누수 없음
</span>    <span class="k">with</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">confirm_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_isdir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">confirm_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_exists</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 안전 래퍼: 빠름→(필요 시)확정
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">safe_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    1) quick(부모 나열, 타임박스)로 결정 시 그 값 사용
    2) 결정 불가(None)이면 멀티프로세싱으로 짧게 확정
    </span><span class="sh">"""</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
               <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">confirm_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">confirm_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 접근/권한 체크
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">confirm_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_mp_access</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">access</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="n">timeout_s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="k">with</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_mp_access</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">safe_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    접근성은 빠른 추정이 의미가 적으므로 바로 확정 호출을 권장.
    그래도 호출 시그니처를 맞추기 위해 quick_budget_ms를 남겨둠.
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">confirm_access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# OK 활성화 판정(다이얼로그 용)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">can_accept_open_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">require_filter_match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                         <span class="n">name_patterns</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(),</span>
                         <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                         <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">safe_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">require_filter_match</span> <span class="ow">and</span> <span class="n">name_patterns</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">fnmatch</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">name</span>
        <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">name_patterns</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">can_accept_open_folder</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                           <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">can_accept_save_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                         <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">)</span>
</code></pre></div></div>

<p>포인트</p>

<ul>
  <li>
    <p>어떤 경로든 하드코딩 규칙 없이 동일하게 다룬다.</p>
  </li>
  <li>
    <p>quick 계열은 부모 디렉터리만 짧게 스캔해서 프리즈를 막고, 판단 불가일 때만 confirm(프로세스, 타임아웃)으로 확정한다.</p>
  </li>
  <li>
    <p>UI에서는 <code class="language-plaintext highlighter-rouge">safe_isfile/safe_isdir/safe_exists</code>만 호출하면 되고, 느려 보이면 <code class="language-plaintext highlighter-rouge">quick_budget_ms</code>를 줄이거나 <code class="language-plaintext highlighter-rouge">confirm_timeout_ms</code>를 늘려 튜닝하면 된다.</p>
  </li>
</ul>

<p>원하면 이 모듈을 <code class="language-plaintext highlighter-rouge">CFileDialog</code>의 <code class="language-plaintext highlighter-rouge">_is_selection_valid()</code>에 바로 붙인 예시도 덧붙여줄게.</p>

<p class="chat--user">

worker가 1개인데 만약에 async나 thread로 confirm_isfile이 불려도 상관없나?

</p>

<p>결론부터 말하면, 지금 올려둔 <code class="language-plaintext highlighter-rouge">confirm_isfile()</code>처럼 <strong>호출할 때마다<code class="language-plaintext highlighter-rouge">ProcessPoolExecutor(max_workers=1)</code>를 만들고 닫는 구조</strong>라면,<br />
여러 스레드·async 컨텍스트에서 동시에 호출되어도 서로 독립적으로 돌아서 문제 없습니다. 각 호출이 자기 전용 프로세스를 잠깐 띄웠다가 타임아웃/완료 후 종료하니까요. 다만 <strong>동시 호출 수만큼 프로세스 생성 오버헤드</strong> 가 생깁니다(특히 Windows/macOS에서 spawn 비용 큼).</p>

<p>원하는 운영 방식에 따라 선택지가 두 가지예요.</p>

<h1 id="옵션-a-지금처럼-호출-단위-풀-생성">옵션 A: 지금처럼 “호출 단위 풀 생성”</h1>

<ul>
  <li>
    <p>장점: 동시 호출 안전(완전 독립), 리소스 누수 없음, 구현 간단.</p>
  </li>
  <li>
    <p>단점: 호출이 잦거나 동시에 많이 들어오면 프로세스 생성 오버헤드↑.</p>
  </li>
  <li>
    <p>스레드/async에서 동시에 불러도 OK. 단, async에서는 반드시 이벤트루프를 블로킹하지 않게 감싸야 함(아래 참고).</p>
  </li>
</ul>

<h1 id="옵션-b-공용-풀을-하나만-두고-직렬병렬-제어">옵션 B: “공용 풀”을 하나만 두고 직렬/병렬 제어</h1>

<ul>
  <li>
    <p>장점: 프로세스 생성/해제 오버헤드↓, 캐시를 얹기도 쉬움.</p>
  </li>
  <li>
    <p>단점: <code class="language-plaintext highlighter-rouge">max_workers=1</code>로 두면 요청이 큐에 쌓여 <strong>직렬 처리</strong> 됩니다. 여러 호출이 동시에 들어오면 뒤에 오는 건 타임아웃될 수 있어요. 병렬을 원하면 2~4로 늘리면 됩니다.</p>
  </li>
</ul>

<p>아래는 두 옵션의 안전한 패턴과 async/스레드에서 쓰는 방법입니다.</p>

<h2 id="옵션-a-유지호출-단위-풀--async스레드에서-호출">옵션 A 유지(호출 단위 풀) + async/스레드에서 호출</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 동기 호출은 그대로 사용
</span><span class="n">ok</span> <span class="o">=</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="c1"># 스레드에서 호출 (GUI 이벤트 루프 안막음)
</span><span class="kn">import</span> <span class="n">threading</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">t</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="c1"># asyncio에서 호출 (반드시 run_in_executor/to_thread로 감싸기)
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">confirm_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="c1"># 사용
</span><span class="n">ok</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="옵션-b-공용-풀권장-파라미터-예시-max_workers24">옵션 B: 공용 풀(권장 파라미터 예시: max_workers=2~4)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># file_checks_pool.py
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="nb">TimeoutError</span>
<span class="n">_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 병렬 2개
</span>
<span class="k">def</span> <span class="nf">_mp_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
    <span class="n">fut</span> <span class="o">=</span> <span class="n">_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_mp_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># 종료 시 정리(앱 종료 훅이나 다이얼로그 closeEvent에서 호출)
</span><span class="k">def</span> <span class="nf">shutdown_pool</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</code></pre></div></div>

<h3 id="async-래퍼">async 래퍼</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># asyncio에서 블로킹 피하기
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">file_checks_pool</span> <span class="kn">import</span> <span class="n">confirm_isfile</span> <span class="k">as</span> <span class="n">_confirm_isfile</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">_confirm_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="스레드-안전성">스레드 안전성</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ProcessPoolExecutor</code> 자체는 <strong>스레드 세이프</strong> 한 제출을 지원합니다. 여러 스레드에서 동시에 <code class="language-plaintext highlighter-rouge">submit()</code> 호출 가능.</p>
  </li>
  <li>
    <p>단, <code class="language-plaintext highlighter-rouge">max_workers=1</code>이면 제출은 되지만 실행은 <strong>순차적</strong> 입니다. 여러 곳에서 동시에 타임아웃 짧게 걸고 기다리면, 뒤의 Future들이 타임아웃으로 False를 받게 되는 건 정상 동작입니다. 필요하면 <code class="language-plaintext highlighter-rouge">max_workers</code>를 늘리거나, 호출 측에서 디바운싱/리밋을 두세요.</p>
  </li>
</ul>

<h1 id="추가-팁">추가 팁</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">quick_*</code>(부모 나열 기반 추정)는 순수 I/O + 지역 루프이므로 <strong>스레드·async 동시 호출 안전</strong> 합니다. 공유 상태가 없고, GIL로 간단히 보호됩니다.</p>
  </li>
  <li>
    <p>Qt/async 혼합 환경이면, 이벤트 루프를 막지 않도록 <code class="language-plaintext highlighter-rouge">confirm_*</code>를 항상 <code class="language-plaintext highlighter-rouge">run_in_executor</code>(또는 <code class="language-plaintext highlighter-rouge">to_thread</code>)로 감싸세요.</p>
  </li>
  <li>
    <p>Windows/macOS에서 멀티프로세싱은 항상 <code class="language-plaintext highlighter-rouge">if __name__ == "__main__":</code> 가드가 필요합니다. Qt 앱 엔트리도 그 안에서 시작하세요.</p>
  </li>
  <li>
    <p>공용 풀을 쓴다면 앱 종료 시 <code class="language-plaintext highlighter-rouge">shutdown_pool()</code> 호출로 정리하는 습관을 들이면 좋습니다.</p>
  </li>
</ul>

<p>정리:</p>

<ul>
  <li>
    <p>지금 구조(호출 단위 풀)는 <strong>동시 호출에도 안전</strong> 하지만 오버헤드가 큽니다.</p>
  </li>
  <li>
    <p>공용 풀은 <strong>효율적</strong> 이고 스레드·async 모두 안전하되, <code class="language-plaintext highlighter-rouge">max_workers</code> 설정에 따라 직렬/병렬 특성이 달라지니 호출 패턴에 맞춰 수치만 잡으면 됩니다.</p>
  </li>
</ul>

<p class="chat--user">

근데 보니까 aiofiles 라는 패키지가 있네. 멀티프로세싱 대신 이걸 타임아웃 걸어서 쓰는건 어떨까

</p>

<p>좋은 발상인데, 딱 정리하면 이렇습니다.</p>

<ul>
  <li>
    <p>aiofiles는 파일 열기/읽기 같은 파일 I/O를 비동기로 다루기 위해 내부적으로 스레드풀을 씁니다. <code class="language-plaintext highlighter-rouge">os.path.isfile</code> 같은 stat 계열은 aiofiles가 감싸주지 않으니 <code class="language-plaintext highlighter-rouge">asyncio.to_thread</code>나 <code class="language-plaintext highlighter-rouge">run_in_executor</code>로 직접 감싸야 합니다.</p>
  </li>
  <li>
    <p>타임아웃은 <code class="language-plaintext highlighter-rouge">asyncio.wait_for</code>로 손쉽게 걸 수 있지만, 커널에서 stat이 오래 블록되면 스레드는 계속 붙잡혀 있고 코루틴만 취소됩니다. 즉, GUI는 살지만 백그라운드 스레드가 “끝날 때까지” 남습니다. 반면 멀티프로세싱은 프로세스를 내려서 정리할 수 있다는 차이가 있어요.</p>
  </li>
  <li>
    <p>정리: 이미 앱에 asyncio 루프(예: qasync 사용)가 있고, 네트워크 환경이 아주 험하지 않다면 aiofiles/스레드 경로가 간단하고 충분합니다. 오랫동안 먹통이 되는 경로가 많다면 멀티프로세싱이 더 안전합니다.</p>
  </li>
</ul>

<p>아래는 깔끔한 비동기 버전입니다. 하드코딩 규칙 없이, 타임박스 중심으로 동작합니다.</p>

<h3 id="1-빠른-추정동기-부모-나열-타임박스">1) 빠른 추정(동기, 부모 나열 타임박스)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">def</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span> <span class="n">parent</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
                    <span class="k">elif</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_file</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="p">))</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>
</code></pre></div></div>

<h3 id="2-aiofiles-없이-asyncio로-확정-확인-스레드풀--타임아웃">2) aiofiles 없이 asyncio로 “확정 확인” (스레드풀 + 타임아웃)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="n">coro</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_isdir_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="n">coro</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_exists_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="n">coro</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>참고: aiofiles를 꼭 쓰고 싶다면 <code class="language-plaintext highlighter-rouge">await asyncio.wait_for(asyncio.to_thread(os.path.isfile, path), timeout)</code>처럼 동일하게 감싸면 됩니다. 실질적으로는 위 코드와 같습니다.</p>

<h3 id="3-안전-래퍼-빠른-추정--필요-시-비동기-확정">3) 안전 래퍼: 빠른 추정 → 필요 시 비동기 확정</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">safe_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="k">await</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">safe_isdir_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="k">await</span> <span class="nf">confirm_isdir_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">safe_exists_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="k">await</span> <span class="nf">confirm_exists_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="4-pyside6와-같이-쓰는-방법">4) PySide6와 같이 쓰는 방법</h3>

<ul>
  <li>
    <p>Qt 이벤트 루프와 asyncio를 함께 쓰려면 qasync를 쓰는 게 깔끔합니다.</p>
  </li>
  <li>
    <p>버튼 클릭 시 <code class="language-plaintext highlighter-rouge">asyncio.create_task(safe_isfile_async(...))</code>로 던지고, 완료되면 OK 버튼 상태를 갱신합니다.</p>
  </li>
  <li>
    <p>타임아웃이 발생해도 스레드는 죽지 않고 백그라운드에서 끝까지 돌 수 있습니다. 보통 문제 없지만, 호출 폭주를 막으려면 디바운스/동시 실행 제한을 두세요.</p>
  </li>
</ul>

<h3 id="5-멀티프로세싱과-비교한-장단점-요약">5) 멀티프로세싱과 비교한 장단점 요약</h3>

<ul>
  <li>
    <p>aiofiles/스레드 방식</p>

    <ul>
      <li>
        <p>장점: 설정 간단, 프로세스 스폰 오버헤드 없음, UI와 자연스러운 연동.</p>
      </li>
      <li>
        <p>단점: 타임아웃이 걸려도 실제 OS 호출 스레드는 살아 있어 누적될 수 있음. 아주 느린 네트워크/autofs에서 많이 호출하면 스레드풀 고갈 가능성.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>멀티프로세싱</p>

    <ul>
      <li>
        <p>장점: 최악의 블로킹에서 격리 안전. 필요시 프로세스 종료로 강제 정리 가능.</p>
      </li>
      <li>
        <p>단점: 스폰 비용, 코드·배포 복잡도 증가.</p>
      </li>
    </ul>
  </li>
</ul>

<p>실전 추천은 이렇습니다.</p>

<ul>
  <li>
    <p>앱이 이미 qasync로 asyncio를 쓰고 있고, 경로 확인 호출 빈도가 낮거나 중간 정도라면 위 비동기 스레드풀+타임아웃 구성이 가장 단순합니다.</p>
  </li>
  <li>
    <p>네트워크 마운트가 “자주” 느려지는 환경이면, 비동기 버전을 기본으로 쓰되, 타임아웃이 일정 횟수 연속 발생할 때만 멀티프로세싱 경로로 자동 폴백하는 하이브리드가 제일 튼튼합니다.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">웹 한글 키보드 추가</title><link href="https://hvppyarchive.github.io/misc/web-korean-keyboard/" rel="alternate" type="text/html" title="웹 한글 키보드 추가" /><published>2025-11-07T20:48:31+09:00</published><updated>2025-11-07T20:48:31+09:00</updated><id>https://hvppyarchive.github.io/misc/web-korean-keyboard</id><content type="html" xml:base="https://hvppyarchive.github.io/misc/web-korean-keyboard/"><![CDATA[<p class="chat--user">

&lt;!DOCTYPE HTML&gt; &lt;html&gt; &lt;head&gt; <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <meta http-equiv="X-UA-Compatible" content="IE=edge" /> <link href="kbd.css" rel="stylesheet" type="text/css" /> <script src="kbd.js"></script> <script> var controller, visible = true; function onPageLoaded() { var input = document.getElementById('t1'); controller = new i18n.input.keyboard.Keyboard(); controller.loadLayout('vi_telex'); controller.loadLayout('vi_vni'); controller.loadLayout('deva_phone'); controller.loadLayout('gu_phone'); controller.loadLayout('ar'); controller.loadLayout('he'); controller.loadLayout('ps'); controller.loadLayout('ur'); controller.loadLayout('fa'); controller.loadLayout('ko'); controller.loadLayout('bg_phone'); controller.loadLayout('yi'); controller.loadLayout('fr'); controller.loadLayout('ml_phone'); controller.loadLayout('kn_phone'); controller.loadLayout('sa_phone'); controller.loadLayout('ca'); controller.loadLayout('th_pattajoti'); controller.loadLayout('th_tis'); controller.loadLayout('ta_typewriter'); controller.loadLayout('ta_itrans'); controller.loadLayout('ne_inscript'); controller.loadLayout('ne_phone'); controller.loadLayout('us_intl'); controller.loadLayout('ethi'); controller.loadLayout('nv'); controller.reposition(input, 5, 4, [5, 0, 0, 0]); controller.activateLayout('ne_inscript'); controller.register(input); controller.addEventListener( 'kc', function() { visible = false; }); input.focus(); } function onLayoutSelected(layoutCode) { controller.activateLayout(layoutCode); document.getElementById('t1').focus(); } function toggle() { if (controller) { controller.setVisible(visible = !visible); } } </script> &lt;/head&gt; &lt;body onload='onPageLoaded()'&gt; <select onchange="onLayoutSelected(this.value)"> <option value="vi_vni">vi_vni</option> <option value="ml_phone">ml_phone</option> <option value="vi_telex">vi_telex</option> <option value="deva_phone">deva_phone</option> <option value="gu_phone">gu_phone</option> <option value="ar">ar</option> <option value="he">he</option> <option value="ps">ps</option> <option value="ur">ur</option> <option value="fa">fa</option> <option value="ko">ko</option> <option value="yi">yi</option> <option value="bg_phone">bg_phone</option> <option value="fr">fr</option> <option value="kn_phone">kn_phone</option> <option value="sa_phone">sa_phone</option> <option value="ca">ca</option> <option value="th_pattajoti">th_pattajoti</option> <option value="th_tis">th_tis</option> <option value="ta_typewriter">ta_typewriter</option> <option value="ta_itrans">ta_itrans</option> <option value="ne_inscript" selected="">ne_inscript</option> <option value="ne_phone">ne_phone</option> <option value="us_intl">us_intl</option> <option value="ethi">ethi</option> <option value="nv">nv</option> </select> <input type="input" id="t1" style="width: 400px" /> <input type="button" value="Toggle show/hide" onclick="javascript:toggle()" /> <br /> &lt;/body&gt; &lt;/html&gt; 이 코드 해석 좀

</p>

<p>아래 HTML/JS는 “가상 키보드 위젯”을 특정 입력창에 붙여서 여러 언어 레이아웃 간 전환을 지원하는 예제예요. 핵심은 kbd.js에 들어있는 i18n.input.keyboard.Keyboard 클래스를 써서 키보드 팝업을 띄우고, <select>로 레이아웃을 바꾸는 구조입니다.</select></p>

<h1 id="한-줄-요약">한 줄 요약</h1>

<p>페이지가 로드되면 가상 키보드를 만들고 다양한 언어 레이아웃을 미리 로드한 뒤, 입력창(#t1)에 붙입니다. 드롭다운으로 레이아웃을 바꾸고, 버튼으로 키보드 표시/숨김을 전환합니다.</p>

<h1 id="구성-요소별-해설">구성 요소별 해설</h1>

<h2 id="1-head-설정">1) <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> 설정</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">meta</code> 태그: UTF-8 인코딩, IE에서 최신 렌더링 모드 사용.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">link href="kbd.css"</code>: 가상 키보드 UI 스타일.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">script src='kbd.js'</code>: 키보드 엔진이 들어있는 스크립트. 여기서 <code class="language-plaintext highlighter-rouge">i18n.input.keyboard.Keyboard</code> 클래스와 레이아웃 코드들이 제공됩니다.</p>
  </li>
</ul>

<h2 id="2-전역-변수">2) 전역 변수</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

var controller, visible = true;
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">controller</code>: 키보드 인스턴스를 담을 변수.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">visible</code>: 키보드 표시 상태. 토글 버튼과 이벤트 리스너에서 쓸 플래그.</p>
  </li>
</ul>

<h2 id="3-onpageloaded-페이지-로드-시-초기화">3) <code class="language-plaintext highlighter-rouge">onPageLoaded()</code>: 페이지 로드 시 초기화</h2>

<p>흐름을 단계별로 보면 이렇습니다.</p>

<ol>
  <li>대상 입력창 찾기</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

var input = document.getElementById('t1');
</code></pre></div></div>

<ol>
  <li>키보드 인스턴스 생성</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller = new i18n.input.keyboard.Keyboard();
</code></pre></div></div>

<ol>
  <li>사용할 레이아웃들 미리 로드</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.loadLayout('vi_telex');
// ... 여러 번 호출 ...
controller.loadLayout('nv');
</code></pre></div></div>

<p>여기서 ‘vi_telex’, ‘ko’, ‘ar’ 같은 문자열은 각 언어/자판 이름입니다. 필요한 레이아웃만 골라서 로드해도 됩니다.</p>

<ol>
  <li>키보드 위치 지정</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.reposition(input, 5, 4, [5, 0, 0, 0]);
</code></pre></div></div>

<ul>
  <li>대상 <code class="language-plaintext highlighter-rouge">input</code> 주변에 가상 키보드가 어디에 뜰지 정합니다. 인수 의미는 라이브러리 구현에 따라 다르지만, 보통 기준 요소, 오프셋, 여백 같은 좌표 파라미터입니다.</li>
</ul>

<ol>
  <li>기본 활성 레이아웃 설정</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.activateLayout('ne_inscript');
</code></pre></div></div>

<ul>
  <li>초기값으로 네팔어 인스크립트 자판을 선택.</li>
</ul>

<ol>
  <li>입력창에 키보드 연결</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.register(input);
</code></pre></div></div>

<ul>
  <li>이 입력창에 포커스가 오면 키보드를 붙여서 입력 이벤트를 가로채고, 가상 키 입력을 넣어줍니다.</li>
</ul>

<ol>
  <li>특정 이벤트 리스너 등록</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.addEventListener('kc', function() { visible = false; });
</code></pre></div></div>

<ul>
  <li>‘kc’는 라이브러리 쪽 이벤트(아마 key commit/keypress 완료 같은 의미)로 보입니다. 이벤트가 발생하면 <code class="language-plaintext highlighter-rouge">visible</code>을 false로 바꿔요. 단, 실제로 화면을 숨기지는 않고 플래그만 바꿉니다. 숨김 처리는 <code class="language-plaintext highlighter-rouge">toggle()</code>에서 <code class="language-plaintext highlighter-rouge">controller.setVisible(visible)</code>을 호출할 때 반영됩니다.</li>
</ul>

<ol>
  <li>입력창에 포커스</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

input.focus();
</code></pre></div></div>

<h2 id="4-onlayoutselectedlayoutcode-드롭다운으로-레이아웃-변경">4) <code class="language-plaintext highlighter-rouge">onLayoutSelected(layoutCode)</code>: 드롭다운으로 레이아웃 변경</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.activateLayout(layoutCode);
document.getElementById('t1').focus();
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;select&gt;</code>에서 선택된 값(레이아웃 코드)을 받아서 즉시 전환하고, 다시 입력창에 포커스를 줍니다.</li>
</ul>

<h2 id="5-toggle-표시숨김-전환">5) <code class="language-plaintext highlighter-rouge">toggle()</code>: 표시/숨김 전환</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

if (controller) {
  controller.setVisible(visible = !visible);
}
</code></pre></div></div>

<ul>
  <li>전역 플래그를 뒤집고, 실제 키보드 UI를 보여주거나 감춥니다.</li>
</ul>

<h2 id="6-body-ui-요소들">6) <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code>: UI 요소들</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">onload='onPageLoaded()'</code>: 페이지 로드 후 초기화 실행.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;select onchange='onLayoutSelected(this.value)'&gt;</code>: 레이아웃 목록. 옵션 value가 곧 레이아웃 코드입니다. 기본 선택은 <code class="language-plaintext highlighter-rouge">ne_inscript</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;input id='t1'&gt;</code>: 실제로 타이핑할 입력창.</p>
  </li>
  <li>
    <p>“Toggle show/hide” 버튼: 가상 키보드 표시/숨김 전환.</p>
  </li>
</ul>

<h1 id="눈에-띄는-포인트와-개선-팁">눈에 띄는 포인트와 개선 팁</h1>

<ol>
  <li><code class="language-plaintext highlighter-rouge">input</code>의 type 속성<br />
현재 <code class="language-plaintext highlighter-rouge">type='input'</code>인데, 표준 값은 <code class="language-plaintext highlighter-rouge">type='text'</code>가 맞습니다.</li>
</ol>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"t1"</span> <span class="na">style=</span><span class="s">"width: 400px"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<ol>
  <li>불필요하거나 불명확한 이벤트 처리<br />
<code class="language-plaintext highlighter-rouge">'kc'</code> 이벤트에서 <code class="language-plaintext highlighter-rouge">visible = false;</code>만 하고 실제 숨김은 하지 않습니다. 키 입력 후 자동으로 키보드를 숨기고 싶다면 <code class="language-plaintext highlighter-rouge">setVisible(false)</code>까지 호출해야 의도가 확실해집니다.</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.addEventListener('kc', function() {
  visible = false;
  controller.setVisible(false);
});
</code></pre></div></div>

<p>반대로 숨기고 싶지 않다면 이 리스너를 제거하세요.</p>

<ol>
  <li>초기 표시 상태 일관성<br />
초기 <code class="language-plaintext highlighter-rouge">visible = true</code>지만 실제로 키보드를 보여주는 코드를 직접 호출하지 않습니다. 라이브러리에 따라 <code class="language-plaintext highlighter-rouge">register()</code>만으로 기본 표시가 될 수도, 포커스 때만 뜰 수도 있어요. 항상 보이게 하려면 초기화 끝에 아래를 호출해 일관성을 보장할 수 있습니다.</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.setVisible(true);
</code></pre></div></div>

<ol>
  <li>레이아웃 로딩 최적화<br />
지금은 상당히 많은 레이아웃을 모두 로드합니다. 실제로 필요한 것만 <code class="language-plaintext highlighter-rouge">loadLayout</code> 하거나, 선택 시점에 지연 로드하도록 바꾸면 초기 로딩이 가벼워집니다. 예:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function onLayoutSelected(code) {
  if (!controller.isLayoutLoaded(code)) controller.loadLayout(code);
  controller.activateLayout(code);
  t1.focus();
}
</code></pre></div></div>

<p>(라이브러리에 <code class="language-plaintext highlighter-rouge">isLayoutLoaded</code> 같은 헬퍼가 없다면 내부 상태를 직접 관리해야 합니다.)</p>

<ol>
  <li>접근성 및 i18n 배려</li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;label for="t1"&gt;</code>를 추가하고, 드롭다운에도 라벨을 붙이면 스크린 리더 호환성이 좋아집니다.</p>
  </li>
  <li>
    <p>레이아웃 코드 대신 사람 친화적인 이름(예: “한국어(두벌식)”)을 <code class="language-plaintext highlighter-rouge">&lt;option&gt;</code> 텍스트에 사용하세요.</p>
  </li>
</ul>

<ol>
  <li>스타일 조정<br />
가상 키보드가 화면을 가리면 <code class="language-plaintext highlighter-rouge">reposition(...)</code> 인자를 조정하거나, <code class="language-plaintext highlighter-rouge">kbd.css</code>에서 z-index/position을 손봐 배치 품질을 올릴 수 있습니다.</li>
</ol>

<h1 id="동작-순서-정리">동작 순서 정리</h1>

<ol>
  <li>
    <p>페이지 로드 → <code class="language-plaintext highlighter-rouge">onPageLoaded()</code> 실행.</p>
  </li>
  <li>
    <p>키보드 인스턴스 생성 → 여러 레이아웃 로드 → 입력창에 부착 → 기본 레이아웃 활성.</p>
  </li>
  <li>
    <p>드롭다운 선택 시 <code class="language-plaintext highlighter-rouge">onLayoutSelected()</code>로 레이아웃 전환.</p>
  </li>
  <li>
    <p>“Toggle show/hide” 버튼으로 키보드 표시/숨김 전환.</p>
  </li>
</ol>

<p>필요하면 이 코드를 기반으로 기본 레이아웃을 한국어(<code class="language-plaintext highlighter-rouge">'ko'</code>)로 바꾸거나, 처음부터 숨김으로 시작하도록 세팅하는 변형 예시도 바로 만들어 드릴 수 있어요.</p>

<p class="chat--user">

가상 키보드 없이 입력을 했을때 한글로 입력되게 할 순 없나

</p>

<p>짧게 결론부터 말하면, 브라우저만으로 사용자의 <strong>입력기(IME)</strong>를 한글로 전환시킬 수는 없어요. <code class="language-plaintext highlighter-rouge">lang="ko"</code>나 <code class="language-plaintext highlighter-rouge">inputmode</code> 같은 HTML 속성도 IME를 바꾸지 않습니다. 즉, 가상 키보드 없이 곧장 한글이 찍히게 하려면 선택지는 세 가지예요.</p>

<h2 id="가능한-방법">가능한 방법</h2>

<ol>
  <li>
    <p>운영체제/브라우저 IME 사용<br />
사용자가 OS에서 한글 입력기를 켜도록 안내하는 방법입니다. 가장 안정적이고 표준적이지만, 코드만으로 강제할 수는 없습니다.</p>
  </li>
  <li>
    <p>“보이지 않는” JS 입력기(자동 변환)<br />
가상 키보드 UI는 없지만, 자바스크립트가 키 입력을 가로채서 영문 키를 <strong>한글 자모로 매핑</strong> 하고, <strong>자동 합성(초/중/종성 조합)</strong> 해서 인풋에 넣는 방식입니다. 사용자는 평소처럼 타이핑하지만 결과는 한글로 들어갑니다.<br />
핵심은 두 단계:</p>
  </li>
</ol>

<ul>
  <li>
    <p>키 매핑: 예) 2벌식 기준으로 <code class="language-plaintext highlighter-rouge">r → ㄱ</code>, <code class="language-plaintext highlighter-rouge">k → ㅏ</code>, <code class="language-plaintext highlighter-rouge">s → ㄴ</code> …</p>
  </li>
  <li>
    <p>합성: 들어온 자모들을 초성/중성/종성 규칙에 맞춰 유니코드 한글 음절로 조합</p>
  </li>
</ul>

<p>완전한 합성 로직을 직접 구현하려면 꽤 길어집니다. 보통은 <strong>Hangul 조합 라이브러리</strong>(예: <code class="language-plaintext highlighter-rouge">Hangul.assemble()</code> 같은 API 제공)를 써서 자모 배열을 음절로 합칩니다.</p>

<p>아래는 “UI 없는 한글 입력기”의 최소 예시 흐름입니다. 실제 서비스용이라면 자모/합성 규칙을 모두 보강해야 합니다.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"t1"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">style=</span><span class="s">"width:400px"</span><span class="nt">&gt;</span>

<span class="nt">&lt;script&gt;</span>
  <span class="c1">// 2벌식 키→자모(데모용: 일부만 수록)</span>
  <span class="kd">const</span> <span class="nx">keyToJamo</span> <span class="o">=</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">r</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㄱ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">s</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㄴ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">e</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㄷ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">f</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㄹ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅁ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">q</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅂ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅅ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">d</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅇ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">w</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅈ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">c</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅊ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">z</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅋ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅌ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">v</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅍ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">g</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅎ</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">k</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅏ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅐ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">i</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅑ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">j</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅓ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">p</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅔ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">u</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅕ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">h</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅗ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">y</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅛ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">n</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅜ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">b</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅠ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">m</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅡ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">l</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ㅣ</span><span class="dl">'</span>
  <span class="p">};</span>

  <span class="c1">// 간단 합성기: 자모가 늘어날 때마다 음절로 조립</span>
  <span class="c1">// 실전용은 초/중/종성 상태머신과 복합모음/겹받침 처리 필요</span>
  <span class="kd">function</span> <span class="nf">assembleHangul</span><span class="p">(</span><span class="nx">jamoArray</span><span class="p">){</span>
    <span class="c1">// 예시: Hangul.js 같은 라이브러리가 있으면 Hangul.assemble(jamoArray) 사용</span>
    <span class="c1">// 여기서는 초간단(불완전) 합성기로 대체: 자모를 그냥 이어 붙임</span>
    <span class="c1">// → 실제 프로젝트에서는 반드시 정식 합성 로직/라이브러리를 쓰세요!</span>
    <span class="k">return</span> <span class="nx">jamoArray</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">t1</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="p">[];</span>    <span class="c1">// 자모 버퍼</span>
  <span class="kd">let</span> <span class="nx">composing</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span> <span class="c1">// 현재 합성 결과</span>

  <span class="nx">input</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// 조합 중에 일반 동작 막고 우리가 넣는다</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">altKey</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// 단축키는 통과</span>
    <span class="kd">const</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
    <span class="c1">// 백스페이스 처리(버퍼에서 자모 하나 제거)</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">k</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Backspace</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="nx">buffer</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
        <span class="nx">composing</span> <span class="o">=</span> <span class="nf">assembleHangul</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
        <span class="nf">replaceTail</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">composing</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 엔터/탭/방향키 등은 통과</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">jamo</span> <span class="o">=</span> <span class="nx">keyToJamo</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">jamo</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// 매핑 없는 키는 통과(영문 그대로 치고 싶다면 여기서 return 하지 말고 허용)</span>

    <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">jamo</span><span class="p">);</span>
    <span class="nx">composing</span> <span class="o">=</span> <span class="nf">assembleHangul</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="nf">replaceTail</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">composing</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// 커서 위치의 “최근 조합 문자열”을 치환(데모: 입력 전체를 덮어쓰기)</span>
  <span class="kd">function</span> <span class="nf">replaceTail</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">text</span><span class="p">){</span>
    <span class="c1">// 간단화를 위해 입력 전체를 조합 결과로 치환(실전: selectionStart/End로 부분 치환)</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>주의사항</p>

<ul>
  <li>
    <p>위 코드는 <strong>합성 로직을 거의 생략</strong> 한 데모라서 “감사” 같은 음절 조합이 제대로 안 됩니다. 반드시 <strong>정식 합성기</strong> 를 붙이세요. (유니코드 한글은 <code class="language-plaintext highlighter-rouge">AC00</code>부터 초·중·종성을 수식으로 조합합니다.)</p>
  </li>
  <li>
    <p>영문을 그대로도 입력해야 한다면, 매핑되지 않은 키는 <code class="language-plaintext highlighter-rouge">preventDefault</code> 하지 않고 원래대로 통과시키면 됩니다. 반대로 “무조건 한글만”이면 모든 알파벳을 가로채세요.</p>
  </li>
  <li>
    <p>모바일에서는 소프트 키보드/자동 교정과 충돌할 수 있어 <code class="language-plaintext highlighter-rouge">inputmode</code>와 이벤트 처리를 꼼꼼히 테스트해야 합니다.</p>
  </li>
  <li>
    <p>contenteditable 영역에서도 <code class="language-plaintext highlighter-rouge">beforeinput</code>/<code class="language-plaintext highlighter-rouge">input</code> 이벤트를 쓰면 비슷한 방식으로 구현 가능합니다.</p>
  </li>
</ul>

<ol>
  <li>사후 변환(사용자는 영문 로마자 입력 → 제출 시 서버/클라이언트에서 한글로 변환)<br />
실시간 조합이 부담스러우면 이 방식이 단순합니다. 제출 직전에 영문을 한글로 바꾸는 버튼/옵션을 두는 식이죠.</li>
</ol>

<h2 id="정리">정리</h2>

<ul>
  <li>
    <p>브라우저가 IME를 바꿔주지는 못한다.</p>
  </li>
  <li>
    <p>UI 없는 <strong>JS 입력기(자모 매핑 + 합성)</strong> 로 “가상 키보드 없이도 한글처럼” 입력되게 만드는 건 가능하다.</p>
  </li>
  <li>
    <p>실제로 쓰려면 표준 2벌식 전체 매핑, 겹모음/겹받침, 되돌리기(Backspace) 처리, 커서 위치 치환 등을 갖춘 <strong>완성된 합성기</strong> 가 필요하다.</p>
  </li>
</ul>

<p>원하시면 위 데모를 기반으로 2벌식 전체 매핑과 정식 합성 로직까지 탑재한 버전을 바로 만들어 드릴게요.</p>

<p class="chat--user">

내가 준 소스는 그런 기능은 아니야?

</p>

<p>가능해요. 네가 준 코드는 “가상 키보드 UI”를 띄우는 게 기본이지만, 실제로는 <strong>키 입력을 가로채서 선택한 레이아웃(예: ‘ko’)대로 문자를 넣는 엔진</strong> 이 핵심이라서, UI를 <strong>숨긴 채로</strong> 한글이 입력되게 만들 수 있어요. 즉, 페이지 안에서만 동작하는 “간이 IME”처럼 쓸 수 있습니다.</p>

<p>정리하자면</p>

<ul>
  <li>
    <p>OS의 한글 IME를 켜주는 건 아니지만,</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">controller</code>가 활성화된 입력창에서는 물리 키보드 입력을 <strong>2벌식 한글 조합</strong> 으로 변환해서 넣어줄 수 있고,</p>
  </li>
  <li>
    <p>가상 키보드 패널은 <code class="language-plaintext highlighter-rouge">setVisible(false)</code>로 감춰도 동작합니다.</p>
  </li>
</ul>

<p>아래처럼 최소 수정하면 됩니다.</p>

<h3 id="핵심-수정-포인트">핵심 수정 포인트</h3>

<ol>
  <li>
    <p>기본 레이아웃을 한국어로 바꾸기</p>
  </li>
  <li>
    <p>가상 키보드 패널을 시작부터 숨기기</p>
  </li>
  <li>
    <p>드롭다운/토글이 필요 없으면 제거(선택 사항)</p>
  </li>
</ol>

<h3 id="예시-수정-코드">예시 수정 코드</h3>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"kbd.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"kbd.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script&gt;</span>
    <span class="kd">var</span> <span class="nx">controller</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nf">onPageLoaded</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">t1</span><span class="dl">'</span><span class="p">);</span>

      <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">i18n</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">keyboard</span><span class="p">.</span><span class="nc">Keyboard</span><span class="p">();</span>

      <span class="c1">// 필요한 레이아웃만 남겨도 됩니다.</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">loadLayout</span><span class="p">(</span><span class="dl">'</span><span class="s1">ko</span><span class="dl">'</span><span class="p">);</span>          <span class="c1">// 한국어</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">loadLayout</span><span class="p">(</span><span class="dl">'</span><span class="s1">us_intl</span><span class="dl">'</span><span class="p">);</span>     <span class="c1">// 필요 시 영문 국제 배열 등</span>

      <span class="nx">controller</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>           <span class="c1">// 입력창에 연결</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">activateLayout</span><span class="p">(</span><span class="dl">'</span><span class="s1">ko</span><span class="dl">'</span><span class="p">);</span>      <span class="c1">// ★ 기본 한글 레이아웃 선택</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">reposition</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>

      <span class="nx">controller</span><span class="p">.</span><span class="nf">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>         <span class="c1">// ★ 패널은 숨기고 엔진만 동작</span>
      <span class="c1">// 불필요: 아래 리스너는 패널 표시 상태만 건드립니다.</span>
      <span class="c1">// controller.addEventListener('kc', function(){ ... });</span>

      <span class="nx">input</span><span class="p">.</span><span class="nf">focus</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// 드롭다운으로 바꾸고 싶다면 유지</span>
    <span class="kd">function</span> <span class="nf">onLayoutSelected</span><span class="p">(</span><span class="nx">layoutCode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">activateLayout</span><span class="p">(</span><span class="nx">layoutCode</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">t1</span><span class="dl">'</span><span class="p">).</span><span class="nf">focus</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">"onPageLoaded()"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- 드롭다운을 유지하고 싶다면 'ko'를 기본 선택으로 --&gt;</span>
  <span class="nt">&lt;select</span> <span class="na">onchange=</span><span class="s">"onLayoutSelected(this.value)"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">"ko"</span> <span class="na">selected</span><span class="nt">&gt;</span>ko<span class="nt">&lt;/option&gt;</span>
    <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">"us_intl"</span><span class="nt">&gt;</span>us_intl<span class="nt">&lt;/option&gt;</span>
  <span class="nt">&lt;/select&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"t1"</span> <span class="na">style=</span><span class="s">"width:400px"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- 패널 토글 버튼은 불필요하면 제거 --&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>사용 팁</p>

<ul>
  <li>
    <p>이 방식은 <strong>해당 입력창에서만</strong> 영→한 변환이 적용됩니다. 다른 필드나 OS 전체 입력기엔 영향이 없어요.</p>
  </li>
  <li>
    <p>물리 키보드가 US 배열이라고 가정하는 매핑이 많습니다. 키보드 배열이 다르면 일부 키 위치가 달라질 수 있어요.</p>
  </li>
  <li>
    <p>한글 조합은 라이브러리가 처리합니다. 커서 이동/백스페이스 등 일반 편집 동작도 라이브러리 쪽 로직을 따릅니다.</p>
  </li>
</ul>

<p>원하면 드롭다운도 없애고 <strong>항상 한글만</strong> 들어가도록 깔끔하게 정리한 버전으로도 바로 바꿔드릴게요.</p>

<p class="chat--user">

&lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>Korean Keyboard</title> <!-- 防缓存META标签 --> <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /> <meta http-equiv="Pragma" content="no-cache" /> <meta http-equiv="Expires" content="0" /> <!-- 带版本戳的样式表 --> <link rel="stylesheet" href="style.css?v=20250802" /> &lt;/head&gt; &lt;body&gt; <!-- 语言切换器 --> &lt;div class="language-selector"&gt; &lt;div class="language-buttons" id="languageButtons"&gt;&lt;/div&gt; &lt;/div&gt; &lt;div class="container"&gt; &lt;h1&gt;Korean Input Test&lt;/h1&gt; <!-- 说明文字移动到这里 --> &lt;div class="info"&gt; &lt;p&gt;Type with English keyboard and it will automatically convert to Korean.</p>
<p>Hold Shift to input more Korean characters.</p>
<p>&lt;/div&gt; &lt;div class="input-section"&gt; <textarea id="koreanInput" placeholder="Type in English and it will convert to Korean..."></textarea> &lt;/div&gt; &lt;div class="button-section"&gt; <button id="copyBtn">Copy</button> <button id="clearBtn">Clear</button> <button id="saveBtn">Save Text</button> <button id="fontSmallerBtn" title="Smaller Text">-</button> <button id="fontLargerBtn" title="Larger Text">+</button> &lt;/div&gt; <!-- 虚拟键盘区域 - 移除标题和控制 --> &lt;div class="virtual-keyboard-section"&gt; &lt;div class="virtual-keyboard" id="virtualKeyboard"&gt; <!-- 键盘布局将通过JavaScript动态生成 --> &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; <!-- 带版本戳的JavaScript文件 --> <script src="i18n.js?v=20250802"></script> <script src="virtual-keyboard.js?v=20250802"></script> <script src="korean-input.js?v=20250802"></script> &lt;footer class="site-footer"&gt; <a href="https://github.com/nonsensejoke/korean-keyboard" target="_blank" rel="noopener noreferrer"> <svg class="github-logo" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"> <path d="M12 0C5.373 0 0 5.373 0 12C0 17.523 3.438 22.093 8.205 23.5C8.795 23.6 9.025 23.225 9.025 22.9C9.025 22.6 9.015 21.685 9.01 20.705C5.672 21.415 4.965 19.165 4.965 19.165C4.445 17.815 3.65 17.415 3.65 17.415C2.61 16.685 3.73 16.705 3.73 16.705C4.855 16.785 5.425 17.815 5.425 17.815C6.425 19.565 8.125 19.065 8.75 18.785C8.85 18.115 9.125 17.665 9.425 17.415C6.885 17.135 4.225 16.125 4.225 11.755C4.225 10.455 4.675 9.395 5.425 8.575C5.315 8.295 4.925 7.155 5.525 5.605C5.525 5.605 6.485 5.295 8.985 6.845C9.915 6.585 10.925 6.455 11.975 6.455C13.025 6.455 14.035 6.585 14.965 6.845C17.465 5.295 18.425 5.605 18.425 5.605C19.025 7.155 18.635 8.295 18.525 8.575C19.275 9.395 19.725 10.455 19.725 11.755C19.725 16.135 17.065 17.135 14.515 17.415C14.895 17.735 15.225 18.335 15.225 19.205C15.225 20.555 15.215 21.625 15.215 21.9C15.215 22.225 15.445 22.605 16.045 22.5C20.825 21.085 24 16.515 24 11C24 4.373 18.627 0 12 0Z"></path> </svg> <span>nonsensejoke/korean-keyboard</span> </a> &lt;/footer&gt; &lt;/body&gt; &lt;/html&gt; 이 사이트 따라 만들고 싶어 근데 특정 키가 눌렷을때 한영 모드 전환되게</p>

<p>&lt;/p&gt;</p>

<p>좋아, “자동 한글 변환” 흐름은 그대로 두고, 특정 키를 눌렀을 때 한/영 입력 모드를 전환하도록 설계해보자. 핵심은 한글 조합 파이프라인 앞단에 “현재 IME 모드” 상태값을 두고, 단축키를 잡아 토글하는 거야. 모드가 ko면 기존 조합기로 처리, en이면 원래 브라우저 입력에 맡기면 된다.</p>

<p>아래는 바로 적용 가능한 설계와 코드 예시야. 파일 이름은 네가 올려둔 구조에 맞춰 넣었어.</p>

<h2 id="1-html에-모드-표시-추가선택">1) HTML에 모드 표시 추가(선택)</h2>

<p>사용자에게 지금 모드가 뭔지 보여주는 작은 칩을 추가하면 좋아.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"input-section"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ime-status"</span> <span class="na">aria-live=</span><span class="s">"polite"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"imeMode"</span><span class="nt">&gt;</span>KO<span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;textarea</span> <span class="na">id=</span><span class="s">"koreanInput"</span> <span class="na">placeholder=</span><span class="s">"Type in English and it will convert to Korean..."</span><span class="nt">&gt;&lt;/textarea&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>간단한 스타일은 style.css에 넣자.</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.ime-status</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">inline-block</span><span class="p">;</span>
  <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">6px</span><span class="p">;</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">12px</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">.8</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.ime-status</span> <span class="nf">#imeMode</span> <span class="p">{</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">2px</span> <span class="m">6px</span><span class="p">;</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">6px</span><span class="p">;</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="n">currentColor</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.ime-status</span> <span class="nf">#imeMode</span><span class="o">[</span><span class="nt">data-mode</span><span class="o">=</span><span class="s1">"ko"</span><span class="o">]</span> <span class="p">{</span> <span class="nl">content</span><span class="p">:</span> <span class="s1">"KO"</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.ime-status</span> <span class="nf">#imeMode</span><span class="o">[</span><span class="nt">data-mode</span><span class="o">=</span><span class="s1">"en"</span><span class="o">]</span> <span class="p">{</span> <span class="nl">content</span><span class="p">:</span> <span class="s1">"EN"</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="2-korean-inputjs에-한영-모드-상태와-토글-단축키-추가">2) korean-input.js에 한/영 모드 상태와 토글 단축키 추가</h2>

<p>포인트는 세 가지다.</p>

<ul>
  <li>
    <p>전역 모드 상태값(ko/en)</p>
  </li>
  <li>
    <p>단축키로 모드 토글</p>
  </li>
  <li>
    <p>모드가 en일 때는 가로채지 않고 기본 입력 흐름 유지</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// korean-input.js

// 1) 모드 상태
const MODE = { KO: 'ko', EN: 'en' };
let imeMode = (localStorage.getItem('imeMode') === MODE.EN) ? MODE.EN : MODE.KO;

const textarea = document.getElementById('koreanInput');
const modeChip = document.getElementById('imeMode');

function renderMode() {
  if (!modeChip) return;
  modeChip.textContent = (imeMode === MODE.KO) ? 'KO' : 'EN';
  modeChip.setAttribute('data-mode', imeMode);
}
renderMode();

// 2) 단축키 정의: Ctrl+Space 또는 F2 중 하나 눌러도 전환
function isToggleHotkey(e) {
  // OS 단축키 충돌이 있을 수 있으니 대안 키도 둔다
  // Ctrl+Space 또는 F2
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}

function toggleImeMode() {
  imeMode = (imeMode === MODE.KO) ? MODE.EN : MODE.KO;
  localStorage.setItem('imeMode', imeMode);
  renderMode();
  // 사용자 피드백(선택): 잠깐 하이라이트 주기
  if (modeChip) {
    modeChip.style.transition = 'background .2s';
    modeChip.style.background = 'rgba(0,0,0,.08)';
    setTimeout(() =&gt; modeChip.style.background = 'transparent', 150);
  }
}

// 3) 한글 조합기(네가 이미 갖고 있는 로직/객체를 사용)
// 예: composer.feedKey(e), composer.backspace(), composer.commit(), getComposedText() 같은 API를 가정
// 없다면 기존 네 조합 함수를 여기서 호출하도록 연결
importComposerIfNeeded(); // 실제로는 네 기존 모듈을 가져와 사용

// 커서/선택 치환 유틸
function replaceSelectionWith(textarea, text) {
  const { selectionStart, selectionEnd, value } = textarea;
  const before = value.slice(0, selectionStart);
  const after  = value.slice(selectionEnd);
  const newPos = before.length + text.length;
  textarea.value = before + text + after;
  textarea.setSelectionRange(newPos, newPos);
}

// 현재 조합 결과를 반영
function applyComposition(text) {
  // 단순히 현재 커서 위치에 합성 중 문자열을 반영하도록 구현
  // 네가 이미 구현한 방식이 있다면 그 방법으로 대체
  replaceSelectionWith(textarea, text);
}

// 4) 키 이벤트 훅
textarea.addEventListener('keydown', (e) =&gt; {
  // 4-1) 모드 토글
  if (isToggleHotkey(e)) {
    e.preventDefault();
    toggleImeMode();
    return;
  }

  // 4-2) EN 모드일 땐 가로채지 않음
  if (imeMode === MODE.EN) return;

  // 4-3) KO 모드: 조합기가 처리할 키만 가로채기
  // 조합기에서 처리하는 키의 범위는 너의 구현에 맞춰 조정
  // 예: 영문자/숫자/백스페이스/스페이스 정도는 preventDefault하고 composer로 넘기기
  const k = e.key;
  const isChar = k.length === 1; // 한 글자 키
  const isBackspace = (k === 'Backspace');
  const isSpace = (k === ' ');
  const isEnter = (k === 'Enter');

  // 방향키/홈/엔드 등은 통과시켜야 편집이 가능
  if (!isChar &amp;&amp; !isBackspace &amp;&amp; !isSpace &amp;&amp; !isEnter) return;

  // 여기서부터는 조합기에게 위임
  e.preventDefault();

  if (isBackspace) {
    composer.backspace();
    applyComposition(composer.text()); // composer.text(): 현재 합성 문자열
    return;
  }
  if (isEnter) {
    // 줄바꿈은 조합을 커밋하고 개행 추가
    const committed = composer.commit();
    replaceSelectionWith(textarea, committed + '\n');
    return;
  }
  if (isSpace) {
    // 스페이스는 조합 커밋 후 공백
    const committed = composer.commit();
    replaceSelectionWith(textarea, committed + ' ');
    return;
  }

  // 일반 문자: 조합기에 먹이고 반영
  composer.feedKey(e);              // 내부에서 2벌식/겹모음/겹받침 처리
  applyComposition(composer.text()); // 합성중 문자열 반영
});

// 5) 포커스 아웃 시 조합 커밋(선택)
textarea.addEventListener('blur', () =&gt; {
  if (imeMode === MODE.KO) {
    const committed = composer.commit();
    if (committed) replaceSelectionWith(textarea, committed);
  }
});

// 6) 가상 키보드와도 모드 동기화(선택)
// 만약 virtual-keyboard.js에서 '한/영' 키를 렌더링한다면:
document.addEventListener('vk:toggle-ime', () =&gt; {
  toggleImeMode();
});
</code></pre></div></div>

<h3 id="주의할-점">주의할 점</h3>

<ul>
  <li>
    <p>OS 단축키 충돌: Ctrl+Space는 macOS/Windows 모두에서 IME 전환으로 쓰일 때가 있다. 브라우저에 키가 도달하면 위 코드가 잡지만, OS 단계에서 먹히면 이벤트가 아예 안 온다. 그래서 F2 같은 대체 키를 함께 두었다.</p>
  </li>
  <li>
    <p>모바일: 소프트 키보드에서는 물리키 이벤트가 제한적이다. 모바일 지원을 원하면 화면에 “한/영” 토글 버튼을 하나 배치해 <code class="language-plaintext highlighter-rouge">toggleImeMode()</code>를 눌러주게 하자.</p>
  </li>
  <li>
    <p>Undo/Redo: <code class="language-plaintext highlighter-rouge">preventDefault</code>로 직접 값을 바꾸면 기본 Undo 스택과 엮이는 방식이 달라질 수 있다. 큰 단위(커밋 시점)로만 value를 바꾸거나, <code class="language-plaintext highlighter-rouge">beforeinput</code> 이벤트를 사용해 브라우저 편집 힌트를 맞춰주면 품질이 오른다.</p>
  </li>
  <li>
    <p>선택 영역 편집: 위 예시는 커서 기준 치환으로 단순화했다. 드래그 선택 후 입력·백스페이스 등도 정확히 작동하게 하려면 selectionStart/End 기준으로 조합 중 문자열 범위를 추적하거나, 커밋 시점마다 앵커를 갱신하자.</p>
  </li>
  <li>
    <p>조합기 API: 위에 쓴 <code class="language-plaintext highlighter-rouge">composer.feedKey/backspace/commit/text</code>는 네가 가진 한글 조합 로직에 맞춰 이름만 바꿔 붙이면 된다.</p>
  </li>
</ul>

<h2 id="3-virtual-keyboardjs에서-한영-키-눌렀을-때-토글선택">3) virtual-keyboard.js에서 ‘한/영’ 키 눌렀을 때 토글(선택)</h2>

<p>화면 키보드에도 한/영 키를 달고 싶다면, 클릭 시 커스텀 이벤트를 쏘자.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// virtual-keyboard.js 내부
function emitToggleIme() {
  const ev = new CustomEvent('vk:toggle-ime', { bubbles: true });
  document.dispatchEvent(ev);
}

// 키 렌더링 시
// &lt;button data-key="HANENG"&gt;한/영&lt;/button&gt;
keyboardRoot.addEventListener('click', (e) =&gt; {
  const key = e.target.closest('[data-key]');
  if (!key) return;
  const code = key.getAttribute('data-key');
  if (code === 'HANENG') {
    emitToggleIme();
    return;
  }
  // ... 기존 키 처리 ...
});
</code></pre></div></div>

<h2 id="4-키-매핑-우선순위">4) 키 매핑 우선순위</h2>

<ul>
  <li>
    <p>ko 모드일 때만 <code class="language-plaintext highlighter-rouge">preventDefault</code>로 잡아 한글 조합 흐름으로 보낸다.</p>
  </li>
  <li>
    <p>en 모드일 때는 최대한 브라우저 기본 동작을 살려둬야 텍스트 편집 경험이 자연스럽다.</p>
  </li>
  <li>
    <p>필요한 경우 숫자/기호도 조합기에서 처리할지 여부를 옵션화해라.</p>
  </li>
</ul>

<h2 id="5-빠른-체크리스트">5) 빠른 체크리스트</h2>

<ul>
  <li>
    <p>단축키: Ctrl+Space, F2 두 가지 다 제공</p>
  </li>
  <li>
    <p>모드 표시: 작은 칩으로 KO/EN 표기</p>
  </li>
  <li>
    <p>로컬 저장: 마지막 모드 기억(localStorage)</p>
  </li>
  <li>
    <p>포커스 아웃: 미커밋 문자 커밋</p>
  </li>
  <li>
    <p>모바일: 화면 토글 버튼 추가</p>
  </li>
</ul>

<p>이대로 넣으면 “특정 키를 눌러 한/영 전환”이 깔끔하게 붙는다. 네 조합기 함수 이름이 다르면 그 부분만 바꿔서 연결하면 되고, 원하면 CapsLock 전환, 오른쪽 Alt 등 다른 키 조합도 추가해줄 수 있어.</p>

<p class="chat--user">

내가 준 소스본거 맞아?

</p>

<p>짚고 갈게.</p>

<p>네가 <strong>이번에 올린 HTML 소스</strong> 는 다음 JS 파일들을 불러오고 있을 뿐,<br />
그 안의 내용(특히 korean-input.js / i18n.js / virtual-keyboard.js)은 <strong>여기 챗에 공유되지 않았어.</strong></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"i18n.js?v=20250802"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"virtual-keyboard.js?v=20250802"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"korean-input.js?v=20250802"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>즉,</p>

<p><strong>네가 준 건 ‘HTML 구조’이고, 실제 한글 자동 변환 기능은 저 JS 파일 안에 있다.</strong><br />
그리고 내가 위에서 작성해준 "한/영 모드 전환" 코드는 그 JS 내부에 추가해야 하는 기능 코드였어.</p>

<hr />

<h3 id="정답">정답</h3>

<p>너가 공유한 HTML 코드만으로는 <strong>"특정 키 눌러 한/영 전환" 기능이 없다.</strong></p>

<p>그리고 "따라 만들고 싶다"는 사이트 소스인지 확인하는 질문이라면:</p>

<blockquote>
  <p><strong>지금까지 네가 챗에 올린 소스는 그 사이트 전체 소스가 아니다.<br />
 핵심 기능(JS 부분)은 아직 챗에서 보지 못했다.</strong></p>
</blockquote>

<hr />

<h3 id="왜냐">왜냐?</h3>

<ul>
  <li>
    <p>HTML에는 <strong>텍스트 박스, 버튼, UI 구조</strong> 만 있음</p>
  </li>
  <li>
    <p>진짜 한글 자동 변환 / 자판 조합 알고리즘은 <code class="language-plaintext highlighter-rouge">korean-input.js</code>에 있음</p>
  </li>
  <li>
    <p>가상 키보드 UI는 <code class="language-plaintext highlighter-rouge">virtual-keyboard.js</code>에 있음</p>
  </li>
  <li>
    <p>언어 배열 및 레이아웃 정의는 <code class="language-plaintext highlighter-rouge">i18n.js</code>에 있음</p>
  </li>
</ul>

<p>즉, 네가 준 HTML은 “이 사이트를 따라 만들기 위한 껍데기”고,<br />
기능은 전부 JS가 담당하고 있어.</p>

<hr />

<h3 id="그래서-해야-할-것">그래서 해야 할 것</h3>

<ol>
  <li>
    <p>네가 쓰고 있는 <code class="language-plaintext highlighter-rouge">korean-input.js</code> 를 보여줘<br />
그래야 <strong>거기에 한/영 전환 핫키 코드를 정확히 삽입해줄 수 있어.</strong></p>
  </li>
  <li>
    <p>또는 사용 중인 GitHub 저장소 링크(URL)를 알려줘도 됨<br />
그러면 구조를 보고 어디에 코드를 넣는지 딱 집어주겠다.</p>
  </li>
</ol>

<hr />

<h3 id="다음-메시지에-이렇게-보내줘">다음 메시지에 이렇게 보내줘</h3>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">korean-input</span><span class="nc">.js</span> <span class="nt">소스</span> <span class="nt">전체</span>
</code></pre></div></div>

<p>또는</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">virtual</span><span class="o">-</span><span class="n">keyboard</span><span class="p">.</span><span class="n">js</span> <span class="err">소스</span> <span class="err">전체</span>
</code></pre></div></div>

<p><strong>그 파일을 보면 네가 원하는 ‘특정 키로 한/영 전환’ 기능을 실제 코드에 정확히 넣어줄게.</strong></p>

<p>지금은 HTML만 있어서 “맞는지?” 라고 물으면 답은 <strong>아직 아니야. 핵심 소스를 안 본 상태거든.</strong><br />
계속 가보자.</p>

<p class="chat--user">

class KoreanInput { constructor() { // 字体大小管理 this.fontSize = 18; // 默认字体大小 // 普通状态的键盘映射 this.normalMap = { // 辅音 (초성/종성) 'q': 'ㅂ', 'w': 'ㅈ', 'e': 'ㄷ', 'r': 'ㄱ', 't': 'ㅅ', 'a': 'ㅁ', 's': 'ㄴ', 'd': 'ㅇ', 'f': 'ㄹ', 'g': 'ㅎ', 'z': 'ㅋ', 'x': 'ㅌ', 'c': 'ㅊ', 'v': 'ㅍ', // 元音 (중성) 'y': 'ㅛ', 'u': 'ㅕ', 'l': 'ㅣ', 'o': 'ㅐ', 'p': 'ㅔ', 'h': 'ㅗ', 'j': 'ㅓ', 'k': 'ㅏ', 'i': 'ㅑ', 'b': 'ㅠ', 'n': 'ㅜ', 'm': 'ㅡ' }; // Shift状态的键盘映射 this.shiftMap = { // 双辅音 'Q': 'ㅃ', 'W': 'ㅉ', 'E': 'ㄸ', 'R': 'ㄲ', 'T': 'ㅆ', // 复合元音 'O': 'ㅒ', 'P': 'ㅖ', // 其他按键保持原映射（小写转大写） 'q': 'ㅃ', 'w': 'ㅉ', 'e': 'ㄸ', 'r': 'ㄲ', 't': 'ㅆ', 'o': 'ㅒ', 'p': 'ㅖ' }; // 韩文字符范围常量 this.HANGUL_BASE = 0xAC00; this.CHOSUNG_BASE = 0x1100; this.JUNGSUNG_BASE = 0x1161; this.JONGSUNG_BASE = 0x11A7; // 初声 (19个) this.chosungList = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ']; // 中声 (21个) this.jungsungList = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ']; // 终声 (28个，包含空字符) this.jongsungList = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ']; // 完整的韩文组合引擎数据结构（从参考项目移植） this.initial = [12593, 12594, 12596, 12599, 12600, 12601, 12609, 12610, 12611, 12613, 12614, 12615, 12616, 12617, 12618, 12619, 12620, 12621, 12622]; this.finale = [0, 12593, 12594, 12595, 12596, 12597, 12598, 12599, 12601, 12602, 12603, 12604, 12605, 12606, 12607, 12608, 12609, 12610, 12612, 12613, 12614, 12615, 12616, 12618, 12619, 12620, 12621, 12622]; this.dMedial = [0, 0, 0, 0, 0, 0, 0, 0, 0, 800, 801, 820, 0, 0, 1304, 1305, 1320, 0, 0, 1820]; this.dFinale = [0, 0, 0, 119, 0, 422, 427, 0, 0, 801, 816, 817, 819, 825, 826, 827, 0, 0, 1719, 0, 1919]; // Unicode常量 this.SBase = 44032; this.LBase = 4352; this.VBase = 12623; this.TBase = 4519; this.LCount = 19; this.VCount = 21; this.TCount = 28; this.NCount = 588; this.SCount = 11172; // 当前正在组合的字符状态 this.currentChosung = ''; this.currentJungsung = ''; this.currentJongsung = ''; this.buffer = ''; } // 查找数组中元素的索引（工具函数） indexOf(array, value) { for (let i = 0; i &lt; array.length; i++) { if (array[i] === value) { return i; } } return -1; } // 获取字符映射 getCharacter(key, isShift) { if (isShift &amp;&amp; this.shiftMap[key]) { return this.shiftMap[key]; } return this.normalMap[key.toLowerCase()] || null; } // 判断是否为辅音 isConsonant(char) { return this.chosungList.includes(char) || this.jongsungList.includes(char); } // 判断是否为元音 isVowel(char) { return this.jungsungList.includes(char); } // 完整的韩文组合算法（从参考项目移植并优化） composeHangul(inputString) { const length = inputString.length; if (length === 0) { return ""; } let currentCharCode = inputString.charCodeAt(0); let result = String.fromCharCode(currentCharCode); for (let i = 1; i &lt; length; i++) { const nextCharCode = inputString.charCodeAt(i); const initialIndex = this.indexOf(this.initial, currentCharCode); // 初声 + 中声 → 音节 if (initialIndex !== -1) { const vowelOffset = nextCharCode - this.VBase; if (0 &lt;= vowelOffset &amp;&amp; vowelOffset &lt; this.VCount) { currentCharCode = this.SBase + (initialIndex * this.VCount + vowelOffset) * this.TCount; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } } // 元音 + 元音 → 复合元音 const currentVowelOffset = currentCharCode - this.VBase; const nextVowelOffset = nextCharCode - this.VBase; if (0 &lt;= currentVowelOffset &amp;&amp; currentVowelOffset &lt; this.VCount &amp;&amp; 0 &lt;= nextVowelOffset &amp;&amp; nextVowelOffset &lt; this.VCount) { const dMedialIndex = this.indexOf(this.dMedial, (currentVowelOffset * 100) + nextVowelOffset); if (dMedialIndex &gt; 0) { currentCharCode = this.VBase + dMedialIndex; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } } const syllableOffset = currentCharCode - this.SBase; // 音节 + 终声 → 完整音节 if (0 &lt;= syllableOffset &amp;&amp; syllableOffset &lt; 11145 &amp;&amp; (syllableOffset % this.TCount) === 0) { const finaleIndex = this.indexOf(this.finale, nextCharCode); if (finaleIndex !== -1) { currentCharCode += finaleIndex; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } // 处理复合中声 const vowelIndex = Math.floor((syllableOffset % this.NCount) / this.TCount); const dMedialIndex = this.indexOf(this.dMedial, (vowelIndex * 100) + (nextCharCode - this.VBase)); if (dMedialIndex &gt; 0) { currentCharCode += (dMedialIndex - vowelIndex) * this.TCount; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } } // 完整音节 + 元音 → 终声分离 + 新音节 (关键修复!) if (0 &lt;= syllableOffset &amp;&amp; syllableOffset &lt; 11172 &amp;&amp; (syllableOffset % this.TCount) !== 0) { const finaleIndex = syllableOffset % this.TCount; const vowelOffset = nextCharCode - this.VBase; if (0 &lt;= vowelOffset &amp;&amp; vowelOffset &lt; this.VCount) { const newInitialIndex = this.indexOf(this.initial, this.finale[finaleIndex]); if (0 &lt;= newInitialIndex &amp;&amp; newInitialIndex &lt; this.LCount) { // 移除终声，创建新音节 result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode - finaleIndex); currentCharCode = this.SBase + (newInitialIndex * this.VCount + vowelOffset) * this.TCount; result = result + String.fromCharCode(currentCharCode); continue; } // 处理复合终声分解 if (finaleIndex &lt; this.dFinale.length &amp;&amp; this.dFinale[finaleIndex] !== 0) { result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode - finaleIndex + Math.floor(this.dFinale[finaleIndex] / 100)); currentCharCode = this.SBase + (this.indexOf(this.initial, this.finale[(this.dFinale[finaleIndex] % 100)]) * this.VCount + vowelOffset) * this.TCount; result = result + String.fromCharCode(currentCharCode); continue; } } // 处理复合终声 const dFinaleIndex = this.indexOf(this.dFinale, (finaleIndex * 100) + this.indexOf(this.finale, nextCharCode)); if (dFinaleIndex &gt; 0) { currentCharCode = currentCharCode + dFinaleIndex - finaleIndex; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } } // 无法组合，添加新字符 currentCharCode = nextCharCode; result = result + String.fromCharCode(nextCharCode); } return result; } // 分解韩文字符（按照参考项目实现） decomposeHangul(inputString) { const length = inputString.length; let result = ""; for (let i = 0; i &lt; length; i++) { const charCode = inputString.charCodeAt(i); const syllableOffset = charCode - this.SBase; // 检查是否为韩文音节 if (syllableOffset &lt; 0 || syllableOffset &gt;= this.SCount) { result += String.fromCharCode(charCode); continue; } // 分解音节 const initialIndex = Math.floor(syllableOffset / this.NCount); const vowelCode = this.VBase + Math.floor((syllableOffset % this.NCount) / this.TCount); const finaleCode = this.finale[syllableOffset % this.TCount]; result += String.fromCharCode(this.initial[initialIndex], vowelCode); if (finaleCode !== 0) { result += String.fromCharCode(finaleCode); } } return result; } // 处理输入 - 简化版本，直接返回字符用于smartInsert处理 processInput(char) { // 简化：直接返回字符，让smartInsert处理所有组合逻辑 return char; } // 检测韩文字符是否完成（用于历史保存时机判断） isHangulCharComplete(char) { if (!char) return false; const charCode = char.charCodeAt(0); const syllableOffset = charCode - this.SBase; // 检查是否为完整的韩文音节（不是单独的字母组件） if (0 &lt;= syllableOffset &amp;&amp; syllableOffset &lt; this.SCount) { return true; // 是完整的韩文音节 } return false; // 不是完整的韩文音节或不是韩文字符 } // 检测从旧文本到新文本是否有韩文字符完成 detectHangulCompletion(oldText, newText, cursorPosition) { // 检查光标位置附近是否有新完成的韩文字符 if (cursorPosition &lt;= 0) return false; const newChar = newText[cursorPosition - 1]; const oldChar = oldText[cursorPosition - 1] || ''; // 如果新字符是完整韩文字符，而旧字符不是，则表示有字符完成 if (this.isHangulCharComplete(newChar) &amp;&amp; !this.isHangulCharComplete(oldChar)) { return true; } // 检查是否有韩文字符从不完整变为完整 if (newChar !== oldChar &amp;&amp; this.isHangulCharComplete(newChar)) { return true; } return false; } // 智能插入函数 - 改进版本，更好地处理韩文组合，增加完成检测 smartInsert(currentText, cursorStart, cursorEnd, newChar) { // 1. 构建新文本：插入新字符 const textBefore = currentText.substring(0, cursorStart); const textAfter = currentText.substring(cursorEnd); const tempText = textBefore + newChar + textAfter; const tempCursorPos = cursorStart + newChar.length; // 2. 韩文组合处理：尝试不同长度的字符序列 for (let testLength = Math.min(4, tempCursorPos); testLength &gt;= 2; testLength–) { const testChars = tempText.substring(tempCursorPos - testLength, tempCursorPos); const composed = this.composeHangul(testChars); // 3. 如果组合成功（长度减少，或者内容有意义变化），则替换 if (composed.length &lt; testChars.length || composed !== testChars) { const newText = tempText.substring(0, tempCursorPos - testLength) + composed + tempText.substring(tempCursorPos); const newCursorPos = tempCursorPos - testLength + composed.length; // 4. 检测韩文字符是否完成（用于历史保存） const hangulCompleted = this.detectHangulCompletion(currentText, newText, newCursorPos); return { text: newText, cursorPosition: newCursorPos, hangulCompleted: hangulCompleted }; } } // 5. 无法组合，返回临时文本，检查是否有韩文完成 const hangulCompleted = this.detectHangulCompletion(currentText, tempText, tempCursorPos); return { text: tempText, cursorPosition: tempCursorPos, hangulCompleted: hangulCompleted }; } // 处理辅音输入 processConsonant(consonant) { if (!this.currentChosung) { // 开始新的音节 this.currentChosung = consonant; this.currentJungsung = ''; this.currentJongsung = ''; return consonant; } else if (this.currentJungsung &amp;&amp; !this.currentJongsung) { // 添加终声 this.currentJongsung = consonant; return this.combineHangul(this.currentChosung, this.currentJungsung, this.currentJongsung); } else { // 开始新的音节 const result = this.finalizeCurrent() + consonant; this.currentChosung = consonant; this.currentJungsung = ''; this.currentJongsung = ''; return result; } } // 处理元音输入 processVowel(vowel) { if (this.currentChosung &amp;&amp; !this.currentJungsung) { // 添加中声 this.currentJungsung = vowel; return this.combineHangul(this.currentChosung, this.currentJungsung); } else if (this.currentChosung &amp;&amp; this.currentJungsung &amp;&amp; this.currentJongsung) { // 终声变成新音节的初声 const result = this.combineHangul(this.currentChosung, this.currentJungsung) + this.combineHangul(this.currentJongsung, vowel); this.currentChosung = this.currentJongsung; this.currentJungsung = vowel; this.currentJongsung = ''; return result; } else { // 处理其他情况 const result = this.finalizeCurrent() + vowel; this.reset(); return result; } } // 完成当前字符组合 finalizeCurrent() { if (this.currentChosung &amp;&amp; this.currentJungsung) { return this.combineHangul(this.currentChosung, this.currentJungsung, this.currentJongsung); } else if (this.currentChosung) { return this.currentChosung; } return ''; } // 重置状态 reset() { this.currentChosung = ''; this.currentJungsung = ''; this.currentJongsung = ''; } // 从单个韩文字符恢复输入状态 restoreStateFromCharacter(char) { if (!char) { this.reset(); return; } const decomposed = this.decomposeHangul(char); if (decomposed) { // 是完整的韩文字符，恢复组合状态 this.currentChosung = decomposed.chosung; this.currentJungsung = decomposed.jungsung; this.currentJongsung = decomposed.jongsung; } else if (this.isConsonant(char)) { // 是单独的辅音，设置为初声 this.currentChosung = char; this.currentJungsung = ''; this.currentJongsung = ''; } else if (this.isVowel(char)) { // 是单独的元音，这种情况不应该出现在正常的韩文输入中 // 重置状态 this.reset(); } else { // 不是韩文字符，重置状态 this.reset(); } } // 处理退格 - 使用新的decomposeHangul实现 handleBackspace(currentText) { if (currentText.length === 0) return ''; const lastChar = currentText[currentText.length - 1]; const decomposed = this.decomposeHangul(lastChar); // 检查是否为韩文字符（通过分解结果长度判断） if (decomposed.length &gt; 1) { // 是韩文字符，按照参考项目的逻辑处理 const decomposedArray = Array.from(decomposed); if (decomposedArray.length &gt; 1) { // 删除最后一个字符部件，重新组合 const remaining = decomposedArray.slice(0, -1).join(''); const recomposed = this.composeHangul(remaining); return currentText.slice(0, -1) + recomposed; } } // 不是韩文字符或无法分解，直接删除 return currentText.slice(0, -1); } // 程序化处理输入（用于移动端虚拟键盘） processInputProgrammatically(key, isShift, currentText, cursorPosition) { const char = this.getCharacter(key, isShift); if (!char) return null; // 使用smartInsert函数处理输入 return this.smartInsert(currentText, cursorPosition, cursorPosition, char); } // === 新增功能：保存文本 === // 保存文本为文件 saveTextAsFile(text) { if (!text.trim()) { alert(window.languageManager ? window.languageManager.getText('noTextToSave') || 'No text to save!' : 'No text to save!'); return; } try { // 创建Blob对象 const blob = new Blob([text], { type: 'text/plain;charset=utf-8' }); // 创建下载链接 const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; // 生成文件名（包含时间戳） const now = new Date(); const timestamp = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '-' + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0') + String(now.getSeconds()).padStart(2, '0'); link.download = <code class="language-plaintext highlighter-rouge">korean-text-${timestamp}.txt</code>; // 触发下载 document.body.appendChild(link); link.click(); document.body.removeChild(link); // 清理URL对象 URL.revokeObjectURL(url); } catch (e) { console.error('Failed to save file:', e); alert('Failed to save file. Please try again.'); } } // === 新增功能：字体大小调整 === // 简单的设置保存 saveSettings() { try { const data = { fontSize: this.fontSize }; localStorage.setItem('korean-input-data', JSON.stringify(data)); } catch (e) { console.warn('Failed to save settings to localStorage:', e); } } // 从localStorage加载设置 loadSettings() { const savedData = localStorage.getItem('korean-input-data'); if (savedData) { try { const data = JSON.parse(savedData); if (data.fontSize) { this.fontSize = data.fontSize; } } catch (e) { console.warn('Failed to load settings from localStorage:', e); } } } // 获取当前字体大小 getFontSize() { return this.fontSize; } // 设置字体大小 setFontSize(size) { this.fontSize = Math.max(12, Math.min(36, size)); // 限制在12-36px之间 const textarea = document.getElementById('koreanInput'); if (textarea) { textarea.style.fontSize = this.fontSize + 'px'; } this.saveSettings(); // 保存字体大小设置 return this.fontSize; } // 增大字体 increaseFontSize() { return this.setFontSize(this.fontSize + 2); } // 减小字体 decreaseFontSize() { return this.setFontSize(this.fontSize - 2); } // 初始化字体大小 initializeFontSize() { this.loadSettings(); // 加载保存的设置 const textarea = document.getElementById('koreanInput'); if (textarea) { textarea.style.fontSize = this.fontSize + 'px'; } } } // DOM加载完成后初始化 document.addEventListener('DOMContentLoaded', function() { const koreanInput = new KoreanInput(); const textarea = document.getElementById('koreanInput'); const copyBtn = document.getElementById('copyBtn'); const clearBtn = document.getElementById('clearBtn'); const saveBtn = document.getElementById('saveBtn'); const fontSmallerBtn = document.getElementById('fontSmallerBtn'); const fontLargerBtn = document.getElementById('fontLargerBtn'); // 初始化字体大小 koreanInput.initializeFontSize(); // 初始化虚拟键盘和语言切换器 window.virtualKeyboard = new VirtualKeyboard(koreanInput); window.languageSwitcher = new LanguageSwitcher(); // 初始化界面语言 window.languageManager.updateUI(); // 修复初始化时序问题：确保虚拟键盘的多语言文字正确显示 if (window.virtualKeyboard) { // 更新功能键文字（修复空格键显示问题） window.virtualKeyboard.updateFunctionKeysText(); // 如果是移动设备且当前处于虚拟键盘模式，更新状态指示器 if (window.virtualKeyboard.isMobileDevice &amp;&amp; window.virtualKeyboard.isVirtualKeyboardMode) { window.virtualKeyboard.updateKeyboardStateIndicator(false); } } // 键盘事件监听 textarea.addEventListener('keydown', function(e) { // 检查输入来源，如果是虚拟键盘输入且在移动设备上，则忽略 if (window.virtualKeyboard &amp;&amp; window.virtualKeyboard.inputSource === 'virtual' &amp;&amp; window.virtualKeyboard.isMobileDevice) { return; } if (e.key === 'Backspace') { e.preventDefault(); // 获取光标位置信息 const cursorStart = this.selectionStart; const cursorEnd = this.selectionEnd; if (cursorStart === cursorEnd) { // 普通删除：删除光标前的一个字符 if (cursorStart &gt; 0) { const textBefore = this.value.substring(0, cursorStart); const textAfter = this.value.substring(cursorStart); // 对光标前的文本应用韩文智能退格逻辑 const newTextBefore = koreanInput.handleBackspace(textBefore); const newText = newTextBefore + textAfter; this.value = newText; // 设置新的光标位置 const newCursorPos = newTextBefore.length; this.setSelectionRange(newCursorPos, newCursorPos); // 基于光标位置智能恢复韩文输入状态 if (newCursorPos &gt; 0) { const charBeforeCursor = newText[newCursorPos - 1]; koreanInput.restoreStateFromCharacter(charBeforeCursor); } else { koreanInput.reset(); } } } else { // 选区删除：删除选中的文本 const textBefore = this.value.substring(0, cursorStart); const textAfter = this.value.substring(cursorEnd); const newText = textBefore + textAfter; this.value = newText; this.setSelectionRange(cursorStart, cursorStart); // 基于光标位置智能恢复韩文输入状态 if (cursorStart &gt; 0) { const charBeforeCursor = newText[cursorStart - 1]; koreanInput.restoreStateFromCharacter(charBeforeCursor); } else { koreanInput.reset(); } } // 注意：这里不再调用 koreanInput.reset()，因为状态已经在上面智能恢复了 return; } if (e.key === ' ') { e.preventDefault(); const cursorStart = this.selectionStart; const textBefore = this.value.substring(0, cursorStart); const textAfter = this.value.substring(this.selectionEnd); this.value = textBefore + ' ' + textAfter; // 移动光标到空格之后 const newCursorPos = cursorStart + 1; this.setSelectionRange(newCursorPos, newCursorPos); // 重置韩文输入状态 koreanInput.reset(); return; } // 忽略其他特殊键 if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return; const char = koreanInput.getCharacter(e.key, e.shiftKey); if (char) { e.preventDefault(); const result = koreanInput.processInput(char); // 更新输入框内容 const cursorPos = this.selectionStart; const textBefore = this.value.substring(0, cursorPos); const textAfter = this.value.substring(this.selectionEnd); // 全新的韩文输入逻辑：智能光标插入处理 const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result); // 更新文本和光标位置 this.value = insertResult.text; this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition); } }); // 添加触摸和焦点事件监听，区分输入来源 textarea.addEventListener('touchstart', function(e) { if (window.virtualKeyboard) { window.virtualKeyboard.inputSource = 'touch'; // 同步虚拟光标位置 setTimeout(() =&gt; { window.virtualKeyboard.syncVirtualCursor(); }, 50); } }); textarea.addEventListener('mousedown', function(e) { if (window.virtualKeyboard) { window.virtualKeyboard.inputSource = 'mouse'; // 同步虚拟光标位置 setTimeout(() =&gt; { window.virtualKeyboard.syncVirtualCursor(); }, 50); } }); textarea.addEventListener('focus', function(e) { if (window.virtualKeyboard) { // 如果是虚拟键盘操作导致的焦点，立即失焦 if (window.virtualKeyboard.isMobileDevice &amp;&amp; window.virtualKeyboard.isVirtualKeyboardMode) { e.preventDefault(); this.blur(); return false; } // 如果是移动设备且输入源不是虚拟键盘，允许系统键盘弹出 if (window.virtualKeyboard.isMobileDevice &amp;&amp; window.virtualKeyboard.inputSource !== 'virtual') { // 正常的焦点行为，允许系统键盘弹出 window.virtualKeyboard.syncVirtualCursor(); } } koreanInput.reset(); }); // 监听自定义虚拟输入事件 textarea.addEventListener('virtualinput', function(e) { // 处理虚拟输入事件，这里可以添加额外的处理逻辑 // 例如更新其他UI元素等 }); // 监听光标位置变化（selectionchange事件） document.addEventListener('selectionchange', function() { if (window.virtualKeyboard &amp;&amp; document.activeElement === textarea) { // 用户直接在textarea中移动了光标，同步虚拟光标 if (!window.virtualKeyboard.isVirtualKeyboardMode) { window.virtualKeyboard.syncVirtualCursor(); } } }); // 监听文本选择变化（兼容性更好的方式） textarea.addEventListener('selectionchange', function() { if (window.virtualKeyboard &amp;&amp; !window.virtualKeyboard.isVirtualKeyboardMode) { window.virtualKeyboard.syncVirtualCursor(); } }); // 监听键盘事件同步光标（用户直接使用物理键盘时） textarea.addEventListener('keyup', function(e) { if (window.virtualKeyboard &amp;&amp; !window.virtualKeyboard.isVirtualKeyboardMode) { window.virtualKeyboard.syncVirtualCursor(); } }); // 复制功能 copyBtn.addEventListener('click', function() { textarea.select(); document.execCommand('copy'); // 显示复制成功提示（多语言支持） const originalText = this.textContent; this.textContent = window.languageManager.getText('copiedMsg'); setTimeout(() =&gt; { this.textContent = originalText; }, 1000); }); // 清空功能 clearBtn.addEventListener('click', function() { textarea.value = ''; koreanInput.reset(); window.virtualKeyboard.reset(); textarea.focus(); }); // 保存文本功能 saveBtn.addEventListener('click', function() { koreanInput.saveTextAsFile(textarea.value); textarea.focus(); }); // 缩小字体功能 fontSmallerBtn.addEventListener('click', function() { koreanInput.decreaseFontSize(); textarea.focus(); }); // 放大字体功能 fontLargerBtn.addEventListener('click', function() { koreanInput.increaseFontSize(); textarea.focus(); }); // 点击事件重置状态和同步光标 textarea.addEventListener('click', function() { koreanInput.reset(); // 设置输入源为直接输入 if (window.virtualKeyboard) { window.virtualKeyboard.inputSource = 'direct'; // 同步虚拟光标位置 window.virtualKeyboard.syncVirtualCursor(); } }); });

</p>

<p>좋아. 네 코드에 “특정 키로 한/영 전환”을 붙이려면, 입력 파이프라인의 맨 앞에 IME 모드 상태(ko/en)를 두고, 단축키로 그 값을 토글하면 돼. ko일 때만 지금의 한글 조합 로직을 실행하고, en일 때는 브라우저 기본 입력을 그대로 통과시키면 된다. 아래는 네가 올린 소스에 최소 침습으로 추가/변경해야 할 부분만 단계별로 정리한 거야.</p>

<h1 id="1-koreaninput-클래스에-모드-상태와-api-추가">1) KoreanInput 클래스에 모드 상태와 API 추가</h1>

<p>생성자에 모드 상태를 넣고 로컬스토리지에 저장·복원하도록 해. 그리고 토글/설정 메서드를 추가.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

class KoreanInput {
    constructor() {
        // ... 기존 코드 그대로 ...

        // IME 모드: 'ko' | 'en'
        this.mode = (localStorage.getItem('imeMode') === 'en') ? 'en' : 'ko';
    }

    setMode(mode) {
        this.mode = (mode === 'en') ? 'en' : 'ko';
        localStorage.setItem('imeMode', this.mode);
        // 모드에 따라 상태 초기화가 필요하면 여기서 처리
        if (this.mode === 'en') this.reset();
    }

    toggleMode() {
        this.setMode(this.mode === 'ko' ? 'en' : 'ko');
        // 모드 표시 UI가 있다면 여기서 갱신
        const chip = document.getElementById('imeMode');
        if (chip) {
            chip.textContent = (this.mode === 'ko') ? 'KO' : 'EN';
            chip.setAttribute('data-mode', this.mode);
        }
    }
    
    // ... 나머지 메서드 그대로 ...
}
</code></pre></div></div>

<p>선택 사항: 모드 상태를 화면에 표시하고 싶다면 HTML에 작은 칩을 하나 두면 좋아.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ime-status"</span><span class="nt">&gt;&lt;span</span> <span class="na">id=</span><span class="s">"imeMode"</span><span class="nt">&gt;</span>KO<span class="nt">&lt;/span&gt;&lt;/div&gt;</span>
</code></pre></div></div>

<p>초기화 시점에 한번 동기화:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// DOMContentLoaded 내부
const chip = document.getElementById('imeMode');
if (chip) {
    chip.textContent = (koreanInput.mode === 'ko') ? 'KO' : 'EN';
    chip.setAttribute('data-mode', koreanInput.mode);
}
</code></pre></div></div>

<h1 id="2-단축키-정의-ctrlspace-또는-f2">2) 단축키 정의: Ctrl+Space 또는 F2</h1>

<p>OS 단축키와 충돌 가능성을 줄이려고 F2도 함께 지원하자.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function isToggleHotkey(e) {
    // Ctrl+Space 또는 F2
    return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}
</code></pre></div></div>

<h1 id="3-keydown-핸들러를-모드-기반으로-분기">3) keydown 핸들러를 모드 기반으로 분기</h1>

<p>지금 keydown은 Backspace, Space, 일반 문자 등을 모두 가로채서 한글 조합으로 넣고 있어. 이 로직을 “ko일 때만” 실행하도록 감싸고, “en일 때는” 브라우저 기본 입력을 그대로 흐르게 두면 된다. 즉, 기존의 <code class="language-plaintext highlighter-rouge">preventDefault()</code>들을 ko 모드에서만 수행하게 만드는 게 핵심.</p>

<p>아래는 네 keydown 리스너의 핵심 부분을 안전하게 바꾼 버전이야. 바뀐 줄에 주석을 달아놨다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

textarea.addEventListener('keydown', function(e) {
    // 가상키보드 입력 통과 로직은 그대로
    if (window.virtualKeyboard &amp;&amp; window.virtualKeyboard.inputSource === 'virtual' &amp;&amp; window.virtualKeyboard.isMobileDevice) {
        return;
    }

    // 1) 한/영 토글 단축키
    if (isToggleHotkey(e)) {
        e.preventDefault();
        koreanInput.toggleMode();
        return;
    }

    // 2) EN 모드: 브라우저 기본 입력을 그대로 사용
    if (koreanInput.mode === 'en') {
        return; // 어떤 키도 가로채지 않음
    }

    // 3) KO 모드: 기존 한글 조합 로직 실행
    if (e.key === 'Backspace') {
        e.preventDefault();

        const cursorStart = this.selectionStart;
        const cursorEnd = this.selectionEnd;

        if (cursorStart === cursorEnd) {
            if (cursorStart &gt; 0) {
                const textBefore = this.value.substring(0, cursorStart);
                const textAfter = this.value.substring(cursorStart);
                const newTextBefore = koreanInput.handleBackspace(textBefore);
                const newText = newTextBefore + textAfter;

                this.value = newText;

                const newCursorPos = newTextBefore.length;
                this.setSelectionRange(newCursorPos, newCursorPos);

                if (newCursorPos &gt; 0) {
                    const charBeforeCursor = newText[newCursorPos - 1];
                    koreanInput.restoreStateFromCharacter(charBeforeCursor);
                } else {
                    koreanInput.reset();
                }
            }
        } else {
            const textBefore = this.value.substring(0, cursorStart);
            const textAfter = this.value.substring(cursorEnd);
            const newText = textBefore + textAfter;

            this.value = newText;
            this.setSelectionRange(cursorStart, cursorStart);

            if (cursorStart &gt; 0) {
                const charBeforeCursor = newText[cursorStart - 1];
                koreanInput.restoreStateFromCharacter(charBeforeCursor);
            } else {
                koreanInput.reset();
            }
        }
        return;
    }

    if (e.key === ' ') {
        e.preventDefault();

        const cursorStart = this.selectionStart;
        const textBefore = this.value.substring(0, cursorStart);
        const textAfter = this.value.substring(this.selectionEnd);

        this.value = textBefore + ' ' + textAfter;

        const newCursorPos = cursorStart + 1;
        this.setSelectionRange(newCursorPos, newCursorPos);

        koreanInput.reset();
        return;
    }

    // 특수키 무시(Shift 등)
    if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

    const char = koreanInput.getCharacter(e.key, e.shiftKey);
    if (char) {
        e.preventDefault();
        const result = koreanInput.processInput(char);

        const cursorPos = this.selectionStart;
        const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);

        this.value = insertResult.text;
        this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);
        return;
    }

    // 매핑되지 않은 키는 KO 모드에서도 통과시킬지, 막을지 정책 결정
    // 필요하면 아래에서 e.preventDefault()를 제거하거나 추가
});
</code></pre></div></div>

<p>핵심 포인트</p>

<ol>
  <li>
    <p>토글 단축키를 가장 먼저 처리해 즉시 모드를 바꾼다.</p>
  </li>
  <li>
    <p>en 모드에서는 아무것도 가로채지 않는다. Backspace/Space/일반 문자 포함 전부 브라우저 기본 동작.</p>
  </li>
  <li>
    <p>ko 모드일 때만 기존 한글 조합 로직이 실행된다.</p>
  </li>
</ol>

<h1 id="4-모바일가상키보드와-동기화선택">4) 모바일·가상키보드와 동기화(선택)</h1>

<p>화면 키보드에도 한/영 키를 달았다면, 그 버튼 클릭 시 <code class="language-plaintext highlighter-rouge">koreanInput.toggleMode()</code>를 호출해주면 된다. 예시:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// virtual-keyboard.js에서
buttonHanEng.addEventListener('click', () =&gt; {
    if (window.koreanInput) window.koreanInput.toggleMode();
});
</code></pre></div></div>

<h1 id="5-사용성-팁">5) 사용성 팁</h1>

<p>단축키는 Ctrl+Space가 OS 레벨에서 먼저 먹을 수 있다. 그럴 때를 대비해 F2 같은 대체 키를 함께 두는 게 안전하다. 모드 칩을 표시하면 사용자 혼란도 줄어든다.</p>

<p>이렇게 붙이면, 사이트는 그대로 유지하면서도 특정 키로 한/영 모드를 전환할 수 있어. 더 빡빡하게 통제하고 싶다면 en 모드일 때도 일부 키(예: Backspace만)는 가로채서 너의 selection 관리 로직에 맞추는 식으로 세분화할 수 있다.</p>

<p class="chat--user">

ime라고 하니까 좀 헷갈리는데 os의 ime랑은 전혀 상관없는거지?

</p>

<p>맞아. 여기서 말하는 건 OS의 한글 입력기(IME)랑 전혀 별개야. 네 코드는 “페이지 안에서 키 이벤트를 받아 영→한으로 조합해 넣는 자바스크립트 입력기”일 뿐, 운영체제의 IME 상태를 바꾸거나 읽을 수 없어.</p>

<h2 id="뭐가-어떻게-다른가">뭐가 어떻게 다른가</h2>

<ul>
  <li>
    <p>OS IME: 시스템 전역. 앱·브라우저 어디서나 적용. 단축키(예: 윈도우/맥 한영 전환)로 토글되고, 브라우저가 제어 못 함.</p>
  </li>
  <li>
    <p>네 JS 입력기: 특정 <code class="language-plaintext highlighter-rouge">textarea</code>에서만 동작. <code class="language-plaintext highlighter-rouge">keydown</code>을 가로채서 자모 매핑→조합 알고리즘으로 텍스트를 “넣어줄” 뿐. 페이지 밖에는 영향 없음.</p>
  </li>
</ul>

<h2 id="함께-켜졌을-때의-상호작용">함께 켜졌을 때의 상호작용</h2>

<ul>
  <li>
    <p>OS IME가 “한글”로 켜져 있으면 브라우저가 이미 조합을 수행하므로, 너의 JS 조합과 충돌하거나 이중 입력처럼 보일 수 있다.</p>
  </li>
  <li>
    <p>OS 단축키(Ctrl+Space 등)는 OS가 먼저 먹을 수 있어, 너의 페이지에 <code class="language-plaintext highlighter-rouge">keydown</code>이 아예 안 오기도 한다.</p>
  </li>
</ul>

<h2 id="안전하게-쓰는-가드강력-추천">안전하게 쓰는 가드(강력 추천)</h2>

<p>OS IME로 실제 조합 중일 때는 이벤트에 <code class="language-plaintext highlighter-rouge">isComposing</code> 플래그가 선다. 이때는 네 커스텀 조합을 끄면 충돌이 사라진다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

textarea.addEventListener('keydown', (e) =&gt; {
  // OS IME 조합 중이거나 IME가 'Process' 키를 보낼 땐 건드리지 않음
  if (e.isComposing || e.key === 'Process') return;

  // 네 ‘한/영 모드’ 토글
  if (isToggleHotkey(e)) { e.preventDefault(); koreanInput.toggleMode(); return; }

  // EN 모드면 기본 입력 통과
  if (koreanInput.mode === 'en') return;

  // KO 모드면 기존 커스텀 조합 로직 실행
  // …(지금 갖고 있는 로직)
});
</code></pre></div></div>

<p>추가로, 충돌 가능성을 더 낮추려면 입력창 속성을 이렇게 세팅해 둬:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;textarea</span> <span class="na">id=</span><span class="s">"koreanInput"</span>
  <span class="na">autocomplete=</span><span class="s">"off"</span> <span class="na">autocapitalize=</span><span class="s">"off"</span> <span class="na">autocorrect=</span><span class="s">"off"</span> <span class="na">spellcheck=</span><span class="s">"false"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
</code></pre></div></div>

<p>(IME 자체를 끄진 못하지만, 자동 교정/철자 교정 같은 브라우저 레이어 간섭을 줄여준다.)</p>

<h2 id="모바일에서의-차이">모바일에서의 차이</h2>

<ul>
  <li>모바일 소프트 키보드는 물리 키 이벤트가 제한적이라 JS 조합기로만 처리하기 어렵다. 화면에 “한/영 토글” 버튼을 별도로 제공해 <code class="language-plaintext highlighter-rouge">toggleMode()</code>를 직접 호출하는 식이 안정적이다.</li>
</ul>

<h2 id="용어-정리헷갈림-방지">용어 정리(헷갈림 방지)</h2>

<ul>
  <li>
    <p>“OS IME”는 그대로 IME.</p>
  </li>
  <li>
    <p>네 쪽은 “인페이지 한글 조합기”, “커스텀 입력기”, 혹은 UI상 “KO/EN 모드”처럼 부르는 게 명확하다.</p>
  </li>
</ul>

<h2 id="현실적인-운용-팁">현실적인 운용 팁</h2>

<ul>
  <li>
    <p>페이지 어딘가에 현재 모드 칩(KO/EN)을 표시하고, 처음엔 “OS 한글 입력은 꺼 주세요” 같은 안내를 보여주면 사용자 혼란이 크게 줄어든다.</p>
  </li>
  <li>
    <p>단축키는 OS와 충돌 가능한 Ctrl+Space 외에 F2/RightAlt 등 대체 키를 함께 두는 게 좋다.</p>
  </li>
</ul>

<p>이렇게 <code class="language-plaintext highlighter-rouge">isComposing</code> 가드와 모드 표기를 붙이면, OS IME와 완전히 독립적으로 동작하면서도 충돌을 최소화할 수 있다.</p>

<p class="chat--user">

모든 텍스트 에리아에 이 기능을 넣고 싶어 그리고 너가 말한 대로 페이지에 현재 모드를 아이콘으로 보여주고 싶어

</p>

<p>좋다—이제 “페이지의 모든 <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>에 한/영 전환형 한글 조합기”를 붙이고, 화면 구석에 <strong>모드 아이콘(KO/EN)</strong> 을 띄워서 전역 상태를 보여주자. 핵심은 전역 모드 상태(ko/en) + 공용 <code class="language-plaintext highlighter-rouge">KoreanInput</code> 인스턴스 + 모든 텍스트에리아에 동일한 키 핸들러를 붙이는 거야. 동적으로 추가되는 textarea도 <code class="language-plaintext highlighter-rouge">MutationObserver</code>로 커버하자.</p>

<p>아래는 네 현재 구조를 최대한 유지하면서 “전역 적용”과 “아이콘 표시”를 추가한 코드 세트야.</p>

<hr />

<h1 id="1-모드-아이콘-ui-추가-html--css">1) 모드 아이콘 UI 추가 (HTML + CSS)</h1>

<p>페이지 공통 위치(우하단)에 작게 떠 있는 칩을 만든다.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- body 끝나기 직전(footer 위나 아래)에 추가 --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"imeBadge"</span> <span class="na">class=</span><span class="s">"ime-badge"</span> <span class="na">aria-live=</span><span class="s">"polite"</span> <span class="na">title=</span><span class="s">"Ctrl+Space 또는 F2로 전환"</span><span class="nt">&gt;&lt;/div&gt;</span>
</code></pre></div></div>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/* style.css에 추가 */</span>
<span class="nc">.ime-badge</span><span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">fixed</span><span class="p">;</span>
  <span class="nl">right</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
  <span class="nl">bottom</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
  <span class="nl">z-index</span><span class="p">:</span> <span class="m">9999</span><span class="p">;</span>
  <span class="nl">min-width</span><span class="p">:</span> <span class="m">36px</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">6px</span> <span class="m">10px</span><span class="p">;</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="n">currentColor</span><span class="p">;</span>
  <span class="nl">font</span><span class="p">:</span> <span class="m">12px</span><span class="o">/</span><span class="m">1.2</span> <span class="n">system-ui</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
  <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">.8</span><span class="p">;</span>
  <span class="nl">background</span><span class="p">:</span> <span class="nf">rgba</span><span class="p">(</span><span class="m">255</span><span class="p">,</span><span class="m">255</span><span class="p">,</span><span class="m">255</span><span class="p">,</span><span class="m">.85</span><span class="p">);</span>
  <span class="py">backdrop-filter</span><span class="p">:</span> <span class="nf">blur</span><span class="p">(</span><span class="m">6px</span><span class="p">);</span>
  <span class="nl">cursor</span><span class="p">:</span> <span class="nb">default</span><span class="p">;</span>
  <span class="py">user-select</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.ime-badge</span><span class="o">[</span><span class="nt">data-mode</span><span class="o">=</span><span class="s1">"ko"</span><span class="o">]</span><span class="nd">::after</span><span class="p">{</span> <span class="nl">content</span><span class="p">:</span> <span class="s1">"KO"</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.ime-badge</span><span class="o">[</span><span class="nt">data-mode</span><span class="o">=</span><span class="s1">"en"</span><span class="o">]</span><span class="nd">::after</span><span class="p">{</span> <span class="nl">content</span><span class="p">:</span> <span class="s1">"EN"</span><span class="p">;</span> <span class="p">}</span>

<span class="c">/* textarea 기본 옵션(권장) */</span>
<span class="nt">textarea</span><span class="p">{</span>
  <span class="py">autocomplete</span><span class="p">:</span> <span class="n">off</span><span class="p">;</span>
  <span class="py">autocapitalize</span><span class="p">:</span> <span class="n">off</span><span class="p">;</span>
  <span class="py">spellcheck</span><span class="p">:</span> <span class="no">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="2-koreaninput-클래스-전역-모드-api-확장">2) KoreanInput 클래스: 전역 모드 API 확장</h1>

<p>이미 넣어둔 <code class="language-plaintext highlighter-rouge">mode</code>, <code class="language-plaintext highlighter-rouge">setMode</code>, <code class="language-plaintext highlighter-rouge">toggleMode</code>를 전역에서 호출하기 쉽게 조금 일반화하고, 초기 배지와 동기화까지 포함한다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// KoreanInput 클래스 내부에 이미 제안했던 것 + 배지 반영
setMode(mode) {
  this.mode = (mode === 'en') ? 'en' : 'ko';
  localStorage.setItem('imeMode', this.mode);
  if (this.mode === 'en') this.reset();
  const badge = document.getElementById('imeBadge');
  if (badge){
    badge.setAttribute('data-mode', this.mode);
    // 살짝 깜빡이는 피드백
    badge.style.transition = 'background .15s';
    badge.style.background = 'rgba(0,0,0,.08)';
    setTimeout(()=&gt; badge.style.background = 'rgba(255,255,255,.85)', 120);
  }
}
toggleMode(){ this.setMode(this.mode === 'ko' ? 'en' : 'ko'); }
</code></pre></div></div>

<p>DOMContentLoaded에서 배지를 현재 모드와 동기화:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// DOMContentLoaded 내부
const badge = document.getElementById('imeBadge');
if (badge){
  badge.setAttribute('data-mode', koreanInput.mode);
}
</code></pre></div></div>

<hr />

<h1 id="3-모든-textarea에-붙는-핸들러-유틸">3) 모든 textarea에 붙는 핸들러 유틸</h1>

<p>특정 요소에 붙이던 keydown 로직을 “재사용 가능한 함수”로 만든다. 이 함수는 네 기존 keydown 내용(Backspace·Space·일반문자 처리)을 그대로 활용하되, <strong>isComposing 가드</strong> 와 <strong>모드 분기</strong> 를 맨 앞에 둔다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// 전역 유틸: 한/영 토글 핫키
function isToggleHotkey(e){
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}

// 특정 textarea에 조합기를 장착
function attachKoreanHandlers(textarea, koreanInput){
  if (!textarea || textarea.__koreanAttached) return;
  textarea.__koreanAttached = true;

  // 포커스 시 상태 초기화(에디터 전환 시 잔상 방지)
  textarea.addEventListener('focus', (e)=&gt;{
    // 모바일 가상키보드 모드 등 네 로직이 있으면 그대로 유지
    koreanInput.reset();
  });

  // 키다운: 전역 모드 + 가드
  textarea.addEventListener('keydown', function(e){
    // OS IME 조합 중이거나 Process 키면 건드리지 않음
    if (e.isComposing || e.key === 'Process') return;

    // 전역 토글
    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
      return;
    }

    // EN 모드: 기본 입력 통과 (아무것도 막지 않음)
    if (koreanInput.mode === 'en') return;

    // ===== 아래부터는 KO 모드에서만 실행: 네 기존 로직을 그대로 이식 =====

    if (e.key === 'Backspace'){
      e.preventDefault();
      const cursorStart = this.selectionStart;
      const cursorEnd = this.selectionEnd;

      if (cursorStart === cursorEnd){
        if (cursorStart &gt; 0){
          const textBefore = this.value.substring(0, cursorStart);
          const textAfter  = this.value.substring(cursorStart);
          const newTextBefore = koreanInput.handleBackspace(textBefore);
          const newText = newTextBefore + textAfter;
          this.value = newText;

          const newCursorPos = newTextBefore.length;
          this.setSelectionRange(newCursorPos, newCursorPos);

          if (newCursorPos &gt; 0){
            const charBeforeCursor = newText[newCursorPos - 1];
            koreanInput.restoreStateFromCharacter(charBeforeCursor);
          } else {
            koreanInput.reset();
          }
        }
      } else {
        const textBefore = this.value.substring(0, cursorStart);
        const textAfter  = this.value.substring(cursorEnd);
        const newText = textBefore + textAfter;
        this.value = newText;
        this.setSelectionRange(cursorStart, cursorStart);

        if (cursorStart &gt; 0){
          const charBeforeCursor = newText[cursorStart - 1];
          koreanInput.restoreStateFromCharacter(charBeforeCursor);
        } else {
          koreanInput.reset();
        }
      }
      return;
    }

    if (e.key === ' '){
      e.preventDefault();
      const cursorStart = this.selectionStart;
      const textBefore  = this.value.substring(0, cursorStart);
      const textAfter   = this.value.substring(this.selectionEnd);
      this.value = textBefore + ' ' + textAfter;

      const newCursorPos = cursorStart + 1;
      this.setSelectionRange(newCursorPos, newCursorPos);
      koreanInput.reset();
      return;
    }

    // 특수키 무시(Shift 등)
    if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

    const char = koreanInput.getCharacter(e.key, e.shiftKey);
    if (char){
      e.preventDefault();
      const result = koreanInput.processInput(char);
      const cursorPos = this.selectionStart;
      const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);
      this.value = insertResult.text;
      this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);
    }
  });

  // 클릭/마우스/터치로 커서 바꿨을 때 상태 초기화(네 기존 방식 유지)
  textarea.addEventListener('click', ()=&gt;{
    koreanInput.reset();
  });
  textarea.addEventListener('keyup', ()=&gt;{
    // 필요시 가상커서 동기화 등 넣을 자리
  });
}
</code></pre></div></div>

<hr />

<h1 id="4-한-번에-모두-장착--동적-추가도-커버">4) 한 번에 모두 장착 + 동적 추가도 커버</h1>

<p>페이지 로드시 모든 <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>를 찾아 장착하고, DOM에 새로운 textarea가 생기면 자동으로 붙인다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

document.addEventListener('DOMContentLoaded', function(){
  const koreanInput = new KoreanInput();
  window.koreanInput = koreanInput; // 다른 스크립트에서 접근 가능하도록

  // 배지 초기 상태 반영
  const badge = document.getElementById('imeBadge');
  if (badge){ badge.setAttribute('data-mode', koreanInput.mode); }

  // 페이지의 모든 textarea에 장착
  document.querySelectorAll('textarea').forEach(el=&gt;{
    // 권장 옵션 적용
    el.setAttribute('autocomplete','off');
    el.setAttribute('autocapitalize','off');
    el.setAttribute('spellcheck','false');
    attachKoreanHandlers(el, koreanInput);
  });

  // 동적 추가 대응
  const mo = new MutationObserver((mutations)=&gt;{
    for (const m of mutations){
      m.addedNodes &amp;&amp; m.addedNodes.forEach(node=&gt;{
        if (node.nodeType === 1){ // ELEMENT_NODE
          if (node.matches &amp;&amp; node.matches('textarea')){
            node.setAttribute('autocomplete','off');
            node.setAttribute('autocapitalize','off');
            node.setAttribute('spellcheck','false');
            attachKoreanHandlers(node, koreanInput);
          }
          // 하위에 여러 개 생기는 케이스
          node.querySelectorAll &amp;&amp; node.querySelectorAll('textarea').forEach(el=&gt;{
            el.setAttribute('autocomplete','off');
            el.setAttribute('autocapitalize','off');
            el.setAttribute('spellcheck','false');
            attachKoreanHandlers(el, koreanInput);
          });
        }
      });
    }
  });
  mo.observe(document.documentElement, { childList:true, subtree:true });

  // 전역 키로도 토글 가능(포커스가 textarea가 아니어도)
  document.addEventListener('keydown', (e)=&gt;{
    if (e.isComposing || e.key === 'Process') return;
    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
    }
  });

  // 배지 클릭으로도 전환(모바일 배려)
  if (badge){
    badge.addEventListener('click', ()=&gt; koreanInput.toggleMode());
  }
});
</code></pre></div></div>

<hr />

<h1 id="5-선택-옵션">5) 선택 옵션</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;input type="text"&gt;</code>에도 적용하고 싶다면 <code class="language-plaintext highlighter-rouge">querySelectorAll('textarea, input[type="text"], input[type="search"]')</code>로 확장하되, selection API가 동일하게 동작하는지 확인하자. 지금 로직은 대부분 호환된다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">contenteditable</code>까지 커버하려면 selection 처리와 text node 교체가 달라서 별 어댑터가 필요하다. 요청하면 그 버전도 만들어줄 수 있다.</p>
  </li>
  <li>
    <p>가상 키보드와 모드 동기화가 필요하면, 가상 키보드의 한/영 버튼 클릭 시 <code class="language-plaintext highlighter-rouge">window.koreanInput.toggleMode()</code>만 호출해주면 끝난다.</p>
  </li>
</ol>

<hr />

<h1 id="동작-요약">동작 요약</h1>

<ul>
  <li>
    <p>전역 모드 상태는 <code class="language-plaintext highlighter-rouge">localStorage('imeMode')</code>에 저장되어 새로고침해도 유지.</p>
  </li>
  <li>
    <p>화면 우하단 배지에 KO/EN 표시. 클릭하거나 Ctrl+Space, F2로 전환.</p>
  </li>
  <li>
    <p>모든 <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>에서 KO 모드일 때만 한글 조합(네 로직)이 동작, EN 모드면 브라우저 기본 입력.</p>
  </li>
  <li>
    <p>OS IME가 조합 중일 때는 <code class="language-plaintext highlighter-rouge">e.isComposing</code> 가드로 충돌 방지.</p>
  </li>
</ul>

<p>원하면 <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code>/<code class="language-plaintext highlighter-rouge">contenteditable</code> 확장과, 배지 디자인(아이콘 SVG, 다크모드, 접근성 라벨)도 덧입혀서 깔끔하게 정리해줄게.</p>

<p class="chat--user">

좋아 잘 되고 있다. 그런데 Ctrl+a, Ctrl+x 같은 키가 제대로 동작을 안해 이거 고쳐줄 수 있어? 

</p>

<p>좋아—바로 고칠 수 있어. 핵심은 <strong>Ctrl/⌘(Meta)와 조합된 단축키는 절대<code class="language-plaintext highlighter-rouge">preventDefault</code>로 막지 않는 것</strong>이야. 지금 keydown 핸들러가 KO 모드에서 Backspace·Space·문자 입력을 가로채다 보니 <code class="language-plaintext highlighter-rouge">Ctrl+A / X / C / V / Z / Y</code> 같은 표준 단축키가 비정상 동작하는 거지.</p>

<p>아래처럼 “수정 라인만” 추가하면 깔끔하게 해결돼.</p>

<h2 id="1-보조-함수-추가">1) 보조 함수 추가</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function isToggleHotkey(e){
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}

// Ctrl/Meta 조합(표준 단축키)면 브라우저에 맡기기
function isEditorShortcut(e){
  // AltGraph(우Alt)나 Ctrl+Alt 같은 조합도 통과
  const altGraph = e.getModifierState &amp;&amp; e.getModifierState('AltGraph');
  const ctrlMeta = e.ctrlKey || e.metaKey;
  const ctrlAlt  = e.ctrlKey &amp;&amp; e.altKey;
  return altGraph || ctrlAlt || ctrlMeta;
}
</code></pre></div></div>

<h2 id="2-keydown-핸들러-앞부분-분기-강화">2) <code class="language-plaintext highlighter-rouge">keydown</code> 핸들러 앞부분 분기 강화</h2>

<p>네가 모든 <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>에 붙이는 <code class="language-plaintext highlighter-rouge">keydown</code> 리스너 안에서, <strong>가장 위쪽에</strong> 아래 가드를 넣어.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

textarea.addEventListener('keydown', function(e){
  // OS IME 조합 중이면 건드리지 않음
  if (e.isComposing || e.key === 'Process') return;

  // 전역 토글 단축키 우선 처리
  if (isToggleHotkey(e)){
    e.preventDefault();
    koreanInput.toggleMode();
    return;
  }

  // ⭐ 표준 편집 단축키는 무조건 통과(Ctrl/⌘, AltGraph 등)
  if (isEditorShortcut(e)){
    return; // Ctrl+A/X/C/V/Z/Y, Ctrl+←/→ 등 전부 브라우저 기본 동작
  }

  // EN 모드는 전부 통과
  if (koreanInput.mode === 'en') return;

  // ----- 이하 KO 모드 전용 로직(기존 코드 유지) -----
  // Backspace/Space/문자 처리...
});
</code></pre></div></div>

<h2 id="3-ko-모드-내부에서도-조합된-backspace-예외-처리">3) KO 모드 내부에서도 “조합된 Backspace” 예외 처리</h2>

<p><code class="language-plaintext highlighter-rouge">Ctrl+Backspace</code>(단어 단위 삭제)나 <code class="language-plaintext highlighter-rouge">Ctrl+Delete</code>도 기본 동작을 살리고 싶다면 KO 블록 진입 <strong>이전</strong> 에 이미 <code class="language-plaintext highlighter-rouge">isEditorShortcut(e)</code>에서 빠져나가므로 추가 변경 없이 해결돼. 다만 혹시 아래처럼 KO 블록 안쪽에 Backspace를 먼저 잡아버리는 코드가 있다면, 한 줄만 보강하면 된다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

if (e.key === 'Backspace'){
  // ⭐ 단어 삭제 같은 조합은 통과
  // (여기까지 오면 Ctrl/Meta는 이미 걸러졌지만, 남겨두면 안전)
  if (e.ctrlKey || e.metaKey) return;

  e.preventDefault();
  // ... 네 기존 handleBackspace 로직 ...
  return;
}
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Space</code>도 마찬가지로 조합키와 함께 누르면 통과:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

if (e.key === ' '){
  // 예: Shift+Space 같은 변형을 통과시키고 싶다면 조건을 확장해도 됨
  if (e.ctrlKey || e.altKey || e.metaKey) return;
  e.preventDefault();
  // ... 기존 공백 처리 ...
  return;
}
</code></pre></div></div>

<h2 id="4-문자-입력-차단-조건-정리">4) 문자 입력 차단 조건 정리</h2>

<p>문자 키만 가로채고, 그 외 편집 키는 통과시키려면 이렇게 두면 안전해.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// 특수키 무시(Shift 등)
if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

// 여기서부터는 "일반 문자"만 가로챔
const char = koreanInput.getCharacter(e.key, e.shiftKey);
if (char){
  e.preventDefault();
  const result = koreanInput.processInput(char);
  const cursorPos = this.selectionStart;
  const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);
  this.value = insertResult.text;
  this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);
}
</code></pre></div></div>

<h2 id="5-결과">5) 결과</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Ctrl+A</code> 전체선택, <code class="language-plaintext highlighter-rouge">Ctrl+X/C/V</code> 잘린/복사/붙여넣기, <code class="language-plaintext highlighter-rouge">Ctrl+Z/Y</code> 되돌리기/다시하기, <code class="language-plaintext highlighter-rouge">Ctrl+←/→</code> 단어 단위 이동, <code class="language-plaintext highlighter-rouge">Ctrl+Backspace/Delete</code> 단어 삭제 모두 정상.</p>
  </li>
  <li>
    <p>KO 모드에서만 한글 조합이 적용되고, EN 모드/표준 단축키/OS IME 조합 상태는 전부 브라우저 기본 편집 흐름을 유지.</p>
  </li>
</ul>

<p>추가로, Edge/Windows에서 <strong>AltGraph(우Alt)</strong> 가 잡히는 환경이 종종 있어서 <code class="language-plaintext highlighter-rouge">isEditorShortcut</code>에 <code class="language-plaintext highlighter-rouge">AltGraph</code>를 꼭 포함했어. 이걸 빼면 일부 기호 입력이 막힐 수 있다.</p>

<p>원하면 <code class="language-plaintext highlighter-rouge">&lt;input type="text"&gt;</code>나 <code class="language-plaintext highlighter-rouge">contenteditable</code>까지 확장할 때의 단축키/선택 영역 처리도 같은 원칙으로 정리해 줄게.</p>

<p class="chat--user">

input 도 같은 방식으로 처리하고 싶어

</p>

<p>좋지! <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code>도 <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>와 똑같은 방식으로 처리할 수 있어. 핵심은 같은 키다운 핸들러를 재사용하고, 셀렉터를 <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code> + 텍스트계열 <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code>으로 확장하는 거야. 아래 코드를 그대로 추가·교체하면 된다.</p>

<h2 id="1-유틸-함수-그대로-사용">1) 유틸 함수 그대로 사용</h2>

<p>이미 쓰던 토글/단축키 가드 유지.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function isToggleHotkey(e){
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}
function isEditorShortcut(e){
  const altGraph = e.getModifierState &amp;&amp; e.getModifierState('AltGraph');
  const ctrlMeta = e.ctrlKey || e.metaKey;
  const ctrlAlt  = e.ctrlKey &amp;&amp; e.altKey;
  return altGraph || ctrlAlt || ctrlMeta;
}
</code></pre></div></div>

<h2 id="2-공통-장착-함수-textarea와-input-모두-지원">2) 공통 장착 함수: <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>와 <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> 모두 지원</h2>

<p>기존 <code class="language-plaintext highlighter-rouge">attachKoreanHandlers</code>를 살짝 일반화해 어느 편집 요소든 붙도록 한다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function attachKoreanHandlers(editEl, koreanInput){
  if (!editEl || editEl.__koreanAttached) return;
  editEl.__koreanAttached = true;

  // 권장 옵션(자동 교정 비활성)
  editEl.setAttribute('autocomplete','off');
  editEl.setAttribute('autocapitalize','off');
  editEl.setAttribute('spellcheck','false');

  // 포커스 시 상태 초기화
  editEl.addEventListener('focus', ()=&gt;{
    koreanInput.reset();
  });

  // 키다운: 공통 처리
  editEl.addEventListener('keydown', function(e){
    if (e.isComposing || e.key === 'Process') return;

    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
      return;
    }

    // Ctrl/Meta 등 편집 단축키는 통과
    if (isEditorShortcut(e)) return;

    // EN 모드는 통과
    if (koreanInput.mode === 'en') return;

    // KO 모드: 기존 로직
    if (e.key === 'Backspace'){
      if (e.ctrlKey || e.metaKey) return; // 단어 삭제 등 통과
      e.preventDefault();

      const cursorStart = this.selectionStart;
      const cursorEnd   = this.selectionEnd;

      if (cursorStart === cursorEnd){
        if (cursorStart &gt; 0){
          const textBefore = this.value.substring(0, cursorStart);
          const textAfter  = this.value.substring(cursorStart);
          const newTextBefore = koreanInput.handleBackspace(textBefore);
          const newText = newTextBefore + textAfter;
          this.value = newText;
          const newCursorPos = newTextBefore.length;
          this.setSelectionRange(newCursorPos, newCursorPos);

          if (newCursorPos &gt; 0){
            const charBeforeCursor = newText[newCursorPos - 1];
            koreanInput.restoreStateFromCharacter(charBeforeCursor);
          } else {
            koreanInput.reset();
          }
        }
      } else {
        const textBefore = this.value.substring(0, cursorStart);
        const textAfter  = this.value.substring(cursorEnd);
        const newText = textBefore + textAfter;
        this.value = newText;
        this.setSelectionRange(cursorStart, cursorStart);

        if (cursorStart &gt; 0){
          const charBeforeCursor = newText[cursorStart - 1];
          koreanInput.restoreStateFromCharacter(charBeforeCursor);
        } else {
          koreanInput.reset();
        }
      }
      return;
    }

    if (e.key === ' '){
      if (e.ctrlKey || e.altKey || e.metaKey) return; // 조합 스페이스는 통과
      e.preventDefault();
      const cursorStart = this.selectionStart;
      const textBefore  = this.value.substring(0, cursorStart);
      const textAfter   = this.value.substring(this.selectionEnd);
      this.value = textBefore + ' ' + textAfter;
      const newCursorPos = cursorStart + 1;
      this.setSelectionRange(newCursorPos, newCursorPos);
      koreanInput.reset();
      return;
    }

    // 특수키(Shift 등) 통과
    if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

    const char = koreanInput.getCharacter(e.key, e.shiftKey);
    if (char){
      e.preventDefault();
      const result = koreanInput.processInput(char);

      const cursorPos = this.selectionStart;
      const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);

      this.value = insertResult.text;
      this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);
    }
  });

  // 클릭/키업 등 상태 초기화
  editEl.addEventListener('click', ()=&gt; koreanInput.reset());
  editEl.addEventListener('keyup',  ()=&gt; {/* 필요시 커서 동기화 자리 */});
}
</code></pre></div></div>

<h2 id="3-초기-장착-textarea--텍스트계열-input-모두-선택">3) 초기 장착: <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code> + 텍스트계열 <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> 모두 선택</h2>

<p>폼 입력 타입 중 텍스트로 편집 가능한 것들만 포함한다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

document.addEventListener('DOMContentLoaded', function(){
  const koreanInput = new KoreanInput();
  window.koreanInput = koreanInput;

  // 모드 배지 초기화
  const badge = document.getElementById('imeBadge');
  if (badge) badge.setAttribute('data-mode', koreanInput.mode);

  // 대상 셀렉터: textarea + text/search/url/tel/password/email (숫자/날짜 계열 제외)
  const editableSelector = [
    'textarea',
    'input:not([type])',
    'input[type="text"]',
    'input[type="search"]',
    'input[type="url"]',
    'input[type="tel"]',
    'input[type="password"]',
    'input[type="email"]'
  ].join(',');

  document.querySelectorAll(editableSelector).forEach(el=&gt;{
    attachKoreanHandlers(el, koreanInput);
  });

  // 동적 추가 대응
  const mo = new MutationObserver(muts=&gt;{
    muts.forEach(m=&gt;{
      m.addedNodes &amp;&amp; m.addedNodes.forEach(node=&gt;{
        if (node.nodeType !== 1) return;
        if (node.matches &amp;&amp; node.matches(editableSelector)){
          attachKoreanHandlers(node, koreanInput);
        }
        node.querySelectorAll &amp;&amp; node.querySelectorAll(editableSelector).forEach(el=&gt;{
          attachKoreanHandlers(el, koreanInput);
        });
      });
    });
  });
  mo.observe(document.documentElement, { childList:true, subtree:true });

  // 전역 토글(포커스가 편집 요소가 아니어도 동작)
  document.addEventListener('keydown', (e)=&gt;{
    if (e.isComposing || e.key === 'Process') return;
    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
    }
  });

  // 배지 클릭으로 모드 전환
  if (badge){
    badge.addEventListener('click', ()=&gt; koreanInput.toggleMode());
  }
});
</code></pre></div></div>

<h2 id="4-주의사항과-팁">4) 주의사항과 팁</h2>

<ul>
  <li>
    <p>숫자/날짜 입력은 브라우저 기본 위젯과 충돌하니 셀렉터에서 제외했다. 필요하면 타입을 텍스트로 바꿔서 사용해.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">maxlength</code>가 있는 <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code>은 합성 중 글자 수가 순간 늘었다 줄 수 있다. 문제 생기면 <code class="language-plaintext highlighter-rouge">smartInsert</code>에서 길이 체크를 추가해서 최종 결과만 제한하도록 조정하자.</p>
  </li>
  <li>
    <p>붙여넣기 이벤트를 EN 모드에서만 통과시키고 KO 모드에서는 “붙여넣기 후 한글 재조합”을 하고 싶다면 <code class="language-plaintext highlighter-rouge">paste</code> 이벤트에서 <code class="language-plaintext highlighter-rouge">preventDefault()</code> 후 <code class="language-plaintext highlighter-rouge">e.clipboardData.getData('text')</code>를 읽어 <code class="language-plaintext highlighter-rouge">smartInsert</code>로 흘려주면 된다.</p>
  </li>
</ul>

<p>이렇게 붙이면 페이지의 모든 텍스트 입력 필드에서 동일하게 한/영 전환형 한글 조합이 동작하고, 표준 단축키(Ctrl/⌘+A/X/C/V/Z/Y)도 제대로 살아난다. 다음으로 <code class="language-plaintext highlighter-rouge">contenteditable</code>까지 확장하고 싶으면 알려줘—그건 Selection API 어댑터만 추가하면 된다.</p>

<p class="chat--user">

근데 한글 지울때 보면 작성 중인 글자는 한 개 자음/모음 지우지만 많이 지우면 한글자씩 다 지워지거든? 그걸 어떻게 구현할 수 있을까

</p>

<p>맞아, 한국어 입력기들이 보통 이렇게 동작해:</p>

<ul>
  <li>
    <p>작성 중(조합 중)일 땐 Backspace가 <strong>자모 단위</strong> 로 지움.</p>
  </li>
  <li>
    <p>Backspace를 <strong>길게 누르거나 빠르게 연타</strong> 하면 <strong>음절(글자) 단위</strong> 로 쭉 지움.<br />
이를 구현하려면 “백스페이스 모드”를 두고, <strong>키 반복(e.repeat)</strong> 이나 <strong>연타 간격</strong> 으로 모드를 전환하면 돼.</p>
  </li>
</ul>

<p>아래는 네 코드에 <strong>최소 변경</strong> 으로 넣는 방법이야.</p>

<h2 id="1-조합자모-삭제-vs-음절-삭제-함수-분리">1) 조합(자모) 삭제 vs 음절 삭제 함수 분리</h2>

<p>현재 <code class="language-plaintext highlighter-rouge">handleBackspace()</code>는 “자모 하나씩” 지우도록 되어 있어. 여기에 “음절 통삭제”용 함수를 하나 더 만든다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ① 자모-단위 삭제(네 기존 함수 그대로 사용)
handleBackspaceJamo(currentText){
  return this.handleBackspace(currentText);
}

// ② 음절-단위 삭제: 마지막 글자가 한글 음절이면 통째로 1코드포인트 삭제
handleBackspaceSyllable(currentText){
  if (currentText.length === 0) return '';
  const last = currentText.charCodeAt(currentText.length - 1);
  const isHangulSyllable = (last &gt;= this.SBase) &amp;&amp; (last &lt; this.SBase + this.SCount);
  // 음절이면 통으로 하나 삭제, 아니면 일반 문자처럼 하나 삭제
  return currentText.slice(0, currentText.length - 1);
}
</code></pre></div></div>

<h2 id="2-길게-누름연타-감지-상태-추가">2) “길게 누름/연타” 감지 상태 추가</h2>

<p>Backspace를 <strong>길게 누르면</strong> 브라우저가 <code class="language-plaintext highlighter-rouge">keydown</code>을 반복해서 주는데, 이때 <code class="language-plaintext highlighter-rouge">e.repeat === true</code>. 또, <strong>재빨리 연타</strong> 해도 음절 단위로 바꾸고 싶다면 “마지막 백스페이스 시각”을 기억해서 간격이 짧으면 음절 삭제 모드로 전환하자.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// 전역 또는 KoreanInput 내부(편한 곳)에 상태 변수
let bsLastTs = 0;
const BS_RAPID_MS = 220; // 이 시간 이내의 연타면 음절 삭제로 전환
</code></pre></div></div>

<h2 id="3-keydown-처리-로직-수정">3) keydown 처리 로직 수정</h2>

<p>핵심은 Backspace 처리에서 “모드 결정”만 추가하는 거야. (Ctrl/Meta 단축키, IME 가드는 전에 넣은 그대로 유지)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

editEl.addEventListener('keydown', function(e){
  if (e.isComposing || e.key === 'Process') return;

  if (isToggleHotkey(e)){ e.preventDefault(); koreanInput.toggleMode(); return; }
  if (isEditorShortcut(e)) return;         // Ctrl/⌘ 단축키 통과
  if (koreanInput.mode === 'en') return;   // EN 모드 통과

  if (e.key === 'Backspace'){
    // 단어삭제 같은 조합키는 통과
    if (e.ctrlKey || e.metaKey) return;

    e.preventDefault();

    const now = performance.now();
    const rapid = (now - bsLastTs) &lt; BS_RAPID_MS;  // 빠른 연타?
    bsLastTs = now;

    // ① 모드 결정: 키 반복이거나 빠른 연타면 '음절', 아니면 '자모'
    const deleteMode = (e.repeat || rapid) ? 'syllable' : 'jamo';

    const cursorStart = this.selectionStart;
    const cursorEnd   = this.selectionEnd;

    if (cursorStart === cursorEnd){
      if (cursorStart &gt; 0){
        const textBefore = this.value.substring(0, cursorStart);
        const textAfter  = this.value.substring(cursorStart);

        const newTextBefore = (deleteMode === 'syllable')
          ? koreanInput.handleBackspaceSyllable(textBefore)
          : koreanInput.handleBackspaceJamo(textBefore);

        const newText = newTextBefore + textAfter;
        this.value = newText;

        const newCursorPos = newTextBefore.length;
        this.setSelectionRange(newCursorPos, newCursorPos);

        if (newCursorPos &gt; 0){
          const charBeforeCursor = newText[newCursorPos - 1];
          koreanInput.restoreStateFromCharacter(charBeforeCursor);
        } else {
          koreanInput.reset();
        }
      }
    } else {
      // 선택영역 삭제는 동일
      const textBefore = this.value.substring(0, cursorStart);
      const textAfter  = this.value.substring(cursorEnd);
      const newText = textBefore + textAfter;
      this.value = newText;
      this.setSelectionRange(cursorStart, cursorStart);
      if (cursorStart &gt; 0){
        const charBeforeCursor = newText[cursorStart - 1];
        koreanInput.restoreStateFromCharacter(charBeforeCursor);
      } else {
        koreanInput.reset();
      }
    }
    return;
  }

  // ... 나머지 Space/일반 문자 처리 동일 ...
});
</code></pre></div></div>

<h2 id="4-동작-요약">4) 동작 요약</h2>

<ul>
  <li>
    <p><strong>짧게 한 번</strong> Backspace: 자모 하나 삭제 → 네 기존 <code class="language-plaintext highlighter-rouge">handleBackspace</code> 경로.</p>
  </li>
  <li>
    <p><strong>길게 누르거나</strong> <strong>빠르게 연타</strong> : 브라우저가 <code class="language-plaintext highlighter-rouge">keydown</code>을 반복(<code class="language-plaintext highlighter-rouge">e.repeat</code>) → 음절 단위 삭제(<code class="language-plaintext highlighter-rouge">handleBackspaceSyllable</code>).</p>
  </li>
  <li>
    <p>선택 영역이 있으면 그대로 선택 삭제.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Ctrl/⌘+Backspace</code> 등 편집 단축키는 통과(단어 삭제 등 기본 동작 유지).</p>
  </li>
</ul>

<h2 id="5-취향-옵션">5) 취향 옵션</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">BS_RAPID_MS</code>를 180~250ms 사이에서 조절하면 너가 원하는 “연타 인식 민감도”를 맞출 수 있어.</p>
  </li>
  <li>
    <p>“첫 1~2회는 자모, 그 이후는 음절” 같은 카운터 기반 정책으로도 바꿀 수 있어. 예: 같은 위치에서 연속 2회 이상 Backspace면 음절 삭제.</p>
  </li>
</ul>

<p>이 방식이면 네 조합기 흐름은 그대로 두면서, 실제 IME처럼 <strong>자모→음절</strong> 로 자연스럽게 삭제 동작이 넘어가서 체감 품질이 확 올라갈 거야.</p>

<p class="chat--user">

Ctrl+Z로 실행취소는 안되네

</p>

<p>맞아. 네 로직이 <code class="language-plaintext highlighter-rouge">.value = ...</code>로 직접 값을 바꾸고 있어서 브라우저의 기본 undo 스택에 기록이 안 남아 <code class="language-plaintext highlighter-rouge">Ctrl+Z</code>가 먹히지 않는 거야. 해결책은 “편집 API”를 써서 브라우저가 <strong>편집으로 인식</strong> 하게 만드는 것. 가장 쉬운 방법은 <code class="language-plaintext highlighter-rouge">HTMLInputElement.setRangeText()</code>를 쓰는 거고, 아주 넓은 호환을 원하면 <code class="language-plaintext highlighter-rouge">execCommand('insertText')</code>(폐기 예정이지만 실제로는 잘 동작)까지 폴백을 얹으면 돼.</p>

<p>아래처럼 바꾸면 <code class="language-plaintext highlighter-rouge">Ctrl+Z / Ctrl+Y</code>가 기본 편집 히스토리를 그대로 사용하게 된다.</p>

<h2 id="1-공통-적용-함수-추가">1) 공통 적용 함수 추가</h2>

<p>값을 직접 바꾸지 말고 이 함수로 바꿔치기 해.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function applyEditWithUndo(el, start, end, replacement, collapse = 'end') {
  // 1) setRangeText가 있으면 네이티브 편집으로 기록됨(undo 가능)
  if (typeof el.setRangeText === 'function') {
    el.setRangeText(replacement, start, end, collapse);
  } else if (document.queryCommandSupported &amp;&amp; document.queryCommandSupported('insertText')) {
    // 2) execCommand 폴백 (여전히 많은 브라우저에서 동작)
    el.setSelectionRange(start, end);
    document.execCommand('insertText', false, replacement);
  } else {
    // 3) 최후의 폴백: 직접 치환(undo 스택은 못 쌓음)
    const v = el.value;
    el.value = v.slice(0, start) + replacement + v.slice(end);
    const newPos = (collapse === 'end') ? (start + replacement.length)
                  : (collapse === 'start') ? start
                  : (start + replacement.length);
    el.setSelectionRange(newPos, newPos);
    return;
  }

  // setRangeText/execCommand 경로에선 커서 위치를 우리가 정리해 준다
  const pos = (collapse === 'end') ? (start + replacement.length)
            : (collapse === 'start') ? start
            : (start + replacement.length);
  el.setSelectionRange(pos, pos);
}
</code></pre></div></div>

<h2 id="2-삽입백스페이스스페이스-처리에-적용">2) 삽입·백스페이스·스페이스 처리에 적용</h2>

<p>이제 기존의 <code class="language-plaintext highlighter-rouge">this.value = ...</code>와 <code class="language-plaintext highlighter-rouge">setSelectionRange(...)</code>를 전부 <code class="language-plaintext highlighter-rouge">applyEditWithUndo(...)</code>로 교체하면 된다.</p>

<h3 id="문자-입력조합-삽입">문자 입력(조합 삽입)</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// 기존
// this.value = insertResult.text;
// this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);

// 변경
applyEditWithUndo(
  this,
  this.selectionStart,
  this.selectionEnd,
  // smartInsert는 “문자 1개 삽입 → 주변 재조합”을 하므로,
  // 실제로 바뀔 구간을 계산해야 한다.
  // 가장 단순한 방법: 삽입 전후 차이를 이용하거나,
  // 아래처럼 전체를 치환(간단하지만 비효율적)할 수도 있음.
  // 효율적으로 하려면 smartInsert가 리턴값에 바뀐 구간 범위(start/end)를 포함하도록 확장해.
  (function(){
    const before = this.value;
    const s = this.selectionStart, e = this.selectionEnd;
    const res = koreanInput.smartInsert(before, s, e, result); // 기존 호출 그대로
    // 값 전체를 새 값으로 교체
    // 범위치환을 쓰려면 smartInsert에 diff 범위 추가가 가장 좋음
    this.value = res.text; // 임시 쓰기(커서 보정용)
    return res.text.slice(0, res.cursorPosition); // 커서 위치 맞추기 위해 collapse='end' 사용
  }).call(this),
  'end'
);
// 주석: 위 간단 버전은 전체 치환이라 undo가 한 번에 잡히긴 해도 비효율.
// 가장 좋은 방식은 smartInsert가 {text, cursorPosition, replaceStart, replaceEnd}를 주도록 바꿔
// applyEditWithUndo(this, replaceStart, replaceEnd, replacement)로 부분 치환하는 것.
</code></pre></div></div>

<p>실무적인 권장: <code class="language-plaintext highlighter-rouge">smartInsert(...)</code>가 “어느 범위가 바뀌었는지”를 리턴하도록 확장하세요.<br />
예: <code class="language-plaintext highlighter-rouge">{ text, cursorPosition, rangeStart, rangeEnd, replacement }</code><br />
그럼 아래처럼 정확히 바뀐 구간만 치환할 수 있어요.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

const ins = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);
applyEditWithUndo(this, ins.rangeStart, ins.rangeEnd, ins.replacement, 'end');
</code></pre></div></div>

<h3 id="backspace자모음절">Backspace(자모/음절)</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// 기존
// this.value = newText;
// this.setSelectionRange(newPos, newPos);

// 변경
applyEditWithUndo(this, cursorStart - (textBefore.length - newTextBefore.length), cursorStart, ''); 
// 설명: 삭제한 길이만큼 start를 앞당겨 빈 문자열로 치환
</code></pre></div></div>

<p>너가 위에서 구현한 자모/음절 삭제 모드(키 반복, 연타)에 그대로 이 로직만 끼워 넣으면 된다.<br />
삭제는 “치환 텍스트를 빈 문자열로” 넣으면 undo 스택에 ‘삭제’로 쌓인다.</p>

<h3 id="space">Space</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// 기존
// this.value = textBefore + ' ' + textAfter;
// this.setSelectionRange(newCursorPos, newCursorPos);

// 변경
applyEditWithUndo(this, this.selectionStart, this.selectionEnd, ' ', 'end');
koreanInput.reset();
</code></pre></div></div>

<h2 id="3-단축키-통과-보강재확인">3) 단축키 통과 보강(재확인)</h2>

<p>이미 넣은 가드가 중요하다. <code class="language-plaintext highlighter-rouge">Ctrl/Meta/AltGraph</code> 조합은 절대 막지 않기.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function isEditorShortcut(e){
  const altGraph = e.getModifierState &amp;&amp; e.getModifierState('AltGraph');
  const ctrlMeta = e.ctrlKey || e.metaKey;
  const ctrlAlt  = e.ctrlKey &amp;&amp; e.altKey;
  return altGraph || ctrlAlt || ctrlMeta;
}

if (isEditorShortcut(e)) return; // KO/EN 모드 상관없이 통과
</code></pre></div></div>

<p>이렇게 하면 <code class="language-plaintext highlighter-rouge">Ctrl+Z / Ctrl+Y / Ctrl+A / Ctrl+X/C/V</code>가 전부 정상 동작하고, 네가 한 삽입·삭제도 브라우저의 undo 스택에 자연스럽게 누적된다.</p>

<h2 id="4-보너스-언제-undo-단위를-끊을지">4) 보너스: “언제 undo 단위를 끊을지”</h2>

<p>지금은 <code class="language-plaintext highlighter-rouge">setRangeText</code>를 호출할 때마다 작은 단위로 쌓인다. 보통은 이게 자연스럽고, 한글 조합도 음절 단위로 되돌려져서 괜찮다. 더 매끄럽게 하려면:</p>

<ul>
  <li>
    <p>조합 중(자모 입력 중)에는 여러 번의 setRangeText를 <strong>타이머(예: 350ms 무입력)</strong>로 묶어 하나의 undo 단위로 만들고,</p>
  </li>
  <li>
    <p>스페이스/엔터/모드전환 시점에 강제로 undo 단위를 끊는다.<br />
이건 고급 옵션이니 필요하면 이어서 잡아주자.</p>
  </li>
</ul>

<hr />

<p>요약: 값 직접 대입을 멈추고 <code class="language-plaintext highlighter-rouge">setRangeText</code>/<code class="language-plaintext highlighter-rouge">execCommand('insertText')</code>로 치환하라. 그러면 운영체제/브라우저가 편집으로 인식해서 <code class="language-plaintext highlighter-rouge">Ctrl+Z</code>가 살아난다.</p>

<p class="chat--user">

근데 모든 textedit에 koreanInput을 다는게 비효율적이진 않나? 그냥 focus가 됐을 때만 다는건 별로?

</p>

<p>좋은 감각이야. “모든 편집기에 리스너를 박아두기”보다, 포커스될 때만 붙이거나 아예 “문서 한 곳에서 위임 처리”가 더 효율적이야. 정리하면 선택지는 세 가지.</p>

<ol>
  <li>
    <p>요소별 부착: 모든 textarea/input에 keydown 등 리스너를 각각 붙임</p>
  </li>
  <li>
    <p>포커스 시 부착: focus될 때만 붙이고 blur 때 떼기</p>
  </li>
  <li>
    <p>이벤트 위임: 문서 하나에 keydown·focusin 리스너만 두고, 타깃이 편집기일 때만 동작</p>
  </li>
</ol>

<p>규모가 커질수록 3번(위임)이 메모리·성능·유지보수 측면에서 깔끔해. 키 이벤트는 버블링되므로 문서 레벨에서 잡아도 selection 조작이 가능해.</p>

<p>아래는 “위임 방식”으로 바꾼 최소 구현이야. 네가 이미 만든 KO/EN 모드, 단축키 가드, 자모/음절 삭제, undo 스택 보존까지 반영했어.</p>

<p>핵심 아이디어<br />
• 전역 한글 모드 상태: koreanInput.mode 유지<br />
• focusin에서 대상만 최소 설정(자동 교정 끄기 등)<br />
• keydown은 문서 하나에만 두고, 대상이 편집기면 동작<br />
• Ctrl/Meta 조합, IME 조합 중, 붙여넣기 등은 통과</p>

<p>예시 코드</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// 대상 셀렉터: textarea + 텍스트 계열 input
const EDITABLE_SELECTOR = [
  'textarea',
  'input:not([type])',
  'input[type="text"]',
  'input[type="search"]',
  'input[type="url"]',
  'input[type="tel"]',
  'input[type="password"]',
  'input[type="email"]'
].join(',');

function isEditable(el){
  return el &amp;&amp; el.matches &amp;&amp; el.matches(EDITABLE_SELECTOR);
}

function isToggleHotkey(e){
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}
function isEditorShortcut(e){
  const altGraph = e.getModifierState &amp;&amp; e.getModifierState('AltGraph');
  const ctrlMeta = e.ctrlKey || e.metaKey;
  const ctrlAlt  = e.ctrlKey &amp;&amp; e.altKey;
  return altGraph || ctrlAlt || ctrlMeta;
}

// Undo 가능한 치환
function applyEditWithUndo(el, start, end, replacement, collapse='end'){
  if (typeof el.setRangeText === 'function'){
    el.setRangeText(replacement, start, end, collapse);
    const pos = collapse === 'start' ? start : start + replacement.length;
    el.setSelectionRange(pos, pos);
  } else {
    const v = el.value;
    el.value = v.slice(0,start) + replacement + v.slice(end);
    const pos = collapse === 'start' ? start : start + replacement.length;
    el.setSelectionRange(pos, pos);
  }
}

// 빠른 연타/길게 누름에 따라 자모/음절 삭제 선택
let bsLastTs = 0;
const BS_RAPID_MS = 220;

document.addEventListener('DOMContentLoaded', () =&gt; {
  const koreanInput = new KoreanInput();
  window.koreanInput = koreanInput;

  const badge = document.getElementById('imeBadge');
  if (badge) badge.setAttribute('data-mode', koreanInput.mode);

  // 배지 클릭으로 모드 전환
  badge?.addEventListener('click', () =&gt; koreanInput.toggleMode());

  // 포커스 들어오면 최소 설정만 적용
  document.addEventListener('focusin', (e) =&gt; {
    const el = e.target;
    if (!isEditable(el)) return;
    el.setAttribute('autocomplete','off');
    el.setAttribute('autocapitalize','off');
    el.setAttribute('spellcheck','false');
    koreanInput.reset();
  });

  // 전역 토글 단축키(어디서든)
  document.addEventListener('keydown', (e) =&gt; {
    if (e.isComposing || e.key === 'Process') return;
    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
    }
  });

  // 핵심: 편집용 keydown 위임
  document.addEventListener('keydown', (e) =&gt; {
    const el = e.target;
    if (!isEditable(el)) return;
    if (e.isComposing || e.key === 'Process') return;

    // 표준 편집 단축키는 항상 통과
    if (isEditorShortcut(e)) return;

    // EN 모드면 아무 것도 가로채지 않음
    if (koreanInput.mode === 'en') return;

    // KO 모드만 아래 로직 실행
    if (e.key === 'Backspace'){
      // 단어 삭제 같은 조합키는 통과
      if (e.ctrlKey || e.metaKey) return;

      e.preventDefault();

      const now = performance.now();
      const rapid = (now - bsLastTs) &lt; BS_RAPID_MS;
      bsLastTs = now;
      const syllableMode = e.repeat || rapid;

      const s = el.selectionStart;
      const rStart = (() =&gt; {
        if (s === el.selectionEnd){ // 커서만
          if (s === 0) return s;
          const left = el.value.slice(0, s);
          if (syllableMode){
            // 음절 단위 삭제: 코드포인트 1개 제거
            return s - 1;
          } else {
            // 자모 단위 삭제: 조합 분해 후 한 단계
            const newLeft = koreanInput.handleBackspace(left);
            return newLeft.length;
          }
        } else {
          // 선택 삭제
          return s;
        }
      })();

      const rEnd = el.selectionEnd;
      if (s === rEnd){
        // 커서 한쪽 삭제: rStart..s 범위를 빈 문자열로
        applyEditWithUndo(el, rStart, s, '', 'start');
        // 상태 복구
        const pos = el.selectionStart;
        if (pos &gt; 0){
          const ch = el.value[pos - 1];
          koreanInput.restoreStateFromCharacter(ch);
        } else {
          koreanInput.reset();
        }
      } else {
        // 선택 삭제
        applyEditWithUndo(el, s, rEnd, '', 'start');
        const pos = el.selectionStart;
        if (pos &gt; 0){
          const ch = el.value[pos - 1];
          koreanInput.restoreStateFromCharacter(ch);
        } else {
          koreanInput.reset();
        }
      }
      return;
    }

    if (e.key === ' '){
      if (e.ctrlKey || e.altKey || e.metaKey) return;
      e.preventDefault();
      applyEditWithUndo(el, el.selectionStart, el.selectionEnd, ' ', 'end');
      koreanInput.reset();
      return;
    }

    // 특수키(Shift 등)는 통과
    if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

    const char = koreanInput.getCharacter(e.key, e.shiftKey);
    if (!char) return;

    e.preventDefault();

    // smartInsert를 위해 현재 범위 전달
    const s = el.selectionStart;
    const ins = koreanInput.smartInsert(el.value, s, el.selectionEnd, char);

    // 가장 깔끔한 방법은 smartInsert가 변경 범위를 알려주는 것
    // 없으니 간단하게 전체 치환 대신, 바뀐 앞쪽 길이만큼 덮어쓰기
    // 실무에서는 smartInsert 반환값을 {rangeStart, rangeEnd, replacement, cursorPosition}으로 확장 추천
    el.value = ins.text; // 임시 업데이트
    el.setSelectionRange(ins.cursorPosition, ins.cursorPosition);
  });
});
</code></pre></div></div>

<p>왜 위임이 좋은가<br />
• 리스너를 수천 개 붙이지 않아도 되고, 동적으로 생기는 입력 필드도 자동 커버된다.<br />
• 포커스될 때만 최소 속성 세팅하고, 실제 연산은 키 눌릴 때 타깃이 편집기인 경우에만 수행한다.<br />
• 메모리 누수 위험이 줄고, 유지보수가 쉽다.</p>

<p>언제 포커스-부착 방식이 좋을까<br />
• keydown 로직을 요소별로 달리해야 하거나, 특정 입력만 커스텀 조합을 쓰고 나머지는 완전히 배제하고 싶을 때. 이 경우 focusin에서 attach, focusout에서 detach하면 된다. 다만 attach/detach 관리 코드가 복잡해지고, 동적 생성·파괴가 잦으면 누락 위험이 있다.</p>

<p>마지막 팁<br />
• Shadow DOM 내부 입력(예: 일부 UI 라이브러리)은 문서 레벨 위임으로는 못 잡을 수 있다. 그땐 컴포넌트마다 focusin에서 별도로 붙여주자.<br />
• contenteditable 확장 계획이 있으면 Selection API용 어댑터를 추가로 만들어, 같은 위임 구조에 태워주면 된다.</p>

<p>원하면 smartInsert가 변경 범위를 리턴하도록 설계 바꿔서, undo 스택도 더 자연스럽게 끊기게 최적화해 줄게.</p>]]></content><author><name>hvppyarchive</name></author><category term="misc" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">untitled</title><link href="https://hvppyarchive.github.io/misc/virutual-korean-keyboard/" rel="alternate" type="text/html" title="untitled" /><published>2025-11-07T17:47:20+09:00</published><updated>2025-11-07T17:47:20+09:00</updated><id>https://hvppyarchive.github.io/misc/virutual-korean-keyboard</id><content type="html" xml:base="https://hvppyarchive.github.io/misc/virutual-korean-keyboard/"><![CDATA[<h3 id="chatgpt404-not-found">ChatGPT404 Not Found</h3>

<p>Paths cross empty void Seeking what once existed Silence answers all.</p>]]></content><author><name>hvppyarchive</name></author><category term="misc" /><summary type="html"><![CDATA[ChatGPT404 Not Found]]></summary></entry><entry><title type="html">Python 코드 실행 Tool Calling</title><link href="https://hvppyarchive.github.io/llm/python-interpreter-tool-calling/" rel="alternate" type="text/html" title="Python 코드 실행 Tool Calling" /><published>2025-11-05T17:49:25+09:00</published><updated>2025-11-05T17:49:25+09:00</updated><id>https://hvppyarchive.github.io/llm/python-interpreter-tool-calling</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/python-interpreter-tool-calling/"><![CDATA[<p class="chat--user">

아래와 같은 Code Interpreter 툴을 나의 (vLLM + GPTOSS / Qwen) + (OpenAI Agents SDK) 시스템에 넣고 싶어. 내가 원하는 것은 사실 이거 하나야. 파이썬 코드를 실행하되, 외부의 파일들을 망치지 않았으면 좋겠어. 그와 동시에 호스트 파일들에 단순 접근은 좀 자유로워도 좋을 것 같아. 파일을 생성/수정이 필요하면 지정한 폴더 안에 복사해서 다루면 좋을 것 같아. 그리고 도커가 없이 이런 시스템을 구성하고 싶어 #!/usr/bin/env python # coding: utf-8 # ## Build Your Own Code Interpreter - Dynamic Tool Generation and Execution With o3-mini # # At the core of providing a LLM Agent capability to interact with the outside world or other Agents is “tool (or function) calling,” where a LLM can invoke a function (a block of code) with arguments. Typically, these functions are predefined by the developer, along with their expected inputs and outputs. However, in this Cookbook, we explore a more flexible paradigm - to <strong>dynamically generate tools</strong> using LLM models (in this case <strong>o3-mini</strong>), with ability to execute the tool using a code interpreter. # # ### Dynamically Generated Tool Calling with Code Interpreter # A Dynamically Generated Tool is a function or code block created by the LLM itself at runtime based on the user’s prompt. This means you don’t have to predefine every possible scenario in your codebase—enabling far more open-ended, creative, and adaptive problem-solving. # # Dynamically Generated Tool Calling goes a step further by granting the LLM the ability to generate tools and execute code blocks on the fly. This dynamic approach is particularly useful for tasks that involve: # # - Data analysis and visualization # - Data manipulation and transformation # - Machine learning workflow generation and execution # - Process automation and scripting # - And much more, as new possibilities emerge through experimentation # # ### Using o3-mini for Dynamic Tool generation # # Released on 31-Jan-25, o3-mini model has exceptional STEM capabilities—with particular strength in science, math, and coding—all while maintaining the low cost and reduced latency of smaller models. In this Cookbook, we will demonstrate o3-mini's capabilities to generate python code to interpret data and draw insights. # # Reasoning models are particularly good at generating dynamic tools to analyze data since they can reason on their own, without the need of an explicit chain-of-thought prompt. In fact, providing explicit chain of thought instructions may interfere with model's internal reasoning and lead to suboptimal outcomes. You can learn more about o3-mini <a href="https://openai.com/index/openai-o3-mini/">here.</a> # # ### Why build your own code interpreter # # Many API providers—such as OpenAI’s Assistants API—offer built-in code interpreter functionality. These built-in code interpreters can be immensely powerful, but there are situations where developers may need to create their own custom code interpreter. For example: # # 1. <strong>Language or library support</strong>: The built-in interpreter may not support the specific programming language (e.g., C++, Java, etc.) or libraries required for your task. # 2. <strong>Task compatibility</strong>: Your use case may not be compatible with the provider’s built-in solution. # 3. <strong>Model constraints</strong>: You might require a language model that isn’t supported by the provider’s interpreter. # 4. <strong>Cost considerations</strong>: The cost structure for code execution or model usage may not fit your budget or constraints. # 5. <strong>File size</strong>: The file size of input data is too large or not supported by the provider's interpreter. # 6. <strong>Integrating with internal systems</strong>: The provider's interpreter may not be able to integrate with your internal systems. # # ### What You’ll Learn # By following this Cookbook, you will learn how to: # # - Set up an isolated Python code execution environment using Docker # - Configure your own code interpreter tool for LLM agents # - Establish a clear separation of “Agentic” concerns for security and safety # - Using <strong>o3-mini</strong> model to dynamically generate code for data analysis # - Orchestrate agents to efficiently accomplish a given task # - Design an agentic application that can dynamically generate and execute code # # You’ll learn how to build a custom code interpreter tool from the ground up, leverage the power of LLMs to generate sophisticated code, and safely execute that code in an isolated environment—all in pursuit of making your AI-powered applications more flexible, powerful, and cost-effective. # ### Example Scenario # # We'll use the sample data provided at <a href="https://www.kaggle.com/datasets/willianoliveiragibin/key-factors-traffic-accidents">Key Factors Traffic Accidents</a> to answer a set of questions. These questions do not require to be pre-defined, we will give LLM the ability to generate code to answer such question. # # Sample questions could be: # - What factors contribute the most to accident frequency? (Feature importance analysis) # - Which areas are at the highest risk of accidents? (Classification/Clustering) # - How does traffic fine amount influence the number of accidents? (Regression/Causal inference) # - Can we determine the optimal fine amounts to reduce accident rates? (Optimization models) # - Do higher fines correlate with lower average speeds or reduced accidents? (Correlation/Regression) # - and so on … # # Using the traditional <strong>Predefined Tool Calling</strong> approach, developer would need to pre-define the function for each of these questions. This limits the LLM's ability to answer any other questions not defined in the pre-defined set of functions. We overcome this limitation by using the <strong>Dynamic Tool Calling</strong> approach where the LLM generates code and uses a Code Interpretter tool to execute the code. # ## Overview # Let's dive into the steps to build this Agentic Applicaiton with Dynamically generated tool calling. There are three components to this application: # #### Step 1: Set up an isolated code execution container environment # # We need a secure environment where our LLM generated function calls can be executed. We want to avoid directly running the LLM generated code on the host machine so will create a Docker container environment with restricted resource access (e.g., no network access). By default, Docker containers cannot access the host machine’s file system, which helps ensure that any code generated by the LLM remains contained. # # ##### ⚠️ A WORD OF CAUTION: Implement Strong Gaurdrails for the LLM generated code # LLMs could generate harmful code with unintended consequences. As a best practice, isolate the code execution environment with only required access to resources as needed by the task. Avoid running the LLM generated code on your host machine or laptop. # # #### Step 2: Define and Test the Agents # # "<strong>What is an Agent?</strong>" In the context of this Cookbook, an Agent is: # 1. Set of instructions for the LLM to follow, i.e. the developer prompt # 2. A LLM model, and ability to call the model via the API # 3. Tool call access to a function, and ability to execute the function # # We will define two agents: # 1. FileAccessAgent: This agent will read the file and provide the context to the PythonCodeExecAgent. # 2. PythonCodeExecAgent: This agent will generate the Python code to answer the user's question and execute the code in the Docker container. # # #### Step 3: Set up Agentic Orchestration to run the application # There are various ways to orchestrate the Agents based on the application requirements. In this example, we will use a simple orchestration where the user provides a task and the agents are called in sequence to accomplish the task. # # The overall orchestration is shown below: # # <img src="../../images/oo_aa_image_1_code_interpreter_agents.png" alt="" /> # ## Let's get started # # # ### Prerequisites # Before you begin, ensure you have the following installed and configured on your host machine: # # 1. Docker: installed and running on your local machine. You can learn more about Docker and <a href="https://www.docker.com/">install it from here</a>. # 2. Python: installed on your local machine. You can learn more about Python and <a href="https://www.python.org/downloads/">install it from here</a>. # 3. OpenAI API key: set up on your local machine as an environment variable or in the .env file in the root directory. You can learn more about OpenAI API key and <a href="https://platform.openai.com/docs/api-reference/introduction">set it up from here</a>. # # ### Step 1: Set up an Isolated Code Execution Environment # # Lets define a Dockerized container environment that will be used to execute our code. I have defined the <strong><a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/docker/dockerfile">dockerfile</a></strong> under <code class="language-plaintext highlighter-rouge">resources/docker</code> directory that will be used to create the container environment with the following specifications: # - Python 3.10 as the base # - A non-root user # - Preinstall the packages in requirements.txt # # The requirements.txt included in the docker image creation process contains all the potential packages our LLM generated code may need to accomplish its tasks. Given we will restrict the container from network access, so we need to pre-install the packages that are required for the task. Our LLM will not be allowed to install any additional packages for security purposes. # # You could create your own docker image with the language requirements (such as Python 3.10) and pre-install the packages that are required for the task, or create a custom docker image with the specific language (such as Java, C++, etc.) and packages that are required for the task. # Let's build the docker image with the following command. For the sake of brevity, I have redirected the output to grep the success message and print a message if the build fails. # In[1]: get_ipython().system('docker build -t python_sandbox:latest ./resources/docker 2&gt;&amp;1 | grep -E "View build details|ERROR" || echo "Build failed."') # Let's run the container in restricted mode. The container will run in the background. This is our opportunity to define the security policies for the container. It is good practice to only allow the bare minimum features to the container that are required for the task. By default, the container cannot access the host file system from within the container. Let's also restrict its access to network so it cannot access the Internet or any other network resources. # In[2]: # Run the container in restricted mode. The container will run in the background. get_ipython().system('docker run -d –name sandbox –network none –cap-drop all –pids-limit 64 –tmpfs /tmp:rw,size=64M python_sandbox:latest sleep infinity') # Let's make sure container is running using the <code class="language-plaintext highlighter-rouge">docker ps</code> that should list our container. # In[3]: get_ipython().system('docker ps') # ### Step 2: Define and Test the Agents # # For our purposes, we will define two agents. # 1. <strong>Agent 1: File Access Agent (with Pre-defined Tool Calling)</strong> # - Instructions to understand the contents of the file to provide as context to Agent 2. # - Has access to the host machine’s file system. # - Can read a file from the host and copy it into the Docker container. # - Cannot access the code interpreter tool. # - Uses gpt-4o model. # # 2. <strong>Agent 2: Python Code Generator and Executor (with Dynamically Generated Tool Calling and Code Execution)</strong> # - Recieve the file content's context from Agent 1. # - Instructions to generate a Python script to answer the user's question. # - Has access to the code interpreter within the Docker container, which is used to execute Python code. # - Has access only to the file system inside the Docker container (not the host). # - Cannot access the host machine’s file system or the network. # - Uses our newest <strong>o3-mini</strong> model that excels at code generation. # # This separation concerns of the File Access (Agent 1) and the Code Generator and Executor (Agent 2) is crucial to prevent the LLM from directly accessing or modifying the host machine. # # # <strong>Limit the Agent 1 to Static Tool Calling as it has access to the host file system.</strong> # # # | Agent | Type of Tool Call | Access to Host File System | Access to Docker Container File System | Access to Code Interpreter | # |——-|——————-|—————————-|—————————————-|—————————-| # | Agent 1: File Access | Pre-defined Tools | Yes | Yes | No | # | Agent 2: Python Code Generator and Executor | Dynamically Generated Tools | No | Yes | Yes | # # To keep the Agents and Tools organized, we've defined a set of <strong>core classes</strong> that will be used to create the two agents for consistency using Object Oriented Programming principles. # # - <strong>BaseAgent</strong>: We start with an abstract base class that enforces common method signatures such as <code class="language-plaintext highlighter-rouge">task()</code>. Base class also provides a logger for debugging, a language model interface and other common functions such as <code class="language-plaintext highlighter-rouge">add_context()</code> to add context to the agent. # - <strong>ChatMessages</strong>: A class to store the conversation history given ChatCompletions API is stateless. # - <strong>ToolManager</strong>: A class to manage the tools that an agent can call. # - <strong>ToolInterface</strong>: An abstract class for any 'tool' that an agent can call so that the tools will have a consistent interface. # # These classes are defined in the <a href="./resources/object_oriented_agents/core_classes">object_oriented_agents/core_classes</a> directory. # #### UML Class Diagram for Core Classes # The following class diagram shows the relationship between the core classes. This UML (Unified Modeling Language) has been generated using <a href="https://mermaid">Mermaid</a> # # <img src="../../images/oo_aa_image_2_uml_diagram.png" alt="" /> # <strong>Define Agent 1: FileAccessAgent with FileAccessTool</strong> # # Let's start with definin the FileAccessTool that inherits from the ToolInterface class. The <strong>FileAccessTool</strong> tool is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/tools/file_access_tool.py">file_access_tool.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/tools</code> directory. # # - FileAccessTool implements the ToolInterface class, which ensures that the tools will have a consistent interface. # - Binding the tool definition for the OpenAI Function Calling API in the <code class="language-plaintext highlighter-rouge">get_definition</code> method and the tool's <code class="language-plaintext highlighter-rouge">run</code> method ensures maintainability, scalability, and reusability. # Now, let's define the <strong>FileAccessAgent</strong> that extends the BaseAgent class and bind the <strong>FileAccessTool</strong> to the agent. The FileAccessAgent is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/agents/file_access_agent.py">file_acess_agent.py</a> file in <code class="language-plaintext highlighter-rouge">resources/registry/agents</code> directory. The FileAccessAgent is: # # - A concrete implementation of the BaseAgent class. # - Initialized with the developer prompt, model name, logger, and language model interface. These values can be overridden by the developer if needed. # - Has a setup_tools method that registers the FileAccessTool to the tool manager. # - Has a <code class="language-plaintext highlighter-rouge">task</code> method that calls the FileAccessTool to read the file and provide the context to the PythonCodeExecAgent. # - <code class="language-plaintext highlighter-rouge">model_name='gpt-4o'</code> that provides sufficient reasoning and tool calling ability for the task. # # <strong>Define Agent 2: PythonExecAgent with PythonExecTool</strong> # # Similarly, PythonExecTool inherits from the ToolInterface class and implements the get_definition and run methods. The get_definition method returns the tool definition in the format expected by the OpenAI Function Calling API. The run method executes the Python code in a Docker container and returns the output. This tool is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/tools/python_code_interpreter_tool.py">python_code_interpreter_tool.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/tools</code> directory. # # Likewise, PythonExecAgent is a concrete implementation of the BaseAgent class. It is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/agents/python_code_exec_agent.py">python_code_exec_agent.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/agents</code> directory. The PythonExecAgent is: # # - A concrete implementation of the BaseAgent class. # - Initialized with the developer prompt, model name, logger, and language model interface. These values can be overridden by the developer if needed. # - Has a setup_tools method that registers the PythonExecTool to the tool manager. # - Has a <code class="language-plaintext highlighter-rouge">task</code> method that calls the OpenAI API to perform the user's task, which in this case involves generating a Python script to answer the user's question and run it with Code Interpreter tool. # - <code class="language-plaintext highlighter-rouge">model_name='o3-mini'</code> that excels at STEM tasks such as code generation. # - <code class="language-plaintext highlighter-rouge">reasoning_effort='high'</code> that allows for more complete reasoning given the complexity of the task at the cost of more tokens generated and slower responses. The default value is medium, which is a balance between speed and reasoning accuracy. # # You can learn more about the <code class="language-plaintext highlighter-rouge">reasoning_effort</code> parameter <a href="https://platform.openai.com/docs/guides/reasoning">here</a>. # ### Step 3: Set up Agentic Orchestration to run the application # # With the Agents defined, now we can define the orchestration loop that will run the application. This loop will prompt the user for a question or task, and then call the FileAccessAgent to read the file and provide the context to the PythonExecAgent. The PythonExecAgent will generate the Python code to answer the user's question and execute the code in the Docker container. The output from the code execution will be displayed to the user. # # User can type 'exit' to stop the application. Our question: <strong>What factors contribute the most to accident frequency?</strong> Note that we did not pre-define the function to answer this question. # # # In[4]: # Import the agents from registry/agents from resources.registry.agents.file_access_agent import FileAccessAgent from resources.registry.agents.python_code_exec_agent import PythonExecAgent prompt = """Use the file traffic_accidents.csv for your analysis. The column names are: Variable Description accidents Number of recorded accidents, as a positive integer. traffic_fine_amount Traffic fine amount, expressed in thousands of USD. traffic_density Traffic density index, scale from 0 (low) to 10 (high). traffic_lights Proportion of traffic lights in the area (0 to 1). pavement_quality Pavement quality, scale from 0 (very poor) to 5 (excellent). urban_area Urban area (1) or rural area (0), as an integer. average_speed Average speed of vehicles in km/h. rain_intensity Rain intensity, scale from 0 (no rain) to 3 (heavy rain). vehicle_count Estimated number of vehicles, in thousands, as an integer. time_of_day Time of day in 24-hour format (0 to 24). accidents traffic_fine_amount """ print("Setup: ") print(prompt) print("Setting up the agents… ") # Instantiate the agents with the default constructor defined values # Developer may override the default values - prompt, model, logger, and language model interface if needed # This agent use gpt-4o by default file_ingestion_agent = FileAccessAgent() # Let's make sure agent uses o3-mini model and set the reasoning_effort to high data_analysis_agent = PythonExecAgent(model_name='o3-mini', reasoning_effort='high') print("Understanding the contents of the file…") # Give a task to the file ingestion agent to read the file and provide the context to the data analysis agent file_ingestion_agent_output = file_ingestion_agent.task(prompt) # Add the file content as context to the data analysis agent # The context is added to the agent's tool manager so that the tool manager can use the context to generate the code data_analysis_agent.add_context(prompt) data_analysis_agent.add_context(file_ingestion_agent_output) while True: print("Type your question related to the data in the file. Type 'exit' to exit.") user_input = input("Type your question.") if user_input == "exit": print("Exiting the application.") break print(f"User question: {user_input}") print("Generating dynamic tools and using code interpreter…") data_analysis_agent_output = data_analysis_agent.task(user_input) print("Output…") print(data_analysis_agent_output) # In this example, the <strong>o3-mini</strong> dynamically generated a tool (Python script) based on user's question to analyze the data. Note that <strong>o3-mini</strong> examined the problem using multiple approaches such as correlation analysis, linear regression and random forest models. This approach highlights the following: # # <strong>reasoning_effort</strong>: The depth of reasoning the model performs e.g., in this case number of approaches, generally increases when the parameter is increased from low, medium to high. You can try with different levels of reasoning effort to see the difference. # # <strong>Dynamically Generated Tool Calling</strong>: The tool (Python script) to analyze the data was not manually written or predetermined by the developer. Instead, the o3-mini model created the relevant data exploration and correlation analysis code at runtime. # # <strong>Isolated Code Execution</strong>: To ensure security and avoid running untrusted code on the host machine, the Python script was executed inside a Docker container using the <code class="language-plaintext highlighter-rouge">execute_python_code</code> tool. This container had restricted resource access (e.g., no network and limited filesystem access), minimizing potential risks posed by arbitrary code execution. # # ### Conclusion # # The Cookbook provides a guide for developing a <strong>custom code interpreter</strong> tailored to specific application needs, addressing limitations found in vendor-provided solutions such as language constraints, cost considerations, and the need for flexibility with different LLMs or models. # # <strong>Approach for Managing Agents and Tools</strong>: We also defined a set of core classes to manage the agents and tools. This approach ensures that the agents and tools will have a consistent interface and can be reused across different applications. A repository of agents and tools such as the <a href="https://github.com/openai/openai-cookbook/tree/main/examples/object_oriented_agentic_approach/resources/registry">registry</a> folder can be created to manage the agents and tools. # # <strong>o3-mini model</strong>: We demonstrated o3-mini model's ability to generate sophisticated code at run time to analyze data based on user's minimal prompt. o3-mini model then reasoned over the outcome of the analysis to explain the results to the user. # # Finally, <strong>to recap</strong>, the three steps to build an Agentic Application with Dynamic Tool Calling are: # 1. Set up an isolated code execution container environment # 2. Define and Test the Agents # 3. Set up Agentic Orchestration to run the application # # We discussed the importance of isolating the code execution environment to ensure security and avoid running untrusted code on the host machine. With the use case of a CSV file, we demonstrated how to dynamically generate a tool (a Python script) to analyze the data and answer the user's question. We also showed how to execute the code in a Docker container and return the output to the user.

</p>

<p>한국어로 답함.<br />
문장 앞에 인용(Blockquote) 금지, 그대로 일반 텍스트로만 서술.</p>

<hr />

<h3 id="당신이-원하는-목표를-다시-정리하면-다음과-같아">당신이 원하는 목표를 다시 정리하면 다음과 같아:</h3>

<ol>
  <li>
    <p>LLM이 생성한 <strong>파이썬 코드를 실행</strong> 하고 싶다.</p>
  </li>
  <li>
    <p>하지만 <strong>호스트 파일 시스템을 망가뜨리거나 수정하면 안 된다</strong>.</p>
  </li>
  <li>
    <p>필요할 경우 파일은 <strong>지정된 작업 폴더에 복사해서 그 안에서만 처리</strong> 되길 원한다.</p>
  </li>
  <li>
    <p>Docker 없이 (즉, 컨테이너 없이) 구현하고 싶다.</p>
  </li>
  <li>
    <p>시스템은 vLLM + Qwen + OpenAI Agents SDK 또는 GPTOSS 기반으로 구성하려고 한다.</p>
  </li>
</ol>

<p>여기서 가장 큰 도전은 <strong>보안 격리 없이 호스트에서 실행되는 코드</strong> 를 어떻게 안전하게 제한하느냐이다. Docker는 자연스러운 해결책이지만, 당신이 원하지 않는다고 했으므로 <strong>Python 자체의 가상화 + 시스템 수준의 sand-boxing(권한 제한)</strong> 방향으로 접근해야 한다.</p>

<p>나는 아래 방식으로 접근을 추천한다.</p>

<hr />

<h2 id="단계별-설계-step-by-step">단계별 설계 (step-by-step)</h2>

<h3 id="1단계-작업-디렉토리sandbox-workspace-구조-정의">1단계. "작업 디렉토리(sandbox workspace)" 구조 정의</h3>

<p>예시 구조:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/host
   /data              ← 원본 파일들 <span class="o">(</span>읽기 전용<span class="o">)</span>
   /sandbox           ← LLM 생성 코드가 실행되는 폴더 <span class="o">(</span>쓰기 가능<span class="o">)</span>
   /runner            ← 코드 실행 스크립트
</code></pre></div></div>

<p>원본 파일 접근 방침:</p>

<ul>
  <li>
    <p>호스트의 <code class="language-plaintext highlighter-rouge">/data</code> 는 읽기만 허용.</p>
  </li>
  <li>
    <p>작업에 필요한 파일이 있으면 <code class="language-plaintext highlighter-rouge">/sandbox</code> 로 복사한 뒤 그 안에서만 사용.</p>
  </li>
</ul>

<p>파이썬 실행 환경에서 <code class="language-plaintext highlighter-rouge">open()</code> 이 /data 를 수정하지 못하도록 강제하려면, <code class="language-plaintext highlighter-rouge">runner</code> 레벨에서 path 검증을 넣어야 한다.</p>

<hr />

<h3 id="2단계-python-실행을-진짜-분리된-프로세스에서-실행하게-하기">2단계. Python 실행을 "진짜 분리된 프로세스"에서 실행하게 하기</h3>

<p>핵심은 코드 실행을 <strong>서브 프로세스로 분리하는 것</strong>.</p>

<p>의사 코드:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arduino

# runner.py
def run_code(code_string):
    생성된_코드를 /sandbox/temp.py 로 저장
    subprocess.run(["python", "/sandbox/temp.py"], timeout=5, cwd="/sandbox")
</code></pre></div></div>

<p>여기서 중요한 안전장치:</p>

<ul>
  <li>
    <p>cwd 를 /sandbox 로 고정</p>
  </li>
  <li>
    <p>timeout (= 무한 루프, while True 방지)</p>
  </li>
  <li>
    <p>subprocess 실행 전에 파일명 및 path 검증</p>
  </li>
</ul>

<hr />

<h3 id="3단계-파일-접근-필터링-안전-장치">3단계. 파일 접근 필터링 (안전 장치)</h3>

<p>파이썬 코드에 직접적인 파일 접근을 막으려면:<br />
방법 A. exec 환경에서 <code class="language-plaintext highlighter-rouge">open</code> 같은 builtins 제거<br />
방법 B. Python restricted environment 적용 (대신 완전하지 않음)<br />
방법 C. 오버레이 파일시스템 또는 chroot (Docker 없이 가능)</p>

<p>여기서는 <strong>가장 간단한 실용적 보호</strong> 를 추천한다.</p>

<p>예제 코드:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">safe_globals</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">range</span><span class="sh">"</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">len</span><span class="sh">"</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">print</span><span class="sh">"</span><span class="p">:</span> <span class="k">print</span><span class="p">,</span>
        <span class="c1"># 필요한 최소 기능만 허용
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">exec</span><span class="p">(</span><span class="n">code_string</span><span class="p">,</span> <span class="n">safe_globals</span><span class="p">)</span>
</code></pre></div></div>

<p>단, 데이터 분석 목적이라면 pandas, numpy 필요하므로 위 방식이 너무 제한된다.<br />
그래서 더 현실적인 방법은 <strong>subprocess 실행 + sys.setrecursionlimit 제한 + resource 모듈로 메모리/CPU 제한</strong> 이다.</p>

<p>예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">resource</span>

<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>          <span class="c1"># CPU 제한 2초
</span><span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="p">(</span><span class="mi">800</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span>  <span class="c1"># 메모리 800MB 제한
</span></code></pre></div></div>

<hr />

<h3 id="4단계-openai-agents-sdk-또는-vllm-function-calling-설계">4단계. OpenAI Agents SDK (또는 vLLM Function-calling) 설계</h3>

<p>코드 실행을 하나의 Tool 로 정의한다.</p>

<p>개념적 pseudo-code:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute_python_tool</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sandbox_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/sandbox/temp.py</span><span class="sh">"</span>
    <span class="n">code를</span> <span class="n">sandbox_path</span> <span class="n">에</span> <span class="n">저장</span>
    <span class="n">subprocess로</span> <span class="n">실행하고</span> <span class="n">stdout</span><span class="o">/</span><span class="n">stderr</span> <span class="n">반환</span>
</code></pre></div></div>

<p>LLM 에게 tool spec 을 제공:</p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">tools</span> <span class="p">=</span> <span class="s">[</span>
    <span class="err">{</span>
        <span class="err">"type":</span> <span class="err">"function",</span>
        <span class="err">"name":</span> <span class="err">"execute_python_tool",</span>
        <span class="err">"description":</span> <span class="err">"Executes</span> <span class="err">python</span> <span class="err">code</span> <span class="err">inside</span> <span class="err">sandbox",</span>
        <span class="err">"parameters":</span> <span class="err">{</span>
            <span class="err">"type":</span> <span class="err">"object",</span>
            <span class="err">"properties":</span> <span class="err">{</span>
                <span class="err">"code":</span> <span class="err">{"type":</span> <span class="err">"string"}</span>
            <span class="err">},</span>
            <span class="err">"required":</span> <span class="nn">["code"]</span>
        <span class="err">}</span>
    <span class="err">}</span>
<span class="err">]</span>
</code></pre></div></div>

<p>vLLM(Qwen/GPTOSS) + Agents SDK 는 다음과 같이 동작:</p>

<ul>
  <li>사용자가 “분석해줘” → LLM → 코드 생성 → tool 호출 → python 실행 → 결과 반환.</li>
</ul>

<hr />

<h3 id="5단계-호스트-파일-보호-정리">5단계. 호스트 파일 보호 (정리)</h3>

<p>보안 수칙:</p>

<ol>
  <li>
    <p>코드 실행은 항상 <strong>subprocess에서</strong> 실행.</p>
  </li>
  <li>
    <p>sandbox 디렉토리 외 경로 접근 시 <strong>실행 거부</strong>.</p>
  </li>
  <li>
    <p>CPU / 메모리 / 실행시간 제한.</p>
  </li>
  <li>
    <p>생성된 파일도 sandbox 내부에서만.</p>
  </li>
</ol>

<hr />

<h3 id="요약-당신이-얻는-것">요약 (당신이 얻는 것)</h3>

<ul>
  <li>
    <p><strong>Docker 없이도 가능한 code interpreter</strong></p>
  </li>
  <li>
    <p><strong>LLM이 generate → 실행 → 결과 반환</strong> 하는 Pipeline</p>
  </li>
  <li>
    <p><strong>호스트 파일을 읽기 전용으로 유지</strong> 하면서, 수정은 전부 sandbox에서만</p>
  </li>
  <li>
    <p><strong>LLM 기반 동적 tool execution</strong></p>
  </li>
</ul>

<hr />

<h3 id="다음-단계">다음 단계</h3>

<p>원한다면,</p>

<ul>
  <li>
    <p>내가 직접 프로덕션 수준 코드 (예: runner.py, tool binding 코드) 를 작성해 줄 수 있다</p>
  </li>
  <li>
    <p>또는 vLLM + Agents SDK 와 통합된 전체 프로젝트 템플릿을 만들어 줄 수 있다</p>
  </li>
</ul>

<p>한마디로, 당신이 만들려는 건 <strong>Code Interpreter Clone, but without Docker</strong>.</p>

<p>계속 도와줄게.<br />
다음 메시지에 아래 중 하나 선택해줘:</p>

<ol>
  <li>
    <p>Python 실제 실행 코드 + tool 코드 생성 원함</p>
  </li>
  <li>
    <p>vLLM + Qwen + Agents SDK 통합 구조 샘플 원함</p>
  </li>
  <li>
    <p>둘 다 원함</p>
  </li>
</ol>

<p>언제든 확장해서 고고!</p>

<p class="chat--user">

1. 어제 너가 만들어준 코드도 참고해줘. 이 코드의 장점은 Kernel이 유지된다는 장점이 있는 것 같아 2. data 폴더를 따로 안 만들고 모든 경로에 접근 가능하되 쓸 파일은 copy_to_sandbox(source, destination) 같은 Tool로 가져올 수 있게 하면 좋겠어. 3. 너가 준 예시에서 temp.py 가 sanbox 안의 파일만 접근한다는 보장이 없지 않아? 이런 걸 해줄 수 있는 라이브러리 없어? 도커 같은 외부 프로그램은 별로 안 쓰고 싶네 import os, time, base64, re from typing import Dict, Any, List from openai import OpenAI from jupyter_client import KernelManager # ========= 설정 ========= # 환경변수 OPENAI_API_KEY 필요 MODEL = os.environ.get("OPENAI_MODEL", "gpt-5.1") DATA_DIR = os.environ.get("DATA_DIR", "/mnt/data") os.makedirs(DATA_DIR, exist_ok=True) # ========= 임베디드 커널 실행기 ========= class KernelSession: def <strong>init</strong>(self): # 히스토리 비활성화로 깔끔하게 self.km = KernelManager() self.km.start_kernel(extra_arguments=["–HistoryManager.enabled=False"]) self.kc = self.km.client(); self.kc.start_channels() def shutdown(self): try: self.kc.stop_channels() self.km.shutdown_kernel(now=True) except Exception: pass def execute(self, code: str, timeout: float = 3.0) -&gt; Dict[str, Any]: # 간단한 안전 필터(정책에 맞게 확장 가능) if re.search(r"\bseaborn\b", code): return {"returncode": 2, "stdout": "", "stderr": "Do not use seaborn", "artifacts": []} msg_id = self.kc.execute(code, allow_stdin=False, stop_on_error=True) t0 = time.time(); out=[]; err=[]; arts=[] while True: if time.time() - t0 &gt; timeout: # 타임아웃 시 커널 강제 종료(무한루프 방지) self.km.shutdown_kernel(now=True) return {"returncode":124,"stdout":"".join(out),"stderr":"Timeout","artifacts":[]} try: msg = self.kc.get_iopub_msg(timeout=0.1) except Exception: continue if msg["parent_header"].get("msg_id") != msg_id: continue typ = msg["header"]["msg_type"]; content = msg["content"] if typ == "stream": (out if content["name"]=="stdout" else err).append(content["text"]) elif typ == "error": err.append("\n".join(content.get("traceback", []))) elif typ in ("display_data","execute_result"): data = content.get("data", {}) if "image/png" in data: b = data["image/png"] if isinstance(b, str): b = b.encode() png = base64.b64decode(b) fn = f"plot_{int(time.time()<em>1000)}.png" fp = os.path.join(DATA_DIR, fn) with open(fp, "wb") as f: f.write(png) arts.append({"name": fn, "path": f"/mnt/data/{fn}", "mime": "image/png"}) elif typ == "status" and content["execution_state"] == "idle": break return { "returncode": 0, "stdout": "".join(out)[:20000], "stderr": "".join(err)[:20000], "artifacts": arts } class KernelPool: def <strong>init</strong>(self): self.sessions: Dict[str, KernelSession] = {} def get(self, session_id: str) -&gt; KernelSession: if session_id not in self.sessions: self.sessions[session_id] = KernelSession() return self.sessions[session_id] def kill(self, session_id: str): s = self.sessions.pop(session_id, None) if s: s.shutdown() POOL = KernelPool() def _plot_rule_check(code: str) -&gt; str | None: # 단일 플롯, 색상/스타일 지정 금지(원하는 정책이면 완화 가능) if re.search(r"\.subplot\(", code) or re.search(r"subplots\(", code): return "Do not use subplots" if re.search(r"(color\s</em>=|palette\s<em>=|style\s</em>=)", code): return "Do not set explicit colors or styles" return None # ========= OpenAI tools 정의(HTTP 서버 없이 in-process) ========= python_exec_internal_tool = { "type": "function", "function": { "name": "python_exec_internal", "description": "내부 분석용 파이썬 실행(사용자에겐 출력 숨김). 세션은 session_id로 유지.", "parameters": { "type": "object", "properties": { "session_id": {"type": "string", "description": "대화/스레드 식별자"}, "code": {"type": "string"}, "timeout_sec": {"type": "integer","minimum":1,"maximum":10,"default":3} }, "required": ["session_id", "code"], "additionalProperties": False }, "strict": True } } python_exec_visible_tool = { "type": "function", "function": { "name": "python_exec_visible", "description": "사용자 가시 파이썬 실행(단일 matplotlib 플롯, 색/스타일 지정 금지).", "parameters": { "type": "object", "properties": { "session_id": {"type": "string"}, "code": {"type": "string"}, "timeout_sec": {"type":"integer","minimum":1,"maximum":10,"default":3}, "enforce_plot_rules": {"type":"boolean","default": True} }, "required": ["session_id", "code"], "additionalProperties": False }, "strict": True } } def run_tool_locally(name: str, args: Dict[str, Any]) -&gt; Dict[str, Any]: session_id = args["session_id"] code = args["code"] timeout = int(args.get("timeout_sec", 3)) if name == "python_exec_visible" and args.get("enforce_plot_rules", True): v = _plot_rule_check(code) if v: return {"returncode": 2, "stdout": "", "stderr": v, "artifacts": []} sess = POOL.get(session_id) return sess.execute(code, timeout=timeout) # ========= 모델 라운드트립 ========= def roundtrip(client: OpenAI, user_msg: str, session_id: str): # 1) 첫 호출: 사용자 질문 + 툴 스펙 제공 resp = client.responses.create( model=MODEL, input=[{"role": "user", "content": user_msg}], tools=[python_exec_internal_tool, python_exec_visible_tool], parallel_tool_calls=False ) # 2) tool_call 감지 및 in-process 실행 → 재피드백 messages = [{"role": "user", "content": user_msg}] final_text = None for item in resp.output: if item.type == "message": # 모델이 즉답했다면 그 내용 final_text = item.content[0].text if item.type == "tool_call": name = item.name args = item.arguments result = run_tool_locally(name, args) # 툴 결과를 모델에 다시 넣어 자연어 답변 생성 follow = client.responses.create( model=MODEL, input=messages + [{"role": "tool", "name": name, "content": result}], tools=[python_exec_internal_tool, python_exec_visible_tool], parallel_tool_calls=False ) final_text = follow.output_text break return final_text # ========= 실행 예시 ========= if <strong>name</strong> == "<strong>main</strong>": client = OpenAI() print("예시 1) 내부용 실행: sum(range(10))") msg1 = "sum(range(10))을 내부 실행기로 계산해서 결과만 말해줘." print(roundtrip(client, msg1, session_id="sess-1")) print("\n예시 2) 가시 실행: 간단 플롯 생성") code = """ import matplotlib.pyplot as plt x = [1,2,3,4]; y = [v*v for v in x] plt.figure() plt.plot(x,y) # 색/스타일 지정 금지 plt.title("y = x^2") plt.savefig("/mnt/data/curve.png") print("done") """ msg2 = f"이 코드를 가시 실행기로 돌리고 산출물 경로를 요약해서 알려줘:\n{code}" print(roundtrip(client, msg2, session_id="sess-1"))

</p>

<p>좋아. 커널이 유지되는 네 기존 구조를 살리면서, “읽기는 어디든 가능, 쓰기는 샌드박스 디렉터리로만”을 강제하고, 도커 없이 실행하는 형태로 정리했다. 핵심은 두 겹의 안전장치다.</p>

<ol>
  <li>
    <p>소프트 가드: 커널 내부에서 open/os/pathlib 등을 몽키패치해 쓰기 동작을 샌드박스로만 제한. subprocess/os.system도 막음.</p>
  </li>
  <li>
    <p>하드 가드(선택, Linux): Landlock(커널 LSM) 바인딩으로 프로세스 자체에 “샌드박스 밖 쓰기 금지”를 커널 수준에서 적용. 라이브러리 예: pylandlock. 이건 도커나 외부 프로그램이 아니라 커널 기능을 직접 이용하므로 요구사항과 부합.</p>
  </li>
</ol>

<p>아래 코드는 네가 올린 커널 유지형 설계를 그대로 확장했다. copy_to_sandbox(source, dest_rel) 툴을 추가했고, temp.py 같은 임의 코드가 샌드박스 밖을 쓰려 하면 커널 안에서 PermissionError를 일으키도록 강제했다. 읽기는 어디든 가능하도록 두었다.</p>

<p>코드 그대로 붙여 넣어 실행하면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# coding: utf-8
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">base64</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>

<span class="c1"># ========= 설정 =========
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-5.1</span><span class="sh">"</span><span class="p">)</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">DATA_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/data</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 가시 산출물 저장 용
</span><span class="n">SANDBOX_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 쓰기 허용 디렉터리
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ========= 커널 내 샌드박스 가드 코드 =========
# 쓰기는 SANDBOX_DIR 내부에서만 허용, 읽기는 어디든 허용
</span><span class="n">KERNEL_GUARD_CODE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, builtins, pathlib, subprocess, sys

SANDBOX_DIR = os.environ.get(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="s">)
SANDBOX_DIR = os.path.realpath(SANDBOX_DIR)

_ORIG_OPEN = builtins.open
_ORIG_OS_OPEN = os.open
_ORIG_RENAME = os.rename
_ORIG_REPLACE = os.replace
_ORIG_REMOVE = os.remove
_ORIG_UNLINK = os.unlink
_ORIG_MKDIR = os.mkdir
_ORIG_MAKEDIRS = os.makedirs
_ORIG_RMDIR = os.rmdir
_ORIG_CHMOD = os.chmod

def _real(p): return os.path.realpath(p)
def _in_sb(p):
    rp = _real(p)
    return rp == SANDBOX_DIR or rp.startswith(SANDBOX_DIR + os.sep)

def _open_guard(file, mode=</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">, buffering=-1, encoding=None, errors=None, newline=None, closefd=True, opener=None):
    write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">))
    if write_intent and not _in_sb(file):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_OPEN(file, mode, buffering, encoding, errors, newline, closefd, opener)

def _os_open_guard(file, flags, mode=0o777, *, dir_fd=None):
    write_flags = (flags &amp; (os.O_WRONLY | os.O_RDWR | os.O_CREAT | os.O_TRUNC | os.O_APPEND)) != 0
    if write_flags and not _in_sb(file):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_OS_OPEN(file, flags, mode, dir_fd=dir_fd)

def _rename_guard(src, dst, *a, **k):
    if not (_in_sb(src) and _in_sb(dst)):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rename/replace restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_RENAME(src, dst, *a, **k)

def _replace_guard(src, dst, *a, **k):
    if not (_in_sb(src) and _in_sb(dst)):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rename/replace restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_REPLACE(src, dst, *a, **k)

def _remove_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Deletion restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_REMOVE(path, *a, **k)

def _unlink_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Deletion restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_UNLINK(path, *a, **k)

def _mkdir_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Mkdir restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_MKDIR(path, *a, **k)

def _makedirs_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Makedirs restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_MAKEDIRS(path, *a, **k)

def _rmdir_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rmdir restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_RMDIR(path, *a, **k)

def _chmod_guard(path, mode, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">chmod restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_CHMOD(path, mode, *a, **k)

builtins.open = _open_guard
os.open = _os_open_guard
os.rename = _rename_guard
os.replace = _replace_guard
os.remove = _remove_guard
os.unlink = _unlink_guard
os.mkdir = _mkdir_guard
os.makedirs = _makedirs_guard
os.rmdir = _rmdir_guard
os.chmod = _chmod_guard

import pathlib
_ORIG_PATH_OPEN = pathlib.Path.open
def _path_open_guard(self, *args, **kwargs):
    mode = kwargs.get(</span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">)
    if len(args) &gt;= 1: mode = args[0]
    write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">))
    if write_intent and not _in_sb(str(self)):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_PATH_OPEN(self, *args, **kwargs)
pathlib.Path.open = _path_open_guard

# 차단: 서브프로세스/셸 실행
def _blocked(*a, **k):
    raise PermissionError(</span><span class="sh">"</span><span class="s">Subprocess execution is disabled in sandbox</span><span class="sh">"</span><span class="s">)
subprocess.Popen = _blocked
subprocess.call = _blocked
subprocess.check_call = _blocked
subprocess.check_output = _blocked
os.system = lambda *a, **k: (_ for _ in ()).throw(PermissionError(</span><span class="sh">"</span><span class="s">os.system disabled</span><span class="sh">"</span><span class="s">))

# 리소스 제한 (유닉스만)
try:
    import resource
    resource.setrlimit(resource.RLIMIT_CPU, (3, 3))
    resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024, 1024*1024*1024))  # 1GB
except Exception:
    pass

print(</span><span class="sh">"</span><span class="s">[sandbox-guard] active:</span><span class="sh">"</span><span class="s">, SANDBOX_DIR)
</span><span class="sh">"""</span>

<span class="c1"># ========= 임베디드 커널 실행기 =========
</span><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">stop_channels</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_ensure_guard</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># 샌드박스 디렉터리를 커널 환경에 주입
</span>        <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">] = </span><span class="si">{</span><span class="n">SANDBOX_DIR</span><span class="si">!r}</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">KERNEL_GUARD_CODE</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_exec_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 간단한 정책 필터
</span>        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\bseaborn\b</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Do not use seaborn</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1"># 샌드박스 가드 보장
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_guard</span><span class="p">()</span>

        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[];</span> <span class="n">arts</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_data</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">execute_result</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
                    <span class="kn">import</span> <span class="n">base64</span> <span class="k">as</span> <span class="n">_b64</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">_b64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">plot_</span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s">.png</span><span class="sh">"</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
                    <span class="n">arts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mime</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="n">arts</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">KernelPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">KernelSession</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KernelSession</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="n">POOL</span> <span class="o">=</span> <span class="nc">KernelPool</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\.subplot\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">subplots\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not use subplots</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">(color\s*=|palette\s*=|style\s*=)</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not set explicit colors or styles</span><span class="sh">"</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># ========= 파일 툴: copy_to_sandbox =========
</span><span class="k">def</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">source not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">dest_rel</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">dest_rel</span>
    <span class="c1"># 목적지는 샌드박스 내부로 강제
</span>    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">SANDBOX_DIR</span> <span class="ow">or</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">SANDBOX_DIR</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="c1"># 디렉터리 복사
</span>        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">destination exists: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># 읽기/쓰기 허용 퍼미션 (소유자)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">rel</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">relpath</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">SANDBOX_DIR</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span> <span class="sh">"</span><span class="s">relative_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">rel</span><span class="p">}</span>

<span class="c1"># ========= OpenAI tools 정의 =========
</span><span class="n">python_exec_internal_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_exec_internal</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">내부 분석용 파이썬 실행(사용자에겐 출력 숨김). 세션은 session_id로 유지.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_exec_visible_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">사용자 가시 파이썬 실행(단일 matplotlib 플롯, 색/스타일 지정 금지).</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">copy_to_sandbox_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">호스트의 임의 경로에서 파일/폴더를 샌드박스로 복사. 쓰기 가능한 경로는 샌드박스뿐.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">호스트의 기존 경로</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">dest_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">샌드박스 내부 상대경로</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_exec_internal_tool</span><span class="p">,</span> <span class="n">python_exec_visible_tool</span><span class="p">,</span> <span class="n">copy_to_sandbox_tool</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">run_tool_locally</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">dest_rel</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">session_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

<span class="c1"># ========= 모델 라운드트립 =========
</span><span class="k">def</span> <span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_msg</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">parallel_tool_calls</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_msg</span><span class="p">}]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">output</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">final_text</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">name</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">arguments</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_tool_locally</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">follow</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">messages</span> <span class="o">+</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}],</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
                <span class="n">parallel_tool_calls</span><span class="o">=</span><span class="bp">False</span>
            <span class="p">)</span>
            <span class="n">final_text</span> <span class="o">=</span> <span class="n">follow</span><span class="p">.</span><span class="n">output_text</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># ========= 실행 예시 =========
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">예시 0) 샌드박스에 파일 복사</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">__file__</span>   <span class="c1"># 현재 스크립트를 샌드박스로 복사해보자
</span>    <span class="n">result</span> <span class="o">=</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="sh">"</span><span class="s">example/copied_script.py</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">예시 1) 내부용 실행: sum(range(10))</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">msg1</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sum(range(10))을 내부 실행기로 계산해서 결과만 말해줘.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">msg1</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="sh">"</span><span class="s">sess-1</span><span class="sh">"</span><span class="p">))</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">예시 2) 가시 실행: 간단 플롯 생성 후 산출물 경로 출력</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
import matplotlib.pyplot as plt, os
x = [1,2,3,4]; y = [v*v for v in x]
plt.figure(); plt.plot(x,y); plt.title(</span><span class="sh">"</span><span class="s">y = x^2</span><span class="sh">"</span><span class="s">)
plt.savefig(os.path.join(os.environ.get(</span><span class="sh">"</span><span class="s">DATA_DIR</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">/mnt/data</span><span class="sh">"</span><span class="s">), </span><span class="sh">"</span><span class="s">curve.png</span><span class="sh">"</span><span class="s">))
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">'''</span>
    <span class="n">msg2</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">이 코드를 가시 실행기로 돌리고 산출물 경로를 요약해서 알려줘:</span><span class="se">\\</span><span class="s">n</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">msg2</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="sh">"</span><span class="s">sess-1</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>핵심 포인트를 짚어둔다.</p>

<ol>
  <li>
    <p>커널 지속성 유지<br />
기존과 동일하게 jupyter_client.KernelManager를 사용하되, 세션마다 샌드박스 가드를 한 번만 주입해 유지한다. 타임아웃으로 커널을 kill하면 새 커널에서 가드를 재주입한다.</p>
  </li>
  <li>
    <p>모든 경로 읽기 허용, 쓰기는 샌드박스만<br />
커널 내부에서 open/os.open/pathlib.Path.open/rename/remove 등 쓰기성 작업을 가드한다. 코드를 통한 임의의 파일 쓰기는 샌드박스 밖으로 나갈 수 없다. copy_to_sandbox(source, dest_rel) 툴은 호스트 프로세스에서 안전 검증 후 샌드박스에 복사한다.</p>
  </li>
  <li>
    <p>temp.py가 샌드박스 밖을 만지지 못한다는 보장<br />
소프트 가드만으로도 대부분의 파이썬 레벨 I/O를 막지만, 이론적으로 C 확장/ctypes로 우회할 수 있다. 그래서 리눅스라면 커널 레벨 하드 가드를 추천한다.</p>
  </li>
</ol>

<p>하드 가드 옵션(Linux, 선택 사항, 도커/외부 프로그램 불필요)<br />
Landlock LSM 바인딩(pylandlock 같은 라이브러리)을 사용하면 프로세스가 스스로 “샌드박스 밖 쓰기 금지” 규칙을 커널에 등록할 수 있다. 루트 권한이 필요 없고, 프로세스 자신에게만 적용된다. 적용 지점은 KernelSession 생성 직후다.</p>

<p>개념 코드(실패 시 예외를 무시하고 소프트 가드만 사용):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">apply_landlock_allow_write_only_to_sandbox</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">landlock</span>  <span class="c1"># 또는 pylandlock: 배포판에 따라 패키지명이 다를 수 있음
</span>        <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span><span class="p">,</span> <span class="n">AccessFs</span><span class="p">,</span> <span class="n">PathBeneath</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>
        <span class="c1"># 기본은 아무 쓰기도 불가, 샌드박스만 쓰기 허용
</span>        <span class="n">write_perms</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_FROM</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_TO</span>
        <span class="p">)</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">add_rule</span><span class="p">(</span><span class="nc">PathBeneath</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">write_perms</span><span class="p">))</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">restrict_self</span><span class="p">()</span>  <span class="c1"># 여기서부터 현재 프로세스는 샌드박스 밖 쓰기 불가
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[landlock] active</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[landlock] not available:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<p>이 함수는 KernelManager가 띄우는 커널 프로세스 안이 아니라, 네 런너 프로세스에 적용하는 게 아니라는 점을 잊지 말고, 커널 프로세스에 적용하려면 커널 시작 후 첫 셀로 Landlock 적용 코드를 주입해야 한다. 위 KERNEL_GUARD_CODE 상단에 Landlock 적용 코드를 넣고, 실패해도 계속 진행하도록 구성하면 된다. 커널 버전이 5.13+ 이어야 한다.</p>

<p>추가 하드닝 아이디어<br />
seccomp(pylibseccomp)로 socket/subprocess 관련 시스템콜 자체를 차단해 네트워크/셸을 무력화할 수 있다. 네트워크 차단이 필요하면 이걸 병행하자.</p>

<p>주의점<br />
읽기를 어디든 허용하면 민감한 키/토큰 파일(예: ~/.ssh, .env)도 읽힐 수 있다. 운영 시엔 copy_to_sandbox로 읽기 허용 목록을 좁히거나, 가드 코드에 “읽기 허용 경로 allowlist”를 추가하는 게 안전하다.</p>

<p>이제 네 스택(vLLM + Qwen/GPTOSS + OpenAI Agents SDK)에 그대로 접목하면 된다. 모델에게는 다음 세 가지 툴을 노출한다.</p>

<ol>
  <li>
    <p>copy_to_sandbox(source, dest_rel?)</p>
  </li>
  <li>
    <p>python_exec_internal(session_id, code, …)</p>
  </li>
  <li>
    <p>python_exec_visible(session_id, code, …)</p>
  </li>
</ol>

<p>실행 동선은 간단하다. 모델이 파일이 필요하면 copy_to_sandbox를 먼저 부르고, 그 다음 실행 툴로 샌드박스 내부 경로만 쓰게 된다. 이렇게 하면 커널을 유지하면서도 파일 안전성이 보장된다.</p>

<p>원하면 Landlock 주입까지 포함한 버전으로 리팩터링해 줄게.</p>

<p class="chat--user">

이런 일을 하는 파이썬 패키지가 있을 법 한데 찾아보고 알려주라

</p>

<p>짧은 결론부터 말할게. 순수 파이썬만으로 “진짜” 안전한 샌드박스를 만드는 건 여러 차례 실패했고, 현재도 권장되지 않는다. 대신 리눅스 커널 기능을 노출한 파이썬 패키지를 조합하면 도커 없이도 “샌드박스 밖 쓰기 금지”를 꽤 단단하게 만들 수 있다. 대표 조합은 Landlock(+선택적으로 seccomp)이다. <a href="https://lwn.net/Articles/574323/?utm_source=chatgpt.com">LWN.net</a></p>

<p>다음이 지금 목적(커널 유지, 어디든 읽기 가능·쓰기만 샌드박스)과 잘 맞는 패키지들이야.</p>

<ol>
  <li>커널 레벨 격리(도커 없이 강력·권장)</li>
</ol>

<ul>
  <li>
    <p>landlock: 리눅스 5.13+에서 프로세스가 “이 디렉터리만 쓰기 허용” 같은 규칙을 스스로 걸 수 있게 해주는 LSM 바인딩. 한 줄 요약: 커널이 파일 쓰기를 차단하므로 temp.py가 밖으로 나가서 write/rename/delete를 하려 해도 거기서 막힌다. 세션 커널을 유지한 채, 커널 시작 직후 규칙을 적용하면 된다. <a href="https://pypi.org/project/landlock/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
  <li>
    <p>pyseccomp / python3-seccomp: libseccomp 바인딩. execve/fork/socket 같은 시스템콜을 막아 서브프로세스 실행이나 네트워크 등 “탈출 루트”를 추가로 봉쇄할 수 있다. Landlock과 병행하면 효과가 좋다. <a href="https://pypi.org/project/pyseccomp/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
</ul>

<ol>
  <li>운영체제 프로파일 기반(환경 의존·설정 필요)</li>
</ol>

<ul>
  <li>edx-codejail: “파이썬 코드 감옥”을 관리하는 패키지. 보안은 AppArmor 프로파일로 강제한다. 즉 패키지는 파이썬이지만, 커널의 AppArmor 설정이 제대로 있어야 보호가 된다. 도커는 필요 없지만 시스템 설정은 필요. <a href="https://pypi.org/project/edx-codejail/?utm_source=chatgpt.com">PyPI</a></li>
</ul>

<ol>
  <li>대안 런타임(아키텍처를 바꿔서 샌드박스)</li>
</ol>

<ul>
  <li>WebAssembly 런타임을 파이썬에서 직접 쓰기: wasmer-python/wasmtime-py로 WASI 환경에서 CPython/py2wasm 등을 돌리면 기본이 “허용 안 함”이라 파일·네트워크 접근이 명시적으로 열어주기 전까지 막힌다. 세션형 유지도 구현 가능. 다만 네이티브 확장 모듈(예: numpy) 호환성은 전략이 필요하다. <a href="https://github.com/wasmerio/wasmer-python?utm_source=chatgpt.com">GitHub</a></li>
</ul>

<p>보조(단독 사용 비권장, 하지만 레이어로 유용)</p>

<ul>
  <li>
    <p>RestrictedPython: 언어 기능을 제한하는 도구(문법/바이트코드 레벨)라 OS 파일 시스템을 가두는 건 아니다. Landlock/seccomp 위에서 “추가 울타리”로 쓰면 좋다. <a href="https://restrictedpython.readthedocs.io/?utm_source=chatgpt.com">restrictedpython.readthedocs.io</a></p>
  </li>
  <li>
    <p>pyfakefs: 테스트용 가짜 파일시스템. 실제 디스크를 만지지 않게 만들 수 있지만 “보안 격리”는 아니다. 주 목적은 회귀 방지/테스트 안정성.</p>
  </li>
</ul>

<p>추천 설계(너의 커널 유지 구조에 바로 얹기)</p>

<ol>
  <li>
    <p>커널 시작 직후 첫 셀에서 Landlock을 적용해 “SANDBOX_DIR만 쓰기 허용” 규칙을 건다.</p>
  </li>
  <li>
    <p>seccomp로 execve/fork/socket 등을 막는다(선택).</p>
  </li>
  <li>
    <p>LLM이 외부 파일을 쓰고 싶다면 반드시 copy_to_sandbox(source, dest_rel) 툴을 호출하도록 에이전트 정책을 강제한다.</p>
  </li>
  <li>
    <p>파이썬 단의 몽키패치(open/rename/remove 등)는 여전히 유용한 소프트 가드지만, 진짜 방어선은 커널(Landlock/seccomp)이 맡는다.</p>
  </li>
</ol>

<p>Landlock 간단 예시(아이디어 스케치)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install landlock  (리눅스 5.13+ 필요)
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span><span class="p">,</span> <span class="n">AccessFs</span><span class="p">,</span> <span class="n">PathBeneath</span>

<span class="n">SANDBOX_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 1) 규칙 모음 생성: 기본은 쓰기 불가, 특정 디렉터리만 쓰기 허용
</span><span class="n">rules</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>
<span class="n">write_perms</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_FROM</span> <span class="o">|</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_TO</span>
<span class="p">)</span>
<span class="n">rules</span><span class="p">.</span><span class="nf">add_rule</span><span class="p">(</span><span class="nc">PathBeneath</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">write_perms</span><span class="p">))</span>

<span class="c1"># 2) 현재 프로세스(= 네가 유지하는 Jupyter 커널)에 적용
</span><span class="n">rules</span><span class="p">.</span><span class="nf">restrict_self</span><span class="p">()</span>

<span class="c1"># 이제부터 이 프로세스와 자식은 SANDBOX_DIR 밖으로의 쓰기가 커널에서 거부됨
</span></code></pre></div></div>

<p>참고로 execve/fork/socket도 막고 싶다면, 커널 시작 직후 seccomp 필터를 같이 로드하면 된다(예: execve/execveat/fork/vfork/sys_socket 차단). <a href="https://pypi.org/project/pyseccomp/?utm_source=chatgpt.com">PyPI</a></p>

<p>정리하면 이렇게 골라 쓰면 된다.</p>

<ul>
  <li>
    <p>“도커 없이, 파일 쓰기만 샌드박스로”: landlock 필수, 필요 시 seccomp 추가. <a href="https://pypi.org/project/landlock/?utm_source=chatgpt.com">PyPI+1</a></p>
  </li>
  <li>
    <p>“시스템 프로파일을 써도 괜찮다”: codejail(AppArmor)로 관리. <a href="https://pypi.org/project/edx-codejail/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
  <li>
    <p>“아예 다른 런타임에 가둔다”: wasmer-python/wasmtime-py 기반 WASM 샌드박스. <a href="https://github.com/wasmerio/wasmer-python?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p>“순수 파이썬 샌드박스만으로는 위험”: 과거 시도가 ‘설계상 취약’으로 결론 났다. 커널/런타임 레벨 방어를 반드시 곁들여라. <a href="https://lwn.net/Articles/574323/?utm_source=chatgpt.com">LWN.net</a></p>
  </li>
</ul>

<p>원하면 네가 어제 주신 커널-세션 구조에 Landlock+seccomp를 정확히 주입한 버전(툴 호출과 연동까지)로 리라이팅해서 전달하겠다.</p>

<p class="chat--user">

그렇게 까지 완벽한 샌드박스는 필요없어

</p>

<p>좋아. “완벽하지 않아도 되는” 현실적 80/20 해법으로 정리해 줄게. 핵심은 커널은 계속 유지하면서, 실수로 호스트를 더럽히는 걸 막는 3중 완충장치다.</p>

<ol>
  <li>
    <p>커널 시작 직후 한 번만 주입하는 audit hook으로 쓰기/서브프로세스/네트워크를 가볍게 차단</p>
  </li>
  <li>
    <p>필요한 파일은 copy_to_sandbox(source, dest_rel)로 복사해 샌드박스 안에서만 다룸</p>
  </li>
  <li>
    <p>CPU/메모리/파일사이즈 같은 리소스 제한으로 폭주 방지</p>
  </li>
</ol>

<p>이 조합은 “강철 감옥”은 아니지만, 실무에서 발생하는 대부분의 실수성 파괴를 확실히 걸러준다. 그리고 도커도 필요 없다.</p>

<p>아래는 네가 준 커널-세션 코드에 딱 필요한 만큼만 추가/교체하는 스니펫이다.</p>

<ol>
  <li>커널에 주입할 가벼운 가드 코드(sys.addaudithook 기반)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 커널에 인젝션할 코드: AUDIT_GUARD_CODE
</span><span class="n">AUDIT_GUARD_CODE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys
SANDBOX_DIR = os.path.realpath(os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">))
os.makedirs(SANDBOX_DIR, exist_ok=True)

def _in_sb(p):
    rp = os.path.realpath(p)
    return rp == SANDBOX_DIR or rp.startswith(SANDBOX_DIR + os.sep)

def _audit(event, args):
    # 파일 쓰기 시도 차단: open 및 os.open은 </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s"> 이벤트로 들어옴
    if event == </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">:
        path = str(args[0])
        mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="s">
        flags = int(args[2]) if len(args) &gt; 2 else 0
        write_intent = any(ch in mode for ch in (</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="s">)) or (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
        if write_intent and not _in_sb(path):
            raise PermissionError(f</span><span class="sh">'</span><span class="s">Writes are restricted to {SANDBOX_DIR}: {path}</span><span class="sh">'</span><span class="s">)
    # 서브프로세스/셸 차단
    elif event.startswith(</span><span class="sh">'</span><span class="s">subprocess.</span><span class="sh">'</span><span class="s">):
        raise PermissionError(</span><span class="sh">'</span><span class="s">Subprocess disabled in this session</span><span class="sh">'</span><span class="s">)
    elif event == </span><span class="sh">'</span><span class="s">os.system</span><span class="sh">'</span><span class="s">:
        raise PermissionError(</span><span class="sh">'</span><span class="s">os.system disabled in this session</span><span class="sh">'</span><span class="s">)
    # 네트워크 차단(원하면 주석 해제)
    elif event.startswith(</span><span class="sh">'</span><span class="s">socket.</span><span class="sh">'</span><span class="s">):
        raise PermissionError(</span><span class="sh">'</span><span class="s">Network disabled in this session</span><span class="sh">'</span><span class="s">)

sys.addaudithook(_audit)

# 가벼운 한도 설정(유닉스 계열에서만 작동)
try:
    import resource
    resource.setrlimit(resource.RLIMIT_CPU, (3, 3))             # CPU 3초
    resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024,)*2) # 1GB 메모리
    resource.setrlimit(resource.RLIMIT_FSIZE, (200*1024*1024,)*2) # 파일 최대 200MB
    resource.setrlimit(resource.RLIMIT_NOFILE, (256, 256))
except Exception:
    pass

print(</span><span class="sh">'</span><span class="s">[audit-guard] active for sandbox:</span><span class="sh">'</span><span class="s">, SANDBOX_DIR)
</span><span class="sh">"""</span>
</code></pre></div></div>

<ol>
  <li>KernelSession에 가드 주입 한 번만 실행하도록 보강</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_ensure_guard</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">] = </span><span class="si">{</span><span class="n">SANDBOX_DIR</span><span class="si">!r}</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">AUDIT_GUARD_CODE</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<ol>
  <li>copy_to_sandbox(source, dest_rel) 툴(간결판)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">source not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dest_rel</span> <span class="k">else</span> <span class="n">dest_rel</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">SANDBOX_DIR</span> <span class="ow">or</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">SANDBOX_DIR</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">destination exists: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>실행기에서 가드 보장 후 코드 수행</li>
</ol>

<p>네가 이미 가진 <code class="language-plaintext highlighter-rouge">KernelSession.execute()</code> 앞부분에 <code class="language-plaintext highlighter-rouge">_ensure_guard()</code> 한 줄만 추가하면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_guard</span><span class="p">()</span>  <span class="c1"># 가드가 주입되지 않았다면 지금 주입
</span>    <span class="c1"># 이하 기존 로직 그대로
</span></code></pre></div></div>

<p>이렇게 하면 다음이 자연스럽게 충족된다.</p>

<ul>
  <li>
    <p>어디든 읽기 가능</p>
  </li>
  <li>
    <p>쓰기는 샌드박스 디렉토리 안에서만 가능</p>
  </li>
  <li>
    <p>temp.py 같은 임의 코드가 /etc, ~, /var 등에 쓰려고 하면 audit hook에서 즉시 PermissionError</p>
  </li>
  <li>
    <p>서브프로세스/네트워크는 기본 차단(옵션)</p>
  </li>
  <li>
    <p>커널은 세션 단위로 계속 유지</p>
  </li>
</ul>

<p>운영 팁 몇 가지만 덧붙인다.</p>

<ul>
  <li>
    <p>민감 경로 읽기까지 허용하면 의도치 않게 비밀 토큰을 읽을 수 있다. 필요하면 audit hook에서 읽기 허용 경로도 allowlist로 좁혀라.</p>
  </li>
  <li>
    <p>Windows에서는 resource 제한이 제한적이다. 그래도 audit hook은 동작하니 파일 쓰기/서브프로세스 차단엔 유용하다.</p>
  </li>
  <li>
    <p>CPython 3.8+에서 audit hook이 지원된다. 그 아래 버전은 이 방식이 안 된다.</p>
  </li>
  <li>
    <p>numpy/pandas/matplotlib 같은 일반 과학 스택은 그대로 사용 가능하다. 네가 잡아 둔 “단일 플롯·색상 지정 금지” 정책은 기존 검사로 유지하면 된다.</p>
  </li>
</ul>

<p>이 정도면 “완벽한 감옥”은 아니지만, 실무에서 실수성 파괴를 거의 없애면서 커널 지속성과 개발 편의성을 그대로 가져갈 수 있다. 다음으로 vLLM + Agents SDK에 노출할 툴 스펙을 정리해주길 원하면 그 부분도 바로 이어서 만들어 줄게.</p>

<p class="chat--user">

landlock을 읽기 가능 폴더 따로 쓰기 가능 폴더 따로 지정가능해?

</p>

<p>가능해. Landlock는 “경로별 권한 비트마스크”를 줘서 읽기 전용 디렉터리와 쓰기 허용 디렉터리를 각각 따로 지정할 수 있어. 방법의 뼈대는 이렇다.</p>

<ol>
  <li>
    <p>ruleset을 만들 때 읽기와 쓰기에 해당하는 모든 권한을 handled_access_fs에 포함한다. 예시로 문서에 나오는 READ_FILE, READ_DIR, WRITE_FILE, MAKE__(파일/디렉터리 생성), REMOVE__(삭제), TRUNCATE(ABI v3+), REFER(디렉터리 간 이동/링크, ABI v2+) 등을 묶는다. 이렇게 해야 “명시한 권한만 허용, 나머지는 거부”가 제대로 작동한다. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서</a></p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>읽기 전용 디렉터리 규칙을 추가한다. 해당 경로에 대해 allowed_access를 READ_FILE</td>
          <td>READ_DIR(필요하면 EXECUTE) 정도만 주는 PathBeneath 규칙을 ruleset에 넣는다. 커널 문서 예제도 /usr를 이런 식으로 “읽기만 허용”으로 추가한다. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서+1</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>쓰기 허용 디렉터리 규칙을 별도로 추가한다. 보통은 READ_DIR(경로 탐색/목록), WRITE_FILE, MAKE_REG/MAKE_DIR, REMOVE_FILE/REMOVE_DIR, TRUNCATE(ABI v3+)를 묶고, 디렉터리 간 rename/link가 필요하면 REFER(ABI v2+)까지 포함한다. 그런 다음 landlock_restrict_self로 현재 스레드(→ 자식 프로세스 포함)에 적용한다. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서+1</a></li>
</ol>

<p>팁과 주의점</p>

<ul>
  <li>
    <p>“진짜” 의미의 write-only 디렉터리를 만들고 싶더라도, 파일을 만들거나 열려면 최소한 디렉터리 탐색을 위한 READ_DIR 권한이 필요해지는 경우가 많다. 커널 문서도 실전에서는 읽기/쓰기 권한을 디렉터리 단위로 깨끗하게 분리해 두는 것을 권장한다(예: ~/doc은 read-only, ~/tmp는 read-write). <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서</a></p>
  </li>
  <li>
    <p>TRUNCATE는 ABI v3(리눅스 6.2)부터 제어 가능, REFER는 ABI v2(리눅스 5.19)부터. 실행 환경의 Landlock ABI 버전을 조회해 가용 권한만 쓰도록 하는 “베스트 에포트” 패턴이 공식 예제에 있다. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel 문서+1</a></p>
  </li>
  <li>
    <p>파이썬에서 쓰려면 C syscalls를 직접 호출해도 되고, PyPI의 landlock 바인딩을 사용할 수 있다. 이 패키지는 파이썬에서 ruleset을 만들고 경로를 허용 목록으로 추가한 뒤 apply()로 적용하는 흐름을 제공한다(세부 권한 플래그는 버전에 따라 다름). <a href="https://pypi.org/project/landlock/">PyPI+1</a></p>
  </li>
</ul>

<p>요약하면, 하나의 ruleset 안에 “읽기 전용 A 디렉터리용 규칙”과 “쓰기 허용 B 디렉터리용 규칙”을 각각 추가하면 된다. 원하면 네 커널-세션 구조에 맞춰서, A는 READ_FILE/READ_DIR만, B는 READ_DIR+WRITE_FILE+MAKE__/REMOVE__ +TRUNCATE(+REFER 선택)로 묶은 최소 예제 코드를 바로 맞춰 드릴게.</p>

<p class="chat--user">

근데 룰셋을 파이썬 코드가 풀어버릴수도잇지않나

</p>

<p>짧게 답하면 “정상 동작하는 Landlock에 한해선, 파이썬 코드가 룰을 ‘풀어버리는’ 건 불가능”이 맞다. Landlock는 커널이 강제하는 일방향(one-way) 제약이라, 한 번 <code class="language-plaintext highlighter-rouge">landlock_restrict_self()</code>로 적용하면 해제·완화가 안 되고 더 좁히는 것만 가능하다. 그리고 새로 생성되는 자식 프로세스들은 그 제약을 그대로 상속받는다. 형제 스레드에는 자동 전파가 안 되므로, 스레드가 생기기 전에 적용하거나 각 스레드에서 적용해야 한다. <a href="https://landlock.io/talks/2025-01-29_landlock-workshop.pdf?utm_source=chatgpt.com">landlock.io+1</a></p>

<p>현실적인 예외·주의점도 있다.</p>

<ol>
  <li>
    <p>2024년에 “제약을 잃어버릴 수 있는” 커널 버그가 있었다(CVE-2024-42318). 특수한 <code class="language-plaintext highlighter-rouge">keyctl(KEYCTL_SESSION_TO_PARENT)</code> 경로에서 Landlock 정보가 사라지는 문제였고, 커널 측에서 <code class="language-plaintext highlighter-rouge">cred_transfer</code> 훅을 추가하는 방식으로 수정됐다. 메인라인에 머지되었고 각 안정화 브랜치로 백포트됐다. 배포판 커널이 이 수정이 포함된 버전이면, 사용자 공간 코드가 Landlock을 해제하는 우회는 더 이상 통하지 않는다. 환경 점검만 해두면 된다. <a href="https://nvd.nist.gov/vuln/detail/cve-2024-42318?utm_source=chatgpt.com">NVD+1</a></p>
  </li>
  <li>
    <p>제약은 “그 시점 이후의 접근”에 적용된다. 제약을 걸기 전에 이미 쓰기 권한으로 연 열린 파일 디스크립터가 있다면 그 FD를 통해서는 계속 쓸 수 있다. 따라서 커널(또는 커널 프로세스) 시작 직후, 사용자 코드가 돌기 전에 바로 제한을 걸고, 미리 열린 불필요한 FD를 닫는 게 안전하다. 이건 Landlock의 설계 철학(누적·일방향)과 동일한 주의점이다. <a href="https://docs.kernel.org/userspace-api/landlock.html?utm_source=chatgpt.com">Kernel 문서</a></p>
  </li>
</ol>

<p>정리하면 다음처럼 운용하면 된다.</p>

<p>• “풀 수 없다”는 보장은 커널이 준다. 사용자 파이썬이 <code class="language-plaintext highlighter-rouge">ctypes</code>·<code class="language-plaintext highlighter-rouge">os</code>·<code class="language-plaintext highlighter-rouge">subprocess</code>로 발버둥쳐도 Landlock 자체를 해제하진 못한다. 제약은 누적만 된다. <a href="https://landlock.io/talks/2025-01-29_landlock-workshop.pdf?utm_source=chatgpt.com">landlock.io</a><br />
• 단, 커널이 CVE-2024-42318 수정분을 포함해야 한다. 2024-07 말에 메인라인에 들어갔고 배포판 커널에도 반영됐다. 운영 환경의 커널 업데이트 여부를 확인하자. <a href="https://nvd.nist.gov/vuln/detail/cve-2024-42318?utm_source=chatgpt.com">NVD+1</a><br />
• 스레드/프로세스 모델을 기억하자. 현재 스레드에 적용하면 자식에는 상속되지만, 이미 떠 있는 다른 스레드엔 자동 적용 안 된다. 커널 프로세스 초기화 직후 제일 먼저 제한을 건다. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org</a></p>

<p>덧붙여, 읽기 전용 폴더와 쓰기 허용 폴더를 각각 따로 주는 것도 한 ruleset 안에서 규칙 두 개로 충분하며, 필요 권한 비트(READ_FILE/READ_DIR… vs WRITE_FILE/MAKE_DIR/REMOVE_* 등)를 분리해 주면 된다. ABI 버전에 따라 TRUNCATE/REFER 같은 권한 가용성이 달라지니 “best-effort” 방식으로 감지해 쓰면 호환성이 좋다. <a href="https://docs.kernel.org/userspace-api/landlock.html?utm_source=chatgpt.com">Kernel 문서</a></p>

<p>이 상태에서 네 커널-세션 구조 위에 얹으면, 파이썬 쪽 몽키패치나 audit hook은 “소프트 가드”로 편의와 메시지 품질을 올려주고, Landlock이 “하드 가드”로 바닥을 받쳐준다. 다음 단계로 커널 첫 셀에서 Landlock을 적용하는 최소 샘플을 붙여줄 수 있다.</p>

<p class="chat--user">

아하 다시 한 번 깔끔하게 정리해보자. 파이썬 실행 툴을 LLM이 쓸 수 있도록 만들 것 툴 Config 단계 -&gt; LLM에게 툴 사용 법 전달하는 단계 -&gt; 실제로 사용하는 단계 이렇게 3단계를 나눠서 생각하자. 요구 사항 1. 툴 Config 단계에서 landlock으로 WRITE/READ 가 가능한 폴더, READ만 가능한 폴더를 지정해둔다. (하위 폴더까지 포함) 2. 세션은 jupyter client 든 뭐든 유지한다(jupyter client 말고 다른 적절한 방법이 있으면 그걸 사용할 것). 각 에이전트별 세션을 유지한다. 이 때 세션에 대한 id 같은걸 같이 받는 방법이 있을 듯. 3. 실제로 사용할 때는 (1) 세션을 유지할지 말지, (2) 일회용 코드 실행할지 선택할 수도 있을 것 같네. 설계 잘 해줘.

</p>

<p>좋아, 3단계 흐름에 딱 맞춰 설계와 최소 구현 스케치를 정리한다. 목표는 LLM이 파이썬을 실행하되, 설정 단계에서 읽기/쓰기 폴더 정책을 정하고, 세션을 필요에 따라 유지하거나 1회성으로 쓰는 것.</p>

<h1 id="0-전체-구조-한눈에">0. 전체 구조 한눈에</h1>

<ul>
  <li>
    <p>PythonExecManager: 툴 진입점. 정책(랜드락), 세션 생성/해제, 실행을 관리.</p>
  </li>
  <li>
    <p>두 가지 실행 백엔드 중 선택</p>

    <ul>
      <li>
        <p>KernelBackend: Jupyter 커널을 세션 단위로 유지. 첫 셀에서 Landlock + 가벼운 가드 주입.</p>
      </li>
      <li>
        <p>SubprocessBackend: 가벼운 1회성 혹은 유지형 서브프로세스(JSON-RPC) 백엔드.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>툴 세트</p>

    <ul>
      <li>
        <p>configure_python_exec(readwrite_dirs, readonly_dirs)</p>
      </li>
      <li>
        <p>start_python_session(agent_id, backend, keep_alive, idle_timeout_sec)</p>
      </li>
      <li>
        <p>python_execute(code, session_id?, backend?, ephemeral?)</p>
      </li>
      <li>
        <p>copy_to_sandbox(source, dest_rel?)</p>
      </li>
    </ul>
  </li>
</ul>

<h1 id="1단계-툴-config-단계">1단계. 툴 Config 단계</h1>

<p>요구사항: 이 단계에서 Landlock으로 “쓰기 가능 폴더”와 “읽기 전용 폴더”를 지정해둔다. 실제 Landlock 적용은 각 세션 프로세스가 뜨고 사용자 코드가 돌기 전에 수행된다.</p>

<p>기능 요약</p>

<ul>
  <li>
    <p>읽기 전용 디렉터리: READ_FILE/READ_DIR(+EXECUTE 선택)만 허용.</p>
  </li>
  <li>
    <p>쓰기 가능 디렉터리: READ_DIR + WRITE_FILE + MAKE_* + REMOVE_* (+TRUNCATE/REFER은 ABI 지원 시) 허용.</p>
  </li>
  <li>
    <p>Linux가 아니거나 Landlock 미탑재면 소프트 가드(audit hook)만 켠다.</p>
  </li>
</ul>

<p>툴 스펙(LLM에 등록할 JSON, OpenAI Agents SDK/Function calling 양식 예)</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"configure_python_exec"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"샌드박스 정책을 설정한다. 읽기/쓰기 폴더를 지정하고 이후 세션에 적용된다."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"readwrite_dirs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"readonly_dirs"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"sandbox_dir"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"쓰기 기본 루트(샌드박스). 생략 시 내부 기본값 사용"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"readwrite_dirs"</span><span class="p">,</span><span class="w"> </span><span class="s2">"readonly_dirs"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>파이썬 최소 구현(정책 저장만, 실제 적용은 세션이 켜질 때)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SandboxPolicy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ro</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sandbox_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">readwrite_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rw</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">readonly_dirs</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sandbox_dir</span>    <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">sandbox_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">sandbox_dir</span> <span class="k">else</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">PythonExecManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="sh">"</span><span class="s">BaseSession</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ro</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sandbox_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">sandbox_dir</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="nc">SandboxPolicy</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">ro</span><span class="p">,</span> <span class="n">sandbox_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">}</span>
</code></pre></div></div>

<h1 id="2단계-llm에게-툴-사용법-전달-단계">2단계. “LLM에게 툴 사용법” 전달 단계</h1>

<p>시스템/개발자 지침에 넣을 핵심 규칙</p>

<ul>
  <li>
    <p>파일을 쓰거나 생성하려면 먼저 copy_to_sandbox를 호출해 샌드박스 안으로 가져올 것.</p>
  </li>
  <li>
    <p>세션이 필요하면 start_python_session을 먼저 호출하고 반환된 session_id를 python_execute에 넘겨라.</p>
  </li>
  <li>
    <p>1회성 실행은 session_id 없이 python_execute(ephemeral=true, backend=…)로 호출해라.</p>
  </li>
  <li>
    <p>경로를 제시할 때는 샌드박스 내부 경로를 우선 사용해라. 쓰기 시도는 샌드박스 밖에서 실패한다.</p>
  </li>
</ul>

<p>LLM용 툴 스펙</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"start_python_session"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"파이썬 실행 세션을 연다(커널 또는 서브프로세스 백엔드)."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"agent_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"에이전트/스레드 식별자"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"backend"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"kernel"</span><span class="p">,</span><span class="w"> </span><span class="s2">"subprocess"</span><span class="p">],</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kernel"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"keep_alive"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"idle_timeout_sec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"agent_id"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python_execute"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"파이썬 코드를 실행한다. 세션 유지 또는 1회성(ephemeral) 실행 모두 지원."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"유지형 세션 실행 시 필요"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"backend"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"kernel"</span><span class="p">,</span><span class="w"> </span><span class="s2">"subprocess"</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"ephemeral"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"timeout_sec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"visible_mode"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"code"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"copy_to_sandbox"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"호스트 경로에서 파일/폴더를 샌드박스로 복사한다."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"dest_rel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"샌드박스 내부 상대경로"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"source"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>LLM에게 주는 간단 지침 텍스트</p>

<ul>
  <li>
    <p>분석에 쓸 파일은 먼저 copy_to_sandbox로 가져와라.</p>
  </li>
  <li>
    <p>플롯/파일 저장은 항상 ${SANDBOX_DIR} 안으로 저장하라.</p>
  </li>
  <li>
    <p>여러 번 실행·상태 유지가 필요하면 start_python_session → python_execute(session_id=…).</p>
  </li>
  <li>
    <p>한 번만 돌릴 거면 python_execute(ephemeral=true, backend="subprocess")로 호출하라.</p>
  </li>
</ul>

<h1 id="3단계-실제-사용-단계-설계">3단계. 실제 사용 단계 설계</h1>

<p>A. 유지형 세션 흐름(예: 에이전트별 상태 유지)</p>

<ol>
  <li>
    <p>configure_python_exec 호출로 정책 등록</p>
  </li>
  <li>
    <p>start_python_session(agent_id="agent-A", backend="kernel", keep_alive=true)</p>
  </li>
  <li>
    <p>copy_to_sandbox 필요 시 호출</p>
  </li>
  <li>
    <p>python_execute(session_id=…, code=…)</p>
  </li>
  <li>
    <p>필요 시 같은 session_id로 연속 실행</p>
  </li>
  <li>
    <p>아이들 타임아웃 초과 시 세션 자동 종료</p>
  </li>
</ol>

<p>B. 1회성 실행 흐름</p>

<ol>
  <li>
    <p>configure_python_exec 호출(앱 시작 시 1회 해도 됨)</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code=…)</p>
  </li>
</ol>

<p>이원화 이유</p>

<ul>
  <li>
    <p>kernel은 풍부한 과학 스택/상태 유지에 강함</p>
  </li>
  <li>
    <p>subprocess는 기동이 빠르고, 일회성 코드에 적합</p>
  </li>
</ul>

<h1 id="세션-백엔드-구현-핵심">세션 백엔드 구현 핵심</h1>

<p>Landlock 적용 전략</p>

<ul>
  <li>
    <p>실제 제약은 “각 세션 프로세스 내부”에서 걸어야 한다.</p>
  </li>
  <li>
    <p>KernelBackend: 커널 시작 후 첫 실행 셀에서 Landlock을 적용하고, 이어서 audit hook(소프트 가드)도 주입.</p>
  </li>
  <li>
    <p>SubprocessBackend: 자식 프로세스가 뜨자마자 Landlock을 restrict_self()로 적용한 후 JSON-RPC 루프 진입.</p>
  </li>
</ul>

<p>권한 마스크 구성(ABI 차이 안전 처리)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_access_mask</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">landlock</span>
    <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">AccessFs</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">READ_DIR</span>
    <span class="c1"># 읽기/실행 필요 시
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">|=</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">EXECUTE</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">acc</span>

<span class="k">def</span> <span class="nf">build_write_mask</span><span class="p">():</span>
    <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">AccessFs</span>
    <span class="n">perms</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># ABI v2+: REFER, v3+: TRUNCATE 등은 있으면 추가
</span>    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># 디렉터리 트래버스 허용
</span>    <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></div>

<p>KernelBackend 초기화 코드 스케치</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AUDIT_GUARD</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys
SBOX = os.path.realpath(os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">))
os.makedirs(SBOX, exist_ok=True)
def _in_sb(p): import os; rp=os.path.realpath(p); return rp==SBOX or rp.startswith(SBOX+os.sep)
def _audit(ev, args):
    if ev == </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">:
        path = str(args[0]); mode = str(args[1]) if len(args)&gt;1 else </span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="s">
        flags = int(args[2]) if len(args)&gt;2 else 0
        wr = any(ch in mode for ch in (</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="s">)) or (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
        if wr and not _in_sb(path): raise PermissionError(f</span><span class="sh">'</span><span class="s">Writes restricted to {SBOX}: {path}</span><span class="sh">'</span><span class="s">)
    elif ev.startswith(</span><span class="sh">'</span><span class="s">subprocess.</span><span class="sh">'</span><span class="s">) or ev==</span><span class="sh">'</span><span class="s">os.system</span><span class="sh">'</span><span class="s">: raise PermissionError(</span><span class="sh">'</span><span class="s">Subprocess disabled</span><span class="sh">'</span><span class="s">)
sys.addaudithook(_audit)
</span><span class="sh">"""</span>

<span class="n">LANDLOCK_INIT</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os
SANDBOX_DIR = os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">)
try:
    import landlock
    from landlock import Ruleset, PathBeneath
    from landlock import AccessFs as A
    rw_dirs = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">) else []
    ro_dirs = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">) else []
    handled = 0
    for name in dir(A):
        if name.isupper():
            handled |= getattr(A, name)
    rs = Ruleset(handled_access_fs=handled)
    write_mask = 0
    for n in (</span><span class="sh">'</span><span class="s">WRITE_FILE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REMOVE_FILE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REMOVE_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_REG</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_SYM</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REFER</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">TRUNCATE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">):
        write_mask |= getattr(A, n, 0)
    read_mask = getattr(A,</span><span class="sh">'</span><span class="s">READ_FILE</span><span class="sh">'</span><span class="s">,0) | getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0) | getattr(A,</span><span class="sh">'</span><span class="s">EXECUTE</span><span class="sh">'</span><span class="s">,0)
    for d in ro_dirs:
        if d: rs.add_rule(PathBeneath(d, read_mask))
    for d in rw_dirs + [SANDBOX_DIR]:
        if d: rs.add_rule(PathBeneath(d, write_mask | read_mask))
    rs.restrict_self()
    print(</span><span class="sh">'</span><span class="s">[landlock] active</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">'</span><span class="s">[landlock] unavailable:</span><span class="sh">'</span><span class="s">, e)
</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">KernelBackendSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="c1"># 정책 전달 및 초기 가드/랜드락 주입
</span>        <span class="n">env</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="si">!r}</span><span class="s">;</span><span class="sh">"</span> \
              <span class="sa">f</span><span class="sh">"</span><span class="s">os.environ[</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">readwrite_dirs</span><span class="p">)</span><span class="si">!r}</span><span class="s">;</span><span class="sh">"</span> \
              <span class="sa">f</span><span class="sh">"</span><span class="s">os.environ[</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">readonly_dirs</span><span class="p">)</span><span class="si">!r}</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_exec</span><span class="p">(</span><span class="n">env</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">LANDLOCK_INIT</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">AUDIT_GUARD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_exec</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># … (iopub 수집/timeout 처리는 생략)
</span></code></pre></div></div>

<p>SubprocessBackend 초기화 코드 스케치</p>

<ul>
  <li>자식이 부팅하자마자 Landlock 적용 후 stdin으로 들어오는 JSON 명령을 실행</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SUBPROCESS_BOOT</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import sys, os, json
SANDBOX_DIR = os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">)
def apply_ll():
    try:
        import landlock
        from landlock import Ruleset, PathBeneath
        from landlock import AccessFs as A
        handled = 0
        for n in dir(A):
            if n.isupper(): handled |= getattr(A,n)
        rs = Ruleset(handled_access_fs=handled)
        rw = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">) else []
        ro = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">) else []
        wm = getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">WRITE_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">MAKE_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">MAKE_REG</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REMOVE_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REMOVE_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REFER</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">TRUNCATE</span><span class="sh">'</span><span class="s">,0)
        rm = getattr(A,</span><span class="sh">'</span><span class="s">READ_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">EXECUTE</span><span class="sh">'</span><span class="s">,0)
        for d in ro: 
            if d: rs.add_rule(PathBeneath(d, rm))
        for d in rw+[SANDBOX_DIR]:
            if d: rs.add_rule(PathBeneath(d, rm|wm))
        rs.restrict_self()
    except Exception as e:
        print(</span><span class="sh">'</span><span class="s">[landlock] unavailable:</span><span class="sh">'</span><span class="s">, e, file=sys.stderr)
def loop():
    apply_ll()
    while True:
        line = sys.stdin.readline()
        if not line: break
        req = json.loads(line)
        code = req.get(</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">)
        g = {}
        try:
            exec(code, g, g)
            print(json.dumps({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">: True, </span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="s">: </span><span class="sh">""</span><span class="s">}))
        except Exception as e:
            print(json.dumps({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">: False, </span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="s">: str(e)}))
        sys.stdout.flush()
loop()
</span><span class="sh">"""</span>
</code></pre></div></div>

<h1 id="copy_to_sandbox-구현-메모">copy_to_sandbox 구현 메모</h1>

<ul>
  <li>
    <p>심볼릭 링크 거부, 목적지는 반드시 sandbox_dir 하위 경로로 강제.</p>
  </li>
  <li>
    <p>디렉터리 복사 시 기존 대상 충돌 방지.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span><span class="p">):</span>
    <span class="kn">import</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">not found</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">,</span> <span class="n">dest_rel</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dst</span> <span class="o">!=</span> <span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dest exists</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
</code></pre></div></div>

<h1 id="실행-단계-예시-시퀀스">실행 단계 예시 시퀀스</h1>

<p>유지형(커널) 예시</p>

<ol>
  <li>
    <p>configure_python_exec(readwrite_dirs=["/mnt/sandbox"], readonly_dirs=["/","/usr","/home/you/data"])</p>
  </li>
  <li>
    <p>start_python_session(agent_id="analyst-1", backend="kernel", keep_alive=true)</p>
  </li>
  <li>
    <p>copy_to_sandbox("/home/you/data/df.csv", "data/df.csv")</p>
  </li>
  <li>
    <p>python_execute(session_id="sess-analyst-1", code='import pandas as pd; df=pd.read_csv("data/df.csv"); print(df.shape)')</p>
  </li>
  <li>
    <p>같은 session_id로 계속 실행</p>
  </li>
</ol>

<p>1회성(서브프로세스) 예시</p>

<ol>
  <li>
    <p>configure_python_exec(…)</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code='open("/etc/hosts","w").write("x")') → 커널이 거부</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code='print("ok")') → 정상</p>
  </li>
</ol>

<h1 id="설계-선택-이유와-한계">설계 선택 이유와 한계</h1>

<ul>
  <li>
    <p>Landlock은 커널이 강제하는 일방향 제약이라 한 번 적용하면 사용자 파이썬이 “해제”하진 못한다. 다만 OS가 Linux 5.13+여야 하며, ABI 기능(TRUNCATE/REFER 등)은 버전에 따라 다르다. 위 코드는 “가능하면 쓰고, 없으면 건너뛰는” 베스트에포트 방식으로 구성.</p>
  </li>
  <li>
    <p>완벽한 격리는 아니지만, 실수로 호스트를 더럽히는 경로를 효과적으로 차단한다. 추가로 audit hook과 리소스 제한(CPU/메모리/파일사이즈)을 곁들이면 80/20 목적에 충분히 실용적.</p>
  </li>
</ul>

<p>원하면 여기에 바로 붙여 쓸 수 있는 완성형 모듈(Manager + 두 백엔드 + 최소 RPC 루프)로 묶어서 드릴 수 있다.</p>

<p class="chat--user">

landlock 패키지에 PathBeneath라는 게 없대. 그리고 Config는 유저가 직접할거라 LLM으로는 노출 금지

</p>

<p>좋아. 정리부터 하고, 바로 가져다 쓸 수 있는 코드와 설계를 깔끔히 바꿔서 줄게. 핵심은 “설정(Config)은 네가 직접, LLM에겐 절대 노출하지 않음”, “세션 유지 선택 가능”, “파일 시스템은 Landlock으로 읽기/쓰기 경계”야. 그리고 네가 지적한 대로 PyPI의 landlock 패키지는 PathBeneath 클래스를 안 쓰고 Ruleset 중심의 API라서, 그에 맞춰 업데이트했어. Landlock의 원리는 커널 레벨에서 한 번 적용하면 호출 스레드와 자식에게 영구적으로 누적되는 일방향 제약이야. 사용자 공간에서 임의로 해제할 수 없도록 설계되어 있어(커널 사용자공간 API/매뉴얼에 명시, 그리고 최근 워크숍 자료에도 “한 번 켜면 끌 수 없다”는 원칙이 반복됨). <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org+2</a></p>

<p>아래는 3단계 분리 설계와 코드 스켈레톤이야.</p>

<h1 id="1-툴-config-단계호스트-전용llm-비노출">1) 툴 Config 단계(호스트 전용·LLM 비노출)</h1>

<p>Config는 네 코드에서만 실행. LLM은 모르게 유지.</p>

<p>기능</p>

<ol>
  <li>
    <p>읽기 전용 경로 목록(ro_roots), 읽기/쓰기 허용 루트(rw_root 한 개 추천)를 지정.</p>
  </li>
  <li>
    <p>Landlock을 현재 프로세스에 적용하고, 이후 새로 만드는 커널/서브프로세스에도 상속.</p>
  </li>
  <li>
    <p>세션 풀 생성(에이전트별 세션 유지용).</p>
  </li>
</ol>

<p>landlock 패키지의 공개 문서 기준으로는 Ruleset().allow(path)로 경로 하위 접근을 허용하고 apply()로 적용하는 형태야. 이 패키지는 PathBeneath를 노출하지 않고 고수준 API를 제공해. 예시에서 “기본은 전부 차단, allow로 명시한 경로만 허용” 모델이므로, 읽기 허용 루트는 모두 allow로 넣고, 쓰기가 필요한 디렉터리는 별도로 관리하는 게 안전해. 쓰기 권한의 세밀한 비트 지정은 커널은 지원하지만(예: READ_DIR/READ_FILE/WRITE/TRUNCATE 등), 이 파이썬 패키지에서 경로별 권한 비트를 직접 노출하지 않을 수 있어 버전별로 차이가 난다. 최신 PyPI 페이지를 보면 고수준 예제만 문서화돼 있으니 이 점을 전제로 코드를 짜고, 만약 네 환경에서 per-path write 허용이 필요하면 아래 “플랜 B”를 참고해. <a href="https://pypi.org/project/landlock/">PyPI</a></p>

<p>구현 스켈레톤</p>

<ul>
  <li>아래 모듈은 설정만 담당. LLM에게 이 모듈의 어떤 내용도 전달하지 마.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_config.py  (호스트 전용, LLM 비노출)
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">shutil</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span>  <span class="c1"># PyPI 'landlock' (Edward-Knight)
</span>
<span class="k">class</span> <span class="nc">FsPolicy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ro_roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">rw_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allow_world_read</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># 절대경로 정규화
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ro_roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro_roots</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rw_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">rw_root</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">allow_world_read</span> <span class="o">=</span> <span class="n">allow_world_read</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SandboxManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FsPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">apply_landlock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">FsPolicy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_applied</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>  <span class="c1"># 기본: 전부 금지, allow로만 허용
</span>        <span class="k">if</span> <span class="n">policy</span><span class="p">.</span><span class="n">allow_world_read</span><span class="p">:</span>
            <span class="n">rs</span><span class="p">.</span><span class="nf">allow</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 모든 경로 읽기 허용(“완벽한 샌드박스 불필요” 요구일 때 편의용)
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">:</span>
                <span class="n">rs</span><span class="p">.</span><span class="nf">allow</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># rw_root는 LLM에게 copy_to_sandbox 통해서만 파일을 두게 한다.
</span>        <span class="c1"># 패키지 API가 경로별 쓰기 비트를 노출하지 않는 경우가 있어,
</span>        <span class="c1"># 쓰기는 원칙적으로 차단하고, 커널이 허용하는 한에서만 rw_root 내 조작을 시도한다.
</span>        <span class="c1"># (패키지 업데이트로 per-path write 옵션이 생기면 여기서 조건부로 허용 추가)
</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">apply</span><span class="p">()</span>  <span class="c1"># 현재 스레드 및 자식 프로세스에 영구 적용
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>

    <span class="c1"># 유틸: 신뢰할 수 있는 사전 복사기(LLM은 이 함수를 tool로만 호출)
</span>    <span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">Sandbox not configured</span><span class="sh">"</span>
        <span class="n">src_abs</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="c1"># 읽기 허용 경로 검증
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">allow_world_read</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">src_abs</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">src_abs</span> <span class="o">==</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Source not allowed: </span><span class="si">{</span><span class="n">src_abs</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">dst_abs</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">))</span>
        <span class="c1"># rw_root 밖으로 벗어나는 경로 금지
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst_abs</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dst_abs</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Destination escapes rw_root: </span><span class="si">{</span><span class="n">dst_abs</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst_abs</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src_abs</span><span class="p">,</span> <span class="n">dst_abs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dst_abs</span>
</code></pre></div></div>

<p>참고: Landlock은 일방향 제약이며 restrict_self 이후 해제가 불가한 특성이 공식 문서와 발표 자료에 반복해서 설명돼 있어. 이 구조 덕분에 “파이썬 코드가 룰셋을 풀어버린다” 류의 우려는 정상 커널/사용자 공간 전제에서 해당되지 않아. 단, 커널 취약점이 공개·패치되는 경우가 가끔 있으니 커널을 최신으로 유지하는 게 좋아. 기능과 권한 비트는 매뉴얼과 사용자공간 API 문서에 잘 정리돼 있어. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org+2</a></p>

<p>플랜 B: 경로별 쓰기 비트가 꼭 필요하면</p>

<ol>
  <li>
    <p>최근 이슈로 유명한 landrun(Go CLI) 같은 얇은 래퍼를 써서 “–ro /… –rw /sandbox …” 형태로 정확히 분리할 수 있어. 컨테이너나 도커는 아님. <a href="https://github.com/Zouuup/landrun?utm_source=chatgpt.com">GitHub+2</a></p>
  </li>
  <li>
    <p>또는 아주 얇은 ctypes 래퍼로 landlock_create_ruleset/landlock_add_rule를 직접 호출해 권한 비트를 정확히 넣는 방법(WRITE/TRUNCATE/… 조합)을 쓰면 돼. 비트 목록과 의미는 커널 문서에 정리돼 있어. <a href="https://man.archlinux.org/man/landlock_add_rule.2.en?utm_source=chatgpt.com">man.archlinux.org+1</a></p>
  </li>
</ol>

<h1 id="2-툴-사용법llm에-전달할-스펙">2) 툴 사용법(LLM에 전달할 스펙)</h1>

<p>설정 정보는 한 줄도 노출하지 않는다. 아래 네 가지만 공개.</p>

<ol>
  <li>
    <p>python_exec_internal(session_id, code, timeout_sec)</p>
  </li>
  <li>
    <p>python_exec_visible(session_id, code, timeout_sec, enforce_plot_rules)</p>
  </li>
  <li>
    <p>copy_to_sandbox(src, dst_relpath)</p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>python_session_control(session_id, action=["reset"</td>
          <td>"kill"])</td>
        </tr>
      </tbody>
    </table>
  </li>
</ol>

<p>copy_to_sandbox는 내부적으로 SandboxManager.copy_to_sandbox를 호출한다. 소스는 읽기 허용 경로 내에 있어야 하고, 목적지는 rw_root 하위 상대경로만 허용한다. 이렇게 하면 LLM은 “호스트 파일에 자유 접근(읽기)”은 가능하지만 “쓰기”는 반드시 샌드박스 디렉터리로 복사한 사본만 다루게 되는 워크플로가 된다.</p>

<h1 id="3-실제-실행-단계세션-유지일회용-선택">3) 실제 실행 단계(세션 유지/일회용 선택)</h1>

<p>세션은 커널 유지형과 일회용 둘 다 지원. 기본은 유지형, 요청 시 일회용으로 실행.</p>

<p>구현 스켈레톤</p>

<ul>
  <li>아래는 너가 올려둔 jupyter_client 기반 코드를 정책 분리/에러 메세지/추가 도구 포함으로 다듬은 버전. seaborn/색상/서브플롯 금지 규칙도 그대로.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># code_tool.py  (LLM에 노출되는 엔드포인트는 여기 함수 시그니처뿐)
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">base64</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">shutil</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
<span class="kn">from</span> <span class="n">sandbox_config</span> <span class="kn">import</span> <span class="n">SandboxManager</span><span class="p">,</span> <span class="n">FsPolicy</span>

<span class="c1"># 0) 초기 설정(호스트 전용)
</span><span class="n">SANDBOX</span> <span class="o">=</span> <span class="nc">SandboxManager</span><span class="p">()</span>
<span class="c1"># 예: 네 앱에서만 호출. LLM에겐 감춤.
# SANDBOX.apply_landlock(FsPolicy(
#     ro_roots=["/home/you/data", "/usr/share"],
#     rw_root="/home/you/sbx",
#     allow_world_read=False  # 느슨한 설정이 필요하면 True
# ))
</span>
<span class="c1"># 1) 세션 풀
</span><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">stop_channels</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\bseaborn\b</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>  <span class="c1"># 정책 예
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">,</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Do not use seaborn</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[];</span> <span class="n">arts</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_data</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">execute_result</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,{})</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">];</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">plot_</span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s">.png</span><span class="sh">"</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># 안전
</span>                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
                    <span class="n">arts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">fn</span><span class="p">,</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span><span class="n">fp</span><span class="p">,</span><span class="sh">"</span><span class="s">mime</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span><span class="n">arts</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">SessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">KernelSession</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KernelSession</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">].</span><span class="nf">shutdown</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="n">POOL</span> <span class="o">=</span> <span class="nc">SessionPool</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\.subplot\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">subplots\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not use subplots</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">(color\s*=|palette\s*=|style\s*=)</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not set explicit colors or styles</span><span class="sh">"</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># 2) LLM이 쓰는 툴(설정 정보 없음)
</span><span class="k">def</span> <span class="nf">python_exec_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">python_exec_visible</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">enforce_plot_rules</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">enforce_plot_rules</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">,</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="n">v</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">python_session_control</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">:</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="n">session_id</span><span class="p">);</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="sh">"</span><span class="s">kill</span><span class="sh">"</span><span class="p">:</span>  <span class="n">POOL</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">session_id</span><span class="p">);</span>  <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">killed</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">unknown action</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">SANDBOX</span><span class="p">.</span><span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre></div></div>

<p>툴 스펙(JSON)만 LLM에 전달</p>

<ul>
  <li>네 OpenAI Agents SDK나 vLLM+GPTOSS/Qwen 파이프라인에서 아래 “툴 서명”만 노출해. 설정 경로나 정책 정보는 절대 넣지 마.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python_exec_internal_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">python_exec_internal</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">세션 유지형 파이썬 실행(비가시).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_exec_visible_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">사용자 가시 실행(단일 matplotlib 플롯, 색/스타일 금지).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">copy_to_sandbox_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">호스트 파일을 샌드박스 쓰기 루트로 복사. 목적지는 rw_root 하위 상대경로만.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">dst_relpath</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">dst_relpath</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_control_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">python_session_control</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">세션 재시작/종료</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">enum</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">kill</span><span class="sh">"</span><span class="p">]}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>세션 유지 vs 일회용</p>

<ul>
  <li>
    <p>유지형: session_id를 고정으로 넘기면 커널 상태가 유지된다.</p>
  </li>
  <li>
    <p>일회용: python_session_control(session_id, "kill")로 즉석 종료 후 새 session_id를 쓰면 된다. 혹은 내부적으로 “one-shot” 코드를 별도 분기해 KernelManager를 매번 생성/종료해도 된다.</p>
  </li>
</ul>

<p>안전성에 대한 메모</p>

<ul>
  <li>
    <p>Landlock은 커널 LSM이므로 사용 중 해제 불가한 일방향 제약(자식 상속 포함)이고, 경로 기반 권한 비트를 제공한다. FS 권한 비트와 설계 원리는 커널 문서의 사용자공간 API/매뉴얼에서 확인 가능하다. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org+2</a></p>
  </li>
  <li>
    <p>PyPI ‘landlock’ 패키지는 PathBeneath를 직접 노출하지 않고 Ruleset.allow / apply를 쓰는 고수준 래퍼다. 문서 예시는 디렉터리 계층 접근 허용 예제만 제공한다. 버전에 따라 경로별 쓰기 비트를 직접 못 줄 수 있으니, 정확한 RW 분리를 원하면 landrun 같은 얇은 CLI를 함께 쓰거나(ctypes로 직접 비트 지정) 정책을 약간 느슨하게 운영하면 된다. <a href="https://pypi.org/project/landlock/">PyPI+1</a></p>
  </li>
</ul>

<p>마무리 체크리스트</p>

<ol>
  <li>
    <p>네 앱 초기화 시점에만 SANDBOX.apply_landlock(…) 호출. 이 코드는 절대 LLM 프롬프트·툴 정의에 섞지 않는다.</p>
  </li>
  <li>
    <p>LLM에는 네 개 툴 시그니처만 노출.</p>
  </li>
  <li>
    <p>쓰기가 필요한 파일은 무조건 copy_to_sandbox로 rw_root에 사본을 둔 뒤 그 경로만 쓰도록 유도.</p>
  </li>
  <li>
    <p>세션 유지가 필요하면 session_id를 고정하고, 필요 없으면 kill→새로 생성.</p>
  </li>
</ol>

<p>원하는 방향으로 더 촘촘한 RW 비트 제어가 필요한 순간이 오면 두 가지 루트가 있어. 첫째, landrun을 커널 앞단 래퍼로 덮어씌우기(도커 아님). 둘째, 작은 ctypes 뼈대에 커널 매뉴얼의 LANDLOCK_ACCESS_FS_* 비트를 그대로 넣는 저수준 바인딩. 어느 쪽이든 연결해 줄 수 있어.</p>

<p class="chat--user">

좀 이상해. rw 컨트롤은 어디서해

</p>

<p>핵심만 콕 집어 말할게. RW 컨트롤은 “툴 레이어”가 아니라 “세션 프로세스가 뜨는 순간 커널에 Landlock 룰을 올리는 곳”에서 한다. 즉,</p>

<p>1단계(네가 직접 하는 Config): 읽기 전용 디렉터리(ro_dirs)와 읽기/쓰기 디렉터리(rw_dir)를 정한다.<br />
2단계(세션 부팅 시점): 해당 세션 프로세스 안에서 landlock_create_ruleset → landlock_add_rule(각 경로에 권한 마스크 지정) → landlock_restrict_self를 호출한다. 이때 ro_dirs에는 읽기 마스크, rw_dir에는 읽기+쓰기 마스크를 준다.<br />
3단계(실행 중): LLM은 copy_to_sandbox로 파일을 rw_dir 아래에 들여와서만 저장·수정하게 하고, 샌드박스 밖 쓰기 시도는 커널이 거부한다.</p>

<p>아래는 실제로 “어디서 어떻게 RW를 강제하는지”가 드러나는 최소 헬퍼다. PyPI의 고수준 landlock 래퍼가 per-path 권한 비트를 안 열어줄 때를 대비해 ctypes로 커널 UAPI를 직접 호출한다. x86_64의 기본 syscall 번호를 쓰되, liblandlock.so가 있으면 그걸 우선 사용한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># landlock_helper.py
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">util</span>

<span class="c1"># x86_64 기본값. 다른 아키텍처면 번호가 다를 수 있다.
</span><span class="n">__NR_landlock_create_ruleset</span> <span class="o">=</span> <span class="mi">444</span>
<span class="n">__NR_landlock_add_rule</span>       <span class="o">=</span> <span class="mi">445</span>
<span class="n">__NR_landlock_restrict_self</span>  <span class="o">=</span> <span class="mi">446</span>

<span class="c1"># 커널 UAPI 비트 (없는 비트는 0으로 처리)
</span><span class="k">class</span> <span class="nc">Access</span><span class="p">:</span>
    <span class="n">READ_FILE</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">WRITE_FILE</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">READ_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">REMOVE_DIR</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">REMOVE_FILE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">MAKE_CHAR</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">MAKE_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">MAKE_REG</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
    <span class="n">MAKE_SOCK</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="n">MAKE_FIFO</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>
    <span class="n">MAKE_BLOCK</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">MAKE_SYM</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
    <span class="c1"># ABI v2+
</span>    <span class="n">REFER</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>
    <span class="c1"># ABI v3+
</span>    <span class="n">TRUNCATE</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>
    <span class="n">EXECUTE</span>     <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>  <span class="c1"># 있으면 사용
</span>
<span class="c1"># struct landlock_path_beneath_attr
</span><span class="k">class</span> <span class="nc">path_beneath_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">allowed_access</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">parent_fd</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_int</span><span class="p">),</span>
    <span class="p">]</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_library</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">syscall</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">OSError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="nf">strerror</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">_best_effort_mask</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">Access</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">_open_ro_dir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_PATH</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CLOEXEC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_landlock_rw</span><span class="p">(</span><span class="n">ro_dirs</span><span class="p">,</span> <span class="n">rw_dir</span><span class="p">):</span>
    <span class="c1"># 1) 어떤 FS 권한을 다룰지 커널에 알리기(handled_access_fs)
</span>    <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span>
    <span class="p">]:</span>
        <span class="n">handled</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">Access</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># landlock_create_ruleset(attr=NULL, size=0, flags=0)로 ABI 쿼리할 수도 있지만,
</span>    <span class="c1"># 여기선 간단화: 바로 ruleset 생성 (size=8바이트 마스크 전송)
</span>    <span class="k">class</span> <span class="nc">ruleset_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">handled_access_fs</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">)]</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="nf">ruleset_attr</span><span class="p">(</span><span class="n">handled_access_fs</span><span class="o">=</span><span class="n">handled</span><span class="p">)</span>
    <span class="n">ruleset_fd</span> <span class="o">=</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 2) 읽기 전용 마스크와 읽기/쓰기 마스크 구성
</span>    <span class="n">read_mask</span>  <span class="o">=</span> <span class="nf">_best_effort_mask</span><span class="p">(</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">write_mask</span> <span class="o">=</span> <span class="nf">_best_effort_mask</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="c1"># 3) ro_dirs에 읽기 규칙 추가
</span>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ro_dirs</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_ro_dir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attr_pb</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">read_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span>
            <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr_pb</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 1 = LANDLOCK_RULE_PATH_BENEATH
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 4) rw_dir에 읽기+쓰기 규칙 추가
</span>    <span class="n">rw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_ro_dir</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr_pb</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">write_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr_pb</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 5) 현재 스레드에 규칙 적용(자식 프로세스에 상속됨)
</span>    <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p>이제 RW 컨트롤이 “정확히 어디서” 이뤄지는지 보이게 연결하면 끝이다.</p>

<ol>
  <li>
    <p>네가 직접 Config할 때<br />
ro_dirs와 rw_dir를 정하고, 세션 프로세스를 띄우기 직전 또는 세션 프로세스 내부 초기화에서 apply_landlock_rw(ro_dirs, rw_dir)를 호출한다. 여기서 ro_dirs에는 read_mask, rw_dir에는 write_mask를 커널에 등록한다. 이 지점이 RW 컨트롤의 본진이다.</p>
  </li>
  <li>
    <p>세션 유지 구조에 붙일 때<br />
KernelBackend라면 커널 기동 직후 첫 셀에서 아래 한 줄을 주입하거나, 아예 커널 프로세스의 entrypoint에서 호출한다.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 커널 첫 셀
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">landlock_helper</span> <span class="kn">import</span> <span class="n">apply_landlock_rw</span>
<span class="nf">apply_landlock_rw</span><span class="p">(</span>
    <span class="n">ro_dirs</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">RO_DIRS</span><span class="sh">"</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">),</span>
    <span class="n">rw_dir</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">RW_DIR</span><span class="sh">"</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div>

<p>SubprocessBackend라면 자식 프로세스가 부팅되자마자 같은 함수를 호출한 뒤 코드 실행 루프에 진입한다.</p>

<ol>
  <li>툴 레이어에서의 역할 정리<br />
툴은 RW를 “결정”하지 않는다. 툴은 그저 copy_to_sandbox로 파일을 rw_dir 아래로 옮기고, python_execute로 실행할 뿐이다. RW 정책은 위의 apply_landlock_rw가 커널에 고정시킨다. 따라서 temp.py가 rw_dir 밖을 쓰려 하면 커널이 EACCES로 거부한다. 읽기는 ro_dirs에서만 허용된다. allow_world_read 같은 편의 옵션을 쓰면 읽기 범위를 넓힐 수 있지만, 쓰기 권한은 여전히 rw_dir로만 묶인다.</li>
</ol>

<p>정리하면, RW 컨트롤은 landlock_helper.apply_landlock_rw 안의 두 군데에서 동시에 걸린다. ro_dirs에 read_mask 규칙을 추가하는 부분, rw_dir에 write_mask 규칙을 추가하는 부분. 툴은 그 정책을 존중할 뿐이고, LLM에게는 이 설정을 절대 노출하지 않는다.</p>

<p class="chat--user">

def apply_landlock(self, policy: FsPolicy): if self._applied: return rs = Ruleset() # 기본: 전부 금지, allow로만 허용 if policy.allow_world_read: rs.allow("/") # 모든 경로 읽기 허용(“완벽한 샌드박스 불필요” 요구일 때 편의용) else: for p in policy.ro_roots: rs.allow(p) # rw_root는 LLM에게 copy_to_sandbox 통해서만 파일을 두게 한다. # 패키지 API가 경로별 쓰기 비트를 노출하지 않는 경우가 있어, # 쓰기는 원칙적으로 차단하고, 커널이 허용하는 한에서만 rw_root 내 조작을 시도한다. # (패키지 업데이트로 per-path write 옵션이 생기면 여기서 조건부로 허용 추가) rs.apply() # 현재 스레드 및 자식 프로세스에 영구 적용 self._applied = True self.policy = policy 이 코드에서 rw policy를 적용해야하는거 아니야?

</p>

<p>맞아. 그 코드 그대로면 rw_root에 “쓰기 허용”이 전혀 적용되지 않아. Ruleset().allow()만 쓰면 경로 허용 여부 정도만 다루고, 경로별 권한 비트(READ/WRITE/TRUNCATE 등)를 지정하지 못해 쓰기 정책을 커널에 못 박지 못해. 그래서 이 지점에서 RW 마스크를 커널에 정확히 등록해야 한다.</p>

<p>실제로 RW 정책을 적용하는 방법은 두 가지다.</p>

<ol>
  <li>
    <p>정확모드(권장): 커널 UAPI를 ctypes로 직접 호출해서 ro_dirs에는 읽기 마스크, rw_dir에는 읽기+쓰기 마스크를 넣는다.</p>
  </li>
  <li>
    <p>임시 대안: high-level 래퍼만으로는 per-path write 비트를 못 주니, rw 컨트롤을 커널이 아닌 툴 레이어(몽키패치/audit hook)에서 “소프트”로 막는다. 이건 의도하신 “도커 없이도 꽤 안전”에 못 미친다.</p>
  </li>
</ol>

<p>아래는 1) 정확모드로, 네 메서드에 딱 들어갈 패치다.</p>

<p>간단 헬퍼(한 파일로 두고 import 해서 쓰면 됨)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># landlock_helper.py
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">util</span>

<span class="n">__NR_landlock_create_ruleset</span> <span class="o">=</span> <span class="mi">444</span>
<span class="n">__NR_landlock_add_rule</span>       <span class="o">=</span> <span class="mi">445</span>
<span class="n">__NR_landlock_restrict_self</span>  <span class="o">=</span> <span class="mi">446</span>

<span class="k">class</span> <span class="nc">Access</span><span class="p">:</span>
    <span class="n">READ_FILE</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">WRITE_FILE</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">READ_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">REMOVE_DIR</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">REMOVE_FILE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">MAKE_CHAR</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">MAKE_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">MAKE_REG</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
    <span class="n">MAKE_SOCK</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="n">MAKE_FIFO</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>
    <span class="n">MAKE_BLOCK</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">MAKE_SYM</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
    <span class="n">EXECUTE</span>     <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>     <span class="c1"># 있으면 사용
</span>    <span class="n">REFER</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>     <span class="c1"># ABI v2+
</span>    <span class="n">TRUNCATE</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>     <span class="c1"># ABI v3+
</span>
<span class="k">class</span> <span class="nc">path_beneath_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">allowed_access</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">),</span> <span class="p">(</span><span class="sh">"</span><span class="s">parent_fd</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_int</span><span class="p">)]</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_library</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">syscall</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">OSError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="nf">strerror</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">_mask</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">Access</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">_open_path_only</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_PATH</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CLOEXEC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_landlock_rw</span><span class="p">(</span><span class="n">ro_dirs</span><span class="p">,</span> <span class="n">rw_dir</span><span class="p">):</span>
    <span class="c1"># 1) ruleset 생성: 어떤 FS 권한을 다룰지 커널에 통보
</span>    <span class="n">handled</span> <span class="o">=</span> <span class="nf">_mask</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="k">class</span> <span class="nc">ruleset_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">handled_access_fs</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">)]</span>
    <span class="n">rs_attr</span> <span class="o">=</span> <span class="nf">ruleset_attr</span><span class="p">(</span><span class="n">handled_access_fs</span><span class="o">=</span><span class="n">handled</span><span class="p">)</span>
    <span class="n">rs_fd</span> <span class="o">=</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">rs_attr</span><span class="p">),</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">(</span><span class="n">rs_attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 2) 읽기와 쓰기 마스크
</span>    <span class="n">read_mask</span>  <span class="o">=</span> <span class="nf">_mask</span><span class="p">(</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">write_mask</span> <span class="o">=</span> <span class="nf">_mask</span><span class="p">(</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span>
                       <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 3) 읽기 전용 경로들
</span>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro_dirs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span> 
            <span class="k">continue</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_path_only</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">read_mask</span><span class="p">,</span> <span class="n">fd</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 1 = PATH_BENEATH
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 4) 쓰기 허용 루트
</span>    <span class="n">rw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_path_only</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">write_mask</span><span class="p">,</span> <span class="n">fd</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 5) 현재 스레드에 적용(자식 상속)
</span>    <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">rs_fd</span><span class="p">)</span>
</code></pre></div></div>

<p>네 기존 메서드 교체본</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_config.py
</span><span class="kn">from</span> <span class="n">landlock_helper</span> <span class="kn">import</span> <span class="n">apply_landlock_rw</span>

<span class="k">def</span> <span class="nf">apply_landlock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">FsPolicy</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_applied</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># ro_roots, rw_root를 커널에 정확히 등록
</span>    <span class="nf">apply_landlock_rw</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">,</span> <span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">rw_root</span><span class="sh">"</span><span class="p">:</span> <span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="sh">"</span><span class="s">ro_roots</span><span class="sh">"</span><span class="p">:</span> <span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">}</span>
</code></pre></div></div>

<p>이 변경으로 “RW 컨트롤을 정확히 어디서 하느냐”가 분명해진다.</p>

<ul>
  <li>
    <p>ro_roots에는 읽기 전용 비트만, rw_root에는 읽기+쓰기 비트를 커널에 고정한다.</p>
  </li>
  <li>
    <p>이후 temp.py가 rw_root 밖에 쓰려 하면 커널이 EACCES로 거부하고, ro_roots 밖의 경로는 아예 읽기도 거부된다(너가 ro_roots를 얼마나 넓게 잡느냐에 따라 다름).</p>
  </li>
  <li>
    <p>ro_roots와 rw_root가 겹칠 수 있는데, Landlock은 허용 비트를 합집합으로 보므로 rw_root 하위에선 쓰기가 열리고, 그 밖에선 닫힌다. 운영상 문제 없다.</p>
  </li>
</ul>

<p>간단 동작 확인</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 설정 단계(LLM 비노출)
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nc">FsPolicy</span><span class="p">(</span><span class="n">ro_roots</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">/usr</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">/home/you/data</span><span class="sh">"</span><span class="p">],</span> <span class="n">rw_root</span><span class="o">=</span><span class="sh">"</span><span class="s">/home/you/sbx</span><span class="sh">"</span><span class="p">)</span>
<span class="n">SANDBOX</span><span class="p">.</span><span class="nf">apply_landlock</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

<span class="c1"># 테스트
</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/hosts</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">)</span>           <span class="c1"># → PermissionError (쓰기 거부)
</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/home/you/data/df.csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># → OK (읽기 허용)
</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/home/you/sbx/out.txt</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># → OK (rw_root 쓰기 허용)
</span></code></pre></div></div>

<p>만약 환경 제약으로 위 syscall 방식이 불가하거나 커널 ABI가 낮으면, apply_landlock에서 예외를 받아 “소프트 가드로 폴백”하도록 분기하면 된다. 그래도 질문의 요지였던 “이 코드에서 rw policy를 적용해야 하는가?”에 답하자면, 그렇다. 바로 이 apply_landlock에서 커널에 rw_root용 쓰기 권한 마스크를 명시적으로 추가해야 한다.</p>

<p class="chat--user">

아 점점 쓸데 없이 복잡해지는 것 같은데; 정신 차리고 제대로 해보자. 일단 /user/abc 는 읽기 가능 /user/abc/test 안에는 쓰기 가능한 landlock을 하는 가장 간단한 코드 줘봐. 테스트 라인 포함해서 

</p>

<p>원하는 딱 그거. 리눅스 5.13+ (x86_64 가정)에서 <code class="language-plaintext highlighter-rouge">/user/abc</code>는 읽기만, <code class="language-plaintext highlighter-rouge">/user/abc/test</code>는 쓰기까지 허용하는 가장 단순한 파이썬 스크립트다. 테스트까지 포함했다. 외부 라이브러리 불필요, ctypes로 커널 UAPI 직접 호출한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">util</span>

<span class="c1"># x86_64용 landlock syscall 번호
</span><span class="n">__NR_landlock_create_ruleset</span> <span class="o">=</span> <span class="mi">444</span>
<span class="n">__NR_landlock_add_rule</span>       <span class="o">=</span> <span class="mi">445</span>
<span class="n">__NR_landlock_restrict_self</span>  <span class="o">=</span> <span class="mi">446</span>

<span class="c1"># 권한 비트 (커널 uapi/linux/landlock.h)
</span><span class="k">class</span> <span class="nc">FS</span><span class="p">:</span>
    <span class="n">EXECUTE</span>     <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">WRITE_FILE</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">READ_FILE</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">READ_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">REMOVE_DIR</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">REMOVE_FILE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">MAKE_CHAR</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">MAKE_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
    <span class="n">MAKE_REG</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="n">MAKE_SOCK</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>
    <span class="n">MAKE_FIFO</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">MAKE_BLOCK</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
    <span class="n">MAKE_SYM</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
    <span class="n">REFER</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>   <span class="c1"># ABI v2+
</span>    <span class="n">TRUNCATE</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>   <span class="c1"># ABI v3+
</span>
<span class="n">LANDLOCK_RULE_PATH_BENEATH</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_library</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">syscall</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">OSError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="nf">strerror</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">class</span> <span class="nc">ruleset_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">handled_access_fs</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">path_beneath_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">allowed_access</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">parent_fd</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_int</span><span class="p">),</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">_open_dir_path_only</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_PATH</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CLOEXEC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_try_create_ruleset</span><span class="p">(</span><span class="n">handled_mask</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="nf">ruleset_attr</span><span class="p">(</span><span class="n">handled_access_fs</span><span class="o">=</span><span class="n">handled_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_landlock_read_ro_write_rw</span><span class="p">(</span><span class="n">ro_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rw_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">ro_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">ro_dir</span><span class="p">)</span>
    <span class="n">rw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># 가능한 최대 비트로 시도 → 안 되면 v3(=TRUNCATE) 제외 → 그래도 안 되면 REFER도 제외
</span>    <span class="n">handled_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">EXECUTE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_DIR</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_CHAR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_REG</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_SOCK</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_FIFO</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_BLOCK</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_SYM</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">REFER</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span><span class="p">)</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">handled_all</span><span class="p">,</span>
             <span class="n">handled_all</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span><span class="p">,</span>
             <span class="n">handled_all</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FS</span><span class="p">.</span><span class="n">REFER</span><span class="p">]</span>
    <span class="n">rs_fd</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">last_err</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs_fd</span> <span class="o">=</span> <span class="nf">_try_create_ruleset</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">last_err</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">rs_fd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">last_err</span> <span class="ow">or</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">landlock_create_ruleset failed</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">read_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">EXECUTE</span><span class="p">)</span>
    <span class="n">write_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span>
                  <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_REG</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span>
                  <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">REFER</span> <span class="nf">if </span><span class="p">(</span><span class="n">handled_all</span> <span class="o">&amp;</span> <span class="n">FS</span><span class="p">.</span><span class="n">REFER</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="nf">if </span><span class="p">(</span><span class="n">handled_all</span> <span class="o">&amp;</span> <span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># 읽기 전용: /user/abc
</span>    <span class="n">fd_ro</span> <span class="o">=</span> <span class="nf">_open_dir_path_only</span><span class="p">(</span><span class="n">ro_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ro_rule</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">read_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd_ro</span><span class="p">)</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="n">LANDLOCK_RULE_PATH_BENEATH</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">ro_rule</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd_ro</span><span class="p">)</span>

    <span class="c1"># 읽기/쓰기 허용: /user/abc/test
</span>    <span class="n">fd_rw</span> <span class="o">=</span> <span class="nf">_open_dir_path_only</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rw_rule</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">write_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd_rw</span><span class="p">)</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="n">LANDLOCK_RULE_PATH_BENEATH</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">rw_rule</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd_rw</span><span class="p">)</span>

    <span class="c1"># 현재 스레드(프로세스)에 적용. 이후 자식 프로세스에도 상속됨.
</span>    <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">rs_fd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">ro</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/user/abc</span><span class="sh">"</span>
    <span class="n">rw</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/user/abc/test</span><span class="sh">"</span>

    <span class="c1"># 테스트 준비: 디렉터리와 읽기용 파일 생성(제한 걸기 전)
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">readonly.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">hello</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Applying Landlock: RO =</span><span class="sh">"</span><span class="p">,</span> <span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">RW =</span><span class="sh">"</span><span class="p">,</span> <span class="n">rw</span><span class="p">)</span>
    <span class="nf">apply_landlock_read_ro_write_rw</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="n">rw</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Landlock applied.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 테스트 1: ro 디렉터리 쓰기 → 실패해야 함
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">should_fail.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">nope</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[FAIL] wrote to RO dir (unexpected)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[OK] RO write blocked:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># 테스트 2: rw 디렉터리 쓰기 → 성공해야 함
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">works</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[OK] RW write succeeded</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[FAIL] RW write blocked:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># 테스트 3: ro 파일 읽기 → 성공해야 함
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">readonly.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[OK] RO read:</span><span class="sh">"</span><span class="p">,</span> <span class="n">f</span><span class="p">.</span><span class="nf">readline</span><span class="p">().</span><span class="nf">strip</span><span class="p">())</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[FAIL] RO read blocked:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">linux</span><span class="sh">"</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Linux 전용입니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>설명 요약</p>

<ul>
  <li>
    <p>이 스크립트는 현재 프로세스에만 제약을 건다. 한 번 적용되면 해제 불가, 자식 프로세스에 상속된다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/user/abc</code>는 READ_FILE/READ_DIR(+EXECUTE)만, <code class="language-plaintext highlighter-rouge">/user/abc/test</code>는 READ/WRITE/CREATE/REMOVE(+가능하면 REFER/TRUNCATE)까지 허용한다.</p>
  </li>
  <li>
    <p>x86_64 기준 syscall 번호를 썼다. 다른 아키텍처면 번호가 다를 수 있다.</p>
  </li>
  <li>
    <p>커널이 낮아 TRUNCATE/REFER를 지원하지 않으면 자동으로 빼고 재시도한다.</p>
  </li>
</ul>

<p class="chat--user">

python landlock 패키지 쓰는거보다 ctype로 하는게 더 낫나?

</p>

<p>짧게 정리하면 “무엇을 통제하느냐”에 따라 선택이 갈린다.</p>

<ol>
  <li>ctypes 직접 호출이 나은 경우</li>
</ol>

<ul>
  <li>
    <p>경로별 권한 비트(READ_FILE/READ_DIR/WRITE_FILE/MAKE__/REMOVE__ /REFER/TRUNCATE 등)를 정확히 지정해야 할 때</p>
  </li>
  <li>
    <p>패키지 래퍼가 원하는 기능(예: rw 전용 디렉터리)까지 노출하지 않거나 버전마다 API가 달라 흔들릴 때</p>
  </li>
  <li>
    <p>지금처럼 “/user/abc는 읽기만, /user/abc/test는 쓰기까지” 같은 세밀한 정책이 필수일 때</p>
  </li>
</ul>

<p>장점: 커널 UAPI를 그대로 쓰므로 원하는 동작을 1:1로 구현 가능, 예측 가능성 높음<br />
단점: 아키텍처별 syscall 번호, ABI 호환성(REFER/TRUNCATE 지원 여부) 처리 등 주변 코드가 필요</p>

<ol>
  <li>PyPI landlock 패키지가 나은 경우</li>
</ol>

<ul>
  <li>
    <p>“읽기만 허용할 루트 몇 개 + 기본은 차단” 같은 단순 모델이면 충분할 때</p>
  </li>
  <li>
    <p>유지보수 용이성, 가독성, 배포 편의성을 우선할 때</p>
  </li>
  <li>
    <p>커널 기능 추가(ABI v2/v3)까지 세밀 제어가 굳이 필요 없을 때</p>
  </li>
</ul>

<p>장점: 코드 간단, 포터블, 업데이트 시 따라가면 됨<br />
단점: 래퍼가 노출하는 추상화 한계 때문에 per-path 쓰기 권한을 정확히 다루지 못할 수 있음</p>

<p>현실적인 권장</p>

<ul>
  <li>
    <p>네 요구(RO 디렉터리와 RW 디렉터리를 분리)라면 ctypes로 얇은 헬퍼를 두는 쪽이 깔끔하다. 이미 제공한 50~80줄짜리 helper를 모듈화하면 끝이다. 그 위에 “설정은 네가 직접, LLM에는 노출 금지” 원칙만 지키면 된다.</p>
  </li>
  <li>
    <p>유지보수 부담을 줄이고 싶다면 하이브리드로 가자. 우선 PyPI 패키지로 “읽기 허용 루트”만 잡고, “쓰기 허용 루트”만 ctypes로 추가 규칙을 넣는 방식도 가능하다. 즉, 간단한 건 래퍼에 맡기고, 꼭 필요한 부분만 커널 UAPI로 보강.</p>
  </li>
</ul>

<p>결론</p>

<ul>
  <li>
    <p>세밀한 RW 컨트롤이 필요하면 ctypes가 더 낫다.</p>
  </li>
  <li>
    <p>단순 접근제어와 운영 편의가 우선이면 패키지가 더 낫다.</p>
  </li>
  <li>
    <p>너의 현재 설계(세션 유지 + 명시적 RW 분리)는 ctypes 미니 헬퍼가 가장 직관적이고, LLM 툴 레이어와도 잘 맞는다.</p>
  </li>
</ul>

<p class="chat--user">

아 redhat 8.10은 그런게 안 되네. 그냥 pure 파이썬으로 간단하게 되는 패키지 없나? 해커가 작정하고 하면 뚫릴수도 있지만 LLM이 그런 동작을 안한다고 가정하고

</p>

<p>가능한 한 단순하게 갈게. RHEL 8.10에서 Landlock 안 된다면 “완벽 보안” 대신 실수 방지용 가벼운 가드가 현실적이다. 순수 파이썬만으로도 다음 정도는 막을 수 있다.</p>

<ol>
  <li>
    <p>sys.addaudithook로 파일 열기(open) 이벤트에서 “쓰기 의도”를 가로채기</p>
  </li>
  <li>
    <p>os/builtins/pathlib의 쓰기 계열 호출을 몽키패치해 우회 시도 최소화</p>
  </li>
  <li>
    <p>옵션으로 subprocess/네트워크 차단</p>
  </li>
</ol>

<p>audit hook은 파이썬 3.8+에서 표준이며 open 이벤트는 경로, 모드, 플래그를 넘겨준다. 이걸로 “쓰기 의도”를 정밀하게 잡아낼 수 있다. 다만 감사용 훅이지 하드한 보안 경계는 아니라는 점은 공식적으로도 명시돼 있다(그래도 이번 목표에는 충분히 유용). <a href="https://docs.python.org/3/library/audit_events.html?utm_source=chatgpt.com">Python documentation+2</a></p>

<p>아래는 바로 복붙해 쓸 수 있는 “순수 파이썬 미니 패키지” 코드와 테스트다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lite_fs_guard.py
# 순수 파이썬 가드: 쓰기는 write_root 아래만 허용, 읽기는 기본 전체 허용(옵션으로 제한 가능)
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">builtins</span><span class="p">,</span> <span class="n">pathlib</span>

<span class="k">class</span> <span class="nc">LiteFSGuard</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">write_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">read_allow</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                 <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">write_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">write_root</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">read_allow</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_allow</span> <span class="ow">or</span> <span class="p">[])]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="n">allow_read_anywhere</span>
        <span class="n">self</span><span class="p">.</span><span class="n">block_subprocess</span> <span class="o">=</span> <span class="n">block_subprocess</span>
        <span class="n">self</span><span class="p">.</span><span class="n">block_network</span> <span class="o">=</span> <span class="n">block_network</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_installed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># 원본 함수 백업
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_orig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">:</span> <span class="n">builtins</span><span class="p">.</span><span class="nb">open</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">os_open</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nb">open</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">rename</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">rename</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">replace</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">remove</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">unlink</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">unlink</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mkdir</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">makedirs</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">rmdir</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">rmdir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">chmod</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">chmod</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">path_open</span><span class="sh">"</span><span class="p">:</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="nb">open</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">os_system</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">system</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rp</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">write_root</span> <span class="ow">or</span> <span class="n">rp</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_read_allowed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">allow_read_anywhere</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">rp</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">rp</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">rp</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">read_allow</span><span class="p">)</span>

    <span class="c1"># --------- audit hook ----------
</span>    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># args: path, mode, flags (문서화됨)
</span>            <span class="c1"># https://docs.python.org/3/library/audit_events.html
</span>            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Subprocess disabled by LiteFSGuard</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Network disabled by LiteFSGuard</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># --------- monkey patches (소프트 가드) ----------
</span>    <span class="k">def</span> <span class="nf">_patches</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">open_guard</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">](</span><span class="nb">file</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">os_open_guard</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">os_open</span><span class="sh">"</span><span class="p">](</span><span class="nb">file</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rename_guard</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">dst</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Rename restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">rename</span><span class="sh">"</span><span class="p">](</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">replace_guard</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">dst</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Replace restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">](</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">remove_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Delete restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">remove</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">unlink_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Unlink restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">unlink</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">mkdir_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Mkdir restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">mkdir</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">makedirs_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Makedirs restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">makedirs</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rmdir_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Rmdir restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">rmdir</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">chmod_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Chmod restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">chmod</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">path_open_guard</span><span class="p">(</span><span class="n">self_path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">self_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">path_open</span><span class="sh">"</span><span class="p">](</span><span class="n">self_path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">builtins</span><span class="p">.</span><span class="nb">open</span> <span class="o">=</span> <span class="n">open_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="nb">open</span> <span class="o">=</span> <span class="n">os_open_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">rename</span> <span class="o">=</span> <span class="n">rename_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">replace</span> <span class="o">=</span> <span class="n">replace_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">remove_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">unlink</span> <span class="o">=</span> <span class="n">unlink_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span> <span class="o">=</span> <span class="n">mkdir_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span> <span class="o">=</span> <span class="n">makedirs_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">rmdir</span> <span class="o">=</span> <span class="n">rmdir_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">chmod</span> <span class="o">=</span> <span class="n">chmod_guard</span>
        <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="nb">open</span> <span class="o">=</span> <span class="n">path_open_guard</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">block_subprocess</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">system</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">()).</span><span class="nf">throw</span><span class="p">(</span><span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">os.system disabled</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_installed</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_audit</span><span class="p">)</span>  <span class="c1"># 3.8+ 표준 훅: 이벤트 목록은 공식 표 참조
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_patches</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_installed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[lite-fs-guard] active. write_root=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">, read_anywhere=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">allow_read_anywhere</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>간단 테스트 스크립트</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_lite_fs_guard.py
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">lite_fs_guard</span> <span class="kn">import</span> <span class="n">LiteFSGuard</span>

<span class="n">WRITE_ROOT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/tmp/sbx</span><span class="sh">"</span>
<span class="n">guard</span> <span class="o">=</span> <span class="nc">LiteFSGuard</span><span class="p">(</span><span class="n">write_root</span><span class="o">=</span><span class="n">WRITE_ROOT</span><span class="p">,</span>
                    <span class="n">allow_read_anywhere</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>   <span class="c1"># 어디든 읽기 허용
</span>                    <span class="n">block_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>      <span class="c1"># 원하면 False
</span>                    <span class="n">block_network</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>        <span class="c1"># 원하면 True
</span><span class="n">guard</span><span class="p">.</span><span class="nf">install</span><span class="p">()</span>

<span class="c1"># 준비
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">try write to /etc/hosts (should fail)</span><span class="sh">"</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/hosts</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s"># nope</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">FAIL: wrote to /etc/hosts</span><span class="sh">"</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OK:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">try write to write_root (should pass)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">hello</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OK: wrote to</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">try read from /etc/hosts (should pass)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/hosts</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">().</span><span class="nf">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>

<p>이 접근은 어디까지나 “실수 방지용”이다. 핵심 포인트만 다시 적는다.</p>

<ul>
  <li>
    <p>sys.addaudithook는 표준이며 open 이벤트(path, mode, flags)를 준다. 여기서 정확히 쓰기 의도를 판별할 수 있다. <a href="https://docs.python.org/3/library/audit_events.html?utm_source=chatgpt.com">Python documentation</a></p>
  </li>
  <li>
    <p>audit hook은 감사용이므로 완전한 보안 경계는 아니다. 하지만 이번 전제(LLM이 악의적 동작을 하지 않는다고 가정)에서는 충분히 실용적이다. <a href="https://github.com/python/cpython/issues/87604?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p>더 강한 격리가 필요하면 도커·랜드락·AppArmor 같은 OS 레벨이 답이지만, Red Hat 8.10 제약이라면 위 가드가 가장 단순한 “순수 파이썬 80/20 해법”이다.</p>
  </li>
  <li>
    <p>참고로 언어 제한만 필요한 경우 RestrictedPython 같은 도구도 있지만 파일시스템 격리를 제공하는 건 아니다. pyfakefs는 테스트용 가짜 FS이지 보안 격리가 아니다. codejail은 AppArmor가 필요해서 이번 조건에 맞지 않는다. <a href="https://restrictedpython.readthedocs.io/?utm_source=chatgpt.com">restrictedpython.readthedocs.io+3</a></p>
  </li>
</ul>

<p>다음 스텝으로, 이 가드를 너의 커널 세션(또는 서브프로세스) 시작 직후에 한 번 설치하도록 넣으면 된다. 세션 유지/일회성 모두 동일하게 동작한다.</p>

<p class="chat--user">

#!/usr/bin/python3.8 #-<em>- coding: utf-8 -</em>- ## QUEST FOR A PYTHON SANDBOX: # 1. You design an script where an exec() command is ran. # 2. The code ran by exec() is supplied by your opponent, trying e.g. to # write something to the './forbidden.txt' file or access # forbidden_object. Your opponent has # full knowledge of the outer script (no security through obscurity). # There should be no trick to break the sandbox whatsoever. Crashing # the subprocess Cpython does not count. # 3. The exec()uted code should however allow as large subset of Python # capabilities as possible, including interaction with variables/ # functions/objects in the outer script, if and only if they are # explicitly listed as accessible. # 4. Elegant, fast, dependency-frugal solution is also appreciated. # 5. The outer script writes something to the './allowed.txt' file # in the end. user_command = """import sys ## Useful code on the figure import numpy x = numpy.linspace(0,10) y = numpy.sin(x) fig.get_axes()[0].plot(x, y) ## Malicious wannabe exploits follow for l in ().<strong>class</strong>.<strong>base</strong>.<strong>subclasses</strong>(): if l.<strong>name</strong> == '<strong>code</strong>': print(l) ## SANDBOXED: has access to the sandboxed python subprocess only, in line with our intention ## to provide Python environment as-rich-as-possible exec("[ i for i in ().<strong>class</strong>.<strong>base</strong>.<strong>subclasses</strong>() if i.<strong>name</strong> == 'code']<a href="0, 0, 0, 5, 8, 0, b'hello world', (), (), ()," title="', '', 0, b'">0</a>") ## TEST #fig = numpy.array([666]) ## TODO: unexpected class type of returned objects should be detected after being returned from the sandbox #class SpoofFigure(matplotlib.pyplot.Figure): # def savefig(self): print("Malicious action") ## SANDBOXED: modified class won't be serialized if not defined in a module - can not get out of sandbox #fig = SpoofFig() #import XXX ## UNCLEAR: could some compiled module circumwent the file access hook? Which OS calls should be forbidden, too? ## See https://docs.python.org/3/library/audit_events.html to find them. #open('forbidden','w').write('pwned by l33t h4xx0rz') ## SANDBOXED: fails to write on disk thanks to the audit hook #fig.savefig('forbidden.png') ## SANDBOXED: audit hook applies to all python code #forbidden_object.access() ## SANDBOXED: no access to the forbidden object from the outer scope conn.send([fig]) ## all results can be safely passed (unless it is of custom class etc.) """ ## Prepare the testing example import matplotlib.pyplot as plt fig, ax = plt.subplots(nrows=1, ncols=1) ## the user's code will plot here allowed_objects = [fig] ## no other data exposed to the exec()uted script ## —————- The sandbox implementation follows, not to be changed ——————– def sandbox2020(code, allowed_objects): def ran_in_subprocess(conn): from sys import addaudithook def block_mischief(event,arg): if type(event) != str: raise # Security note: Well-designed objects can be passed to this function that could expose the top-level namespace # (through catching error and reading sys.exc_info()[2].tb_frame.f_back.f_globals). This should not enable modifying # variables outside the multiprocessing sandbox, but could give access to some internal sandbox variables. This function # thus should not refer to any 'lock variables'. It is safer to check the results in the main thread. if event=='open' and type(arg[1])==str and arg[1]!='r': print('\taudit:', event, arg) raise IOError('file write forbidden') if event.split('.')[0] in ['subprocess', 'shutil', 'winreg']: print('\taudit:', event, arg) raise IOError('potentially dangerous, filesystem-accessing functions forbidden') addaudithook(block_mischief) del(block_mischief) ## No way to remove or circumwent audit hooks from python. No access to this function. sandbox_locals['conn'] = conn # automatically add the communication pipe to objects accessible from the sandbox exec(user_command, sandbox_locals) print('len sandbox locals after', len(sandbox_locals)) conn.close() from multiprocessing import Process, Pipe parent_conn, child_conn = Pipe() p = Process(target=ran_in_subprocess, args=(child_conn,)) p.start() ## NOTE: The sandbox is probably safe against file writing, as well as against access into the main process. ## Yet the objects returned from it as results could have been manipulated. Asserting the output objects to be ## of expected data types is an extra safety measure. But be careful whenever your main program flow is ## controlled by the returned objects' attributes, e.g. file paths could change. return parent_conn.recv() p.join() ## Run the sandbox! sandbox_locals = dict((key, value) for key,value in locals().items() if value in allowed_objects) # copy.deepcopy() ## are all obj safely serialized? fig_result = sandbox2020(user_command, sandbox_locals) ## Demonstrate that the main process is not affected open('./allowed.txt','w').write('legally saved file from the main process') print(type(fig_result) == type(fig)) fig_result.savefig('allowed.png') 이런 코드는 어때

</p>

<p>좋은 출발이야. 다만 지금 코드는 “쓰기 의도” 판별이 부정확하고, os 계열 조작·서브프로세스·네트워크가 그대로 열려 있어 실수 방지라는 목표에도 살짝 모자라. 구조는 유지하되, 최소한만 손봐서 안전성과 예측가능성을 올린 패치안을 줄게.</p>

<p>핵심 문제 요약</p>

<ol>
  <li>
    <p>audit 훅의 open 검사: mode가 'r'이 아니면 전부 쓰기라고 가정하고 있는데, 'rb', 'r+', 'a', 'x' 등과 flags까지 모두 봐야 한다. os.open()도 잡아야 한다.</p>
  </li>
  <li>
    <p>파일 조작류: rename/replace/remove/unlink/mkdir/makedirs/rmdir 같은 조작 이벤트를 막아야 샌드박스 밖 훼손을 피할 수 있다.</p>
  </li>
  <li>
    <p>subprocess와 os.system, socket 계열은 명시 차단이 필요하다.</p>
  </li>
  <li>
    <p>타임아웃과 join 누락: recv() 대기 중 교착, 무한루프 방지 필요. p.join(timeout) 후 미응답이면 종료.</p>
  </li>
  <li>
    <p>인자 전달 혼선: sandbox2020(…, allowed_objects) 인자를 쓰지 않고 전역 sandbox_locals를 닫아 사용하고 있다. 함수 인자를 사용하도록 정리.</p>
  </li>
</ol>

<p>아래는 네 코드에 최소 변경만 가한 드롭인 패치다. 동작은 그대로이고, 샌드박스 안에서의 파일 쓰기는 현재 작업 디렉터리 기준으로 “./sandbox/” 하위에서만 허용하도록 했다. 필요하면 WRITE_ROOT를 바꿔.</p>

<p>수정본 전체</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3.8
#-*- coding: utf-8 -*-
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">WRITE_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># 샌드박스 내에서만 쓰기 허용
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">user_command</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">import sys, os, numpy
x = numpy.linspace(0,10)
y = numpy.sin(x)
fig.get_axes()[0].plot(x, y)

# 시도: 금지 영역 쓰기
try:
    open(</span><span class="sh">'</span><span class="s">./forbidden.txt</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">nope</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">'</span><span class="s">forbidden write blocked:</span><span class="sh">'</span><span class="s">, type(e).__name__)

# 시도: 허용 영역 쓰기
open(os.path.join(os.environ[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="s">], </span><span class="sh">'</span><span class="s">ok.txt</span><span class="sh">'</span><span class="s">),</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="s">)

# 결과 전달
conn.send([fig])
</span><span class="sh">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">allowed_objects</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">fig</span><span class="sh">"</span><span class="p">:</span> <span class="n">fig</span><span class="p">}</span>   <span class="c1"># exec에 노출할 것만 명시
</span>
<span class="k">def</span> <span class="nf">sandbox2020</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span>

    <span class="k">def</span> <span class="nf">ran_in_subprocess</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">allowed</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">pathlib</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">wr</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">rp</span> <span class="o">==</span> <span class="n">wr</span> <span class="ow">or</span> <span class="n">rp</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">wr</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="c1"># open / os.open: (path, mode, flags)
</span>            <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># 파일 조작류
</span>            <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">FS op restricted to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># 서브프로세스/시스템 호출
</span>            <span class="k">elif</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Subprocess disabled</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># 네트워크(원하면 주석 해제)
</span>            <span class="c1"># elif event.startswith("socket."):
</span>            <span class="c1">#     raise PermissionError("Network disabled")
</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

        <span class="c1"># exec용 전역 딕셔너리 구성
</span>        <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="n">__builtins__</span><span class="p">}</span>
        <span class="n">g</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
        <span class="n">g</span><span class="p">[</span><span class="sh">"</span><span class="s">conn</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>

        <span class="c1"># 실행
</span>        <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="n">parent_conn</span><span class="p">,</span> <span class="n">child_conn</span> <span class="o">=</span> <span class="nc">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">ran_in_subprocess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">child_conn</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="c1"># 결과 수신 대기 + 타임아웃
</span>    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">poll</span><span class="p">(</span><span class="mf">0.05</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout_sec</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="sh">"</span><span class="s">sandbox execution timed out</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># 샌드박스 실행
</span><span class="n">result_list</span> <span class="o">=</span> <span class="nf">sandbox2020</span><span class="p">(</span><span class="n">user_command</span><span class="p">,</span> <span class="n">allowed_objects</span><span class="p">)</span>

<span class="c1"># 메인 프로세스는 정상 동작
</span><span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">./allowed.txt</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="s">legally saved file from the main process</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># 결과 확인
</span><span class="n">fig_result</span> <span class="o">=</span> <span class="n">result_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">same type:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig_result</span><span class="p">)</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig_result</span><span class="p">))</span>
<span class="n">fig_result</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="sh">'</span><span class="s">allowed.png</span><span class="sh">'</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>설명과 운용 팁</p>

<ol>
  <li>
    <p>WRITE_ROOT 안에서만 쓰기 허용: open/os.open에서 mode/flags를 모두 검사해 쓰기 의도를 잡고, 조작성 작업(삭제/이동/생성 등)은 경로가 WRITE_ROOT 내부일 때만 허용했다.</p>
  </li>
  <li>
    <p>읽기는 어디서나 가능하게 남겨두었고, 필요하면 _audit의 open 분기에서 읽기도 allowlist로 제한할 수 있다.</p>
  </li>
  <li>
    <p>subprocess, os.system 차단. 네 목적에 맞게 socket.*도 막을 수 있다.</p>
  </li>
  <li>
    <p>타임아웃과 안전 종료 추가. 자식이 결과를 안 보내면 terminate 후 TimeoutError.</p>
  </li>
  <li>
    <p>allowed_objects는 dict로 명시 주입. exec의 globals로만 전달돼, 그 외 바깥 이름은 보이지 않는다.</p>
  </li>
  <li>
    <p>이건 “실수 방지용”이다. 악의적 확장(C 확장에서 직접 open 호출, ctypes로 커널 호출 등)은 막지 못한다는 점은 설계상 감수. 그 대신 코드가 짧고 의존성 없고, LLM이 악의적으로 행동하지 않는다는 전제에서는 실용적이다.</p>
  </li>
</ol>

<p>여기서 더 단단히 하고 싶다면, 네가 이미 쓰던 커널 유지 구조에 이 가드를 첫 셀로 주입하고, 파일은 copy_to_sandbox로 WRITE_ROOT 밑으로만 들여와 다루게 만드는 정도면 충분히 80/20을 채운다.</p>

<p class="chat--user">

근데 기존 코드에서 return을 먼저하고 join을 하는데 말이 안되는거지?

</p>

<p>맞아. 그 코드는 return 다음에 p.join()이 있어 실행되지 않아. 결과를 받은 뒤 프로세스를 정리(join/terminate)하고 리소스를 닫은 다음에 return 해야 한다. 그렇지 않으면 좀비 프로세스가 생길 수 있다(특히 POSIX).</p>

<p>안전한 기본 패턴을 아주 간단히 적으면 이렇게 된다.</p>

<ol>
  <li>
    <p>자식 시작 → 부모에서 child_conn 닫기</p>
  </li>
  <li>
    <p>poll로 타임아웃 감시하며 recv</p>
  </li>
  <li>
    <p>결과 받으면 p.join()으로 수거</p>
  </li>
  <li>
    <p>타임아웃이면 p.terminate() 후 p.join()</p>
  </li>
  <li>
    <p>항상 파이프 닫기</p>
  </li>
</ol>

<p>최소 수정 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">sandbox2020</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span>

    <span class="k">def</span> <span class="nf">ran_in_subprocess</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">allowed</span><span class="p">):</span>
        <span class="c1"># ... 내부 실행 로직 ...
</span>        <span class="n">conn</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>           <span class="c1"># 자식 쪽 파이프 닫기 후 종료
</span>
    <span class="n">parent_conn</span><span class="p">,</span> <span class="n">child_conn</span> <span class="o">=</span> <span class="nc">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">ran_in_subprocess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">child_conn</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">child_conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>          <span class="c1"># 부모 쪽에서 child end는 바로 닫기
</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 타임아웃 감시하면서 결과 수신
</span>        <span class="k">if</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">poll</span><span class="p">(</span><span class="n">timeout_sec</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="sh">"</span><span class="s">sandbox execution timed out</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 여기서 반드시 조인해서 수거
</span>        <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="c1"># 혹시 아직 살아 있으면 강제 종료 후 재조인
</span>            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">parent_conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<p>한 줄 요약<br />
return을 먼저 하면 그 아래 코드는 죽은 코드가 된다. 결과를 변수에 담고, 프로세스를 수거(p.join)하고, 핸들들을 닫은 뒤에 return 하도록 순서를 바꿔야 한다.</p>

<p class="chat--user">

수정할 것: conn 불필요한 것 같은데 그냥 subprocess(with 파일/subprocess sendbox)로 실행하고 stdout 메시지랑 stderr 메시지만 있으면 될 것 같아. 단 에러 난 내용에 대해선 좀 더 자세히 나오면 좋겠어. 어떤 파일을 접근하려다 났는지/어떤 커맨드를 하려다 났는지

&lt;p class="chat--user" markdown="1"&gt;

수정할 것: conn 불필요한 것 같은데 그냥 subprocess(with 파일/subprocess sendbox)로 실행하고 stdout 메시지랑 stderr 메시지만 있으면 될 것 같아. 단 에러 난 내용에 대해선 좀 더 자세히 나오면 좋겠어. 어떤 파일을 접근하려다 났는지/어떤 커맨드를 하려다 났는지 또, async를 활용해서 끝날때까지는 await로 하면 좋겠어

</p>

<p>좋아. 파이프(conn) 없이, 별도 파이썬 서브프로세스를 async/await로 실행하고 stdout/stderr만 수집하는 최소 구현을 정리했다. 서브프로세스 안에서는 audit hook으로 “파일 시스템 쓰기”를 WRITE_ROOT 내부로만 제한하고, subprocess/os.system 시도를 차단한다. 에러 메시지는 어떤 파일/커맨드 때문에 막혔는지 자세히 출력된다.</p>

<p>아래 스크립트 하나로 바로 실행해도 되고, run_user_code_async 함수만 가져다 써도 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async.py
# Python 3.8+ 필요. 외부 의존성 없음.
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">tempfile</span><span class="p">,</span> <span class="n">textwrap</span><span class="p">,</span> <span class="n">traceback</span>

<span class="n">CHILD_TEMPLATE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys

WRITE_ROOT = os.environ.get(</span><span class="sh">"</span><span class="s">WRITE_ROOT</span><span class="sh">"</span><span class="s">, os.path.abspath(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="s">))
ALLOW_READ_ANYWHERE = os.environ.get(</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">) == </span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">
READ_ALLOW = os.environ.get(</span><span class="sh">"</span><span class="s">READ_ALLOW</span><span class="sh">"</span><span class="s">, </span><span class="sh">""</span><span class="s">)
READ_ALLOW = [os.path.realpath(p) for p in READ_ALLOW.split(os.pathsep) if p]

def _real(p): 
    try: return os.path.realpath(p)
    except Exception: return str(p)

def _in_write_root(p):
    rp = _real(p); wr = _real(WRITE_ROOT)
    return rp == wr or rp.startswith(wr + os.sep)

def _is_read_allowed(p):
    if ALLOW_READ_ANYWHERE: 
        return True
    rp = _real(p)
    if _in_write_root(rp): 
        return True
    return any(rp == r or rp.startswith(r + os.sep) for r in READ_ALLOW)

def _audit(event, args):
    # 파일 열기/생성
    if event in (</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="s">):
        path = str(args[0])
        mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">
        flags = int(args[2]) if len(args) &gt; 2 else 0
        write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)) or \
            (flags &amp; (os.O_WRONLY | os.O_RDWR | os.O_CREAT | os.O_TRUNC | os.O_APPEND))
        if write_intent and not _in_write_root(path):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} mode={mode} flags={flags} reason=write-outside-WRITE_ROOT({WRITE_ROOT})</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)
        # 선택: 읽기 제한을 두고 싶으면 여기서 검사
        if (not write_intent) and (not _is_read_allowed(path)):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=read-not-allowed</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)

    # 파일 조작류 (경로가 첫 인자에 온다고 가정; rename/replace는 src,dst 둘 다 체크)
    elif event in (</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="s">):
        src = str(args[0]); dst = str(args[1])
        if not (_in_write_root(src) and _in_write_root(dst)):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} src={_real(src)} dst={_real(dst)} reason=op-outside-WRITE_ROOT({WRITE_ROOT})</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)
    elif event in (</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="s">):
        path = str(args[0])
        if not _in_write_root(path):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=op-outside-WRITE_ROOT({WRITE_ROOT})</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)

    # 서브프로세스/시스템 호출 차단
    elif event.startswith(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="s">) or event == </span><span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="s">:
        cmd = None
        try:
            # subprocess.Popen은 첫 인자로 args(커맨드)가 들어오는 경우가 많다
            cmd = args[0]
        except Exception:
            cmd = </span><span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="s">
        msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} cmd={cmd} reason=subprocess-disabled</span><span class="sh">"</span><span class="s">
        print(msg, file=sys.stderr, flush=True)
        raise PermissionError(msg)

    # 네트워크를 막고 싶으면 주석 해제
    # elif event.startswith(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="s">):
    #     msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} reason=network-disabled</span><span class="sh">"</span><span class="s">
    #     print(msg, file=sys.stderr, flush=True)
    #     raise PermissionError(msg)

# 설치
sys.addaudithook(_audit)

# 사용자 코드 실행
USER_CODE = r\"\"\"{user_code}\"\"\"
g = {</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="s">}
try:
    exec(USER_CODE, g, g)
except Exception as e:
    # 에러를 자세히 stderr로
    print(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="s">, file=sys.stderr)
    traceback.print_exc()
    raise
</span><span class="sh">"""</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">write_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">read_allow</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">python_executable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    user code를 별도 파이썬 서브프로세스에서 실행하고 stdout/stderr만 수집.
    쓰기는 write_root 내부에서만 허용. subprocess/os.system은 차단.
    </span><span class="sh">"""</span>
    <span class="n">write_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">write_root</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">write_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">python_executable</span> <span class="ow">or</span> <span class="n">sys</span><span class="p">.</span><span class="n">executable</span>

    <span class="n">child_code</span> <span class="o">=</span> <span class="n">CHILD_TEMPLATE</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">user_code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
    <span class="c1"># 임시 파일에 자식 스크립트 저장
</span>    <span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="nc">NamedTemporaryFile</span><span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.py</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">child_path</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">name</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">child_code</span><span class="p">)</span>

    <span class="c1"># 자식 환경
</span>    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">WRITE_ROOT</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_root</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span> <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="k">else</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">read_allow</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">READ_ALLOW</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">read_allow</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">child_path</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">124</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">unlink</span><span class="p">(</span><span class="n">child_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># 데모
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">user_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
import os, sys, numpy
print(</span><span class="sh">"</span><span class="s">hello from user code</span><span class="sh">"</span><span class="s">)
# 허용된 쓰기
open(os.path.join(os.environ[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="s">], </span><span class="sh">'</span><span class="s">ok.txt</span><span class="sh">'</span><span class="s">), </span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="s">)
# 금지된 쓰기
try:
    open(</span><span class="sh">'</span><span class="s">/etc/forbidden.txt</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">no</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">caught:</span><span class="sh">"</span><span class="s">, type(e).__name__)
</span><span class="sh">"""</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_async</span><span class="p">(</span><span class="n">user_code</span><span class="p">,</span> <span class="n">write_root</span><span class="o">=</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RETURN =</span><span class="sh">"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트 요약</p>

<ol>
  <li>
    <p>별도 파이썬 프로세스에서 실행하므로 세션 유지가 필요 없을 때 가볍고 안전하다. 세션 유지형이 필요하면 프로세스를 길게 붙잡는 래퍼를 만들면 된다.</p>
  </li>
  <li>
    <p>파일 쓰기는 WRITE_ROOT 내부만 허용. 금지 시도는 stderr에 [AUDIT] 라인으로 이벤트, 경로, 이유가 찍히고 PermissionError를 일으킨다.</p>
  </li>
  <li>
    <p>subprocess/os.system은 차단되고, 차단 사유와 시도한 커맨드를 stderr로 남긴다.</p>
  </li>
  <li>
    <p>await로 결과를 받을 때까지 기다린다. 타임아웃이 나면 returncode 124와 함께 종료한다.</p>
  </li>
  <li>
    <p>읽기는 기본적으로 어디서든 허용하지만, allow_read_anywhere=False로 두고 read_allow 리스트를 주면 읽기도 경로 기반 허용으로 좁힐 수 있다.</p>
  </li>
</ol>

<p>이제 네 에이전트 툴 쪽에서는 이 함수 하나만 감싸서 호출하면 된다. 툴 인자는 code, write_root, timeout 정도만 노출하고, 정책(읽기 허용 범위)은 서버 측에서만 관리해도 깔끔하다.</p>

<p class="chat--user">

추가 구현 요청: read_path(리스트)와 write_path(리스트)를 받도록 하고 싶어. 그리고 시작하는 cwd(Working directory)도 코드 시작할 때 코드랑 같이 입력 하면 좋겠어. 없으면 그냥 None으로 하기. 그런데 cwd를 subprocess 에서 바꿔도 부모 프로세스에는 상관이 없지?

</p>

<p>정리 먼저.</p>

<ul>
  <li>
    <p>요청 반영: read_path(여러 개), write_path(여러 개) 받기, 시작 작업 디렉터리(cwd) 옵션, 비동기(async/await) 실행, 결과는 stdout/stderr만.</p>
  </li>
  <li>
    <p>서브프로세스 안에서 audit hook으로 파일/서브프로세스 시도 감시. 어떤 파일·커맨드 때문에 막혔는지 stderr에 자세히 씀.</p>
  </li>
  <li>
    <p>서브프로세스에서 cwd를 바꿔도 부모 프로세스에는 영향 없다(프로세스마다 현재 디렉터리는 독립).</p>
  </li>
</ul>

<p>아래는 바로 쓸 수 있는 최소 구현이다. 외부 의존성 없음, Python 3.8+.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async_paths.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">tempfile</span>

<span class="n">CHILD_TEMPLATE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, traceback

WRITE_DIRS = [p for p in os.environ.get(</span><span class="sh">"</span><span class="s">WRITE_DIRS</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">).split(os.pathsep) if p]
READ_DIRS  = [p for p in os.environ.get(</span><span class="sh">"</span><span class="s">READ_DIRS</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">).split(os.pathsep) if p]
ALLOW_READ_ANYWHERE = os.environ.get(</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">) == </span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">

def _real(p):
    try: return os.path.realpath(p)
    except Exception: return str(p)

def _is_under_any(path, roots):
    rp = _real(path)
    for r in roots:
        rr = _real(r)
        if rp == rr or rp.startswith(rr + os.sep):
            return True
    return False

def _audit(event, args):
    try:
        # 파일 열기
        if event in (</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="s">):
            path = str(args[0])
            mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">
            flags = int(args[2]) if len(args) &gt; 2 else 0
            write = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)) or \
                    (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
            if write and not _is_under_any(path, WRITE_DIRS):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} mode={mode} flags={flags} reason=write-outside-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)
            if not write and not ALLOW_READ_ANYWHERE and not _is_under_any(path, READ_DIRS+WRITE_DIRS):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=read-not-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)

        # 파일 조작류
        elif event in (</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="s">):
            src = str(args[0]); dst = str(args[1])
            if not (_is_under_any(src, WRITE_DIRS) and _is_under_any(dst, WRITE_DIRS)):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} src={_real(src)} dst={_real(dst)} reason=op-outside-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)
        elif event in (</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="s">):
            path = str(args[0])
            if not _is_under_any(path, WRITE_DIRS):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=op-outside-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)

        # 서브프로세스/시스템 호출 차단
        elif event.startswith(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="s">) or event == </span><span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="s">:
            cmd = None
            try: cmd = args[0]
            except Exception: cmd = </span><span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="s">
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} cmd={cmd} reason=subprocess-disabled</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)

        # 네트워크를 막고 싶으면 주석 해제
        # elif event.startswith(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="s">):
        #     msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} reason=network-disabled</span><span class="sh">"</span><span class="s">
        #     print(msg, file=sys.stderr, flush=True)
        #     raise PermissionError(msg)

    except Exception:
        raise

sys.addaudithook(_audit)

USER_CODE = r\"\"\"{user_code}\"\"\"
g = {</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="s">}
try:
    exec(USER_CODE, g, g)
except Exception:
    print(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="s">, file=sys.stderr)
    traceback.print_exc()
    raise
</span><span class="sh">"""</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">read_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">write_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">python_executable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    별도 파이썬 서브프로세스에서 사용자 코드를 실행한다.
    - read_paths: 읽기 허용 경로 목록(하위 포함). None 또는 []면 읽기 어디든 허용(allow_read_anywhere=True).
    - write_paths: 쓰기 허용 경로 목록(하위 포함). None/[]면 쓰기 전부 차단.
    - cwd: 서브프로세스 시작 작업 디렉터리. None이면 부모의 cwd를 상속. 자식이 바꿔도 부모에는 영향 없음.
    - stdout/stderr를 수집해 반환.
    </span><span class="sh">"""</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">python_executable</span> <span class="ow">or</span> <span class="n">sys</span><span class="p">.</span><span class="n">executable</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">wp</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">rp</span><span class="p">)</span>  <span class="c1"># 읽기 경로 미지정이면 어디든 읽기 허용
</span>
    <span class="n">child_code</span> <span class="o">=</span> <span class="n">CHILD_TEMPLATE</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">user_code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="nc">NamedTemporaryFile</span><span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.py</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">child_path</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">name</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">child_code</span><span class="p">)</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">READ_DIRS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">WRITE_DIRS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span> <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="k">else</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">child_path</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span>  <span class="c1"># 자식의 시작 작업 디렉터리. 부모엔 영향 없음.
</span>        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">unlink</span><span class="p">(</span><span class="n">child_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="c1"># 데모 실행
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">code</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">CWD:</span><span class="sh">"</span><span class="s">, os.getcwd())
# 허용된 쓰기
open(os.path.join(</span><span class="sh">"</span><span class="s">out_dir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="s">), </span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)  # 상대경로는 cwd 기준
# 금지된 쓰기
try:
    open(</span><span class="sh">"</span><span class="s">/tmp/blocked.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked write:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# 서브프로세스 시도
try:
    subprocess.check_output([</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">hi</span><span class="sh">"</span><span class="s">])
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked subproc:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# 허용된 읽기(예: read_paths가 지정되었거나 allow_read_anywhere=True인 경우)
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="c1"># 예시: cwd를 ./work로, 쓰기는 ./work/out_dir 아래만, 읽기는 어디든 허용
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_async</span><span class="p">(</span>
            <span class="n">code</span><span class="p">,</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                 <span class="c1"># None → 어디든 읽기 허용
</span>            <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work/out_dir</span><span class="sh">"</span><span class="p">],</span>  <span class="c1"># 여기만 쓰기 허용
</span>            <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>                    <span class="c1"># 자식의 시작 CWD
</span>            <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>포인트</p>

<ul>
  <li>
    <p>read_paths와 write_paths는 하위 폴더까지 포함해 허용된다. 쓰기는 write_paths 중 하나에 포함될 때만 통과.</p>
  </li>
  <li>
    <p>read_paths를 지정하지 않으면 allow_read_anywhere=True로 동작해 어디든 읽기 허용(요구가 느슨할 때 편함). 읽기도 제한하려면 read_paths를 지정하고 allow_read_anywhere를 생략하면 자동으로 False로 바뀐다.</p>
  </li>
  <li>
    <p>cwd 인자는 서브프로세스에만 적용된다. 자식이 os.chdir로 바꿔도 부모 프로세스에는 아무 영향 없다.</p>
  </li>
  <li>
    <p>차단 시 stderr에 [AUDIT] 라인으로 이벤트, 경로, 커맨드, 이유를 상세히 남긴다.</p>
  </li>
</ul>

<p class="chat--user">

{event}가 없대 format 부분에서

</p>

<p>맞아. 그 에러는 CHILD_TEMPLATE 전체에 <code class="language-plaintext highlighter-rouge">.format(...)</code>을 걸면서 템플릿 안에 있는 f-string의 <code class="language-plaintext highlighter-rouge">{event}</code>, <code class="language-plaintext highlighter-rouge">{args}</code> 같은 중괄호를 바깥 포맷터가 “키 event/args를 달라”로 오해했기 때문에 생긴 거야.</p>

<p>해결은 셋 중 하나로 하면 깔끔해.</p>

<ol>
  <li>
    <p>string.Template로 치환하기(가장 간단)</p>
  </li>
  <li>
    <p>템플릿 안 모든 중괄호를 이스케이프해서 ``로 바꾸고 <code class="language-plaintext highlighter-rouge">.format(user_code=...)</code> 사용</p>
  </li>
  <li>
    <p>아예 사용자 코드 위치만 특수 토큰으로 두고 <code class="language-plaintext highlighter-rouge">.replace()</code>로 치환</p>
  </li>
</ol>

<p>바로 돌아가는 패치(Template 사용)만 보여줄게. 너의 기존 run_user_code_async에서 템플릿 치환 부분만 바꾸면 된다.</p>

<p>수정 전<br />
child_code = CHILD_TEMPLATE.format(user_code=code)</p>

<p>수정 후<br />
from string import Template<br />
child_code = Template(CHILD_TEMPLATE).substitute(USER_CODE=code)</p>

<p>그리고 CHILD_TEMPLATE 안의 자리표시자도 <code class="language-plaintext highlighter-rouge">${USER_CODE}</code>로 바꿔줘야 한다.</p>

<p>예시(핵심 부분만)<br />
CHILD_TEMPLATE = r"""<br />
import os, sys, traceback</p>

<h1 id="-중략-">… 중략 …</h1>

<p>sys.addaudithook(_audit)</p>

<p>USER_CODE = r"""${USER_CODE}"""<br />
g = {"<strong>name</strong> ":"<strong>main</strong> "}<br />
try:<br />
exec(USER_CODE, g, g)<br />
except Exception:<br />
print("[ERROR] exception while executing user code:", file=sys.stderr)<br />
traceback.print_exc()<br />
raise<br />
"""</p>

<p>이렇게 바꾸면 템플릿 안의 f-string들(예: f"[AUDIT] blocked: event={event} …")은 손대지 않아도 되고, 바깥 치환기(Template)는 <code class="language-plaintext highlighter-rouge">$</code>만 보고 치환하므로 <code class="language-plaintext highlighter-rouge">{event}</code>를 건드리지 않는다.</p>

<p>참고로 <code class="language-plaintext highlighter-rouge">.format()</code>을 꼭 쓰고 싶다면 템플릿 내부의 모든 중괄호를 ``로 이스케이프해야 한다. 예: <code class="language-plaintext highlighter-rouge">f"[AUDIT] blocked: event="</code>처럼. 그런데 그러면 내부 f-string이 더 이상 f-string이 아니게 되니, 그 경우엔 f-string을 포기하고 나중에 <code class="language-plaintext highlighter-rouge">.format(event=event, …)</code>를 자식 프로세스에서 호출하는 식으로 바꿔야 해서 코드가 번거로워진다. Template가 제일 깔끔해.</p>

<p class="chat--user">

async multi process 를 이용할 순 없나 string으로 코드를 줄줄이 쓰니깐 좀 …

</p>

<p>맞아. 문자열 템플릿로 “자식 스크립트”를 만들지 말고, 멀티프로세싱으로 독립 프로세스에서 실행하되 async/await로 감싸면 깔끔하다. 아래 코드는 순수 파이썬(의존성 없음)으로 동작하고, 자식 프로세스는 audit hook으로 파일/서브프로세스를 감시한다. 읽기·쓰기 허용 경로는 리스트로 받고, 시작 CWD도 옵션으로 준다. 자식에서 CWD를 바꿔도 부모에는 영향 없다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async_multiprocess.py
# Python 3.8+ 전제. 외부 의존성 없음.
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">def</span> <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                   <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>

    <span class="k">def</span> <span class="nf">_real</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">roots</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">path</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># open / os.open: (path, mode, flags)
</span>        <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> flags=</span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s"> reason=write-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_read_anywhere</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">rp</span><span class="o">+</span><span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=read-not-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 파일 조작(경로 첫 인자; rename/replace는 src,dst 둘 다 확인)
</span>        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">_under_any</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">wp</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> src=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="si">}</span><span class="s"> dst=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 서브프로세스/시스템 호출
</span>        <span class="k">elif</span> <span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s"> reason=subprocess-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 네트워크 차단 옵션
</span>        <span class="k">elif</span> <span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> reason=network-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_child_worker</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">result_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">):</span>
    <span class="c1"># stdout/stderr 캡처
</span>    <span class="n">stdout_buf</span><span class="p">,</span> <span class="n">stderr_buf</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(),</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">()</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># CWD 설정(부모에는 영향 없음)
</span>        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># 가드 설치
</span>        <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>

        <span class="c1"># 코드 실행
</span>        <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>
        <span class="kn">import</span> <span class="n">contextlib</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># 가드 초기화 중 오류 등
</span>        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] sandbox init/exec failed: </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">result_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span>
        <span class="p">})</span>

<span class="k">def</span> <span class="nf">_run_blocking</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_child_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="p">,</span> <span class="n">q</span>
    <span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="c1"># 결과 대기(타임아웃 지원)
</span>    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">.</span><span class="nf">empty</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="c1"># 비정상 종료 케이스
</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] child exited unexpectedly</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout_sec</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">124</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">read_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">write_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    별도 프로세스에서 사용자 코드를 실행하고 stdout/stderr만 수집한다(비동기).
    - read_paths: 읽기 허용 경로 리스트(하위 포함). None이면 어디든 읽기 허용.
    - write_paths: 쓰기 허용 경로 리스트(하위 포함). None/[]면 쓰기 전부 차단.
    - cwd: 자식 프로세스 시작 CWD. None이면 부모 CWD 상속. 자식 변경은 부모에 영향 없음.
    - block_subprocess: 서브프로세스 호출 차단 여부.
    - block_network: 네트워크 차단 여부(기본 False).
    - timeout_sec: 시간 초과시 returncode=124 반환.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">read_paths</span><span class="p">)</span>  <span class="c1"># 읽기 경로 미지정 → 어디든 읽기 허용
</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">_run_blocking</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">cwd</span><span class="p">,</span>
        <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">timeout_sec</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span>
        <span class="n">block_network</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># 데모
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">demo_code</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">hello, cwd:</span><span class="sh">"</span><span class="s">, os.getcwd())
# 허용된 쓰기
open(</span><span class="sh">"</span><span class="s">out/ok.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)
# 금지된 쓰기
try:
    open(</span><span class="sh">"</span><span class="s">/etc/blocked.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked write:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# 서브프로세스 시도(차단)
try:
    subprocess.check_output([</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">hi</span><span class="sh">"</span><span class="s">])
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked subproc:</span><span class="sh">"</span><span class="s">, type(e).__name__)
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
            <span class="n">demo_code</span><span class="p">,</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>               <span class="c1"># 읽기 어디든
</span>            <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">],</span>    <span class="c1"># 여기에만 쓰기 허용
</span>            <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">block_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>

    <span class="c1"># Windows spawn 대비
</span>    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">==</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">mp</span><span class="p">.</span><span class="nf">freeze_support</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트</p>

<ol>
  <li>
    <p>문자열 템플릿로 “자식 스크립트”를 만들지 않는다. 모듈 내의 <code class="language-plaintext highlighter-rouge">_child_worker</code>가 별도 프로세스에서 실행되어 exec(code)를 돌린다.</p>
  </li>
  <li>
    <p>read_paths, write_paths를 리스트로 받아 하위까지 허용한다. 쓰기 시도는 write_paths 바깥이면 [AUDIT] 라인이 stderr에 찍히고 PermissionError가 난다. 어떤 파일을 쓰려 했는지, 어떤 조작을 하려 했는지 모두 기록된다.</p>
  </li>
  <li>
    <p>async/await는 <code class="language-plaintext highlighter-rouge">run_in_executor</code>로 멀티프로세스 작업을 논블로킹으로 감싼다. 타임아웃이 나면 자식을 terminate하고 returncode=124로 돌려준다.</p>
  </li>
  <li>
    <p>자식에서 cwd를 바꿔도 부모에는 영향 없다. 시작 CWD는 인자로 지정 가능하다.</p>
  </li>
  <li>
    <p>서브프로세스, os.system을 차단했고, 필요하면 <code class="language-plaintext highlighter-rouge">block_network=True</code>로 소켓도 막을 수 있다.</p>
  </li>
</ol>

<p>여기서 세션 유지형이 필요해지면, 프로세스를 오래 살려두고 큐로 여러 코드를 보내는 “세션 워커” 패턴으로 확장하면 된다. 지금은 요구하신 “간단하고 의존성 없는, async 멀티프로세스 + stdout/stderr만 수집”에 맞춘 최소 구현이다.</p>

<p class="chat--user">

근데 이런 식으로 수행하면 parent 코드에 있는 글로벌 변수 같은걸 user code가 접근할수도 있게 되나?

</p>

<p>핵심만 딱 정리.</p>

<ol>
  <li>
    <p>지금 멀티프로세스 설계에서, 기본이 Linux의 fork면 자식이 부모의 메모리 스냅샷을 “읽기”는 할 수 있다. 예컨대 user code가 import <strong>main</strong> 해서 모듈 전역을 보면, 포크 시점의 값들이 보인다. 부모 상태를 바꾸진 못하지만, 전역 값이 노출되는 건 맞다.</p>
  </li>
  <li>
    <p>이걸 원천 차단하려면 시작 방법을 spawn으로 강제하면 된다. spawn은 새 인터프리터를 깨끗하게 띄우고 모듈을 다시 임포트하므로, 부모의 런타임 전역 객체가 그대로 보이지 않는다. 네가 의도적으로 넘겨준 값(인자, 큐 메시지, exec에 주는 dict)만 접근 가능하다. Windows/macOS는 기본이 spawn, Linux는 기본이 fork라서 강제하는 것이 중요하다.</p>
  </li>
  <li>
    <p>추가로 환경변수는 기본적으로 상속된다. 민감 정보가 있다면 자식에서 os.environ을 초기화하거나, 부모에서 run_user_code_mp_async 호출 전에 “허용 리스트만” 넘기는 방식을 써라.</p>
  </li>
</ol>

<p>아래는 내 이전 코드에 “spawn 강제 + 환경변수 정리 옵션”을 넣은 패치다. 이러면 user code는 부모 전역에 직접 접근할 수 없다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># patch: spawn 사용 + 선택적 환경변수 정리
</span><span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>

<span class="k">def</span> <span class="nf">_child_worker</span><span class="p">(...,</span> <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span><span class="p">,</span> <span class="p">...):</span>
    <span class="c1"># CWD 설정
</span>    <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

    <span class="c1"># 환경변수 정리(선택)
</span>    <span class="k">if</span> <span class="n">sanitize_env</span><span class="p">:</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allowed_env_keys</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># 가드 설치
</span>    <span class="nf">_install_guard</span><span class="p">(...)</span>

    <span class="c1"># 완전히 깨끗한 글로벌 dict로 실행
</span>    <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>
    <span class="bp">...</span>

<span class="k">def</span> <span class="nf">_run_blocking</span><span class="p">(...,</span> <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nf">get_context</span><span class="p">(</span><span class="sh">"</span><span class="s">spawn</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 여기!
</span>    <span class="n">q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_child_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(...,</span> <span class="n">sanitize_env</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">,</span> <span class="p">...))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="bp">...</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_mp_async</span><span class="p">(...,</span> <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="p">...):</span>
    <span class="bp">...</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">_run_blocking</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">cwd</span><span class="p">,</span>
        <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">timeout_sec</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span>
        <span class="n">block_network</span><span class="p">,</span>
        <span class="n">sanitize_env</span><span class="p">,</span>
        <span class="n">allowed_env_keys</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>요점 체크</p>

<ul>
  <li>
    <p>spawn을 쓰면 user code는 부모 전역에 접근하지 못한다. 네가 exec에 넣은 dict(g)와 네가 넘긴 인자만 본다.</p>
  </li>
  <li>
    <p>fork를 쓰면 import <strong>main</strong> 등으로 부모 모듈 전역 “값”을 읽을 수 있다. 그래서 Linux에서는 반드시 spawn으로 강제하자.</p>
  </li>
  <li>
    <p>자식에서 os.chdir로 CWD를 바꿔도 부모에는 영향 없다. 프로세스별로 독립이다.</p>
  </li>
  <li>
    <p>환경변수는 기본 상속이라 민감 정보가 있다면 sanitize_env=True와 allowed_env_keys로 최소화하자.</p>
  </li>
</ul>

<p>이 설정이면, LLM이 악의적이진 않다는 전제에서 “부모 전역 접근” 걱정은 깔끔히 정리된다.</p>

<p class="chat--user">

음 OK. 전체 코드 다 써줘.

</p>

<p>좋아. 아래 스크립트 하나로 끝난다. 멀티프로세스로 분리해 exec(code)를 돌리고, spawn 컨텍스트로 부모 전역 노출을 막았다. read_paths와 write_paths 리스트로 경로 허용을 설정하고, 자식 프로세스 시작 cwd도 선택적으로 지정한다. 파일·서브프로세스(옵션으로 네트워크) 시도는 audit hook에서 차단하며, 어떤 경로/커맨드였는지 stderr에 자세히 남긴다. 비동기 API는 run_user_code_mp_async 한 함수만 쓰면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async_multiprocess_full.py
# Python 3.8+ / 외부 의존성 없음
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">contextlib</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="c1"># ============== 내부: 가드 설치 ==============
</span><span class="k">def</span> <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                   <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>

    <span class="k">def</span> <span class="nf">_real</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">path</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># 파일 열기
</span>        <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> flags=</span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s"> reason=write-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">write</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">allow_read_anywhere</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">rp</span> <span class="o">+</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=read-not-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 파일 조작류
</span>        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">_under_any</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">wp</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> src=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="si">}</span><span class="s"> dst=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 서브프로세스/시스템 호출
</span>        <span class="k">elif</span> <span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s"> reason=subprocess-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 네트워크 차단 옵션
</span>        <span class="k">elif</span> <span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> reason=network-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

<span class="c1"># ============== 내부: 자식 워커 ==============
</span><span class="k">def</span> <span class="nf">_child_worker</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                  <span class="n">result_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">stdout_buf</span><span class="p">,</span> <span class="n">stderr_buf</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(),</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">()</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># CWD 설정(부모에는 영향 없음)
</span>        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># 환경변수 최소화(선택)
</span>        <span class="k">if</span> <span class="n">sanitize_env</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allowed_env_keys</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># 가드 설치
</span>        <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>

        <span class="c1"># exec용 깨끗한 글로벌 dict
</span>        <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>

        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] sandbox init/exec failed: </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">result_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span>
        <span class="p">})</span>

<span class="c1"># ============== 내부: 동기 실행(스레드풀에서 호출) ==============
</span><span class="k">def</span> <span class="nf">_run_blocking</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nf">get_context</span><span class="p">(</span><span class="sh">"</span><span class="s">spawn</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 부모 전역 노출 방지
</span>    <span class="n">q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_child_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="p">,</span> <span class="n">sanitize_env</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">,</span> <span class="n">q</span>
    <span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">.</span><span class="nf">empty</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] child exited unexpectedly</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout_sec</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">124</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] no result</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ============== 공개: 비동기 API ==============
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">read_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">write_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    별도 프로세스에서 사용자 코드를 실행하고 stdout/stderr를 수집해 반환(비동기).
    - read_paths: 읽기 허용 경로 리스트(하위 포함). None이면 어디든 읽기 허용.
    - write_paths: 쓰기 허용 경로 리스트(하위 포함). None/[]면 쓰기 전부 차단.
    - cwd: 자식 프로세스 시작 작업 디렉터리. 자식의 os.chdir는 부모에 영향 없음.
    - allow_read_anywhere: 명시적 제어(기본 None → read_paths 미지정이면 True).
    - block_subprocess: 서브프로세스 호출 차단 여부.
    - block_network: 네트워크 차단 여부.
    - sanitize_env: 자식 환경변수를 최소화할지 여부.
    - allowed_env_keys: sanitize_env=True일 때 보존할 키 목록(기본 PATH, PYTHONPATH, HOME, TMPDIR).
    - timeout_sec: 시간 초과 시 returncode=124.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">read_paths</span><span class="p">)</span>

    <span class="c1"># 쓰기 경로는 미리 만들어 둔다.
</span>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">_run_blocking</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">cwd</span><span class="p">,</span>
        <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">timeout_sec</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span>
        <span class="n">block_network</span><span class="p">,</span>
        <span class="n">sanitize_env</span><span class="p">,</span>
        <span class="n">allowed_env_keys</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># ============== 데모 ==============
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">demo_code</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">hello, cwd:</span><span class="sh">"</span><span class="s">, os.getcwd())
# 허용된 쓰기
open(</span><span class="sh">"</span><span class="s">out/ok.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)
# 금지된 쓰기
try:
    open(</span><span class="sh">"</span><span class="s">/etc/blocked.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked write:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# 서브프로세스 시도(차단)
try:
    subprocess.check_output([</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">hi</span><span class="sh">"</span><span class="s">])
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked subproc:</span><span class="sh">"</span><span class="s">, type(e).__name__)
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
            <span class="n">demo_code</span><span class="p">,</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>               <span class="c1"># 읽기 어디든 허용
</span>            <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">],</span>    <span class="c1"># 여기만 쓰기 허용
</span>            <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>                  <span class="c1"># 자식 시작 CWD
</span>            <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">block_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">sanitize_env</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>             <span class="c1"># 환경 최소화
</span>            <span class="n">allowed_env_keys</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">==</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">mp</span><span class="p">.</span><span class="nf">freeze_support</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>이제 이 파일을 모듈로 두고 run_user_code_mp_async만 호출하면 된다. 필요하면 read_paths/write_paths/cwd를 에이전트 툴 인자로 노출하고, 환경변수 최소화나 네트워크 차단은 서버 쪽 정책으로 고정해도 된다.</p>

<p class="chat--user">

만약에 multi threading이면 어떻게 돼?

</p>

<p>요지는 “스레드로 돌리느냐, 프로세스로 돌리느냐”를 나눠 보아야 해.</p>

<ol>
  <li>우리 설계처럼 멀티프로세스로 샌드박스를 띄운 뒤, 그 안에서 유저 코드가 멀티스레드를 쓰는 경우</li>
</ol>

<ul>
  <li>
    <p>괜찮다. <code class="language-plaintext highlighter-rouge">sys.addaudithook</code>은 “프로세스 단위”로 설치되고, 그 프로세스의 모든 스레드에서 발생한 이벤트에 적용된다. 즉 유저 코드가 스레드를 여러 개 만들어도 파일 쓰기 차단, <code class="language-plaintext highlighter-rouge">subprocess</code> 차단은 그대로 먹힌다.</p>
  </li>
  <li>
    <p>주의점은 프로세스 단위 속성들(CWD, 환경변수 등)은 스레드 간 공유된다는 것. 하지만 이건 부모에게는 영향 없다(부모는 다른 프로세스).</p>
  </li>
  <li>
    <p>안정성 보강 팁: 자식 프로세스 진입 직후 <code class="language-plaintext highlighter-rouge">resource</code>로 한도(시간/메모리/파일크기)를 걸면, 스레드 폭주로 인한 자원 잡아먹기도 방지된다.</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">resource</span>
<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>위 3줄을 내가 준 <code class="language-plaintext highlighter-rouge">_child_worker</code> 맨 앞쪽(가드 설치 직후) 정도에 넣으면 충분해.</p>

<ol>
  <li>샌드박스를 “스레드”로만 돌리고(=부모와 같은 프로세스), 비동기/스레드로 병렬 실행하고 싶은 경우</li>
</ol>

<ul>
  <li>
    <p>비권장. 같은 프로세스에서 <code class="language-plaintext highlighter-rouge">exec</code>을 돌리면 메모리 격리가 없다. 유저 코드가 부모의 전역 상태를 들여다보거나 건드릴 여지가 생긴다. 예를 들어 같은 프로세스에서 <code class="language-plaintext highlighter-rouge">import __main__</code>, <code class="language-plaintext highlighter-rouge">inspect</code>로 프레임을 타고 올라가면 부모 스코프에 닿을 수 있다.</p>
  </li>
  <li>
    <p>또한 같은 프로세스라 <code class="language-plaintext highlighter-rouge">os.chdir</code>은 전역 CWD를 바꿔서 “다른 스레드/부모 로직”에도 영향을 준다. 환경변수 수정도 마찬가지. 파일가드(audit hook)는 스레드 전체에 적용되지만, “상태 격리”가 안 된다.</p>
  </li>
  <li>
    <p>그래도 꼭 스레드 모드가 필요하다면 최소한 다음을 추가해야 한다.</p>

    <ul>
      <li>
        <p>스레드 모드에선 <code class="language-plaintext highlighter-rouge">os.chdir</code> 금지(감사 훅에서 <code class="language-plaintext highlighter-rouge">event == "os.chdir"</code> 혹은 <code class="language-plaintext highlighter-rouge">os.chdir</code>를 래핑해서 막기).</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">exec</code>의 <code class="language-plaintext highlighter-rouge">globals</code>를 새 dict로 주고, 부모 전역 참조를 전달하지 않기.</p>
      </li>
      <li>
        <p>민감 빌트인/모듈 접근을 최소화(예: <code class="language-plaintext highlighter-rouge">__import__</code>, <code class="language-plaintext highlighter-rouge">inspect</code> 등). 이건 기능 제한과 충돌하니 신중해야 한다.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>결론적으로 “LLM이 악의적이지 않다” 가정 하더라도, 스레드만으로는 실수로 부모 상태를 망칠 수 있다. 그래서 나는 계속 “spawn 프로세스” 권장.</p>
  </li>
</ul>

<ol>
  <li>병렬 실행(동시에 여러 개 돌리기)을 원하면</li>
</ol>

<ul>
  <li>
    <p>지금 구조 그대로 <code class="language-plaintext highlighter-rouge">run_user_code_mp_async</code>를 여러 번 await하면 된다. 내부에서 프로세스를 매번 띄우니 완전 분리된다.</p>
  </li>
  <li>
    <p>대량 병렬 시엔 세마포어로 동시 실행 수를 제한하거나, 프로세스 풀(예: <code class="language-plaintext highlighter-rouge">concurrent.futures.ProcessPoolExecutor</code>)로 바꾸면 리소스 효율이 좋아진다. 인터페이스는 그대로 유지한 채 내부 실행자만 풀로 교체하면 된다.</p>
  </li>
</ul>

<p>정리</p>

<ul>
  <li>
    <p>“멀티스레딩을 유저 코드가 자식 프로세스 안에서 쓰는 것”은 OK. 감사 훅은 모든 스레드에 적용된다.</p>
  </li>
  <li>
    <p>“샌드박스 자체를 스레드로 구현”은 메모리·상태 격리가 없어 위험하다. CWD/ENV가 전역이라 부모에 영향도 줄 수 있다. 그래서 지금처럼 spawn 멀티프로세스 유지가 정답이다.</p>
  </li>
  <li>
    <p>병렬성은 프로세스 단위로 가져가고, 필요하면 리소스 한도와 풀링으로 튜닝하자.</p>
  </li>
</ul>

<p>원하면 스레드 모드의 최소 샘플도 붙여 줄 수 있는데, 위 이유로 실전 투입은 추천하지 않는다.</p>

<p class="chat--user">

오케이 프로세스 한 번이 아니라 기억이 유지되는 커널은 어떻게 만들수있을까

</p>

<p>좋아. “기억이 유지되는 커널”을 멀티프로세스로 만들었다. 한 번 띄워두면 같은 프로세스 안의 전역 dict를 재사용해서 상태가 이어지고, 비동기(await) 인터페이스로 코드 조각을 계속 실행할 수 있다. 파일·서브프로세스(선택적으로 네트워크)는 감사 훅(sys.addaudithook)으로 가볍게 샌드박스한다. 읽기/쓰기 허용 경로, 시작 CWD, 환경 정리 여부도 런타임에 바꿀 수 있다.</p>

<p>아래 파일 하나로 끝난다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># persistent_kernel_async.py
# Python 3.8+ / 외부 의존성 없음
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">contextlib</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="c1"># ---------------- 내부: 감사 훅(파일/서브프로세스/네트워크 제어) ----------------
</span><span class="k">def</span> <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                   <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>

    <span class="k">def</span> <span class="nf">_real</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">path</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># 파일 열기(open / os.open)
</span>        <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> flags=</span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s"> reason=write-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">write</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">allow_read_anywhere</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">rp</span> <span class="o">+</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=read-not-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 파일 조작(경로 첫 인자; rename/replace는 src,dst 둘 다 확인)
</span>        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">_under_any</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">wp</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> src=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="si">}</span><span class="s"> dst=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 서브프로세스/시스템 호출
</span>        <span class="k">elif</span> <span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s"> reason=subprocess-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 네트워크 차단(옵션)
</span>        <span class="k">elif</span> <span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> reason=network-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

<span class="c1"># ---------------- 내부: 자식 프로세스 커널 ----------------
</span><span class="k">def</span> <span class="nf">_kernel_proc</span><span class="p">(</span><span class="n">req_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">resp_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">,</span>
                 <span class="n">init_cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># 상태
</span>    <span class="n">read_paths</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">write_paths</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">block_subprocess</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">block_subprocess</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">block_network</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">block_network</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">sanitize_env</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">sanitize_env</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">allowed_env_keys</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">allowed_env_keys</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># CWD/ENV 설정
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sanitize_env</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allowed_env_keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># 초기화 오류도 응답
</span>        <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">init failed: </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">return</span>

    <span class="c1"># 리소스 한도(원하면 조정)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">resource</span>
        <span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># 메모리는 OS/glibc 동작에 따라 영향이 다를 수 있으니 필요할 때만 켜기
</span>        <span class="c1"># resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024,)*2)
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># 감사 훅 설치(프로세스 전체 스레드에 적용)
</span>    <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>

    <span class="c1"># 전역 dict: 이게 “기억”이다.
</span>    <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>

    <span class="c1"># 이벤트 루프
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">req_q</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">rid</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">exec</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">stdout_buf</span><span class="p">,</span> <span class="n">stderr_buf</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(),</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">()</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
                        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">()})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">reset-done</span><span class="sh">"</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">set_paths</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">read_paths</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="n">write_paths</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">)</span>
                <span class="c1"># 훅은 이미 설치되어 있지만, 클로저 값이 아니라 함수 내에서 최신 리스트를 캡쳐하도록 재설치
</span>                <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                               <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">paths-updated</span><span class="sh">"</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">set_cwd</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">new_cwd</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_cwd</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">)</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
                            <span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_paths</span><span class="p">,</span> <span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">write_paths</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">:</span> <span class="n">allow_read_anywhere</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">shutdown</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bye</span><span class="sh">"</span><span class="p">})</span>
                <span class="k">break</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown op: </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># ---------------- 부모 측: 세션 핸들(비동기 API) ----------------
</span><span class="k">class</span> <span class="nc">PersistentKernel</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nf">get_context</span><span class="p">(</span><span class="sh">"</span><span class="s">spawn</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_req_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_resp_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">mp</span><span class="p">.</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_next_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                    <span class="o">*</span><span class="p">,</span>
                    <span class="n">read_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">write_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">startup_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">init_cfg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">block_subprocess</span><span class="sh">"</span><span class="p">:</span> <span class="n">block_subprocess</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">block_network</span><span class="sh">"</span><span class="p">:</span> <span class="n">block_network</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">sanitize_env</span><span class="sh">"</span><span class="p">:</span> <span class="n">sanitize_env</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">allowed_env_keys</span><span class="sh">"</span><span class="p">:</span> <span class="n">allowed_env_keys</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_kernel_proc</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_req_q</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_resp_q</span><span class="p">,</span> <span class="n">init_cfg</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="c1"># 간단 헬스체크: 상태 요청
</span>        <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">startup_timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aexec</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">exec</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="n">code</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">set_paths</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                        <span class="n">read_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                        <span class="n">write_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                        <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">set_paths</span><span class="sh">"</span><span class="p">,</span>
                                <span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
                                <span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
                                <span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">:</span> <span class="n">allow_read_anywhere</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">set_cwd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">set_cwd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">shutdown</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_cleanup</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_rpc</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">kernel not started</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_next_id</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_next_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">rid</span>
            <span class="c1"># 큐 put/get은 블로킹이므로 스레드풀로 넘김
</span>            <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_req_q</span><span class="p">.</span><span class="n">put</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
            <span class="c1"># 응답 대기(타임아웃)
</span>            <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">kernel request timed out: </span><span class="si">{</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">op</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_resp_q</span><span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">remaining</span><span class="p">))</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="c1"># 계속 폴링
</span>                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="n">rid</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">resp</span>
                <span class="c1"># 혹시 다른 응답이면 버퍼링하지 않고 무시(직렬 호출 전제)
</span>                <span class="c1"># 병렬 호출을 원하면 here: per-request map/fan-in 스레드 추가 필요
</span>
<span class="c1"># ---------------- 사용 예(데모) ----------------
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nc">PersistentKernel</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                 <span class="c1"># None → 어디든 읽기 허용
</span>            <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">],</span>      <span class="c1"># 여기만 쓰기 허용
</span>            <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>                    <span class="c1"># 커널의 시작 CWD (부모엔 영향 없음)
</span>            <span class="n">block_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">sanitize_env</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 1) 상태 확인
</span>        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">status</span><span class="p">())</span>

        <span class="c1"># 2) 실행 1: 파일 쓰기(허용) + 금지 시도(거부)
</span>        <span class="n">code1</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">CWD:</span><span class="sh">"</span><span class="s">, os.getcwd())
open(</span><span class="sh">"</span><span class="s">out/ok.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)
try:
    open(</span><span class="sh">"</span><span class="s">/etc/blocked.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked write:</span><span class="sh">"</span><span class="s">, type(e).__name__)
print(</span><span class="sh">"</span><span class="s">done-1</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="n">res1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="n">code1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC1:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res1</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT1:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res1</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR1:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res1</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>

        <span class="c1"># 3) 실행 2: 상태 유지 확인(앞에서 만든 변수 재사용)
</span>        <span class="n">code2</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
if </span><span class="sh">'</span><span class="s">counter</span><span class="sh">'</span><span class="s"> not in globals():
    counter = 0
counter += 1
print(</span><span class="sh">"</span><span class="s">counter:</span><span class="sh">"</span><span class="s">, counter)
</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">res2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="n">code2</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">].</span><span class="nf">strip</span><span class="p">())</span>

        <span class="c1"># 4) reset 후 다시 확인
</span>        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">reset</span><span class="p">())</span>
        <span class="n">res3</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="sh">"</span><span class="s">print(</span><span class="sh">'</span><span class="s">has counter?</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">counter</span><span class="sh">'</span><span class="s"> in globals())</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">res3</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">].</span><span class="nf">strip</span><span class="p">())</span>

        <span class="c1"># 5) 경로/작업 디렉터리 변경
</span>        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">set_paths</span><span class="p">(</span><span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work2/out2</span><span class="sh">"</span><span class="p">],</span> <span class="n">read_paths</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">allow_read_anywhere</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">set_cwd</span><span class="p">(</span><span class="sh">"</span><span class="s">./work2</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">res4</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="sh">"</span><span class="s">open(</span><span class="sh">'</span><span class="s">out2/ok2.txt</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">ok2</span><span class="sh">'</span><span class="s">); print(</span><span class="sh">'</span><span class="s">wrote ok2</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">res4</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">].</span><span class="nf">strip</span><span class="p">())</span>

        <span class="c1"># 6) 종료
</span>        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">==</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">mp</span><span class="p">.</span><span class="nf">freeze_support</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">demo</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 정리</p>

<ol>
  <li>
    <p>커널은 별도 프로세스로 한 번 띄우고 유지한다(spawn). 같은 세션에서의 exec는 같은 globals dict를 재사용하므로 상태가 이어진다.</p>
  </li>
  <li>
    <p>파일·조작·서브프로세스(옵션으로 네트워크) 시도는 감사 훅으로 감시하고, 금지 시도는 어떤 경로/커맨드였는지 stderr에 [AUDIT]로 남긴다.</p>
  </li>
  <li>
    <p>read_paths, write_paths, cwd를 시작 시점에 지정하고, 중간에 set_paths/set_cwd로 변경 가능하다.</p>
  </li>
  <li>
    <p>부모 전역은 spawn 덕분에 기본 노출이 없다. 환경변수는 sanitize_env로 최소화할 수 있다.</p>
  </li>
  <li>
    <p>비동기 호출은 aexec/reset/status 등으로 제공한다. 동시 다발 호출은 락으로 직렬화해 안전하게 처리했다(진짜 병렬을 원하면 응답 매칭 맵과 전용 리더 스레드로 확장).</p>
  </li>
</ol>

<p>이걸 바로 네 vLLM/Agents SDK 툴로 감싸면 “세션 유지형 파이썬 인터프리터”를 깔끔하게 쓸 수 있다.</p>

<p class="chat--user">

좀 헷갈려 code1은 두 번째 open 부분에서 에러가 나잖아? 근데 바로 아래의 Except 코드에서 그걸 잡아야할 것 같은데 이건 returncode 1이 뜨네. 의도한 동작인가

</p>

<p>의도한 동작은 아니다. 그 <code class="language-plaintext highlighter-rouge">returncode=1</code>은 “잡히지 않은 예외가 있었음”을 뜻해. 지금 케이스는 두 번째 금지 쓰기(try/except로 감싼 부분)가 아니라, 그 위의 첫 번째 허용 쓰기 <code class="language-plaintext highlighter-rouge">open("out/ok.txt","w")</code>가 감사 훅에 의해 막혀서 예외가 바깥으로 튄 가능성이 높다.</p>

<p>왜 막히냐면 내가 준 데모에서 <code class="language-plaintext highlighter-rouge">cwd="./work"</code>로 커널을 시작했는데 <code class="language-plaintext highlighter-rouge">write_paths=["./work/out"]</code>를 그대로 넘겼다. 자식은 먼저 <code class="language-plaintext highlighter-rouge">chdir("./work")</code>를 하고, 그 다음에 <code class="language-plaintext highlighter-rouge">write_paths</code>를 realpath로 절대화한다. 상대경로를 현재 작업디렉터리에 붙이니 <code class="language-plaintext highlighter-rouge">./work/out</code> → <code class="language-plaintext highlighter-rouge">/…/work/work/out</code>이 되어 버려서, 실제로 쓰려는 <code class="language-plaintext highlighter-rouge">out/ok.txt</code>(<code class="language-plaintext highlighter-rouge">/…/work/out/ok.txt</code>)와 경로가 불일치한다. 그래서 첫 번째 open이 PermissionError로 실패하고, 그건 try/except로 감싸지 않았으니 rc=1이 된 것.</p>

<p>해결은 둘 중 하나로 깔끔히 끝난다.</p>

<p>옵션 A: 항상 절대경로로 넘기기</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
    <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">)],</span>  <span class="c1"># 절대경로로 넘김
</span>    <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>
    <span class="c1"># ...
</span><span class="p">)</span>
</code></pre></div></div>

<p>옵션 B: 커널 안에서 cwd 기준으로 경로를 정규화하도록 패치<br />
_kernel_proc에서 chdir 한 “직후”에 read/write 경로를 현재 CWD 기준으로 절대화하면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># _kernel_proc 내부, chdir(cwd) 한 다음에 추가
</span><span class="k">def</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lst</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isabs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span> <span class="n">p</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">read_paths</span>  <span class="o">=</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">read_paths</span><span class="p">)</span>
<span class="n">write_paths</span> <span class="o">=</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">write_paths</span><span class="p">)</span>
</code></pre></div></div>

<p>그리고 데모 호출은 이렇게 바꾸면 헷갈림이 없다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
    <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">out</span><span class="sh">"</span><span class="p">],</span>    <span class="c1"># cwd 기준 상대경로
</span>    <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>
    <span class="c1"># ...
</span><span class="p">)</span>
</code></pre></div></div>

<p>점검 팁<br />
stderr에 첫 번째 open에 대한 <code class="language-plaintext highlighter-rouge">[AUDIT] blocked: event=open path=…/work/out/ok.txt …</code>가 찍혀 있으면 내가 설명한 경로 불일치가 원인이다. 위 패치(혹은 절대경로 전달) 이후에는 첫 번째 쓰기가 통과하고, 두 번째 금지 쓰기는 try/except에 잡혀서 <code class="language-plaintext highlighter-rouge">returncode</code>가 0으로 내려간다.</p>

<p class="chat--user">

아 오케이 좀 헷갈린

</p>

<p>괜찮아, 경로가 섞이면 누구나 헷갈려. 핵심만 다시 정리할게.</p>

<p>정리</p>

<ol>
  <li>
    <p>커널 시작 시 cwd를 바꾸면, write_paths 같은 상대경로는 새 cwd 기준으로 절대화해줘야 한다.</p>
  </li>
  <li>
    <p>절대경로로 넘기면 안전하고, 상대경로로 넘기고 싶으면 커널 안에서 chdir 이후에 절대화하면 된다.</p>
  </li>
  <li>
    <p>첫 번째 open이 허용 경로 밖으로 인식되면 try/except에 안 걸린 예외가 떠서 returncode=1이 된다.</p>
  </li>
</ol>

<p>빠른 해결 두 가지<br />
옵션 A: 항상 절대경로로 넘기기</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
    <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">)],</span>
<span class="p">)</span>
</code></pre></div></div>

<p>옵션 B: 커널 내부에서 절대화 패치(권장)<br />
_kernel_proc에서 chdir(cwd) 바로 뒤에 아래 유틸을 넣어주면, 상대경로를 새 cwd 기준으로 정규화해준다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lst</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isabs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">p</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">read_paths</span>  <span class="o">=</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">read_paths</span><span class="p">)</span>
<span class="n">write_paths</span> <span class="o">=</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">write_paths</span><span class="p">)</span>
</code></pre></div></div>

<p>그 다음 시작할 때는 직관적으로</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span> <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">out</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div>

<p>동작 체크</p>

<ol>
  <li>
    <p>첫 실행에서 out/ok.txt 쓰기가 성공해야 하고</p>
  </li>
  <li>
    <p>금지 쓰기 시도는 stderr에 [AUDIT] blocked…가 찍히면서 try/except로 잡혀야 하며</p>
  </li>
  <li>
    <p>returncode는 0으로 내려와야 정상.</p>
  </li>
</ol>

<p>필요하면 위 패치 반영한 전체 파일도 묶어 줄게.</p>

<p class="chat--user">

좋아 이제 PersistentKernel을 이용해서 llm tool calling용 툴을 만들어보자. 단일 코드 실행 -&gt; 일회용 툴 콜링용 세션 유지 세션 코드 실행 -&gt; 세션 유지용 코드 실행

</p>

<p>좋아. PersistentKernel을 그대로 활용해서 “일회성 실행”과 “세션 유지 실행” 두 가지 툴을 바로 쓸 수 있게 묶어준다. 설정(Config)은 서버 코드에서만 하고, LLM에는 절대 노출하지 않는다. LLM이 호출할 수 있는 건 다음 다섯 개뿐이다.</p>

<ol>
  <li>
    <p>python_execute_once(code, timeout_sec?, cwd_rel?)</p>
  </li>
  <li>
    <p>python_session_start(session_id, timeout_sec?, cwd_rel?)</p>
  </li>
  <li>
    <p>python_session_execute(session_id, code, timeout_sec?)</p>
  </li>
  <li>
    <p>python_session_reset(session_id)</p>
  </li>
  <li>
    <p>python_session_shutdown(session_id)</p>
  </li>
</ol>

<p>아래 한 파일로 붙여 넣으면 된다. 이전에 만든 persistent_kernel_async.py가 같은 디렉터리에 있다고 가정한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># persistent_kernel_tools.py
# 요구: Python 3.8+, 같은 폴더에 persistent_kernel_async.py 존재
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="n">persistent_kernel_async</span> <span class="kn">import</span> <span class="n">PersistentKernel</span><span class="p">,</span> <span class="n">run_user_code_mp_async</span>

<span class="c1"># ===================== 서버 전용 정책(LLM 비노출) =====================
# 운영자가 직접 채움. LLM에 노출 금지.
</span><span class="n">READ_PATHS_DEFAULT</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./data_ro</span><span class="sh">"</span><span class="p">)]</span>   <span class="c1"># 읽기 허용 루트(하위 포함)
</span><span class="n">WRITE_PATHS_DEFAULT</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">)]</span>   <span class="c1"># 쓰기 허용 루트(하위 포함)
</span><span class="n">DEFAULT_CWD</span>         <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">)</span>        <span class="c1"># 커널의 시작 CWD
</span><span class="n">BLOCK_SUBPROC</span>       <span class="o">=</span> <span class="bp">True</span>
<span class="n">BLOCK_NET</span>           <span class="o">=</span> <span class="bp">False</span>
<span class="n">SANITIZE_ENV</span>        <span class="o">=</span> <span class="bp">True</span>
<span class="n">ALLOWED_ENV_KEYS</span>    <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">]</span>

<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ===================== 유틸 =====================
</span><span class="k">def</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">paths</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isabs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">p</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cwd_rel</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c1"># 상대 경로는 기본 CWD 기준으로 절대화
</span>    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">))</span>
    <span class="c1"># 안전: 쓰기/읽기 허용 루트들 하위로만
</span>    <span class="n">allowed_roots</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="nf">_abslist</span><span class="p">(</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">+</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">DEFAULT_CWD</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">any</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">target</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">allowed_roots</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">cwd_rel outside allowed roots: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">target</span>

<span class="c1"># ===================== 세션 레지스트리 =====================
</span><span class="k">class</span> <span class="nc">KernelRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PersistentKernel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_locks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_global_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_or_start</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PersistentKernel</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_global_lock</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_locks</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_locks</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_locks</span><span class="p">[</span><span class="n">sid</span><span class="p">]:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="nc">PersistentKernel</span><span class="p">()</span>
                    <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
                        <span class="n">read_paths</span><span class="o">=</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">,</span>
                        <span class="n">write_paths</span><span class="o">=</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">,</span>
                        <span class="n">cwd</span><span class="o">=</span><span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_CWD</span><span class="p">,</span>
                        <span class="n">block_subprocess</span><span class="o">=</span><span class="n">BLOCK_SUBPROC</span><span class="p">,</span>
                        <span class="n">block_network</span><span class="o">=</span><span class="n">BLOCK_NET</span><span class="p">,</span>
                        <span class="n">sanitize_env</span><span class="o">=</span><span class="n">SANITIZE_ENV</span><span class="p">,</span>
                        <span class="n">allowed_env_keys</span><span class="o">=</span><span class="n">ALLOWED_ENV_KEYS</span><span class="p">,</span>
                        <span class="n">startup_timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">return</span> <span class="n">k</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">session not found</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">session not found</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="n">REGISTRY</span> <span class="o">=</span> <span class="nc">KernelRegistry</span><span class="p">()</span>

<span class="c1"># ===================== LLM 툴 구현(핸들러) =====================
# 1) 단일 코드 실행(세션 없음, 즉시 프로세스 생성→실행→종료)
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">cwd_rel</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 선택
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
            <span class="n">code</span><span class="p">,</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">,</span>
            <span class="n">write_paths</span><span class="o">=</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_CWD</span><span class="p">,</span>
            <span class="n">allow_read_anywhere</span><span class="o">=</span><span class="nf">bool</span><span class="p">(</span><span class="ow">not</span> <span class="n">READ_PATHS_DEFAULT</span><span class="p">),</span>  <span class="c1"># 읽기 루트 없으면 어디든 읽기 허용
</span>            <span class="n">timeout_sec</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">block_subprocess</span><span class="o">=</span><span class="n">BLOCK_SUBPROC</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="n">BLOCK_NET</span><span class="p">,</span>
            <span class="n">sanitize_env</span><span class="o">=</span><span class="n">SANITIZE_ENV</span><span class="p">,</span>
            <span class="n">allowed_env_keys</span><span class="o">=</span><span class="n">ALLOWED_ENV_KEYS</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># 2) 세션 시작
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_session_start</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">cwd_rel</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">REGISTRY</span><span class="p">.</span><span class="nf">get_or_start</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="o">=</span><span class="n">cwd_rel</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># 3) 세션 코드 실행
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_session_execute</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">];</span> <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">];</span> <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">k</span> <span class="o">=</span> <span class="k">await</span> <span class="n">REGISTRY</span><span class="p">.</span><span class="nf">get_or_start</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># 4) 세션 리셋
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_session_reset</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">REGISTRY</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

<span class="c1"># 5) 세션 종료
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_session_shutdown</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">REGISTRY</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

<span class="c1"># ===================== 툴 스키마(JSON; LLM에 노출) =====================
</span><span class="n">python_execute_once_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">단일 파이썬 코드 조각을 샌드박스에서 실행하고 stdout/stderr만 반환.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">커널 시작 CWD 기준 상대경로(허용 루트 하위만).</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_start_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_session_start</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">세션 유지형 커널을 시작한다(이미 있으면 성공으로 취급).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">세션 시작 시 상대 CWD(옵션).</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_execute_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_session_execute</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">세션 유지형 커널에서 코드를 실행하고 stdout/stderr를 반환.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_reset_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_session_reset</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">세션의 전역 상태를 지운다(globals 재생성).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_shutdown_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_session_shutdown</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">세션 유지형 커널을 종료한다.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ===================== 동기 어댑터(프레임워크에 맞게 선택적으로 사용) =====================
</span><span class="k">def</span> <span class="nf">run_tool_sync</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">프레임워크가 sync만 지원하면 사용. 내부에서 이벤트 루프를 관리.</span><span class="sh">"""</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_session_start</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_session_start</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_session_execute</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_session_execute</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_session_reset</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_session_reset</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_session_shutdown</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_session_shutdown</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="c1"># 이미 루프가 있다면 상위에서 await하도록 디자인하는 것이 바람직
</span>        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">run_tool_sync called inside event loop</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">RuntimeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">_runner</span><span class="p">())</span>
</code></pre></div></div>

<p>LLM에게 알려줄 사용 규칙(간단)</p>

<ul>
  <li>
    <p>단발 작업이면 python_execute_once를 호출하라. 결과는 returncode/stdout/stderr만 본다.</p>
  </li>
  <li>
    <p>상태를 써야 하면 python_session_start → python_session_execute를 반복 호출하라. 필요하면 python_session_reset으로 상태를 초기화하고, 끝나면 python_session_shutdown으로 닫아라.</p>
  </li>
  <li>
    <p>파일은 서버에서 허용한 폴더 하위에서만 쓸 수 있다. 금지 시도는 stderr에 [AUDIT]로 어떤 경로/연산이 막혔는지 기록된다.</p>
  </li>
  <li>
    <p>cwd_rel은 선택이며, 세션 시작 시 한 번만 지정하는 걸 권장한다.</p>
  </li>
</ul>

<p>프레임워크에 연결</p>

<ul>
  <li>
    <p>OpenAI Agents SDK나 vLLM function-calling에는 위 “tool 스키마”들(python_execute_once_tool 등)을 등록한다.</p>
  </li>
  <li>
    <p>툴 콜이 들어오면 name과 arguments를 받아서 run_tool_sync(name, args)로 돌린 결과를 다시 LLM에게 전달하면 된다.</p>
  </li>
</ul>

<p>경로 혼동 방지 팁</p>

<ul>
  <li>
    <p>운영자가 READ_PATHS_DEFAULT/WRITE_PATHS_DEFAULT/DEFAULT_CWD를 절대경로로 채워두면 가장 깔끔하다.</p>
  </li>
  <li>
    <p>cwd_rel은 DEFAULT_CWD 기준 상대경로로만 받고, 허용 루트(READ/WRITE/DEFAULT_CWD) 하위가 아니면 거부한다.</p>
  </li>
</ul>

<p>이렇게 붙이면 “일회성 실행”과 “기억 유지 커널 실행”을 같은 정책 아래에서 깔끔하게 제공할 수 있다.</p>

<p class="chat--user">

그런 의문은 좀 있어. 세션을 유지하는게 필요할까?

</p>

<p>좋은 의문이야. “세션 유지형 커널(지속 프로세스)”이 정말 필요한가를 용도별로 딱 갈라보자.</p>

<ol>
  <li>세션이 주는 이득</li>
</ol>

<ul>
  <li>
    <p>반복 비용 절감: 큰 데이터·모델·라이브러리를 한 번 로드하고 계속 씀. 예) 1 GB 벡터 DB, 대형 ML 모델, 느린 초기화가 있는 툴.</p>
  </li>
  <li>
    <p>탐색형 작업: 한 번 만든 변수·함수를 이어가며 점진적으로 코드를 보강. EDA, 시뮬레이션, 디버깅 루프에 유리.</p>
  </li>
  <li>
    <p>도구의 워밍업 유지: JIT 컴파일, 캐시(토큰화 캐시, 정규식 컴파일 등)를 다시 안 해도 됨.</p>
  </li>
  <li>
    <p>인터랙티브 UX: “방금 만든 df를 그래프로 바꿔” 같은 후속 명령이 자연스러움.</p>
  </li>
</ul>

<ol>
  <li>세션의 비용·리스크</li>
</ol>

<ul>
  <li>
    <p>재현성 하락: 숨은 상태 때문에 같은 코드가 매번 동일하게 안 돌 수도 있음.</p>
  </li>
  <li>
    <p>메모리 누수/오염: LLM이 만든 전역이 쌓이다가 성능 저하. 상태 “독”이 남으면 계속 실패.</p>
  </li>
  <li>
    <p>보안·통제 어려움: 상태가 길게 남을수록 정책 위반 탐지가 늦어짐. 세션별 CWD/경로 정책을 늘 점검해야 함.</p>
  </li>
  <li>
    <p>운영 부담: 세션 수명, TTL, 정리 시점, 동시성, 장애 복구 등을 관리해야 함.</p>
  </li>
</ul>

<ol>
  <li>결론 요약: 전형적인 선택 기준</li>
</ol>

<ul>
  <li>
    <p>일회성 계산·변환·리포트처럼 “같은 입력 → 같은 출력”이면 세션 불필요(일회용 실행 권장).</p>
  </li>
  <li>
    <p>대용량 초기화가 반복되거나, 다단계 실험·EDA처럼 “맥락을 잇는” 흐름이면 세션이 이득.</p>
  </li>
  <li>
    <p>둘 다 쓰고, 기본값은 일회용. 다음 조건이면 자동으로 세션으로 승격하는 전략이 깔끔함.</p>

    <ul>
      <li>
        <p>연속 호출 간 같은 사용자·같은 작업 스레드에서 2회 이상 후속 지시가 들어옴.</p>
      </li>
      <li>
        <p>코드가 “앞에서 만든 객체/파일/변수”를 참조.</p>
      </li>
      <li>
        <p>초기화 비용이 임계치(예: 300 ms 또는 메모리 200 MB 이상) 넘는 라이브러리 감지.</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>현실적인 운영 권장안</li>
</ol>

<ul>
  <li>
    <p>기본: python_execute_once만 사용. 빠르고 재현성 높음.</p>
  </li>
  <li>
    <p>필요 시만 세션: python_session_start/execute를 노출하되, 서버 정책으로 아래처럼 안전 레일을 깐다.</p>

    <ul>
      <li>
        <p>idle_timeout(예: 5분), hard_ttl(예: 30분), max_sessions_per_user(예: 2).</p>
      </li>
      <li>
        <p>세션당 메모리·파일 크기 rlimit, 쓰기 경로는 write_paths만.</p>
      </li>
      <li>
        <p>reset과 shutdown을 LLM에 명시적으로 가르치고, 실패 시 자동 reset.</p>
      </li>
      <li>
        <p>로그에 [AUDIT] 라인(막힌 파일·커맨드·사유)과 리소스 사용량을 함께 남김.</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>“세션 없이도 기억하기” 대안</li>
</ol>

<ul>
  <li>
    <p>파일 기반 상태: 일회용 실행마다 허용된 write_paths에만 아티팩트(.npz/.parquet/.pt) 저장 → 다음 호출에서 경로만 넘겨 재사용. 세션 없이도 80%의 “기억”을 충족.</p>
  </li>
  <li>
    <p>선택 직렬화: 매우 제한된 화이트리스트 타입만 자동 저장/복원(dict[str→ndarray/DataFrame/float/int])해서 “의미 있는 최소 상태”만 이어 받기. 프로세스는 매번 새로 띄워 재현성 유지.</p>
  </li>
</ul>

<ol>
  <li>적용 팁(당장 쓸 설정)</li>
</ol>

<ul>
  <li>
    <p>오늘 구조에서 기본값을 이렇게 두면 균형이 좋다.</p>

    <ul>
      <li>
        <p>default_mode=“once”, session_mode는 명시 opt-in</p>
      </li>
      <li>
        <p>session idle_timeout=300s, hard_ttl=1800s</p>
      </li>
      <li>
        <p>state persistence는 “파일로만” 허용(피클 전역 저장은 금지)</p>
      </li>
      <li>
        <p>read_paths는 넉넉히, write_paths는 최소로</p>
      </li>
      <li>
        <p>네트워크 차단 기본 On, 필요 시만 임시 해제</p>
      </li>
    </ul>
  </li>
</ul>

<p>요약하면, 세션은 “속도와 편의”를 사고 “재현성과 단순성”을 판다. LLM 에이전트에서 실수 방지가 우선이면 일회용을 기본으로, 대형 초기화나 인터랙티브 루프가 필요할 때만 세션을 열고 TTL·리밋으로 다스리는 하이브리드가 가장 안정적이다. 다음 단계로는 너의 툴 레이어에서 기본을 once로 두고, 특정 규칙에 맞으면 session_start를 자동 제안하도록 넣으면 된다.</p>

<p class="chat--user">

일단 툴로는 일회용 세션만 지원해보자

</p>

<p>좋아. “일회용 세션만” 지원하는 LLM 툴을 깔끔하게 정리했다. 설정은 서버 쪽에만 두고, LLM에는 오직 코드와 타임아웃(+선택적 cwd 상대경로)만 노출한다. 파일/서브프로세스(옵션으로 네트워크)는 감사 훅으로 제어하고, 차단 사유를 stderr에 구체적으로 남긴다.</p>

<p>아래 파일 하나로 끝난다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># oneoff_tool.py
# Python 3.8+ / 외부 의존성 없음
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">contextlib</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="c1"># ============== 서버측 정책(LLM 비노출) ==============
</span><span class="n">READ_PATHS_DEFAULT</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./data_ro</span><span class="sh">"</span><span class="p">)]</span>    <span class="c1"># 읽기 허용 루트(하위 포함). []면 어디든 읽기 허용
</span><span class="n">WRITE_PATHS_DEFAULT</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">)]</span>    <span class="c1"># 쓰기 허용 루트(하위 포함). []면 전부 차단
</span><span class="n">DEFAULT_CWD</span>         <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">)</span>         <span class="c1"># 시작 작업 디렉터리
</span><span class="n">BLOCK_SUBPROC</span>       <span class="o">=</span> <span class="bp">True</span>                              <span class="c1"># 서브프로세스 차단
</span><span class="n">BLOCK_NET</span>           <span class="o">=</span> <span class="bp">False</span>                             <span class="c1"># 필요 시 True
</span><span class="n">SANITIZE_ENV</span>        <span class="o">=</span> <span class="bp">True</span>                              <span class="c1"># 환경변수 최소화
</span><span class="n">ALLOWED_ENV_KEYS</span>    <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">]</span>

<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">WRITE_PATHS_DEFAULT</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ============== 내부: 감사 훅 설치 ==============
</span><span class="k">def</span> <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                   <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>

    <span class="k">def</span> <span class="nf">_real</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">path</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> flags=</span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s"> reason=write-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">write</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">allow_read_anywhere</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">rp</span> <span class="o">+</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=read-not-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">_under_any</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">wp</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> src=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="si">}</span><span class="s"> dst=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s"> reason=subprocess-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> reason=network-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

<span class="c1"># ============== 내부: 자식 워커(일회용) ==============
</span><span class="k">def</span> <span class="nf">_child_once_worker</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                       <span class="n">result_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">stdout_buf</span><span class="p">,</span> <span class="n">stderr_buf</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(),</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">()</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sanitize_env</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allowed_env_keys</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>

        <span class="c1"># 옵션: 리소스 한도
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="n">resource</span>
            <span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] sandbox init/exec failed: </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">result_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">()})</span>

<span class="k">def</span> <span class="nf">_run_once_blocking</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nf">get_context</span><span class="p">(</span><span class="sh">"</span><span class="s">spawn</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># 부모 전역 노출 방지
</span>    <span class="n">q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_child_once_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="p">,</span> <span class="n">sanitize_env</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">,</span> <span class="n">q</span>
    <span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">.</span><span class="nf">empty</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] child exited unexpectedly</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout_sec</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">();</span> <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">124</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">();</span> <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] no result</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ============== 공개 API: 일회용 실행(비동기) ==============
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_once_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    별도 프로세스에서 코드 조각을 한 번 실행하고 stdout/stderr만 반환.
    - cwd_rel: DEFAULT_CWD 기준 상대경로. 허용 루트 밖이면 거부.
    </span><span class="sh">"""</span>
    <span class="c1"># cwd 결정 및 경로 정규화
</span>    <span class="n">allowed_roots</span> <span class="o">=</span> <span class="nf">set</span><span class="p">([</span><span class="n">DEFAULT_CWD</span><span class="p">]</span> <span class="o">+</span> <span class="n">READ_PATHS_DEFAULT</span> <span class="o">+</span> <span class="n">WRITE_PATHS_DEFAULT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cwd_rel</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">any</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">target</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">allowed_roots</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] cwd_rel outside allowed roots: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">target</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">DEFAULT_CWD</span>

    <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">_run_once_blocking</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">READ_PATHS_DEFAULT</span><span class="p">,</span>
        <span class="n">WRITE_PATHS_DEFAULT</span><span class="p">,</span>
        <span class="n">cwd</span><span class="p">,</span>
        <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">timeout_sec</span><span class="p">,</span>
        <span class="n">BLOCK_SUBPROC</span><span class="p">,</span>
        <span class="n">BLOCK_NET</span><span class="p">,</span>
        <span class="n">SANITIZE_ENV</span><span class="p">,</span>
        <span class="n">ALLOWED_ENV_KEYS</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># ============== LLM 툴 스키마와 핸들러 ==============
</span><span class="n">python_execute_once_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">일회성 파이썬 코드 조각을 샌드박스에서 실행하고 stdout/stderr만 반환합니다.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">기본 작업 디렉터리(DEFAULT_CWD) 기준 상대경로</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">run_user_code_once_async</span><span class="p">(</span>
            <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="n">cwd_rel</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">timeout_sec</span><span class="o">=</span><span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># 동기 어댑터(프레임워크가 sync만 지원할 때 선택)
</span><span class="k">def</span> <span class="nf">run_tool_sync</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">unknown tool</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">run_tool_sync called in running loop</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">RuntimeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">_runner</span><span class="p">())</span>
</code></pre></div></div>

<p>연결 방법 요약</p>

<ol>
  <li>
    <p>서버에서 READ_PATHS_DEFAULT, WRITE_PATHS_DEFAULT, DEFAULT_CWD 등 정책만 세팅한다. 이 값들은 LLM에 절대 노출하지 않는다.</p>
  </li>
  <li>
    <p>에이전트 런타임에 툴 정의로 python_execute_once_tool을 등록한다.</p>
  </li>
  <li>
    <p>툴 콜이 들어오면 tool_python_execute_once를 await해서 결과 딕셔너리(returncode/stdout/stderr)를 모델에 재피드한다.</p>
  </li>
  <li>
    <p>경로 혼동을 막으려면 정책 경로들은 애초에 절대경로로 두는 게 가장 깔끔하고, LLM에는 cwd_rel만 선택적으로 허용한다.</p>
  </li>
</ol>

<p>운용 팁</p>

<ul>
  <li>
    <p>금지된 파일·연산·커맨드는 stderr에 [AUDIT] 라인으로 이유와 함께 남는다.</p>
  </li>
  <li>
    <p>대량 병렬이 필요하면 _run_once_blocking을 ProcessPoolExecutor로 바꾸거나 동시 실행 세마포어만 얹으면 된다.</p>
  </li>
  <li>
    <p>나중에 세션형이 필요해지면, 이 구조 위에 PersistentKernel을 얹어도 인터페이스는 바뀌지 않는다.</p>
  </li>
</ul>

<p class="chat--user">

기존 만든 PersistentKernel은 활용하는게 좋을거 같은데

</p>

<p>좋아. “일회용 툴만 지원”은 유지하되, 내부 엔진은 PersistentKernel을 그대로 써서 실행-정리까지 한 번에 태우는 래퍼를 만들자. 나중에 세션형으로 확장할 때 바뀌는 건 툴 바인딩이 아니라 정책뿐이 되도록.</p>

<p>아래 파일 하나로 끝난다. 핵심은 EphemeralKernelRunner.run_once가 PersistentKernel을 즉시 띄우고(a.start), 코드 실행(aexec), 결과 회수 후 즉시 종료(shutdown)하는 패턴이다. 상단의 READ_PATHS_DEFAULT/WRITE_PATHS_DEFAULT/DEFAULT_CWD만 운영자가 세팅하고, LLM에는 code, timeout_sec, cwd_rel만 노출한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># oneoff_with_persistent_kernel.py
# 요구: Python 3.8+, 같은 폴더에 persistent_kernel_async.py가 있어야 함
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="n">persistent_kernel_async</span> <span class="kn">import</span> <span class="n">PersistentKernel</span>  <span class="c1"># 앞서 만든 커널 구현
</span>
<span class="c1"># ===================== 서버 정책(LLM 비노출) =====================
</span><span class="n">READ_PATHS_DEFAULT</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./data_ro</span><span class="sh">"</span><span class="p">)]</span>   <span class="c1"># 읽기 허용 루트(하위 포함). []면 어디든 읽기 허용
</span><span class="n">WRITE_PATHS_DEFAULT</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">)]</span>   <span class="c1"># 쓰기 허용 루트(하위 포함). []면 전부 차단
</span><span class="n">DEFAULT_CWD</span>         <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">)</span>        <span class="c1"># 커널 시작 CWD
</span><span class="n">BLOCK_SUBPROC</span>       <span class="o">=</span> <span class="bp">True</span>
<span class="n">BLOCK_NET</span>           <span class="o">=</span> <span class="bp">False</span>
<span class="n">SANITIZE_ENV</span>        <span class="o">=</span> <span class="bp">True</span>
<span class="n">ALLOWED_ENV_KEYS</span>    <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">]</span>

<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">WRITE_PATHS_DEFAULT</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isabs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">p</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cwd_rel</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">))</span>
    <span class="n">allowed_roots</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="nf">_abslist</span><span class="p">(</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">+</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">DEFAULT_CWD</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">any</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">target</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">allowed_roots</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">cwd_rel outside allowed roots: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">target</span>

<span class="c1"># ===================== 일회용 실행 러너 =====================
</span><span class="k">class</span> <span class="nc">EphemeralKernelRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nc">PersistentKernel</span><span class="p">()</span>
        <span class="c1"># 커널 시작: 여기서 세션은 만들어지지만 이 호출 안에서만 쓰고 곧바로 종료한다.
</span>        <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">,</span>
            <span class="n">write_paths</span><span class="o">=</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_CWD</span><span class="p">,</span>
            <span class="n">allow_read_anywhere</span><span class="o">=</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">block_subprocess</span><span class="o">=</span><span class="n">BLOCK_SUBPROC</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="n">BLOCK_NET</span><span class="p">,</span>
            <span class="n">sanitize_env</span><span class="o">=</span><span class="n">SANITIZE_ENV</span><span class="p">,</span>
            <span class="n">allowed_env_keys</span><span class="o">=</span><span class="n">ALLOWED_ENV_KEYS</span><span class="p">,</span>
            <span class="n">startup_timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 코드 실행
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
            <span class="c1"># res = {"returncode": int, "stdout": str, "stderr": str}
</span>            <span class="k">return</span> <span class="n">res</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># 항상 종료(세션 유지 없음)
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c1"># ===================== LLM 툴 스키마 및 핸들러 =====================
</span><span class="n">python_execute_once_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">일회성 파이썬 코드 조각을 PersistentKernel 기반 샌드박스에서 실행하고 stdout/stderr만 반환합니다.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">기본 작업 디렉터리(DEFAULT_CWD) 기준 상대경로(허용 루트 밖이면 거부).</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">_runner</span> <span class="o">=</span> <span class="nc">EphemeralKernelRunner</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">cwd_rel</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">_runner</span><span class="p">.</span><span class="nf">run_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="o">=</span><span class="n">cwd_rel</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># 동기 어댑터(프레임워크가 sync만 지원할 때 선택)
</span><span class="k">def</span> <span class="nf">run_tool_sync</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner_main</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">run_tool_sync called inside event loop</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">RuntimeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">_runner_main</span><span class="p">())</span>

<span class="c1"># =============== 간단 데모 ===============
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">demo</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">CWD:</span><span class="sh">"</span><span class="s">, os.getcwd())
open(</span><span class="sh">"</span><span class="s">out_demo.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)  # WRITE_PATHS_DEFAULT 하위여야 통과
try:
    subprocess.check_output([</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">hi</span><span class="sh">"</span><span class="s">])
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked subproc:</span><span class="sh">"</span><span class="s">, type(e).__name__)
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="c1"># 데모용: write_paths에 DEFAULT_CWD를 넣었거나, DEFAULT_CWD/out_demo.txt가 WRITE_PATHS_DEFAULT 안에 있어야 함
</span>        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">tool_python_execute_once</span><span class="p">({</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="n">demo</span><span class="p">,</span> <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">})</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">==</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
        <span class="n">mp</span><span class="p">.</span><span class="nf">freeze_support</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>동작 흐름 요약</p>

<ol>
  <li>
    <p>LLM이 python_execute_once를 호출하면 EphemeralKernelRunner가 PersistentKernel을 즉시 띄운다.</p>
  </li>
  <li>
    <p>커널은 감사 훅이 설치된 샌드박스 상태로 code를 exec하고 stdout/stderr만 반환한다.</p>
  </li>
  <li>
    <p>실행 직후 반드시 shutdown하므로 세션은 남지 않는다. 세션 유지가 필요해지면 이 러너 대신 아까 만든 PersistentKernel 툴셋을 그대로 노출하면 된다.</p>
  </li>
</ol>

<p>경로 혼동 방지 팁<br />
DEFAULT_CWD, READ_PATHS_DEFAULT, WRITE_PATHS_DEFAULT는 모두 절대경로로 두는 게 가장 깔끔하다. LLM에 노출되는 cwd_rel은 DEFAULT_CWD 기준 상대경로만 받으며, 허용 루트 밖이면 거부한다.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">vLLM에 pdf 넣는법</title><link href="https://hvppyarchive.github.io/llm/vllm-pdf/" rel="alternate" type="text/html" title="vLLM에 pdf 넣는법" /><published>2025-11-04T14:13:34+09:00</published><updated>2025-11-04T14:13:34+09:00</updated><id>https://hvppyarchive.github.io/llm/vllm-pdf</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/vllm-pdf/"><![CDATA[<p class="chat--user">

vllm 서빙하는 모델 gptoss에 pdf 넣는법

</p>

<p>요약 먼저: vLLM으로 서빙 중인 gpt-oss는 “PDF 파일을 직접 넣어 처리”하는 인터페이스가 없습니다. vLLM OpenAI 호환 서버는 텍스트/토큰 스트림을 받는 API이고, gpt-oss는 공개된 가이드 기준 텍스트 전용 모델이라서(이미지·PDF 업로드 파라미터 없음) PDF는 사전 전처리(텍스트 추출→청소→청크→검색/RAG)로 넣어야 합니다. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai+4</a></p>

<p>아래는 “PDF를 gpt-oss(vLLM 서버)로 넣는” 가장 흔한 구현 레시피입니다. 단계별로 그대로 따라하면 됩니다.</p>

<ol>
  <li>vLLM 서버로 gpt-oss 띄우기</li>
</ol>

<ul>
  <li>CUDA 환경에서 예시:</li>
</ul>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">pip</span> <span class="nt">install</span> <span class="nt">vllm</span>
<span class="nt">python</span> <span class="nt">-m</span> <span class="nt">vllm</span><span class="nc">.entrypoints.openai.api_server</span> <span class="err">\</span>
  <span class="nt">--model</span> <span class="nt">openai</span><span class="o">/</span><span class="nt">gpt-oss-20b</span> <span class="err">\</span>
  <span class="nt">--max-model-len</span> <span class="err">32768</span> <span class="err">\</span>
  <span class="nt">--port</span> <span class="err">8000</span>
</code></pre></div></div>

<p>서버는 OpenAI 호환 Chat/Completions 엔드포인트를 제공합니다. 기본적으로 파일 업로드 필드는 없고 문자열 프롬프트만 받습니다. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai</a></p>

<ol>
  <li>PDF → 텍스트 추출</li>
</ol>

<ul>
  <li>
    <p>Python 도구 예: pypdf, pdfminer.six, unstructured, docling 등.</p>
  </li>
  <li>
    <p>표·머리글·각주가 섞여 있으면 docling/Unstructured 계열이 품질이 더 낫습니다. 추출 후 다음을 꼭 하세요.<br />
• 페이지 헤더/푸터 제거, 공백 정규화, 본문 병합<br />
• 너무 긴 표는 CSV로 따로 저장(필요시)<br />
관련 이슈와 파이프라인 선택은 커뮤니티/라이브러리 이슈를 참고하세요. <a href="https://github.com/docling-project/docling/issues/1365?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<ol>
  <li>청크 나누기</li>
</ol>

<ul>
  <li>
    <p>800~1500자(또는 200~400 토큰) 단위로 자르고, 문단 경계를 최대한 유지합니다.</p>
  </li>
  <li>
    <p>각 청크에 원문 페이지/섹션 메타데이터를 붙입니다.</p>
  </li>
</ul>

<ol>
  <li>임베딩 생성 → 벡터DB 적재</li>
</ol>

<ul>
  <li>
    <p>임베딩 모델(예: bge-m3, jina-embeddings, sentence-transformers 등)로 각 청크를 벡터화하고, FAISS/Chroma/PGVector에 넣습니다.</p>
  </li>
  <li>
    <p>이 단계는 LLM(gpt-oss/vLLM)과 분리된 별도 과정입니다. vLLM 자체는 임베딩을 만들지 않습니다. RAG 패턴 예시는 다수의 vLLM 배포 예제에서도 동일합니다. <a href="https://validatedpatterns.io/patterns/rag-llm-gitops/?utm_source=chatgpt.com">validatedpatterns.io+1</a></p>
  </li>
</ul>

<ol>
  <li>질의 시 검색(RAG) → 프롬프트 구성 → vLLM에 전달</li>
</ol>

<ul>
  <li>
    <p>유저 질문을 벡터 검색으로 top-k 청크와 매칭</p>
  </li>
  <li>
    <p>아래 System/Assistant 컨텍스트에 “검색 결과”를 넣고, gpt-oss의 권장 포맷(하모니 포맷)을 지키며 요청을 보냅니다. gpt-oss는 OpenAI 호환 서버에서 잘 동작하도록 가이드가 있습니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm?utm_source=chatgpt.com">cookbook.openai.com+1</a></p>
  </li>
</ul>

<p>실전 코드 스니펫</p>

<p>A. PDF 텍스트 추출/청크(간단 예시)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pypdf</span> <span class="kn">import</span> <span class="n">PdfReader</span>

<span class="k">def</span> <span class="nf">extract_pdf_text</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="nc">PdfReader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">pages</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">extract_text</span><span class="p">()</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="n">pages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">())})</span>
    <span class="k">return</span> <span class="n">pages</span>

<span class="k">def</span> <span class="nf">chunk_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_chars</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">start</span> <span class="o">+</span> <span class="n">max_chars</span><span class="p">)</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">overlap</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">pages</span> <span class="o">=</span> <span class="nf">extract_pdf_text</span><span class="p">(</span><span class="sh">"</span><span class="s">sample.pdf</span><span class="sh">"</span><span class="p">)</span>
<span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">chunk_text</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">page</span><span class="p">[</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">})</span>
</code></pre></div></div>

<p>B. 임베딩→FAISS 적재(예시: sentence-transformers)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">import</span> <span class="n">faiss</span><span class="p">,</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">SentenceTransformer</span><span class="p">(</span><span class="sh">"</span><span class="s">sentence-transformers/all-MiniLM-L6-v2</span><span class="sh">"</span><span class="p">)</span>
<span class="n">emb</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">encode</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">],</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="p">.</span><span class="nc">IndexFlatIP</span><span class="p">(</span><span class="n">emb</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">index</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>
</code></pre></div></div>

<p>C. 검색→vLLM(gpt-oss) 호출(OpenAI 호환)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span><span class="p">,</span> <span class="n">requests</span><span class="p">,</span> <span class="n">json</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">encode</span><span class="p">([</span><span class="n">query</span><span class="p">],</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">scores</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">topk</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">ctx</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[p.</span><span class="si">{</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">]</span><span class="se">\n</span><span class="si">{</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ask_vllm</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">You are a helpful assistant. Use the provided CONTEXT; if missing, say you don</span><span class="sh">'</span><span class="s">t know.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sa">f</span><span class="sh">"</span><span class="s">CONTEXT:</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n\n</span><span class="s">QUESTION:</span><span class="se">\n</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">http://localhost:8000/v1/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">},</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">openai/gpt-oss-20b</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span><span class="n">messages</span><span class="p">,</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span><span class="mf">0.2</span><span class="p">})</span>
    <span class="p">).</span><span class="nf">json</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">ask_vllm</span><span class="p">(</span><span class="sh">"</span><span class="s">이 PDF에서 반품 정책 핵심 요약해줘</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>D. curl로 간단 테스트</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">curl</span> <span class="nv">http</span><span class="p">:</span><span class="c1">//localhost:8000/v1/chat/completions \</span>
  <span class="o">-</span><span class="kt">H</span> <span class="s">"Content-Type: application/json"</span> <span class="p">\</span>
  <span class="o">-</span><span class="n">d</span> <span class="err">'</span><span class="p">{</span>
    <span class="s">"model"</span><span class="p">:</span> <span class="s">"openai/gpt-oss-20b"</span><span class="p">,</span>
    <span class="s">"messages"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="s">"role"</span><span class="p">:</span><span class="s">"system"</span><span class="p">,</span><span class="s">"content"</span><span class="p">:</span><span class="s">"Answer using the context."</span><span class="p">},</span>
      <span class="p">{</span><span class="s">"role"</span><span class="p">:</span><span class="s">"user"</span><span class="p">,</span><span class="s">"content"</span><span class="p">:</span><span class="s">"CONTEXT:</span><span class="se">\n</span><span class="s">&lt;여기에 검색으로 모은 PDF 청크&gt;</span><span class="se">\n\n</span><span class="s">QUESTION:</span><span class="se">\n</span><span class="s">요약해줘"</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">0.2</span>
  <span class="p">}</span><span class="err">'</span>
</code></pre></div></div>

<p>자주 묻는 포인트</p>

<ul>
  <li>
    <p>왜 PDF 파일 자체를 바로 못 넣나?<br />
vLLM의 OpenAI 호환 서버는 파일 업로드/스토리지 기능이 아니라 텍스트 프롬프트 API입니다. 즉, 파일은 애플리케이션 레이어에서 처리해서 텍스트(또는 검색된 컨텍스트)로 바꾼 다음 모델에 넣어야 합니다. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai</a></p>
  </li>
  <li>
    <p>gpt-oss가 PDF나 이미지까지 직접 읽는 멀티모달인가?<br />
공개 가이드 기준 gpt-oss는 텍스트 중심의 오픈 웨이트 패밀리로 소개되었습니다. 멀티모달 입력을 직접 받는 형태가 아니라, 텍스트로 컨텍스트를 주는 방식이 표준입니다. <a href="https://openai.com/index/introducing-gpt-oss/?utm_source=chatgpt.com">OpenAI+2</a></p>
  </li>
  <li>
    <p>“PDF 질의응답” 정밀도를 더 높이려면?<br />
청크 크기/오버랩 최적화, 표/코드 블록 보존, 섹션별 재순위화(re-ranking), “출처 페이지 표시”를 프롬프트에 강제, 그리고 답변 근거를 따로 출력하도록 규칙을 넣으면 품질이 안정됩니다. vLLM 레시피/쿠크북의 gpt-oss 운영 가이드도 함께 보세요. <a href="https://docs.vllm.ai/projects/recipes/en/latest/OpenAI/GPT-OSS.html?utm_source=chatgpt.com">docs.vllm.ai+1</a></p>
  </li>
</ul>

<p>한 줄 정리: vLLM+gpt-oss로 PDF를 “넣는” 것은 PDF를 텍스트로 전처리하고, 검색 기반(RAG)으로 관련 청크를 추려 OpenAI 호환 API에 문자열로 보내는 것입니다. 이 흐름을 코드와 같이 구성하면 바로 운영에 올릴 수 있습니다.</p>

<p class="chat--user">

openai agent 라는 패키지가 있는데 여기에 그런 레이어가 포함되어있나?

</p>

<p>짧은 결론부터 말하면, “openai agent”로 알려진 OpenAI Agents SDK는 에이전트 오케스트레이션(툴 호출, 세션/메모리, 핸드오프, 가드레일 등)을 제공하지만 PDF 파싱·청크·임베딩·벡터스토어 적재 같은 “문서 RAG 인입 레이어”는 기본 내장되어 있지 않습니다. 다만 OpenAI 모델을 쓸 때는 호스티드 도구(FileSearchTool 등)를 통해 OpenAI Vector Stores에 올려둔 문서를 검색하는 방식은 지원합니다. 자체 vLLM+gpt-oss로 돌릴 때는 그 레이어를 직접 붙여야 합니다. <a href="https://openai.github.io/openai-agents-python/">openai.github.io+1</a></p>

<p>핵심 포인트를 정리하면 아래와 같습니다.</p>

<ol>
  <li>
    <p>SDK가 해주는 일<br />
에이전트 루프, 함수툴(FunctionTool), 세션/트레이싱, 핸드오프, MCP(Model Context Protocol) 연결 등 “오케스트레이션”이 주역할입니다. PDF를 읽어 텍스트로 만들고 임베딩을 뽑아 벡터DB에 적재하는 파이프라인은 앱 쪽에서 구성해야 합니다. <a href="https://openai.github.io/openai-agents-python/">openai.github.io+1</a></p>
  </li>
  <li>
    <p>OpenAI 호스티드 도구가 있을 때<br />
OpenAI Responses 모델을 쓰면 FileSearchTool, WebSearchTool, Code Interpreter 같은 “호스티드 툴”을 바로 붙일 수 있습니다. 이 경우 PDF는 OpenAI Vector Stores API로 업로드·처리하고, 에이전트는 FileSearchTool로 검색합니다. SDK 자체가 PDF를 파싱해주진 않고, 벡터스토어도 OpenAI 쪽 리소스를 이용하는 구성입니다. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io</a></p>
  </li>
  <li>
    <p>gpt-oss(+vLLM)와 함께 쓰는 경우<br />
vLLM의 OpenAI-호환 엔드포인트로 에이전트의 모델 클라이언트를 바꿔치기 할 수 있습니다. 다만 이때는 OpenAI 호스티드 도구(FileSearchTool 등)가 그대로 동작하지 않거나 전제가 바뀌므로, 직접 함수툴로 “검색/RAG”를 구현하거나 MCP 서버(자체 문서 검색 서버)를 붙여서 문서 검색을 노출하는 패턴이 일반적입니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm?utm_source=chatgpt.com">cookbook.openai.com+2</a></p>
  </li>
  <li>
    <p>최소 구현 스케치</p>
  </li>
</ol>

<ul>
  <li>
    <p>PDF 인입: pypdf/unstructured로 텍스트 추출 → 청크 → 임베딩(bge/jina/sentence-transformers) → FAISS/Chroma 적재</p>
  </li>
  <li>
    <p>에이전트 툴: search(query) 같은 Python 함수툴을 정의해 top-k 청크를 반환하도록 구현</p>
  </li>
  <li>
    <p>에이전트: Agent(tools=[search])로 등록, 모델은 vLLM의 Chat Completions/Responses 호환 엔드포인트로 지정</p>
  </li>
  <li>
    <p>OpenAI 모델로 바꿀 때만 FileSearchTool을 사용해 OpenAI Vector Store를 조회 가능<br />
이 구성은 SDK 문서의 “Tools”, “Context management”, “MCP” 섹션 흐름과 딱 맞습니다. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io+2</a></p>
  </li>
</ul>

<ol>
  <li>이름 혼동 주의<br />
Assistants API는 Responses API로 대체되는 흐름이며, Agents SDK는 이 Responses 기반에서 돌아갑니다. 최신 가이드와 레퍼런스를 참고해서 구성하세요. <a href="https://www.reuters.com/technology/artificial-intelligence/openai-launches-new-developer-tools-chinese-ai-startups-gain-ground-2025-03-11/?utm_source=chatgpt.com">reuters.com+1</a></li>
</ol>

<p>정리</p>

<ul>
  <li>포함되어 있는가? 에이전트 오케스트레이션은 포함, “PDF→RAG 인입 레이어”는 미포함. OpenAI 모델일 때만 FileSearchTool로 OpenAI Vector Stores를 조회할 수 있음. vLLM+gpt-oss에서는 직접 함수툴이나 MCP로 붙여야 합니다. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io+1</a></li>
</ul>

<p>원하시면 지금 쓰시는 vLLM 서버 주소와 선호 임베딩/벡터DB를 가정해, Agents SDK용 최소 예제(함수툴 기반 검색 + vLLM 연결) 스니펫을 바로 만들어 드립니다.</p>

<p class="chat--user">

openai vector store는 어떤식으로 구성되어있어?

</p>

<p>좋아요 — “OpenAI Vector Store”가 대체로 어떻게 구성되어 있는지(=아키텍처, 주요 컴포넌트, API 흐름) 같이 살펴봅시다. (약간 기술적이긴 하지만, 전체 그림을 이해하면 이후 구현할 때 훨씬 수월해요.)</p>

<hr />

<h2 id="1-기본-개념">1. 기본 개념</h2>

<p>Vector Store는 간단히 말해 “문서/청크(텍스트 단위)를 임베딩 벡터로 변환해 저장하고, 이후 검색 가능하도록 조회하는 저장소”입니다. OpenAI 쪽에서 제공하는 API는 문서를 업로드 → 임베딩/청크화(내부 처리) → 벡터저장소 생성 및 파일 바인딩 → 검색 질의(Query) → 관련 청크 반환하는 흐름을 지원합니다. <a href="https://platform.openai.com/docs/assistants/tools/file-search/vector-stores?utm_source=chatgpt.com">platform.openai.com+3</a></p>

<p>즉, 내부적으로는 다음 요소들이 있습니다:</p>

<ul>
  <li>
    <p>문서 파일(예: PDF, 텍스트) 업로드 및 처리된 파일 배치(file batch)</p>
  </li>
  <li>
    <p>벡터 변환(임베딩) + 청크(metadata 포함)</p>
  </li>
  <li>
    <p>저장소(Vector store) 객체: 여러 파일/청크들을 묶음</p>
  </li>
  <li>
    <p>검색 API: 벡터 유사도 기반 조회 → 반환된 청크와 메타정보</p>
  </li>
</ul>

<hr />

<h2 id="2-openai-api-상의-구성-요소">2. OpenAI API 상의 구성 요소</h2>

<p>OpenAI 문서를 기준으로 주요 리소스(resource)들이 어떻게 연결되는지요:</p>

<ul>
  <li>
    <p><strong>Vector Store 리소스</strong> : <code class="language-plaintext highlighter-rouge">/v1/vector_stores</code> 엔드포인트로 만들 수 있음. <a href="https://platform.openai.com/docs/api-reference/vector-stores?utm_source=chatgpt.com">platform.openai.com+1</a></p>
  </li>
  <li>
    <p><strong>파일 배치(File Batches)</strong> : 업로드된 파일이 청크/벡터화되어 저장되는 단위. <code class="language-plaintext highlighter-rouge">/v1/vector_stores/{vector_store_id}/file_batches</code> 같은 구조 있음. <a href="https://platform.openai.com/docs/api-reference/vector-stores-file-batches?utm_source=chatgpt.com">platform.openai.com</a></p>
  </li>
  <li>
    <p><strong>파일(파일 업로드)</strong> : <code class="language-plaintext highlighter-rouge">/v1/vector_stores/{vs_id}/files</code> 엔드포인트에서 파일을 추가할 수 있음. <a href="https://platform.openai.com/docs/api-reference/vector-stores-files?utm_source=chatgpt.com">platform.openai.com</a></p>
  </li>
  <li>
    <p><strong>검색(Search)</strong> : 저장된 Vector Store에 대해 “유사벡터 기반 검색”을 요청 가능 (예: 파일 검색, 청크 검색) <a href="https://platform.openai.com/docs/assistants/tools/file-search/vector-stores?utm_source=chatgpt.com">platform.openai.com+1</a></p>
  </li>
</ul>

<hr />

<h2 id="3-흐름-예시로-보기">3. 흐름 예시로 보기</h2>

<p>아래처럼 단계별 구성됩니다:</p>

<ol>
  <li>
    <p>파일 업로드</p>

    <ul>
      <li>예: PDF를 업로드 → OpenAI 측에서 자동으로 청크화/임베딩/저장 준비 → 파일 배치 생성</li>
    </ul>
  </li>
  <li>
    <p>Vector Store 생성</p>

    <ul>
      <li>저장소 이름, 설명 등의 메타데이터 제공 → 생성</li>
    </ul>
  </li>
  <li>
    <p>파일을 Vector Store에 바인딩(=파일 추가)</p>

    <ul>
      <li>생성한 Vector Store ID에 파일 배치/파일을 업로드하는 API 호출</li>
    </ul>
  </li>
  <li>
    <p>검색 요청</p>

    <ul>
      <li>
        <p>사용자가 질의(query)를 보내면, API는 임베딩 생성 → 저장된 벡터들과 유사도 비교 → 관련 청크 반환</p>
      </li>
      <li>
        <p>반환된 청크를 기반으로 응답 생성(LLM 호출 전처리 역할)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>LLM 호출(별도)</p>

    <ul>
      <li>검색된 청크는 LLM(예: gpt-모델)에 컨텍스트로 전달 → 답변 생성</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="4-주요-특성-및-한계">4. 주요 특성 및 한계</h2>

<ul>
  <li>
    <p>파일/문서 메타데이터는 비교적 제한적: 업로드된 파일이 얼마나 긴지(token count, char count) 등의 정보 부족하다는 사용자의 피드백이 있음. <a href="https://www.reddit.com/r/OpenAI/comments/1lacgqe/openais_vector_store_api_is_missing_basic/?utm_source=chatgpt.com">Reddit</a></p>
  </li>
  <li>
    <p>청크화 + 임베딩 + 저장/관리 과정을 “사용자제어” 하려면 OpenAI 호스티드 기능보다는 자체 벡터DB + 임베딩 워크플로우가 더 유연함</p>
  </li>
  <li>
    <p>검색 품질은 임베딩 모델(어떤 모델을 썼는가) + 청크 단위/문서 구조 설계에 크게 좌우됨</p>
  </li>
</ul>

<hr />

<h2 id="5-gpt-ossvllm-활용-시-고려사항">5. gpt-oss/vLLM 활용 시 고려사항</h2>

<p>당신이 vLLM + gpt-oss 조합으로 쓰는 상황이라면, OpenAI Vector Store API를 그대로 의존하기보다는 다음과 같은 변형이 필요할 수 있어요:</p>

<ul>
  <li>
    <p>OpenAI Vector Store API를 쓰고 싶으면 OpenAI 인증/요금/호스팅 구조 따라야 함</p>
  </li>
  <li>
    <p>또는 자체 벡터DB(예: FAISS, Milvus 등) + 임베딩 모델 + 검색 함수툴을 만들어서 “유사 기능”을 구현</p>
  </li>
  <li>
    <p>Agents SDK나 워크플로우에서는 “검색 툴(tool)”이 이 저장소와 연결됨: 사용자가 질의하면 검색툴이 관련 청크를 꺼내오고, LLM에게 문맥으로 제공</p>
  </li>
</ul>

<hr />

<p>필요하시다면, OpenAI Vector Store API를 실제로 호출하는 예제 코드(Python) 만들어 드릴 수 있어요—특히 파일 업로드 → 검색까지 흐름. 그렇게 할까요?</p>

<p class="chat--user">

마지막에 말한 검색툴은 자동으로 동작하는건지 llm이 요청하면 동작하는건지 궁금해

</p>

<p>아주 핵심을 짚으셨습니다.<br />
OpenAI의 “검색 툴(FileSearchTool)”은 <strong>자동으로 동작하지 않습니다</strong>.<br />
LLM이 “필요하다고 판단할 때” — 즉, <strong>모델이 툴 호출을 생성하면</strong> — 그때 실행됩니다.</p>

<p>이걸 조금 더 세밀하게 뜯어보면 이렇게 됩니다.</p>

<hr />

<h3 id="1-에이전트의-기본-구조">1. 에이전트의 기본 구조</h3>

<p>OpenAI Agents SDK(혹은 Responses API)에서 에이전트는 다음 두 가지를 갖습니다.</p>

<ul>
  <li>
    <p><strong>LLM 모델</strong> : gpt-4o, gpt-4o-mini 등</p>
  </li>
  <li>
    <p><strong>툴(tool)</strong> : 함수 호출(Function Tool), FileSearchTool, WebSearchTool, CodeInterpreter 등</p>
  </li>
</ul>

<p>에이전트는 LLM에게 “너는 이런 툴들을 쓸 수 있다”고 알려주고,<br />
대화 중에 LLM이 판단해 특정 툴을 호출할 때만 실제 실행 로직이 수행됩니다.</p>

<hr />

<h3 id="2-툴-호출-과정">2. 툴 호출 과정</h3>

<p>모델이 내부적으로 이런 구조의 응답을 냅니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function_call"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"arguments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"계약서 요약"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>SDK는 이걸 감지하고 <strong>search() 함수</strong> (혹은 FileSearchTool)을 호출합니다.<br />
그 결과를 받아 모델에게 다시 전달하면, 모델은 그 결과를 바탕으로 <strong>최종 답변</strong> 을 만듭니다.</p>

<p>즉, LLM이 툴 사용을 “결정”하고, 호출은 SDK가 “대리 실행”합니다.</p>

<hr />

<h3 id="3-자동성과-자율성의-정도">3. 자동성과 자율성의 정도</h3>

<ul>
  <li>
    <p><strong>자동 실행 아님</strong> : 사용자가 “검색을 꼭 하라”고 지정하지 않으면, 모델이 문맥상 필요하다고 판단해야 호출합니다.</p>
  </li>
  <li>
    <p><strong>프롬프트 설계 가능</strong> : system prompt 에 “파일 내용을 참조할 때는 항상 FileSearchTool을 사용하라”처럼 명시해 주면 호출 확률이 높아집니다.</p>
  </li>
  <li>
    <p><strong>Agent Loop</strong> : SDK가 이 과정을 자동 반복해줍니다. 모델이 툴 호출 → 실행 → 결과 전달 → 다시 모델 호출 … 최종 답변이 완성될 때까지 루프를 돕습니다.</p>
  </li>
</ul>

<hr />

<h3 id="4-예시로-보는-흐름">4. 예시로 보는 흐름</h3>

<p>사용자: “이 계약서 요약해줘.”</p>

<ol>
  <li>
    <p>모델은 FileSearchTool이 등록되어 있음을 알고 있음.</p>
  </li>
  <li>
    <p>LLM이 내부적으로 판단: “파일에서 내용 가져와야 하네.”</p>
  </li>
  <li>
    <p>LLM → <code class="language-plaintext highlighter-rouge">function_call: file_search(query="계약서 요약")</code></p>
  </li>
  <li>
    <p>SDK → 실제 Vector Store 검색 수행</p>
  </li>
  <li>
    <p>검색 결과를 모델에게 다시 입력</p>
  </li>
  <li>
    <p>모델 → 검색 결과를 요약한 최종 답변 생성</p>
  </li>
</ol>

<hr />

<h3 id="5-vllm--gpt-oss-조합에서는">5. vLLM + gpt-oss 조합에서는</h3>

<p>vLLM은 OpenAI의 Responses API 내부 오케스트레이션 기능이 없습니다.<br />
따라서 “자동 툴 호출”을 구현하려면 SDK가 필요합니다.<br />
직접 서버나 에이전트 루프를 만들고, 모델의 함수 호출 결과(JSON)를 해석해 수동으로 “search() → 결과 → 모델 재호출”을 구현해야 합니다.</p>

<hr />

<p>정리하자면:<br />
<strong>FileSearchTool은 모델이 필요하다고 판단할 때만 호출되고, SDK가 실행을 중계합니다.</strong><br />
즉, “모델이 요청하면 자동으로 동작한다”는 표현이 가장 정확합니다.</p>

<p>다음 단계로, 원하신다면 vLLM + gpt-oss 조합에서 이 “툴 호출 루프”를 흉내내는 최소 예제(모델 → function_call → search → 재호출)를 만들어 드릴 수 있습니다.</p>

<p class="chat--user">

영어로 작성된 문서 rag를 한글로 쿼리할 수 있어?

</p>

<p>가능합니다. 방법은 크게 두 가지 계열입니다. 한글 쿼리 → 영어 문서 RAG를 지원하려면 “다국어 임베딩”을 쓰거나 “번역 레이어”를 끼우면 됩니다.</p>

<ol>
  <li>다국어 임베딩으로 직접 검색</li>
</ol>

<ul>
  <li>
    <p>핵심: 영어 문서 청크와 한국어 쿼리를 같은 임베딩 공간으로 매핑.</p>
  </li>
  <li>
    <p>모델 예: bge-m3, e5-multilingual, LaBSE, mContriever 등.</p>
  </li>
  <li>
    <p>장점: 번역 없이도 개념 맞춤. 고유명사·전문용어에 강함.</p>
  </li>
  <li>
    <p>단점: 임베딩 품질·차원 수가 커서 메모리↑. 영어 전용 임베딩 대비 약간의 정밀도 손실이 있을 수 있음.</p>
  </li>
</ul>

<ol>
  <li>번역 후 검색(translate-then-retrieve)</li>
</ol>

<ul>
  <li>
    <p>파이프라인: 한글 쿼리 → 영어로 번역 → 영어 전용 임베딩(예: e5-large, bge-large-en 등)으로 검색 → 답변은 한글로 생성.</p>
  </li>
  <li>
    <p>장점: 영어 전용 임베딩/리랭커 품질을 그대로 활용 가능.</p>
  </li>
  <li>
    <p>단점: 번역 오류가 쿼리의 핵심 토픽을 비트는 경우가 있음. 엔티티(제품명, 표기) 주의.</p>
  </li>
</ul>

<p>권장 설계(현업 안정판)</p>

<ul>
  <li>
    <p>인덱싱: 영어 문서를 문단/문장 단위로 청크, 메타데이터(페이지, 섹션, 언어=en) 저장.</p>
  </li>
  <li>
    <p>임베딩: 다국어 임베딩 인덱스 1개는 반드시 구축. 여력이 되면 영어 전용 인덱스를 추가로 구성해 듀얼 인덱스 검색.</p>
  </li>
  <li>
    <p>검색 전략: 한글 쿼리에 대해</p>

    <ol>
      <li>
        <p>다국어 인덱스에서 top-k</p>
      </li>
      <li>
        <p>영어 전용 인덱스(쿼리 번역)에서도 top-k</p>
      </li>
      <li>
        <p>두 결과를 점수 정규화 후 병합</p>
      </li>
    </ol>
  </li>
  <li>
    <p>리랭킹: 다국어 리랭커(bge-reranker-v2-m3 같은 범용 다국어 리랭커)로 상위 50→10 재정렬.</p>
  </li>
  <li>
    <p>하이브리드: BM25(키워드) + 벡터 점수 가중 평균. 고유명사 매칭 강화.</p>
  </li>
  <li>
    <p>생성: gpt-oss(vLLM)에 “출처 표시, 영어 인용문은 원문 유지, 최종 답변은 한국어”를 시스템 규칙으로 주입.</p>
  </li>
</ul>

<p>간단 파이프라인 예시(핵심 로직만)</p>

<ul>
  <li>
    <p>인덱싱</p>

    <ol>
      <li>
        <p>PDF → 텍스트 추출 → 청크</p>
      </li>
      <li>
        <p>multilingual_embed(chunks) → FAISS/Chroma/PGVector에 저장</p>
      </li>
      <li>
        <p>선택: english_embed(chunks)로 영어 전용 인덱스도 병행 구축</p>
      </li>
    </ol>
  </li>
  <li>
    <p>질의</p>

    <ol>
      <li>
        <p>ko_query → multilingual_embed(ko_query)로 검색</p>
      </li>
      <li>
        <p>ko_query → en_query로 번역 → english_embed(en_query)로 검색</p>
      </li>
      <li>
        <p>결과 병합 → 다국어 리랭킹</p>
      </li>
      <li>
        <p>상위 n개를 컨텍스트로 vLLM에 넣고 한국어로 답변 생성</p>
      </li>
    </ol>
  </li>
</ul>

<p>프롬프트 팁</p>

<ul>
  <li>
    <p>시스템 규칙에 “문헌은 영어 원문을 그대로 인용, 설명은 한국어로 작성, 출처 페이지/섹션을 함께 적시”를 명시.</p>
  </li>
  <li>
    <p>다국어 혼용 문서일 경우 “언어 감지 → 쿼리와 다른 언어라도 동일 개념이면 포함” 같은 지침을 추가.</p>
  </li>
</ul>

<p>실무 체크리스트</p>

<ul>
  <li>
    <p>토크나이저 길이: 청크는 200~400토큰(문단 경계 유지).</p>
  </li>
  <li>
    <p>메타데이터: page, section, filename, lang. 답변에 근거 표시 용이.</p>
  </li>
  <li>
    <p>고유명사: 대소문자·하이픈·스네이크케이스 보존. 정규화 과도하게 하지 않기.</p>
  </li>
  <li>
    <p>캐싱: 빈번한 쿼리 번역/임베딩 결과 캐시.</p>
  </li>
  <li>
    <p>평가: 한-영 쌍으로 질의–정답 골드셋을 만들어 MRR@n, Hit@n, nDCG로 비교.</p>
  </li>
</ul>

<p>vLLM + gpt-oss 연결 포인트</p>

<ul>
  <li>
    <p>위 검색 결과(top-k 청크)를 user 메시지에 CONTEXT로 넣고 질문은 한국어로 전달.</p>
  </li>
  <li>
    <p>답변은 한국어로 강제, 필요한 부분만 영어 원문 인용.</p>
  </li>
  <li>
    <p>함수툴(예: search_docs)을 한 개 제공해 “모델이 필요 시 호출”하도록하면 자동 루프(에이전트 스타일)도 재현 가능.</p>
  </li>
</ul>

<p>요약</p>

<ul>
  <li>가능하고, 실전에서는 “다국어 임베딩 + 번역 병행 + 리랭킹”이 안정적입니다. 이미 구축된 영어 코퍼스에 최소 변경으로 한글 질의를 붙일 수 있고, gpt-oss 서빙과도 잘 맞습니다.</li>
</ul>

<p class="chat--user">

아 그리고 아까 search function을 만든다고 했잖아. 그 함수는 모든 RAG 문서를 다 뒤져 아니면 문서가 만약 100개 등록됐다고 치면 가장 관련된 10개만 추려서 10개에 대한 매칭만 해?

</p>

<p>짧게 핵심부터: 잘 만든 search 함수는 “전부 뒤지기”가 아니라 보통 2단계로 좁힙니다. 1단계에서 문서 레벨로 상위 N개를 고르고, 2단계에서 그 문서들 안에서 청크 레벨로 상위 K개만 뽑아 LLM에 넣습니다. 보편값은 N≈5~20, K≈3~8, 그리고 최종 컨텍스트 토큰 상한으로 컷을 겁니다.</p>

<p>아키텍처를 단계별로 정리해볼게요.</p>

<ol>
  <li>컬렉션과 인덱스</li>
</ol>

<ul>
  <li>
    <p>문서 100개가 등록되어 있다면 우선 전부를 하나의 벡터 인덱스(또는 컬렉션)로 관리합니다.</p>
  </li>
  <li>
    <p>문서 메타데이터(파일명, 섹션, 날짜, 언어, 권한, 태그)를 함께 저장해 필터링에 활용합니다.</p>
  </li>
  <li>
    <p>하이브리드 검색 권장: 벡터(의미) + BM25(키워드)를 함께 써서 고유명사·숫자 매칭을 보완합니다.</p>
  </li>
</ul>

<ol>
  <li>1단계: 문서 레벨 프리셀렉션</li>
</ol>

<ul>
  <li>
    <p>쿼리 임베딩과 문서 대표 벡터를 비교해 상위 N개 문서를 고릅니다.</p>
  </li>
  <li>
    <p>문서 대표 벡터는 보통 문서 제목+요약(abstract) 또는 상위 몇 개 청크의 평균으로 만듭니다.</p>
  </li>
  <li>
    <p>필터 예: lang=en, updated_at&gt;2025-01-01, tag in [“policy”, “spec”] 같은 조건을 먼저 걸어 탐색 공간을 줄입니다.</p>
  </li>
  <li>
    <p>다중 전략 결합: 벡터 상위 N1, BM25 상위 N2를 뽑아 Reciprocal Rank Fusion 같은 방식으로 합칩니다.</p>
  </li>
</ul>

<ol>
  <li>2단계: 청크 레벨 정밀 검색</li>
</ol>

<ul>
  <li>
    <p>선택된 N개 문서 각각에서 top_k_chunks_per_doc=K로 청크를 뽑습니다.</p>
  </li>
  <li>
    <p>중복·유사 청크는 Max Marginal Relevance(MMR)로 다양화합니다.</p>
  </li>
  <li>
    <p>전체 모아서 재랭킹: 다국어 리랭커 또는 cross-encoder로 상위 50→최종 10개로 줄입니다.</p>
  </li>
</ul>

<ol>
  <li>컨텍스트 빌더</li>
</ol>

<ul>
  <li>
    <p>최종 청크들을 근거 메타데이터와 함께 LLM 컨텍스트로 직조합니다.</p>
  </li>
  <li>
    <p>토큰 한도(max_context_tokens)에 맞춰 자르고, 가능한 한 문단 경계를 유지합니다.</p>
  </li>
  <li>
    <p>규칙을 강제: 답변은 한국어, 인용은 원문 유지, 각 근거에 페이지/섹션 표기.</p>
  </li>
</ul>

<ol>
  <li>운영 팁</li>
</ol>

<ul>
  <li>
    <p>쿼리 라우팅: 분야별 컬렉션이 여러 개면 먼저 라우터(분야 분류기)로 컬렉션을 1~2개로 좁힌 뒤 위 과정을 수행합니다.</p>
  </li>
  <li>
    <p>캐싱: 잦은 쿼리의 임베딩과 상위 결과를 캐시해 지연을 줄입니다.</p>
  </li>
  <li>
    <p>임계값: 유사도 스코어가 임계값 미만이면 “근거 없음”으로 처리해 환각을 줄입니다.</p>
  </li>
  <li>
    <p>권한: 멀티유저라면 문서별 ACL을 메타데이터 필터에 반드시 반영합니다.</p>
  </li>
  <li>
    <p>실험: N, K, 임계값을 검증셋으로 튜닝합니다. 일반적으로 N을 늘리면 리콜↑, 지연/비용↑.</p>
  </li>
</ul>

<p>간단한 의사코드</p>

<ul>
  <li>
    <p>입력: query, filters, top_docs=N, top_chunks_per_doc=K, max_context_tokens</p>
  </li>
  <li>
    <p>출력: ranked_chunks</p>
  </li>
</ul>

<ol>
  <li>
    <p>q_emb = embed(query)</p>
  </li>
  <li>
    <p>doc_candidates = fuse(<br />
vector_search(DOC_INDEX, q_emb, N_vec),<br />
bm25_search(DOC_TEXTS, query, N_bm25)<br />
)[:N]</p>
  </li>
  <li>
    <p>chunk_pool = []<br />
for d in doc_candidates:<br />
chunk_pool += vector_search(d.CHUNK_INDEX, q_emb, K)</p>
  </li>
  <li>
    <p>chunk_pool = mmr_dedup(chunk_pool)</p>
  </li>
  <li>
    <p>ranked = rerank_cross_encoder(query, chunk_pool)</p>
  </li>
  <li>
    <p>context = pack_by_tokens(ranked, max_context_tokens)</p>
  </li>
  <li>
    <p>return context, ranked[:final_k]</p>
  </li>
</ol>

<p>질문으로 주신 두 선택지를 정리하자면</p>

<ul>
  <li>
    <p>모든 RAG 문서를 다 뒤지는 일괄 전수검색은 규모가 커질수록 느려지고 비용이 큽니다.</p>
  </li>
  <li>
    <p>보통은 “가장 관련된 문서 상위 N개”를 추려 그 안에서만 K개 청크를 뽑는 계층적 검색을 씁니다. 100개 문서면 상위 10개 문서 × 문서당 5개 청크 같은 구성이 현실적입니다.</p>
  </li>
</ul>

<p>마지막으로 숫자 레시피 예시</p>

<ul>
  <li>
    <p>top_docs=10, top_chunks_per_doc=5, rerank_top=60→final=12, max_context_tokens=6k</p>
  </li>
  <li>
    <p>하이브리드 비율: vector:bm25 = 0.7:0.3 가중 평균</p>
  </li>
  <li>
    <p>임계값: cosine &lt; 0.25면 제외, 문서 최신가중치 e^(−λ·age_days) 적용</p>
  </li>
</ul>

<p>이렇게 구성하면 정확도·지연·비용의 균형이 좋아지고, 쿼리 폭이 넓어져도 깔끔하게 확장됩니다.</p>

<p class="chat--user">

FunctionTool로 너가 말한 기능을 구현하고 싶어. 대략적인 인터페이스 함수들과 동작을 잡아보자

</p>

<p>좋아, FunctionTool로 RAG 검색을 붙일 때 쓸 “대략적 인터페이스”와 동작 흐름을 잡아볼게. vLLM+gpt-oss에서도 그대로 쓰고, OpenAI Agents SDK에도 거의 그대로 맵핑되도록 설계했어.</p>

<p>핵심 구성요소</p>

<ul>
  <li>
    <p>인덱싱 파이프라인: 파일→텍스트→청크→임베딩→저장</p>
  </li>
  <li>
    <p>검색 파이프라인: 질의→필터→문서 상위 N→청크 상위 K→재랭크→컨텍스트 패킹</p>
  </li>
  <li>
    <p>FunctionTool: 모델이 호출하면 위 검색 파이프라인을 실행해 컨텍스트와 근거 메타를 반환</p>
  </li>
</ul>

<p>데이터 모델(간단)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

type DocMeta = {
  doc_id: string
  title: string
  path?: string
  lang?: 'en'|'ko'|'mixed'
  tags?: string[]
  created_at?: string
  updated_at?: string
  acl?: string[]            // 접근 허용 사용자/역할
}

type Chunk = {
  chunk_id: string
  doc_id: string
  content: string
  page?: number
  section?: string
  tokens?: number
}

type Scored&lt;T&gt; = T &amp; { score: number }
</code></pre></div></div>

<p>FunctionTool 시그니처(검색 전용)<br />
OpenAI-style JSON 스키마를 따라 설계. 툴 이름은 search_docs.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search_docs"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"질문과 필터를 받아 관련 문서와 청크를 검색해 LLM 컨텍스트를 만든다."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"사용자 질문(ko/en 가능)"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"filters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"langs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"tags"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"doc_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"updated_after"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ISO8601"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"top_docs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"top_chunks_per_doc"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"final_chunks"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"max_context_tokens"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"use_hybrid"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"use_mmr"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"use_reranker"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"translate_query_to_en"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"query"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>FunctionTool 반환 포맷<br />
LLM이 바로 먹일 수 있게 컨텍스트 텍스트와 근거 리스트를 함께 줌.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

type SearchResult = {
  context: string                 // LLM에 바로 넣을 컨텍스트
  citations: Array&lt;{
    doc_id: string
    title?: string
    page?: number
    section?: string
    snippet: string
    score: number
  }&gt;
  diagnostics?: {
    used_docs: Array&lt;Scored&lt;DocMeta&gt;&gt;
    used_chunks: Array&lt;Scored&lt;Chunk&gt;&gt;
    query_lang?: 'ko'|'en'|'unknown'
    translated_query?: string
  }
}
</code></pre></div></div>

<p>동작 의사코드</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">search_docs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">top_docs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">top_chunks_per_doc</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">final_chunks</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_context_tokens</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                <span class="n">use_hybrid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_mmr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_reranker</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">translate_query_to_en</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SearchResult</span><span class="p">:</span>

    <span class="c1"># 0) 권한/필터링 프레딕트
</span>    <span class="n">candidate_docs</span> <span class="o">=</span> <span class="nf">filter_docs</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>  <span class="c1"># lang/tags/doc_ids/updated_after/ACL 반영
</span>
    <span class="c1"># 1) 쿼리 준비
</span>    <span class="n">lang</span> <span class="o">=</span> <span class="nf">detect_lang</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># ko/en 추정
</span>    <span class="n">q_for_vec</span> <span class="o">=</span> <span class="n">query</span>
    <span class="k">if</span> <span class="n">translate_query_to_en</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="sh">'</span><span class="s">ko</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">q_for_vec</span> <span class="o">=</span> <span class="nf">translate_ko_to_en</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># 선택 기능
</span>
    <span class="c1"># 2) 문서 레벨 프리셀렉션
</span>    <span class="n">doc_scores_vec</span> <span class="o">=</span> <span class="nf">vector_search_docs</span><span class="p">(</span><span class="n">candidate_docs</span><span class="p">,</span> <span class="n">q_for_vec</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_docs</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">doc_scores_kw</span>  <span class="o">=</span> <span class="nf">bm25_search_docs</span><span class="p">(</span><span class="n">candidate_docs</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_docs</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_hybrid</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">doc_candidates</span> <span class="o">=</span> <span class="nf">fuse_scores</span><span class="p">(</span><span class="n">doc_scores_vec</span><span class="p">,</span> <span class="n">doc_scores_kw</span><span class="p">)[:</span><span class="n">top_docs</span><span class="p">]</span>

    <span class="c1"># 3) 청크 레벨 정밀 검색
</span>    <span class="n">chunk_pool</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">doc_candidates</span><span class="p">:</span>
        <span class="n">chunks_vec</span> <span class="o">=</span> <span class="nf">vector_search_chunks</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">q_for_vec</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_chunks_per_doc</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">chunks_kw</span>  <span class="o">=</span> <span class="nf">bm25_search_chunks</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_chunks_per_doc</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_hybrid</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">chunk_pool</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">fuse_scores</span><span class="p">(</span><span class="n">chunks_vec</span><span class="p">,</span> <span class="n">chunks_kw</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">use_mmr</span><span class="p">:</span>
        <span class="n">chunk_pool</span> <span class="o">=</span> <span class="nf">mmr_diversify</span><span class="p">(</span><span class="n">chunk_pool</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">final_chunks</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># 4) 재랭킹
</span>    <span class="n">ranked</span> <span class="o">=</span> <span class="n">chunk_pool</span>
    <span class="k">if</span> <span class="n">use_reranker</span><span class="p">:</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="nf">cross_encoder_rerank</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">chunk_pool</span><span class="p">)</span>  <span class="c1"># 상위 50→정렬
</span>
    <span class="c1"># 5) 컨텍스트 패킹
</span>    <span class="n">selected</span> <span class="o">=</span> <span class="nf">take_until_token_budget</span><span class="p">(</span><span class="n">ranked</span><span class="p">,</span> <span class="n">final_chunks</span><span class="p">,</span> <span class="n">max_context_tokens</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="nf">build_context</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>  <span class="c1"># [Doc:Title p.X] + 본문… 형태
</span>
    <span class="c1"># 6) 인용/디버그 정보
</span>    <span class="n">citations</span> <span class="o">=</span> <span class="p">[{</span>
        <span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">doc_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="nf">get_title</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">doc_id</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">section</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">snippet</span><span class="sh">"</span><span class="p">:</span> <span class="nf">shorten</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">score</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>

    <span class="n">diags</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">used_docs</span><span class="sh">"</span><span class="p">:</span> <span class="n">doc_candidates</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">used_chunks</span><span class="sh">"</span><span class="p">:</span> <span class="n">selected</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">query_lang</span><span class="sh">"</span><span class="p">:</span> <span class="n">lang</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">translated_query</span><span class="sh">"</span><span class="p">:</span> <span class="n">q_for_vec</span> <span class="k">if</span> <span class="n">q_for_vec</span> <span class="o">!=</span> <span class="n">query</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span> <span class="sh">"</span><span class="s">citations</span><span class="sh">"</span><span class="p">:</span> <span class="n">citations</span><span class="p">,</span> <span class="sh">"</span><span class="s">diagnostics</span><span class="sh">"</span><span class="p">:</span> <span class="n">diags</span><span class="p">}</span>
</code></pre></div></div>

<p>컨텍스트 빌드 규칙(요약)</p>

<ul>
  <li>
    <p>문서/페이지/섹션 메타를 명시</p>
  </li>
  <li>
    <p>청크 사이에 구분자</p>
  </li>
  <li>
    <p>원문이 영어라도 그대로 두고, 최종 답변 언어는 LLM 시스템 프롬프트로 강제</p>
  </li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Source] Title="Spec ABC", DocID=doc_123, Page=5, Section="3.2"
"Chunk content here..."

[Source] Title="Spec XYZ", DocID=doc_987, Page=12
"Another chunk..."
</code></pre></div></div>

<p>Agents SDK에 등록 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">search_docs_tool</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">search_docs</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">search_docs</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">문서/청크 검색</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="n">위</span> <span class="n">JSON</span> <span class="n">스키마</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">답변은 한국어로. 반드시 search_docs를 이용해 근거를 확인하고, 인용을 포함해라.</span><span class="sh">"</span><span class="p">},</span>
  <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">영어로 된 제품 보증 조건 요약해줘</span><span class="sh">"</span><span class="p">}</span>
<span class="p">]</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
  <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
  <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
  <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
<span class="p">)</span>
<span class="c1"># tool_calls 감지 → search_docs_tool 실행 → 결과를 tool 메시지로 첨부 → 모델 재호출
</span></code></pre></div></div>

<p>vLLM+gpt-oss 커스텀 루프</p>

<ul>
  <li>
    <p>vLLM은 툴 호출 오케스트레이션이 없으니, 모델 출력의 function_call(JSON)을 직접 파싱해서 search_docs를 호출한 뒤 결과를 다시 모델에 넣는 루프를 구현하면 된다.</p>
  </li>
  <li>
    <p>또는 “수동 모드”로, 사용자 질문이 오면 서버에서 search_docs를 먼저 실행해 context를 만들고, 그걸 user 메시지에 붙여 모델을 한 번만 호출하는 방식도 간단하고 튼튼하다.</p>
  </li>
</ul>

<p>인덱싱용 보조 툴(선택)<br />
파일 업로드/재빌드/상태 확인을 위해 추가 FunctionTool을 두면 운영이 편하다.</p>

<ul>
  <li>
    <p>upsert_documents(files, tags, lang_hint)</p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>rebuild_index(scope='all'</td>
          <td>'doc_id')</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>describe_doc(doc_id)</p>
  </li>
  <li>purge_docs(doc_ids)</li>
</ul>

<p>최소 운영 파라미터의 추천 기본값</p>

<ul>
  <li>
    <p>top_docs=10</p>
  </li>
  <li>
    <p>top_chunks_per_doc=5</p>
  </li>
  <li>
    <p>final_chunks=12</p>
  </li>
  <li>
    <p>max_context_tokens=6000</p>
  </li>
  <li>
    <p>use_hybrid=true, use_mmr=true, use_reranker=true</p>
  </li>
  <li>
    <p>translate_query_to_en=false (다국어 임베딩이면 불필요, 영어 전용 임베딩이면 true)</p>
  </li>
</ul>

<p>여기까지가 견고한 골격이야. 다음 단계로는 너희가 쓰는 임베딩/벡터DB를 가정해서 search_docs 내부의 vector_search_*와 bm25, reranker, 패킹 함수를 실코드로 메워 넣으면 바로 붙일 수 있다.</p>

<p class="chat--user">

Database를 만들기도 해야해. 이를 위해 문서를 DB에 추가하거나 하는 것도 필요할 것 같은데

</p>

<p>좋아, RAG용 Database까지 포함한 “문서 수집·저장·인덱싱·검색” 풀사이클 인터페이스를 잡아보자. 운영을 염두에 두고 설계하면 나중에 안 아파요.</p>

<p>핵심 구조 개요</p>

<ol>
  <li>
    <p>원본 저장소: 업로드한 파일을 보관하는 Object Storage(S3, GCS, MinIO 등)</p>
  </li>
  <li>
    <p>메타·텍스트 DB: 문서/청크/태그/ACL/상태를 관리하는 RDB(PostgreSQL 권장)</p>
  </li>
  <li>
    <p>벡터 인덱스: pgvector 또는 외부 벡터DB(FAISS, Milvus, Chroma, Qdrant)</p>
  </li>
  <li>
    <p>잡 큐: 임베딩·재인덱싱 같은 비동기 작업용(예: Celery, RQ, Sidekiq, Temporal)</p>
  </li>
</ol>

<p>권장 구현 프로파일<br />
PostgreSQL + pgvector 한 방으로 끝내기<br />
장점: 트랜잭션, 조인, 필터링, 권한체크가 깔끔. 운영 단순.<br />
대안: 텍스트는 Postgres, 벡터는 FAISS/Milvus로 분리. 성능 튜닝 자유도↑.</p>

<p>데이터 모델 스키마(Postgres + pgvector)<br />
SQL DDL 예시. 임베딩 차원은 예로 1024를 사용.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sql

create extension if not exists vector;

create table documents (
  doc_id          uuid primary key,
  title           text not null,
  source_uri      text,                 -- S3 키, GCS 경로 등
  mime_type       text,
  lang            text,                 -- 'en','ko','mixed' 등
  tags            text[],
  bytes           bigint,
  pages           int,
  created_at      timestamptz default now(),
  updated_at      timestamptz default now(),
  status          text not null default 'ready',  -- 'ready','processing','error','disabled'
  acl_roles       text[] default array[]::text[], -- 접근 허용 역할
  acl_users       text[] default array[]::text[]  -- 접근 허용 사용자
);

create table chunks (
  chunk_id        uuid primary key,
  doc_id          uuid references documents(doc_id) on delete cascade,
  page            int,
  section         text,
  content         text not null,
  token_count     int,
  created_at      timestamptz default now(),
  updated_at      timestamptz default now()
);

-- 하나의 컬럼에 다국어 임베딩을 저장(권장). 필요하면 영어 전용 추가 컬럼도.
create table chunk_embeddings (
  chunk_id        uuid primary key references chunks(chunk_id) on delete cascade,
  emb_mtext       vector(1024),         -- 다국어 임베딩
  emb_en          vector(1024)          -- 선택: 영어 전용 임베딩
);

-- BM25 대체용 전체검색 인덱스
create index idx_chunks_fts on chunks using gin (to_tsvector('simple', content));

-- 태그/언어/상태/업데이트일 필터링
create index idx_documents_tags on documents using gin (tags);
create index idx_documents_lang on documents (lang);
create index idx_documents_status on documents (status);
create index idx_documents_updated on documents (updated_at);

-- 벡터 인덱스(IVFFlat 예시). 규모 커지면 lists 파라미터 튜닝.
create index idx_chunk_emb_mtext on chunk_embeddings using ivfflat (emb_mtext vector_cosine_ops) with (lists = 200);
create index idx_chunk_emb_en    on chunk_embeddings using ivfflat (emb_en    vector_cosine_ops) with (lists = 200);
</code></pre></div></div>

<p>스토리지 계층<br />
원문 파일은 RDB에 넣지 말고 Object Storage에 넣고 documents.source_uri로 연결. 썸네일·텍스트 추출 캐시를 두면 속도가 빨라짐.</p>

<p>FunctionTool 인터페이스 설계<br />
검색뿐 아니라 업서트·재인덱싱·관리까지 FunctionTool로 노출하면 LLM 에이전트나 관리용 UI에서 자동화하기 좋다.</p>

<ol>
  <li>문서 업서트<br />
이 함수는 DB와 스토리지를 갱신하고, 비동기 인덱싱 잡을 발행.</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"upsert_documents"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"문서를 DB와 스토리지에 추가/갱신하고 인덱싱 잡을 큐에 넣는다."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"source_uri"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"mime_type"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"lang_hint"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"acl_roles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"acl_users"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"doc_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"갱신 시 지정"</span><span class="w"> </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"source_uri"</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"reindex"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"items"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>동작</p>

<ol>
  <li>
    <p>source_uri 유효성 확인 및 메타 추출(bytes, pages 등)</p>
  </li>
  <li>
    <p>documents upsert</p>
  </li>
  <li>
    <p>상태를 processing으로 바꾸고 인덱싱 잡 enqueue</p>
  </li>
  <li>
    <p>인덱싱 워커(비동기 잡)<br />
추출→청크→임베딩→저장 파이프라인. 실패 시 documents.status='error'와 메시지 저장.<br />
의사코드</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">worker_index_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">get_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">source_uri</span><span class="p">)</span>
    <span class="n">text</span><span class="p">,</span> <span class="n">pages</span> <span class="o">=</span> <span class="nf">extract_text</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>             <span class="c1"># pypdf/unstructured/docling
</span>    <span class="n">chunks</span> <span class="o">=</span> <span class="nf">chunking</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>                     <span class="c1"># 200~400 토큰 권장
</span>    <span class="n">db</span><span class="p">.</span><span class="nf">delete_chunks</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>                    <span class="c1"># 전체 재빌드 시
</span>    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="n">chunk_id</span> <span class="o">=</span> <span class="nf">uuid4</span><span class="p">()</span>
        <span class="n">db</span><span class="p">.</span><span class="nf">insert_chunk</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">page</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">section</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">tokens</span><span class="p">)</span>
    <span class="c1"># 임베딩
</span>    <span class="n">vecs_m</span> <span class="o">=</span> <span class="nf">embed_multilingual</span><span class="p">([</span><span class="n">c</span><span class="p">.</span><span class="n">content</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">])</span>
    <span class="n">vecs_en</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># 필요하면 번역 후 또는 영어전용 임베딩
</span>    <span class="n">db</span><span class="p">.</span><span class="nf">insert_embeddings</span><span class="p">([</span> <span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nb">id</span><span class="p">,</span> <span class="n">vecs_m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vecs_en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">vecs_en</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">))</span> <span class="p">])</span>
    <span class="n">db</span><span class="p">.</span><span class="nf">update_document_status</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="sh">'</span><span class="s">ready</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>문서 상태 조회/설명</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"describe_doc"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"문서 메타데이터와 인덱싱 상태를 조회한다."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"doc_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"doc_id"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>반환은 title, lang, tags, updated_at, status, chunk_count 등.</p>

<ol>
  <li>선택적 재빌드</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rebuild_index"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"문서 또는 전체 컬렉션의 인덱스를 재생성한다."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"all"</span><span class="p">,</span><span class="s2">"doc"</span><span class="p">],</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"doc"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"doc_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"scope"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>삭제</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"purge_docs"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"문서를 완전히 삭제한다(청크, 임베딩 포함)."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"doc_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"doc_ids"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>검색 툴(앞서 정의한 search_docs)<br />
필터에 tags/lang/updated_after/acl 포함. top_docs, top_chunks_per_doc, final_chunks로 폭을 제어.</li>
</ol>

<p>권한(ACL) 처리<br />
검색 쿼리에서 반드시 다음을 적용.</p>

<ol>
  <li>
    <p>로그인 유저의 roles, user_id를 받아 documents.acl_roles/acl_users에 매칭</p>
  </li>
  <li>
    <p>필터 단계에서 미리 제외</p>
  </li>
  <li>
    <p>감사 로그: 누가 어떤 doc_id를 근거로 보았는지 기록</p>
  </li>
</ol>

<p>성능 팁</p>

<ol>
  <li>
    <p>토큰 예산 우선: final_chunks는 8~16 사이, 총 4~8k 토큰 내에서 패킹</p>
  </li>
  <li>
    <p>인덱스 튜닝: IVFFlat lists, probes 조정. pgvector의 SET ivfflat.probes=값</p>
  </li>
  <li>
    <p>하이브리드: to_tsvector(simple)로 키워드 인덱스. 고유명사/숫자 강화</p>
  </li>
  <li>
    <p>캐싱: 쿼리→상위 doc_ids, chunk_ids 캐시. 임베딩 결과도 메모리 캐시</p>
  </li>
  <li>
    <p>최신 가중치: score = α·cosine + β·bm25 + γ·recency_boost</p>
  </li>
</ol>

<p>간단 API 흐름 예시</p>

<ol>
  <li>
    <p>클라이언트가 파일 업로드 → 백엔드가 S3에 저장 후 upsert_documents 호출</p>
  </li>
  <li>
    <p>워커가 인덱싱 완료 → 문서 status=ready</p>
  </li>
  <li>
    <p>사용자가 질문 → search_docs 호출 → 컨텍스트와 citations 반환</p>
  </li>
  <li>
    <p>LLM 호출 시 컨텍스트 삽입 → 한국어 답변 생성</p>
  </li>
</ol>

<p>서버 사이드 의사코드 스니펫<br />
문서 업서트</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">upsert_documents</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">reindex</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">uuid4</span><span class="p">()</span>
        <span class="n">db</span><span class="p">.</span><span class="nf">upsert_document</span><span class="p">(</span>
            <span class="n">doc_id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">it</span><span class="p">[</span><span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">],</span>
            <span class="n">source_uri</span><span class="o">=</span><span class="n">it</span><span class="p">[</span><span class="sh">"</span><span class="s">source_uri</span><span class="sh">"</span><span class="p">],</span>
            <span class="n">mime_type</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">mime_type</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">lang</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">lang_hint</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">acl_roles</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">acl_roles</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">acl_users</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">acl_users</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">status</span><span class="o">=</span><span class="sh">"</span><span class="s">processing</span><span class="sh">"</span> <span class="k">if</span> <span class="n">reindex</span> <span class="k">else</span> <span class="sh">"</span><span class="s">ready</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">reindex</span><span class="p">:</span>
            <span class="n">queue</span><span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="sh">"</span><span class="s">worker_index_document</span><span class="sh">"</span><span class="p">,</span> <span class="n">doc_id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">)</span>
        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">doc_id</span><span class="p">),</span> <span class="sh">"</span><span class="s">queued</span><span class="sh">"</span><span class="p">:</span> <span class="n">reindex</span><span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>
</code></pre></div></div>

<p>검색 핵심 쿼리(pgvector)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sql

-- 다국어 임베딩으로 top N 청크
select c.chunk_id, c.doc_id, c.page, c.section, c.content,
       1 - (ce.emb_mtext &lt;=&gt; :qvec) as score
from chunk_embeddings ce
join chunks c on c.chunk_id = ce.chunk_id
join documents d on d.doc_id = c.doc_id
where d.status = 'ready'
  and (:lang is null or d.lang = :lang)
  and (:tags is null or d.tags &amp;&amp; :tags::text[])
  and (:user_id = any(d.acl_users) or array_length(d.acl_users,1) is null
       or :role &amp;&amp; d.acl_roles)
order by ce.emb_mtext &lt;=&gt; :qvec
limit :k;
</code></pre></div></div>

<p>운영 체크리스트<br />
문서 상태 전이: ready ↔ processing ↔ error<br />
중복 방지: 같은 source_uri+hash로 idempotent 업서트<br />
관찰성: 인덱싱 시간, 청크 수, 임베딩 시간, 검색 지연, 히트율 지표 수집<br />
재현성: 임베딩 모델 버전 저장. 교체 시 롤링 재인덱싱</p>

<p>정리</p>

<ol>
  <li>
    <p>문서 메타·청크·임베딩을 RDB로 명확히 분리하고, 파일은 Object Storage에 둔다.</p>
  </li>
  <li>
    <p>FunctionTool로 upsert/rebuild/describe/purge/search를 노출해 LLM이 필요한 순간에만 호출하게 한다.</p>
  </li>
  <li>
    <p>비동기 워커를 두어 인덱싱을 오프로드한다.</p>
  </li>
  <li>
    <p>pgvector 하나로도 충분히 단단한 RAG DB를 만들 수 있다.</p>
  </li>
</ol>

<p>다음으로 원하시면 이 스키마를 기준으로 실제 Python 저장소 레이어(ORM), 워커(Celery), 그리고 search_docs 내부 SQL까지 꽂아 넣은 미니 레퍼런스를 만들어줄게.</p>

<p class="chat--user">

임베딩 등은 그냥 유저의 로컬 파일 시스템에 저장한다고 가정하자.

</p>

<p>좋아. “임베딩과 인덱스까지 모두 로컬 파일 시스템에 저장”한다는 가정으로, 풀사이클 인터페이스와 디렉터리 구조, 파일 포맷, FunctionTool 시그니처, 동작 스케치를 잡아줄게. 외부 DB 없이도 단단히 돌아가도록 설계했어. 필요 라이브러리는 pypdf/unstructured, sentence-transformers(or bge/e5), faiss, sqlite3 정도로 가정한다.</p>

<p>설계 요약</p>

<ol>
  <li>
    <p>스토리지 계층은 전부 로컬 디렉터리. 원본 파일과 파생 산출물(텍스트, 청크, 임베딩, 인덱스)을 규칙적으로 저장.</p>
  </li>
  <li>
    <p>메타데이터는 SQLite 한 파일로 관리해 조회·필터·ACL가 빠름. 대안으로 JSONL만 써도 되지만 규모가 커지면 느려짐.</p>
  </li>
  <li>
    <p>벡터 검색은 FAISS를 사용하고 인덱스 파일로 영속화. 키워드 검색은 SQLite FTS5로 대체.</p>
  </li>
  <li>
    <p>FunctionTool은 업서트, 재인덱싱, 검색, 설명, 삭제까지 한 세트로 노출.</p>
  </li>
</ol>

<p>디렉터리 구조 예시<br />
rag_store/<br />
blobs/ 원본 파일 보관<br />
{doc_id}/{filename}<br />
texts/ 텍스트 추출 캐시<br />
{doc_id}.txt<br />
chunks/ 청크 JSONL<br />
{doc_id}.jsonl [{"chunk_id","page","section","content","tokens"}…]<br />
embeddings/ 임베딩 파일<br />
mtext/{doc_id}.npy float32 [num_chunks, dim]<br />
en/{doc_id}.npy 선택: 영어 전용<br />
indices/ 전체 컬렉션용 인덱스<br />
faiss_mtext.index<br />
faiss_en.index<br />
manifest/ 버전·모델 추적<br />
embedding_manifest.json [{"model":"bge-m3","dim":1024,"built_at":…}]<br />
locks/<br />
index.lock<br />
rag_meta.sqlite SQLite 메타DB(문서·청크·ACL·FTS5)</p>

<p>SQLite 스키마 요약<br />
documents(doc_id pk, title, source_path, mime, lang, tags json, bytes, pages, status, acl_users json, acl_roles json, created_at, updated_at, embed_model_mtext, embed_model_en)<br />
chunks(chunk_id pk, doc_id fk, page, section, content, tokens)<br />
fts_chunks(content) USING FTS5(content, content='chunks', content_rowid='rowid')<br />
인덱스: documents(status, updated_at), chunks(doc_id)</p>

<p>FunctionTool 인터페이스</p>

<ol>
  <li>
    <p>upsert_documents<br />
name: upsert_documents<br />
description: 로컬 파일을 등록하고 인덱싱 잡을 트리거한다.<br />
parameters:<br />
items: [{title, source_path, lang_hint?, tags?, acl_users?, acl_roles?, doc_id?}]<br />
reindex: boolean = true</p>
  </li>
  <li>
    <p>rebuild_index<br />
name: rebuild_index<br />
description: 전체 또는 특정 문서의 임베딩·FAISS 인덱스를 재생성한다.<br />
parameters:<br />
scope: "all"|"doc"<br />
doc_id?: string<br />
which: "mtext"|"en"|"both" = "mtext"</p>
  </li>
  <li>
    <p>describe_doc<br />
name: describe_doc<br />
description: 문서 메타·상태·청크 수를 조회한다.<br />
parameters:<br />
doc_id: string</p>
  </li>
  <li>
    <p>purge_docs<br />
name: purge_docs<br />
description: 문서를 로컬 스토리지와 메타DB, 인덱스에서 완전 삭제한다.<br />
parameters:<br />
doc_ids: string[]</p>
  </li>
  <li>
    <p>search_docs<br />
name: search_docs<br />
description: 쿼리와 필터로 문서 상위 N → 청크 상위 K → 재랭크 후 컨텍스트 빌드<br />
parameters:<br />
query: string<br />
filters?: { langs?: string[], tags?: string[], doc_ids?: string[], updated_after?: string }<br />
top_docs?: int = 10<br />
top_chunks_per_doc?: int = 5<br />
final_chunks?: int = 12<br />
max_context_tokens?: int = 6000<br />
use_hybrid?: boolean = true 벡터 + FTS5<br />
use_mmr?: boolean = true<br />
use_reranker?: boolean = true 크로스 인코더가 있으면 사용<br />
translate_query_to_en?: boolean = false</p>
  </li>
</ol>

<p>주요 동작 스케치</p>

<p>A) 업서트와 인덱싱</p>

<ol>
  <li>
    <p>upsert_documents(items):<br />
a. 파일 존재 확인 → rag_store/blobs/{doc_id}/에 복사<br />
b. rag_meta.sqlite의 documents에 upsert, status='processing'<br />
c. 인덱싱 워커 트리거(worker_index_document(doc_id))</p>
  </li>
  <li>
    <p>worker_index_document(doc_id):<br />
a. 텍스트 추출 → rag_store/texts/{doc_id}.txt<br />
b. 청크 생성 → rag_store/chunks/{doc_id}.jsonl 저장, chunks 테이블 교체 삽입<br />
c. 임베딩 생성 → rag_store/embeddings/mtext/{doc_id}.npy 저장<br />
d. SQLite FTS5 동기화: chunks를 fts_chunks에 삽입<br />
e. documents.status='ready', updated_at=now<br />
f. 글로벌 FAISS 인덱스 갱신: indices/faiss_mtext.index 로드 → add_with_ids → 저장</p>
  </li>
</ol>

<p>B) 검색<br />
search_docs(query, …):</p>

<ol>
  <li>
    <p>쿼리 전처리와 임베딩 준비(필요시 ko→en 번역)</p>
  </li>
  <li>
    <p>문서 레벨 프리셀렉션<br />
a. FTS5 문서 후보: SELECT doc_id FROM fts_chunks WHERE fts_chunks MATCH ? LIMIT N_bm25<br />
b. FAISS 후보: 쿼리 임베딩으로 topN 청크 검색 → doc_id 집계 상위 N_vec<br />
c. 두 결과를 RRF로 합쳐 상위 top_docs 도출</p>
  </li>
  <li>
    <p>청크 레벨 정밀 검색<br />
a. 선택 문서별로 top_chunks_per_doc씩 FAISS 검색<br />
b. 필요시 FTS5 결과도 병합<br />
c. MMR로 다양화, 크로스 인코더 재랭크</p>
  </li>
  <li>
    <p>컨텍스트 패킹<br />
a. final_chunks 개수와 max_context_tokens 안에서 패킹<br />
b. citations에 doc_id, title, page, section, score 포함</p>
  </li>
  <li>
    <p>반환: {context, citations, diagnostics}</p>
  </li>
</ol>

<p>C) 삭제와 재인덱싱<br />
purge_docs: 파일 디렉터리, 텍스트, 청크 jsonl, npy 제거 → SQLite에서 문서·청크 삭제 → FAISS에서 해당 ID 삭제 후 저장<br />
rebuild_index: scope='all'이면 임베딩과 FAISS를 제로부터 리빌드, which로 mtext/en 선택</p>

<p>파일 포맷과 저장 방식<br />
임베딩 저장: NumPy .npy, dtype=float32, shape=[num_chunks, dim]<br />
FAISS 인덱스: IVF_FLAT 또는 HNSW. index.reset(); index.add_with_ids(vecs, global_ids) 후 write_index<br />
글로벌 ID: 64-bit 정수. 권장 매핑은 hash64("{doc_id}:{chunk_id}")로 만들고 SQLite에 gid 컬럼으로 저장<br />
청크 JSONL: 한 줄에 한 청크. 대용량 append/replace가 쉬워 운영 간단</p>

<p>간단 코드 스니펫들</p>

<ol>
  <li>임베딩 npy 저장/로드<br />
import numpy as np</li>
</ol>

<p>def save_embeddings_npy(path, matrix):<br />
path.parent.mkdir(parents=True, exist_ok=True)<br />
np.save(path, matrix.astype(np.float32))</p>

<p>def load_embeddings_npy(path):<br />
return np.load(path).astype(np.float32)</p>

<ol>
  <li>FAISS 인덱스 로드/저장/갱신<br />
import faiss<br />
from pathlib import Path</li>
</ol>

<p>def load_faiss(path, dim):<br />
if Path(path).exists():<br />
return faiss.read_index(str(path))<br />
index = faiss.index_factory(dim, "IVF4096,Flat", faiss.METRIC_INNER_PRODUCT)<br />
quantizer = faiss.IndexFlatIP(dim)<br />
index_ivf = faiss.IndexIVFFlat(quantizer, dim, 4096, faiss.METRIC_INNER_PRODUCT)<br />
return index if isinstance(index, faiss.Index) else index_ivf</p>

<p>def save_faiss(index, path):<br />
Path(path).parent.mkdir(parents=True, exist_ok=True)<br />
faiss.write_index(index, str(path))</p>

<p>def add_embeddings(index, vecs, ids):<br />
faiss.normalize_L2(vecs)<br />
if hasattr(index, "is_trained") and not index.is_trained:<br />
index.train(vecs)<br />
index.add_with_ids(vecs, ids)</p>

<ol>
  <li>SQLite FTS5 삽입<br />
import sqlite3, json</li>
</ol>

<p>def upsert_chunks_sqlite(db_path, doc_id, chunks):<br />
conn = sqlite3.connect(db_path)<br />
c = conn.cursor()<br />
c.execute("DELETE FROM chunks WHERE doc_id=?", (doc_id,))<br />
for ch in chunks:<br />
c.execute("INSERT INTO chunks(chunk_id,doc_id,page,section,content,tokens) VALUES(?,?,?,?,?,?)",<br />
(ch["chunk_id"], doc_id, ch.get("page"), ch.get("section"), ch["content"], ch.get("tokens",0)))<br />
c.execute("INSERT INTO fts_chunks(rowid, content) SELECT rowid, content FROM chunks WHERE doc_id=?", (doc_id,))<br />
conn.commit()<br />
conn.close()</p>

<ol>
  <li>검색 파이프라인 핵심<br />
def search_pipeline(query, top_docs=10, top_chunks_per_doc=5, final_chunks=12):</li>
</ol>

<h1 id="1-쿼리-임베딩">1) 쿼리 임베딩</h1>

<p>q_vec = embed_mtext([query])[0].astype("float32")<br />
faiss.normalize_L2(q_vec.reshape(1,-1))</p>

<h1 id="2-글로벌-청크에서-topn-후보">2) 글로벌 청크에서 topN 후보</h1>

<p>D, I = faiss_index.search(q_vec.reshape(1,-1), 200)<br />
chunk_candidates = gather_chunks_by_ids(I[0], D[0]) # SQLite에서 메타 로드</p>

<h1 id="3-문서-집계--상위-top_docs">3) 문서 집계 → 상위 top_docs</h1>

<p>doc_scores = aggregate_by_doc(chunk_candidates)<br />
doc_top = take_top(doc_scores, top_docs)</p>

<h1 id="4-문서별-재검색">4) 문서별 재검색</h1>

<p>refined = []<br />
for d in doc_top:<br />
refined += search_chunks_in_doc(d.doc_id, q_vec, top_chunks_per_doc)<br />
refined = mmr_diversify(refined, k=final_chunks*4)<br />
ranked = rerank_cross_encoder(query, refined)[:final_chunks]</p>

<h1 id="5-컨텍스트-빌드">5) 컨텍스트 빌드</h1>

<p>context, citations = build_context_and_citations(ranked)<br />
return {"context": context, "citations": citations}</p>

<p>운영·안전 포인트<br />
락킹: indices/index.lock 파일로 파일 잠금 후 인덱스 저장.<br />
원자성: 인덱스 저장은 tmp에 쓴 뒤 rename으로 교체.<br />
버전관리: manifest/embedding_manifest.json에 모델명, 차원, 토큰라이저 버전 기록.<br />
권한: documents.acl_users/acl_roles를 검색 전 필터에 반영.<br />
복구: 청크 JSONL → SQLite 재구축, npy → FAISS 재빌드가 가능하도록 유지.</p>

<p>추천 기본값<br />
embedding 모델: bge-m3, dim=1024<br />
청크 크기: 200~400 토큰, overlap 15%<br />
faiss nprobe: 8~32, IVF lists: 4096부터 시작<br />
검색 폭: top_docs=10, top_chunks_per_doc=5, final_chunks=12, max_context_tokens=6000<br />
하이브리드: use_hybrid=true, FTS5 가중치 0.3, 벡터 0.7</p>

<p>정리<br />
로컬 파일 시스템만으로도 문서 등록부터 인덱싱, 검색까지 충분히 안정적인 RAG 스토어를 만들 수 있다. 핵심은 규칙적인 디렉터리 구조, SQLite+FTS5로의 메타·키워드 처리, FAISS 인덱스의 안전 저장, 그리고 FunctionTool 세트를 통한 일관된 오케스트레이션이다. 다음 단계로 원하면 이 스펙을 바로 실행 가능한 최소 Python 패키지 구조와 CLI까지 포함해 뼈대 코드를 만들어줄 수 있다.</p>

<p class="chat--user">

유저가 사용할 땐 어떤 순서로 해야해?

</p>

<p>다음 순서대로 쓰면 됩니다. 한 번 익히면 흐름이 늘 같습니다: 등록 → 인덱싱 → 검색 → 답변.</p>

<ol>
  <li>최초 1회 설정</li>
</ol>

<ul>
  <li>
    <p>로컬 디렉터리 준비: rag_store/ 하위에 blobs, texts, chunks, embeddings, indices, manifest, locks와 rag_meta.sqlite 생성.</p>
  </li>
  <li>
    <p>임베딩/인덱스 초기화: embedding 모델 선택(bge-m3 등), FAISS 인덱스 파일 생성(indices/faiss_mtext.index).</p>
  </li>
</ul>

<ol>
  <li>문서 등록</li>
</ol>

<ul>
  <li>
    <p>파일을 준비하고 upsert_documents 함수(또는 API/CLI)를 호출합니다.<br />
예시(Python/FunctionTool 호출 파라미터)<br />
{<br />
"items": [<br />
{<br />
"title": "spec_A.pdf",<br />
"source_path": "/path/spec_A.pdf",<br />
"lang_hint": "en",<br />
"tags": ["spec","v1"]<br />
}<br />
],<br />
"reindex": true<br />
}</p>
  </li>
  <li>
    <p>내부 동작: 파일을 blobs/{doc_id}/로 복사하고 documents 테이블에 기록, status='processing', 인덱싱 잡을 큐에 넣음.</p>
  </li>
</ul>

<ol>
  <li>인덱싱 자동 처리</li>
</ol>

<ul>
  <li>
    <p>워커가 텍스트 추출 → 청크 → 임베딩(npy) 저장 → FAISS 인덱스 갱신 → FTS5 업데이트 → status='ready'로 전환.</p>
  </li>
  <li>
    <p>필요하면 describe_doc(doc_id)로 상태 확인. 청크 수, 페이지 수, 임베딩 모델 버전 등을 바로 확인 가능.</p>
  </li>
</ul>

<ol>
  <li>검색과 질의응답</li>
</ol>

<ul>
  <li>
    <p>사용자가 질문을 입력하면, 애플리케이션이 먼저 search_docs를 호출해 컨텍스트를 확보합니다.<br />
권장 파라미터 예:<br />
{<br />
"query": "반품 정책 핵심이 뭐야?",<br />
"filters": { "langs": ["en"], "tags": ["policy"] },<br />
"top_docs": 10,<br />
"top_chunks_per_doc": 5,<br />
"final_chunks": 12,<br />
"use_hybrid": true,<br />
"use_mmr": true,<br />
"use_reranker": true,<br />
"max_context_tokens": 6000<br />
}</p>
  </li>
  <li>
    <p>search_docs가 반환한 context와 citations를 LLM에 넣어 답변 생성.</p>
  </li>
  <li>
    <p>한글 질의로 영어 문서를 찾으려면 다국어 임베딩 또는 translate_query_to_en=true를 사용.</p>
  </li>
</ul>

<ol>
  <li>운영 중 문서 추가/갱신</li>
</ol>

<ul>
  <li>
    <p>새 파일 추가: upsert_documents(items=[…], reindex=true).</p>
  </li>
  <li>
    <p>기존 문서 교체: 같은 doc_id로 upsert하거나 source_path를 업데이트 후 reindex.</p>
  </li>
  <li>
    <p>여러 파일 배치 등록도 동일. 상태가 ‘ready’가 되면 바로 검색에 포함됩니다.</p>
  </li>
</ul>

<ol>
  <li>재인덱싱과 청소</li>
</ol>

<ul>
  <li>
    <p>임베딩 모델 교체나 청크 규칙 변경 시 rebuild_index로 전체 또는 특정 문서를 재빌드.<br />
{<br />
"scope": "all",<br />
"which": "mtext"<br />
}</p>
  </li>
  <li>
    <p>문서 삭제는 purge_docs로 처리. 로컬 파일, 텍스트, 청크, 임베딩, 메타DB, FAISS 참조까지 정리.</p>
  </li>
</ul>

<ol>
  <li>권한과 필터링</li>
</ol>

<ul>
  <li>
    <p>사용자별로 roles/user_id를 애플리케이션이 전달하고, search_docs가 ACL을 반영해 필터링.</p>
  </li>
  <li>
    <p>태그, 언어, 수정일(updated_after)로 검색 범위를 줄여 지연을 안정화.</p>
  </li>
</ul>

<ol>
  <li>장애/품질 관리 팁</li>
</ol>

<ul>
  <li>
    <p>status='error'일 때 describe_doc로 에러 메시지 확인 후 재시도.</p>
  </li>
  <li>
    <p>검색 품질 저하 시 이 순서로 점검: 청크 크기(200~400 토큰), 임베딩 모델 일치, 하이브리드 검색 활성화, 리랭커 적용, MMR 다양화, 최신 가중치 적용.</p>
  </li>
  <li>
    <p>지연이 느리면 top_docs, top_chunks_per_doc, final_chunks를 줄이고, FAISS nprobe 튜닝.</p>
  </li>
</ul>

<p>사용자 경험 관점의 최소 흐름(진짜 실무용 압축본)</p>

<ol>
  <li>
    <p>파일 드래그·드롭 또는 업로드 → upsert_documents(reindex=true)</p>
  </li>
  <li>
    <p>잠시 후 준비 완료 → describe_doc로 ready 확인</p>
  </li>
  <li>
    <p>질문 입력 → 백엔드가 search_docs 호출 → context 수집</p>
  </li>
  <li>
    <p>LLM 호출 → 한국어 답변과 출처 표시</p>
  </li>
  <li>
    <p>추가 파일이 생기면 1로 돌아감</p>
  </li>
</ol>

<p>API/CLI 예시 한 줄씩</p>

<ul>
  <li>
    <p>등록: cli upsert –path /docs/spec.pdf –title "spec" –lang en –tag spec –reindex</p>
  </li>
  <li>
    <p>상태: cli describe –doc-id <uuid></uuid></p>
  </li>
  <li>
    <p>검색: cli search –q "refund policy" –lang en –top-docs 10 –top-chunks 5</p>
  </li>
  <li>
    <p>재빌드: cli rebuild –scope all</p>
  </li>
  <li>
    <p>삭제: cli purge –doc-ids <uuid1>,<uuid2></uuid2></uuid1></p>
  </li>
</ul>

<p>이 흐름을 앱에 녹이면 최종 사용자는 “문서 업로드 → 질문”만 알면 되고, 나머지 전처리·검색·컨텍스트 패킹은 백엔드가 FunctionTool로 수행합니다. 다음 단계로 원하면, 위 순서를 그대로 수행하는 REST 라우트 또는 간단한 CLI 스켈레톤을 만들어 줄게.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI Debug 노드 리팩터링</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor/" rel="alternate" type="text/html" title="ComfyUI Debug 노드 리팩터링" /><published>2025-11-04T12:48:12+09:00</published><updated>2025-11-04T12:48:12+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor/"><![CDATA[<p class="chat--user">

이거 내가 개발한 ComfyUI 노드야. 스트링 여러 개가 입력되었을 때 인덱스 선택하는 콤보 위젯 + 선택된 텍스트를 보여주는 텍스트 위젯으로 되어 있어. 
<code class="language-plaintext highlighter-rouge">
js
import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
    name: "hvppyflow.debug_nodes",
    async beforeRegisterNodeDef(nodeType, nodeData, app) {
        if (nodeData.name === "HFDebug") {
            const onExecuted = nodeType.prototype.onExecuted;
            nodeType.prototype.onExecuted = function (message) {
                onExecuted?.apply(this, arguments);

                this.properties.text = message["text"]

                let comboWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displayindex");
                let textWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displaytext");
                if (!comboWidget) {
                    comboWidget = this.addWidget("combo", "displayindex", 0, () =&gt; {
                        comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                        textWidget.value = message["text"]?.[comboWidget.value];       
                    }, {values: Array.from({ length: message["text"].length }, (_, i) =&gt; i)});
                    comboWidget.value = 0;
                } 
                if (!textWidget) {
                    textWidget = ComfyWidgets["STRING"](this, "displaytext", ["STRING", { multiline: true }], app).widget;
                    textWidget.inputEl.readOnly = true;
                    textWidget.inputEl.style.border = "none";
                    textWidget.inputEl.style.backgroundColor = "transparent";
                    textWidget.serialize = false;
                    textWidget.options.serialize = false; // Prevent prompt serialization
                }
                
                if (comboWidget.options.values.length !== message["text"].length) {
                    comboWidget.options.values = Array.from({ length: message["text"].length }, (_, i) =&gt; i);
                    comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                }
                textWidget.value = message["text"]?.[comboWidget.value];

                comboWidget.onChange = (data) =&gt; {
                    console.log("Combo changed" + comboWidget.value);
                    const index = comboWidget.value;
                    textWidget.value = message["text"]?.[index];
                };
            };

            const onConfigure = nodeType.prototype.onConfigure;
            nodeType.prototype.onConfigure = function () {
                onConfigure?.apply(this, arguments);
                
                let comboWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displayindex");
                let textWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displaytext");
                if (!comboWidget) {
                    comboWidget = this.addWidget("combo", "displayindex", 0, () =&gt; {
                        comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                        textWidget.value = this.properties?.text?.[comboWidget.value];
                    }, {values: Array.from({ length: this.properties?.text.length ?? 0 }, (_, i) =&gt; i)});
                    comboWidget.value = 0;
                }
                if (!textWidget) {
                    textWidget = ComfyWidgets["STRING"](this, "displaytext", ["STRING", { multiline: true }], app).widget;
                    textWidget.inputEl.readOnly = true;
                    textWidget.inputEl.style.border = "none";
                    textWidget.inputEl.style.backgroundColor = "transparent";
                    textWidget.serialize = false;
                    textWidget.options.serialize = false; // Prevent prompt serialization
                }

                if (comboWidget.options.values.length !== this.properties?.text.length) {
                    comboWidget.options.values = Array.from({ length: this.properties?.text.length }, (_, i) =&gt; i);
                    comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                }

                comboWidget.onChange = (data) =&gt; {
                    console.log("Combo changed" + comboWidget.value);
                    const index = comboWidget.value;
                    textWidget.value = this.properties?.text?.[index];
                };

                if (this.properties?.text) {
                    textWidget.value = this.properties?.text?.[comboWidget.value];
                }
            };
        }
    },
});
</code>
<code class="language-plaintext highlighter-rouge">python
class HFDebug:
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "text": ("STRING", {"forceInput": True}),
            },
            "hidden": {
                "unique_id": "UNIQUE_ID",
            },
        }

    @classmethod
    def IS_CHANGED(cls, **kwargs):
        import logging
        logging.info("HPDebug - IS_CHANGED called with kwargs: %s", kwargs)
        text = kwargs.get("text")
        if isinstance(text, list):
            return tuple(text)
        return text

    INPUT_IS_LIST = True
    RETURN_TYPES = ("STRING",)
    FUNCTION = "notify"
    OUTPUT_NODE = True
    OUTPUT_IS_LIST = (True,)
    CATEGORY = "utils"

    def notify(self, text, unique_id=None):
        return {"ui": {"text": text}, "result": (text,)}
</code>

여기서 string 리스트 길이가 1이면 콤보 위젯은 헷갈기만 하니까 그냥 생성을 안하도록 하고 싶어. 다양한 변수를 고려해서 작성해줘(리스트 길다가 -&gt; 1개로 줄어들 때, 1개 였다가 여러개가 될 때, 길이가 변할 때 등등) 그리고 내가 js 초보자라 좀 쓸데 없이 코드가 긴 것 같은데 정리도 해주면 좋겠어. 그리고 버그인진 모르겠는데 버그가 있어. 화살표로 넘기면 page가 1 -&gt; 2 이런 식으로 변해야할 것 같은데 항상 0으로 돌아가. 클릭해서 콤보 선택으로 넘겨야만 잘 돌아가. 이 버그도 고쳐주면 좋겠어

</p>

<p>좋아, 요구사항을 전부 반영해서 JS 쪽을 깔끔하게 리팩터링하고, “리스트 길이 = 1이면 콤보 위젯을 만들지 않기”, “길이가 늘었다/줄었다/변했다 케이스 모두 처리”, “키보드 화살표로 바꿀 때 0으로 되돌아가는 버그”까지 잡은 버전을 아래에 제시할게. 핵심 아이디어는 다음이야.</p>

<ol>
  <li>
    <p>선택 인덱스를 this.properties.selectedIndex로 보존해서 재실행(onExecuted)·재구성(onConfigure) 시에 값이 덮어써지지 않게 함.</p>
  </li>
  <li>
    <p>콤보 위젯은 “필요할 때만” 만들고(길이 ≥ 2), 불필요하면 제거. 제거 시에 안전하게 widgets 배열에서 뺀 뒤 노드 크기 재계산.</p>
  </li>
  <li>
    <p>onChange 안에서 comboWidget.value를 다시 건드리지 않음. 사용자가 키보드/마우스로 바꾼 값을 그대로 쓰고, 그 값을 properties에 저장만 함.</p>
  </li>
  <li>
    <p>옵션 길이가 바뀌어도 현재 selectedIndex를 최대 길이-1로만 클램프하고, 굳이 0으로 초기화하지 않음.</p>
  </li>
  <li>
    <p>입력이 string 하나이든 list이든 안전하게 처리(Array 래핑). 길이 0도 방어.</p>
  </li>
</ol>

<p>아래 코드로 교체하면 돼.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // ---------- 유틸: 안전한 remove ----------
    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        // LiteGraph/ComfyUI에서는 크기 재계산이 필요함
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    // ---------- 유틸: 텍스트를 항상 배열로 ----------
    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    // ---------- 유틸: 텍스트 위젯 확보 ----------
    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false; // 프롬프트 직렬화 방지
      }
      return textWidget;
    }

    // ---------- 유틸: 콤보 위젯 보장/업데이트 또는 제거 ----------
    function syncComboWidget(node, count) {
      let comboWidget = node.widgets?.find(w =&gt; w.name === "displayindex");

      // 길이 0 또는 1이면 콤보 제거
      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      // 필요: 콤보 생성
      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "displayindex",
          0,
          // 콜백에서는 value를 다시 세팅하지 말고, properties/텍스트만 동기화
          () =&gt; {
            const idx = Number(comboWidget.value) || 0;
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values: Array.from({ length: count }, (_, i) =&gt; i) }
        );
        comboWidget.serialize = false; // 필요시 직렬화 방지
      }

      // 옵션 길이 변경 반영
      const needUpdate =
        !comboWidget.options?.values ||
        comboWidget.options.values.length !== count;

      if (needUpdate) {
        comboWidget.options.values = Array.from({ length: count }, (_, i) =&gt; i);
      }

      // 현재 선택 인덱스를 보존/클램프
      const current = Number(node.properties.selectedIndex ?? comboWidget.value ?? 0);
      const clamped = Math.max(0, Math.min(current, count - 1));
      // 사용자 키입력을 덮어쓰지 않기 위해 "필요할 때만" 동기화
      if (comboWidget.value !== clamped) {
        comboWidget.value = clamped;
      }
      node.properties.selectedIndex = clamped;

      return comboWidget;
    }

    // ---------- 유틸: 텍스트/콤보/선택 상태 동기화 ----------
    function syncUI(node, texts) {
      // 텍스트를 properties에 저장 (onConfigure 재구성용)
      node.properties.text = texts;

      // 콤보 생성/제거
      const comboWidget = syncComboWidget(node, texts.length);

      // 텍스트 위젯 보장 및 값 반영
      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      // onChange는 한 번만 설정 (중복 등록 방지)
      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = Number(comboWidget.value) || 0;
          node.properties.selectedIndex = i;
          textWidget.value = texts[i] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    // ---------- onExecuted ----------
    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      // 최신 결과 수신
      const texts = normalizeToArray(message?.text);

      // 길이 변화(늘거나/줄거나/1개가 됨/여러 개가 됨)를 모두 커버
      // 선택 인덱스를 "필요 시"만 클램프하여 보존
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };

    // ---------- onConfigure ----------
    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>버그 원인과 해결 포인트 설명</p>

<ol>
  <li>
    <p>값 리셋 요인 제거<br />
기존 코드에서는 콤보 생성 직후 comboWidget.value = 0 같은 강제 초기화가 있었고, addWidget 콜백에서 comboWidget.value를 다시 세팅하는 로직도 섞여 있어서 사용자의 키보드 변경 직후 여러 경로로 값이 덮어써질 여지가 있었어. 새 코드는 사용자 입력 흐름을 존중해 “onChange에서 properties와 텍스트만 동기화”하고, 콤보 value를 임의로 다시 쓰지 않아 키보드(화살표) 조작 시 0으로 리셋되지 않아.</p>
  </li>
  <li>
    <p>상태의 단일 소스<br />
선택 인덱스를 this.properties.selectedIndex로 통일해서 onExecuted, onConfigure 사이에서 일관성 있게 유지돼. 데이터 길이가 변할 때도 selectedIndex를 최대 길이-1로만 클램프하니 사용자가 고른 페이지가 가능한 한 유지돼.</p>
  </li>
  <li>
    <p>콤보 동적 생성/제거<br />
texts.length ≤ 1이면 콤보를 제거하고, ≥ 2이면 필요 시에만 생성해. 길이가 1→여러 개, 여러 개→1, 혹은 N이 바뀌는 경우에도 syncComboWidget이 알아서 옵션/선택/제거를 처리해.</p>
  </li>
  <li>
    <p>위젯 제거 안전성<br />
removeWidget 유틸로 widgets 배열에서 안전하게 빼고, computeSize를 호출해서 노드 레이아웃이 깨지지 않도록 했어.</p>
  </li>
</ol>

<p>추가로 고려한 엣지 케이스</p>

<ul>
  <li>
    <p>text가 아예 오지 않거나(null/undefined) 빈 리스트일 때에도 빈 배열로 처리하고 텍스트 위젯엔 빈 문자열 표시.</p>
  </li>
  <li>
    <p>콤보 옵션이 갱신될 때 현재 선택 인덱스를 유지 가능한 범위에서 유지(클램프만 수행).</p>
  </li>
  <li>
    <p>직렬화 방지: 표시용 위젯들은 serialize를 false로 둬서 프롬프트에 새는 걸 막음.</p>
  </li>
</ul>

<p>파이썬 쪽은 건드릴 필요 없어 보이지만, 혹시 텍스트가 항상 리스트가 되길 원한다면 notify에서 ui 쪽으로 항상 list를 주는 지금 구현이 이미 적절해. IS_CHANGED에서 리스트면 튜플로 바꿔주는 것도 캐시 무효화에 도움이 되니 그대로 두면 돼.</p>

<p>다음 단계로 이어가기</p>

<ul>
  <li>
    <p>콤보 대신 좌우 화살표 버튼(두 개의 push 버튼 위젯)을 원하는 경우에도 같은 selectedIndex를 써서 쉽게 확장 가능해.</p>
  </li>
  <li>
    <p>텍스트가 매우 길다면 표시용 위젯 높이/자동 줄바꿈을 추가로 조절할 수 있어(style.whiteSpace, style.height 등).</p>
  </li>
</ul>

<p class="chat--user">

Array 원소가 숫자로 되어있으니 잘 동작을 안 하는 것 같아. 문자열로 바꿔줘

</p>

<p>좋아. 콤보 옵션과 value를 전부 문자열로 바꾸고, 내부 상태는 숫자로 유지하도록 정리했어. 핵심은 다음 두 가지야.</p>

<ol>
  <li>
    <p>UI 쪽(콤보)은 "라벨 문자열"을 사용한다. 예: "0", "1", "2"</p>
  </li>
  <li>
    <p>로직 쪽(프로퍼티 selectedIndex, 인덱싱)은 숫자를 사용한다. 변환기는 labelToIndex, indexToLabel 두 함수를 쓴다.</p>
  </li>
</ol>

<p>아래 코드는 이전에 준 리팩터 버전에서 “문자열 라벨”만을 위한 변경을 반영한 완성본이야.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // 라벨/인덱스 변환기
    const indexToLabel = (i) =&gt; String(i);
    const labelToIndex = (v) =&gt; {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : 0;
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // count에 맞춰 콤보를 생성/업데이트(라벨은 문자열), 불필요하면 제거
    function syncComboWidget(node, count) {
      let comboWidget = node.widgets?.find(w =&gt; w.name === "displayindex");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "displayindex",
          indexToLabel(0), // 문자열 라벨로 초기값
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values: Array.from({ length: count }, (_, i) =&gt; indexToLabel(i)) }
        );
        comboWidget.serialize = false;
      }

      const needUpdate =
        !comboWidget.options?.values ||
        comboWidget.options.values.length !== count;

      if (needUpdate) {
        comboWidget.options.values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i));
      }

      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx);

      if (comboWidget.value !== desiredLabel) {
        comboWidget.value = desiredLabel; // 콤보에는 문자열 라벨을 넣는다
      }
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);

      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          node.properties.selectedIndex = i;
          textWidget.value = texts[i] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>무엇이 바뀌었는지 한 줄 요약<br />
콤보의 options.values와 value를 모두 문자열("0","1","2", …)로 통일했고, 선택 상태는 this.properties.selectedIndex에 숫자로 저장되며 labelToIndex/indexToLabel로 변환해 동기화한다. 이로써 숫자 원소 때문에 선택이 꼬이는 문제와 화살표 조작 시 되돌아가는 증상 모두 방지된다.</p>

<p>다음 확장 아이디어<br />
라벨을 단순 순번이 아니라 “1 / N” 같은 사용자 친화형 문자열로 바꾸고 싶다면 indexToLabel을 i =&gt; <code class="language-plaintext highlighter-rouge">${i+1} / ${count}</code> 형태로 바꿔도 된다. 이때는 labelToIndex를 해당 형식에 맞게 파싱해주면 된다.</p>

<p class="chat--user">

응 사용자 친화적으로 가자. 1부터 인덱스로 가고 분모도 써주자. 라벨 이름도 displayindex 대신 page 로 바꾸자.

</p>

<p>좋지. 콤보 라벨을 “1 / N” 형식으로 바꾸고, 위젯 이름도 displayindex → page로 변경했어. 내부 로직은 0-based 숫자 인덱스를 유지하고, UI와의 경계에서만 문자열 라벨로 변환해. 기존 노드에 displayindex가 남아있을 수 있으니 마이그레이션으로 발견 즉시 제거하도록 처리했어.</p>

<p>핵심 변경점 요약</p>

<ul>
  <li>
    <p>콤보 라벨: “1 / N” (1부터 시작, 전체 길이 표기)</p>
  </li>
  <li>
    <p>콤보 위젯 이름: page</p>
  </li>
  <li>
    <p>selectedIndex는 숫자(0-based)로 유지, 라벨↔인덱스 변환기로 동기화</p>
  </li>
  <li>
    <p>길이 변화, 1개일 때 콤보 제거, 화살표 조작 시 값 리셋 방지 그대로 계승</p>
  </li>
</ul>

<p>교체 코드</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // 라벨/인덱스 변환기: "k / N" ↔ 0-based index
    const indexToLabel = (i, count) =&gt; `${i + 1} / ${count}`;
    const labelToIndex = (label) =&gt; {
      // "12 / 34" 같은 문자열에서 첫 번째 숫자만 잡아서 1 빼기
      const m = String(label).match(/\d+/);
      const k = m ? parseInt(m[0], 10) : 1;
      const idx = Number.isFinite(k) ? k - 1 : 0;
      return Math.max(0, idx);
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // count에 맞춰 콤보(page)를 생성/업데이트(라벨은 "1 / N"), 불필요하면 제거
    function syncComboWidget(node, count) {
      // 구버전(displayindex) 잔존 시 제거 (마이그레이션)
      const legacy = node.widgets?.find(w =&gt; w.name === "displayindex");
      if (legacy) removeWidget(node, legacy);

      let comboWidget = node.widgets?.find(w =&gt; w.name === "page");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      const values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i, count));

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "page",
          values[0],
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values }
        );
        comboWidget.serialize = false;
      } else {
        // 옵션 길이 변경 반영
        const needUpdate = !comboWidget.options?.values ||
                           comboWidget.options.values.length !== count ||
                           comboWidget.options.values[0] !== values[0];
        if (needUpdate) comboWidget.options.values = values;
      }

      // 현재 선택 인덱스 유지(클램프) 후 라벨과 동기화
      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx, count);

      if (comboWidget.value !== desiredLabel) comboWidget.value = desiredLabel;
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);

      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          const cl = Math.max(0, Math.min(i, texts.length - 1));
          node.properties.selectedIndex = cl;
          comboWidget.value = indexToLabel(cl, texts.length); // 불일치 시 교정
          textWidget.value = texts[cl] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;

      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>작동 방식 설명</p>

<ul>
  <li>
    <p>UI 라벨은 항상 “현재페이지(1-based) / 전체길이” 문자열로 보여주고, 내부 상태는 0-based 숫자 인덱스 selectedIndex에 저장한다.</p>
  </li>
  <li>
    <p>길이가 1 이하가 되면 page 콤보는 제거된다. 1→여러 개, 여러 개→1, 길이 증감 모두 자동 반영된다.</p>
  </li>
  <li>
    <p>화살표 조작 시 onChange가 문자열 라벨을 인덱스로 변환해 selectedIndex를 업데이트하고, 필요하면 라벨을 재동기화해 값 일관성을 유지한다.</p>
  </li>
  <li>
    <p>구버전 displayindex 위젯이 이미 붙어있던 노드도 안전하게 제거해 혼재 문제를 방지한다.</p>
  </li>
</ul>

<p>추가 팁</p>

<ul>
  <li>라벨 포맷을 바꾸고 싶으면 indexToLabel만 수정하면 된다. 예: <code class="language-plaintext highlighter-rouge">${i+1} / ${count} (${texts[i].slice(0,10)}…)</code>처럼 일부 내용 미리보기까지 첨부 가능.</li>
</ul>

<p class="chat--user">

아 그리고 page 콤보 위젯은 텍스트 위에 오면 보기가 더 좋을 것 같아. (1 페이지면 아얘 없는 것은 동일)

</p>

<p>좋지. “page 콤보를 텍스트 위에” 보이도록 위젯 순서를 재배열하는 유틸을 추가해 정리했어. 1페이지(길이 ≤ 1)일 땐 콤보를 만들지 않는 기존 동작도 그대로 유지돼.</p>

<p>핵 포인트</p>

<ol>
  <li>
    <p>widgets 배열에서 page가 displaytext보다 항상 앞에 오도록 재배치.</p>
  </li>
  <li>
    <p>콤보 생성/제거, 길이 변화, 화살표 조작, 1페이지 시 제거 로직은 이전 버전과 동일.</p>
  </li>
  <li>
    <p>구버전(displayindex) 잔존 위젯은 감지 즉시 제거.</p>
  </li>
</ol>

<p>교체 코드</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // "1 / N" 라벨 ↔ 0-based index
    const indexToLabel = (i, count) =&gt; `${i + 1} / ${count}`;
    const labelToIndex = (label) =&gt; {
      const m = String(label).match(/\d+/);
      const k = m ? parseInt(m[0], 10) : 1;
      const idx = Number.isFinite(k) ? k - 1 : 0;
      return Math.max(0, idx);
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") node.size = node.computeSize();
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // page 콤보를 생성/업데이트(라벨 "1 / N"), 불필요 시 제거
    function syncComboWidget(node, count) {
      // 구버전(displayindex) 제거
      const legacy = node.widgets?.find(w =&gt; w.name === "displayindex");
      if (legacy) removeWidget(node, legacy);

      let comboWidget = node.widgets?.find(w =&gt; w.name === "page");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      const values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i, count));

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "page",
          values[0],
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values }
        );
        comboWidget.serialize = false;
      } else {
        const needUpdate =
          !comboWidget.options?.values ||
          comboWidget.options.values.length !== count ||
          comboWidget.options.values[0] !== values[0];
        if (needUpdate) comboWidget.options.values = values;
      }

      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx, count);

      if (comboWidget.value !== desiredLabel) comboWidget.value = desiredLabel;
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    // page가 displaytext 위로 오도록 재배치
    function ensureOrderPageAboveText(node) {
      if (!node?.widgets) return;
      const pageIdx = node.widgets.findIndex(w =&gt; w.name === "page");
      const textIdx = node.widgets.findIndex(w =&gt; w.name === "displaytext");
      if (pageIdx === -1 || textIdx === -1) return;
      if (pageIdx &gt; textIdx) {
        const [w] = node.widgets.splice(pageIdx, 1);
        node.widgets.splice(textIdx, 0, w);
        if (typeof node.computeSize === "function") node.size = node.computeSize();
      }
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);
      const textWidget = ensureTextWidget(node);

      // 순서 정리: page -&gt; displaytext
      ensureOrderPageAboveText(node);

      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          const cl = Math.max(0, Math.min(i, texts.length - 1));
          node.properties.selectedIndex = cl;
          comboWidget.value = indexToLabel(cl, texts.length);
          textWidget.value = texts[cl] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);
      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;
      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);
      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;
      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>동작 흐름 요약</p>

<ol>
  <li>
    <p>onExecuted/onConfigure에서 텍스트 배열을 정규화.</p>
  </li>
  <li>
    <p>길이에 맞춰 page 콤보를 생성/업데이트(1페이지면 제거), displaytext는 항상 유지.</p>
  </li>
  <li>
    <p>ensureOrderPageAboveText로 page가 displaytext보다 위에 오도록 재배열.</p>
  </li>
  <li>
    <p>선택 인덱스는 properties.selectedIndex로 일관 관리, UI 라벨은 “1 / N” 문자열로 표시.</p>
  </li>
  <li>
    <p>키보드/마우스 조작 시 라벨→인덱스 변환으로 동기화하며 리셋 문제 없음.</p>
  </li>
</ol>

<p>더 다듬고 싶다면 텍스트 위젯 높이, 자동 줄바꿈, 프리뷰 길이 등을 옵션으로 노출해도 좋다.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python Tool 작성</title><link href="https://hvppyarchive.github.io/llm/python-systemfile-tools/" rel="alternate" type="text/html" title="Python Tool 작성" /><published>2025-10-31T11:43:50+09:00</published><updated>2025-10-31T11:43:50+09:00</updated><id>https://hvppyarchive.github.io/llm/python-systemfile-tools</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/python-systemfile-tools/"><![CDATA[<p class="chat--user">

Python Tool 작성을 해보자. OpenAI Agent에서 사용할 Tool을 만들고 싶어. 너가 만들어준 Tool에 agents.function_tool decorator를 붙일거니깐 내부 documentation과 Annotation이 된 상태로 되면 좋겠어. 그런데 root 폴더는 자체적으로 root_dir 로 지정을 해서 그에 따라 만들어서 나가게 하고 싶어. File System 관련 툴들 - list_files - read_file - save_file 만 일단 만들어줘. 

</p>

<p>좋아. 아래는 OpenAI Agent에서 바로 쓸 수 있게 <code class="language-plaintext highlighter-rouge">@agents.function_tool</code> 데코레이터를 붙인, 루트 디렉터리를 고정해서 동작하는 파일 시스템 툴 3종 세트야. 경로 탈출(<code class="language-plaintext highlighter-rouge">..</code>)을 막고, 바이너리/텍스트 모두 안전하게 다룰 수 있도록 설계했어.</p>

<p>간단한 설계 요약 (한 줄씩):</p>

<ol>
  <li>
    <p>모듈 전역의 <code class="language-plaintext highlighter-rouge">ROOT_DIR</code>로 작업 루트를 고정하고, 모든 입출력은 여기에 상대 경로로만 접근.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_resolve_safe()</code>에서 <code class="language-plaintext highlighter-rouge">Path.resolve()</code>로 정규화한 뒤 <code class="language-plaintext highlighter-rouge">is_relative_to</code>로 루트 내 경로인지 검증.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">list_files</code>는 재귀/글롭/숨김파일 포함 여부, 최대 개수 제한을 제공.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">read_file</code>은 텍스트 또는 바이너리(베이스64) 반환을 선택 가능. 파일 크기 상한(<code class="language-plaintext highlighter-rouge">max_bytes</code>)으로 과도한 읽기 방지.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">save_file</code>은 텍스트/베이스64 쓰기, 상위 폴더 자동 생성, 덮어쓰기 가드 제공.</p>
  </li>
  <li>
    <p>모든 함수는 풍부한 타입 힌트와 독스트링을 포함하고, JSON 직렬화 가능한 결과를 반환.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">asdict</span><span class="p">,</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># 이 모듈이 불리는 시점에 기본 root 설정 (필요하면 set_root_dir로 재설정)
</span><span class="n">ROOT_DIR</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="sh">"</span><span class="s">agent_root</span><span class="sh">"</span>
<span class="n">ROOT_DIR</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">set_root_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    루트 디렉터리를 설정한다. 모든 툴은 이 디렉터리 하위에서만 동작한다.

    Parameters
    ----------
    path : str | Path
        작업 루트로 사용할 디렉터리 경로.

    Returns
    -------
    str
        정규화된 루트 디렉터리의 절대 경로 문자열.
    </span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">ROOT_DIR</span>
    <span class="n">ROOT_DIR</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">ROOT_DIR</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relpath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    루트 디렉터리 내부의 안전한 절대 경로를 계산한다.
    경로 탈출(../ 등)을 방지하기 위해 resolve 후 ROOT_DIR 하위인지 검사한다.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROOT_DIR</span> <span class="o">/</span> <span class="nc">Path</span><span class="p">(</span><span class="n">relpath</span><span class="p">)).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Python 3.9+: Path.is_relative_to 지원. 미지원 환경 대비 수동 체크.
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">):</span>  <span class="c1"># type: ignore[attr-defined]
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes ROOT_DIR</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="c1"># 수동 구현
</span>        <span class="k">if</span> <span class="n">ROOT_DIR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">ROOT_DIR</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes ROOT_DIR</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FileEntry</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_path</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">FileEntry</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="nc">FileEntry</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span> <span class="nb">type</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

<span class="c1"># ===== OpenAI Agent Tool Definitions =====
# 프레임워크에 따라 import 경로가 다를 수 있음. 예:
# from openai import agents
# 여기서는 사용자가 말한 데코레이터 이름을 그대로 쓴다.
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">agents</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>  <span class="c1"># 런타임 환경에서 데코레이터가 없을 수 있으니 대체 정의
</span>    <span class="k">class</span> <span class="nc">_NoopDecorator</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">fn</span>
            <span class="k">return</span> <span class="n">wrapper</span>
    <span class="n">agents</span> <span class="o">=</span> <span class="nf">_NoopDecorator</span><span class="p">()</span>  <span class="c1"># type: ignore
</span>
<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">루트 디렉터리(root_dir) 기준으로 파일/폴더 목록을 가져온다. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">재귀 탐색, 글롭 패턴, 숨김파일 포함 여부, 최대 개수 제한을 지원한다.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    파일/폴더 목록 조회.

    Parameters
    ----------
    relative_path : str, default=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="s">
        ROOT_DIR 기준 시작 경로.
    glob : str | None, default=None
        글롭 패턴 (예: </span><span class="sh">"</span><span class="s">*.py</span><span class="sh">"</span><span class="s">). None이면 전체.
    recursive : bool, default=True
        하위 폴더 재귀 탐색 여부.
    include_hidden : bool, default=False
        점(.)으로 시작하는 숨김 항목 포함 여부.
    max_items : int | None, default=None
        반환 항목 최대 개수. None이면 제한 없음.

    Returns
    -------
    dict
        {
          </span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;ROOT_DIR&gt;</span><span class="sh">"</span><span class="s">,
          </span><span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;relative_path&gt;</span><span class="sh">"</span><span class="s">,
          </span><span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="s">: &lt;int&gt;,
          </span><span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">file|dir</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int|null&gt;}, ...]
        }

    Notes
    -----
    - 모든 경로는 ROOT_DIR 하위로 제한된다.
    - 경로 탈출이 감지되면 ValueError를 발생시킨다.
    </span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">relative_path</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
            <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># 후보 경로 이터레이션
</span>    <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
            <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

    <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FileEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="c1"># ROOT_DIR 범위 재확인 (심볼릭 링크 등 대비)
</span>        <span class="n">safe_p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">))</span>
        <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">FileEntry</span><span class="p">.</span><span class="nf">from_path</span><span class="p">(</span><span class="n">safe_p</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="nf">asdict</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">루트 디렉터리(root_dir) 기준 경로의 파일을 읽는다. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">텍스트(encoding 사용) 또는 바이너리(Base64) 모드로 반환할 수 있다.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    파일 읽기.

    Parameters
    ----------
    relative_path : str
        ROOT_DIR 기준 파일 경로.
    mode : {</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">}, default=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">
        </span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">는 문자열로 반환(encoding 사용), </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">는 Base64 문자열로 반환.
    encoding : str, default=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="s">
        텍스트 모드에서 사용할 인코딩.
    max_bytes : int | None, default=2*1024*1024
        읽기 최대 바이트. None이면 제한 없음.

    Returns
    -------
    dict
        텍스트 모드:
          {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;str&gt;</span><span class="sh">"</span><span class="s">}
        바이너리 모드:
          {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;str&gt;</span><span class="sh">"</span><span class="s">}

    Raises
    ------
    FileNotFoundError
        대상 파일이 없을 때.
    IsADirectoryError
        디렉터리를 읽으려 할 때.
    ValueError
        경로 탈출 등 보안 위반.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s"> bytes) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">save_file</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">루트 디렉터리(root_dir) 기준 경로에 파일을 저장한다. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">텍스트(encoding) 또는 Base64 바이너리를 지원하고, </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">덮어쓰기/상위 경로 자동 생성 옵션을 제공한다.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    파일 저장.

    Parameters
    ----------
    relative_path : str
        ROOT_DIR 기준 저장 경로.
    content : str | None, default=None
        텍스트 모드에서 저장할 문자열. mode=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">일 때 필요.
    content_b64 : str | None, keyword-only, default=None
        바이너리 모드에서 저장할 Base64 문자열. mode=</span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">일 때 필요.
    mode : {</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">}, default=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">
        저장 모드.
    encoding : str, default=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="s">
        텍스트 모드 인코딩.
    overwrite : bool, default=False
        True면 기존 파일을 덮어쓴다. False면 기존 파일이 있으면 예외 발생.
    create_parents : bool, default=True
        상위 디렉터리를 자동 생성할지 여부.

    Returns
    -------
    dict
        {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">text|binary</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="s">: &lt;bool&gt;, </span><span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="s">: &lt;bool&gt;}

    Raises
    ------
    IsADirectoryError
        디렉터리 경로에 파일을 쓰려 할 때.
    FileExistsError
        overwrite=False이고 파일이 이미 존재할 때.
    ValueError
        잘못된 모드/입력 또는 경로 탈출 등 보안 위반.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">created</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">created</span><span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># 사용 예시 (Agent 외부 초기화 코드)
# set_root_dir("./workspace")  # 필요 시 루트 디렉터리 지정
# list_files(relative_path=".", glob="*.py", recursive=True)
# save_file("docs/readme.txt", content="hello", overwrite=True)
# read_file("docs/readme.txt", mode="text")
</span></code></pre></div></div>

<p>연동 팁:</p>

<ul>
  <li>
    <p>에이전트 시작 시점에 <code class="language-plaintext highlighter-rouge">set_root_dir("/desired/root")</code>를 한 번 호출해 루트 고정.</p>
  </li>
  <li>
    <p>보안상 모든 외부 입력 경로는 위 3개 툴의 <code class="language-plaintext highlighter-rouge">relative_path</code>에 그대로 넣지 말고, 꼭 이 툴 안에서 <code class="language-plaintext highlighter-rouge">_resolve_safe</code>가 검증하도록 유지.</p>
  </li>
  <li>
    <p>큰 파일을 다룬다면 <code class="language-plaintext highlighter-rouge">read_file(max_bytes=None)</code>처럼 상한을 조절하되, 에이전트 정책에 맞춰 적절한 제한을 두는 게 안전하다.</p>
  </li>
</ul>

<p>다음으로 원하면, 삭제/이동/복사 같은 추가 툴이나 파일 잠금, 트랜잭션성 저장(임시 파일로 쓰고 원자적 교체)도 확장해줄 수 있어.</p>

<p class="chat--user">

음 이런 형식이야. 너가 찾아볼 줄 알았지. from agents import function_tool @function_tool def get_weather(city: str) -&gt; str: """returns weather info for the specified city.""" return f"The weather in {city} is sunny" 그런데 루트를 함수로 입력 받고 그에 따른 툴을 리턴하면 잘 동작할까? 예를 들어 def get_systemfile_tools(root_dir: str): def list_files(…): f"root dir: {root_dir} …" … def save_file(…): return [list_files, save_file, …]

</p>

<p>가능해. 함수가 클로저로 <code class="language-plaintext highlighter-rouge">root_dir</code>를 캡처해서 툴로 내려가도, 에이전트가 “파이썬 콜러블을 호출”만 하면 문제없다. 다만 몇 가지 현실적 주의점이 있다.</p>

<p>핵심 포인트 먼저 정리</p>

<ol>
  <li>
    <p>대부분의 런타임(단일 프로세스, 인메모리)은 클로저 툴을 잘 지원한다.</p>
  </li>
  <li>
    <p>멀티프로세스/원격 실행(예: 프로세스 간 큐, 서버리스 워커)에서는 “피클/직렬화 가능한 최상위 함수”를 요구할 수 있다. 그땐 클로저 대신 <code class="language-plaintext highlighter-rouge">functools.partial</code>이나 클래스 바인딩 패턴이 안전하다.</p>
  </li>
  <li>
    <p>데코레이터는 정의 시점에 적용된다. 팩토리 내부에서 “데코레이터를 함수처럼 호출”해 적용하면 된다.</p>
  </li>
</ol>

<p>아래는 네가 제시한 스타일에 맞춘 최소-의존성 구현이다. <code class="language-plaintext highlighter-rouge">from agents import function_tool</code> 가정, <code class="language-plaintext highlighter-rouge">get_systemfile_tools(root_dir)</code>가 안전 경로 검증까지 포함한 3개 툴(list_files, read_file, save_file)을 만들어 리스트로 반환한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">function_tool</span>  <span class="c1"># 사용자 환경의 데코레이터
</span>
<span class="c1"># ===== 내부 유틸 =====
</span>
<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    root 하위의 안전한 절대 경로 생성. 경로 탈출 방지.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="n">relpath</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="c1"># Path.is_relative_to: 3.9+ 지원. 하위 호환 수동 체크
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>  <span class="c1"># type: ignore[attr-defined]
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="c1"># ===== 툴 팩토리 =====
</span>
<span class="k">def</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    지정한 root_dir를 기준으로 동작하는 파일 시스템 툴 3종을 생성해 반환한다.
    반환 값은 에이전트에 그대로 등록 가능한 데코레이트된 함수 리스트.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">root</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># --- list_files ---------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_list_files_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        루트(root_dir) 기준으로 파일/폴더 목록을 가져온다.
        글롭 패턴, 재귀 탐색, 숨김 포함 여부, 최대 개수 제한을 지원한다.
        </span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
                <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

        <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">safe</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">entries</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">list_files</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir 기준으로 파일/폴더 목록을 가져온다. 글롭/재귀/숨김/최대개수 옵션 지원.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_list_files_impl</span><span class="p">)</span>

    <span class="c1"># --- read_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_read_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        파일 읽기. 텍스트(encoding) 또는 바이너리(Base64) 모드 선택.
        파일 크기 상한(max_bytes)으로 과도한 읽기 방지.
        </span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
        <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">read_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir 기준 경로의 파일을 읽는다. 텍스트 또는 Base64 바이너리 반환.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_read_file_impl</span><span class="p">)</span>

    <span class="c1"># --- save_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_save_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        파일 저장. 텍스트(content) 또는 Base64(content_b64) 지원.
        overwrite와 상위 경로 자동 생성(create_parents) 옵션 제공.
        </span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">created</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">created</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">save_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">save_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir 기준 경로에 파일을 저장한다. 텍스트/바이너리, 덮어쓰기, 상위 폴더 생성 지원.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_save_file_impl</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">list_files</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">save_file</span><span class="p">]</span>
</code></pre></div></div>

<p>사용 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tools</span> <span class="o">=</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="sh">"</span><span class="s">./workspace</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># 에이전트 초기화 시 등록
# agent = Agent(tools=tools)  # 프레임워크에 맞게 등록
</span>
<span class="c1"># 또는 직접 호출도 가능(내부적으로 root="./workspace"로 고정됨)
</span><span class="nf">print</span><span class="p">(</span><span class="n">tools</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">relative_path</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">glob</span><span class="o">=</span><span class="sh">"</span><span class="s">*.py</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>클로저 툴의 현실적 주의사항과 대안</p>

<ul>
  <li>
    <p>워커 프로세스가 별도에서 툴을 로드해야 하는 아키텍처라면 클로저가 직렬화되지 않아 실패할 수 있다. 이 경우 두 가지 대안이 안전하다.</p>

    <ol>
      <li>
        <p><code class="language-plaintext highlighter-rouge">functools.partial</code> 패턴: 최상위 함수에 <code class="language-plaintext highlighter-rouge">root</code> 인자를 두고, <code class="language-plaintext highlighter-rouge">partial(fn, root=my_root)</code>로 바인딩한 뒤 그 partial에 데코레이터를 씌우거나, 데코레이터가 “함수처럼 호출 가능”하다면 팩토리에서 <code class="language-plaintext highlighter-rouge">function_tool(...)(partial(...))</code>로 등록.</p>
      </li>
      <li>
        <p>클래스 패턴: <code class="language-plaintext highlighter-rouge">class FS:</code> 안에 <code class="language-plaintext highlighter-rouge">__init__(root)</code>로 상태를 들고, 최상위 래퍼 함수를 만들어 <code class="language-plaintext highlighter-rouge">fs = FS(root)</code>의 메서드를 호출하게 래핑. 이 래퍼만 데코레이트해 등록하면 직렬화 제약을 피하기 쉽다.</p>
      </li>
    </ol>
  </li>
</ul>

<p>지금 제공한 구현은 가장 간결한 클로저-팩토리 버전이다. 만약 네 런타임이 멀티프로세스 직렬화를 요구한다면, 위 대안 패턴으로 바로 바꿔줄 수도 있다.</p>

<p class="chat--user">

function_tool이 자동으로 첫줄을 description으로 만드는데 그걸 f string으로 만들고 싶다는거지

</p>

<p>좋아. 핵심은 “데코레이터가 첫 줄 docstring을 읽는 타이밍 전에, 함수의 __doc__을 동적으로 채워넣기”야. 파이썬에서 함수 정의 블록 맨 처음의 문자열 리터럴은 컴파일 시 고정되지만, 런타임에 <code class="language-plaintext highlighter-rouge">fn.__doc__</code>을 다시 할당하는 건 가능하다. 그러니 팩토리에서 클로저를 만들고, 그 함수들의 <code class="language-plaintext highlighter-rouge">__doc__</code>을 f-string 결과로 대입한 다음, <code class="language-plaintext highlighter-rouge">function_tool</code>을 “데코레이터처럼 호출”해서 적용하면 된다. 포인트는 “docstring 수정 → function_tool 적용”의 순서.</p>

<p>아래는 동작하는 패턴을 단계별로 풀어쓴 코드다.</p>

<ol>
  <li>
    <p>클로저로 root_dir를 캡처</p>
  </li>
  <li>
    <p>내부 함수의 원본 docstring은 포맷용 플레이스홀더를 둔다</p>
  </li>
  <li>
    <p>정의가 끝난 뒤 <code class="language-plaintext highlighter-rouge">.__doc__ = f"...{root_dir}..."</code> 또는 <code class="language-plaintext highlighter-rouge">.format(root=root_dir)</code>로 주입</p>
  </li>
  <li>
    <p>마지막에 <code class="language-plaintext highlighter-rouge">function_tool(...)</code>로 래핑해서 리턴</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">function_tool</span>

<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="n">relpath</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>  <span class="c1"># py3.9+
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    root_dir를 캡처한 파일 시스템 툴들을 만들고, docstring의 첫 줄을 동적으로 채운 뒤 function_tool로 래핑해 반환한다.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">root</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># --- list_files ---------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_list_files_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">List files under {root}: glob/recursive/hidden/max_items supported.</span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
                <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">safe</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

    <span class="c1"># docstring 첫 줄을 동적으로 주입
</span>    <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">List files under </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: glob/recursive/hidden/max_items supported.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">list_files</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_list_files_impl</span><span class="p">)</span>  <span class="c1"># 이 시점에 첫 줄을 읽어 description으로 사용
</span>
    <span class="c1"># --- read_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_read_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Read a file from {root}: return text or Base64 binary with size guard.</span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
        <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Read a file from </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: return text or Base64 binary with size guard.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">read_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_read_file_impl</span><span class="p">)</span>

    <span class="c1"># --- save_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_save_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Save a file under {root}: text/binary, overwrite and parent creation options.</span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">existed</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">existed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="ow">not</span> <span class="n">existed</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="n">existed</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Save a file under </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: text/binary, overwrite and parent creation options.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">save_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_save_file_impl</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">list_files</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">save_file</span><span class="p">]</span>
</code></pre></div></div>

<p>이 패턴의 이유와 주의점 정리</p>

<ol>
  <li>
    <p>대부분의 <code class="language-plaintext highlighter-rouge">function_tool</code> 구현은 “래핑 시점”에 <code class="language-plaintext highlighter-rouge">fn.__doc__</code>의 첫 줄을 읽어 description으로 씀. 따라서 반드시 docstring을 바꾼 뒤에 <code class="language-plaintext highlighter-rouge">function_tool(fn)</code>을 호출해야 한다.</p>
  </li>
  <li>
    <p>데코레이터 구문 <code class="language-plaintext highlighter-rouge">@function_tool</code>를 함수 정의 위에 바로 붙이면, 데코레이터가 먼저 실행되므로 그 뒤의 <code class="language-plaintext highlighter-rouge">__doc__</code> 주입이 반영되지 않는다. 지금처럼 “call-style 데코레이션”으로 해결한다.</p>
  </li>
  <li>
    <p>f-string을 함수 본문 첫 줄 리터럴에 직접 쓸 수는 없다. 대신 런타임에 <code class="language-plaintext highlighter-rouge">__doc__</code>에 f-string 결과를 대입하거나, 템플릿 문자열을 두고 <code class="language-plaintext highlighter-rouge">.format(root=root_dir)</code>로 치환하면 된다.</p>
  </li>
  <li>
    <p>만약 네 <code class="language-plaintext highlighter-rouge">function_tool</code>이 description 인자를 직접 받는다면 더 간단히 <code class="language-plaintext highlighter-rouge">function_tool(description=f"...{root}...")(fn)</code>로 끝낼 수 있다. 하지만 “첫 줄 docstring 자동 사용” 규약을 유지하려면 지금 방식이 가장 호환성이 좋다.</p>
  </li>
</ol>

<p>확장 팁</p>

<ul>
  <li>
    <p>첫 줄 외에 상세 도움말을 계속 남기고 싶으면, 원래 docstring을 읽어 두고 첫 줄만 덮어쓴 뒤 나머지를 이어붙이는 지금 방식을 쓰면 된다.</p>
  </li>
  <li>
    <p>직렬화가 필요한 환경에서는 이 클로저를 최상위 함수+<code class="language-plaintext highlighter-rouge">functools.partial</code>로 바꿔도 동일한 방식으로 <code class="language-plaintext highlighter-rouge">__doc__</code> 주입 후 래핑이 가능하다.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI 타입 색상 추가</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-connection-color/" rel="alternate" type="text/html" title="ComfyUI 타입 색상 추가" /><published>2025-10-30T16:07:05+09:00</published><updated>2025-10-30T16:07:05+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-connection-color</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-connection-color/"><![CDATA[<p class="chat--user">

ComfyUI 에서 내가 만든 타입에 색깔을 넣을 순 없나

</p>

<p>가능해요. “내가 만든 타입(예: MYTYPE)”의 링크 색을 정해두면, 그 타입으로 들어오고 나가는 연결선이 원하는 색으로 보입니다. 핵심은 프런트엔드(LiteGraph 캔버스) 쪽의 “타입→색상” 매핑을 추가하는 겁니다.</p>

<p>아래 순서대로 하면 됩니다.</p>

<ol>
  <li>
    <p>파이썬 노드에서 타입 이름 정하기<br />
커스텀 노드의 RETURN_TYPES / INPUT_TYPES 등에 사용할 문자열이 실제 타입 이름이 됩니다. 예: RETURN_TYPES = ("MYTYPE",). 이 문자열이 프런트엔드에서도 색상 키로 쓰입니다. 타입 문자열과 링크 색은 LiteGraph가 타입별로 구분합니다. <a href="https://docs.comfy.org/development/core-concepts/nodes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>프런트엔드 확장 스크립트 만들기<br />
ComfyUI는 브라우저에서 실행될 때 작은 JS 확장(extension)을 자동 로드할 수 있습니다. 여기에 “타입→색상” 매핑을 추가합니다. 확장은 docs의 ComfyNode/JS 하이재킹 가이드가 안내하는 app.registerExtension 패턴을 쓰면 깔끔합니다. <a href="https://docs.comfy.org/custom-nodes/js/javascript_objects_and_hijacking?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ol>

<p>예시: ComfyUI/web/extensions/mytype-colors.js 파일을 만들고 아래처럼 작성합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ComfyUI 0.7대 LiteGraph 기준 예시
app.registerExtension({
  name: "mytype.color.map",
  setup() {
    const LGC = LGraphCanvas; // LiteGraph 캔버스
    // 연결선(활성/비활성) 색상을 타입 문자열 키로 지정
    LGC.default_connection_color_byType = {
      ...(LGC.default_connection_color_byType || {}),
      "MYTYPE": "#a26bff"   // 원하는 HEX
    };
    LGC.default_connection_color_byTypeOff = {
      ...(LGC.default_connection_color_byTypeOff || {}),
      "MYTYPE": "#5b3a9a"   // 비활성(꺼짐) 상태일 때 어두운 톤
    };
    // 색상 변경 후 캔버스 다시 그리기
    if (app?.graph?.canvas) app.graph.canvas.setDirty(true, true);
  }
});
</code></pre></div></div>

<p>LiteGraph는 타입 문자열별 기본 연결선 색을 default_connection_color_byType / default_connection_color_byTypeOff 두 객체에서 찾습니다. 이 두 맵에 키를 추가하면 됩니다. 이 방법은 LiteGraph에 직접 물어본 답과 동일한 메커니즘을 씁니다. <a href="https://stackoverflow.com/questions/78543805/how-do-i-change-the-color-of-a-slot?utm_source=chatgpt.com">Stack Overflow</a></p>

<ol>
  <li>브라우저 새로고침<br />
ComfyUI를 재시작하거나 브라우저를 새로고침하면, 이제 MYTYPE 타입 링크가 지정한 색으로 보입니다.</li>
</ol>

<p>추가 팁</p>

<p>• 노드 카드(헤더) 배경색은 타입 색과 별개입니다. 헤더 배경은 테마/팔레트(설정의 Appearance)나 CSS로 바꿀 수 있지만, “데이터 타입” 링크 색은 위처럼 타입 매핑을 손대야 바뀝니다. 팔레트만 바꾸면 “색이 더 잘 보이게” 되는 경우가 있으나, 타입별 고유색을 새로 정의하는 건 아닙니다. <a href="https://docs.comfy.org/interface/appearance?utm_source=chatgpt.com">ComfyUI+1</a></p>

<p>• ComfyUI는 커스텀 LiteGraph 빌드를 씁니다. 버전마다 내부 경로가 약간 다를 수 있지만, 공개 패키지 설명에서도 ComfyUI가 수정된 litegraph를 사용한다고 명시되어 있어 위 패턴이 안정적입니다. <a href="https://www.npmjs.com/package/%40comfyorg/litegraph/v/0.7.42?utm_source=chatgpt.com">Npm</a></p>

<p>• 코드로 헤더 색까지 강제하고 싶다면 node.color / node.bgcolor 같은 LiteGraph 속성도 건드릴 수 있습니다. 다만 워크플로 전반의 일관성을 생각하면 “링크(타입) 색은 타입-맵으로, 전체 테마는 팔레트/스타일로” 나누는 편이 유지보수에 유리합니다. 관련 JS 훅은 Comfy의 JS 오브젝트/하이재킹 문서가 출발점으로 좋습니다. <a href="https://docs.comfy.org/custom-nodes/js/javascript_objects_and_hijacking?utm_source=chatgpt.com">ComfyUI</a></p>

<p>정리하면, 파이썬 쪽에서 타입 문자열을 하나 정해 쓰고, 프런트엔드 확장으로 LGraphCanvas.default_connection_color_byType(및 Off)에 그 문자열 키를 원하는 색으로 추가하세요. 그러면 그 타입의 입출력 링크가 지정한 색으로 깔끔하게 표시됩니다. 다음으로는 여러 커스텀 타입을 쓰는 워크플로에서 색 팔레트를 체계적으로 정리해 두면, 복잡한 그래프도 한눈에 읽히는 “시각적 문법”이 됩니다.</p>

<p class="chat--user">

위에 임포트 같은건 따로 안해도 되나

</p>

<p>아니요. 따로 임포트할 거 없습니다.</p>

<p>왜냐면 ComfyUI가 브라우저에서 이미 필요한 것들을 전역으로 올려둡니다. 확장 스크립트를 <code class="language-plaintext highlighter-rouge">web/extensions/*.js</code>에 두고 <code class="language-plaintext highlighter-rouge">app.registerExtension({...})</code>를 쓰면, 내부에서 <code class="language-plaintext highlighter-rouge">app</code>(ComfyUI 앱 객체)와 <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>(LiteGraph 캔버스)가 자동으로 보입니다. 그래서 추가 임포트 없이 바로 맵을 건드릴 수 있습니다.</p>

<p>정리해두면 이렇게 됩니다.</p>

<ol>
  <li>
    <p>JS 쪽<br />
파일 위치: <code class="language-plaintext highlighter-rouge">ComfyUI/web/extensions/mytype-colors.js</code><br />
코드 안에서 따로 <code class="language-plaintext highlighter-rouge">import</code> 안 해도 됨. <code class="language-plaintext highlighter-rouge">app</code>과 <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>는 전역. <code class="language-plaintext highlighter-rouge">registerExtension</code>이 로딩 타이밍도 책임져줘서 “먼저 로드됐나?” 걱정도 줄어듭니다.</p>
  </li>
  <li>
    <p>파이썬 노드 쪽<br />
색상 매핑을 위해 별도의 임포트 필요 없음. 커스텀 노드 클래스에서 <code class="language-plaintext highlighter-rouge">RETURN_TYPES = ("MYTYPE",)</code> 같은 타입 문자열을 평소처럼 정의하면 끝. 색상은 JS 확장에서 타입 문자열 키로 매핑합니다.</p>
  </li>
  <li>
    <p>재시작/새로고침<br />
파일을 넣은 뒤 ComfyUI 재시작 또는 브라우저 새로고침만 하면 반영됩니다. 캐시가 끼면 강력 새고침 정도면 충분합니다.</p>
  </li>
</ol>

<p>예시 스니펫(임포트 없음):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

app.registerExtension({
  name: "mytype.color.map",
  setup() {
    const LGC = LGraphCanvas;
    LGC.default_connection_color_byType = {
      ...(LGC.default_connection_color_byType || {}),
      "MYTYPE": "#a26bff"
    };
    LGC.default_connection_color_byTypeOff = {
      ...(LGC.default_connection_color_byTypeOff || {}),
      "MYTYPE": "#5b3a9a"
    };
    if (app?.graph?.canvas) app.graph.canvas.setDirty(true, true);
  }
});
</code></pre></div></div>

<p>주의할 점 몇 가지만 덧붙이면 더 탄탄해집니다.<br />
• 파일 위치가 맞아야 자동 로드됩니다. 다른 경로를 쓰면 직접 로더에 등록해야 해요.<br />
• TypeScript로 작성한다면 “전역 <code class="language-plaintext highlighter-rouge">app</code>, <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>”에 대한 타입 선언만 추가하면 됩니다. JS라면 그냥 넘어가도 됩니다.<br />
• 만약 브라우저 콘솔에서 즉석 실행한다면 <code class="language-plaintext highlighter-rouge">window.app</code>, <code class="language-plaintext highlighter-rouge">window.LGraphCanvas</code>로 접근하세요.</p>

<p>한 줄 결론: 기본 설치 그대로라면 임포트는 전혀 필요 없습니다. 타입 문자열만 맞추고, 확장 스크립트에서 전역 객체를 살짝 손대면 링크 색상 커스터마이징이 깔끔하게 동작합니다.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry></feed>