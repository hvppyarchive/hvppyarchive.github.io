<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://hvppyarchive.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://hvppyarchive.github.io/" rel="alternate" type="text/html" /><updated>2025-11-04T13:16:59+09:00</updated><id>https://hvppyarchive.github.io/feed.xml</id><title type="html">ARCHIVE</title><subtitle>An amazing archive.</subtitle><author><name>hvppyarchive</name></author><entry><title type="html"></title><link href="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/" rel="alternate" type="text/html" title="" /><published>2025-11-04T13:16:59+09:00</published><updated>2025-11-04T13:16:59+09:00</updated><id>https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str</id><content type="html" xml:base="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/"><![CDATA[<p class="chat--user">

Python에서 <code class="language-plaintext highlighter-rouge">__repr__</code> 함수와 <code class="language-plaintext highlighter-rouge">__str__</code> 함수의 차이점

</p>

<p>Python에서 <code class="language-plaintext highlighter-rouge">__repr__</code> 과 <code class="language-plaintext highlighter-rouge">__str__</code> 의 차이점은 <strong>객체를 문자열로 표현하는 목적</strong> 에서 달라집니다. 차이를 단계적으로 정리해드릴게요.</p>

<hr />

<h2 id="1-__repr__-의-목적">1. <code class="language-plaintext highlighter-rouge">__repr__</code> 의 목적</h2>

<ul>
  <li>
    <p><strong>개발자 중심</strong> : 객체를 "개발자"가 보고 이해할 수 있도록 표현합니다.</p>
  </li>
  <li>
    <p><strong>재현 가능(reproducible)</strong> : 가능한 한 객체를 다시 만들 수 있는 코드 형태로 보여주는 것이 목표입니다.</p>
  </li>
  <li>
    <p>보통 <code class="language-plaintext highlighter-rouge">eval(repr(obj)) == obj</code> 가 성립하는 형태를 지향합니다 (꼭 항상 그런 건 아니지만 권장).</p>
  </li>
  <li>
    <p>디버깅할 때 주로 사용됩니다.</p>
  </li>
</ul>

<p>예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Person(name=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">'</span><span class="s">, age=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># Person(name='Alice', age=30)
</span></code></pre></div></div>

<hr />

<h2 id="2-__str__-의-목적">2. <code class="language-plaintext highlighter-rouge">__str__</code> 의 목적</h2>

<ul>
  <li>
    <p><strong>사용자 중심</strong> : 객체를 "사용자"가 보기 좋은 문자열로 표현합니다.</p>
  </li>
  <li>
    <p>읽기 쉽고 깔끔하게 출력하는 데 초점을 둡니다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">print(obj)</code> 를 호출했을 때 보여지는 값이 <code class="language-plaintext highlighter-rouge">__str__</code> 입니다.</p>
  </li>
</ul>

<p>예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s"> years old)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Alice (30 years old)
</span></code></pre></div></div>

<hr />

<h2 id="3-__repr__-vs-__str__-비교">3. <code class="language-plaintext highlighter-rouge">__repr__</code> vs <code class="language-plaintext highlighter-rouge">__str__</code> 비교</h2>

<table>
  <thead>
    <tr>
      <th>특징</th>
      <th><code class="language-plaintext highlighter-rouge">__repr__</code></th>
      <th><code class="language-plaintext highlighter-rouge">__str__</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>목적</td>
      <td>개발자용, 디버깅</td>
      <td>사용자용, 가독성</td>
    </tr>
    <tr>
      <td>출력 대상</td>
      <td><code class="language-plaintext highlighter-rouge">repr(obj)</code>, 대화형 쉘에서 기본</td>
      <td><code class="language-plaintext highlighter-rouge">str(obj)</code>, <code class="language-plaintext highlighter-rouge">print(obj)</code></td>
    </tr>
    <tr>
      <td>형식</td>
      <td>객체 재현 가능하거나 상세</td>
      <td>읽기 쉬운 설명 위주</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="4-구현-시-주의사항">4. 구현 시 주의사항</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code> 가 없으면 <code class="language-plaintext highlighter-rouge">__repr__</code> 가 대신 사용</strong>됩니다.</p>
  </li>
  <li>
    <p>따라서 최소한 <code class="language-plaintext highlighter-rouge">__repr__</code> 은 정의해 두는 것이 좋습니다.</p>
  </li>
</ul>

<hr />

<p>👉 정리하면,</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__repr__</code></strong> : “개발자가 디버깅할 때” 객체의 정확한 표현.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code></strong> : “사용자가 출력물을 볼 때” 보기 좋게 표현.</p>
  </li>
</ul>

<hr />

<p>원하시면 <code class="language-plaintext highlighter-rouge">__repr__</code> 와 <code class="language-plaintext highlighter-rouge">__str__</code> 를 동시에 구현했을 때 <code class="language-plaintext highlighter-rouge">print(obj)</code> 와 <code class="language-plaintext highlighter-rouge">obj</code> (쉘 출력) 의 차이를 직접 실행해 보여드릴 수도 있는데, 예제 코드 시연을 원하시나요?</p>]]></content><author><name>hvppyarchive</name></author></entry><entry><title type="html">vLLM에 pdf 넣는법</title><link href="https://hvppyarchive.github.io/llm/vllm-pdf/" rel="alternate" type="text/html" title="vLLM에 pdf 넣는법" /><published>2025-11-04T13:16:54+09:00</published><updated>2025-11-04T13:16:54+09:00</updated><id>https://hvppyarchive.github.io/llm/vllm-pdf</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/vllm-pdf/"><![CDATA[<p class="chat--user">

vllm 서빙하는 모델 gptoss에 pdf 넣는법

</p>

<p>요약 먼저: vLLM으로 서빙 중인 gpt-oss는 “PDF 파일을 직접 넣어 처리”하는 인터페이스가 없습니다. vLLM OpenAI 호환 서버는 텍스트/토큰 스트림을 받는 API이고, gpt-oss는 공개된 가이드 기준 텍스트 전용 모델이라서(이미지·PDF 업로드 파라미터 없음) PDF는 사전 전처리(텍스트 추출→청소→청크→검색/RAG)로 넣어야 합니다. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai+4</a></p>

<p>아래는 “PDF를 gpt-oss(vLLM 서버)로 넣는” 가장 흔한 구현 레시피입니다. 단계별로 그대로 따라하면 됩니다.</p>

<ol>
  <li>vLLM 서버로 gpt-oss 띄우기</li>
</ol>

<ul>
  <li>CUDA 환경에서 예시:</li>
</ul>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">pip</span> <span class="nt">install</span> <span class="nt">vllm</span>
<span class="nt">python</span> <span class="nt">-m</span> <span class="nt">vllm</span><span class="nc">.entrypoints.openai.api_server</span> <span class="err">\</span>
  <span class="nt">--model</span> <span class="nt">openai</span><span class="o">/</span><span class="nt">gpt-oss-20b</span> <span class="err">\</span>
  <span class="nt">--max-model-len</span> <span class="err">32768</span> <span class="err">\</span>
  <span class="nt">--port</span> <span class="err">8000</span>
</code></pre></div></div>

<p>서버는 OpenAI 호환 Chat/Completions 엔드포인트를 제공합니다. 기본적으로 파일 업로드 필드는 없고 문자열 프롬프트만 받습니다. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai</a></p>

<ol>
  <li>PDF → 텍스트 추출</li>
</ol>

<ul>
  <li>
    <p>Python 도구 예: pypdf, pdfminer.six, unstructured, docling 등.</p>
  </li>
  <li>
    <p>표·머리글·각주가 섞여 있으면 docling/Unstructured 계열이 품질이 더 낫습니다. 추출 후 다음을 꼭 하세요.<br />
• 페이지 헤더/푸터 제거, 공백 정규화, 본문 병합<br />
• 너무 긴 표는 CSV로 따로 저장(필요시)<br />
관련 이슈와 파이프라인 선택은 커뮤니티/라이브러리 이슈를 참고하세요. <a href="https://github.com/docling-project/docling/issues/1365?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<ol>
  <li>청크 나누기</li>
</ol>

<ul>
  <li>
    <p>800~1500자(또는 200~400 토큰) 단위로 자르고, 문단 경계를 최대한 유지합니다.</p>
  </li>
  <li>
    <p>각 청크에 원문 페이지/섹션 메타데이터를 붙입니다.</p>
  </li>
</ul>

<ol>
  <li>임베딩 생성 → 벡터DB 적재</li>
</ol>

<ul>
  <li>
    <p>임베딩 모델(예: bge-m3, jina-embeddings, sentence-transformers 등)로 각 청크를 벡터화하고, FAISS/Chroma/PGVector에 넣습니다.</p>
  </li>
  <li>
    <p>이 단계는 LLM(gpt-oss/vLLM)과 분리된 별도 과정입니다. vLLM 자체는 임베딩을 만들지 않습니다. RAG 패턴 예시는 다수의 vLLM 배포 예제에서도 동일합니다. <a href="https://validatedpatterns.io/patterns/rag-llm-gitops/?utm_source=chatgpt.com">validatedpatterns.io+1</a></p>
  </li>
</ul>

<ol>
  <li>질의 시 검색(RAG) → 프롬프트 구성 → vLLM에 전달</li>
</ol>

<ul>
  <li>
    <p>유저 질문을 벡터 검색으로 top-k 청크와 매칭</p>
  </li>
  <li>
    <p>아래 System/Assistant 컨텍스트에 “검색 결과”를 넣고, gpt-oss의 권장 포맷(하모니 포맷)을 지키며 요청을 보냅니다. gpt-oss는 OpenAI 호환 서버에서 잘 동작하도록 가이드가 있습니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm?utm_source=chatgpt.com">cookbook.openai.com+1</a></p>
  </li>
</ul>

<p>실전 코드 스니펫</p>

<p>A. PDF 텍스트 추출/청크(간단 예시)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pypdf</span> <span class="kn">import</span> <span class="n">PdfReader</span>

<span class="k">def</span> <span class="nf">extract_pdf_text</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="nc">PdfReader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">pages</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">extract_text</span><span class="p">()</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="n">pages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">())})</span>
    <span class="k">return</span> <span class="n">pages</span>

<span class="k">def</span> <span class="nf">chunk_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_chars</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">start</span> <span class="o">+</span> <span class="n">max_chars</span><span class="p">)</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">overlap</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">pages</span> <span class="o">=</span> <span class="nf">extract_pdf_text</span><span class="p">(</span><span class="sh">"</span><span class="s">sample.pdf</span><span class="sh">"</span><span class="p">)</span>
<span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">chunk_text</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">page</span><span class="p">[</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">})</span>
</code></pre></div></div>

<p>B. 임베딩→FAISS 적재(예시: sentence-transformers)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">import</span> <span class="n">faiss</span><span class="p">,</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">SentenceTransformer</span><span class="p">(</span><span class="sh">"</span><span class="s">sentence-transformers/all-MiniLM-L6-v2</span><span class="sh">"</span><span class="p">)</span>
<span class="n">emb</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">encode</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">],</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="p">.</span><span class="nc">IndexFlatIP</span><span class="p">(</span><span class="n">emb</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">index</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>
</code></pre></div></div>

<p>C. 검색→vLLM(gpt-oss) 호출(OpenAI 호환)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span><span class="p">,</span> <span class="n">requests</span><span class="p">,</span> <span class="n">json</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">encode</span><span class="p">([</span><span class="n">query</span><span class="p">],</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">scores</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">topk</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">ctx</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[p.</span><span class="si">{</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">]</span><span class="se">\n</span><span class="si">{</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ask_vllm</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">You are a helpful assistant. Use the provided CONTEXT; if missing, say you don</span><span class="sh">'</span><span class="s">t know.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sa">f</span><span class="sh">"</span><span class="s">CONTEXT:</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n\n</span><span class="s">QUESTION:</span><span class="se">\n</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">http://localhost:8000/v1/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">},</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">openai/gpt-oss-20b</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span><span class="n">messages</span><span class="p">,</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span><span class="mf">0.2</span><span class="p">})</span>
    <span class="p">).</span><span class="nf">json</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">ask_vllm</span><span class="p">(</span><span class="sh">"</span><span class="s">이 PDF에서 반품 정책 핵심 요약해줘</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>D. curl로 간단 테스트</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">curl</span> <span class="nv">http</span><span class="p">:</span><span class="c1">//localhost:8000/v1/chat/completions \</span>
  <span class="o">-</span><span class="kt">H</span> <span class="s">"Content-Type: application/json"</span> <span class="p">\</span>
  <span class="o">-</span><span class="n">d</span> <span class="err">'</span><span class="p">{</span>
    <span class="s">"model"</span><span class="p">:</span> <span class="s">"openai/gpt-oss-20b"</span><span class="p">,</span>
    <span class="s">"messages"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="s">"role"</span><span class="p">:</span><span class="s">"system"</span><span class="p">,</span><span class="s">"content"</span><span class="p">:</span><span class="s">"Answer using the context."</span><span class="p">},</span>
      <span class="p">{</span><span class="s">"role"</span><span class="p">:</span><span class="s">"user"</span><span class="p">,</span><span class="s">"content"</span><span class="p">:</span><span class="s">"CONTEXT:</span><span class="se">\n</span><span class="s">&lt;여기에 검색으로 모은 PDF 청크&gt;</span><span class="se">\n\n</span><span class="s">QUESTION:</span><span class="se">\n</span><span class="s">요약해줘"</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">0.2</span>
  <span class="p">}</span><span class="err">'</span>
</code></pre></div></div>

<p>자주 묻는 포인트</p>

<ul>
  <li>
    <p>왜 PDF 파일 자체를 바로 못 넣나?<br />
vLLM의 OpenAI 호환 서버는 파일 업로드/스토리지 기능이 아니라 텍스트 프롬프트 API입니다. 즉, 파일은 애플리케이션 레이어에서 처리해서 텍스트(또는 검색된 컨텍스트)로 바꾼 다음 모델에 넣어야 합니다. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai</a></p>
  </li>
  <li>
    <p>gpt-oss가 PDF나 이미지까지 직접 읽는 멀티모달인가?<br />
공개 가이드 기준 gpt-oss는 텍스트 중심의 오픈 웨이트 패밀리로 소개되었습니다. 멀티모달 입력을 직접 받는 형태가 아니라, 텍스트로 컨텍스트를 주는 방식이 표준입니다. <a href="https://openai.com/index/introducing-gpt-oss/?utm_source=chatgpt.com">OpenAI+2</a></p>
  </li>
  <li>
    <p>“PDF 질의응답” 정밀도를 더 높이려면?<br />
청크 크기/오버랩 최적화, 표/코드 블록 보존, 섹션별 재순위화(re-ranking), “출처 페이지 표시”를 프롬프트에 강제, 그리고 답변 근거를 따로 출력하도록 규칙을 넣으면 품질이 안정됩니다. vLLM 레시피/쿠크북의 gpt-oss 운영 가이드도 함께 보세요. <a href="https://docs.vllm.ai/projects/recipes/en/latest/OpenAI/GPT-OSS.html?utm_source=chatgpt.com">docs.vllm.ai+1</a></p>
  </li>
</ul>

<p>한 줄 정리: vLLM+gpt-oss로 PDF를 “넣는” 것은 PDF를 텍스트로 전처리하고, 검색 기반(RAG)으로 관련 청크를 추려 OpenAI 호환 API에 문자열로 보내는 것입니다. 이 흐름을 코드와 같이 구성하면 바로 운영에 올릴 수 있습니다.</p>

<p class="chat--user">

openai agent 라는 패키지가 있는데 여기에 그런 레이어가 포함되어있나?

</p>

<p>짧은 결론부터 말하면, “openai agent”로 알려진 OpenAI Agents SDK는 에이전트 오케스트레이션(툴 호출, 세션/메모리, 핸드오프, 가드레일 등)을 제공하지만 PDF 파싱·청크·임베딩·벡터스토어 적재 같은 “문서 RAG 인입 레이어”는 기본 내장되어 있지 않습니다. 다만 OpenAI 모델을 쓸 때는 호스티드 도구(FileSearchTool 등)를 통해 OpenAI Vector Stores에 올려둔 문서를 검색하는 방식은 지원합니다. 자체 vLLM+gpt-oss로 돌릴 때는 그 레이어를 직접 붙여야 합니다. <a href="https://openai.github.io/openai-agents-python/">openai.github.io+1</a></p>

<p>핵심 포인트를 정리하면 아래와 같습니다.</p>

<ol>
  <li>
    <p>SDK가 해주는 일<br />
에이전트 루프, 함수툴(FunctionTool), 세션/트레이싱, 핸드오프, MCP(Model Context Protocol) 연결 등 “오케스트레이션”이 주역할입니다. PDF를 읽어 텍스트로 만들고 임베딩을 뽑아 벡터DB에 적재하는 파이프라인은 앱 쪽에서 구성해야 합니다. <a href="https://openai.github.io/openai-agents-python/">openai.github.io+1</a></p>
  </li>
  <li>
    <p>OpenAI 호스티드 도구가 있을 때<br />
OpenAI Responses 모델을 쓰면 FileSearchTool, WebSearchTool, Code Interpreter 같은 “호스티드 툴”을 바로 붙일 수 있습니다. 이 경우 PDF는 OpenAI Vector Stores API로 업로드·처리하고, 에이전트는 FileSearchTool로 검색합니다. SDK 자체가 PDF를 파싱해주진 않고, 벡터스토어도 OpenAI 쪽 리소스를 이용하는 구성입니다. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io</a></p>
  </li>
  <li>
    <p>gpt-oss(+vLLM)와 함께 쓰는 경우<br />
vLLM의 OpenAI-호환 엔드포인트로 에이전트의 모델 클라이언트를 바꿔치기 할 수 있습니다. 다만 이때는 OpenAI 호스티드 도구(FileSearchTool 등)가 그대로 동작하지 않거나 전제가 바뀌므로, 직접 함수툴로 “검색/RAG”를 구현하거나 MCP 서버(자체 문서 검색 서버)를 붙여서 문서 검색을 노출하는 패턴이 일반적입니다. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm?utm_source=chatgpt.com">cookbook.openai.com+2</a></p>
  </li>
  <li>
    <p>최소 구현 스케치</p>
  </li>
</ol>

<ul>
  <li>
    <p>PDF 인입: pypdf/unstructured로 텍스트 추출 → 청크 → 임베딩(bge/jina/sentence-transformers) → FAISS/Chroma 적재</p>
  </li>
  <li>
    <p>에이전트 툴: search(query) 같은 Python 함수툴을 정의해 top-k 청크를 반환하도록 구현</p>
  </li>
  <li>
    <p>에이전트: Agent(tools=[search])로 등록, 모델은 vLLM의 Chat Completions/Responses 호환 엔드포인트로 지정</p>
  </li>
  <li>
    <p>OpenAI 모델로 바꿀 때만 FileSearchTool을 사용해 OpenAI Vector Store를 조회 가능<br />
이 구성은 SDK 문서의 “Tools”, “Context management”, “MCP” 섹션 흐름과 딱 맞습니다. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io+2</a></p>
  </li>
</ul>

<ol>
  <li>이름 혼동 주의<br />
Assistants API는 Responses API로 대체되는 흐름이며, Agents SDK는 이 Responses 기반에서 돌아갑니다. 최신 가이드와 레퍼런스를 참고해서 구성하세요. <a href="https://www.reuters.com/technology/artificial-intelligence/openai-launches-new-developer-tools-chinese-ai-startups-gain-ground-2025-03-11/?utm_source=chatgpt.com">reuters.com+1</a></li>
</ol>

<p>정리</p>

<ul>
  <li>포함되어 있는가? 에이전트 오케스트레이션은 포함, “PDF→RAG 인입 레이어”는 미포함. OpenAI 모델일 때만 FileSearchTool로 OpenAI Vector Stores를 조회할 수 있음. vLLM+gpt-oss에서는 직접 함수툴이나 MCP로 붙여야 합니다. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io+1</a></li>
</ul>

<p>원하시면 지금 쓰시는 vLLM 서버 주소와 선호 임베딩/벡터DB를 가정해, Agents SDK용 최소 예제(함수툴 기반 검색 + vLLM 연결) 스니펫을 바로 만들어 드립니다.</p>

<p class="chat--user">

openai vector store는 어떤식으로 구성되어있어?

</p>

<p>좋아요 — “OpenAI Vector Store”가 대체로 어떻게 구성되어 있는지(=아키텍처, 주요 컴포넌트, API 흐름) 같이 살펴봅시다. (약간 기술적이긴 하지만, 전체 그림을 이해하면 이후 구현할 때 훨씬 수월해요.)</p>

<hr />

<h2 id="1-기본-개념">1. 기본 개념</h2>

<p>Vector Store는 간단히 말해 “문서/청크(텍스트 단위)를 임베딩 벡터로 변환해 저장하고, 이후 검색 가능하도록 조회하는 저장소”입니다. OpenAI 쪽에서 제공하는 API는 문서를 업로드 → 임베딩/청크화(내부 처리) → 벡터저장소 생성 및 파일 바인딩 → 검색 질의(Query) → 관련 청크 반환하는 흐름을 지원합니다. <a href="https://platform.openai.com/docs/assistants/tools/file-search/vector-stores?utm_source=chatgpt.com">platform.openai.com+3</a></p>

<p>즉, 내부적으로는 다음 요소들이 있습니다:</p>

<ul>
  <li>
    <p>문서 파일(예: PDF, 텍스트) 업로드 및 처리된 파일 배치(file batch)</p>
  </li>
  <li>
    <p>벡터 변환(임베딩) + 청크(metadata 포함)</p>
  </li>
  <li>
    <p>저장소(Vector store) 객체: 여러 파일/청크들을 묶음</p>
  </li>
  <li>
    <p>검색 API: 벡터 유사도 기반 조회 → 반환된 청크와 메타정보</p>
  </li>
</ul>

<hr />

<h2 id="2-openai-api-상의-구성-요소">2. OpenAI API 상의 구성 요소</h2>

<p>OpenAI 문서를 기준으로 주요 리소스(resource)들이 어떻게 연결되는지요:</p>

<ul>
  <li>
    <p><strong>Vector Store 리소스</strong> : <code class="language-plaintext highlighter-rouge">/v1/vector_stores</code> 엔드포인트로 만들 수 있음. <a href="https://platform.openai.com/docs/api-reference/vector-stores?utm_source=chatgpt.com">platform.openai.com+1</a></p>
  </li>
  <li>
    <p><strong>파일 배치(File Batches)</strong> : 업로드된 파일이 청크/벡터화되어 저장되는 단위. <code class="language-plaintext highlighter-rouge">/v1/vector_stores/{vector_store_id}/file_batches</code> 같은 구조 있음. <a href="https://platform.openai.com/docs/api-reference/vector-stores-file-batches?utm_source=chatgpt.com">platform.openai.com</a></p>
  </li>
  <li>
    <p><strong>파일(파일 업로드)</strong> : <code class="language-plaintext highlighter-rouge">/v1/vector_stores/{vs_id}/files</code> 엔드포인트에서 파일을 추가할 수 있음. <a href="https://platform.openai.com/docs/api-reference/vector-stores-files?utm_source=chatgpt.com">platform.openai.com</a></p>
  </li>
  <li>
    <p><strong>검색(Search)</strong> : 저장된 Vector Store에 대해 “유사벡터 기반 검색”을 요청 가능 (예: 파일 검색, 청크 검색) <a href="https://platform.openai.com/docs/assistants/tools/file-search/vector-stores?utm_source=chatgpt.com">platform.openai.com+1</a></p>
  </li>
</ul>

<hr />

<h2 id="3-흐름-예시로-보기">3. 흐름 예시로 보기</h2>

<p>아래처럼 단계별 구성됩니다:</p>

<ol>
  <li>
    <p>파일 업로드</p>

    <ul>
      <li>예: PDF를 업로드 → OpenAI 측에서 자동으로 청크화/임베딩/저장 준비 → 파일 배치 생성</li>
    </ul>
  </li>
  <li>
    <p>Vector Store 생성</p>

    <ul>
      <li>저장소 이름, 설명 등의 메타데이터 제공 → 생성</li>
    </ul>
  </li>
  <li>
    <p>파일을 Vector Store에 바인딩(=파일 추가)</p>

    <ul>
      <li>생성한 Vector Store ID에 파일 배치/파일을 업로드하는 API 호출</li>
    </ul>
  </li>
  <li>
    <p>검색 요청</p>

    <ul>
      <li>
        <p>사용자가 질의(query)를 보내면, API는 임베딩 생성 → 저장된 벡터들과 유사도 비교 → 관련 청크 반환</p>
      </li>
      <li>
        <p>반환된 청크를 기반으로 응답 생성(LLM 호출 전처리 역할)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>LLM 호출(별도)</p>

    <ul>
      <li>검색된 청크는 LLM(예: gpt-모델)에 컨텍스트로 전달 → 답변 생성</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="4-주요-특성-및-한계">4. 주요 특성 및 한계</h2>

<ul>
  <li>
    <p>파일/문서 메타데이터는 비교적 제한적: 업로드된 파일이 얼마나 긴지(token count, char count) 등의 정보 부족하다는 사용자의 피드백이 있음. <a href="https://www.reddit.com/r/OpenAI/comments/1lacgqe/openais_vector_store_api_is_missing_basic/?utm_source=chatgpt.com">Reddit</a></p>
  </li>
  <li>
    <p>청크화 + 임베딩 + 저장/관리 과정을 “사용자제어” 하려면 OpenAI 호스티드 기능보다는 자체 벡터DB + 임베딩 워크플로우가 더 유연함</p>
  </li>
  <li>
    <p>검색 품질은 임베딩 모델(어떤 모델을 썼는가) + 청크 단위/문서 구조 설계에 크게 좌우됨</p>
  </li>
</ul>

<hr />

<h2 id="5-gpt-ossvllm-활용-시-고려사항">5. gpt-oss/vLLM 활용 시 고려사항</h2>

<p>당신이 vLLM + gpt-oss 조합으로 쓰는 상황이라면, OpenAI Vector Store API를 그대로 의존하기보다는 다음과 같은 변형이 필요할 수 있어요:</p>

<ul>
  <li>
    <p>OpenAI Vector Store API를 쓰고 싶으면 OpenAI 인증/요금/호스팅 구조 따라야 함</p>
  </li>
  <li>
    <p>또는 자체 벡터DB(예: FAISS, Milvus 등) + 임베딩 모델 + 검색 함수툴을 만들어서 “유사 기능”을 구현</p>
  </li>
  <li>
    <p>Agents SDK나 워크플로우에서는 “검색 툴(tool)”이 이 저장소와 연결됨: 사용자가 질의하면 검색툴이 관련 청크를 꺼내오고, LLM에게 문맥으로 제공</p>
  </li>
</ul>

<hr />

<p>필요하시다면, OpenAI Vector Store API를 실제로 호출하는 예제 코드(Python) 만들어 드릴 수 있어요—특히 파일 업로드 → 검색까지 흐름. 그렇게 할까요?</p>

<p class="chat--user">

마지막에 말한 검색툴은 자동으로 동작하는건지 llm이 요청하면 동작하는건지 궁금해

</p>

<p>아주 핵심을 짚으셨습니다.<br />
OpenAI의 “검색 툴(FileSearchTool)”은 <strong>자동으로 동작하지 않습니다</strong>.<br />
LLM이 “필요하다고 판단할 때” — 즉, <strong>모델이 툴 호출을 생성하면</strong> — 그때 실행됩니다.</p>

<p>이걸 조금 더 세밀하게 뜯어보면 이렇게 됩니다.</p>

<hr />

<h3 id="1-에이전트의-기본-구조">1. 에이전트의 기본 구조</h3>

<p>OpenAI Agents SDK(혹은 Responses API)에서 에이전트는 다음 두 가지를 갖습니다.</p>

<ul>
  <li>
    <p><strong>LLM 모델</strong> : gpt-4o, gpt-4o-mini 등</p>
  </li>
  <li>
    <p><strong>툴(tool)</strong> : 함수 호출(Function Tool), FileSearchTool, WebSearchTool, CodeInterpreter 등</p>
  </li>
</ul>

<p>에이전트는 LLM에게 “너는 이런 툴들을 쓸 수 있다”고 알려주고,<br />
대화 중에 LLM이 판단해 특정 툴을 호출할 때만 실제 실행 로직이 수행됩니다.</p>

<hr />

<h3 id="2-툴-호출-과정">2. 툴 호출 과정</h3>

<p>모델이 내부적으로 이런 구조의 응답을 냅니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function_call"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"arguments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"계약서 요약"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>SDK는 이걸 감지하고 <strong>search() 함수</strong> (혹은 FileSearchTool)을 호출합니다.<br />
그 결과를 받아 모델에게 다시 전달하면, 모델은 그 결과를 바탕으로 <strong>최종 답변</strong> 을 만듭니다.</p>

<p>즉, LLM이 툴 사용을 “결정”하고, 호출은 SDK가 “대리 실행”합니다.</p>

<hr />

<h3 id="3-자동성과-자율성의-정도">3. 자동성과 자율성의 정도</h3>

<ul>
  <li>
    <p><strong>자동 실행 아님</strong> : 사용자가 “검색을 꼭 하라”고 지정하지 않으면, 모델이 문맥상 필요하다고 판단해야 호출합니다.</p>
  </li>
  <li>
    <p><strong>프롬프트 설계 가능</strong> : system prompt 에 “파일 내용을 참조할 때는 항상 FileSearchTool을 사용하라”처럼 명시해 주면 호출 확률이 높아집니다.</p>
  </li>
  <li>
    <p><strong>Agent Loop</strong> : SDK가 이 과정을 자동 반복해줍니다. 모델이 툴 호출 → 실행 → 결과 전달 → 다시 모델 호출 … 최종 답변이 완성될 때까지 루프를 돕습니다.</p>
  </li>
</ul>

<hr />

<h3 id="4-예시로-보는-흐름">4. 예시로 보는 흐름</h3>

<p>사용자: “이 계약서 요약해줘.”</p>

<ol>
  <li>
    <p>모델은 FileSearchTool이 등록되어 있음을 알고 있음.</p>
  </li>
  <li>
    <p>LLM이 내부적으로 판단: “파일에서 내용 가져와야 하네.”</p>
  </li>
  <li>
    <p>LLM → <code class="language-plaintext highlighter-rouge">function_call: file_search(query="계약서 요약")</code></p>
  </li>
  <li>
    <p>SDK → 실제 Vector Store 검색 수행</p>
  </li>
  <li>
    <p>검색 결과를 모델에게 다시 입력</p>
  </li>
  <li>
    <p>모델 → 검색 결과를 요약한 최종 답변 생성</p>
  </li>
</ol>

<hr />

<h3 id="5-vllm--gpt-oss-조합에서는">5. vLLM + gpt-oss 조합에서는</h3>

<p>vLLM은 OpenAI의 Responses API 내부 오케스트레이션 기능이 없습니다.<br />
따라서 “자동 툴 호출”을 구현하려면 SDK가 필요합니다.<br />
직접 서버나 에이전트 루프를 만들고, 모델의 함수 호출 결과(JSON)를 해석해 수동으로 “search() → 결과 → 모델 재호출”을 구현해야 합니다.</p>

<hr />

<p>정리하자면:<br />
<strong>FileSearchTool은 모델이 필요하다고 판단할 때만 호출되고, SDK가 실행을 중계합니다.</strong><br />
즉, “모델이 요청하면 자동으로 동작한다”는 표현이 가장 정확합니다.</p>

<p>다음 단계로, 원하신다면 vLLM + gpt-oss 조합에서 이 “툴 호출 루프”를 흉내내는 최소 예제(모델 → function_call → search → 재호출)를 만들어 드릴 수 있습니다.</p>

<p class="chat--user">

영어로 작성된 문서 rag를 한글로 쿼리할 수 있어?

</p>

<p>가능합니다. 방법은 크게 두 가지 계열입니다. 한글 쿼리 → 영어 문서 RAG를 지원하려면 “다국어 임베딩”을 쓰거나 “번역 레이어”를 끼우면 됩니다.</p>

<ol>
  <li>다국어 임베딩으로 직접 검색</li>
</ol>

<ul>
  <li>
    <p>핵심: 영어 문서 청크와 한국어 쿼리를 같은 임베딩 공간으로 매핑.</p>
  </li>
  <li>
    <p>모델 예: bge-m3, e5-multilingual, LaBSE, mContriever 등.</p>
  </li>
  <li>
    <p>장점: 번역 없이도 개념 맞춤. 고유명사·전문용어에 강함.</p>
  </li>
  <li>
    <p>단점: 임베딩 품질·차원 수가 커서 메모리↑. 영어 전용 임베딩 대비 약간의 정밀도 손실이 있을 수 있음.</p>
  </li>
</ul>

<ol>
  <li>번역 후 검색(translate-then-retrieve)</li>
</ol>

<ul>
  <li>
    <p>파이프라인: 한글 쿼리 → 영어로 번역 → 영어 전용 임베딩(예: e5-large, bge-large-en 등)으로 검색 → 답변은 한글로 생성.</p>
  </li>
  <li>
    <p>장점: 영어 전용 임베딩/리랭커 품질을 그대로 활용 가능.</p>
  </li>
  <li>
    <p>단점: 번역 오류가 쿼리의 핵심 토픽을 비트는 경우가 있음. 엔티티(제품명, 표기) 주의.</p>
  </li>
</ul>

<p>권장 설계(현업 안정판)</p>

<ul>
  <li>
    <p>인덱싱: 영어 문서를 문단/문장 단위로 청크, 메타데이터(페이지, 섹션, 언어=en) 저장.</p>
  </li>
  <li>
    <p>임베딩: 다국어 임베딩 인덱스 1개는 반드시 구축. 여력이 되면 영어 전용 인덱스를 추가로 구성해 듀얼 인덱스 검색.</p>
  </li>
  <li>
    <p>검색 전략: 한글 쿼리에 대해</p>

    <ol>
      <li>
        <p>다국어 인덱스에서 top-k</p>
      </li>
      <li>
        <p>영어 전용 인덱스(쿼리 번역)에서도 top-k</p>
      </li>
      <li>
        <p>두 결과를 점수 정규화 후 병합</p>
      </li>
    </ol>
  </li>
  <li>
    <p>리랭킹: 다국어 리랭커(bge-reranker-v2-m3 같은 범용 다국어 리랭커)로 상위 50→10 재정렬.</p>
  </li>
  <li>
    <p>하이브리드: BM25(키워드) + 벡터 점수 가중 평균. 고유명사 매칭 강화.</p>
  </li>
  <li>
    <p>생성: gpt-oss(vLLM)에 “출처 표시, 영어 인용문은 원문 유지, 최종 답변은 한국어”를 시스템 규칙으로 주입.</p>
  </li>
</ul>

<p>간단 파이프라인 예시(핵심 로직만)</p>

<ul>
  <li>
    <p>인덱싱</p>

    <ol>
      <li>
        <p>PDF → 텍스트 추출 → 청크</p>
      </li>
      <li>
        <p>multilingual_embed(chunks) → FAISS/Chroma/PGVector에 저장</p>
      </li>
      <li>
        <p>선택: english_embed(chunks)로 영어 전용 인덱스도 병행 구축</p>
      </li>
    </ol>
  </li>
  <li>
    <p>질의</p>

    <ol>
      <li>
        <p>ko_query → multilingual_embed(ko_query)로 검색</p>
      </li>
      <li>
        <p>ko_query → en_query로 번역 → english_embed(en_query)로 검색</p>
      </li>
      <li>
        <p>결과 병합 → 다국어 리랭킹</p>
      </li>
      <li>
        <p>상위 n개를 컨텍스트로 vLLM에 넣고 한국어로 답변 생성</p>
      </li>
    </ol>
  </li>
</ul>

<p>프롬프트 팁</p>

<ul>
  <li>
    <p>시스템 규칙에 “문헌은 영어 원문을 그대로 인용, 설명은 한국어로 작성, 출처 페이지/섹션을 함께 적시”를 명시.</p>
  </li>
  <li>
    <p>다국어 혼용 문서일 경우 “언어 감지 → 쿼리와 다른 언어라도 동일 개념이면 포함” 같은 지침을 추가.</p>
  </li>
</ul>

<p>실무 체크리스트</p>

<ul>
  <li>
    <p>토크나이저 길이: 청크는 200~400토큰(문단 경계 유지).</p>
  </li>
  <li>
    <p>메타데이터: page, section, filename, lang. 답변에 근거 표시 용이.</p>
  </li>
  <li>
    <p>고유명사: 대소문자·하이픈·스네이크케이스 보존. 정규화 과도하게 하지 않기.</p>
  </li>
  <li>
    <p>캐싱: 빈번한 쿼리 번역/임베딩 결과 캐시.</p>
  </li>
  <li>
    <p>평가: 한-영 쌍으로 질의–정답 골드셋을 만들어 MRR@n, Hit@n, nDCG로 비교.</p>
  </li>
</ul>

<p>vLLM + gpt-oss 연결 포인트</p>

<ul>
  <li>
    <p>위 검색 결과(top-k 청크)를 user 메시지에 CONTEXT로 넣고 질문은 한국어로 전달.</p>
  </li>
  <li>
    <p>답변은 한국어로 강제, 필요한 부분만 영어 원문 인용.</p>
  </li>
  <li>
    <p>함수툴(예: search_docs)을 한 개 제공해 “모델이 필요 시 호출”하도록하면 자동 루프(에이전트 스타일)도 재현 가능.</p>
  </li>
</ul>

<p>요약</p>

<ul>
  <li>가능하고, 실전에서는 “다국어 임베딩 + 번역 병행 + 리랭킹”이 안정적입니다. 이미 구축된 영어 코퍼스에 최소 변경으로 한글 질의를 붙일 수 있고, gpt-oss 서빙과도 잘 맞습니다.</li>
</ul>

<p class="chat--user">

아 그리고 아까 search function을 만든다고 했잖아. 그 함수는 모든 RAG 문서를 다 뒤져 아니면 문서가 만약 100개 등록됐다고 치면 가장 관련된 10개만 추려서 10개에 대한 매칭만 해?

</p>

<p>짧게 핵심부터: 잘 만든 search 함수는 “전부 뒤지기”가 아니라 보통 2단계로 좁힙니다. 1단계에서 문서 레벨로 상위 N개를 고르고, 2단계에서 그 문서들 안에서 청크 레벨로 상위 K개만 뽑아 LLM에 넣습니다. 보편값은 N≈5~20, K≈3~8, 그리고 최종 컨텍스트 토큰 상한으로 컷을 겁니다.</p>

<p>아키텍처를 단계별로 정리해볼게요.</p>

<ol>
  <li>컬렉션과 인덱스</li>
</ol>

<ul>
  <li>
    <p>문서 100개가 등록되어 있다면 우선 전부를 하나의 벡터 인덱스(또는 컬렉션)로 관리합니다.</p>
  </li>
  <li>
    <p>문서 메타데이터(파일명, 섹션, 날짜, 언어, 권한, 태그)를 함께 저장해 필터링에 활용합니다.</p>
  </li>
  <li>
    <p>하이브리드 검색 권장: 벡터(의미) + BM25(키워드)를 함께 써서 고유명사·숫자 매칭을 보완합니다.</p>
  </li>
</ul>

<ol>
  <li>1단계: 문서 레벨 프리셀렉션</li>
</ol>

<ul>
  <li>
    <p>쿼리 임베딩과 문서 대표 벡터를 비교해 상위 N개 문서를 고릅니다.</p>
  </li>
  <li>
    <p>문서 대표 벡터는 보통 문서 제목+요약(abstract) 또는 상위 몇 개 청크의 평균으로 만듭니다.</p>
  </li>
  <li>
    <p>필터 예: lang=en, updated_at&gt;2025-01-01, tag in [“policy”, “spec”] 같은 조건을 먼저 걸어 탐색 공간을 줄입니다.</p>
  </li>
  <li>
    <p>다중 전략 결합: 벡터 상위 N1, BM25 상위 N2를 뽑아 Reciprocal Rank Fusion 같은 방식으로 합칩니다.</p>
  </li>
</ul>

<ol>
  <li>2단계: 청크 레벨 정밀 검색</li>
</ol>

<ul>
  <li>
    <p>선택된 N개 문서 각각에서 top_k_chunks_per_doc=K로 청크를 뽑습니다.</p>
  </li>
  <li>
    <p>중복·유사 청크는 Max Marginal Relevance(MMR)로 다양화합니다.</p>
  </li>
  <li>
    <p>전체 모아서 재랭킹: 다국어 리랭커 또는 cross-encoder로 상위 50→최종 10개로 줄입니다.</p>
  </li>
</ul>

<ol>
  <li>컨텍스트 빌더</li>
</ol>

<ul>
  <li>
    <p>최종 청크들을 근거 메타데이터와 함께 LLM 컨텍스트로 직조합니다.</p>
  </li>
  <li>
    <p>토큰 한도(max_context_tokens)에 맞춰 자르고, 가능한 한 문단 경계를 유지합니다.</p>
  </li>
  <li>
    <p>규칙을 강제: 답변은 한국어, 인용은 원문 유지, 각 근거에 페이지/섹션 표기.</p>
  </li>
</ul>

<ol>
  <li>운영 팁</li>
</ol>

<ul>
  <li>
    <p>쿼리 라우팅: 분야별 컬렉션이 여러 개면 먼저 라우터(분야 분류기)로 컬렉션을 1~2개로 좁힌 뒤 위 과정을 수행합니다.</p>
  </li>
  <li>
    <p>캐싱: 잦은 쿼리의 임베딩과 상위 결과를 캐시해 지연을 줄입니다.</p>
  </li>
  <li>
    <p>임계값: 유사도 스코어가 임계값 미만이면 “근거 없음”으로 처리해 환각을 줄입니다.</p>
  </li>
  <li>
    <p>권한: 멀티유저라면 문서별 ACL을 메타데이터 필터에 반드시 반영합니다.</p>
  </li>
  <li>
    <p>실험: N, K, 임계값을 검증셋으로 튜닝합니다. 일반적으로 N을 늘리면 리콜↑, 지연/비용↑.</p>
  </li>
</ul>

<p>간단한 의사코드</p>

<ul>
  <li>
    <p>입력: query, filters, top_docs=N, top_chunks_per_doc=K, max_context_tokens</p>
  </li>
  <li>
    <p>출력: ranked_chunks</p>
  </li>
</ul>

<ol>
  <li>
    <p>q_emb = embed(query)</p>
  </li>
  <li>
    <p>doc_candidates = fuse(<br />
vector_search(DOC_INDEX, q_emb, N_vec),<br />
bm25_search(DOC_TEXTS, query, N_bm25)<br />
)[:N]</p>
  </li>
  <li>
    <p>chunk_pool = []<br />
for d in doc_candidates:<br />
chunk_pool += vector_search(d.CHUNK_INDEX, q_emb, K)</p>
  </li>
  <li>
    <p>chunk_pool = mmr_dedup(chunk_pool)</p>
  </li>
  <li>
    <p>ranked = rerank_cross_encoder(query, chunk_pool)</p>
  </li>
  <li>
    <p>context = pack_by_tokens(ranked, max_context_tokens)</p>
  </li>
  <li>
    <p>return context, ranked[:final_k]</p>
  </li>
</ol>

<p>질문으로 주신 두 선택지를 정리하자면</p>

<ul>
  <li>
    <p>모든 RAG 문서를 다 뒤지는 일괄 전수검색은 규모가 커질수록 느려지고 비용이 큽니다.</p>
  </li>
  <li>
    <p>보통은 “가장 관련된 문서 상위 N개”를 추려 그 안에서만 K개 청크를 뽑는 계층적 검색을 씁니다. 100개 문서면 상위 10개 문서 × 문서당 5개 청크 같은 구성이 현실적입니다.</p>
  </li>
</ul>

<p>마지막으로 숫자 레시피 예시</p>

<ul>
  <li>
    <p>top_docs=10, top_chunks_per_doc=5, rerank_top=60→final=12, max_context_tokens=6k</p>
  </li>
  <li>
    <p>하이브리드 비율: vector:bm25 = 0.7:0.3 가중 평균</p>
  </li>
  <li>
    <p>임계값: cosine &lt; 0.25면 제외, 문서 최신가중치 e^(−λ·age_days) 적용</p>
  </li>
</ul>

<p>이렇게 구성하면 정확도·지연·비용의 균형이 좋아지고, 쿼리 폭이 넓어져도 깔끔하게 확장됩니다.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI Debug 노드 리팩터링</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor/" rel="alternate" type="text/html" title="ComfyUI Debug 노드 리팩터링" /><published>2025-11-04T12:48:12+09:00</published><updated>2025-11-04T12:48:12+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor/"><![CDATA[<p class="chat--user">

이거 내가 개발한 ComfyUI 노드야. 스트링 여러 개가 입력되었을 때 인덱스 선택하는 콤보 위젯 + 선택된 텍스트를 보여주는 텍스트 위젯으로 되어 있어. 
<code class="language-plaintext highlighter-rouge">
js
import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
    name: "hvppyflow.debug_nodes",
    async beforeRegisterNodeDef(nodeType, nodeData, app) {
        if (nodeData.name === "HFDebug") {
            const onExecuted = nodeType.prototype.onExecuted;
            nodeType.prototype.onExecuted = function (message) {
                onExecuted?.apply(this, arguments);

                this.properties.text = message["text"]

                let comboWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displayindex");
                let textWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displaytext");
                if (!comboWidget) {
                    comboWidget = this.addWidget("combo", "displayindex", 0, () =&gt; {
                        comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                        textWidget.value = message["text"]?.[comboWidget.value];       
                    }, {values: Array.from({ length: message["text"].length }, (_, i) =&gt; i)});
                    comboWidget.value = 0;
                } 
                if (!textWidget) {
                    textWidget = ComfyWidgets["STRING"](this, "displaytext", ["STRING", { multiline: true }], app).widget;
                    textWidget.inputEl.readOnly = true;
                    textWidget.inputEl.style.border = "none";
                    textWidget.inputEl.style.backgroundColor = "transparent";
                    textWidget.serialize = false;
                    textWidget.options.serialize = false; // Prevent prompt serialization
                }
                
                if (comboWidget.options.values.length !== message["text"].length) {
                    comboWidget.options.values = Array.from({ length: message["text"].length }, (_, i) =&gt; i);
                    comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                }
                textWidget.value = message["text"]?.[comboWidget.value];

                comboWidget.onChange = (data) =&gt; {
                    console.log("Combo changed" + comboWidget.value);
                    const index = comboWidget.value;
                    textWidget.value = message["text"]?.[index];
                };
            };

            const onConfigure = nodeType.prototype.onConfigure;
            nodeType.prototype.onConfigure = function () {
                onConfigure?.apply(this, arguments);
                
                let comboWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displayindex");
                let textWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displaytext");
                if (!comboWidget) {
                    comboWidget = this.addWidget("combo", "displayindex", 0, () =&gt; {
                        comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                        textWidget.value = this.properties?.text?.[comboWidget.value];
                    }, {values: Array.from({ length: this.properties?.text.length ?? 0 }, (_, i) =&gt; i)});
                    comboWidget.value = 0;
                }
                if (!textWidget) {
                    textWidget = ComfyWidgets["STRING"](this, "displaytext", ["STRING", { multiline: true }], app).widget;
                    textWidget.inputEl.readOnly = true;
                    textWidget.inputEl.style.border = "none";
                    textWidget.inputEl.style.backgroundColor = "transparent";
                    textWidget.serialize = false;
                    textWidget.options.serialize = false; // Prevent prompt serialization
                }

                if (comboWidget.options.values.length !== this.properties?.text.length) {
                    comboWidget.options.values = Array.from({ length: this.properties?.text.length }, (_, i) =&gt; i);
                    comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                }

                comboWidget.onChange = (data) =&gt; {
                    console.log("Combo changed" + comboWidget.value);
                    const index = comboWidget.value;
                    textWidget.value = this.properties?.text?.[index];
                };

                if (this.properties?.text) {
                    textWidget.value = this.properties?.text?.[comboWidget.value];
                }
            };
        }
    },
});
</code>
<code class="language-plaintext highlighter-rouge">python
class HFDebug:
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "text": ("STRING", {"forceInput": True}),
            },
            "hidden": {
                "unique_id": "UNIQUE_ID",
            },
        }

    @classmethod
    def IS_CHANGED(cls, **kwargs):
        import logging
        logging.info("HPDebug - IS_CHANGED called with kwargs: %s", kwargs)
        text = kwargs.get("text")
        if isinstance(text, list):
            return tuple(text)
        return text

    INPUT_IS_LIST = True
    RETURN_TYPES = ("STRING",)
    FUNCTION = "notify"
    OUTPUT_NODE = True
    OUTPUT_IS_LIST = (True,)
    CATEGORY = "utils"

    def notify(self, text, unique_id=None):
        return {"ui": {"text": text}, "result": (text,)}
</code>

여기서 string 리스트 길이가 1이면 콤보 위젯은 헷갈기만 하니까 그냥 생성을 안하도록 하고 싶어. 다양한 변수를 고려해서 작성해줘(리스트 길다가 -&gt; 1개로 줄어들 때, 1개 였다가 여러개가 될 때, 길이가 변할 때 등등) 그리고 내가 js 초보자라 좀 쓸데 없이 코드가 긴 것 같은데 정리도 해주면 좋겠어. 그리고 버그인진 모르겠는데 버그가 있어. 화살표로 넘기면 page가 1 -&gt; 2 이런 식으로 변해야할 것 같은데 항상 0으로 돌아가. 클릭해서 콤보 선택으로 넘겨야만 잘 돌아가. 이 버그도 고쳐주면 좋겠어

</p>

<p>좋아, 요구사항을 전부 반영해서 JS 쪽을 깔끔하게 리팩터링하고, “리스트 길이 = 1이면 콤보 위젯을 만들지 않기”, “길이가 늘었다/줄었다/변했다 케이스 모두 처리”, “키보드 화살표로 바꿀 때 0으로 되돌아가는 버그”까지 잡은 버전을 아래에 제시할게. 핵심 아이디어는 다음이야.</p>

<ol>
  <li>
    <p>선택 인덱스를 this.properties.selectedIndex로 보존해서 재실행(onExecuted)·재구성(onConfigure) 시에 값이 덮어써지지 않게 함.</p>
  </li>
  <li>
    <p>콤보 위젯은 “필요할 때만” 만들고(길이 ≥ 2), 불필요하면 제거. 제거 시에 안전하게 widgets 배열에서 뺀 뒤 노드 크기 재계산.</p>
  </li>
  <li>
    <p>onChange 안에서 comboWidget.value를 다시 건드리지 않음. 사용자가 키보드/마우스로 바꾼 값을 그대로 쓰고, 그 값을 properties에 저장만 함.</p>
  </li>
  <li>
    <p>옵션 길이가 바뀌어도 현재 selectedIndex를 최대 길이-1로만 클램프하고, 굳이 0으로 초기화하지 않음.</p>
  </li>
  <li>
    <p>입력이 string 하나이든 list이든 안전하게 처리(Array 래핑). 길이 0도 방어.</p>
  </li>
</ol>

<p>아래 코드로 교체하면 돼.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // ---------- 유틸: 안전한 remove ----------
    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        // LiteGraph/ComfyUI에서는 크기 재계산이 필요함
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    // ---------- 유틸: 텍스트를 항상 배열로 ----------
    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    // ---------- 유틸: 텍스트 위젯 확보 ----------
    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false; // 프롬프트 직렬화 방지
      }
      return textWidget;
    }

    // ---------- 유틸: 콤보 위젯 보장/업데이트 또는 제거 ----------
    function syncComboWidget(node, count) {
      let comboWidget = node.widgets?.find(w =&gt; w.name === "displayindex");

      // 길이 0 또는 1이면 콤보 제거
      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      // 필요: 콤보 생성
      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "displayindex",
          0,
          // 콜백에서는 value를 다시 세팅하지 말고, properties/텍스트만 동기화
          () =&gt; {
            const idx = Number(comboWidget.value) || 0;
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values: Array.from({ length: count }, (_, i) =&gt; i) }
        );
        comboWidget.serialize = false; // 필요시 직렬화 방지
      }

      // 옵션 길이 변경 반영
      const needUpdate =
        !comboWidget.options?.values ||
        comboWidget.options.values.length !== count;

      if (needUpdate) {
        comboWidget.options.values = Array.from({ length: count }, (_, i) =&gt; i);
      }

      // 현재 선택 인덱스를 보존/클램프
      const current = Number(node.properties.selectedIndex ?? comboWidget.value ?? 0);
      const clamped = Math.max(0, Math.min(current, count - 1));
      // 사용자 키입력을 덮어쓰지 않기 위해 "필요할 때만" 동기화
      if (comboWidget.value !== clamped) {
        comboWidget.value = clamped;
      }
      node.properties.selectedIndex = clamped;

      return comboWidget;
    }

    // ---------- 유틸: 텍스트/콤보/선택 상태 동기화 ----------
    function syncUI(node, texts) {
      // 텍스트를 properties에 저장 (onConfigure 재구성용)
      node.properties.text = texts;

      // 콤보 생성/제거
      const comboWidget = syncComboWidget(node, texts.length);

      // 텍스트 위젯 보장 및 값 반영
      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      // onChange는 한 번만 설정 (중복 등록 방지)
      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = Number(comboWidget.value) || 0;
          node.properties.selectedIndex = i;
          textWidget.value = texts[i] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    // ---------- onExecuted ----------
    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      // 최신 결과 수신
      const texts = normalizeToArray(message?.text);

      // 길이 변화(늘거나/줄거나/1개가 됨/여러 개가 됨)를 모두 커버
      // 선택 인덱스를 "필요 시"만 클램프하여 보존
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };

    // ---------- onConfigure ----------
    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>버그 원인과 해결 포인트 설명</p>

<ol>
  <li>
    <p>값 리셋 요인 제거<br />
기존 코드에서는 콤보 생성 직후 comboWidget.value = 0 같은 강제 초기화가 있었고, addWidget 콜백에서 comboWidget.value를 다시 세팅하는 로직도 섞여 있어서 사용자의 키보드 변경 직후 여러 경로로 값이 덮어써질 여지가 있었어. 새 코드는 사용자 입력 흐름을 존중해 “onChange에서 properties와 텍스트만 동기화”하고, 콤보 value를 임의로 다시 쓰지 않아 키보드(화살표) 조작 시 0으로 리셋되지 않아.</p>
  </li>
  <li>
    <p>상태의 단일 소스<br />
선택 인덱스를 this.properties.selectedIndex로 통일해서 onExecuted, onConfigure 사이에서 일관성 있게 유지돼. 데이터 길이가 변할 때도 selectedIndex를 최대 길이-1로만 클램프하니 사용자가 고른 페이지가 가능한 한 유지돼.</p>
  </li>
  <li>
    <p>콤보 동적 생성/제거<br />
texts.length ≤ 1이면 콤보를 제거하고, ≥ 2이면 필요 시에만 생성해. 길이가 1→여러 개, 여러 개→1, 혹은 N이 바뀌는 경우에도 syncComboWidget이 알아서 옵션/선택/제거를 처리해.</p>
  </li>
  <li>
    <p>위젯 제거 안전성<br />
removeWidget 유틸로 widgets 배열에서 안전하게 빼고, computeSize를 호출해서 노드 레이아웃이 깨지지 않도록 했어.</p>
  </li>
</ol>

<p>추가로 고려한 엣지 케이스</p>

<ul>
  <li>
    <p>text가 아예 오지 않거나(null/undefined) 빈 리스트일 때에도 빈 배열로 처리하고 텍스트 위젯엔 빈 문자열 표시.</p>
  </li>
  <li>
    <p>콤보 옵션이 갱신될 때 현재 선택 인덱스를 유지 가능한 범위에서 유지(클램프만 수행).</p>
  </li>
  <li>
    <p>직렬화 방지: 표시용 위젯들은 serialize를 false로 둬서 프롬프트에 새는 걸 막음.</p>
  </li>
</ul>

<p>파이썬 쪽은 건드릴 필요 없어 보이지만, 혹시 텍스트가 항상 리스트가 되길 원한다면 notify에서 ui 쪽으로 항상 list를 주는 지금 구현이 이미 적절해. IS_CHANGED에서 리스트면 튜플로 바꿔주는 것도 캐시 무효화에 도움이 되니 그대로 두면 돼.</p>

<p>다음 단계로 이어가기</p>

<ul>
  <li>
    <p>콤보 대신 좌우 화살표 버튼(두 개의 push 버튼 위젯)을 원하는 경우에도 같은 selectedIndex를 써서 쉽게 확장 가능해.</p>
  </li>
  <li>
    <p>텍스트가 매우 길다면 표시용 위젯 높이/자동 줄바꿈을 추가로 조절할 수 있어(style.whiteSpace, style.height 등).</p>
  </li>
</ul>

<p class="chat--user">

Array 원소가 숫자로 되어있으니 잘 동작을 안 하는 것 같아. 문자열로 바꿔줘

</p>

<p>좋아. 콤보 옵션과 value를 전부 문자열로 바꾸고, 내부 상태는 숫자로 유지하도록 정리했어. 핵심은 다음 두 가지야.</p>

<ol>
  <li>
    <p>UI 쪽(콤보)은 "라벨 문자열"을 사용한다. 예: "0", "1", "2"</p>
  </li>
  <li>
    <p>로직 쪽(프로퍼티 selectedIndex, 인덱싱)은 숫자를 사용한다. 변환기는 labelToIndex, indexToLabel 두 함수를 쓴다.</p>
  </li>
</ol>

<p>아래 코드는 이전에 준 리팩터 버전에서 “문자열 라벨”만을 위한 변경을 반영한 완성본이야.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // 라벨/인덱스 변환기
    const indexToLabel = (i) =&gt; String(i);
    const labelToIndex = (v) =&gt; {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : 0;
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // count에 맞춰 콤보를 생성/업데이트(라벨은 문자열), 불필요하면 제거
    function syncComboWidget(node, count) {
      let comboWidget = node.widgets?.find(w =&gt; w.name === "displayindex");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "displayindex",
          indexToLabel(0), // 문자열 라벨로 초기값
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values: Array.from({ length: count }, (_, i) =&gt; indexToLabel(i)) }
        );
        comboWidget.serialize = false;
      }

      const needUpdate =
        !comboWidget.options?.values ||
        comboWidget.options.values.length !== count;

      if (needUpdate) {
        comboWidget.options.values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i));
      }

      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx);

      if (comboWidget.value !== desiredLabel) {
        comboWidget.value = desiredLabel; // 콤보에는 문자열 라벨을 넣는다
      }
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);

      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          node.properties.selectedIndex = i;
          textWidget.value = texts[i] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>무엇이 바뀌었는지 한 줄 요약<br />
콤보의 options.values와 value를 모두 문자열("0","1","2", …)로 통일했고, 선택 상태는 this.properties.selectedIndex에 숫자로 저장되며 labelToIndex/indexToLabel로 변환해 동기화한다. 이로써 숫자 원소 때문에 선택이 꼬이는 문제와 화살표 조작 시 되돌아가는 증상 모두 방지된다.</p>

<p>다음 확장 아이디어<br />
라벨을 단순 순번이 아니라 “1 / N” 같은 사용자 친화형 문자열로 바꾸고 싶다면 indexToLabel을 i =&gt; <code class="language-plaintext highlighter-rouge">${i+1} / ${count}</code> 형태로 바꿔도 된다. 이때는 labelToIndex를 해당 형식에 맞게 파싱해주면 된다.</p>

<p class="chat--user">

응 사용자 친화적으로 가자. 1부터 인덱스로 가고 분모도 써주자. 라벨 이름도 displayindex 대신 page 로 바꾸자.

</p>

<p>좋지. 콤보 라벨을 “1 / N” 형식으로 바꾸고, 위젯 이름도 displayindex → page로 변경했어. 내부 로직은 0-based 숫자 인덱스를 유지하고, UI와의 경계에서만 문자열 라벨로 변환해. 기존 노드에 displayindex가 남아있을 수 있으니 마이그레이션으로 발견 즉시 제거하도록 처리했어.</p>

<p>핵심 변경점 요약</p>

<ul>
  <li>
    <p>콤보 라벨: “1 / N” (1부터 시작, 전체 길이 표기)</p>
  </li>
  <li>
    <p>콤보 위젯 이름: page</p>
  </li>
  <li>
    <p>selectedIndex는 숫자(0-based)로 유지, 라벨↔인덱스 변환기로 동기화</p>
  </li>
  <li>
    <p>길이 변화, 1개일 때 콤보 제거, 화살표 조작 시 값 리셋 방지 그대로 계승</p>
  </li>
</ul>

<p>교체 코드</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // 라벨/인덱스 변환기: "k / N" ↔ 0-based index
    const indexToLabel = (i, count) =&gt; `${i + 1} / ${count}`;
    const labelToIndex = (label) =&gt; {
      // "12 / 34" 같은 문자열에서 첫 번째 숫자만 잡아서 1 빼기
      const m = String(label).match(/\d+/);
      const k = m ? parseInt(m[0], 10) : 1;
      const idx = Number.isFinite(k) ? k - 1 : 0;
      return Math.max(0, idx);
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // count에 맞춰 콤보(page)를 생성/업데이트(라벨은 "1 / N"), 불필요하면 제거
    function syncComboWidget(node, count) {
      // 구버전(displayindex) 잔존 시 제거 (마이그레이션)
      const legacy = node.widgets?.find(w =&gt; w.name === "displayindex");
      if (legacy) removeWidget(node, legacy);

      let comboWidget = node.widgets?.find(w =&gt; w.name === "page");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      const values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i, count));

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "page",
          values[0],
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values }
        );
        comboWidget.serialize = false;
      } else {
        // 옵션 길이 변경 반영
        const needUpdate = !comboWidget.options?.values ||
                           comboWidget.options.values.length !== count ||
                           comboWidget.options.values[0] !== values[0];
        if (needUpdate) comboWidget.options.values = values;
      }

      // 현재 선택 인덱스 유지(클램프) 후 라벨과 동기화
      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx, count);

      if (comboWidget.value !== desiredLabel) comboWidget.value = desiredLabel;
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);

      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          const cl = Math.max(0, Math.min(i, texts.length - 1));
          node.properties.selectedIndex = cl;
          comboWidget.value = indexToLabel(cl, texts.length); // 불일치 시 교정
          textWidget.value = texts[cl] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;

      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>작동 방식 설명</p>

<ul>
  <li>
    <p>UI 라벨은 항상 “현재페이지(1-based) / 전체길이” 문자열로 보여주고, 내부 상태는 0-based 숫자 인덱스 selectedIndex에 저장한다.</p>
  </li>
  <li>
    <p>길이가 1 이하가 되면 page 콤보는 제거된다. 1→여러 개, 여러 개→1, 길이 증감 모두 자동 반영된다.</p>
  </li>
  <li>
    <p>화살표 조작 시 onChange가 문자열 라벨을 인덱스로 변환해 selectedIndex를 업데이트하고, 필요하면 라벨을 재동기화해 값 일관성을 유지한다.</p>
  </li>
  <li>
    <p>구버전 displayindex 위젯이 이미 붙어있던 노드도 안전하게 제거해 혼재 문제를 방지한다.</p>
  </li>
</ul>

<p>추가 팁</p>

<ul>
  <li>라벨 포맷을 바꾸고 싶으면 indexToLabel만 수정하면 된다. 예: <code class="language-plaintext highlighter-rouge">${i+1} / ${count} (${texts[i].slice(0,10)}…)</code>처럼 일부 내용 미리보기까지 첨부 가능.</li>
</ul>

<p class="chat--user">

아 그리고 page 콤보 위젯은 텍스트 위에 오면 보기가 더 좋을 것 같아. (1 페이지면 아얘 없는 것은 동일)

</p>

<p>좋지. “page 콤보를 텍스트 위에” 보이도록 위젯 순서를 재배열하는 유틸을 추가해 정리했어. 1페이지(길이 ≤ 1)일 땐 콤보를 만들지 않는 기존 동작도 그대로 유지돼.</p>

<p>핵 포인트</p>

<ol>
  <li>
    <p>widgets 배열에서 page가 displaytext보다 항상 앞에 오도록 재배치.</p>
  </li>
  <li>
    <p>콤보 생성/제거, 길이 변화, 화살표 조작, 1페이지 시 제거 로직은 이전 버전과 동일.</p>
  </li>
  <li>
    <p>구버전(displayindex) 잔존 위젯은 감지 즉시 제거.</p>
  </li>
</ol>

<p>교체 코드</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // "1 / N" 라벨 ↔ 0-based index
    const indexToLabel = (i, count) =&gt; `${i + 1} / ${count}`;
    const labelToIndex = (label) =&gt; {
      const m = String(label).match(/\d+/);
      const k = m ? parseInt(m[0], 10) : 1;
      const idx = Number.isFinite(k) ? k - 1 : 0;
      return Math.max(0, idx);
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") node.size = node.computeSize();
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // page 콤보를 생성/업데이트(라벨 "1 / N"), 불필요 시 제거
    function syncComboWidget(node, count) {
      // 구버전(displayindex) 제거
      const legacy = node.widgets?.find(w =&gt; w.name === "displayindex");
      if (legacy) removeWidget(node, legacy);

      let comboWidget = node.widgets?.find(w =&gt; w.name === "page");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      const values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i, count));

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "page",
          values[0],
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values }
        );
        comboWidget.serialize = false;
      } else {
        const needUpdate =
          !comboWidget.options?.values ||
          comboWidget.options.values.length !== count ||
          comboWidget.options.values[0] !== values[0];
        if (needUpdate) comboWidget.options.values = values;
      }

      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx, count);

      if (comboWidget.value !== desiredLabel) comboWidget.value = desiredLabel;
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    // page가 displaytext 위로 오도록 재배치
    function ensureOrderPageAboveText(node) {
      if (!node?.widgets) return;
      const pageIdx = node.widgets.findIndex(w =&gt; w.name === "page");
      const textIdx = node.widgets.findIndex(w =&gt; w.name === "displaytext");
      if (pageIdx === -1 || textIdx === -1) return;
      if (pageIdx &gt; textIdx) {
        const [w] = node.widgets.splice(pageIdx, 1);
        node.widgets.splice(textIdx, 0, w);
        if (typeof node.computeSize === "function") node.size = node.computeSize();
      }
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);
      const textWidget = ensureTextWidget(node);

      // 순서 정리: page -&gt; displaytext
      ensureOrderPageAboveText(node);

      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          const cl = Math.max(0, Math.min(i, texts.length - 1));
          node.properties.selectedIndex = cl;
          comboWidget.value = indexToLabel(cl, texts.length);
          textWidget.value = texts[cl] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);
      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;
      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);
      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;
      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>동작 흐름 요약</p>

<ol>
  <li>
    <p>onExecuted/onConfigure에서 텍스트 배열을 정규화.</p>
  </li>
  <li>
    <p>길이에 맞춰 page 콤보를 생성/업데이트(1페이지면 제거), displaytext는 항상 유지.</p>
  </li>
  <li>
    <p>ensureOrderPageAboveText로 page가 displaytext보다 위에 오도록 재배열.</p>
  </li>
  <li>
    <p>선택 인덱스는 properties.selectedIndex로 일관 관리, UI 라벨은 “1 / N” 문자열로 표시.</p>
  </li>
  <li>
    <p>키보드/마우스 조작 시 라벨→인덱스 변환으로 동기화하며 리셋 문제 없음.</p>
  </li>
</ol>

<p>더 다듬고 싶다면 텍스트 위젯 높이, 자동 줄바꿈, 프리뷰 길이 등을 옵션으로 노출해도 좋다.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python Tool 작성</title><link href="https://hvppyarchive.github.io/llm/python-systemfile-tools/" rel="alternate" type="text/html" title="Python Tool 작성" /><published>2025-10-31T11:43:50+09:00</published><updated>2025-10-31T11:43:50+09:00</updated><id>https://hvppyarchive.github.io/llm/python-systemfile-tools</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/python-systemfile-tools/"><![CDATA[<p class="chat--user">

Python Tool 작성을 해보자. OpenAI Agent에서 사용할 Tool을 만들고 싶어. 너가 만들어준 Tool에 agents.function_tool decorator를 붙일거니깐 내부 documentation과 Annotation이 된 상태로 되면 좋겠어. 그런데 root 폴더는 자체적으로 root_dir 로 지정을 해서 그에 따라 만들어서 나가게 하고 싶어. File System 관련 툴들 - list_files - read_file - save_file 만 일단 만들어줘. 

</p>

<p>좋아. 아래는 OpenAI Agent에서 바로 쓸 수 있게 <code class="language-plaintext highlighter-rouge">@agents.function_tool</code> 데코레이터를 붙인, 루트 디렉터리를 고정해서 동작하는 파일 시스템 툴 3종 세트야. 경로 탈출(<code class="language-plaintext highlighter-rouge">..</code>)을 막고, 바이너리/텍스트 모두 안전하게 다룰 수 있도록 설계했어.</p>

<p>간단한 설계 요약 (한 줄씩):</p>

<ol>
  <li>
    <p>모듈 전역의 <code class="language-plaintext highlighter-rouge">ROOT_DIR</code>로 작업 루트를 고정하고, 모든 입출력은 여기에 상대 경로로만 접근.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_resolve_safe()</code>에서 <code class="language-plaintext highlighter-rouge">Path.resolve()</code>로 정규화한 뒤 <code class="language-plaintext highlighter-rouge">is_relative_to</code>로 루트 내 경로인지 검증.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">list_files</code>는 재귀/글롭/숨김파일 포함 여부, 최대 개수 제한을 제공.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">read_file</code>은 텍스트 또는 바이너리(베이스64) 반환을 선택 가능. 파일 크기 상한(<code class="language-plaintext highlighter-rouge">max_bytes</code>)으로 과도한 읽기 방지.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">save_file</code>은 텍스트/베이스64 쓰기, 상위 폴더 자동 생성, 덮어쓰기 가드 제공.</p>
  </li>
  <li>
    <p>모든 함수는 풍부한 타입 힌트와 독스트링을 포함하고, JSON 직렬화 가능한 결과를 반환.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">asdict</span><span class="p">,</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># 이 모듈이 불리는 시점에 기본 root 설정 (필요하면 set_root_dir로 재설정)
</span><span class="n">ROOT_DIR</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="sh">"</span><span class="s">agent_root</span><span class="sh">"</span>
<span class="n">ROOT_DIR</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">set_root_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    루트 디렉터리를 설정한다. 모든 툴은 이 디렉터리 하위에서만 동작한다.

    Parameters
    ----------
    path : str | Path
        작업 루트로 사용할 디렉터리 경로.

    Returns
    -------
    str
        정규화된 루트 디렉터리의 절대 경로 문자열.
    </span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">ROOT_DIR</span>
    <span class="n">ROOT_DIR</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">ROOT_DIR</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relpath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    루트 디렉터리 내부의 안전한 절대 경로를 계산한다.
    경로 탈출(../ 등)을 방지하기 위해 resolve 후 ROOT_DIR 하위인지 검사한다.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROOT_DIR</span> <span class="o">/</span> <span class="nc">Path</span><span class="p">(</span><span class="n">relpath</span><span class="p">)).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Python 3.9+: Path.is_relative_to 지원. 미지원 환경 대비 수동 체크.
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">):</span>  <span class="c1"># type: ignore[attr-defined]
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes ROOT_DIR</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="c1"># 수동 구현
</span>        <span class="k">if</span> <span class="n">ROOT_DIR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">ROOT_DIR</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes ROOT_DIR</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FileEntry</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_path</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">FileEntry</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="nc">FileEntry</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span> <span class="nb">type</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

<span class="c1"># ===== OpenAI Agent Tool Definitions =====
# 프레임워크에 따라 import 경로가 다를 수 있음. 예:
# from openai import agents
# 여기서는 사용자가 말한 데코레이터 이름을 그대로 쓴다.
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">agents</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>  <span class="c1"># 런타임 환경에서 데코레이터가 없을 수 있으니 대체 정의
</span>    <span class="k">class</span> <span class="nc">_NoopDecorator</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">fn</span>
            <span class="k">return</span> <span class="n">wrapper</span>
    <span class="n">agents</span> <span class="o">=</span> <span class="nf">_NoopDecorator</span><span class="p">()</span>  <span class="c1"># type: ignore
</span>
<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">루트 디렉터리(root_dir) 기준으로 파일/폴더 목록을 가져온다. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">재귀 탐색, 글롭 패턴, 숨김파일 포함 여부, 최대 개수 제한을 지원한다.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    파일/폴더 목록 조회.

    Parameters
    ----------
    relative_path : str, default=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="s">
        ROOT_DIR 기준 시작 경로.
    glob : str | None, default=None
        글롭 패턴 (예: </span><span class="sh">"</span><span class="s">*.py</span><span class="sh">"</span><span class="s">). None이면 전체.
    recursive : bool, default=True
        하위 폴더 재귀 탐색 여부.
    include_hidden : bool, default=False
        점(.)으로 시작하는 숨김 항목 포함 여부.
    max_items : int | None, default=None
        반환 항목 최대 개수. None이면 제한 없음.

    Returns
    -------
    dict
        {
          </span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;ROOT_DIR&gt;</span><span class="sh">"</span><span class="s">,
          </span><span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;relative_path&gt;</span><span class="sh">"</span><span class="s">,
          </span><span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="s">: &lt;int&gt;,
          </span><span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">file|dir</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int|null&gt;}, ...]
        }

    Notes
    -----
    - 모든 경로는 ROOT_DIR 하위로 제한된다.
    - 경로 탈출이 감지되면 ValueError를 발생시킨다.
    </span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">relative_path</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
            <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># 후보 경로 이터레이션
</span>    <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
            <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

    <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FileEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="c1"># ROOT_DIR 범위 재확인 (심볼릭 링크 등 대비)
</span>        <span class="n">safe_p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">))</span>
        <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">FileEntry</span><span class="p">.</span><span class="nf">from_path</span><span class="p">(</span><span class="n">safe_p</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="nf">asdict</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">루트 디렉터리(root_dir) 기준 경로의 파일을 읽는다. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">텍스트(encoding 사용) 또는 바이너리(Base64) 모드로 반환할 수 있다.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    파일 읽기.

    Parameters
    ----------
    relative_path : str
        ROOT_DIR 기준 파일 경로.
    mode : {</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">}, default=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">
        </span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">는 문자열로 반환(encoding 사용), </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">는 Base64 문자열로 반환.
    encoding : str, default=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="s">
        텍스트 모드에서 사용할 인코딩.
    max_bytes : int | None, default=2*1024*1024
        읽기 최대 바이트. None이면 제한 없음.

    Returns
    -------
    dict
        텍스트 모드:
          {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;str&gt;</span><span class="sh">"</span><span class="s">}
        바이너리 모드:
          {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;str&gt;</span><span class="sh">"</span><span class="s">}

    Raises
    ------
    FileNotFoundError
        대상 파일이 없을 때.
    IsADirectoryError
        디렉터리를 읽으려 할 때.
    ValueError
        경로 탈출 등 보안 위반.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s"> bytes) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">save_file</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">루트 디렉터리(root_dir) 기준 경로에 파일을 저장한다. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">텍스트(encoding) 또는 Base64 바이너리를 지원하고, </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">덮어쓰기/상위 경로 자동 생성 옵션을 제공한다.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    파일 저장.

    Parameters
    ----------
    relative_path : str
        ROOT_DIR 기준 저장 경로.
    content : str | None, default=None
        텍스트 모드에서 저장할 문자열. mode=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">일 때 필요.
    content_b64 : str | None, keyword-only, default=None
        바이너리 모드에서 저장할 Base64 문자열. mode=</span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">일 때 필요.
    mode : {</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">}, default=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">
        저장 모드.
    encoding : str, default=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="s">
        텍스트 모드 인코딩.
    overwrite : bool, default=False
        True면 기존 파일을 덮어쓴다. False면 기존 파일이 있으면 예외 발생.
    create_parents : bool, default=True
        상위 디렉터리를 자동 생성할지 여부.

    Returns
    -------
    dict
        {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">text|binary</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="s">: &lt;bool&gt;, </span><span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="s">: &lt;bool&gt;}

    Raises
    ------
    IsADirectoryError
        디렉터리 경로에 파일을 쓰려 할 때.
    FileExistsError
        overwrite=False이고 파일이 이미 존재할 때.
    ValueError
        잘못된 모드/입력 또는 경로 탈출 등 보안 위반.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">created</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">created</span><span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># 사용 예시 (Agent 외부 초기화 코드)
# set_root_dir("./workspace")  # 필요 시 루트 디렉터리 지정
# list_files(relative_path=".", glob="*.py", recursive=True)
# save_file("docs/readme.txt", content="hello", overwrite=True)
# read_file("docs/readme.txt", mode="text")
</span></code></pre></div></div>

<p>연동 팁:</p>

<ul>
  <li>
    <p>에이전트 시작 시점에 <code class="language-plaintext highlighter-rouge">set_root_dir("/desired/root")</code>를 한 번 호출해 루트 고정.</p>
  </li>
  <li>
    <p>보안상 모든 외부 입력 경로는 위 3개 툴의 <code class="language-plaintext highlighter-rouge">relative_path</code>에 그대로 넣지 말고, 꼭 이 툴 안에서 <code class="language-plaintext highlighter-rouge">_resolve_safe</code>가 검증하도록 유지.</p>
  </li>
  <li>
    <p>큰 파일을 다룬다면 <code class="language-plaintext highlighter-rouge">read_file(max_bytes=None)</code>처럼 상한을 조절하되, 에이전트 정책에 맞춰 적절한 제한을 두는 게 안전하다.</p>
  </li>
</ul>

<p>다음으로 원하면, 삭제/이동/복사 같은 추가 툴이나 파일 잠금, 트랜잭션성 저장(임시 파일로 쓰고 원자적 교체)도 확장해줄 수 있어.</p>

<p class="chat--user">

음 이런 형식이야. 너가 찾아볼 줄 알았지. from agents import function_tool @function_tool def get_weather(city: str) -&gt; str: """returns weather info for the specified city.""" return f"The weather in {city} is sunny" 그런데 루트를 함수로 입력 받고 그에 따른 툴을 리턴하면 잘 동작할까? 예를 들어 def get_systemfile_tools(root_dir: str): def list_files(…): f"root dir: {root_dir} …" … def save_file(…): return [list_files, save_file, …]

</p>

<p>가능해. 함수가 클로저로 <code class="language-plaintext highlighter-rouge">root_dir</code>를 캡처해서 툴로 내려가도, 에이전트가 “파이썬 콜러블을 호출”만 하면 문제없다. 다만 몇 가지 현실적 주의점이 있다.</p>

<p>핵심 포인트 먼저 정리</p>

<ol>
  <li>
    <p>대부분의 런타임(단일 프로세스, 인메모리)은 클로저 툴을 잘 지원한다.</p>
  </li>
  <li>
    <p>멀티프로세스/원격 실행(예: 프로세스 간 큐, 서버리스 워커)에서는 “피클/직렬화 가능한 최상위 함수”를 요구할 수 있다. 그땐 클로저 대신 <code class="language-plaintext highlighter-rouge">functools.partial</code>이나 클래스 바인딩 패턴이 안전하다.</p>
  </li>
  <li>
    <p>데코레이터는 정의 시점에 적용된다. 팩토리 내부에서 “데코레이터를 함수처럼 호출”해 적용하면 된다.</p>
  </li>
</ol>

<p>아래는 네가 제시한 스타일에 맞춘 최소-의존성 구현이다. <code class="language-plaintext highlighter-rouge">from agents import function_tool</code> 가정, <code class="language-plaintext highlighter-rouge">get_systemfile_tools(root_dir)</code>가 안전 경로 검증까지 포함한 3개 툴(list_files, read_file, save_file)을 만들어 리스트로 반환한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">function_tool</span>  <span class="c1"># 사용자 환경의 데코레이터
</span>
<span class="c1"># ===== 내부 유틸 =====
</span>
<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    root 하위의 안전한 절대 경로 생성. 경로 탈출 방지.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="n">relpath</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="c1"># Path.is_relative_to: 3.9+ 지원. 하위 호환 수동 체크
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>  <span class="c1"># type: ignore[attr-defined]
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="c1"># ===== 툴 팩토리 =====
</span>
<span class="k">def</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    지정한 root_dir를 기준으로 동작하는 파일 시스템 툴 3종을 생성해 반환한다.
    반환 값은 에이전트에 그대로 등록 가능한 데코레이트된 함수 리스트.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">root</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># --- list_files ---------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_list_files_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        루트(root_dir) 기준으로 파일/폴더 목록을 가져온다.
        글롭 패턴, 재귀 탐색, 숨김 포함 여부, 최대 개수 제한을 지원한다.
        </span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
                <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

        <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">safe</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">entries</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">list_files</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir 기준으로 파일/폴더 목록을 가져온다. 글롭/재귀/숨김/최대개수 옵션 지원.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_list_files_impl</span><span class="p">)</span>

    <span class="c1"># --- read_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_read_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        파일 읽기. 텍스트(encoding) 또는 바이너리(Base64) 모드 선택.
        파일 크기 상한(max_bytes)으로 과도한 읽기 방지.
        </span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
        <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">read_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir 기준 경로의 파일을 읽는다. 텍스트 또는 Base64 바이너리 반환.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_read_file_impl</span><span class="p">)</span>

    <span class="c1"># --- save_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_save_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        파일 저장. 텍스트(content) 또는 Base64(content_b64) 지원.
        overwrite와 상위 경로 자동 생성(create_parents) 옵션 제공.
        </span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">created</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">created</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">save_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">save_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir 기준 경로에 파일을 저장한다. 텍스트/바이너리, 덮어쓰기, 상위 폴더 생성 지원.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_save_file_impl</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">list_files</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">save_file</span><span class="p">]</span>
</code></pre></div></div>

<p>사용 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tools</span> <span class="o">=</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="sh">"</span><span class="s">./workspace</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># 에이전트 초기화 시 등록
# agent = Agent(tools=tools)  # 프레임워크에 맞게 등록
</span>
<span class="c1"># 또는 직접 호출도 가능(내부적으로 root="./workspace"로 고정됨)
</span><span class="nf">print</span><span class="p">(</span><span class="n">tools</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">relative_path</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">glob</span><span class="o">=</span><span class="sh">"</span><span class="s">*.py</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>클로저 툴의 현실적 주의사항과 대안</p>

<ul>
  <li>
    <p>워커 프로세스가 별도에서 툴을 로드해야 하는 아키텍처라면 클로저가 직렬화되지 않아 실패할 수 있다. 이 경우 두 가지 대안이 안전하다.</p>

    <ol>
      <li>
        <p><code class="language-plaintext highlighter-rouge">functools.partial</code> 패턴: 최상위 함수에 <code class="language-plaintext highlighter-rouge">root</code> 인자를 두고, <code class="language-plaintext highlighter-rouge">partial(fn, root=my_root)</code>로 바인딩한 뒤 그 partial에 데코레이터를 씌우거나, 데코레이터가 “함수처럼 호출 가능”하다면 팩토리에서 <code class="language-plaintext highlighter-rouge">function_tool(...)(partial(...))</code>로 등록.</p>
      </li>
      <li>
        <p>클래스 패턴: <code class="language-plaintext highlighter-rouge">class FS:</code> 안에 <code class="language-plaintext highlighter-rouge">__init__(root)</code>로 상태를 들고, 최상위 래퍼 함수를 만들어 <code class="language-plaintext highlighter-rouge">fs = FS(root)</code>의 메서드를 호출하게 래핑. 이 래퍼만 데코레이트해 등록하면 직렬화 제약을 피하기 쉽다.</p>
      </li>
    </ol>
  </li>
</ul>

<p>지금 제공한 구현은 가장 간결한 클로저-팩토리 버전이다. 만약 네 런타임이 멀티프로세스 직렬화를 요구한다면, 위 대안 패턴으로 바로 바꿔줄 수도 있다.</p>

<p class="chat--user">

function_tool이 자동으로 첫줄을 description으로 만드는데 그걸 f string으로 만들고 싶다는거지

</p>

<p>좋아. 핵심은 “데코레이터가 첫 줄 docstring을 읽는 타이밍 전에, 함수의 __doc__을 동적으로 채워넣기”야. 파이썬에서 함수 정의 블록 맨 처음의 문자열 리터럴은 컴파일 시 고정되지만, 런타임에 <code class="language-plaintext highlighter-rouge">fn.__doc__</code>을 다시 할당하는 건 가능하다. 그러니 팩토리에서 클로저를 만들고, 그 함수들의 <code class="language-plaintext highlighter-rouge">__doc__</code>을 f-string 결과로 대입한 다음, <code class="language-plaintext highlighter-rouge">function_tool</code>을 “데코레이터처럼 호출”해서 적용하면 된다. 포인트는 “docstring 수정 → function_tool 적용”의 순서.</p>

<p>아래는 동작하는 패턴을 단계별로 풀어쓴 코드다.</p>

<ol>
  <li>
    <p>클로저로 root_dir를 캡처</p>
  </li>
  <li>
    <p>내부 함수의 원본 docstring은 포맷용 플레이스홀더를 둔다</p>
  </li>
  <li>
    <p>정의가 끝난 뒤 <code class="language-plaintext highlighter-rouge">.__doc__ = f"...{root_dir}..."</code> 또는 <code class="language-plaintext highlighter-rouge">.format(root=root_dir)</code>로 주입</p>
  </li>
  <li>
    <p>마지막에 <code class="language-plaintext highlighter-rouge">function_tool(...)</code>로 래핑해서 리턴</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">function_tool</span>

<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="n">relpath</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>  <span class="c1"># py3.9+
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    root_dir를 캡처한 파일 시스템 툴들을 만들고, docstring의 첫 줄을 동적으로 채운 뒤 function_tool로 래핑해 반환한다.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">root</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># --- list_files ---------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_list_files_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">List files under {root}: glob/recursive/hidden/max_items supported.</span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
                <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">safe</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

    <span class="c1"># docstring 첫 줄을 동적으로 주입
</span>    <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">List files under </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: glob/recursive/hidden/max_items supported.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">list_files</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_list_files_impl</span><span class="p">)</span>  <span class="c1"># 이 시점에 첫 줄을 읽어 description으로 사용
</span>
    <span class="c1"># --- read_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_read_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Read a file from {root}: return text or Base64 binary with size guard.</span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
        <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Read a file from </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: return text or Base64 binary with size guard.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">read_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_read_file_impl</span><span class="p">)</span>

    <span class="c1"># --- save_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_save_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Save a file under {root}: text/binary, overwrite and parent creation options.</span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">existed</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">existed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="ow">not</span> <span class="n">existed</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="n">existed</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Save a file under </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: text/binary, overwrite and parent creation options.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">save_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_save_file_impl</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">list_files</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">save_file</span><span class="p">]</span>
</code></pre></div></div>

<p>이 패턴의 이유와 주의점 정리</p>

<ol>
  <li>
    <p>대부분의 <code class="language-plaintext highlighter-rouge">function_tool</code> 구현은 “래핑 시점”에 <code class="language-plaintext highlighter-rouge">fn.__doc__</code>의 첫 줄을 읽어 description으로 씀. 따라서 반드시 docstring을 바꾼 뒤에 <code class="language-plaintext highlighter-rouge">function_tool(fn)</code>을 호출해야 한다.</p>
  </li>
  <li>
    <p>데코레이터 구문 <code class="language-plaintext highlighter-rouge">@function_tool</code>를 함수 정의 위에 바로 붙이면, 데코레이터가 먼저 실행되므로 그 뒤의 <code class="language-plaintext highlighter-rouge">__doc__</code> 주입이 반영되지 않는다. 지금처럼 “call-style 데코레이션”으로 해결한다.</p>
  </li>
  <li>
    <p>f-string을 함수 본문 첫 줄 리터럴에 직접 쓸 수는 없다. 대신 런타임에 <code class="language-plaintext highlighter-rouge">__doc__</code>에 f-string 결과를 대입하거나, 템플릿 문자열을 두고 <code class="language-plaintext highlighter-rouge">.format(root=root_dir)</code>로 치환하면 된다.</p>
  </li>
  <li>
    <p>만약 네 <code class="language-plaintext highlighter-rouge">function_tool</code>이 description 인자를 직접 받는다면 더 간단히 <code class="language-plaintext highlighter-rouge">function_tool(description=f"...{root}...")(fn)</code>로 끝낼 수 있다. 하지만 “첫 줄 docstring 자동 사용” 규약을 유지하려면 지금 방식이 가장 호환성이 좋다.</p>
  </li>
</ol>

<p>확장 팁</p>

<ul>
  <li>
    <p>첫 줄 외에 상세 도움말을 계속 남기고 싶으면, 원래 docstring을 읽어 두고 첫 줄만 덮어쓴 뒤 나머지를 이어붙이는 지금 방식을 쓰면 된다.</p>
  </li>
  <li>
    <p>직렬화가 필요한 환경에서는 이 클로저를 최상위 함수+<code class="language-plaintext highlighter-rouge">functools.partial</code>로 바꿔도 동일한 방식으로 <code class="language-plaintext highlighter-rouge">__doc__</code> 주입 후 래핑이 가능하다.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI 타입 색상 추가</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-connection-color/" rel="alternate" type="text/html" title="ComfyUI 타입 색상 추가" /><published>2025-10-30T16:07:05+09:00</published><updated>2025-10-30T16:07:05+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-connection-color</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-connection-color/"><![CDATA[<p class="chat--user">

ComfyUI 에서 내가 만든 타입에 색깔을 넣을 순 없나

</p>

<p>가능해요. “내가 만든 타입(예: MYTYPE)”의 링크 색을 정해두면, 그 타입으로 들어오고 나가는 연결선이 원하는 색으로 보입니다. 핵심은 프런트엔드(LiteGraph 캔버스) 쪽의 “타입→색상” 매핑을 추가하는 겁니다.</p>

<p>아래 순서대로 하면 됩니다.</p>

<ol>
  <li>
    <p>파이썬 노드에서 타입 이름 정하기<br />
커스텀 노드의 RETURN_TYPES / INPUT_TYPES 등에 사용할 문자열이 실제 타입 이름이 됩니다. 예: RETURN_TYPES = ("MYTYPE",). 이 문자열이 프런트엔드에서도 색상 키로 쓰입니다. 타입 문자열과 링크 색은 LiteGraph가 타입별로 구분합니다. <a href="https://docs.comfy.org/development/core-concepts/nodes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>프런트엔드 확장 스크립트 만들기<br />
ComfyUI는 브라우저에서 실행될 때 작은 JS 확장(extension)을 자동 로드할 수 있습니다. 여기에 “타입→색상” 매핑을 추가합니다. 확장은 docs의 ComfyNode/JS 하이재킹 가이드가 안내하는 app.registerExtension 패턴을 쓰면 깔끔합니다. <a href="https://docs.comfy.org/custom-nodes/js/javascript_objects_and_hijacking?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ol>

<p>예시: ComfyUI/web/extensions/mytype-colors.js 파일을 만들고 아래처럼 작성합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ComfyUI 0.7대 LiteGraph 기준 예시
app.registerExtension({
  name: "mytype.color.map",
  setup() {
    const LGC = LGraphCanvas; // LiteGraph 캔버스
    // 연결선(활성/비활성) 색상을 타입 문자열 키로 지정
    LGC.default_connection_color_byType = {
      ...(LGC.default_connection_color_byType || {}),
      "MYTYPE": "#a26bff"   // 원하는 HEX
    };
    LGC.default_connection_color_byTypeOff = {
      ...(LGC.default_connection_color_byTypeOff || {}),
      "MYTYPE": "#5b3a9a"   // 비활성(꺼짐) 상태일 때 어두운 톤
    };
    // 색상 변경 후 캔버스 다시 그리기
    if (app?.graph?.canvas) app.graph.canvas.setDirty(true, true);
  }
});
</code></pre></div></div>

<p>LiteGraph는 타입 문자열별 기본 연결선 색을 default_connection_color_byType / default_connection_color_byTypeOff 두 객체에서 찾습니다. 이 두 맵에 키를 추가하면 됩니다. 이 방법은 LiteGraph에 직접 물어본 답과 동일한 메커니즘을 씁니다. <a href="https://stackoverflow.com/questions/78543805/how-do-i-change-the-color-of-a-slot?utm_source=chatgpt.com">Stack Overflow</a></p>

<ol>
  <li>브라우저 새로고침<br />
ComfyUI를 재시작하거나 브라우저를 새로고침하면, 이제 MYTYPE 타입 링크가 지정한 색으로 보입니다.</li>
</ol>

<p>추가 팁</p>

<p>• 노드 카드(헤더) 배경색은 타입 색과 별개입니다. 헤더 배경은 테마/팔레트(설정의 Appearance)나 CSS로 바꿀 수 있지만, “데이터 타입” 링크 색은 위처럼 타입 매핑을 손대야 바뀝니다. 팔레트만 바꾸면 “색이 더 잘 보이게” 되는 경우가 있으나, 타입별 고유색을 새로 정의하는 건 아닙니다. <a href="https://docs.comfy.org/interface/appearance?utm_source=chatgpt.com">ComfyUI+1</a></p>

<p>• ComfyUI는 커스텀 LiteGraph 빌드를 씁니다. 버전마다 내부 경로가 약간 다를 수 있지만, 공개 패키지 설명에서도 ComfyUI가 수정된 litegraph를 사용한다고 명시되어 있어 위 패턴이 안정적입니다. <a href="https://www.npmjs.com/package/%40comfyorg/litegraph/v/0.7.42?utm_source=chatgpt.com">Npm</a></p>

<p>• 코드로 헤더 색까지 강제하고 싶다면 node.color / node.bgcolor 같은 LiteGraph 속성도 건드릴 수 있습니다. 다만 워크플로 전반의 일관성을 생각하면 “링크(타입) 색은 타입-맵으로, 전체 테마는 팔레트/스타일로” 나누는 편이 유지보수에 유리합니다. 관련 JS 훅은 Comfy의 JS 오브젝트/하이재킹 문서가 출발점으로 좋습니다. <a href="https://docs.comfy.org/custom-nodes/js/javascript_objects_and_hijacking?utm_source=chatgpt.com">ComfyUI</a></p>

<p>정리하면, 파이썬 쪽에서 타입 문자열을 하나 정해 쓰고, 프런트엔드 확장으로 LGraphCanvas.default_connection_color_byType(및 Off)에 그 문자열 키를 원하는 색으로 추가하세요. 그러면 그 타입의 입출력 링크가 지정한 색으로 깔끔하게 표시됩니다. 다음으로는 여러 커스텀 타입을 쓰는 워크플로에서 색 팔레트를 체계적으로 정리해 두면, 복잡한 그래프도 한눈에 읽히는 “시각적 문법”이 됩니다.</p>

<p class="chat--user">

위에 임포트 같은건 따로 안해도 되나

</p>

<p>아니요. 따로 임포트할 거 없습니다.</p>

<p>왜냐면 ComfyUI가 브라우저에서 이미 필요한 것들을 전역으로 올려둡니다. 확장 스크립트를 <code class="language-plaintext highlighter-rouge">web/extensions/*.js</code>에 두고 <code class="language-plaintext highlighter-rouge">app.registerExtension({...})</code>를 쓰면, 내부에서 <code class="language-plaintext highlighter-rouge">app</code>(ComfyUI 앱 객체)와 <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>(LiteGraph 캔버스)가 자동으로 보입니다. 그래서 추가 임포트 없이 바로 맵을 건드릴 수 있습니다.</p>

<p>정리해두면 이렇게 됩니다.</p>

<ol>
  <li>
    <p>JS 쪽<br />
파일 위치: <code class="language-plaintext highlighter-rouge">ComfyUI/web/extensions/mytype-colors.js</code><br />
코드 안에서 따로 <code class="language-plaintext highlighter-rouge">import</code> 안 해도 됨. <code class="language-plaintext highlighter-rouge">app</code>과 <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>는 전역. <code class="language-plaintext highlighter-rouge">registerExtension</code>이 로딩 타이밍도 책임져줘서 “먼저 로드됐나?” 걱정도 줄어듭니다.</p>
  </li>
  <li>
    <p>파이썬 노드 쪽<br />
색상 매핑을 위해 별도의 임포트 필요 없음. 커스텀 노드 클래스에서 <code class="language-plaintext highlighter-rouge">RETURN_TYPES = ("MYTYPE",)</code> 같은 타입 문자열을 평소처럼 정의하면 끝. 색상은 JS 확장에서 타입 문자열 키로 매핑합니다.</p>
  </li>
  <li>
    <p>재시작/새로고침<br />
파일을 넣은 뒤 ComfyUI 재시작 또는 브라우저 새로고침만 하면 반영됩니다. 캐시가 끼면 강력 새고침 정도면 충분합니다.</p>
  </li>
</ol>

<p>예시 스니펫(임포트 없음):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

app.registerExtension({
  name: "mytype.color.map",
  setup() {
    const LGC = LGraphCanvas;
    LGC.default_connection_color_byType = {
      ...(LGC.default_connection_color_byType || {}),
      "MYTYPE": "#a26bff"
    };
    LGC.default_connection_color_byTypeOff = {
      ...(LGC.default_connection_color_byTypeOff || {}),
      "MYTYPE": "#5b3a9a"
    };
    if (app?.graph?.canvas) app.graph.canvas.setDirty(true, true);
  }
});
</code></pre></div></div>

<p>주의할 점 몇 가지만 덧붙이면 더 탄탄해집니다.<br />
• 파일 위치가 맞아야 자동 로드됩니다. 다른 경로를 쓰면 직접 로더에 등록해야 해요.<br />
• TypeScript로 작성한다면 “전역 <code class="language-plaintext highlighter-rouge">app</code>, <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>”에 대한 타입 선언만 추가하면 됩니다. JS라면 그냥 넘어가도 됩니다.<br />
• 만약 브라우저 콘솔에서 즉석 실행한다면 <code class="language-plaintext highlighter-rouge">window.app</code>, <code class="language-plaintext highlighter-rouge">window.LGraphCanvas</code>로 접근하세요.</p>

<p>한 줄 결론: 기본 설치 그대로라면 임포트는 전혀 필요 없습니다. 타입 문자열만 맞추고, 확장 스크립트에서 전역 객체를 살짝 손대면 링크 색상 커스터마이징이 깔끔하게 동작합니다.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">npx 설정 변경 방법</title><link href="https://hvppyarchive.github.io/llm/npx-command-line-config/" rel="alternate" type="text/html" title="npx 설정 변경 방법" /><published>2025-10-30T13:40:18+09:00</published><updated>2025-10-30T13:40:18+09:00</updated><id>https://hvppyarchive.github.io/llm/npx-command-line-config</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/npx-command-line-config/"><![CDATA[<p class="chat--user">

npx (npm exec)을 돌리되 커맨드라인에서 prefix, .npm 경로, registry, strict-ssl를 커맨드로 바꿀 수 있어?

</p>

<p>가능해. <code class="language-plaintext highlighter-rouge">npx</code>(npm v7+에서는 <code class="language-plaintext highlighter-rouge">npm exec</code>와 동일)는 거의 모든 npm 설정 값을 “그 실행 한 번”에 한해 CLI 옵션이나 환경변수로 오버라이드할 수 있어. 핵심은 다음 셋 중 하나를 쓰는 것: 1) CLI 플래그, 2) <code class="language-plaintext highlighter-rouge">npm_config_*</code> 환경변수, 3) 다른 <code class="language-plaintext highlighter-rouge">.npmrc</code>를 지정하는 <code class="language-plaintext highlighter-rouge">--userconfig</code>.</p>

<p>아래를 차근차근 보자.</p>

<ol>
  <li>CLI 플래그로 바로 지정</li>
</ol>

<ul>
  <li>
    <p>registry: <code class="language-plaintext highlighter-rouge">--registry=https://registry.npmmirror.com</code></p>
  </li>
  <li>
    <p>strict-ssl: <code class="language-plaintext highlighter-rouge">--strict-ssl=false</code></p>
  </li>
  <li>
    <p>prefix(글로벌 prefix): <code class="language-plaintext highlighter-rouge">--prefix=/opt/npm-global</code></p>
  </li>
  <li>
    <p>.npm 캐시 경로: <code class="language-plaintext highlighter-rouge">--cache=/var/tmp/npm-cache</code> (일반적으로 “~/.npm”이 이 값)</p>
  </li>
</ul>

<p>예시들:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># npm v7+ 스타일 (권장): npm exec</span>
npm <span class="nb">exec</span> <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--</span> <span class="se">\</span>
  some-binary <span class="nt">--help</span>

<span class="c"># 전통적인 npx 스타일 (npm v6~): npx</span>
npx <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false </span>some-binary <span class="nt">--help</span>

<span class="c"># prefix와 cache도 한 번에</span>
npm <span class="nb">exec</span> <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="nt">--</span> <span class="se">\</span>
  eslint <span class="nt">-v</span>
</code></pre></div></div>

<ol>
  <li>환경변수로 지정 (<code class="language-plaintext highlighter-rouge">npm_config_*</code>)<br />
동일한 키를 환경변수로 넘겨도 된다. 한 번 쓰고 끝낼 때 깔끔하다.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># POSIX 쉘</span>
<span class="nv">npm_config_registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
<span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nv">npm_config_prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
<span class="nv">npm_config_cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
npx eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>Windows PowerShell이라면:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_registry</span><span class="o">=</span><span class="s2">"https://registry.npmmirror.com"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="s2">"false"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_prefix</span><span class="o">=</span><span class="s2">"C:\npm-global"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_cache</span><span class="o">=</span><span class="s2">"D:\npm-cache"</span><span class="w">
</span><span class="n">npx</span><span class="w"> </span><span class="nx">eslint</span><span class="w"> </span><span class="nt">-v</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>별도 .npmrc를 지정<br />
프로젝트/유저 기본 설정 건드리지 않고 특정 실행에만 쓰고 싶을 때 유용하다.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /tmp/my.npmrc 안에 원하는 설정을 써둔 뒤</span>
npm <span class="nb">exec</span> <span class="nt">--userconfig</span><span class="o">=</span>/tmp/my.npmrc <span class="nt">--</span> webpack <span class="nt">--version</span>
</code></pre></div></div>

<p>실무 팁과 주의점</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">npm exec</code>에서 “설정 플래그들은 실행할 바이너리 이름 앞”에 두는 게 안전하다. 그 뒤의 인자는 실행 대상 패키지가 받는다. 애매하면 <code class="language-plaintext highlighter-rouge">--</code>로 구분해주기.<br />
예: <code class="language-plaintext highlighter-rouge">npm exec --registry=... -- strict-ssl-checker --verbose</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefix</code>는 “글로벌 설치 위치”를 의미한다. <code class="language-plaintext highlighter-rouge">npm exec --package=foo</code> 같이 일시 설치 실행할 때는 임시 디렉터리를 쓰므로 <code class="language-plaintext highlighter-rouge">prefix</code>보다 <code class="language-plaintext highlighter-rouge">cache</code>와 <code class="language-plaintext highlighter-rouge">tmp</code> 관련 설정이 동작에 더 큰 영향을 준다.</p>
  </li>
  <li>
    <p>npm v6의 <code class="language-plaintext highlighter-rouge">npx</code>는 옵션 파싱이 다소 까다로웠다. 패키지 인자와 npx 옵션이 섞이면 <code class="language-plaintext highlighter-rouge">--</code>로 경계 표시.</p>
  </li>
  <li>
    <p>CA 검증을 끄는 <code class="language-plaintext highlighter-rouge">--strict-ssl=false</code>는 편하지만 보안상 위험하니 내부 네트워크 테스트 등 불가피할 때만 쓰자.</p>
  </li>
  <li>
    <p>자주 쓰는 값은 사용자 홈의 <code class="language-plaintext highlighter-rouge">~/.npmrc</code>나 프로젝트의 <code class="language-plaintext highlighter-rouge">.npmrc</code>에 적어 두고, 일시적으로 바꿀 때만 위 방식을 쓰면 깔끔하다.</p>
  </li>
</ul>

<p>여기까지면 보통은 충분하다. 필요하면 <code class="language-plaintext highlighter-rouge">proxy</code>, <code class="language-plaintext highlighter-rouge">https-proxy</code>, <code class="language-plaintext highlighter-rouge">cafile</code>, <code class="language-plaintext highlighter-rouge">always-auth</code> 같은 다른 npm 설정들도 똑같은 방식으로 한 번 실행용으로 덧입힐 수 있다.</p>

<p class="chat--user">

모두 한 번에 설정하는 법

</p>

<p>가능. 한 줄에서 전부 덮어씌우는 가장 간단한 방법 3가지를 바로 쓸 수 있어. 각각 “실행 한 번”에만 적용돼서 기본 설정은 안 바뀐다.</p>

<ol>
  <li>CLI 플래그 한 번에(권장: npm v7+에서 npm exec)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">exec</span> <span class="se">\</span>
  <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
  <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
  <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
  <span class="nt">--package</span><span class="o">=</span>eslint <span class="nt">--</span> <span class="se">\</span>
  eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>포인트: 설정 플래그는 실행할 패키지 이름(여기선 eslint) 앞에 두고, 그 뒤를 <code class="language-plaintext highlighter-rouge">--</code>로 구분해 실행 대상의 인자를 전달한다.</p>

<ol>
  <li>환경변수 한 번에 (<code class="language-plaintext highlighter-rouge">npm_config_*</code>)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># POSIX 쉘</span>
<span class="nv">npm_config_registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
<span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nv">npm_config_prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
<span class="nv">npm_config_cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
npm <span class="nb">exec</span> <span class="nt">--package</span><span class="o">=</span>eslint <span class="nt">--</span> eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>PowerShell이라면:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_registry</span><span class="o">=</span><span class="s2">"https://registry.npmmirror.com"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="s2">"false"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_prefix</span><span class="o">=</span><span class="s2">"C:\npm-global"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_cache</span><span class="o">=</span><span class="s2">"D:\npm-cache"</span><span class="w">
</span><span class="n">npm</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nt">--package</span><span class="o">=</span><span class="n">eslint</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nx">eslint</span><span class="w"> </span><span class="nt">-v</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>임시 .npmrc 파일로 한 번에</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&gt;</span> /tmp/once.npmrc <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">'
registry=https://registry.npmmirror.com
strict-ssl=false
prefix=/opt/npm-global
cache=/var/tmp/npm-cache
</span><span class="no">EOF

</span>npm <span class="nb">exec</span> <span class="nt">--userconfig</span><span class="o">=</span>/tmp/once.npmrc <span class="nt">--package</span><span class="o">=</span>eslint <span class="nt">--</span> eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>npx를 그대로 쓰는 경우(npm v6 계열)도 동일하게 된다:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
    <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
    eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>정리해둔 작동 원칙</p>

<ul>
  <li>
    <p>우선순위: CLI 플래그 &gt; 환경변수(npm_config_*) &gt; --userconfig로 지정한 .npmrc &gt; 프로젝트/유저 .npmrc</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefix</code>는 글로벌 설치 경로를 의미한다. <code class="language-plaintext highlighter-rouge">npm exec --package=...</code>처럼 일시 설치 실행에서는 임시 디렉터리를 쓰므로 실제 체감 영향은 <code class="language-plaintext highlighter-rouge">cache</code>, <code class="language-plaintext highlighter-rouge">tmp</code>가 더 크다.</p>
  </li>
  <li>
    <p>패키지 이름과 옵션이 섞일 위험이 있으면 <code class="language-plaintext highlighter-rouge">--</code>로 경계를 나눠라.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--strict-ssl=false</code>는 편하지만 보안상 위험하니 내부 네트워크 테스트 등 꼭 필요할 때만 사용하라.</p>
  </li>
</ul>

<p>여기 예시의 registry, 경로들은 네 환경에 맞게 바꿔 꽂으면 된다. 다음 단계로는 proxy, cafile, always-auth 같은 값도 같은 방식으로 함께 묶어 넘겨볼 수 있다.</p>

<p class="chat--user">

뭔가 길다? 내가 원래 치려던 건 npx -y @modelcontextprotocol/server-everything이야

</p>

<p>좋아, 그 한 줄짜리로 끝내자. 네가 치려던 명령에 옵션 4종을 “한 번 실행용”으로 덮어씌우는 최소 예시는 아래 둘 중 하나로 된다.</p>

<p>CLI 플래그로 한 방에:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
    <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
    <span class="nt">-y</span> @modelcontextprotocol/server-everything
</code></pre></div></div>

<p>환경변수로 깔끔하게(추천, 쉘 이식성 좋음):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">npm_config_registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
<span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nv">npm_config_prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
<span class="nv">npm_config_cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
npx <span class="nt">-y</span> @modelcontextprotocol/server-everything
</code></pre></div></div>

<p>참고 메모</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--</code> 구분자는 패키지에 추가 인자를 넘길 때만 붙이면 된다. 여기선 불필요.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefix</code>는 전역 설치 경로지만, npx는 일시 설치·실행이라 실제로는 <code class="language-plaintext highlighter-rouge">cache</code>와 네트워크 설정(registry, strict-ssl)이 더 영향이 크다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">strict-ssl=false</code>는 위험하니 내부망 테스트처럼 꼭 필요할 때만 쓰자.</p>
  </li>
</ul>

<p>같은 방식으로 <code class="language-plaintext highlighter-rouge">proxy</code>, <code class="language-plaintext highlighter-rouge">https-proxy</code>, <code class="language-plaintext highlighter-rouge">cafile</code>, <code class="language-plaintext highlighter-rouge">always-auth</code>도 한 줄에 얹을 수 있다.</p>

<p class="chat--user">

유저 파일로 저장해두고 돌리기

</p>

<p>좋아. “매번 옵션 치기 귀찮다 → 사용자 설정 파일(~/.npmrc)에 저장해두고 그냥 실행”으로 가자. 아래 순서대로 하면 된다.</p>

<ol>
  <li>기존 설정 백업</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="o">[</span> <span class="nt">-f</span> ~/.npmrc <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">cp</span> <span class="nt">-a</span> ~/.npmrc ~/.npmrc.bak.<span class="si">$(</span><span class="nb">date</span> +%Y%m%d-%H%M%S<span class="si">)</span>

<span class="c"># Windows PowerShell</span>
<span class="k">if</span> <span class="o">(</span>Test-Path <span class="nv">$HOME</span><span class="se">\.</span>npmrc<span class="o">)</span> <span class="o">{</span> Copy-Item <span class="nv">$HOME</span><span class="se">\.</span>npmrc <span class="s2">"</span><span class="nv">$HOME</span><span class="se">\.</span><span class="s2">npmrc.bak.</span><span class="k">$((</span>Get-Date<span class="o">)</span>.ToString<span class="o">(</span><span class="s1">'yyyyMMdd-HHmmss'</span><span class="k">))</span><span class="s2">"</span> <span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>사용자 .npmrc 작성<br />
원하는 값으로 바꿔 넣자. strict-ssl=false는 보안상 위험하니 정말 필요한 경우에만 쓴다.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="nb">cat</span> <span class="o">&gt;</span> ~/.npmrc <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">'
registry=https://registry.npmmirror.com
strict-ssl=false
prefix=/opt/npm-global
cache=/var/tmp/npm-cache
</span><span class="no">EOF
</span></code></pre></div></div>

<p>PowerShell이라면:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">@"
registry=https://registry.npmmirror.com
strict-ssl=false
prefix=C:\npm-global
cache=D:\npm-cache
"@</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Set-Content</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">UTF8</span><span class="w"> </span><span class="bp">$HOME</span><span class="nx">\.npmrc</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>prefix 경로 만들기 및 PATH에 추가<br />
prefix를 바꿨다면 그 위치의 bin이 PATH에 있어야 실행 파일이 보인다.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt/npm-global
<span class="c"># 셸에 PATH 추가(예: bash/zsh)</span>
<span class="nb">echo</span> <span class="s1">'export PATH="/opt/npm-global/bin:$PATH"'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
<span class="nb">echo</span> <span class="s1">'export PATH="/opt/npm-global/bin:$PATH"'</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="c"># 적용</span>
<span class="nb">source</span> ~/.bashrc 2&gt;/dev/null <span class="o">||</span> <span class="nb">source</span> ~/.zshrc 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
</code></pre></div></div>

<p>PowerShell:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">New-Item</span><span class="w"> </span><span class="nt">-ItemType</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nx">C:\npm-global</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\npm-global;</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">Path</span><span class="s2">"</span><span class="w">
</span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s2">"Path"</span><span class="p">,</span><span class="w"> </span><span class="s2">"C:\npm-global;"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">GetEnvironmentVariable</span><span class="p">(</span><span class="s2">"Path"</span><span class="p">,</span><span class="s2">"User"</span><span class="p">),</span><span class="w"> </span><span class="s2">"User"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>캐시 디렉터리 준비(선택)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /var/tmp/npm-cache

<span class="c"># PowerShell</span>
New-Item <span class="nt">-ItemType</span> Directory <span class="nt">-Force</span> D:<span class="se">\n</span>pm-cache | Out-Null
</code></pre></div></div>

<ol>
  <li>잘 저장됐는지 확인</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm config list <span class="nt">-l</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'registry|strict-ssl|prefix|cache'</span>
<span class="c"># PowerShell</span>
npm config list <span class="nt">-l</span> | findstr /r <span class="s2">"registry strict-ssl prefix cache"</span>
</code></pre></div></div>

<ol>
  <li>이제 그냥 실행<br />
이제부터는 옵션 없이 네가 쓰려던 명령을 그대로 쓰면 된다.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">-y</span> @modelcontextprotocol/server-everything
</code></pre></div></div>

<p>실무 메모</p>

<ul>
  <li>
    <p>사용자 수준(~/.npmrc)은 현재 사용자에게만 적용된다. 프로젝트 전용 설정을 원하면 프로젝트 루트에 .npmrc를 두면 해당 디렉터리에서만 우선 적용된다.</p>
  </li>
  <li>
    <p>빠른 대안으로 CLI에서 영구 저장도 가능하다:<br />
macOS/Linux:</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm config <span class="nb">set </span>registry https://registry.npmmirror.com
npm config <span class="nb">set </span>strict-ssl <span class="nb">false
</span>npm config <span class="nb">set </span>prefix /opt/npm-global
npm config <span class="nb">set </span>cache /var/tmp/npm-cache
</code></pre></div>    </div>
  </li>
</ul>

<p>PowerShell:
    <code class="language-plaintext highlighter-rouge">powershell
    npm config set registry https://registry.npmmirror.com
    npm config set strict-ssl false
    npm config set prefix C:\npm-global
    npm config set cache D:\npm-cache
   </code></p>

<p>이 방식은 같은 내용이 ~/.npmrc에 기록된다.</p>

<ul>
  <li>
    <p>strict-ssl=false는 중간자 공격에 취약해진다. 보안이 필요한 환경에선 내부 CA를 쓰거나 cafile 설정을 권장한다.</p>
  </li>
  <li>
    <p>설정을 되돌리려면 백업한 ~/.npmrc.bak.* 파일을 다시 덮어쓰면 된다.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python MCP 연결 방법</title><link href="https://hvppyarchive.github.io/llm/unified-mcp-interface/" rel="alternate" type="text/html" title="Python MCP 연결 방법" /><published>2025-10-30T09:53:10+09:00</published><updated>2025-10-30T09:53:10+09:00</updated><id>https://hvppyarchive.github.io/llm/unified-mcp-interface</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/unified-mcp-interface/"><![CDATA[<p class="chat--user">

너는 LLM Agent 전문가야. MCP 두 개 이상(이건 입력으로 커맨드를 여러개 받을 수 있어)을 띄우고 모든 MCP 툴을 LLM에게 전달 및 실행하고 싶어. 

</p>

<p>좋아, 여러 개의 MCP 서버를 동시에 붙여서 “모든 MCP 툴을 LLM이 한 번에 보고 실행”하게 만드는 방법을 두 가지 경로로 정리해줄게. 첫째는 Anthropic Messages API의 MCP 커넥터를 그대로 쓰는 방법(가장 간단). 둘째는 직접 MCP 클라이언트를 만들어 여러 서버에 붙고, 툴 카탈로그를 합쳐서 LLM에게 제공하는 방법(커스텀 제어). 단계별로 바로 따라하면 된다. 인용구문은 쓰지 않는다.</p>

<h1 id="1-가장-쉬운-길-claude-messages-api의-mcp-커넥터로-여러-서버-붙이기">1) 가장 쉬운 길: Claude Messages API의 MCP 커넥터로 여러 서버 붙이기</h1>

<p>핵심은 <code class="language-plaintext highlighter-rouge">messages.create</code> 호출에 <code class="language-plaintext highlighter-rouge">mcp_servers</code> 배열을 넣어 여러 서버를 동시에 선언하는 것. 서버마다 이름을 부여하면 충돌 없이 툴을 구분할 수 있고, 모델은 각 서버에서 노출된 MCP 툴을 필요할 때 호출한다. 베타 헤더가 필요하다.</p>

<p>요청 바디 예시(둘 이상의 서버 연결):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">"claude-sonnet-4-5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"max_tokens"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"두 서버의 툴을 모두 활용해서 작업을 끝내줘"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"mcp_servers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example1.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tool_configuration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example2.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>이 방식의 포인트</p>

<ol>
  <li>
    <p>한 요청에서 여러 MCP 서버의 툴을 모두 노출할 수 있다.</p>
  </li>
  <li>
    <p>서버 이름(<code class="language-plaintext highlighter-rouge">name</code>)이 툴 호출 블록에 함께 들어가서 충돌을 피한다.</p>
  </li>
  <li>
    <p>현재는 “MCP의 툴 호출”만 지원(리소스/프롬프트 등은 제외)되고, HTTP로 공개된 원격 서버만 직접 연결된다(로컬 stdio는 불가). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>
  </li>
</ol>

<p>문서 근거와 스펙<br />
• MCP 커넥터 사용법과 멀티 서버 예시는 Claude 공식 문서의 “MCP connector”와 “Multiple MCP servers” 섹션에 그대로 있다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• MCP 자체 개념과 스펙은 프로토콜 사이트와 스펙 문서 참고. <a href="https://modelcontextprotocol.io/?utm_source=chatgpt.com">모델 컨텍스트 프로토콜+1</a></p>

<p>이 경로로 가면 “LLM에게 MCP 툴 전체를 그대로 전달하고, 실행은 모델이 알아서 서버별로 라우팅”해준다. 운영에서 OAuth 토큰이 필요한 서버는 <code class="language-plaintext highlighter-rouge">authorization_token</code> 필드로 전달하면 된다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>

<h1 id="2-더-유연한-길-직접-mcp-클라이언트를-만들어-멀티-서버--단일-툴-레지스트리로-합치기">2) 더 유연한 길: 직접 MCP 클라이언트를 만들어 “멀티 서버 → 단일 툴 레지스트리”로 합치기</h1>

<p>로컬/사내용 툴까지 다 엮고 싶거나, 툴 노출/로그/권한을 섬세하게 통제하려면 직접 클라이언트를 만드는 편이 좋다. 공식 SDK가 있다(타입스크립트, 파이썬 등). <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>

<p>아키텍처 개요</p>

<ol>
  <li>
    <p>각 MCP 서버와 별도의 세션으로 연결(stdio 또는 HTTP).</p>
  </li>
  <li>
    <p>모든 서버에서 <code class="language-plaintext highlighter-rouge">list_tools</code>를 받아 합친다. 이때 충돌을 막기 위해 <code class="language-plaintext highlighter-rouge">serverName:toolName</code> 같은 네임스페이스를 붙인다.</p>
  </li>
  <li>
    <p>합쳐진 툴 목록을 LLM의 “도구(Function/Tool Use)”로 등록한다.</p>
  </li>
  <li>
    <p>LLM이 <code class="language-plaintext highlighter-rouge">serverName:toolName</code>을 호출하면, 해당 서버 세션으로 라우팅해서 <code class="language-plaintext highlighter-rouge">call_tool</code> 실행 → 결과를 모델에 <code class="language-plaintext highlighter-rouge">tool_result</code>로 되돌린다.</p>
  </li>
</ol>

<p>예시 코드(타입스크립트, Node). 여러 서버에서 툴을 모아 네임스페이스화하고, 호출 시 라우팅한다. SDK는 공식 TS SDK를 사용한다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

// package.json: @modelcontextprotocol/sdk, zod, anthropic 등 설치 가정
// npm i @modelcontextprotocol/sdk zod anthropic

import { ClientSession } from '@modelcontextprotocol/sdk/client/session.js';
import { StdioClientTransport, StdioServerParameters } from '@modelcontextprotocol/sdk/client/stdio.js';
import Anthropic from '@anthropic-ai/sdk';

// 서버 설정
type ServerCfg = { name: string; command: string; args: string[] };
const SERVERS: ServerCfg[] = [
  { name: 'files', command: 'node', args: ['./servers/files/index.js'] },
  { name: 'db', command: 'python', args: ['./servers/db/server.py'] },
];

type Connected = {
  name: string;
  session: ClientSession;
};

const connected: Connected[] = [];

async function connectAll() {
  for (const s of SERVERS) {
    const params: StdioServerParameters = { command: s.command, args: s.args };
    const transport = new StdioClientTransport(params);
    await transport.start();
    const session = new ClientSession(transport);
    await session.initialize();
    connected.push({ name: s.name, session });
    console.log(`[MCP] connected: ${s.name}`);
  }
}

type ToolDesc = {
  name: string;              // namespaced: `${server}:${tool}`
  description?: string;
  input_schema: any;         // JSON Schema
};

// 모든 서버의 툴을 수집하여 네임스페이스 부여
async function collectTools(): Promise&lt;ToolDesc[]&gt; {
  const all: ToolDesc[] = [];
  for (const { name: serverName, session } of connected) {
    const { tools } = await session.listTools();
    for (const t of tools) {
      all.push({
        name: `${serverName}:${t.name}`,
        description: t.description,
        input_schema: t.inputSchema,
      });
    }
  }
  return all;
}

// LLM이 namespaced 툴을 호출하면 해당 서버로 라우팅
async function callNamespacedTool(nsName: string, args: any) {
  const [serverName, toolName] = nsName.split(':');
  const target = connected.find(c =&gt; c.name === serverName);
  if (!target) throw new Error(`Server not found: ${serverName}`);
  return target.session.callTool(toolName, args);
}

async function main() {
  await connectAll();
  const tools = await collectTools();

  const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! });

  // 대화 루프의 한 턴 예시
  let messages: any[] = [{ role: 'user', content: 'CSV를 DB에 적재하고 요약해줘' }];

  // Anthropic의 Tool Use 포맷에 맞춰 툴 전달
  const toolDefs = tools.map(t =&gt; ({
    name: t.name,
    description: t.description,
    input_schema: t.input_schema,
  }));

  let resp = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 1000,
    messages,
    tools: toolDefs,
  });

  // tool_use 처리 루프
  while (resp.content.some((c: any) =&gt; c.type === 'tool_use')) {
    const assistantContent: any[] = [];
    const toolResults: any[] = [];

    for (const c of resp.content) {
      if (c.type === 'text') assistantContent.push(c);
      if (c.type === 'tool_use') {
        const result = await callNamespacedTool(c.name, c.input);
        toolResults.push({
          type: 'tool_result',
          tool_use_id: c.id,
          content: result.content, // MCP 표준 content 배열
        });
      }
    }

    messages.push({ role: 'assistant', content: assistantContent.concat(resp.content.filter((c: any) =&gt; c.type === 'tool_use')) });
    messages.push({ role: 'user', content: toolResults });

    resp = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1000,
      messages,
      tools: toolDefs,
    });
  }

  console.log(resp.content.map((c: any) =&gt; (c.type === 'text' ? c.text : '')).join('\n'));
}

main().catch(e =&gt; { console.error(e); process.exit(1); });
</code></pre></div></div>

<p>이 패턴의 장점<br />
• 어떤 LLM이든(Anthropic/OpenAI/로컬) 표준 “툴 호출” 인터페이스만 있으면 같은 레지스트리를 재활용할 수 있다.<br />
• 서버별 권한, 로깅, 레이트 리밋, 입력 검증을 중앙에서 통제 가능.<br />
• 네임스페이스 전략으로 툴 이름 충돌을 확실히 방지.<br />
• stdio 로컬 서버와 원격 HTTP 서버를 섞어서 붙일 수 있다(직접 클라이언트 방식이므로). SDK가 stdio/HTTP 모두 지원한다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>설치·참고<br />
• 공식 TS SDK와 예제 서버/클라이언트, Streamable HTTP/stdio 전송계층은 깃허브 README와 예제에 상세. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a><br />
• “Build an MCP client” 튜토리얼(파이썬/노드 포함)도 멀티 서버로 확장하기 쉽다. 위 예시 로직은 그 흐름을 일반화한 것. <a href="https://modelcontextprotocol.io/quickstart/client">모델 컨텍스트 프로토콜</a></p>

<h1 id="운영-팁과-함정실무-체크리스트">운영 팁과 함정(실무 체크리스트)</h1>

<p>네임스페이스 규칙<br />
• <code class="language-plaintext highlighter-rouge">${server}:${tool}</code>로 고정하면 라우팅이 단순해진다. 툴 설명에도 서버명을 적어 LLM의 선택을 돕는다.<br />
• 모델이 “비슷한 두 툴”을 혼동할 수 있으니 설명에 차이를 명확히 쓰고 스키마에 제약을 넣는다.</p>

<p>권한과 안전장치<br />
• 서버별 <code class="language-plaintext highlighter-rouge">allowed_tools</code>로 노출 툴을 제한하거나, 자체 클라이언트라면 툴 화이트리스트를 적용한다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• 파괴적 툴(삭제/결제 등)은 “dry_run” 플래그를 스키마에 추가해 2단계 확인을 강제.<br />
• 프롬프트 인젝션 방지: 서버 측에서 입력 검증과 URL/경로 화이트리스트를 둔다.</p>

<p>성능/안정성<br />
• 초기에 모든 서버에 <code class="language-plaintext highlighter-rouge">list_tools</code>를 한 번만 호출하고 캐싱하라.<br />
• 툴 호출은 타임아웃과 재시도를 둔다. 실패 시 에러 메시지와 복구 힌트를 모델에게 짧게 제공하면 후속 계획을 모델이 스스로 조정한다.<br />
• 결과가 큰 경우(파일/표)는 리소스 링크를 반환하도록 MCP 쪽에서 설계하면 토큰 압박을 줄일 수 있다(리소스는 커넥터 경로에 따라 제한될 수 있음).</p>

<p>배포 토막 가이드<br />
• 원격 연결 위주면 Claude의 MCP 커넥터가 가장 빠른 온보딩이다(단, HTTP 공개 필요). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• 사내망·로컬 혼합이면 직접 클라이언트 구성이 유리하다. TS SDK의 streamable HTTP + stdio를 혼용하면 된다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>다음 확장 아이디어<br />
• “자동 라우터”: 툴 메타데이터에 domain 태그를 두고, 사용자 요청을 분류해 관련 서버 툴만 모델에 노출(토큰/혼란 감소).<br />
• “관측성”: 모든 tool_use/tool_result를 이벤트로 로그 수집해 실패율/지연/입력 분포를 대시보드로 본다.<br />
• “권한 승격”: 고위험 툴 호출은 사람 확인을 요구하는 인가 훅을 중앙 클라이언트에 추가.</p>

<p>원하면 네가 쓰려는 서버 목록과 전송 방식(stdio/HTTP), 붙일 모델(Claude/OpenAI 등)을 알려줘. 거기에 맞춰 완성 스캐폴딩을 바로 내줄게.</p>

<p class="chat--user">

타입스크립트 말고 파이썬 mcp 로 부탁해 그리고 커스텀 엔드포인트 LLM을 사용할거야.

</p>

<p>좋아. 파이썬으로 MCP 다중 서버를 붙이고, 커스텀 LLM 엔드포인트(자체 호스팅 모델)에 “툴 콜링”을 돌리는 전체 오케스트레이터 스캐폴딩을 바로 줄게. 핵심 아이디어는 두 가지다. 첫째, 여러 MCP 서버에 각각 세션을 열고 툴 목록을 합쳐서 네임스페이스(server:tool)로 노출. 둘째, 커스텀 LLM의 /chat API에 툴 스키마를 전달하고, 응답 내 tool_calls를 받아 해당 MCP 서버로 라우팅해 실행 결과를 다시 모델에 피드백하는 루프를 돈다.</p>

<p>아래 코드는 바로 실행 가능한 단일 파일 예시다. 커스텀 LLM의 API 포맷은 OpenAI 함수콜과 유사한 형태를 가정했지만, 클래스 한 군데만 바꾸면 어떤 엔드포인트든 맞출 수 있도록 어댑터를 분리해두었다.</p>

<p>설치 가정<br />
pip install mcp requests pydantic orjson</p>

<p>main.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># 선택: SSE(원격 HTTP) 서버를 붙일 때
</span>    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#######################################################################
# 0) 데이터 모델: LLM과 툴콜 인터페이스(커스텀 엔드포인트 어댑터용)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI style에 가깝게 노멀라이즈해 커스텀 LLM에 전달
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(JSON str)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># 필요 시 stop_reason 등 추가
</span>
<span class="c1">#######################################################################
# 1) MCP 연결 유틸: 여러 서버 연결하고 툴 합치기(네임스페이스)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># stdio 또는 sse
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># sse
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 설치되어야 SSE 연결을 사용할 수 있습니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="c1"># t.name, t.description, t.input_schema
</span>                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># JSON Schema
</span>                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># namespaced = "server:tool"
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">툴 이름은 </span><span class="sh">'</span><span class="s">server:tool</span><span class="sh">'</span><span class="s"> 형식이어야 합니다: </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server_name</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="c1"># MCP 표준 content를 단일 문자열 또는 JSON으로 정리
</span>                <span class="c1"># MCP content는 list of {type: "text"|"json"|"blob", ...}
</span>                <span class="c1"># 여기서는 간단히 text/json만 지원 예시
</span>                <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># blob/resource 등은 필요 시 확장
</span>                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">서버를 찾을 수 없음: </span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1">#######################################################################
# 2) 커스텀 LLM 어댑터: 너의 사설 /chat 엔드포인트에 맞춰 조정
#######################################################################
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    너의 커스텀 엔드포인트 규약을 한 곳에 캡슐화.
    아래는 예시 규약:
      POST {base_url}/chat
      json: {
        </span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}],
        </span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...}}}]
      }
    응답:
      {
        </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">assistant text...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [
          {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">{</span><span class="se">\"</span><span class="s">k</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">v</span><span class="se">\"</span><span class="s">}</span><span class="sh">"</span><span class="s">}}
        ]
      }
    필요한 경우 이 클래스만 수정하면 된다.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">extra_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span> <span class="o">=</span> <span class="n">extra_headers</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span> <span class="k">if</span> <span class="n">tools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

<span class="c1">#######################################################################
# 3) 오케스트레이터: 툴 병합 → LLM 대화 루프 → MCP 라우팅
#######################################################################
</span>
<span class="k">def</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">merged_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
    <span class="n">defs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">merged_tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP tool </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="p">}</span>
        <span class="n">defs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">defs</span>

<span class="k">def</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">args_raw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">args_raw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args_raw</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args_raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sh">""</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 모델이 JSON이 아닌 걸 내는 경우 방어
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_conversation</span><span class="p">(</span>
    <span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">):</span>
    <span class="n">tools_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">llm_tools</span> <span class="o">=</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">tools_catalog</span><span class="p">)</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">system_prompt</span><span class="p">:</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">))</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">llm_tools</span><span class="p">)</span>
        <span class="c1"># 우선 어시스턴트 텍스트가 있으면 추가
</span>        <span class="n">assistant_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="n">assistant_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">assistant_text</span><span class="p">))</span>

        <span class="c1"># 툴콜 없으면 종료
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># MCP 라우팅 → 결과를 tool_result로 user에 피드백
</span>        <span class="n">tool_results_acc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="c1"># 결과를 다시 모델에게 피드백: 단순화를 위해 JSON 텍스트로 합침
</span>                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="c1"># 다수 툴 호출 결과를 하나의 user 메시지로 재주입
</span>        <span class="n">feedback_text</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tool_results_acc</span><span class="p">)</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="si">{</span><span class="n">feedback_text</span><span class="si">}</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1">#######################################################################
# 4) 샘플 엔트리포인트
#######################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 4-1) 붙일 MCP 서버들 정의
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># 로컬 stdio 예시
</span>        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># 원격 SSE 예시(있다면)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"authorization":"Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>

    <span class="c1"># 4-2) 커스텀 LLM 엔드포인트 설정
</span>    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_API_KEY</span><span class="sh">"</span><span class="p">),</span>            <span class="c1"># 필요 시
</span>        <span class="n">extra_headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">x-tenant</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo</span><span class="sh">"</span><span class="p">}</span>                 <span class="c1"># 필요 시
</span>    <span class="p">)</span>

    <span class="c1"># 4-3) 대화 한 턴 예시
</span>    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">너는 MCP 툴을 활용해 일을 끝내는 에이전트다. 위험 작업은 dry_run을 선호하고, 명시적으로 승인받기 전에는 파괴적 변경을 하지 않는다.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSV를 files 서버의 ingest_csv 툴로 적재하고, db 서버의 sql_summary로 요약해줘. 파일 경로는 ./data/sales.csv</span><span class="sh">"</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_conversation</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 대화 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">2000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>동작 흐름 설명<br />
1단계. MCPMux가 각 서버에 세션을 연다. stdio 서버는 command+args로 프로세스를 실행하고, sse 서버는 HTTP SSE로 연결한다.<br />
2단계. list_tools를 모든 서버에서 모아서 네임스페이스(server:tool)로 변환한다.<br />
3단계. 커스텀 LLM 엔드포인트에 messages와 tools를 넘긴다. tools는 OpenAI식 function 포맷으로 정규화해서 전달한다.<br />
4단계. LLM이 tool_calls를 반환하면, 각 call의 function.name이 server:tool이므로 해당 서버로 라우팅해서 call_tool을 실행한다.<br />
5단계. 결과를 TOOL_RESULTS 텍스트로 user 역할 메시지에 합쳐서 모델에 다시 주입한다. 모델은 추가적인 tool_calls를 내거나, 최종 답변을 낸다.<br />
6단계. tool_calls가 더 이상 없으면 루프 종료.</p>

<p>운영 팁<br />
네임스페이스 고정. server:tool 네이밍을 스키마 description에도 반복해서 LLM의 선택 오류를 줄인다.<br />
권한 경계. 삭제·결제·배포 같은 툴에는 parameters에 dry_run(boolean, default true) 같은 필드를 추가해 2단계 승인을 유도하라.<br />
타임아웃·재시도. SSE나 stdio 모두 외부 프로세스/네트워크에 민감하니 call_tool에는 서버 측 타임아웃과 재시도를 둔다. 필요 시 MCPMux.call에 재시도를 추가하라.<br />
대용량 결과. 파일·표·바이너리 결과는 MCP 리소스(파일 핸들)나 외부 저장소 URL을 반환하고, LLM에는 메타데이터만 보내 토큰을 아끼는 설계를 추천한다.<br />
적응층. CustomLLMClient를 너의 실제 /chat 규격에 맞게 수정한다. 예컨대 문서화된 JSON 키 이름이 다르면 ChatResponse 파싱만 바꾸면 된다.</p>

<p>테스트 방법<br />
가짜 서버부터. servers 디렉터리에 echo 수준의 간단한 MCP 서버 두 개(files, db)를 만들어 list_tools와 call_tool만 최소 구현한다.<br />
단위 테스트. CustomLLMClient.send를 모킹해 tool_calls를 강제로 내보내고, MCPMux.call이 올바른 서버로 라우팅되는지 확인한다.<br />
엔드투엔드. 실제 LLM 엔드포인트로 교체해 CSV → SQL 요약 같은 워크플로를 한 번에 돌려본다.</p>

<p>확장 아이디어<br />
자동 라우팅. 도메인 태그(files/db/search 등)를 보고 관련 툴만 tools 배열에 노출해 토큰과 혼란을 줄인다.<br />
감사 로그. 모든 tool_call 입력·출력을 JSONL로 파일에 적재해 지연, 실패율, 위험 호출을 모니터링한다.<br />
휴먼 게이트. 위험한 툴콜이 감지되면 CustomLLMClient로 바로 보내지 말고, 별도 승인 UI 혹은 CLI에서 1회 승인 후 재주입한다.</p>

<p>원하는 /chat 규격(JSON 예시 스펙)이나 실제 엔드포인트 샘플을 알려주면, 위 어댑터를 거기에 딱 맞춰 구체화해서 리라이트해줄 수 있다.</p>

<p class="chat--user">

질문이 있어. 1. 그냥 툴을 그대로 보내면 오류가 더 많을까? 2. 일반 툴 콜링과 섞여 있는 예시도 보여주면 좋겠어. 

</p>

<p>좋아, 두 가지 모두 딱 꽂히게 정리해줄게. 결론 먼저, 그다음 바로 실행 가능한 파이썬 예시로 마무리한다.</p>

<ol>
  <li>그냥 “서버에서 받은 툴을 전부” 모델에 그대로 보여주면 오류가 더 많을까?<br />
짧은 답: 보통 그렇다. 이유는 예측 가능하다.</li>
</ol>

<ul>
  <li>
    <p>과적재(too many tools). 툴이 많아질수록 선택 오류가 늘고, 모델이 비슷한 툴을 혼동한다. 비슷한 이름, 비슷한 설명은 특히 위험하다.</p>
  </li>
  <li>
    <p>스키마 느슨함. parameters(JSON Schema)에 타입·필수 필드·enum 제약이 약하면 arguments 형식 오류가 증가한다.</p>
  </li>
  <li>
    <p>문맥 미스매치. 현재 턴과 관계없는 툴까지 모두 보이면 “근처에 있는 도구” 편향 때문에 엉뚱한 걸 집는다.</p>
  </li>
  <li>
    <p>네임 충돌·의도 충돌. 서로 다른 서버에 같은 이름, 유사 기능이 있으면 라우팅·선택 모두 흔들린다.</p>
  </li>
  <li>
    <p>부작용 위험. 삭제/결제/배포 같은 툴을 아무 맥락 없이 노출하면 모델이 성급히 실행하려 한다(모델은 과감하다).</p>
  </li>
  <li>
    <p>레이턴시·실패 전파. 원격/SSE 툴 다수는 타임아웃과 429가 뒤섞여 에러 증폭을 만든다.</p>
  </li>
</ul>

<p>현업에서 에러를 줄이는 실전 처방</p>

<ul>
  <li>
    <p>턴별 툴 소출(Selective exposure). 유저 입력을 기준으로 관련 서버/도메인의 툴만 노출한다. 단순 키워드 라우팅만 넣어도 실패율이 뚝 떨어진다.</p>
  </li>
  <li>
    <p>네임스페이스 필수. server:tool 이름으로 고정하고, description에도 서버/도메인을 반복 명시한다.</p>
  </li>
  <li>
    <p>스키마를 엄격하게. type/enum/minItems/format까지 빡빡하게 걸어라. 가능하면 예제(example) 필드까지 넣는다.</p>
  </li>
  <li>
    <p>고위험 툴에 세이프티 플래그. dry_run 기본값 true, confirmation string 같은 이중 잠금.</p>
  </li>
  <li>
    <p>응답 정규화. MCP tool_result를 항상 같은 JSON 포맷으로 묶어 모델에 재주입해 학습된 기대 형태를 유지한다.</p>
  </li>
  <li>
    <p>타임아웃/재시도/백오프 표준화. 서버별 기본값이 달라도 클라이언트에서 상한을 통일한다.</p>
  </li>
  <li>
    <p>툴 캡. 한 턴에 최대 10~20개 정도만 노출(경험상 8~12에서 가장 안정적).</p>
  </li>
</ul>

<ol>
  <li>“일반 툴 콜링”과 “MCP 툴 콜링”이 섞여 있는 예시<br />
아래는 이전 파이썬 스캐폴딩을 얇게 확장한 버전이다. 핵심은 디스패처에 로컬(일반) 툴 네임스페이스 local.* 를 추가하고, LLM이 같은 턴에서 local.* 과 server:tool(MCP)을 섞어서 호출해도 자연스럽게 라우팅되는 구조다.</li>
</ol>

<p>필요 패키지<br />
pip install mcp requests pydantic orjson</p>

<p>mixed_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="c1"># ======== 공용 데이터 모델 ========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># ======== MCP 멀티 서버 MUX ========
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ======== 로컬(일반) 툴: 예시 구현 ========
</span>
<span class="k">def</span> <span class="nf">local_tools_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전한 사칙연산/간단식 평가기. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">텍스트에서 자주 등장하는 단어 상위 K를 뽑아준다. 입력: {text: string, k: integer}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># 아주 보수적인 계산기(숫자, + - * / () 만 허용)
</span>        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}}]}</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">collections</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[A-Za-z0-9가-힣]+</span><span class="sh">"</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="nc">Counter</span><span class="p">([</span><span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">])</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">.</span><span class="nf">most_common</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">top</span><span class="sh">"</span><span class="p">:</span> <span class="n">top</span><span class="p">}}]}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ======== 커스텀 LLM 어댑터(예시) ========
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>

<span class="c1"># ======== 툴 노출 전략(간단 소출 예시) ========
</span>
<span class="k">def</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">keep</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">user_text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>

    <span class="c1"># 키워드 기반 라우팅(아주 얕은 예시)
</span>    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ingest</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">load</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">데이터베이스</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">요약</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">summary</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># 항상 노출할 로컬 도구
</span>    <span class="n">local_basics</span> <span class="o">=</span> <span class="nf">local_tools_catalog</span><span class="p">()</span>

    <span class="c1"># 중복 제거 및 이름 네임스페이스 적용
</span>    <span class="k">def</span> <span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

    <span class="n">uniq</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
        <span class="n">uniq</span><span class="p">[(</span><span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">tooldefs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">uniq</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>
    <span class="n">tooldefs</span> <span class="o">+=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]})</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">local_basics</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tooldefs</span>

<span class="c1"># ======== 대화 루프 ========
</span>
<span class="k">def</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>
    <span class="n">all_mcp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system</span><span class="p">),</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">tools_exposed</span> <span class="o">=</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">)</span>  <span class="c1"># 턴별 소출
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools_exposed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># 섞여 있는 툴콜 처리: local.* ↔ server:tool
</span>        <span class="n">results_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_texts</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ======== 실행 예시 ========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
    <span class="p">])</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">너는 안전하고 신중한 에이전트다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSV를 적재하고(sql 요약까지). 수치 확인은 계산기로 한번 검증해줘. 파일은 ./data/sales.csv 이야.</span><span class="sh">"</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== LOG ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>이 코드에서 확인할 수 있는 것</p>

<ul>
  <li>
    <p>한 턴에 LLM이 local.math_eval(일반 툴)과 files:ingest_csv(MCP) / db:sql_summary(MCP)를 섞어 호출해도 디스패처가 각각 맞는 경로로 라우팅한다.</p>
  </li>
  <li>
    <p>selective_expose가 턴별 툴 소출을 해준다. 유저 요청에 필요 없는 서버 툴은 숨겨서 혼란과 에러를 줄인다.</p>
  </li>
  <li>
    <p>로컬 툴은 파이썬 함수로 바로 처리하므로 레이턴시가 적고, 간단한 검증·후처리(예: 계산으로 sanity-check)를 빠르게 수행할 수 있다.</p>
  </li>
</ul>

<p>마지막으로, 에러를 더 줄이려면</p>

<ul>
  <li>
    <p>툴 설명에 “언제 쓰는지/언제 쓰지 말아야 하는지”를 한 문장씩 명시한다.</p>
  </li>
  <li>
    <p>위험 툴의 parameters에 confirm 문자열(예: "I understand this deletes data")을 required로 추가한다.</p>
  </li>
  <li>
    <p>TOOL_RESULTS 포맷을 팀 공통 JSON 스키마로 고정해 모델이 예측 가능한 후속 계획을 세우도록 한다.</p>
  </li>
  <li>
    <p>각 서버/툴별 타임아웃·재시도·서킷브레이커를 공통 미들웨어로 묶는다.</p>
  </li>
</ul>

<p>여기까지면 커스텀 LLM 엔드포인트에서도 “일반+MCP 혼합 툴콜”을 안정적으로 돌릴 수 있다. 다음 단계는 네가 쓰는 /chat 스펙에 맞춰 CustomLLMClient의 직렬화/역직렬화 부분만 미세조정하고, 실제 서버 두 개(files/db) 최소 구현으로 E2E를 한 번 굴려보는 것이다.</p>

<p class="chat--user">

오호. 다음은 어려운 문제야. 이걸 openai agent python sdk에 붙일 수 있을까?

</p>

<p>가능하다. 게다가 “여러 MCP 서버”와 “커스텀 LLM 엔드포인트”를 동시에 쓰는 구성이 OpenAI Agents Python SDK에서 정석으로 지원된다. 요점만 단계별로 정리하고, 바로 돌아가는 최소 예시를 준다.</p>

<p>핵심 정리</p>

<ol>
  <li>
    <p>Agents SDK는 MCP를 4가지 전송으로 붙인다: Hosted MCP(Responses API가 원격서버를 직접 호출), Streamable HTTP, HTTP+SSE, stdio(로컬 프로세스). 서버 여러 개를 mcp_servers 리스트에 넣으면 한 에이전트가 전부를 본다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>모델은 OpenAI 모델 말고도 LiteLLM 확장을 통해 “OpenAI 호환 REST”로 노출된 임의의 엔드포인트를 모델처럼 쓸 수 있다. base_url만 네 엔드포인트로 바꾸면 된다. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Hosted MCP를 쓰면 OpenAI 인프라가 원격 MCP 서버를 직접 호출하므로 파이썬 쪽 콜백이 필요 없다(공개 접근 가능한 원격 서버에 적합). 반대로 사내망/로컬은 stdio·SSE 등 “직접 붙이기”가 맞다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Agents SDK에는 MCP 전용 클래스들이 이미 들어있다(MCPServerStdio, MCPServerSse, MCPServerStreamableHttp, HostedMCPTool 등). <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub+1</a></p>
  </li>
</ol>

<p>빠른 스캐폴딩(파이썬)<br />
설치<br />
pip install openai-agents mcp</p>

<p>예시 1) 커스텀 LLM(base_url) + stdio/SSE MCP 다중 서버 한 번에 붙이기<br />
아래는 파일시스템 MCP를 로컬(stdio)로, 사내용 검색 MCP를 SSE로 붙이고, 모델은 너의 커스텀 /v1 Chat 호환 엔드포인트를 씀.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>  <span class="c1"># 커스텀 엔드포인트용
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 서버들을 context manager로 기동/연결
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer XYZ</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="c1"># 2) 커스텀 LLM 엔드포인트(OpenAI 호환) 모델로 지정
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>                 <span class="c1"># 엔진/이름
</span>            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>     <span class="c1"># 네 엔드포인트
</span>            <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">sk-your-key</span><span class="sh">"</span><span class="p">,</span>                   <span class="c1"># 필요시
</span>        <span class="p">)</span>

        <span class="c1"># 3) 에이전트 구성: 여러 MCP 서버를 한 번에 노출
</span>        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Orchestrator</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP 툴을 안전하게 사용하고, 필요할 때만 호출한다.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 필요 시 "required"로 강제
</span>        <span class="p">)</span>

        <span class="c1"># 4) 실행
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더의 CSV를 읽고, search 서버로 관련 문서 찾아 요약해줘</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>예시 2) Hosted MCP를 섞는 변형<br />
원격에 공개된 MCP 서버는 HostedMCPTool 하나만 tools에 넣으면 모델이 OpenAI 인프라에서 직접 목록조회/호출까지 한다. 파이썬 쪽 콜백이 거의 없다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">HostedMCPTool</span>

<span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">HostedMCPUser</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="nc">HostedMCPTool</span><span class="p">(</span><span class="n">tool_config</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_label</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gitmcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://gitmcp.io/openai/codex</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">require_approval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">})],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">이 저장소의 주요 언어를 알려줘</span><span class="sh">"</span><span class="p">).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>위 두 방식은 공식 문서의 사용법과 동일한 흐름이다. Hosted MCP, stdio/SSE/HTTP 서버, 툴 필터링, 승인 훅까지 포함된 가이드를 참고해 세부옵션을 맞추면 된다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>

<p>툴 소출 전략(오류 줄이는 팁)</p>

<ol>
  <li>
    <p>툴 필터링: 서버 생성자에 tool_filter를 걸거나 정적/동적 필터를 써서 턴별로 필요한 툴만 노출하라. SDK가 도우미를 제공한다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>위험 툴 승인: HostedMCPTool은 require_approval 및 on_approval_request 콜백으로 민감 작업을 승인 플로로 감싼다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>캐싱과 재시도: cache_tools_list, max_retry_attempts 등 옵션으로 지연과 실패 확률을 줄일 수 있다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
</ol>

<p>한 줄 결론<br />
OpenAI Agents Python SDK에 네가 만든 “멀티 MCP + 커스텀 LLM 엔드포인트”를 그대로 붙일 수 있다. 모델은 LiteLLMModel로 커스텀 REST를 쓰고, MCP는 mcp_servers에 여러 개를 열거하거나 HostedMCPTool을 병용하면 된다. 필요하면 너의 엔드포인트 스펙에 맞춰 모델 어댑터를 더 촘촘하게 설정하는 코드도 만들어주겠다. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub+2</a></p>

<p class="chat--user">

아니 난 너가 만든 코드를 그대로 쓰고 싶어. 왜냐면 이렇게 만든 인터페이스를 다른 Chat 에도 쓰고 싶거든. Agent만을 위한 다른 코드가 분기 되는 것이 싫어. Tool만 입력해서 동작하게 하는 방법 없어?

</p>

<p>좋아. “Agent 전용 분기 없이” 너가 만든 인터페이스를 어떤 Chat에도 재사용하려면, 입력은 오직 툴(=프로바이더)과 LLM 엔드포인트만 주고 돌아가는 얇은 오케스트레이터가 필요하다. 아래는 그 목적에 맞춘 단일 파일 스캐폴딩이다. 핵심은 세 가지 인터페이스다.</p>

<ol>
  <li>
    <p>ChatBackend: 어떤 채팅 모델이든 붙일 수 있는 백엔드 어댑터.</p>
  </li>
  <li>
    <p>ToolProvider: 툴 카탈로그를 노출하고 호출을 처리하는 표준 인터페이스.</p>
  </li>
  <li>
    <p>Orchestrator: messages + tools만으로 루프를 돌린다. 어떤 에이전트 SDK 분기도 없다.</p>
  </li>
</ol>

<p>설치<br />
pip install mcp requests pydantic orjson</p>

<p>tools_only.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== 공통 데이터 모델 ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI/함수콜 호환 포맷으로 통일
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(str or dict)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    OpenAI Chat Completions 호환(또는 유사) 엔드포인트용 백엔드.
    /v1/chat/completions 또는 /chat 같은 곳에 맞춰 최소한의 어댑터만 제공.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>  <span class="c1"># "/v1/chat/completions"로 바꿔도 됨
</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="c1"># 서버 규격에 맞게 필요한 키만 담는다. 필요시 여기만 수정.
</span>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="c1"># data를 ChatResponse로 매핑; 너의 엔드포인트 규격에 맞게 여기만 조정하면 된다.
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 2) ToolProvider 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ToolProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span> <span class="bp">...</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>

<span class="c1"># ---- 2-1) MCP 프로바이더 (여러 서버 포함) ----
# mcp 설치 필요
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># 네임스페이스
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="c1"># 동기 인터페이스 요구 때문에 캐시 기반. 최초 호출 전에 warmup()을 호출하거나,
</span>        <span class="c1"># Orchestrator가 응답 전 await ensure_ready()를 한 번 수행.
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await provider.ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="c1"># list_tools는 async라 여기서 미리 모은다.
</span>        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># tool_name은 "server:tool"이어야 함
</span>        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server namespace: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ---- 2-2) 로컬 툴 프로바이더(선택) ----
</span>
<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                    <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (도구만 입력해서 동작) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    목적: 툴만 입력해서 동작. 어떤 Chat(백엔드)에도 재사용.
    - providers: ToolProvider들의 리스트
    - backend: ChatBackend 구현체 1개
    - expose_fn: 선택적으로 </span><span class="sh">'</span><span class="s">툴 소출</span><span class="sh">'</span><span class="s"> 전략을 주입 (기본값: 전부 노출)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolProvider</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># MCPProvider 같은 async 준비가 필요한 프로바이더를 워밍업
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 각 프로바이더가 책임지는 네임스페이스로 라우팅
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># 빠른 판별: MCP는 "server:" 네임스페이스, 로컬은 "local." 같은 규칙 추천
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">):</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>  <span class="c1"># server:tool
</span>                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># 마지막 fallback: 모든 provider에 시도
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider could handle tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="c1"># 툴 카탈로그를 수집하고 소출 전략 적용
</span>            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="c1"># 모델에게 도구결과를 일괄 재주입
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 서버들: 필요 서버만 나열
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>

    <span class="c1"># 2) 로컬 툴(선택)
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># 3) 어떤 Chat이든 붙일 백엔드. base_url과 path만 맞추면 끝.
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span>               <span class="c1"># 필요에 따라 "/v1/chat/completions" 등으로 변경
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) 오케스트레이터: 입력은 “툴(프로바이더)”뿐
</span>    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="c1"># 간단 소출: 파일/SQL 관련 단어가 없으면 MCP를 숨기고 로컬만 노출
</span>        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSV를 읽고 합계를 계산한 뒤 수치가 맞는지 계산기로 검증해줘. 파일은 ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 MCP 툴을 신중히 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>설명과 사용법 요약<br />
입력은 툴(프로바이더)만 넘긴다. 오케스트레이터는 툴 카탈로그를 합치고, LLM 응답의 tool_calls를 받아 적절한 프로바이더로 라우팅한다. 특정 에이전트 SDK 분기가 전혀 없다. 다른 Chat 백엔드로 바꾸고 싶으면 OpenAICompatibleBackend만 교체하거나 send 메소드가 동일한 시그니처를 가지는 새 클래스를 하나 추가하면 된다.</p>

<p>운영 팁<br />
툴 소출 함수(expose_fn)로 턴별 필터링을 꼭 넣자. 단순 키워드만으로도 선택 오류와 불필요 호출이 크게 준다.<br />
네임스페이스를 일관되게 유지하자. MCP는 server:tool, 로컬은 local.*처럼 구분하면 충돌이 없다.<br />
고위험 툴은 parameters에 dry_run, confirm 문자열 같은 제약을 넣어야 한다.<br />
대용량 결과는 MCP 서버가 파일 핸들(리소스)로 반환하고, 모델에는 요약/메타데이터만 재주입해 토큰을 아끼자.</p>

<p>이 구조면 같은 Orchestrator를 그대로 두고, 어떤 Chat UI/엔진에도 쉽게 이식할 수 있다. 필요하면 네 엔드포인트의 정확한 JSON 규격을 알려줘. OpenAICompatibleBackend의 매핑만 10줄쯤 손보면 바로 물릴 수 있게 맞춰줄 수 있다.</p>

<p class="chat--user">

이건 또 openai agent는 안 쓰는 것 같은데

</p>

<p>맞아, 방금 준 스캐폴딩은 “오픈AI Agents SDK”를 쓰지 않는 순수 오케스트레이터였지. 너가 원하는 건 그 코드를 그대로 유지하면서, 백엔드만 갈아끼워 “OpenAI Agents Python SDK”를 LLM 백엔드로 사용할 수 있게 하는 것. 아래처럼 백엔드 어댑터 하나만 추가하면 된다. 오케스트레이터·툴 프로바이더·라우팅은 그대로 재사용하고, 에이전트 SDK는 단지 “텍스트+툴콜 JSON을 뱉는 모델 백엔드”로만 쓴다. 즉, Agents SDK에게 MCP 실행을 맡기지 않고, 우리가 만든 라우터가 계속 MCP를 호출한다.</p>

<p>핵심 아이디어<br />
에이전트 SDK에게 도구를 등록하지 않는다(tool_choice 없이). 대신 우리가 넘긴 툴 카탈로그를 프롬프트에 JSON으로 주고, 에이전트가 반드시 다음 포맷의 JSON만 출력하도록 강제한다. 그러면 우리 오케스트레이터가 그 JSON을 파싱해 실제 MCP/로컬 툴로 라우팅한다. 이러면 Agent 전용 코드 분기가 생기지 않는다. 백엔드를 바꿔 끼우는 것만으로 같은 오케스트레이터가 그대로 동작한다.</p>

<p>설치<br />
pip install openai-agents mcp requests pydantic orjson</p>

<p>agents_backend.py<br />
아래 파일은 네가 이전에 받은 tools_only.py의 구조를 그대로 따르되, ChatBackend 구현체로 AgentsBackend를 추가한 버전이다. 나머지는 동일하니 이 파일 하나로 교체해도 되고, 필요한 부분만 가져다 써도 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== 공통 데이터 모델 ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {"name": ..., "arguments": str|dict}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 1-b) OpenAI Agents SDK 백엔드 어댑터 ==========
</span>
<span class="c1"># Agents SDK는 내부적으로 도구 실행까지 맡길 수 있지만,
# 여기서는 "텍스트+툴콜 JSON을 생성하는 모델"로만 사용한다.
# 프롬프트 강제 형식으로 tool_calls를 JSON으로 출력하게 만든다.
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># LiteLLM 모델 확장을 사용해 임의의 OpenAI 호환 엔드포인트를 붙일 수 있다.
</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># 도구는 에이전트에 등록하지 않는다. 우리가 직접 라우팅할 것이기 때문.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 절대 자동 도구 호출 금지
</span>        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 툴 목록을 JSON으로 주고, 정확한 출력 포맷을 강제한다.
</span>        <span class="n">tools_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span>
            <span class="n">tools_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tools_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_prompt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">위는 대화 내역이다. 아래는 사용 가능한 도구 목록이다.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">TOOLS_JSON=</span><span class="si">{</span><span class="n">tools_json</span><span class="si">}</span><span class="se">\n\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">반드시 다음 JSON 포맷으로만 답하라. 다른 텍스트는 절대 출력하지 말라.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">{</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;최종 자연어 응답(있으면)&gt;</span><span class="sh">"</span><span class="s"> ,</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-1</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}},</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-2</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}}</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">"</span><span class="s">  ]</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">}</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">여러 도구가 필요하면 tool_calls 배열에 순서대로 넣어라. 도구가 필요 없으면 빈 배열을 넣어라.</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">history</span> <span class="o">+</span> <span class="p">[</span><span class="sh">""</span><span class="p">,</span> <span class="n">guide</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_build_prompt</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
        <span class="c1"># Developer 메시지에 강제 포맷 가이드를 넣어 JSON만 출력하게 한다.
</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">JSON 포맷만 출력</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># JSON 파싱 실패 시, 일반 텍스트만 채워서 반환
</span>            <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">tool_calls</span><span class="o">=</span><span class="p">[])</span>
        <span class="c1"># 표준 ChatResponse로 맵
</span>        <span class="n">tc_raw</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># arguments가 dict가 아닐 수도 있으니 그대로 통과(오케스트레이터 쪽에서 정규화)
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span><span class="nc">ToolCall</span><span class="p">(</span><span class="o">**</span><span class="n">tc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tc_raw</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tc_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

<span class="c1"># ========== 2) ToolProvider (MCP/로컬) ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                <span class="p">}))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산. 입력 {expr:string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">})]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (변경 없음) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># 네임스페이스 단서
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LocalToolsProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># 폴백
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider can handle </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># MCP 서버 예시
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>
    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># A) OpenAI Agents SDK를 백엔드로 사용
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">AgentsBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># OpenAI 호환 엔드포인트(LiteLLM도 가능)
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>                <span class="c1"># 혹은 네 임의 모델명
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>

    <span class="c1"># B) 필요하면 기존 OpenAICompatibleBackend로 교체 가능
</span>    <span class="c1"># backend = OpenAICompatibleBackend(base_url="http://localhost:8000", path="/chat", model="my-model")
</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSV를 읽고 합계를 구한 뒤 계산기로 수치 검증까지 해줘. 파일은 ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 MCP 툴을 신중히 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>작동 방식 정리<br />
1단계. AgentsBackend는 OpenAI Agents Python SDK의 Agent를 모델 백엔드로만 쓴다. 도구는 등록하지 않는다.<br />
2단계. 우리가 노출할 툴 목록을 JSON으로 프롬프트에 넣고, 에이전트가 content와 tool_calls 배열을 정확히 담은 JSON만 출력하게 강제한다.<br />
3단계. 오케스트레이터는 그 tool_calls를 받아 기존과 똑같이 MCP/로컬 툴로 라우팅한다.<br />
4단계. 즉, 같은 오케스트레이터 코드를 유지한 채, 백엔드만 갈아끼워 Agents SDK 또는 일반 OpenAI 호환 엔드포인트를 자유롭게 선택할 수 있다.</p>

<p>주의점과 팁<br />
JSON 강제 프롬프트가 중요하다. 모델이 장식 텍스트를 섞지 않도록 developer_instructions로 “JSON만 출력”을 반복해서 고정하라.<br />
툴 스키마를 엄격하게. required, enum, format을 충분히 넣으면 arguments 파싱 실패가 줄어든다.<br />
성능. AgentsBackend는 Runner.run_sync를 한 턴마다 호출한다. 대화 길어지면 토큰·시간이 늘어나므로 expose_fn으로 툴을 턴별로 소출하고, 결과는 요약해서 재주입하라.<br />
대체. 에이전트 SDK의 모델 대신 OpenAICompatibleBackend로 바꾸면 바로 동일 코드가 다른 Chat에도 붙는다. 목적에 맞춰 백엔드만 교체하면 된다.</p>

<p>이렇게 하면 에이전트 SDK를 “백엔드 모델”로만 쓰면서, 너의 툴 중심 인터페이스와 라우터는 그대로 유지된다. 다음에는 네 실제 엔드포인트의 출력 JSON 예시를 알려줘. AgentsBackend의 JSON 파싱 부분을 거기에 맞춰 2~3줄만 조정하면 된다.</p>

<p class="chat--user">

아 복잡해 그냥 function_tool로 각 tool을 등록하면 어떨까

</p>

<p>좋지. “그냥 function_tool로 각 툴을 등록”하는 가장 깔끔한 방법은, MCP 서버들에서 list_tools를 긁어와서 각각을 Agents SDK의 FunctionTool로 동적으로 래핑하는 거야. 그러면 Agent 쪽은 전혀 커스텀 분기 없이 표준 툴만 본다. 아래 코드가 바로 그 패턴이고, 커스텀 LLM도 LiteLLM 모델 어댑터로 붙인다.</p>

<p>핵심 개념 한 줄 요약<br />
MCP의 tool 메타데이터(name, description, input_schema)를 Agents SDK의 FunctionTool(name, description, params_json_schema, on_invoke_tool)에 그대로 매핑하고, on_invoke_tool에서 해당 MCP 세션으로 call_tool만 라우팅한다. FunctionTool/<code class="language-plaintext highlighter-rouge">@function_tool</code> 사용법과 JSON 스키마 포맷은 Agents 문서 그대로다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a> 또한 모델은 LiteLLMModel로 너의 베이스 URL을 모델처럼 쓸 수 있다. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson</p>

<p>mcp_as_function_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># 네임스페이스(툴 이름 prefix에 들어감)
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cdfg</span><span class="p">.</span><span class="n">name</span> <span class="nf">if </span><span class="p">(</span><span class="n">cdfg</span> <span class="p">:</span><span class="o">=</span> <span class="n">cfg</span><span class="p">)</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    MCP tool -&gt; Agents FunctionTool
    tool_meta: has .name, .description, .input_schema (JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Agents SDK가 args_json을 JSON 문자열로 넘겨준다 → dict로 파싱 후 MCP 호출
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 모델이 형식 어기면 raw로 전달(서버 쪽 검증에 맡김)
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="c1"># MCP 표준 content를 텍스트/JSON 위주로 정규화
</span>        <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="c1"># 에이전트에게는 문자열을 반환하므로 JSON 문자열로 묶어준다
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="c1"># FunctionTool은 name/description/params_json_schema/on_invoke_tool만 주면 된다.
</span>    <span class="c1"># 공식 문서의 "Custom function tools" 섹션과 동일한 생성자. :contentReference[oaicite:2]{index=2}
</span>    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) 여러 MCP 서버를 선언
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>        <span class="c1"># MCPServerCfg(name="db", kind="stdio", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">]</span>

    <span class="c1"># 2) MCP의 모든 툴을 FunctionTool로 등록
</span>    <span class="n">mcp_function_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>

    <span class="c1"># 3) 커스텀 LLM(너의 엔드포인트)을 LiteLLM 모델로 사용
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># 네 엔드포인트를 OpenAI 호환으로 노출했다는 가정
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) 에이전트 구성: “function_tool로 등록된 MCP 툴”만 전달
</span>    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP-through-FunctionTools</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_function_tools</span><span class="p">,</span>  <span class="c1"># 포인트: 오직 function_tool만
</span>    <span class="p">)</span>

    <span class="c1"># 5) 실행
</span>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data 폴더에서 sales.csv를 읽고 합계 계산해줘. 필요하면 스스로 적절한 MCP 툴을 골라 써.</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>어떻게 돌아가나<br />
1단계. 여러 MCP 서버에 연결하고 list_tools로 메타를 긁는다.<br />
2단계. 각 MCP 툴을 FunctionTool로 감싼다. name은 server:tool로 네임스페이스, description과 JSON 스키마는 MCP의 description/input_schema를 그대로 쓴다. 이 매핑은 Agents 문서의 Function tools/Custom function tools 규약에 맞다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a><br />
3단계. on_invoke_tool에서 session.call_tool만 호출해 결과를 문자열(JSON)로 반환한다.<br />
4단계. Agent는 “function_tool로 등록된 툴”만 보므로, 네가 원한 단순한 툴 등록 모델 그대로다. 모델은 LiteLLM을 통해 임의 베이스 URL의 LLM을 쓸 수 있다. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>실전 팁<br />
툴 과적재를 피하려면 tools=mcp_function_tools 대신, 프롬프트를 보고 필요한 서버만 필터링해서 전달해라(예: 파일/CSV가 있으면 files:*만). Function tools는 설명과 인자 스키마를 자동 소비하니, MCP 쪽 스키마를 빡빡하게 유지하면 arguments 오류가 줄어든다. FunctionTool로 직접 생성하면 데코레이터 없이도 이름·설명·스키마를 원하는 대로 넣을 수 있다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a></p>

<p>확장 아이디어<br />
고위험 툴에 dry_run, confirm 같은 필드를 MCP input_schema에 추가하면, 그대로 FunctionTool 인자 스키마에 반영되어 실행 전에 모델이 스스로 안전 절차를 따른다.<br />
툴 결과가 크면 on_invoke_tool에서 요약만 반환하고, 원본은 파일 핸들이나 URL로 제공하도록 MCP 서버를 설계해 토큰 사용량을 줄인다.</p>

<p>원하면 네 파일/DB MCP 서버의 실제 tool 이름과 input_schema를 알려줘. 위 스크립트가 해당 스키마를 그대로 FunctionTool로 옮겨주기 때문에 추가 코드는 사실상 없다.</p>

<p class="chat--user">

응 내가 원하는거랑 가까워진듯. 질문이 더 있어. 질문 1. MCP 말고 일반 Function 툴과 섞인 버젼 추가해줘. 질문 2. 일반 chat completions (with tools) 예제도 바로 아래에 추가해줘. 질문 3. MCP Client Session은 저절로 종료되나? 질문 4. 여러 Agent가 있으면 MCP 종류별로 세션을 여러개 열게될수도 있을거 같은데 하나로 유지하는건 어때? 문제가 있으려나

</p>

<p>좋아. 네 질문 4개를 순서대로, 바로 쓸 수 있는 코드와 함께 정리한다. 인용구문은 쓰지 않는다.</p>

<h1 id="1-mcp-툴--일반-function-툴을-섞어-등록하는-버전">1) MCP 툴 + 일반 Function 툴을 섞어 등록하는 버전</h1>

<p>아래는 앞서 만든 “MCP → FunctionTool 래핑”에 더해, 일반 파이썬 함수도 FunctionTool로 함께 등록하는 예시다. 에이전트는 두 종류를 한꺼번에 본다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># ========== MCP 연결 ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">args_json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_function_tools</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># ========== 일반 파이썬 함수 → FunctionTool ==========
</span>
<span class="k">def</span> <span class="nf">make_local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">math_eval</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 툴
</span>    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_mcp_function_tools</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="db", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">])</span>

    <span class="c1"># 2) 일반 Function 툴
</span>    <span class="n">local_tools</span> <span class="o">=</span> <span class="nf">make_local_tools</span><span class="p">()</span>

    <span class="c1"># 3) 모델 (네 커스텀 LLM OpenAI-호환 엔드포인트)
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MixedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_tools</span> <span class="o">+</span> <span class="n">local_tools</span><span class="p">,</span>  <span class="c1"># 섞어서 등록
</span>    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data 폴더의 sales.csv를 읽어 합계를 구하고, local.math_eval로 숫자 검증까지 해줘</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h1 id="2-일반-chat-completions-with-tools-예제">2) 일반 Chat Completions (with tools) 예제</h1>

<p>OpenAI 호환 Chat Completions API를 직접 쓰는 순수 예시다. tools에 함수 스키마를 주고, tool_calls를 받아서 너의 실행기로 라우팅한다. 여기서는 로컬 계산기 하나만 보여주지만, 위의 MCP tools 리스트를 그대로 합쳐 넣으면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>  <span class="c1"># 네 OpenAI 호환 엔드포인트
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산 계산기</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># 여기에 MCP에서 긁어온 tools도 그대로 append 가능
</span><span class="p">]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">3*(2+5) 값을 계산해줘</span><span class="sh">"</span><span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># 1차 요청
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
<span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="c1"># tool_calls 처리
</span><span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="c1"># 2차 요청(도구 결과 반영)
</span>    <span class="n">resp2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp2</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">resp2</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
</code></pre></div></div>

<p>포인트<br />
tools에 MCP에서 긁은 스키마를 그대로 추가하면, 일반 chat completions 루프에서도 MCP와 로컬 툴을 함께 쓸 수 있다. 단, MCP 호출부는 너의 라우터가 처리해 tool 역할 메시지를 만들어 넣으면 된다.</p>

<h1 id="3-mcp-clientsession은-저절로-종료되나">3) MCP ClientSession은 저절로 종료되나?</h1>

<p>자동 종료를 기대하면 안 된다. 표준 패턴은 세 가지다.</p>

<ol>
  <li>
    <p>세션을 감싼 트랜스포트(StdIO/SSE)에 대해 stop/close를 명시적으로 호출한다.</p>
  </li>
  <li>
    <p>async with 컨텍스트를 제공하는 래퍼를 만들어 with 블록이 끝날 때 정리한다.</p>
  </li>
  <li>
    <p>프로세스 종료 훅에서 전역 세션들을 순서대로 정리한다.</p>
  </li>
</ol>

<p>간단 정리 함수 예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 세션과 트랜스포트를 함께 추적해야 안전
</span><span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<p>세션을 열 때 MCPHandle을 만들어 리스트에 넣고, 애플리케이션 종료 시 모든 handle.close()를 await 하면 된다.</p>

<h1 id="4-여러-agent가-세션을-공유해도-될까-하나로-유지하는-전략과-주의점">4) 여러 Agent가 세션을 공유해도 될까? 하나로 유지하는 전략과 주의점</h1>

<p>결론부터 말하면, 공유 풀을 두고 재사용하는 게 일반적으로 좋다. 다만 몇 가지 주의점이 있다.</p>

<p>장점<br />
메모리·프로세스 수 절감. stdio 서버는 프로세스를 하나만 띄우면 된다.<br />
콜드 스타트 지연 감소. list_tools 캐시와 연결 수립 시간이 절약된다.</p>

<p>주의점<br />
동시성. 하나의 MCP 세션이 다중 호출을 처리할 때, 서버/클라이언트가 동시 호출을 안전하게 처리하는지 확인해야 한다. 대부분의 MCP 서버 구현은 괜찮지만, 특정 서버가 순차 처리만 안전하게 지원한다면 큐잉이나 세마포어가 필요하다.<br />
격리. 사용자·권한이 다른 Agent가 같은 세션을 쓰면 권한 경계가 흐려질 수 있다. 서버 인스턴스를 권한 단위로 분리하는 게 안전하다.<br />
생명주기. 누가 언제 닫을지 합의가 필요하다. 레퍼런스 카운팅 또는 명시적 init/close API가 필요하다.<br />
버전·옵션 차이. 같은 서버라도 플래그(예: dry_run 기본값)가 다른 Agent마다 다를 수 있다. 이땐 세션을 공유하지 말고 별도 인스턴스를 띄워라.</p>

<p>간단한 세션 풀 스캐폴딩(RefCount + AsyncLock):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPSessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,...]],</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># key 예시: ("stdio", ("npx","-y","@modelcontextprotocol/server-filesystem","./data"))
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acquire_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientSession</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">:</span>
                <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
            <span class="c1"># 새로 생성
</span>            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">transport</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">release_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>사용 패턴<br />
Agent가 시작할 때 acquire_stdio로 세션을 받아 쓰고, 끝날 때 release_stdio로 반납한다. 동일한 command/args 조합은 한 세션을 공유한다. 권한 격리가 필요한 경우 key에 추가 식별자(tenant, role 등)를 포함시키면 된다. 동시성 밀도가 높다면 각 MCP 서버 특성에 맞춰 per-server 세마포어를 더해주는 게 안전하다.</p>

<p>마무리 팁<br />
섞인 환경(일반 함수 + MCP)에서는 툴 수가 늘어 혼란이 생기기 쉬우니, 에이전트에 등록할 때 도메인별 프리픽스(server:tool, local.*)와 짧고 명확한 설명, 엄격한 JSON 스키마(required/enum/format)를 유지하자. 필요하면 한 턴에 노출할 툴을 필터링해 과적재를 줄이는 것도 효과적이다.</p>

<p class="chat--user">

1번과 2번을 합쳐서 써야지. 두 개 툴 구현이 너무 다르잖아. 툴 구현을 한 번만 하고 두 군데 모두에서 쓰고 싶은거야.

</p>

<p>좋아, “툴 구현은 한 번만” 하고, 그걸 두 방식 모두에서 재사용하도록 합치자. 아래 스캐폴딩은 단일 ToolRegistry에 툴을 등록하고, 같은 구현을 1) OpenAI Agents SDK(FunctionTool) 경로, 2) 일반 Chat Completions(with tools) 경로 양쪽에서 그대로 씁니다. MCP 툴도 동일한 추상화로 래핑합니다.</p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>unified_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1">###############################################################################
# 공통 추상화: 한 번 구현한 툴을 어디서든 재사용
###############################################################################
</span>
<span class="c1"># Tool 핸들러 시그니처: args(dict) -&gt; dict/str (awaitable)
</span><span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># 실제 실행 로직(동일 구현을 양쪽에서 재사용)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool name: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">list_for_chat_completions</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># OpenAI tools 포맷으로 직렬화
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# 로컬(일반) 툴 구현 예시: 한 번만 구현
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">LOCAL_MATH_TOOL</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기. 입력 {expr: string}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="n">handler</span><span class="o">=</span><span class="n">math_eval_handler</span>
<span class="p">)</span>

<span class="c1">###############################################################################
# MCP 툴을 동일 추상화로 래핑: 세션별로 ToolSpec을 생성
###############################################################################
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># 네임스페이스 prefix
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈 필요</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mcp_toolspecs_from_session</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="c1"># 동기 함수로 명세만 만들고, handler는 session을 캡처하여 비동기로 호출
</span>    <span class="c1"># list_tools 는 async라 밖에서 호출해 metadata를 넘겨줘야 한다.
</span>    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">call build_mcp_tools(...) instead</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">MCPHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">handle</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">):</span>
            <span class="c1"># _tool를 default 인자로 바인딩해 late-binding 이슈 방지
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">packed</span>

        <span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">specs</span>

<span class="c1">###############################################################################
# 1) OpenAI Agents SDK 경로: FunctionTool로 래핑하되, handler는 동일 구현 사용
###############################################################################
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_function_tool</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># 에이전트는 문자열 반환이 표준이므로 JSON 문자열로 직렬화
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_function_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">()]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">user_text</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1">###############################################################################
# 2) 일반 Chat Completions 경로: tools JSON + 동일 handler로 tool_calls 라우팅
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_for_chat_completions</span><span class="p">()</span>

        <span class="c1"># 1차 호출
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 도구 호출 처리 루프(필요 시 반복)
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw_args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">}</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# 실행 예시: 한 번 구현 → 두 경로에서 사용
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) 레지스트리 생성 및 로컬 툴 등록(한 번만)
</span>    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">LOCAL_MATH_TOOL</span><span class="p">)</span>

    <span class="c1"># 1) MCP 세션 연결 후, MCP 툴들을 동일 추상화로 등록
</span>    <span class="n">files_cfg</span> <span class="o">=</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">files_handle</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">files_cfg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="k">await</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">files_handle</span><span class="p">):</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># A) Agents SDK 경로
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Agents SDK 경로 ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더의 sales.csv를 읽고 합계를 계산한 뒤 local.math_eval로 2배를 계산해줘</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># B) 일반 Chat Completions 경로
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Chat Completions 경로 ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">files 서버 툴로 sales.csv 합계를 구하고 local.math_eval로 100+23도 계산해줘</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">files_handle</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트 정리<br />
툴은 ToolSpec(handler 포함)으로 한 번만 구현한다. MCP도 build_mcp_tools가 동일한 ToolSpec을 만들고, 로컬 툴도 같은 형태다.<br />
OpenAI Agents SDK는 FunctionTool로 얇게 래핑만 한다. on_invoke는 같은 handler를 호출한다.<br />
Chat Completions(with tools)도 registry의 tools JSON을 그대로 사용하고, tool_calls를 같은 handler로 라우팅한다.<br />
MCP 세션은 MCPHandle.close로 명시 종료한다. 여러 Agent나 여러 러너가 있을 때 공유하고 싶다면 핸들 풀을 두고 레퍼런스 카운팅만 얹으면 된다.</p>

<p>이제 “툴 구현은 한 번만” 쓰고, Agents와 Chat Completions 어디서든 동일하게 돌아간다. 필요한 경우 expose(툴 소출) 정책이나 권한 게이트를 registry 레벨에서 필터링 훅으로 추가하면 된다.</p>

<p class="chat--user">

흠 차라리 MCP에 대한 정보를 따로 받고 에이전트에게 알아서 처리하는게 나을까? 이러너 레이어를 내가 직접 만드는것보다?

</p>

<p>짚고 가자. “MCP 정보를 에이전트에게 그대로 넘겨서 알아서 쓰게 할지” vs “네가 러너 레이어(오케스트레이터)를 직접 만들어 통제할지”는 트레이드오프다. 한쪽이 항상 더 낫지는 않다. 아래를 기준으로 선택하면 된다.</p>

<p>선택 기준 요약<br />
에이전트가 MCP를 직접 다루게 한다<br />
장점: 설정이 단순하고 빠르다. SDK가 세션 관리, 툴 호출, 반환 형식 등을 알아서 처리한다. 호스티드/원격 MCP는 코드 없이 붙이기 쉽다. <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io+1</a><br />
단점: 턴별 툴 소출(Selective exposure), 고급 승인 흐름, 로깅 표준화, 네임스페이스 규칙, 재시도·서킷브레이커 같은 “플랫폼 공통 정책”을 세밀하게 넣기 어렵다. 모델이 많은 툴을 동시에 보게 되면 호출 혼선이 늘어난다. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI Platform+1</a></p>

<p>직접 러너(오케스트레이터)를 둔다<br />
장점: 툴 노출·권한·에러 처리·관측성을 전부 네가 표준화할 수 있다. 여러 채팅 백엔드(Agents, 일반 Chat Completions, 사내 엔진)를 같은 규약으로 꿰매 쓸 수 있다.<br />
단점: 네가 세션 풀, 라우팅, 재시도, 포맷 강제(JSON만 출력 등)를 구현·유지해야 한다.</p>

<p>권장 결론<br />
운영 기준이 빡빡하다면(권한 분리, 승인, 로그, 복구 전략, 비용/지연 관리), 지금까지 만든 얇은 러너를 유지하되 백엔드는 갈아끼우는 방식이 적합하다. 반대로 빠른 초기 통합·PoC, 공개 원격 MCP만 쓰는 경우에는 에이전트가 MCP를 직접 다루게 하는 구성이 가볍다. 둘을 섞는 하이브리드도 가능하다. 즉, 저위험·읽기 전용 MCP는 에이전트가 직접, 고위험 MCP는 러너를 통해서만 노출.</p>

<p>둘 중 하나를 고른 뒤 바로 쓸 수 있게, 실제 사용 스니펫을 2개 붙인다.</p>

<p>에이전트가 MCP를 직접 다루는 최소 예시<br />
여기서는 OpenAI Agents Python SDK에 여러 MCP 서버를 그대로 넘긴다. 모델은 OpenAI 호환 REST로 노출된 커스텀 엔드포인트를 쓴다(LiteLLM 래퍼).<br />
주의: 에이전트에 툴을 모두 노출하면 혼선이 생길 수 있으니, 필요하면 툴 필터·승인 옵션을 병행하라.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>  <span class="c1"># SDK 내장 MCP 커넥터
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://your-mcp.example/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">your-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">AgentManagedMCP</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요한 MCP 툴만 선택해서 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>  <span class="c1"># 포인트: MCP 정보를 그대로 넘김
</span>        <span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더에서 sales.csv 총합을 구하고, 검색 서버로 관련 리포트를 찾아 요약해줘</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>일반 Chat Completions(with tools)에 바로 붙이는 최소 예시<br />
여기서는 MCP 정보를 직접 넘기지 않고, MCP가 노출한 툴들을 OpenAI “tools” 포맷으로 변환해서 모델에게 보여준다. 모델의 tool_calls를 받으면 네가 call_tool을 실행한다. 이 경로는 러너가 얇게나마 필요하지만, 너가 이미 가진 통일 인터페이스(단일 ToolRegistry + handler 재사용)를 유지하기 좋다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="n">BASE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>
<span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">your-model</span><span class="sh">"</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">list_mcp_tools_as_openai_tools</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]))</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">);</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">files:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">session</span><span class="p">,</span> <span class="n">tools</span>  <span class="c1"># session은 뒤에서 call_tool에 사용
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">session</span><span class="p">,</span> <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">list_mcp_tools_as_openai_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">필요한 툴만 호출한다.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">files 서버 툴로 sales.csv 합계를 구해줘</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># 1차 요청
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>            <span class="c1"># e.g., files:read
</span>            <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># MCP 실행
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="c1"># 표준화하여 툴 메시지로 재주입
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,{})</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">]})</span>
            <span class="p">})</span>

        <span class="c1"># 2차 요청
</span>        <span class="n">data2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="n">_transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>언제 “에이전트에게 맡기기”가 유리한가<br />
MCP 서버가 전부 원격·공개이고, 권한 경계가 단순하며, 툴 수가 많지 않고, 빠르게 결과를 내야 할 때. SDK가 세션·호출을 대신 관리하므로 개발 비용이 낮다. OpenAI Agents SDK의 MCP 가이드는 이 경로를 기본으로 상정한다. <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io</a></p>

<p>언제 “직접 오케스트레이션”이 유리한가<br />
툴이 많고 성격이 다양해서 턴별 소출이 필요할 때, 실패·재시도·백오프 같은 SRE 룰을 도입해야 할 때, 감사 로그와 승인 플로우가 필요한 조직 환경일 때. 이때는 네가 만든 ToolRegistry/handler 단일화 구조가 유지보수에 유리하다. 모델/플랫폼을 바꿀 때도 백엔드만 교체하면 된다. OpenAI 표준 함수콜 루프는 문서의 권장 패턴이며, 이 위에 정책을 얹기 쉽다. <a href="https://platform.openai.com/docs/guides/function-calling?api-mode=chat&amp;utm_source=chatgpt.com">OpenAI Platform+1</a></p>

<p>하이브리드 팁<br />
저위험·읽기 전용 MCP는 에이전트 직결로 빨리 붙이고, 고위험(쓰기/삭제/결제/배포) MCP는 러너 경유 툴로만 노출한다. 에이전트 쪽에는 해당 툴을 숨겨 두고, 러너가 승인된 요청만 대리 호출한다. 이 구성이 현업에서 가장 에러율·사고율이 낮고, 초기 속도도 빠르다.</p>

<p>마지막 체크리스트<br />
툴 과적재를 피하려면 툴 노출 수를 턴당 8~12개 수준에서 시작하자.<br />
namespacing은 server:tool 패턴을 고정해 충돌을 막자.<br />
input_schema를 엄격하게(required, enum, format) 잡아 잘못된 arguments를 줄이자.<br />
MCP 세션은 자동 종료가 아니므로 종료 훅을 두거나 컨텍스트 매니저를 사용하자.<br />
세션 공유는 가능하지만 권한·동시성·생명주기 규칙을 먼저 정해둬야 한다.</p>

<p>원한다면 지금 네 실제 MCP 서버 목록과 위험도(읽기/쓰기), 그리고 사용 중인 모델 엔드포인트를 알려줘. 위 스니펫을 네 환경에 맞게 바로 돌아가도록 깔끔하게 커스터마이즈해주겠다.</p>

<p class="chat--user">

MCP가 3개 이상들어왔을 때 처리에 대해 알려줘. 그리고 OpenAI Agent 말고 다른 Agent도 있어. 1. MCP에 관한 정보를 통일되게 다룰 수 있는 클래스가 필요해. 2. 1에서 만든 정보를 각각의 Agent에 맞게 Adapt를 해줄 수 있는 얇은 클래스나 함수가 필요할 것 같아.

</p>

<p>좋아. “MCP 서버가 3개 이상”일 때 흔들리지 않게 돌리는 구조를 딱 두 층으로 깔끔하게 나눠줄게.</p>

<ol>
  <li>
    <p>MCP 정보를 “완전히 통일된 포맷”으로 다루는 허브 클래스</p>
  </li>
  <li>
    <p>그 통일 포맷을 각 에이전트별로 얇게 변환하는 어댑터들</p>
  </li>
</ol>

<p>한 번의 구현으로 OpenAI Agents, 일반 Chat Completions(with tools), 그리고 다른 프레임워크(원하면 LangChain/Autogen 등)까지 같은 툴 구현을 재사용할 수 있다. 아래 스캐폴딩은 그대로 복붙해서 시작해도 된다.</p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>mcp_unified_adapters.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">uuid</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>

<span class="c1"># =========================
# 0) 통일된 툴 스펙/레지스트리
# =========================
</span>
<span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">UnifiedToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># 예: "files:read_csv" or "local.math_eval"
</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># 모든 백엔드에서 재사용되는 실제 실행 로직
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">UnifiedToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">UnifiedToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UnifiedToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

<span class="c1"># =========================
# 1) MCP 허브(3개+ 서버 안정 운용)
# =========================
</span>
<span class="c1"># a) 설정과 핸들
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># 네임스페이스
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># 선택: 동시성 제한 등
</span>    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sema</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># b) MCP 허브: 3개 이상 서버를 연결·통일 스펙으로 변환·실행 라우팅
</span><span class="k">class</span> <span class="nc">MCPHub</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MCPHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">)</span>

        <span class="c1"># list_tools를 모두 긁어 통일 스펙으로 등록(네임스페이스: server:tool)
</span>        <span class="k">for</span> <span class="n">server</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="c1"># 동시성 보호 + 타임아웃
</span>                    <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">sema</span><span class="p">:</span>
                        <span class="n">coro</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">packed</span>

                <span class="n">self</span><span class="p">.</span><span class="n">_registry</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">UnifiedToolSpec</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
                <span class="p">))</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">registry</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_ready</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPHub.start() 호출 전입니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_registry</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># =========================
# 2) 공통 로컬 툴(선택)
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedToolSpec</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">UnifiedToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">math_eval</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># =========================
# 3) 어댑터 레이어(얇게)
# =========================
</span>
<span class="c1"># 3-a) OpenAI Agents Python SDK(FunctionTool) 어댑터
</span><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_agents_function_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">UnifiedToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="nf">wrap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">()]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">model_impl</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출하고, 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_impl</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="nf">to_agents_function_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1"># 3-b) OpenAI 호환 Chat Completions(with tools) 어댑터
</span><span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_tools_json</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
        <span class="p">}}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_json</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw</span><span class="p">}</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>

<span class="c1"># 3-c) 다른 에이전트(예: LangChain Tool)로의 얇은 어댑터(옵션)
# 필요하면 이런 형태로 추가:
</span><span class="k">def</span> <span class="nf">to_langchain_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">langchain.tools</span> <span class="kn">import</span> <span class="n">StructuredTool</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">t</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">StructuredTool</span><span class="p">.</span><span class="nf">from_function</span><span class="p">(</span>
            <span class="n">coroutine</span><span class="o">=</span><span class="n">_run</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">__</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 프레임워크 명명 규칙 맞추기
</span>            <span class="n">description</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">description</span>
            <span class="c1"># schema는 프레임워크별로 별도 지정 가능
</span>        <span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># =========================
# 4) 3개+ MCP 서버 포함 실행 예시
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># a) MCP 서버 3개 이상 선언
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># 공개/원격이면 SSE 가능(모듈 설치 필요)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="nc">MCPHub</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">hub</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">hub</span><span class="p">.</span><span class="nf">registry</span><span class="p">()</span>

        <span class="c1"># 로컬(일반) 툴도 같은 레지스트리에 추가
</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">local_tools</span><span class="p">():</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># 노출 과적재 방지 팁(선택): 필요할 때만 서브셋을 뽑아 다른 레지스트리에 복사해도 됨
</span>        <span class="c1"># 여기서는 전체를 그대로 사용
</span>
        <span class="c1"># A) OpenAI Agents 경로
</span>        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span>
            <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># OpenAI 호환 엔드포인트
</span>            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="sh">"</span><span class="s">files 서버로 sales.csv 합계를 구하고, local.math_eval로 100+23 계산도 해줘</span><span class="sh">"</span>
        <span class="p">)</span>

        <span class="c1"># B) Chat Completions 경로
</span>        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">system</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="sh">"</span><span class="s">db 서버 요약 툴로 고객별 구매 합계를 요약하고, 수치 검증은 local.math_eval로 2*(50+5) 계산해줘</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">hub</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 설계 포인트 정리<br />
MCP가 3개 이상이어도 MCPHub가 모든 세션을 들고 있고, list_tools를 네임스페이스(server:tool)로 묶어 하나의 ToolRegistry에 올린다. 실행도 같은 handler를 통해 라우팅되므로 구현이 한 번뿐이다.<br />
어댑터 레이어는 얇다. Agents(FunctionTool 리스트 생성), Chat Completions(tools JSON 생성), LangChain 등 아무 프레임워크나 20~30줄 내로 붙는다.<br />
동시성·타임아웃을 MCPHandle에 통합했다. 서버마다 max_concurrency와 timeout을 다르게 줄 수 있다.<br />
세션 종료는 MCPHub.close에서 일괄 처리한다. 자동 종료에 기대지 않는다.</p>

<p>3개 이상 서버일 때 실전 운영 팁<br />
툴 소출: 턴별로 필요한 서브셋만 노출하면 툴 선택 오류가 급감한다. 간단한 키워드 룰부터 시작해도 효과가 크다.<br />
네임스페이스: server:tool을 고정하고, description에도 서버명을 반복 표기하면 혼동이 줄어든다.<br />
스키마 엄격화: required, enum, format을 가능한 한 많이 넣자. arguments 파싱 오류가 줄어든다.<br />
관측성: handler에서 입력/출력/지연을 JSONL로 로깅하면 후속 최적화가 쉬워진다.<br />
고위험 툴: parameters에 dry_run(boolean, default true)와 confirm 문자열을 추가해 모델이 자체로 안전 절차를 밟게 하자.</p>

<p>이 스캐폴딩이면 MCP 정보를 한 번만 수집·정규화하고, 어떤 에이전트든 어댑터만 갈아끼워 재사용할 수 있다. 필요하면 expose(툴 소출) 전략 함수와 세션 풀(여러 프로세스/서비스 간 공유)을 덧대서 팀 표준 플랫폼으로 굳히면 된다.</p>

<p class="chat--user">

아니 mcp 서버는 그대로 넘길거야 툴로 내가 래핑 안할거야

</p>

<p>좋아. “MCP 서버는 그대로 넘긴다(툴로 래핑 안 함)”를 전제로, 여러 개(3개 이상) MCP를 한꺼번에 다루는 통일 정보 클래스와 각 에이전트별 얇은 어댑터를 만들어줄게. 핵심은 툴 레벨 래핑이 아니라, MCP 서버 메타(연결 방식·자격증명·네임라벨)를 그대로 전달하는 것이다.</p>

<p>아래 스캐폴딩은 세 파트다.</p>

<ol>
  <li>
    <p>UnifiedMCPConfig: MCP 서버 정보를 통일된 포맷으로 보관·검증.</p>
  </li>
  <li>
    <p>Adapters: 이 정보를 각 에이전트 SDK에 맞게 그대로 투사.<br />
2-1) OpenAI Agents Python SDK용 어댑터<br />
2-2) Anthropic Messages API(MCP connector)용 어댑터<br />
2-3) MCP 미지원 프레임워크용 “프로토콜 유지” 대안: 합성 프록시 서버(선택). 툴로 감싸지 않고, 하나의 MCP 서버로 프록시 제공.</p>
  </li>
</ol>

<p>추가로 3개 이상 서버일 때의 수명주기, 동시성, 공유 전략까지 포함했다.</p>

<p>설치<br />
pip install mcp pydantic orjson "openai-agents[litellm]" requests</p>

<p>unified_mcp_pass_through.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">HttpUrl</span><span class="p">,</span> <span class="n">field_validator</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># 1) 통일 포맷: MCP 서버 정보를 “그대로” 담아 에이전트로 전달하기 위한 모델
</span>
<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># 필요시 확장
</span>
<span class="k">class</span> <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">에이전트에서 보일 서버 라벨(네임스페이스)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># 공통 옵션
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span>
    <span class="n">cache_tools_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">non_empty</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">name must be non-empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="k">class</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedMCPServer</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">dup</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate server names: </span><span class="si">{</span><span class="n">dup</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">no MCP servers provided</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># 최소 가드: stdio면 command 필수, sse면 url 필수
</span>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2) 어댑터들
# 2-1) OpenAI Agents Python SDK 어댑터: 그대로 mcp_servers에 꽂는 팩토리
</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span><span class="p">,</span> <span class="n">MCPServerStreamableHttp</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>

<span class="k">class</span> <span class="nc">OpenAIAgentsMCPAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">build_context_managers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">cms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerStdio</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">env</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerSse</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                    <span class="n">require_approval</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">require_approval</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerStreamableHttp</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                    <span class="n">require_approval</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">require_approval</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cms</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">cms</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">build_context_managers</span><span class="p">()</span>
        <span class="c1"># 여러 context manager를 한 번에 열기
</span>        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncExitStackGroup</span><span class="p">(</span><span class="n">cms</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">PassThroughMCPAgent</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP 서버의 툴을 안전하게 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">mcp_servers</span><span class="o">=</span><span class="n">opened</span><span class="p">,</span>                             <span class="c1"># 포인트: 서버를 '그대로' 넘김
</span>                <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span>

<span class="c1"># 여러 async context manager를 묶어 여닫는 유틸
</span><span class="k">class</span> <span class="nc">AsyncExitStackGroup</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cms</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cms</span> <span class="o">=</span> <span class="n">cms</span>
        <span class="n">self</span><span class="p">.</span><span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">opened</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="c1"># 역순으로 안전 종료
</span>        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="nf">reversed</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c1"># 2-2) Anthropic Messages API(MCP connector) 어댑터: payload만 만들어 반환
# 주의: 여기서는 실제 호출까지 하지 않고, mcp_servers JSON을 만들어 돌려준다.
# 너는 이 JSON을 바로 API 바디에 넣으면 된다.
</span>
<span class="k">class</span> <span class="nc">AnthropicMCPAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">to_messages_payload</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">mcp_servers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="c1"># Anthropic 커넥터는 원격만 직접 붙이는 패턴이 일반적이므로, stdio는 보통 불가.
</span>                <span class="c1"># 필요하면 너의 서버를 HTTP로 노출해야 한다.
</span>                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: Anthropic payload는 stdio를 직접 전달할 수 없다. HTTP/SSE로 전환 필요</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mcp_servers</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">authorization_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">tool_configuration</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">enabled</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_text</span><span class="p">}],</span>
            <span class="sh">"</span><span class="s">mcp_servers</span><span class="sh">"</span><span class="p">:</span> <span class="n">mcp_servers</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c1"># 2-3) MCP 미지원 프레임워크를 위한 “프로토콜 유지” 대안: 합성 프록시(선택)
# 툴 래핑 없이, 여러 상류 MCP를 하나의 '가짜 MCP 서버'로 노출.
# 에이전트는 MCP 한 대만 본다. 내부에서 list_tools/ call_tool를 서버별로 프록시.
# 간단 버전(개념 코드): 실제 MCP 서버 스펙에 맞춘 완성 서버는 별도 구현 필요.
</span>
<span class="k">class</span> <span class="nc">CompositeMCPProxy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    아이디어: upstream 여러 MCP 세션에 붙어, 외부에는 단일 MCP 서버처럼 동작.
    - list_tools: 모든 upstream에서 툴을 긁어 namespaced 이름(server:tool)으로 합쳐 반환
    - call_tool: </span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">을 파싱해 해당 upstream에 위임
    이 클래스 자체는 프로토콜 처리(transport)는 생략하고, 콜백 형태만 제공.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># upstream 연결만 담당(프록시 서버로 공개하려면 별도 transport/서버 구현 필요)
</span>        <span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
        <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
            <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 필요</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 필요하면 streamable-http 등 추가
</span>                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unsupported kind for proxy: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">tr</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">sess</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_all_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">server</span><span class="p">][</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">packed</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

<span class="c1"># 3) 사용 예시
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">demo_openai_agents</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">servers</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span>  <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}),</span>
    <span class="p">])</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="nc">OpenAIAgentsMCPAdapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">run_once</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="sh">"</span><span class="s">files와 db, search MCP를 적절히 사용해 sales.csv의 통찰을 요약해줘</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">demo_anthropic_payload</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">servers</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">git</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.git.example/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer Y</span><span class="sh">"</span><span class="p">}),</span>
    <span class="p">])</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="nc">AnthropicMCPAdapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">).</span><span class="nf">to_messages_payload</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">claude-3-7-sonnet</span><span class="sh">"</span><span class="p">,</span> <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">두 MCP를 활용해서 리포트를 만들어줘</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="n">OPT_INDENT_2</span><span class="p">).</span><span class="nf">decode</span><span class="p">())</span>

<span class="c1"># 메인
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">asyncio</span>
    <span class="kn">from</span> <span class="n">contextlib</span> <span class="kn">import</span> <span class="n">suppress</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">demo_openai_agents</span><span class="p">())</span>
    <span class="k">with</span> <span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
        <span class="nf">demo_anthropic_payload</span><span class="p">()</span>
</code></pre></div></div>

<p>어떻게 쓰면 되나 단계별 요약</p>

<ol>
  <li>
    <p>UnifiedMCPConfig에 3개 이상 MCP 서버를 그대로 나열한다. stdio면 command/args, sse면 url/headers만 채우면 된다.</p>
  </li>
  <li>
    <p>OpenAI Agents를 쓸 때는 OpenAIAgentsMCPAdapter로 context manager들을 만들어 Agent(mcp_servers=[…])에 꽂는다. 이 흐름은 MCP 툴을 “래핑하지 않고” 서버 정보를 그대로 전달한다.</p>
  </li>
  <li>
    <p>Anthropic Messages API를 쓸 때는 AnthropicMCPAdapter가 messages.create 바디에 넣을 mcp_servers JSON을 생성해준다. stdio는 원격 공개가 아니면 바로 붙일 수 없으니 SSE/HTTP로 노출해야 한다.</p>
  </li>
  <li>
    <p>MCP 미지원 프레임워크에는 CompositeMCPProxy 같은 방식으로 “MCP 프로토콜은 유지”한 채 합성 서버를 하나 띄우는 선택지가 있다. 이건 툴 래핑이 아니라 “MCP 서버를 하나 더 제공”하는 방식이라 네 조건과 어긋나지 않는다.</p>
  </li>
</ol>

<p>3개 이상 서버에서의 실무 체크<br />
툴 과적재 방지. Agent에 넘길 때 서버를 전부 주되, 모델 프롬프트에 “이런 작업에는 files만, 요약은 db만” 같은 지침을 한 줄 넣는 것만으로도 혼선이 줄어든다.<br />
세션/자원 관리. OpenAI Agents 어댑터는 context manager가 종료 시 자동 정리를 수행한다. Anthropic 경로는 원격 서버이므로 별도 세션 정리는 필요 없다.<br />
권한 경계. 서로 다른 테넌트나 위험도를 가진 MCP는 서버 라벨을 명확히 구분하고, require_approval 옵션을 “always/auto”로 둔다(Hosted/원격에서 의미 있음).<br />
동시성·타임아웃. 서버별 max_concurrency, request_timeout_sec를 다르게 주어 병목을 피한다.</p>

<p>이 구성은 “MCP 서버 정보를 있는 그대로 넘긴다”는 원칙을 지키면서, 서로 다른 에이전트들에 같은 정보를 재사용하도록 해준다. 필요한 프레임워크가 더 있으면 같은 패턴으로 어댑터를 20~30줄로 추가하면 된다.</p>

<p class="chat--user">

근데 MCP를 보니 그냥 툴만 있는게 아니라 Sampling, 사용자에게 물어보기, 프롬프트 등등 있잖아. 그걸 Chat이랑 연동할 수 있을까

</p>

<p>좋아, 핵심은 “MCP가 제공하는 건 툴만이 아니다”는 점을 전제로, Sampling(서버가 모델 호출을 위임), 사용자에게 물어보기(ask-user), 프롬프트/프롬프트 템플릿(list/get) 같은 채널을 Chat 루프에 붙이는 얇은 어댑터 레이어를 여기에 딱 만들어두는 거다. 래핑으로 툴로 바꾸지 않고, MCP 메타(프롬프트/샘플링/질의)를 그대로 전달·왕복시켜 결합한다.</p>

<p>아래 설계와 스캐폴딩은 이전에 만든 “백엔드 갈아끼우기(Chat Completions or OpenAI Agents)” 구조를 유지하면서, MCP의 네 가지 면을 모두 연동한다.</p>

<ol>
  <li>
    <p>툴: 기존과 동일, call_tool 라우팅</p>
  </li>
  <li>
    <p>프롬프트: list_prompts/get_prompt를 통해 시스템/도우미 메시지 주입</p>
  </li>
  <li>
    <p>사용자에게 물어보기: MCP가 사용자 입력을 요청하면, Chat UI에 질문을 띄우고 답을 다시 MCP에 돌려줌</p>
  </li>
  <li>
    <p>샘플링: MCP 서버가 “모델 호출을 대신 해달라”고 요청하면, 현재 백엔드로 대리 샘플링 후 결과를 MCP에게 반환</p>
  </li>
</ol>

<p>아래는 그대로 붙이는 최소 스캐폴딩이다. MCP SDK의 일부 API는 서버 구현/버전에 따라 차이가 있어서, 함수 존재 여부를 동적으로 체크하도록 방어코드를 넣었다.</p>

<p>설치<br />
pip install mcp pydantic orjson requests "openai-agents[litellm]"</p>

<p>mcp_chat_bridge.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">################################################################################
# 공통: Chat 백엔드(두 가지 구현: OpenAI 호환 Chat Completions, OpenAI Agents)
################################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">OpenAIChatBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">tools</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span><span class="p">;</span> <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

<span class="c1"># 선택: OpenAI Agents를 백엔드로 쓰고 싶다면 이 어댑터를 사용
</span><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">FunctionTool</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">))</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 도구는 Agent에 등록하지 않고, 프롬프트 강제 포맷으로 tool_calls를 JSON으로 받는 전략도 가능
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">가능하면 JSON만 출력</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">txt</span><span class="p">}}]}</span>

<span class="c1">################################################################################
# MCP 연결: 여러 서버를 그대로 붙이고, 프롬프트/샘플링/질문을 브릿지
################################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span> <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈 필요</span><span class="sh">"</span><span class="p">)</span>
        <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>

<span class="c1">################################################################################
# 브릿지: MCP의 툴/프롬프트/ask-user/샘플링을 Chat 루프에 접속
################################################################################
</span>
<span class="k">class</span> <span class="nc">MCPChatBridge</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span>
        <span class="n">chat_backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span>
        <span class="n">ask_user</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>     <span class="c1"># 사용자에게 질문 보여주고 응답 받는 콜백
</span>        <span class="n">prompt_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">sampling_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c1"># 샘플링 옵션 정규화
</span>    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">chat_backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ask_user</span> <span class="o">=</span> <span class="n">ask_user</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prompt_selector</span> <span class="o">=</span> <span class="n">prompt_selector</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sampling_policy</span> <span class="o">=</span> <span class="n">sampling_policy</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">opts</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)})</span>

        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MCPHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="k">return</span> <span class="n">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_list_all_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                    <span class="p">}</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_collect_prompts</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]:</span>
        <span class="c1"># 서버별 프롬프트 목록 취합. 세션에 list_prompts/get_prompt 가 없으면 건너뜀.
</span>        <span class="n">collected</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">list_prompts</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">list_prompts</span><span class="sh">"</span><span class="p">)()</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># 각 항목마다 get_prompt(name)로 템플릿/메시지 구성 요소를 가져올 수 있다는 가정(서버 구현마다 상이)
</span>                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">prompts</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)})</span>
                    <span class="n">collected</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">collected</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_get_prompt_messages</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">server</span><span class="p">]</span>
        <span class="n">msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_prompt</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_prompt</span><span class="sh">"</span><span class="p">)(</span><span class="n">prompt_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># resp가 messages 비슷한 구조라고 가정하고 표준화
</span>                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">))</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">msgs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_server_sampling</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        MCP 서버가 </span><span class="sh">'</span><span class="s">샘플링 요구</span><span class="sh">'</span><span class="s">를 보내는 상황을 가정.
        request = {</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">:[...], </span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="s">:{...}} 같은 형태를 정책에 맞춰 백엔드에 대리 호출
        </span><span class="sh">"""</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">sampling_policy</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="c1"># request["messages"]는 OpenAI 포맷을 가정하고 그대로 전달
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">([</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="o">**</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])],</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1"># 필요하면 온전한 응답을 그대로 돌려주거나, 텍스트만 추출
</span>        <span class="n">content</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 1) 서버별 프롬프트 목록을 모아서 선택
</span>        <span class="n">base_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">)]</span>
        <span class="n">prompt_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_prompts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prompt_selector</span><span class="p">:</span>
            <span class="c1"># prompt_selector는 {server:[{name,desc},...]}를 보고 초기 메시지(예: system 프롬프트들) 리스트를 반환
</span>            <span class="n">injected</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prompt_selector</span><span class="p">(</span><span class="n">prompt_catalog</span><span class="p">)</span>
            <span class="n">base_messages</span> <span class="o">=</span> <span class="n">injected</span> <span class="o">+</span> <span class="n">base_messages</span>

        <span class="c1"># 2) MCP 툴들을 OpenAI tools 포맷으로 그대로 넘김
</span>        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_list_all_tools</span><span class="p">()</span>

        <span class="c1"># 3) 1차 모델 호출
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">base_messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
        <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)))</span>

        <span class="c1"># 4) tool_calls 처리 루프 + ask-user + server-sampling 훅 예시
</span>        <span class="c1"># 실제 ask/sampling 이벤트는 서버가 별도 툴로 노출하거나, resource/protocol 필드를 통해 트리거할 수 있다.
</span>        <span class="c1"># 여기서는 관습적으로 이름을 잡아 예시를 보인다.
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">tool_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># e.g., "files:read_csv" or "db:sql_summary" or "search:ask_user" 등
</span>                <span class="n">args_raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

                <span class="c1"># 4-a) ask-user 패턴: 특정 서버가 사용자 입력을 받아달라고 하는 툴을 제공한다고 가정
</span>                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">:ask_user</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">ask.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">question</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">추가 정보가 필요합니다. 입력해 주세요.</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">user_answer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">answer</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_answer</span><span class="p">})</span>
                    <span class="p">})</span>
                    <span class="k">continue</span>

                <span class="c1"># 4-b) server-side sampling: 서버가 모델 호출을 위임하는 툴(예: server:sample)로 구현돼 있다고 가정
</span>                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">:sample</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">sample.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{}})</span>
                    <span class="n">sampling_out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_maybe_server_sampling</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">sampling_out</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="k">continue</span>

                <span class="c1"># 4-c) 일반 MCP 툴 호출
</span>                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">namespaced tool required</span><span class="sh">"</span><span class="p">})})</span>
                    <span class="k">continue</span>
                <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">unknown server</span><span class="sh">"</span><span class="p">})})</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                    <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[]}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()})</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})})</span>

            <span class="c1"># 4-d) 툴 결과 재주입
</span>            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">tool_results</span><span class="p">:</span>
                <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">tr</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]))</span>
                <span class="c1"># 일부 백엔드/모델은 tool 메시지에 name/tool_call_id를 요구하므로,
</span>                <span class="c1"># OpenAIChatBackend를 직접 사용할 때는 messages에 dict 그대로 넣는 경로를 따로 두어도 된다.
</span>
            <span class="c1"># 4-e) 다음 턴 호출
</span>            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">base_messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
            <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)))</span>

        <span class="c1"># 5) 최종 답변
</span>        <span class="k">return</span> <span class="n">base_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span>
</code></pre></div></div>

<p>어떻게 쓰는가 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">ui_ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[QUESTION from MCP] </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># 실제 앱/UI에서는 모달·입력창으로 구현
</span>    <span class="k">return</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">pick_prompts</span><span class="p">(</span><span class="n">prompt_catalog</span><span class="p">):</span>
    <span class="c1"># prompt_catalog: {server: [{name,description}, ...]}
</span>    <span class="c1"># 간단 예시: files 서버에 "analysis_default" 프롬프트가 있으면 불러와 system에 삽입
</span>    <span class="c1"># 실제로는 bridge._get_prompt_messages(server, prompt_name)로 메시지를 받아 prepend
</span>    <span class="k">return</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 조심스럽고 정확한 분석가다.</span><span class="sh">"</span><span class="p">)]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">]</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAIChatBackend</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPChatBridge</span><span class="p">(</span><span class="n">servers</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">ask_user</span><span class="o">=</span><span class="n">ui_ask_user</span><span class="p">,</span> <span class="n">prompt_selector</span><span class="o">=</span><span class="n">pick_prompts</span><span class="p">)</span> <span class="k">as</span> <span class="n">bridge</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bridge</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sh">"</span><span class="s">sales.csv를 분석하고, 필요한 추가 정보가 있으면 먼저 나에게 질문해줘</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ANSWER ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트 요약<br />
샘플링. 서버가 “모델 호출을 대리해달라” 요청하면, 현재 연결된 Chat 백엔드로 그대로 라우팅해 결과를 돌려준다. 이렇게 하면 서버-주도 플로우까지 연동된다.<br />
사용자에게 물어보기. MCP가 사용자 입력이 필요할 때를 툴 혹은 별도 시그널로 노출하는 패턴을 잡고, ask_user 콜백으로 Chat UI와 왕복한다. 러너를 두더라도 로직은 콜백 한 줄이다.<br />
프롬프트. 서버별 프롬프트 레지스트리를 조회(list/get)해서 초기 system 메시지로 주입한다. 프롬프트가 파라미터화되어 있다면 get_prompt(name, **kwargs) 식으로 받아 메시지로 변환한다.<br />
호환성. 같은 브릿지를 OpenAI Chat Completions, OpenAI Agents 어느 쪽에도 꽂을 수 있다. Agents를 백엔드로 쓸 땐 JSON 강제 출력 같은 프롬프트 전략을 써도 되고, 필요하면 Agents의 FunctionTool을 병행해서 ask-user나 sampling을 명시 툴로 노출하는 하이브리드도 가능하다.<br />
3개 이상 서버. 서버 수에 상관없이 namespacing(server:tool) 룰을 유지하고, 프롬프트·질문·샘플링은 서버 라벨과 함께 로깅해 추적 가능성을 높인다. 서버별 타임아웃/동시성은 handle 단에서 개별 튜닝하는 게 안전하다.</p>

<p>이렇게 하면 “툴로 래핑하지 않고”도 MCP의 넓은 표면적(툴·프롬프트·샘플링·유저질문)을 동일 Chat 경험에 자연스럽게 녹일 수 있다. 실제 네 서버에서 프롬프트/샘플링/ask가 어떤 엔드포인트/이벤트로 노출되는지 알려주면, 위 브릿지의 해당 함수만 너의 스펙에 딱 맞게 구체화해 줄 수 있다.</p>

<p class="chat--user">

아니 Elicitation이라고 따로 있는데

</p>

<p>맞아, MCP에는 “Elicitation(엘리시테이션)”이 따로 있다. 요지는 서버가 작업 도중 사용자에게 추가 정보를 표준 형식으로 요청할 수 있게 해주는 기능이고, 툴과는 별개의 채널이다. 결론부터 말하면 Chat 루프에 깔끔하게 연동할 수 있다. 아래처럼 “질문 라운드트립”을 브릿지에 끼우면 된다. 핵심 포인트와 최소 코드를 단계별로 정리한다.</p>

<ol>
  <li>
    <p>개념 정리<br />
Elicitation은 MCP 서버가 대화 도중 “사용자에게 이 정보 좀 받아줘”라고 요청하는 표준 메커니즘이다. 요청에는 프롬프트 문구와 함께 JSON 스키마가 따라오고, 클라이언트는 그 스키마에 맞게 사용자 입력을 받아 검증한 뒤 서버에 돌려준다. 2025-06-18 스펙에 정식 포함되었고, “툴 실행 중간에 끼어드는 질문”을 안전하고 구조화된 방식으로 다루려는 목적이다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p>아키텍처 선택지<br />
A. 프로토콜-네이티브 처리: MCP 클라이언트가 서버의 Elicitation 이벤트를 직접 수신해 UI로 띄우고 응답을 서버에 돌려준다. Chat 모델은 “최종 답변 생성”에 집중하고, 추가 정보 수집은 브릿지가 담당한다.<br />
B. 모델-중개 처리: Elicitation을 “ask_user” 같은 툴로도 노출하는 서버가 있다면, 기존 tool_call 루프에 섞어 처리해도 된다. 하지만 권장되는 방식은 스펙에 맞춘 네이티브 처리다(질문·응답이 중첩 흐름에서도 안정적). <a href="https://modelcontextprotocol.io/specification/draft/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a></p>
  </li>
  <li>
    <p>브릿지 확장 패턴<br />
너의 기존 Chat 오케스트레이터/브릿지에 아래 훅 두 개만 더해주면 된다.<br />
a) elicitation 이벤트 수신 → UI로 질문 띄우기 → JSON 스키마 검증 → 서버에 제출<br />
b) 샘플링·프롬프트·툴 루프와 자연스럽게 공존하도록 순서 제어</p>
  </li>
</ol>

<p>아래 코드는 “개념적으로 정확한 동작 흐름”을 보여주는 미니 스캐폴딩이다. MCP SDK의 세부 메서드명은 릴리스별로 다를 수 있으므로, 이벤트 구독/응답 부분은 네 SDK 버전에 맞춰 함수명만 치환하면 된다.</p>

<p>설치<br />
pip install mcp jsonschema orjson requests</p>

<p>코드 스니펫: MCP Elicitation 브릿지 훅</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="c1"># 가정: 이미 MCP 세션을 여러 개 열어놓았고, handles = {server: session} 형태로 보유
# 또한 ask_user 콜백(UI 입력)과 chat_backend(네 Chat 또는 Agent 백엔드)가 있다.
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_elicitation_loop</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]):</span>
    <span class="sh">"""</span><span class="s">
    한 MCP 세션에 대해 서버가 보내는 Elicitation 요청을 처리하는 루프.
    SDK마다 이벤트 수신 API 이름이 다를 수 있으므로, 아래 </span><span class="sh">'</span><span class="s">await session.next_elicitation()</span><span class="sh">'</span><span class="s">는
    네가 쓰는 SDK의 실제 호출로 치환하면 된다.
    </span><span class="sh">"""</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">next_elicitation</span><span class="p">()</span>  <span class="c1"># 예시: {"id": "...", "message": "날짜를 입력하세요", "schema": {...}}
</span>        <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">추가 정보가 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>

        <span class="c1"># UI에 질문 띄우고, 스키마에 맞는 dict로 응답 받기
</span>        <span class="n">user_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c1"># 로컬에서 1차 검증(선택이지만 권장)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="nf">validate</span><span class="p">(</span><span class="n">user_payload</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># 검증 실패 시 재질문
</span>            <span class="n">user_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">ask_user</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">입력 형식 오류: </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s">다시 입력해 주세요.</span><span class="sh">"</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
            <span class="nf">validate</span><span class="p">(</span><span class="n">user_payload</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c1"># 서버에 제출(실제 API명/필드명은 SDK에 맞춰 치환)
</span>        <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">submit_elicitation</span><span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="n">user_payload</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_chat_with_elicitation</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">):</span>
    <span class="c1"># 1) 병행으로 각 세션의 elicitation 루프를 가동
</span>    <span class="n">loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">handle_elicitation_loop</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">))</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>

    <span class="c1"># 2) 모델 호출 루프(툴/프롬프트/샘플링 등 기존 처리와 동일)
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_text</span><span class="p">}]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 필요하면 MCP list_tools를 OpenAI tools 포맷으로 넣기
</span>
    <span class="c1"># 첫 턴
</span>    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># tool_calls 처리(생략) + 중간에 서버가 elicitation을 보낼 수 있으므로, 다음 턴 전에 잠깐 yield
</span>    <span class="c1"># ...
</span>    <span class="c1"># 다음 턴 계속
</span>    <span class="c1"># ...
</span>
    <span class="c1"># 3) 종료 시 elicitation 루프 정리
</span>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">loops</span><span class="p">:</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">t</span>
</code></pre></div></div>

<p>UI 입력 콜백 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">ask_user_via_console</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[MCP 질문] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">요구 스키마: </span><span class="si">{</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; JSON으로 응답: </span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">ask_user_via_console</span><span class="p">(</span><span class="sh">"</span><span class="s">JSON 파싱 실패. 다시 입력해 주세요.</span><span class="sh">"</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></div>

<p>여기서 중요한 점<br />
스키마 검증. 서버가 스키마를 제공하므로 클라이언트에서 jsonschema로 1차 검증을 돌리면 왕복 횟수와 오류가 줄어든다. 스펙이 권장하는 보안·프라이버시 정책도 함께 지켜라(민감정보 요구 금지 등). <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
중첩 가능성. Elicitation은 다른 MCP 기능(툴, 프롬프트, 샘플링) 안쪽에 중첩되어 등장할 수 있다. 그러므로 이벤트 루프를 Chat 루프와 병행 실행하는 패턴이 안전하다. <a href="https://modelcontextprotocol.io/specification/draft/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
호환성. MCP를 직접 지원하는 클라이언트/에이전트(예: 일부 IDE, 일부 Agents SDK)는 Elicitation을 네이티브로 뜯어서 보여줄 예정이거나 이미 실험 중이다. 하지만 서버·SDK에 따라 이벤트/메서드명이 다르므로, 위 루프의 두 함수(next_elicitation, submit_elicitation) 위치만 실제 SDK 이름으로 바꾸면 된다. 개념과 흐름은 동일하다. <a href="https://github.com/anthropics/claude-code/issues/2799?utm_source=chatgpt.com">GitHub+1</a></p>

<p>OpenAI Agents나 일반 Chat과의 결합 방식 요약<br />
OpenAI Agents를 백엔드 모델로 쓸 때도 동일하다. “에이전트에게 MCP 서버를 그대로 넘겨서 에이전트가 툴 호출을 처리”하도록 둘 수도 있지만, Elicitation은 클라이언트(UI) 레벨의 사용자 상호작용이므로, 브릿지에서 이벤트를 수신해 UI와 왕복 후 결과를 서버에 전달하는 편이 제일 예측 가능하다.<br />
일반 Chat Completions(with tools) 경로에서도 마찬가지다. 모델은 답변/계획에 집중시키고, 사용자 질문은 브릿지가 담당한다. 필요하면 Elicitation으로 수집된 값을 시스템/유저 메시지로도 주입해 다음 턴 답변 품질을 올릴 수 있다.</p>

<p>실전 팁<br />
서버 수가 3개 이상이면 서버 라벨을 질문 메시지에 명시해준다. 예: “[files] 어떤 디렉토리를 생성할까요?”.<br />
민감정보 가드. 스펙이 금지하는 내용(비밀번호/토큰 등)은 브릿지에서 차단하고, 허용 목록만 통과시키는 것이 안전하다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
UX. 스키마에 enum/format을 적극 사용하게 서버 쪽에 권장하라. 클라이언트는 enum이면 드롭다운, format=email이면 이메일 입력 UI처럼 친화적으로 렌더링하기 쉽다. <a href="https://medium.com/data-science-collective/a-practical-guide-to-mcp-elicitation-with-fastapi-fastmcp-65f57fd91896?utm_source=chatgpt.com">Medium</a></p>

<p>한 줄 결론<br />
Elicitation은 MCP의 “인간-개입 표준 채널”이고, 툴과 별개로 Chat 루프에 깨끗하게 붙일 수 있다. 위 브릿지 훅 두 개만 넣으면, 모델-툴-사용자 삼자 협업이 안정적으로 돈다. 네가 쓰는 MCP Python SDK의 정확한 elicitation API 이름을 알려주면, next_elicitation/submit_elicitation 부분을 해당 버전에 딱 맞춰 즉시 치환해 준다.</p>

<p class="chat--user">

근데 MCP Server 라고 클래스명을 하니깐 진짜 서버 같이 느껴져 다른 이름 없어? 이건 설정 값에 가까운거 같은데

</p>

<p>맞아, “MCPServer”라고 하면 네트워크 서버 프로세스를 직접 돌린다는 느낌이 강하다. 실제 네가 다루는 건 세션을 열 때 필요한 <strong>설정 정보(Descriptor, Config, Profile, Endpoint)</strong>에 가까워.</p>

<p>보통 이런 경우 네이밍을 이렇게 바꿔 쓰면 더 자연스럽다.</p>

<ul>
  <li>
    <p><strong>MCPServerConfig</strong> : 가장 직설적. 서버에 접속하는 데 필요한 설정값 묶음.</p>
  </li>
  <li>
    <p><strong>MCPServerSpec</strong> : “사양/스펙”이라는 의미로, 서버를 기술하는 선언적 정보라는 뉘앙스.</p>
  </li>
  <li>
    <p><strong>MCPServerProfile</strong> : 여러 환경(개발/운영/테스트)에서 쓰일 수 있는 “프로필”이라는 톤.</p>
  </li>
  <li>
    <p><strong>MCPServerEndpoint</strong> : 특히 SSE/HTTP 주소처럼 원격 엔드포인트를 지칭할 때 적합.</p>
  </li>
  <li>
    <p><strong>MCPConnectionConfig</strong> : 실제로는 연결 구성에 해당한다는 걸 분명히 함.</p>
  </li>
</ul>

<p>네가 만든 UnifiedMCPConfig 같은 컨테이너 안에 들어갈 원소라면,</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MCPServerConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span> <span class="bp">...</span>
</code></pre></div></div>

<p>혹은 조금 더 가볍게</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MCPServerSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span> <span class="bp">...</span>
</code></pre></div></div>

<p>정도가 가장 무난하다.</p>

<p>정리하자면: <strong>서버(server)</strong>라는 단어 대신 <strong>Config / Spec / Endpoint / Profile</strong> 계열을 붙여주면 “실제 서버 객체”가 아니라 “접속 선언”이라는 의미가 명확해진다.</p>

<p>너의 코드베이스에서 MCP 서버를 실제로 구동하는 책임이 아니라 <strong>연결 정보를 담는 데이터 모델</strong> 이라면, <code class="language-plaintext highlighter-rouge">MCPServerConfig</code>가 가장 안전한 선택이다.</p>

<p>원한다면, 네가 지금 가지고 있는 클래스 정의를 내가 <code class="language-plaintext highlighter-rouge">MCPServerConfig</code> 식으로 리팩터링해서 전체 코드 스니펫을 다시 정리해줄 수도 있어.</p>

<p class="chat--user">

MCPSpec은 어때

</p>

<p>좋다. MCPSpec 괜찮다. 다만 “Spec”은 선언적·불변 설정이라는 뉘앙스를 주니, 런타임 상태(세션, 캐시, 동시성 제어)는 다른 이름에 두는 걸 추천한다. 정리하면 이렇게 쓰면 깔끔하다.</p>

<p>권장 의미 구분</p>

<ul>
  <li>
    <p>MCPSpec: 연결·인증·전송방식 같은 선언형 스펙. 직렬화 가능, 불변 취급.</p>
  </li>
  <li>
    <p>MCPHandle 또는 MCPSession: MCPSpec을 바탕으로 실제 연결을 연 뒤 갖게 되는 런타임 객체.</p>
  </li>
  <li>
    <p>MCPConfig: 여러 MCPSpec을 담는 컨테이너.</p>
  </li>
</ul>

<p>작은 리팩터 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">사람과 모델이 보는 라벨</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># 정책/힌트(스펙이므로 기본값만 보관)
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span>
    <span class="n">cache_tools_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">class</span> <span class="nc">MCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPSpec</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate names: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>런타임 분리 패턴</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">MCPSpec</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">open_handle</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">MCPSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">env</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 필요 시 http_streamable 등 추가
</span>        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unsupported kind: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span> <span class="k">await</span> <span class="n">s</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</code></pre></div></div>

<p>어댑터에서의 사용 느낌</p>

<ul>
  <li>
    <p>OpenAI Agents 어댑터: MCPSpec → MCPServerStdio/MCPServerSse 생성 시 그대로 넘김.</p>
  </li>
  <li>
    <p>Anthropic 어댑터: MCPSpec(kind="sse"/"http_streamable")를 mcp_servers 페이로드로 직렬화.</p>
  </li>
</ul>

<p>장단점 한줄 요약</p>

<ul>
  <li>
    <p>MCPSpec은 “진짜 서버”가 아니라 “접속 선언”이라는 의도가 분명해져 오해가 줄고, 테스트·직렬화·버전관리도 쉬워진다.</p>
  </li>
  <li>
    <p>세션·동시성 같은 런타임은 Handle/Session 쪽으로 분리되니 책임이 선명해진다.</p>
  </li>
</ul>

<p>결론<br />
MCPSpec 네이밍 채택 추천. 이미 만들어둔 코드에서 클래스명만 바꾸고, 핸들(세션) 계층을 분리하면 지금까지의 어댑터/브릿지 구조와도 잘 맞물린다.</p>

<p class="chat--user">

응 런타임 처리는 안할거야. MCPSpec // ToolSpec 이렇게 할까 하는데 MCPConfig // ToolConfig 이게 나으려나 어떻게 생각해

</p>

<p>좋아, 런타임은 안 다룬다고 했으니 이름은 “무슨 값을 선언·기술해 두는가”에만 맞추면 된다. 핵심은 Spec과 Config가 주는 뉘앙스 차이를 의도대로 쓰는 것.</p>

<p>정의 요약<br />
Spec: 인터페이스·스키마·불변에 가까운 선언. 엔드포인트, 툴 시그니처, JSON 스키마 같은 “계약서”.<br />
Config: 실행 맥락에 맞춘 선택·오버레이. 어떤 Spec을 노출할지, 별칭, 기본 옵션, 켜기/끄기 같은 “정책”.</p>

<p>권장 네이밍 매트릭스<br />
단일 선언 단위<br />
MCPSpec: MCP 접속 선언. kind, url/command, headers 같은 연결 스펙과 라벨, 태그 등.<br />
ToolSpec: 툴 선언. name, description, parameters(JSON Schema), 위험도 플래그 등.</p>

<p>컬렉션과 정책<br />
MCPConfig: 여러 MCPSpec을 담고, 환경별로 enable/disable·라벨·승인정책 등 오버레이.<br />
ToolConfig: 여러 ToolSpec에 대한 정책 오버레이와 노출 규칙(필터링, 별칭, 기본 파라미터 등).</p>

<p>즉, MCPSpec // ToolSpec은 “순수 선언”, MCPConfig // ToolConfig는 “선택과 정책”으로 역할을 분리하면 깔끔하다.</p>

<p>바로 쓸 수 있는 최소 모델 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">사람/모델이 볼 라벨, 네임스페이스 키</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># 메타
</span>    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                             <span class="c1"># 예: "files:read_csv" 또는 "local.math_eval"
</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span>            <span class="c1"># JSON Schema
</span>    <span class="n">server_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>      <span class="c1"># MCP 네임스페이스(예: "files"). 로컬 툴이면 None.
</span>    <span class="n">risk_level</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">med</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">low</span><span class="sh">"</span>
    <span class="n">default_dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>        <span class="c1"># name -&gt; on/off
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>         <span class="c1"># name -&gt; alias for UI/LLM
</span>    <span class="c1"># 간단 검증
</span>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate MCP names</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ToolConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>        <span class="c1"># tool name -&gt; on/off
</span>    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>         <span class="c1"># tool name -&gt; alias
</span>    <span class="n">defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># tool name -&gt; default args
</span>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate tool names</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>어댑터는 “런타임 없이” 정적 변환만 하면 된다</p>

<p>OpenAI Chat Completions tools 변환<br />
ToolSpec → tools JSON으로 직렬화</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tools_for_openai</span><span class="p">(</span><span class="n">tool_cfg</span><span class="p">:</span> <span class="n">ToolConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">aliases</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></div>

<p>Anthropic Messages API용 MCP 서버 페이로드<br />
MCPSpec → mcp_servers 항목으로 직렬화(SSE/HTTP 계열만)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mcp_servers_for_anthropic</span><span class="p">(</span><span class="n">mcp_cfg</span><span class="p">:</span> <span class="n">MCPConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># Anthropic는 원격 URL 타입만 직접 붙일 수 있음
</span>            <span class="k">continue</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">aliases</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">authorization_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_configuration</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">enabled</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<p>OpenAI Agents Python SDK용 MCP 컨텍스트 매니저 생성<br />
MCPSpec → SDK의 MCPServerSse/MCPServerStdio로 변환에 필요한 파라미터만 준비<br />
런타임은 안 만들지만, 어댑터가 어느 클래스를 써야 하는지 결정할 수 있도록 정적 매핑만 책임지게 하면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mcp_params_for_openai_agents</span><span class="p">(</span><span class="n">mcp_cfg</span><span class="p">:</span> <span class="n">MCPConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">env</span><span class="p">}})</span>
        <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">}})</span>
        <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">}})</span>
    <span class="k">return</span> <span class="n">params</span>
</code></pre></div></div>

<p>왜 이렇게 나누길 권하냐<br />
MCPSpec / ToolSpec은 불변 계약서다. 코드 리뷰·버전 관리·테스트 더블 작성이 쉽다.<br />
MCPConfig / ToolConfig는 환경별 설정과 정책을 담아 배포 파이프라인에서 바꿔치우기 좋다. 스테이징과 프로덕션을 오버레이로 구분하기 편하다.<br />
추후 런타임을 붙이고 싶어도 모델이 흔들리지 않는다. Handle/Session은 별 파일에서 추가하면 된다.</p>

<p>실무 팁<br />
Spec에 version, tags, capabilities 같은 필드를 두면 나중에 필터링이 편하다(예: tag가 readonly인 MCP만 노출).<br />
ToolSpec.parameters는 반드시 엄격하게(required, enum, format, min/max) 기입해 모델의 잘못된 호출을 줄인다.<br />
Config의 aliases는 LLM 혼동을 줄이는 데 효과적이다. 네임스페이스가 긴 툴은 별칭을 짧고 명확하게.</p>

<p>결론<br />
네 목표가 선언값만 관리하는 거라면 MCPSpec // ToolSpec로 가는 게 맞다. 여기에 환경·정책을 얹는 용도로 MCPConfig // ToolConfig를 추가하면 운영 친화적이다. 한 줄 요약은 이거다.<br />
Spec = 계약, Config = 선택과 정책.<br />
둘 다 쓰되, 각자 역할을 분명히 나누자.</p>

<p class="chat--user">

근데 클래스명을 McpSpec MCPSpec 이거 계속 헷갈림 

</p>

<p>헷갈리는 게 정상이다. 파이썬에서 약어를 클래스명에 넣을 때 선택지는 두 가지뿐이다. 하나만 고르고 끝까지 일관하면 된다.</p>

<p>권장 결론<br />
McpSpec로 통일하자. 이유는 가독성(대문자 덩어리 줄임), 타이핑 편의, 그리고 파이썬 생태계에서 HttpServer, XmlParser처럼 약어를 단어 취급하는 관례가 널리 쓰이기 때문이다. 그러면 패밀리도 자연스럽게 McpConfig, McpEndpoint, McpHandle 같은 리듬이 된다.</p>

<p>빠른 규칙 세트<br />
클래스: McpSpec, McpConfig, McpToolSpec, McpToolConfig<br />
모듈 파일: mcp_spec.py, mcp_config.py<br />
변수/매개변수: mcp_spec, mcp_config<br />
JSON 키: snake_case 면 "mcp_spec", camelCase면 "mcpSpec" (팀 컨벤션 하나만 선택)<br />
상수: MCP_SPEC_DEFAULTS처럼 전부 대문자도 가능하지만 클래스명과 혼동되니 피하는 편이 좋다</p>

<p>작게 맛보기 리팩터 스니펫</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_spec.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">McpSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">라벨/네임스페이스</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate MCP names</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>레거시 호환이 필요하면 한 줄로 다리 걸어두면 된다</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 임시 호환(향후 제거 예정)
</span><span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">McpSpec</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>만약 팀이 전통적인 “약어는 전부 대문자”를 고집한다면 MCPSpec로 가도 된다. 그 경우엔 문서·코드 전반에 동일 규칙을 강제하자. 예를 들어 클래스는 MCPSpec/MCPEndpoint, 변수는 mcp_spec, 파일은 mcp_spec.py처럼 “클래스만 ALLCAPS+CapWords, 나머진 snake_case”로 선을 긋는 식이다. 핵심은 혼용 금지다.</p>

<p>한 줄 요약<br />
파이썬 프로젝트라면 McpSpec 계열이 덜 헷갈리고 읽기 좋다. 팀 합의로 한 스타일만 박고, 클래스·모듈·변수·JSON 키에 같은 원칙을 반복 적용하면 혼란이 사라진다.</p>

<p class="chat--user">

StdioClientTransport랑 SSEClientTransport가 없다는ㄷ

</p>

<p>좋아, 이건 보통 다음 세 가지 경우 중 하나다. 차근차근 정리하고, 바로 쓸 수 있는 호환 셰임(shim) 코드까지 붙일게.</p>

<ol>
  <li>
    <p>패키지/버전 문제<br />
mcp Python SDK의 트랜스포트 경로가 버전별로 조금 달라서, 네 환경에선 <code class="language-plaintext highlighter-rouge">mcp.client.stdio</code> / <code class="language-plaintext highlighter-rouge">mcp.client.sse</code> 모듈이 없을 수 있다. 설치가 다르거나 구버전일 가능성이 높다.</p>
  </li>
  <li>
    <p>선택적 의존성 미설치<br />
SSE 트랜스포트는 선택(extra)로 분리된 경우가 있다. 즉, 기본 <code class="language-plaintext highlighter-rouge">pip install mcp</code>로는 SSE 클라이언트가 없고, 추가 의존성을 깔아야 한다.</p>
  </li>
  <li>
    <p>다른 SDK를 보고 있다<br />
이름이 비슷한 포크/래퍼(예: 예전 model-context-protocol 패키지)나 프록시 클라이언트를 깔아 두면 경로가 어긋난다.</p>
  </li>
</ol>

<p>해결 순서 한 번에 끝내기<br />
아래 명령으로 네 환경을 표준화해보자. 실패하면 바로 호환 셰임 코드가 뒤에 있다.</p>

<p>1단계. 설치/업그레이드<br />
pip install -U mcp<br />
SSE까지 쓸 거면 아래 둘 중 환경에 맞게 하나를 시도<br />
pip install -U "mcp[sse]"<br />
또는<br />
pip install -U httpx sse-starlette</p>

<p>2단계. 버전·모듈 확인<br />
python - «'PY'<br />
import pkgutil, mcp, sys<br />
print("mcp version:", getattr(mcp, "<strong>version</strong> ", "unknown"))<br />
print("has mcp.client.stdio:", pkgutil.find_loader("mcp.client.stdio") is not None)<br />
print("has mcp.client.sse:", pkgutil.find_loader("mcp.client.sse") is not None)<br />
print("has mcp.transport.stdio:", pkgutil.find_loader("mcp.transport.stdio") is not None)<br />
print("has mcp.transport.sse:", pkgutil.find_loader("mcp.transport.sse") is not None)<br />
PY</p>

<p>이제 어떤 경로가 있는지 알았으니, 호환 임포트 셰임으로 깔끔하게 처리하면 된다.</p>

<p>호환 임포트 셰임(둘 중 있는 걸 자동으로 씀)<br />
이 스니펫을 너의 공통 유틸에 넣고, 나머지 코드에선 항상 여기서 임포트한 클래스를 쓰면 경로 차이에 안 흔들린다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_compat.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># stdio
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>  <span class="c1"># 신형 경로
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.transport.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>  <span class="c1"># 구형/다른 빌드
</span>    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">StdioClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>        <span class="n">StdioServerParameters</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>
<span class="c1"># sse
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>  <span class="c1"># 신형 경로
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.transport.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>  <span class="c1"># 구형/다른 빌드
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">SSEClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>
<span class="k">def</span> <span class="nf">have_stdio</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">StdioClientTransport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">StdioServerParameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">have_sse</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">SSEClientTransport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</code></pre></div></div>

<p>사용 예시(네 기존 코드 그대로, 단 임포트만 바꿈)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 기존: from mcp.client.stdio import StdioClientTransport, StdioServerParameters
# 기존: from mcp.client.sse import SSEClientTransport
</span><span class="kn">from</span> <span class="n">mcp_compat</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span><span class="p">,</span> <span class="n">SSEClientTransport</span><span class="p">,</span> <span class="n">have_stdio</span><span class="p">,</span> <span class="n">have_sse</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_stdio</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">have_stdio</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">STDIO transport가 이 환경에 없습니다. mcp 패키지 또는 버전을 확인하세요.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}))</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">transport</span><span class="p">,</span> <span class="n">sess</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_sse</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">have_sse</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">SSE transport가 이 환경에 없습니다. </span><span class="sh">'</span><span class="s">pip install </span><span class="se">\"</span><span class="s">mcp[sse]</span><span class="se">\"</span><span class="sh">'</span><span class="s"> 또는 httpx 계열을 설치하세요.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">transport</span><span class="p">,</span> <span class="n">sess</span>
</code></pre></div></div>

<p>대체 경로가 모두 없다면<br />
OpenAI Agents Python SDK의 내장 커넥터를 써서 트랜스포트 문제를 아예 우회할 수도 있다. 네가 “MCP 서버를 그대로 넘긴다” 전략을 쓰는 경우 특히 간단하다. 이 경로에선 파이썬에서 transport를 직접 임포트하지 않는다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search</span><span class="p">:</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">pass-through</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files</span><span class="p">,</span> <span class="n">search</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">((</span><span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">sales.csv 합계를 구해줘</span><span class="sh">"</span><span class="p">)).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>정리<br />
StdioClientTransport / SSEClientTransport가 “없다”는 에러는 거의 항상 모듈 경로/버전 차이에서 온다. 위 셰임을 쓰면 코드 한 번으로 양쪽 경로를 자동 지원할 수 있고, 그래도 안 되면 Agents SDK의 내장 MCP 커넥터로 트랜스포트 계층을 통째로 맡겨 버리는 것도 깔끔한 해결책이다.</p>

<p>계속 쓰는 스타일을 정리하자면</p>

<ol>
  <li>
    <p>직접 SDK를 쓸 거면 mcp_compat.py 셰임으로 경로 차이를 흡수</p>
  </li>
  <li>
    <p>빠른 통합이면 Agents SDK의 MCPServerStdio/MCPServerSse를 사용</p>
  </li>
</ol>

<p>여기까지로 안 잡히면 네 <code class="language-plaintext highlighter-rouge">pip show mcp</code> 출력과 <code class="language-plaintext highlighter-rouge">python -c "import pkgutil; import mcp, sys; ..."</code> 결과를 알려줘. 그 정보로 정확한 임포트 경로를 딱 맞춰줄 수 있다.</p>

<p class="chat--user">

음 그냥 FastMcp 쓰는게 편할것 같네. FastMCP에서 config = { 'mcpServers': { "weather": {"url": "https://weather-api.example.com/mcp"}, "assistant": {"command": "python", "args": ["./assistant_servers.py"]} } } client = Client(config) 를 하면 바로 만들어 주는 것 같거든? 각각의 McpSpec에서 각각 한 줄을 만드는 함수 작성 + McpConfig에서 Config 자체를 만드는 함수 작성하면 좋을 것 같아.

</p>

<p>좋아, FastMCP를 기준으로 “스펙 → 한 줄”과 “스펙 모음 → 최종 config”를 자동 생성하는 얇은 레이어를 딱 만들어줄게. 네가 원하는 건 런타임이 아니라 선언값이니, McpSpec은 선언, McpConfig는 컬렉션+검증+직렬화만 맡는다.</p>

<p>아래 코드는 그대로 붙여 쓰면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_specs.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># FastMCP 관점: 원격(url) 또는 로컬(stdio)
</span>
<span class="k">class</span> <span class="nc">McpSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">FastMCP에서 사용할 서버 라벨</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># url 서버
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># stdio 서버
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>           <span class="c1"># 선택: 필터링/문서화에 유용
</span>    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>                       <span class="c1"># 선택: 사람 읽는 설명
</span>
    <span class="nd">@field_validator</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_name_non_empty</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">name must be non-empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">to_fastmcp_entry</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        FastMCP 설정의 </span><span class="sh">'</span><span class="s">한 줄</span><span class="sh">'</span><span class="s">을 만든다.
        반환 예시:
          {</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">https://...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="s">: {...}}
          {</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="s">: [</span><span class="sh">"</span><span class="s">./server.py</span><span class="sh">"</span><span class="s">], </span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="s">: {...}}
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: url kind requires url</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">headers</span>
            <span class="k">return</span> <span class="n">entry</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio kind requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">command</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">args</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="k">return</span> <span class="n">entry</span>

        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: unknown kind </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">kind</span><span class="si">!r}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpSpec</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">dupes</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate spec names: </span><span class="si">{</span><span class="nf">sorted</span><span class="p">(</span><span class="n">dupes</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: url is required for kind=</span><span class="sh">'</span><span class="s">url</span><span class="sh">'"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: command is required for kind=</span><span class="sh">'</span><span class="s">stdio</span><span class="sh">'"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_fastmcp_config</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">exclude_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">enable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">name_alias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        FastMCP가 바로 먹는 dict를 만든다.
        반환 예시:
          {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="s">: {...}, </span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="s">: {...}}}
        옵션:
          include_tags: 지정된 태그가 하나라도 있는 스펙만 포함
          exclude_tags: 지정된 태그가 하나라도 있으면 제외
          enable: {</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: True/False} 형태의 on/off 오버라이드
          name_alias: {</span><span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">alias</span><span class="sh">"</span><span class="s">} 키 변경(LLM/사람에게 보일 라벨 바꾸기)
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">servers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">include_tags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">tags</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exclude_tags</span> <span class="ow">and</span> <span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">exclude_tags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">tags</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">enable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">enable</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">key</span> <span class="o">=</span> <span class="n">name_alias</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name_alias</span> <span class="k">else</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span>
            <span class="n">servers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="nf">to_fastmcp_entry</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">servers</span><span class="p">}</span>

    <span class="c1"># 편의: 체이닝 등록
</span>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">McpSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">McpConfig</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span>
</code></pre></div></div>

<p>간단 사용 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 예시 1) 질문에서 준 config를 코드로 생성
</span><span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpSpec</span><span class="p">,</span> <span class="n">McpConfig</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="p">[</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]),</span>
<span class="p">])</span>

<span class="n">fastmcp_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">()</span>
<span class="c1"># fastmcp_config == {
#   "mcpServers": {
#     "weather": {"url": "https://weather-api.example.com/mcp"},
#     "assistant": {"command": "python", "args": ["./assistant_servers.py"]}
#   }
# }
</span>
<span class="c1"># FastMCP 클라이언트에 그대로 투입
# from fastmcp import Client
# client = Client(fastmcp_config)
</span></code></pre></div></div>

<p>태그/별칭/부분 사용 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">().</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">readonly</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">public</span><span class="sh">"</span><span class="p">])</span>
<span class="p">).</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./db_server.py</span><span class="sh">"</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">MODE</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">prod</span><span class="sh">"</span><span class="p">},</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">write</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">internal</span><span class="sh">"</span><span class="p">])</span>
<span class="p">).</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">],</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">helper</span><span class="sh">"</span><span class="p">])</span>
<span class="p">)</span>

<span class="c1"># 읽기 전용만 포함하고, weather를 public-weather로 라벨링
</span><span class="n">fastmcp_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">(</span>
    <span class="n">include_tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">readonly</span><span class="sh">"</span><span class="p">],</span>
    <span class="n">name_alias</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">public-weather</span><span class="sh">"</span><span class="p">}</span>
<span class="p">)</span>
<span class="c1"># 결과:
# {"mcpServers": {"public-weather": {"url": "https://weather-api.example.com/mcp"}}}
</span></code></pre></div></div>

<p>검증 포인트 요약</p>

<ol>
  <li>
    <p>McpSpec.to_fastmcp_entry가 “url”과 “stdio” 케이스를 각각 한 줄로 생성한다.</p>
  </li>
  <li>
    <p>McpConfig.to_fastmcp_config가 필터링과 on/off, 별칭을 지원한다.</p>
  </li>
  <li>
    <p>FastMCP의 Client(config) 호출에 바로 넣을 수 있는 구조를 만든다.</p>
  </li>
</ol>

<p>확장 아이디어<br />
headers, env에 비밀값이 들어가면 McpConfig에서 별도 시크릿 소스로 병합하는 훅을 추가해도 좋다.<br />
테넌트별로 enable dict를 바꾸는 것만으로 동일 스펙에서 다른 배포 구성을 만들 수 있다.<br />
나중에 Elicitation/Prompt 같은 메타가 필요하면 McpSpec에 meta: Dict[str, Any] 정도를 추가해도 직렬화 흐름엔 영향이 없다.</p>

<p>이렇게 두면 “각각의 McpSpec에서 각각 한 줄”과 “McpConfig에서 최종 config”가 둘 다 한 번에 해결된다.</p>

<p class="chat--user">

아 그런데 config가 없으면 어떻게 되지?

</p>

<p>좋은 포인트다. “config가 없을 때”는 두 가지를 분리해서 생각하면 깔끔하다.</p>

<ol>
  <li>FastMCP Client 레벨에서의 기대 동작<br />
일반적으로 Client는 최소한 {"mcpServers": {}} 형태의 딕셔너리를 기대한다. 완전히 None이거나 키가 없으면 내부에서 KeyError/TypeError 류가 날 가능성이 높다. 안전하게 가려면 다음을 지키자.</li>
</ol>

<ul>
  <li>
    <p>비어 있어도 된다: 빈 설정은 곧 “연결된 MCP 서버 없음”이니, Client는 뜨지만 툴은 없다.</p>
  </li>
  <li>
    <p>키는 반드시 있어야 한다: {"mcpServers": {}} 형태를 보장하자.</p>
  </li>
  <li>
    <p>잘못된 형태는 막자: 문자열이나 리스트 같은 타입이 들어가면 바로 예외를 던지게 하자.</p>
  </li>
</ul>

<ol>
  <li>네 선언 계층(McpSpec / McpConfig)에서의 방어 전략<br />
런타임을 다루지 않기로 했으니, 선언-직렬화 단계에서 다음의 fallbacks를 두면 실전에서 편하다.</li>
</ol>

<ul>
  <li>
    <p>config가 None이면 빈 구조로 만들어 준다.</p>
  </li>
  <li>
    <p>mcpServers 키가 없으면 생성해 준다.</p>
  </li>
  <li>
    <p>specs가 비어 있으면 빈 딕셔너리를 넣되, 로거 경고를 남긴다.</p>
  </li>
  <li>
    <p>환경변수나 기본 파일 경로에서 자동으로 끌어오는 선택지를 둔다(있으면 사용, 없으면 빈 dict).</p>
  </li>
</ul>

<p>아래 헬퍼를 넣으면 실수해도 안전하게 동작한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_guard.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="c1"># 이전에 만든 선언 모델이라고 가정
# from fastmcp_specs import McpSpec, McpConfig
</span>
<span class="k">def</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="sh">"</span><span class="s">McpSpec</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>     <span class="c1"># 문자열 인용은 순환 import 회피용
</span>    <span class="n">env_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">FASTMCP_SERVERS_JSON</span><span class="sh">"</span><span class="p">,</span>       <span class="c1"># 옵션: {"weather":{"url":"..."}, "assistant":{...}} 형태
</span>    <span class="n">file_env_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">FASTMCP_CONFIG_PATH</span><span class="sh">"</span>    <span class="c1"># 옵션: JSON 파일 경로
</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    1순위: 명시 config
    2순위: specs → {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: {...}} 직렬화
    3순위: 환경변수에서 로드
    4순위: 빈 설정으로 폴백
    항상 {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: dict} 형태를 보장한다.
    </span><span class="sh">"""</span>
    <span class="c1"># 1) 명시 config
</span>    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">config must be a dict or None</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="c1"># 부분 설정만 온 경우 보완
</span>            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)}</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="c1"># 2) specs → 직렬화
</span>    <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpConfig</span>  <span class="c1"># 지역 임포트로 순환 참조 회피
</span>        <span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">()</span>

    <span class="c1"># 3) 환경변수: 파일 경로 우선
</span>    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">file_env_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># 파일이 {"mcpServers":{...}} 형태이거나 {"weather":{...}} 같은 맵일 수도 있음
</span>        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">file config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">file config must be a dict</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">env config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">env config must be a dict</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 4) 최종 폴백: 빈 설정
</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
</code></pre></div></div>

<p>즉시 사용 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1) config가 None인 상황
</span><span class="kn">from</span> <span class="n">fastmcp_guard</span> <span class="kn">import</span> <span class="n">ensure_fastmcp_config</span>
<span class="c1"># from fastmcp import Client
</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>  <span class="c1"># {"mcpServers": {}}
# client = Client(cfg)  # 툴 없이 실행
</span>
<span class="c1"># 2) McpSpec만 있고 config가 없는 상황
</span><span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpSpec</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]),</span>
<span class="p">]</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>
<span class="c1"># client = Client(cfg)
</span>
<span class="c1"># 3) 환경변수로만 공급하는 상황
# export FASTMCP_SERVERS_JSON='{"weather":{"url":"https://weather-api.example.com/mcp"}}'
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">()</span>
<span class="c1"># client = Client(cfg)
</span></code></pre></div></div>

<p>운영 팁 한 줄 요약<br />
빈 설정은 허용하되 형태는 항상 보장하자. 즉, 최소 {"mcpServers": {}}를 만들어서 Client가 안정적으로 뜨게 하고, 실제 서버 없으면 “툴 없음” 상태로만 동작하게 하는 게 제일 안전하다. 필요하면 ensure_fastmcp_config 내부에 로깅을 넣어 “현재 MCP 서버 0개” 같은 경고를 남기면 실수도 빨리 잡힌다.</p>

<p class="chat--user">

이렇게 만든 FastMcp Client의 툴과 내가 만든 일반 ToolSpec을 둘 다 고려해서 chat completions 호출 -&gt; 그 후 요청하는 함수 실행을 만들고 싶어 async with Client(cfg) as client: client.list_tools() # mcp tool 반환 client.call_tool(함수명, 인자) 이렇게 쓸 수 있어. fastmcp는 이 두 가지를 어떻게 하면 잘 쓰게 할 수 있을까

</p>

<p>좋아. 목표는 FastMCP의 툴들과 네가 직접 정의한 일반 ToolSpec들을 “하나의 툴 세트”처럼 묶어서 Chat Completions with tools를 돌리고, 모델이 요청한 tool_calls를 각각 알맞은 실행기로 라우팅하는 것. 아래 스캐폴딩은 그대로 붙여서 돌아가도록 설계했다.</p>

<p>핵심 아이디어</p>

<ol>
  <li>
    <p>FastMCP의 client.list_tools() 결과를 OpenAI tools 포맷으로 정규화하고 이름에 접두사 mcp:를 붙인다.</p>
  </li>
  <li>
    <p>네 로컬 ToolSpec들도 같은 포맷으로 직렬화한다.</p>
  </li>
  <li>
    <p>Chat Completions 첫 호출에 두 종류 툴을 모두 넣는다.</p>
  </li>
  <li>
    <p>tool_calls 루프에서 이름이 mcp:면 client.call_tool로, 아니면 LocalToolRegistry 핸들러로 실행한다.</p>
  </li>
</ol>

<p>코드</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># unified_fastmcp_chat.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="c1">###############################################################################
# 0) 로컬 ToolSpec 정의(한 번만 구현해서 공통 사용)
###############################################################################
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">LocalToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate tool: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_openai_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">.</span><span class="nf">values</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# 1) FastMCP → OpenAI tools 정규화
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    FastMCP client.list_tools()를 호출해 OpenAI tools 포맷으로 변환.
    각 이름에는 </span><span class="sh">'</span><span class="s">mcp:</span><span class="sh">'</span><span class="s"> 접두사를 붙여 로컬 툴과 충돌을 방지.
    FastMCP 툴 메타는 다음 필드를 가진다고 가정: name, description, parameters(JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">def</span> <span class="nf">is_mcp_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">strip_mcp_prefix</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tool_name</span><span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span> <span class="k">if</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">else</span> <span class="n">tool_name</span>

<span class="c1">###############################################################################
# 2) Chat Completions 호출 러너(두 툴 세트를 한꺼번에 노출)
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">local_registry</span><span class="p">:</span> <span class="n">LocalToolRegistry</span><span class="p">,</span>
        <span class="n">fastmcp_client</span><span class="p">,</span>
        <span class="n">expose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 1) 툴 카탈로그 합치기
</span>        <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">fastmcp_client</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">local_tools</span> <span class="o">=</span> <span class="n">local_registry</span><span class="p">.</span><span class="nf">list_openai_tools</span><span class="p">()</span>
        <span class="n">all_tools</span> <span class="o">=</span> <span class="n">local_tools</span> <span class="o">+</span> <span class="n">mcp_tools</span>
        <span class="k">if</span> <span class="n">expose</span><span class="p">:</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="nf">expose</span><span class="p">(</span><span class="n">all_tools</span><span class="p">)</span>  <span class="c1"># 턴별 소출 정책(선택)
</span>
        <span class="c1"># 2) 1차 모델 호출
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 3) tool_calls 루프
</span>        <span class="n">rounds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">rounds</span> <span class="o">&lt;</span> <span class="n">max_rounds</span><span class="p">:</span>
            <span class="n">rounds</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw</span><span class="p">}</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nf">is_mcp_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">):</span>
                        <span class="c1"># FastMCP 경로
</span>                        <span class="n">mcp_name</span> <span class="o">=</span> <span class="nf">strip_mcp_prefix</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fastmcp_client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">mcp_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># 로컬 툴 경로
</span>                        <span class="n">spec</span> <span class="o">=</span> <span class="n">local_registry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span>
                <span class="p">})</span>

            <span class="c1"># 다음 턴
</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# 3) 사용 예시
###############################################################################
</span>
<span class="c1"># 예시 로컬 툴 구현
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) FastMCP 클라이언트 준비
</span>    <span class="c1"># from fastmcp import Client
</span>    <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">},</span>
            <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># async with Client(cfg) as client:
</span>    <span class="c1">#     ...
</span>
    <span class="c1"># 데모를 위해 간이 더미 클라이언트를 흉내내자. 실제로는 fastmcp.Client를 사용.
</span>    <span class="k">class</span> <span class="nc">DummyFastMCP</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">self</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
            <span class="c1"># 이름은 서버 네임스페이스를 포함해주면 LLM이 더 잘 고른다
</span>            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">weather:get_forecast</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">도시/날짜별 일기예보</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">}},</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">]</span>
                <span class="p">}},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant:read_csv_sum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CSV 합계 계산</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">]</span>
                <span class="p">}}</span>
            <span class="p">]</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="c1"># 여기서는 결과 형태만 맞춰준다
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo-result</span><span class="sh">"</span><span class="p">}</span>

    <span class="c1"># 1) 로컬 툴 레지스트리
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolRegistry</span><span class="p">()</span>
    <span class="n">local</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
        <span class="n">handler</span><span class="o">=</span><span class="n">math_eval</span>
    <span class="p">))</span>

    <span class="c1"># 2) 러너
</span>    <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 3) 통합 실행
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">필요한 도구만 호출한다. 파괴적 작업은 dry_run 우선.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant:read_csv_sum으로 data/sales.csv 합계를 구하고, local.math_eval로 (100+23)도 계산해줘</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">async</span> <span class="k">with</span> <span class="nc">DummyFastMCP</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">local_registry</span><span class="o">=</span><span class="n">local</span><span class="p">,</span> <span class="n">fastmcp_client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== FINAL ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>운영 포인트<br />
이름 규칙을 고정하자. mcp: 접두사로 FastMCP에서 온 툴을 표시하면 충돌을 방지하고 라우팅이 단순해진다. FastMCP 쪽 툴 이름에 이미 server:tool 형태가 들어가 있어도 상관없다. 최종 노출명은 mcp:server:tool처럼 되지만 LLM이 의외로 잘 고른다.<br />
툴 소출을 넣자. expose 콜백으로 턴별로 필요한 서브셋만 tools에 담으면 선택 오류와 지연이 줄어든다.<br />
결과 포맷을 통일하자. tool role 메시지 content는 항상 JSON 문자열로 넣는 게 후속 라운드에서 안정적이다.<br />
에러는 JSON으로. 실행기 에러도 {"error": "…"}로 통일해 모델이 복구 플랜을 세우기 좋게 만든다.</p>

<p>이 구조면 FastMCP가 제공하는 툴과 네 로컬 ToolSpec을 동시에 들고, 표준 Chat Completions 루프에서 자연스럽게 섞어 쓸 수 있다. 필요한 경우 expose 정책, 이름 별칭, 기본 인자 주입 같은 정책 훅을 runner.run의 인자로 얹어 확장하면 된다.</p>

<p class="chat--user">

Tool이 not subscriptable mcp Tool의 속성을 저런식으로 접근하는게 잘못된거 아닐까 싶네

</p>

<p>맞다. “Tool이 not subscriptable”은 FastMCP가 <code class="language-plaintext highlighter-rouge">list_tools()</code>에서 dict가 아니라 객체를 돌려줘서 생긴 증상이다. 내가 예시에서 <code class="language-plaintext highlighter-rouge">t['name']</code>처럼 딕셔너리로 다뤘기 때문. 해결은 간단하다. MCP 툴 메타를 dict/객체 어떤 형식이 와도 안전하게 읽도록 정규화 레이어를 한 줄 끼우면 된다.</p>

<p>아래 패치만 적용하면 바로 돌아간다.</p>

<ol>
  <li>MCP 툴 메타 정규화 유틸 추가<br />
딕셔너리, pydantic 모델, dataclass, 일반 객체를 모두 지원하고, 필드명도 <code class="language-plaintext highlighter-rouge">parameters | input_schema | schema</code> 중 있는 걸 자동 선택한다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># utils_normalize.py
</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="k">def</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="c1"># pydantic 모델, dataclass, 일반 객체까지 커버
</span>    <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="c1"># 일부 객체는 to_dict()/dict() 제공
</span>    <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">to_dict</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="nf">to_dict</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">dict</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="nf">dict</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">default</span>

<span class="k">def</span> <span class="nf">normalize_mcp_tool_meta</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    FastMCP client.list_tools() 결과의 한 항목을 OpenAI tools 포맷용 메타로 정규화.
    반환: {</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">: dict}
    </span><span class="sh">"""</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="c1"># 어떤 서버는 server/name 식별자를 별도 필드에 둘 수 있음
</span>        <span class="n">name</span> <span class="o">=</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">unknown</span><span class="sh">"</span>

    <span class="n">desc</span> <span class="o">=</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">desc</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

    <span class="c1"># JSON Schema 필드명 변주 대응
</span>    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">schema</span><span class="sh">"</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="p">)</span>

    <span class="c1"># 최소 형식 보정
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">params</span><span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>mcp_tools_for_openai를 정규화 유틸로 교체<br />
이제 리스트가 dict든 객체든 문제 없다. 접두사만 붙여 충돌을 피한다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># unified_fastmcp_chat.py의 기존 함수 대체
</span>
<span class="kn">from</span> <span class="n">utils_normalize</span> <span class="kn">import</span> <span class="n">normalize_mcp_tool_meta</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="n">tools_raw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">openai_tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_raw</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="nf">normalize_mcp_tool_meta</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">openai_tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">meta</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">openai_tools</span>
</code></pre></div></div>

<ol>
  <li>
    <p>실행 시 라우팅 부분은 그대로 유지<br />
<code class="language-plaintext highlighter-rouge">is_mcp_tool(name)</code>로 접두사 판단 → <code class="language-plaintext highlighter-rouge">strip_mcp_prefix(name)</code>로 원래 이름 복구 → <code class="language-plaintext highlighter-rouge">await client.call_tool(mcp_name, args)</code> 호출. FastMCP가 기대하는 함수명이 <code class="language-plaintext highlighter-rouge">list_tools()</code>에서 받은 그대로라면 이 흐름이 정확하다.</p>
  </li>
  <li>
    <p>빠른 자가진단 스니펫<br />
혹시 그래도 타입이 애매하면, 아래를 한 번 찍어보면 어떤 필드를 쓰는지 바로 파악된다.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 디버그용
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">debug_list_tools</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">tools</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nf">type</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nf">type</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="sh">"</span><span class="s">no direct attrs</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># dict로 변환 가능하면 미리 확인
</span>        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">dict</span><span class="sh">"</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">  keys:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">list</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">dict</span><span class="p">().</span><span class="nf">keys</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">to_dict</span><span class="sh">"</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">  keys:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">list</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">to_dict</span><span class="p">().</span><span class="nf">keys</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">  keys:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">list</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">keys</span><span class="p">()))</span>
</code></pre></div></div>

<p>요약 정리<br />
문제 원인: FastMCP가 객체를 반환하는데 dict처럼 <code class="language-plaintext highlighter-rouge">t['name']</code>로 접근함.<br />
해결: <code class="language-plaintext highlighter-rouge">normalize_mcp_tool_meta()</code>로 dict/객체 양쪽을 지원하고, 필드명 변주까지 흡수. 그 결과를 OpenAI tools 포맷으로 직렬화.<br />
장점: FastMCP 구현이 바뀌거나 서버별로 메타 필드명이 달라도 안전. 네 로컬 ToolSpec과도 충돌 없이 합쳐서 쓸 수 있다.</p>

<p>이 패치만 적용하면 “Tool is not subscriptable” 에러는 사라지고, mcp 툴과 로컬 툴을 한 번의 Chat Completions 루프에서 안정적으로 섞어 실행할 수 있다.</p>

<p class="chat--user">

그런데 AsyncExitStackGroup에서 오픈 하는 중에 예외가 발생하면 어떻게 돼? 정리가 어떻게 돼?

</p>

<p>핵심만 말하면, 지금 만든 AsyncExitStackGroup은 “여럿을 차례로 열다 중간에 실패”했을 때 이미 열린 것들을 자동으로 닫아주지 않는다. <strong>aenter</strong> 도중 예외가 나면 __aexit__가 호출되지 않기 때문. 따라서 부분적으로 열린 리소스가 누수될 수 있다.</p>

<p>해결은 두 가지다.</p>

<ol>
  <li>표준 라이브러리 쓰기: contextlib.AsyncExitStack<br />
이게 바로 그런 상황을 안전하게 처리하라고 존재한다. 하나라도 열기에 실패하면, 그 이전에 성공한 컨텍스트들의 정리 함수가 역순으로 호출된다.</li>
</ol>

<p>예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">open_many</span><span class="p">(</span><span class="n">managers</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nc">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">managers</span><span class="p">:</span>
            <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stack</span><span class="p">.</span><span class="nf">enter_async_context</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
            <span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
        <span class="c1"># 여기까지 오면 모두 정상 오픈
</span>        <span class="c1"># opened를 사용
</span>        <span class="k">return</span> <span class="n">opened</span>
    <span class="c1"># 위 블록을 빠져나오면 모두 정리됨
</span></code></pre></div></div>

<ol>
  <li>네 커스텀 클래스를 안전하게 고치기<br />
AsyncExitStack과 같은 의미론을 직접 구현하려면, 열릴 때마다 “해당 컨텍스트의 __aexit__를 스택에 push”하고, 중간에 예외가 나면 이미 쌓아둔 __aexit__들을 역순으로 호출해야 한다.</li>
</ol>

<p>안전 버전</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AsyncExitStackGroup</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cms</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cms</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">cms</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_exits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_entered</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">:</span>
                <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">()</span>
                <span class="c1"># 정상 진입했으면, 대응 __aexit__를 스택에 저장
</span>                <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cm</span><span class="p">.</span><span class="n">__aexit__</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_entered</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_entered</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># 여기서 정리: 이미 진입했던 컨텍스트들을 역순으로 닫음
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_close_partial</span><span class="p">(</span><span class="n">exc_type</span><span class="o">=</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">exc</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="n">e</span><span class="p">.</span><span class="n">__traceback__</span><span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># 원래 예외를 그대로 전파
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_close_partial</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
        <span class="c1"># 예외 전파 여부: 여기서는 억제하지 않음(False)
</span>        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_close_partial</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">:</span>
            <span class="n">exit_cb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="nf">exit_cb</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># 정리 중 예외는 로그만 남기고 계속 진행하는 게 보통 안전
</span>                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_entered</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
</code></pre></div></div>

<p>비교 요약</p>

<ul>
  <li>
    <p>기존 구현: __aenter__에서 예외가 나면 이미 연 리소스가 남을 수 있음.</p>
  </li>
  <li>
    <p>개선 구현: __aenter__에서 예외가 나도 _close_partial이 호출되어 역순 정리됨.</p>
  </li>
  <li>
    <p>표준 AsyncExitStack: 같은 보증을 이미 제공. 가능하면 이걸 쓰는 게 가장 안전하고 간단.</p>
  </li>
</ul>

<p>추천 전략</p>

<ul>
  <li>
    <p>가능한 한 contextlib.AsyncExitStack을 사용하자. 기능 검증, 예외 전파, 정리 중 예외 처리까지 잘 되어 있다.</p>
  </li>
  <li>
    <p>직접 구현해야 한다면 위 개선 버전을 쓰고, 정리 중 예외는 삼키되 로깅하자. 운영 환경에서는 누수보다 정리 지속이 중요하다.</p>
  </li>
  <li>
    <p>정리 함수가 멱등적이어야 한다. 일부 MCP 커넥터는 중복 close/stop 호출이 들어와도 안전하게 무시하도록 만들어두는 편이 좋다.</p>
  </li>
  <li>
    <p>오픈과 정리 사이에 상태를 외부로 넘길 때는, 반환값 리스트(self._entered) 대신 이름→핸들 맵을 쓰면 추적이 쉽다.</p>
  </li>
</ul>

<p class="chat--user">

뭐야 그럼 첨에는 안전하지 않게 만들어줬던거야?

</p>

<p>맞다. 처음에 준 AsyncExitStackGroup은 예외 시 자동 정리를 보장하지 못했으니 안전하지 않았다. 내 실수다. 바로잡자.</p>

<p>단계별로 정리</p>

<ol>
  <li>
    <p>문제 핵심<br />
여러 컨텍스트를 순차로 여는 중 하나가 실패하면, 이미 열린 것들을 닫아줘야 한다. 직접 만든 단순 구현은 <strong>aenter</strong> 중 예외가 나면 __aexit__가 호출되지 않아 누수가 난다.</p>
  </li>
  <li>
    <p>가장 안전한 해결책<br />
파이썬 표준 contextlib.AsyncExitStack을 쓰면, 열 때마다 정리 콜백을 스택에 등록하므로 중간 실패 시 역순 정리가 자동으로 보장된다.</p>
  </li>
  <li>
    <p>표준 스택 사용 예시</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">open_many_safely</span><span class="p">(</span><span class="n">managers</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nc">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">managers</span><span class="p">:</span>
            <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stack</span><span class="p">.</span><span class="nf">enter_async_context</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
            <span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opened</span>
    <span class="c1"># 블록을 빠져나가면 자동으로 모두 정리됨
</span></code></pre></div></div>

<ol>
  <li>커스텀 클래스를 꼭 써야 한다면 안전 버전</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AsyncExitStackGroup</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cms</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cms</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">cms</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_exits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_entered</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">:</span>
                <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cm</span><span class="p">.</span><span class="n">__aexit__</span><span class="p">)</span>  <span class="c1"># 정리 콜백 스택에 push
</span>                <span class="n">self</span><span class="p">.</span><span class="n">_entered</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_entered</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_close_partial</span><span class="p">(</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">__traceback__</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_close_partial</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># 예외 억제 안 함
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_close_partial</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">:</span>
            <span class="n">exit_cb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="nf">exit_cb</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_entered</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
</code></pre></div></div>

<ol>
  <li>실전 권장<br />
가능하면 표준 AsyncExitStack으로 교체하라. 이미 검증된 보증을 제공하고, 정리 중 예외 처리도 일관적이다. 커스텀이 필요하면 위 안전 버전을 그대로 쓰면 된다.</li>
</ol>

<p>다음 액션<br />
기존 AsyncExitStackGroup을 전역 검색해서 두 가지 중 하나로 바꿔라.<br />
표준 스택으로 단순화하거나, 안전 버전으로 대체.<br />
이후 MCP 컨텍스트 매니저를 여럿 여는 모든 경로에서 누수 가능성이 사라진다.</p>

<p class="chat--user">

import contextlib async def open_many_safely(managers): async with contextlib.AsyncExitStack() as stack: opened = [] for cm in managers: entered = await stack.enter_async_context(cm) opened.append(entered) return opened # 블록을 빠져나가면 자동으로 모두 정리됨 이건 어떻게 쓰는건데? MCP 서버들을 열고 그걸 Agent에 argument로 넣고 실행한 뒤 그 후에 열린 서버들을 닫아야해

</p>

<p>맞는 흐름은 “열고 → 사용하는 동안 열어두고 → 끝나면 자동으로 닫기”다. 그래서 반환으로 꺼내는 함수가 아니라, “여러 컨텍스트를 열어둔 상태를 yield”하는 async 컨텍스트 매니저가 필요하다. 아래처럼 바꿔 쓰면 된다.</p>

<ol>
  <li>유틸: 여러 컨텍스트를 안전하게 열고 닫는 async 컨텍스트 매니저</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">contextlib</span>

<span class="nd">@contextlib.asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">open_many</span><span class="p">(</span><span class="n">managers</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nc">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">managers</span><span class="p">:</span>
            <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stack</span><span class="p">.</span><span class="nf">enter_async_context</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
            <span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
        <span class="c1"># 여기서 opened를 내보낸 뒤 with 블록이 끝날 때 자동으로 모두 닫힘
</span>        <span class="k">yield</span> <span class="n">opened</span>
</code></pre></div></div>

<ol>
  <li>사용 예시: MCP 서버들 열기 → Agent에 주입 → 실행 → 자동 정리</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 서버 컨텍스트 매니저들 준비
</span>    <span class="n">managers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerStdio</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
            <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">MCPServerSse</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
            <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># 2) 여러 서버를 안전하게 열고, 열린 핸들들을 에이전트에 넘김
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nf">open_many</span><span class="p">(</span><span class="n">managers</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened_servers</span><span class="p">:</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">PassThroughMCP</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 MCP 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="n">opened_servers</span><span class="p">,</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># 3) 에이전트 실행
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">files와 search MCP를 활용해 sales.csv 통찰을 요약해줘</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>
    <span class="c1"># 4) 여기 도달하면 opened_servers는 모두 자동으로 정리됨
</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트</p>

<ul>
  <li>
    <p>open_many는 with 블록이 유지되는 동안만 리소스를 열어둔다. 블록을 벗어나면 역순으로 안전하게 닫힌다.</p>
  </li>
  <li>
    <p>중간에 어떤 서버 열기에서 예외가 나도 이미 열린 것들은 AsyncExitStack이 알아서 닫아준다.</p>
  </li>
  <li>
    <p>Runner.run에서 예외가 나도 with 블록을 빠져나가며 정리가 보장된다.</p>
  </li>
</ul>

<p>이 패턴만 기억하면 “MCP 여러 대 열고 → Agent에 주고 → 끝나면 자동으로 닫기”가 항상 안전하게 동작한다.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python MCP 연결 방법</title><link href="https://hvppyarchive.github.io/llm/unified-mcp-interface/" rel="alternate" type="text/html" title="Python MCP 연결 방법" /><published>2025-10-29T16:22:58+09:00</published><updated>2025-10-29T16:22:58+09:00</updated><id>https://hvppyarchive.github.io/llm/unified-mcp-interface</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/unified-mcp-interface/"><![CDATA[<p class="chat--user">

너는 LLM Agent 전문가야. MCP 두 개 이상(이건 입력으로 커맨드를 여러개 받을 수 있어)을 띄우고 모든 MCP 툴을 LLM에게 전달 및 실행하고 싶어. 

</p>

<p>좋아, 여러 개의 MCP 서버를 동시에 붙여서 “모든 MCP 툴을 LLM이 한 번에 보고 실행”하게 만드는 방법을 두 가지 경로로 정리해줄게. 첫째는 Anthropic Messages API의 MCP 커넥터를 그대로 쓰는 방법(가장 간단). 둘째는 직접 MCP 클라이언트를 만들어 여러 서버에 붙고, 툴 카탈로그를 합쳐서 LLM에게 제공하는 방법(커스텀 제어). 단계별로 바로 따라하면 된다. 인용구문은 쓰지 않는다.</p>

<h1 id="1-가장-쉬운-길-claude-messages-api의-mcp-커넥터로-여러-서버-붙이기">1) 가장 쉬운 길: Claude Messages API의 MCP 커넥터로 여러 서버 붙이기</h1>

<p>핵심은 <code class="language-plaintext highlighter-rouge">messages.create</code> 호출에 <code class="language-plaintext highlighter-rouge">mcp_servers</code> 배열을 넣어 여러 서버를 동시에 선언하는 것. 서버마다 이름을 부여하면 충돌 없이 툴을 구분할 수 있고, 모델은 각 서버에서 노출된 MCP 툴을 필요할 때 호출한다. 베타 헤더가 필요하다.</p>

<p>요청 바디 예시(둘 이상의 서버 연결):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">"claude-sonnet-4-5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"max_tokens"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"두 서버의 툴을 모두 활용해서 작업을 끝내줘"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"mcp_servers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example1.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tool_configuration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example2.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>이 방식의 포인트</p>

<ol>
  <li>
    <p>한 요청에서 여러 MCP 서버의 툴을 모두 노출할 수 있다.</p>
  </li>
  <li>
    <p>서버 이름(<code class="language-plaintext highlighter-rouge">name</code>)이 툴 호출 블록에 함께 들어가서 충돌을 피한다.</p>
  </li>
  <li>
    <p>현재는 “MCP의 툴 호출”만 지원(리소스/프롬프트 등은 제외)되고, HTTP로 공개된 원격 서버만 직접 연결된다(로컬 stdio는 불가). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>
  </li>
</ol>

<p>문서 근거와 스펙<br />
• MCP 커넥터 사용법과 멀티 서버 예시는 Claude 공식 문서의 “MCP connector”와 “Multiple MCP servers” 섹션에 그대로 있다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• MCP 자체 개념과 스펙은 프로토콜 사이트와 스펙 문서 참고. <a href="https://modelcontextprotocol.io/?utm_source=chatgpt.com">모델 컨텍스트 프로토콜+1</a></p>

<p>이 경로로 가면 “LLM에게 MCP 툴 전체를 그대로 전달하고, 실행은 모델이 알아서 서버별로 라우팅”해준다. 운영에서 OAuth 토큰이 필요한 서버는 <code class="language-plaintext highlighter-rouge">authorization_token</code> 필드로 전달하면 된다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>

<h1 id="2-더-유연한-길-직접-mcp-클라이언트를-만들어-멀티-서버--단일-툴-레지스트리로-합치기">2) 더 유연한 길: 직접 MCP 클라이언트를 만들어 “멀티 서버 → 단일 툴 레지스트리”로 합치기</h1>

<p>로컬/사내용 툴까지 다 엮고 싶거나, 툴 노출/로그/권한을 섬세하게 통제하려면 직접 클라이언트를 만드는 편이 좋다. 공식 SDK가 있다(타입스크립트, 파이썬 등). <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>

<p>아키텍처 개요</p>

<ol>
  <li>
    <p>각 MCP 서버와 별도의 세션으로 연결(stdio 또는 HTTP).</p>
  </li>
  <li>
    <p>모든 서버에서 <code class="language-plaintext highlighter-rouge">list_tools</code>를 받아 합친다. 이때 충돌을 막기 위해 <code class="language-plaintext highlighter-rouge">serverName:toolName</code> 같은 네임스페이스를 붙인다.</p>
  </li>
  <li>
    <p>합쳐진 툴 목록을 LLM의 “도구(Function/Tool Use)”로 등록한다.</p>
  </li>
  <li>
    <p>LLM이 <code class="language-plaintext highlighter-rouge">serverName:toolName</code>을 호출하면, 해당 서버 세션으로 라우팅해서 <code class="language-plaintext highlighter-rouge">call_tool</code> 실행 → 결과를 모델에 <code class="language-plaintext highlighter-rouge">tool_result</code>로 되돌린다.</p>
  </li>
</ol>

<p>예시 코드(타입스크립트, Node). 여러 서버에서 툴을 모아 네임스페이스화하고, 호출 시 라우팅한다. SDK는 공식 TS SDK를 사용한다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

// package.json: @modelcontextprotocol/sdk, zod, anthropic 등 설치 가정
// npm i @modelcontextprotocol/sdk zod anthropic

import { ClientSession } from '@modelcontextprotocol/sdk/client/session.js';
import { StdioClientTransport, StdioServerParameters } from '@modelcontextprotocol/sdk/client/stdio.js';
import Anthropic from '@anthropic-ai/sdk';

// 서버 설정
type ServerCfg = { name: string; command: string; args: string[] };
const SERVERS: ServerCfg[] = [
  { name: 'files', command: 'node', args: ['./servers/files/index.js'] },
  { name: 'db', command: 'python', args: ['./servers/db/server.py'] },
];

type Connected = {
  name: string;
  session: ClientSession;
};

const connected: Connected[] = [];

async function connectAll() {
  for (const s of SERVERS) {
    const params: StdioServerParameters = { command: s.command, args: s.args };
    const transport = new StdioClientTransport(params);
    await transport.start();
    const session = new ClientSession(transport);
    await session.initialize();
    connected.push({ name: s.name, session });
    console.log(`[MCP] connected: ${s.name}`);
  }
}

type ToolDesc = {
  name: string;              // namespaced: `${server}:${tool}`
  description?: string;
  input_schema: any;         // JSON Schema
};

// 모든 서버의 툴을 수집하여 네임스페이스 부여
async function collectTools(): Promise&lt;ToolDesc[]&gt; {
  const all: ToolDesc[] = [];
  for (const { name: serverName, session } of connected) {
    const { tools } = await session.listTools();
    for (const t of tools) {
      all.push({
        name: `${serverName}:${t.name}`,
        description: t.description,
        input_schema: t.inputSchema,
      });
    }
  }
  return all;
}

// LLM이 namespaced 툴을 호출하면 해당 서버로 라우팅
async function callNamespacedTool(nsName: string, args: any) {
  const [serverName, toolName] = nsName.split(':');
  const target = connected.find(c =&gt; c.name === serverName);
  if (!target) throw new Error(`Server not found: ${serverName}`);
  return target.session.callTool(toolName, args);
}

async function main() {
  await connectAll();
  const tools = await collectTools();

  const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! });

  // 대화 루프의 한 턴 예시
  let messages: any[] = [{ role: 'user', content: 'CSV를 DB에 적재하고 요약해줘' }];

  // Anthropic의 Tool Use 포맷에 맞춰 툴 전달
  const toolDefs = tools.map(t =&gt; ({
    name: t.name,
    description: t.description,
    input_schema: t.input_schema,
  }));

  let resp = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 1000,
    messages,
    tools: toolDefs,
  });

  // tool_use 처리 루프
  while (resp.content.some((c: any) =&gt; c.type === 'tool_use')) {
    const assistantContent: any[] = [];
    const toolResults: any[] = [];

    for (const c of resp.content) {
      if (c.type === 'text') assistantContent.push(c);
      if (c.type === 'tool_use') {
        const result = await callNamespacedTool(c.name, c.input);
        toolResults.push({
          type: 'tool_result',
          tool_use_id: c.id,
          content: result.content, // MCP 표준 content 배열
        });
      }
    }

    messages.push({ role: 'assistant', content: assistantContent.concat(resp.content.filter((c: any) =&gt; c.type === 'tool_use')) });
    messages.push({ role: 'user', content: toolResults });

    resp = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1000,
      messages,
      tools: toolDefs,
    });
  }

  console.log(resp.content.map((c: any) =&gt; (c.type === 'text' ? c.text : '')).join('\n'));
}

main().catch(e =&gt; { console.error(e); process.exit(1); });
</code></pre></div></div>

<p>이 패턴의 장점<br />
• 어떤 LLM이든(Anthropic/OpenAI/로컬) 표준 “툴 호출” 인터페이스만 있으면 같은 레지스트리를 재활용할 수 있다.<br />
• 서버별 권한, 로깅, 레이트 리밋, 입력 검증을 중앙에서 통제 가능.<br />
• 네임스페이스 전략으로 툴 이름 충돌을 확실히 방지.<br />
• stdio 로컬 서버와 원격 HTTP 서버를 섞어서 붙일 수 있다(직접 클라이언트 방식이므로). SDK가 stdio/HTTP 모두 지원한다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>설치·참고<br />
• 공식 TS SDK와 예제 서버/클라이언트, Streamable HTTP/stdio 전송계층은 깃허브 README와 예제에 상세. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a><br />
• “Build an MCP client” 튜토리얼(파이썬/노드 포함)도 멀티 서버로 확장하기 쉽다. 위 예시 로직은 그 흐름을 일반화한 것. <a href="https://modelcontextprotocol.io/quickstart/client">모델 컨텍스트 프로토콜</a></p>

<h1 id="운영-팁과-함정실무-체크리스트">운영 팁과 함정(실무 체크리스트)</h1>

<p>네임스페이스 규칙<br />
• <code class="language-plaintext highlighter-rouge">${server}:${tool}</code>로 고정하면 라우팅이 단순해진다. 툴 설명에도 서버명을 적어 LLM의 선택을 돕는다.<br />
• 모델이 “비슷한 두 툴”을 혼동할 수 있으니 설명에 차이를 명확히 쓰고 스키마에 제약을 넣는다.</p>

<p>권한과 안전장치<br />
• 서버별 <code class="language-plaintext highlighter-rouge">allowed_tools</code>로 노출 툴을 제한하거나, 자체 클라이언트라면 툴 화이트리스트를 적용한다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• 파괴적 툴(삭제/결제 등)은 “dry_run” 플래그를 스키마에 추가해 2단계 확인을 강제.<br />
• 프롬프트 인젝션 방지: 서버 측에서 입력 검증과 URL/경로 화이트리스트를 둔다.</p>

<p>성능/안정성<br />
• 초기에 모든 서버에 <code class="language-plaintext highlighter-rouge">list_tools</code>를 한 번만 호출하고 캐싱하라.<br />
• 툴 호출은 타임아웃과 재시도를 둔다. 실패 시 에러 메시지와 복구 힌트를 모델에게 짧게 제공하면 후속 계획을 모델이 스스로 조정한다.<br />
• 결과가 큰 경우(파일/표)는 리소스 링크를 반환하도록 MCP 쪽에서 설계하면 토큰 압박을 줄일 수 있다(리소스는 커넥터 경로에 따라 제한될 수 있음).</p>

<p>배포 토막 가이드<br />
• 원격 연결 위주면 Claude의 MCP 커넥터가 가장 빠른 온보딩이다(단, HTTP 공개 필요). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• 사내망·로컬 혼합이면 직접 클라이언트 구성이 유리하다. TS SDK의 streamable HTTP + stdio를 혼용하면 된다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>다음 확장 아이디어<br />
• “자동 라우터”: 툴 메타데이터에 domain 태그를 두고, 사용자 요청을 분류해 관련 서버 툴만 모델에 노출(토큰/혼란 감소).<br />
• “관측성”: 모든 tool_use/tool_result를 이벤트로 로그 수집해 실패율/지연/입력 분포를 대시보드로 본다.<br />
• “권한 승격”: 고위험 툴 호출은 사람 확인을 요구하는 인가 훅을 중앙 클라이언트에 추가.</p>

<p>원하면 네가 쓰려는 서버 목록과 전송 방식(stdio/HTTP), 붙일 모델(Claude/OpenAI 등)을 알려줘. 거기에 맞춰 완성 스캐폴딩을 바로 내줄게.</p>

<p class="chat--user">

타입스크립트 말고 파이썬 mcp 로 부탁해 그리고 커스텀 엔드포인트 LLM을 사용할거야.

</p>

<p>좋아. 파이썬으로 MCP 다중 서버를 붙이고, 커스텀 LLM 엔드포인트(자체 호스팅 모델)에 “툴 콜링”을 돌리는 전체 오케스트레이터 스캐폴딩을 바로 줄게. 핵심 아이디어는 두 가지다. 첫째, 여러 MCP 서버에 각각 세션을 열고 툴 목록을 합쳐서 네임스페이스(server:tool)로 노출. 둘째, 커스텀 LLM의 /chat API에 툴 스키마를 전달하고, 응답 내 tool_calls를 받아 해당 MCP 서버로 라우팅해 실행 결과를 다시 모델에 피드백하는 루프를 돈다.</p>

<p>아래 코드는 바로 실행 가능한 단일 파일 예시다. 커스텀 LLM의 API 포맷은 OpenAI 함수콜과 유사한 형태를 가정했지만, 클래스 한 군데만 바꾸면 어떤 엔드포인트든 맞출 수 있도록 어댑터를 분리해두었다.</p>

<p>설치 가정<br />
pip install mcp requests pydantic orjson</p>

<p>main.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># 선택: SSE(원격 HTTP) 서버를 붙일 때
</span>    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#######################################################################
# 0) 데이터 모델: LLM과 툴콜 인터페이스(커스텀 엔드포인트 어댑터용)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI style에 가깝게 노멀라이즈해 커스텀 LLM에 전달
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(JSON str)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># 필요 시 stop_reason 등 추가
</span>
<span class="c1">#######################################################################
# 1) MCP 연결 유틸: 여러 서버 연결하고 툴 합치기(네임스페이스)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># stdio 또는 sse
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># sse
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 설치되어야 SSE 연결을 사용할 수 있습니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="c1"># t.name, t.description, t.input_schema
</span>                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># JSON Schema
</span>                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># namespaced = "server:tool"
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">툴 이름은 </span><span class="sh">'</span><span class="s">server:tool</span><span class="sh">'</span><span class="s"> 형식이어야 합니다: </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server_name</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="c1"># MCP 표준 content를 단일 문자열 또는 JSON으로 정리
</span>                <span class="c1"># MCP content는 list of {type: "text"|"json"|"blob", ...}
</span>                <span class="c1"># 여기서는 간단히 text/json만 지원 예시
</span>                <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># blob/resource 등은 필요 시 확장
</span>                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">서버를 찾을 수 없음: </span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1">#######################################################################
# 2) 커스텀 LLM 어댑터: 너의 사설 /chat 엔드포인트에 맞춰 조정
#######################################################################
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    너의 커스텀 엔드포인트 규약을 한 곳에 캡슐화.
    아래는 예시 규약:
      POST {base_url}/chat
      json: {
        </span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}],
        </span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...}}}]
      }
    응답:
      {
        </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">assistant text...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [
          {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">{</span><span class="se">\"</span><span class="s">k</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">v</span><span class="se">\"</span><span class="s">}</span><span class="sh">"</span><span class="s">}}
        ]
      }
    필요한 경우 이 클래스만 수정하면 된다.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">extra_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span> <span class="o">=</span> <span class="n">extra_headers</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span> <span class="k">if</span> <span class="n">tools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

<span class="c1">#######################################################################
# 3) 오케스트레이터: 툴 병합 → LLM 대화 루프 → MCP 라우팅
#######################################################################
</span>
<span class="k">def</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">merged_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
    <span class="n">defs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">merged_tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP tool </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="p">}</span>
        <span class="n">defs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">defs</span>

<span class="k">def</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">args_raw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">args_raw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args_raw</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args_raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sh">""</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 모델이 JSON이 아닌 걸 내는 경우 방어
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_conversation</span><span class="p">(</span>
    <span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">):</span>
    <span class="n">tools_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">llm_tools</span> <span class="o">=</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">tools_catalog</span><span class="p">)</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">system_prompt</span><span class="p">:</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">))</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">llm_tools</span><span class="p">)</span>
        <span class="c1"># 우선 어시스턴트 텍스트가 있으면 추가
</span>        <span class="n">assistant_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="n">assistant_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">assistant_text</span><span class="p">))</span>

        <span class="c1"># 툴콜 없으면 종료
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># MCP 라우팅 → 결과를 tool_result로 user에 피드백
</span>        <span class="n">tool_results_acc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="c1"># 결과를 다시 모델에게 피드백: 단순화를 위해 JSON 텍스트로 합침
</span>                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="c1"># 다수 툴 호출 결과를 하나의 user 메시지로 재주입
</span>        <span class="n">feedback_text</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tool_results_acc</span><span class="p">)</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="si">{</span><span class="n">feedback_text</span><span class="si">}</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1">#######################################################################
# 4) 샘플 엔트리포인트
#######################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 4-1) 붙일 MCP 서버들 정의
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># 로컬 stdio 예시
</span>        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># 원격 SSE 예시(있다면)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"authorization":"Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>

    <span class="c1"># 4-2) 커스텀 LLM 엔드포인트 설정
</span>    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_API_KEY</span><span class="sh">"</span><span class="p">),</span>            <span class="c1"># 필요 시
</span>        <span class="n">extra_headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">x-tenant</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo</span><span class="sh">"</span><span class="p">}</span>                 <span class="c1"># 필요 시
</span>    <span class="p">)</span>

    <span class="c1"># 4-3) 대화 한 턴 예시
</span>    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">너는 MCP 툴을 활용해 일을 끝내는 에이전트다. 위험 작업은 dry_run을 선호하고, 명시적으로 승인받기 전에는 파괴적 변경을 하지 않는다.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSV를 files 서버의 ingest_csv 툴로 적재하고, db 서버의 sql_summary로 요약해줘. 파일 경로는 ./data/sales.csv</span><span class="sh">"</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_conversation</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 대화 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">2000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>동작 흐름 설명<br />
1단계. MCPMux가 각 서버에 세션을 연다. stdio 서버는 command+args로 프로세스를 실행하고, sse 서버는 HTTP SSE로 연결한다.<br />
2단계. list_tools를 모든 서버에서 모아서 네임스페이스(server:tool)로 변환한다.<br />
3단계. 커스텀 LLM 엔드포인트에 messages와 tools를 넘긴다. tools는 OpenAI식 function 포맷으로 정규화해서 전달한다.<br />
4단계. LLM이 tool_calls를 반환하면, 각 call의 function.name이 server:tool이므로 해당 서버로 라우팅해서 call_tool을 실행한다.<br />
5단계. 결과를 TOOL_RESULTS 텍스트로 user 역할 메시지에 합쳐서 모델에 다시 주입한다. 모델은 추가적인 tool_calls를 내거나, 최종 답변을 낸다.<br />
6단계. tool_calls가 더 이상 없으면 루프 종료.</p>

<p>운영 팁<br />
네임스페이스 고정. server:tool 네이밍을 스키마 description에도 반복해서 LLM의 선택 오류를 줄인다.<br />
권한 경계. 삭제·결제·배포 같은 툴에는 parameters에 dry_run(boolean, default true) 같은 필드를 추가해 2단계 승인을 유도하라.<br />
타임아웃·재시도. SSE나 stdio 모두 외부 프로세스/네트워크에 민감하니 call_tool에는 서버 측 타임아웃과 재시도를 둔다. 필요 시 MCPMux.call에 재시도를 추가하라.<br />
대용량 결과. 파일·표·바이너리 결과는 MCP 리소스(파일 핸들)나 외부 저장소 URL을 반환하고, LLM에는 메타데이터만 보내 토큰을 아끼는 설계를 추천한다.<br />
적응층. CustomLLMClient를 너의 실제 /chat 규격에 맞게 수정한다. 예컨대 문서화된 JSON 키 이름이 다르면 ChatResponse 파싱만 바꾸면 된다.</p>

<p>테스트 방법<br />
가짜 서버부터. servers 디렉터리에 echo 수준의 간단한 MCP 서버 두 개(files, db)를 만들어 list_tools와 call_tool만 최소 구현한다.<br />
단위 테스트. CustomLLMClient.send를 모킹해 tool_calls를 강제로 내보내고, MCPMux.call이 올바른 서버로 라우팅되는지 확인한다.<br />
엔드투엔드. 실제 LLM 엔드포인트로 교체해 CSV → SQL 요약 같은 워크플로를 한 번에 돌려본다.</p>

<p>확장 아이디어<br />
자동 라우팅. 도메인 태그(files/db/search 등)를 보고 관련 툴만 tools 배열에 노출해 토큰과 혼란을 줄인다.<br />
감사 로그. 모든 tool_call 입력·출력을 JSONL로 파일에 적재해 지연, 실패율, 위험 호출을 모니터링한다.<br />
휴먼 게이트. 위험한 툴콜이 감지되면 CustomLLMClient로 바로 보내지 말고, 별도 승인 UI 혹은 CLI에서 1회 승인 후 재주입한다.</p>

<p>원하는 /chat 규격(JSON 예시 스펙)이나 실제 엔드포인트 샘플을 알려주면, 위 어댑터를 거기에 딱 맞춰 구체화해서 리라이트해줄 수 있다.</p>

<p class="chat--user">

질문이 있어. 1. 그냥 툴을 그대로 보내면 오류가 더 많을까? 2. 일반 툴 콜링과 섞여 있는 예시도 보여주면 좋겠어. 

</p>

<p>좋아, 두 가지 모두 딱 꽂히게 정리해줄게. 결론 먼저, 그다음 바로 실행 가능한 파이썬 예시로 마무리한다.</p>

<ol>
  <li>그냥 “서버에서 받은 툴을 전부” 모델에 그대로 보여주면 오류가 더 많을까?<br />
짧은 답: 보통 그렇다. 이유는 예측 가능하다.</li>
</ol>

<ul>
  <li>
    <p>과적재(too many tools). 툴이 많아질수록 선택 오류가 늘고, 모델이 비슷한 툴을 혼동한다. 비슷한 이름, 비슷한 설명은 특히 위험하다.</p>
  </li>
  <li>
    <p>스키마 느슨함. parameters(JSON Schema)에 타입·필수 필드·enum 제약이 약하면 arguments 형식 오류가 증가한다.</p>
  </li>
  <li>
    <p>문맥 미스매치. 현재 턴과 관계없는 툴까지 모두 보이면 “근처에 있는 도구” 편향 때문에 엉뚱한 걸 집는다.</p>
  </li>
  <li>
    <p>네임 충돌·의도 충돌. 서로 다른 서버에 같은 이름, 유사 기능이 있으면 라우팅·선택 모두 흔들린다.</p>
  </li>
  <li>
    <p>부작용 위험. 삭제/결제/배포 같은 툴을 아무 맥락 없이 노출하면 모델이 성급히 실행하려 한다(모델은 과감하다).</p>
  </li>
  <li>
    <p>레이턴시·실패 전파. 원격/SSE 툴 다수는 타임아웃과 429가 뒤섞여 에러 증폭을 만든다.</p>
  </li>
</ul>

<p>현업에서 에러를 줄이는 실전 처방</p>

<ul>
  <li>
    <p>턴별 툴 소출(Selective exposure). 유저 입력을 기준으로 관련 서버/도메인의 툴만 노출한다. 단순 키워드 라우팅만 넣어도 실패율이 뚝 떨어진다.</p>
  </li>
  <li>
    <p>네임스페이스 필수. server:tool 이름으로 고정하고, description에도 서버/도메인을 반복 명시한다.</p>
  </li>
  <li>
    <p>스키마를 엄격하게. type/enum/minItems/format까지 빡빡하게 걸어라. 가능하면 예제(example) 필드까지 넣는다.</p>
  </li>
  <li>
    <p>고위험 툴에 세이프티 플래그. dry_run 기본값 true, confirmation string 같은 이중 잠금.</p>
  </li>
  <li>
    <p>응답 정규화. MCP tool_result를 항상 같은 JSON 포맷으로 묶어 모델에 재주입해 학습된 기대 형태를 유지한다.</p>
  </li>
  <li>
    <p>타임아웃/재시도/백오프 표준화. 서버별 기본값이 달라도 클라이언트에서 상한을 통일한다.</p>
  </li>
  <li>
    <p>툴 캡. 한 턴에 최대 10~20개 정도만 노출(경험상 8~12에서 가장 안정적).</p>
  </li>
</ul>

<ol>
  <li>“일반 툴 콜링”과 “MCP 툴 콜링”이 섞여 있는 예시<br />
아래는 이전 파이썬 스캐폴딩을 얇게 확장한 버전이다. 핵심은 디스패처에 로컬(일반) 툴 네임스페이스 local.* 를 추가하고, LLM이 같은 턴에서 local.* 과 server:tool(MCP)을 섞어서 호출해도 자연스럽게 라우팅되는 구조다.</li>
</ol>

<p>필요 패키지<br />
pip install mcp requests pydantic orjson</p>

<p>mixed_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="c1"># ======== 공용 데이터 모델 ========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># ======== MCP 멀티 서버 MUX ========
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ======== 로컬(일반) 툴: 예시 구현 ========
</span>
<span class="k">def</span> <span class="nf">local_tools_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전한 사칙연산/간단식 평가기. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">텍스트에서 자주 등장하는 단어 상위 K를 뽑아준다. 입력: {text: string, k: integer}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># 아주 보수적인 계산기(숫자, + - * / () 만 허용)
</span>        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}}]}</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">collections</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[A-Za-z0-9가-힣]+</span><span class="sh">"</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="nc">Counter</span><span class="p">([</span><span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">])</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">.</span><span class="nf">most_common</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">top</span><span class="sh">"</span><span class="p">:</span> <span class="n">top</span><span class="p">}}]}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ======== 커스텀 LLM 어댑터(예시) ========
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>

<span class="c1"># ======== 툴 노출 전략(간단 소출 예시) ========
</span>
<span class="k">def</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">keep</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">user_text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>

    <span class="c1"># 키워드 기반 라우팅(아주 얕은 예시)
</span>    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ingest</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">load</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">데이터베이스</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">요약</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">summary</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># 항상 노출할 로컬 도구
</span>    <span class="n">local_basics</span> <span class="o">=</span> <span class="nf">local_tools_catalog</span><span class="p">()</span>

    <span class="c1"># 중복 제거 및 이름 네임스페이스 적용
</span>    <span class="k">def</span> <span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

    <span class="n">uniq</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
        <span class="n">uniq</span><span class="p">[(</span><span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">tooldefs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">uniq</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>
    <span class="n">tooldefs</span> <span class="o">+=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]})</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">local_basics</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tooldefs</span>

<span class="c1"># ======== 대화 루프 ========
</span>
<span class="k">def</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>
    <span class="n">all_mcp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system</span><span class="p">),</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">tools_exposed</span> <span class="o">=</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">)</span>  <span class="c1"># 턴별 소출
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools_exposed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># 섞여 있는 툴콜 처리: local.* ↔ server:tool
</span>        <span class="n">results_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_texts</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ======== 실행 예시 ========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
    <span class="p">])</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">너는 안전하고 신중한 에이전트다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSV를 적재하고(sql 요약까지). 수치 확인은 계산기로 한번 검증해줘. 파일은 ./data/sales.csv 이야.</span><span class="sh">"</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== LOG ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>이 코드에서 확인할 수 있는 것</p>

<ul>
  <li>
    <p>한 턴에 LLM이 local.math_eval(일반 툴)과 files:ingest_csv(MCP) / db:sql_summary(MCP)를 섞어 호출해도 디스패처가 각각 맞는 경로로 라우팅한다.</p>
  </li>
  <li>
    <p>selective_expose가 턴별 툴 소출을 해준다. 유저 요청에 필요 없는 서버 툴은 숨겨서 혼란과 에러를 줄인다.</p>
  </li>
  <li>
    <p>로컬 툴은 파이썬 함수로 바로 처리하므로 레이턴시가 적고, 간단한 검증·후처리(예: 계산으로 sanity-check)를 빠르게 수행할 수 있다.</p>
  </li>
</ul>

<p>마지막으로, 에러를 더 줄이려면</p>

<ul>
  <li>
    <p>툴 설명에 “언제 쓰는지/언제 쓰지 말아야 하는지”를 한 문장씩 명시한다.</p>
  </li>
  <li>
    <p>위험 툴의 parameters에 confirm 문자열(예: "I understand this deletes data")을 required로 추가한다.</p>
  </li>
  <li>
    <p>TOOL_RESULTS 포맷을 팀 공통 JSON 스키마로 고정해 모델이 예측 가능한 후속 계획을 세우도록 한다.</p>
  </li>
  <li>
    <p>각 서버/툴별 타임아웃·재시도·서킷브레이커를 공통 미들웨어로 묶는다.</p>
  </li>
</ul>

<p>여기까지면 커스텀 LLM 엔드포인트에서도 “일반+MCP 혼합 툴콜”을 안정적으로 돌릴 수 있다. 다음 단계는 네가 쓰는 /chat 스펙에 맞춰 CustomLLMClient의 직렬화/역직렬화 부분만 미세조정하고, 실제 서버 두 개(files/db) 최소 구현으로 E2E를 한 번 굴려보는 것이다.</p>

<p class="chat--user">

오호. 다음은 어려운 문제야. 이걸 openai agent python sdk에 붙일 수 있을까?

</p>

<p>가능하다. 게다가 “여러 MCP 서버”와 “커스텀 LLM 엔드포인트”를 동시에 쓰는 구성이 OpenAI Agents Python SDK에서 정석으로 지원된다. 요점만 단계별로 정리하고, 바로 돌아가는 최소 예시를 준다.</p>

<p>핵심 정리</p>

<ol>
  <li>
    <p>Agents SDK는 MCP를 4가지 전송으로 붙인다: Hosted MCP(Responses API가 원격서버를 직접 호출), Streamable HTTP, HTTP+SSE, stdio(로컬 프로세스). 서버 여러 개를 mcp_servers 리스트에 넣으면 한 에이전트가 전부를 본다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>모델은 OpenAI 모델 말고도 LiteLLM 확장을 통해 “OpenAI 호환 REST”로 노출된 임의의 엔드포인트를 모델처럼 쓸 수 있다. base_url만 네 엔드포인트로 바꾸면 된다. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Hosted MCP를 쓰면 OpenAI 인프라가 원격 MCP 서버를 직접 호출하므로 파이썬 쪽 콜백이 필요 없다(공개 접근 가능한 원격 서버에 적합). 반대로 사내망/로컬은 stdio·SSE 등 “직접 붙이기”가 맞다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Agents SDK에는 MCP 전용 클래스들이 이미 들어있다(MCPServerStdio, MCPServerSse, MCPServerStreamableHttp, HostedMCPTool 등). <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub+1</a></p>
  </li>
</ol>

<p>빠른 스캐폴딩(파이썬)<br />
설치<br />
pip install openai-agents mcp</p>

<p>예시 1) 커스텀 LLM(base_url) + stdio/SSE MCP 다중 서버 한 번에 붙이기<br />
아래는 파일시스템 MCP를 로컬(stdio)로, 사내용 검색 MCP를 SSE로 붙이고, 모델은 너의 커스텀 /v1 Chat 호환 엔드포인트를 씀.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>  <span class="c1"># 커스텀 엔드포인트용
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 서버들을 context manager로 기동/연결
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer XYZ</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="c1"># 2) 커스텀 LLM 엔드포인트(OpenAI 호환) 모델로 지정
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>                 <span class="c1"># 엔진/이름
</span>            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>     <span class="c1"># 네 엔드포인트
</span>            <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">sk-your-key</span><span class="sh">"</span><span class="p">,</span>                   <span class="c1"># 필요시
</span>        <span class="p">)</span>

        <span class="c1"># 3) 에이전트 구성: 여러 MCP 서버를 한 번에 노출
</span>        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Orchestrator</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP 툴을 안전하게 사용하고, 필요할 때만 호출한다.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 필요 시 "required"로 강제
</span>        <span class="p">)</span>

        <span class="c1"># 4) 실행
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더의 CSV를 읽고, search 서버로 관련 문서 찾아 요약해줘</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>예시 2) Hosted MCP를 섞는 변형<br />
원격에 공개된 MCP 서버는 HostedMCPTool 하나만 tools에 넣으면 모델이 OpenAI 인프라에서 직접 목록조회/호출까지 한다. 파이썬 쪽 콜백이 거의 없다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">HostedMCPTool</span>

<span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">HostedMCPUser</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="nc">HostedMCPTool</span><span class="p">(</span><span class="n">tool_config</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_label</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gitmcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://gitmcp.io/openai/codex</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">require_approval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">})],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">이 저장소의 주요 언어를 알려줘</span><span class="sh">"</span><span class="p">).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>위 두 방식은 공식 문서의 사용법과 동일한 흐름이다. Hosted MCP, stdio/SSE/HTTP 서버, 툴 필터링, 승인 훅까지 포함된 가이드를 참고해 세부옵션을 맞추면 된다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>

<p>툴 소출 전략(오류 줄이는 팁)</p>

<ol>
  <li>
    <p>툴 필터링: 서버 생성자에 tool_filter를 걸거나 정적/동적 필터를 써서 턴별로 필요한 툴만 노출하라. SDK가 도우미를 제공한다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>위험 툴 승인: HostedMCPTool은 require_approval 및 on_approval_request 콜백으로 민감 작업을 승인 플로로 감싼다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>캐싱과 재시도: cache_tools_list, max_retry_attempts 등 옵션으로 지연과 실패 확률을 줄일 수 있다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
</ol>

<p>한 줄 결론<br />
OpenAI Agents Python SDK에 네가 만든 “멀티 MCP + 커스텀 LLM 엔드포인트”를 그대로 붙일 수 있다. 모델은 LiteLLMModel로 커스텀 REST를 쓰고, MCP는 mcp_servers에 여러 개를 열거하거나 HostedMCPTool을 병용하면 된다. 필요하면 너의 엔드포인트 스펙에 맞춰 모델 어댑터를 더 촘촘하게 설정하는 코드도 만들어주겠다. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub+2</a></p>

<p class="chat--user">

아니 난 너가 만든 코드를 그대로 쓰고 싶어. 왜냐면 이렇게 만든 인터페이스를 다른 Chat 에도 쓰고 싶거든. Agent만을 위한 다른 코드가 분기 되는 것이 싫어. Tool만 입력해서 동작하게 하는 방법 없어?

</p>

<p>좋아. “Agent 전용 분기 없이” 너가 만든 인터페이스를 어떤 Chat에도 재사용하려면, 입력은 오직 툴(=프로바이더)과 LLM 엔드포인트만 주고 돌아가는 얇은 오케스트레이터가 필요하다. 아래는 그 목적에 맞춘 단일 파일 스캐폴딩이다. 핵심은 세 가지 인터페이스다.</p>

<ol>
  <li>
    <p>ChatBackend: 어떤 채팅 모델이든 붙일 수 있는 백엔드 어댑터.</p>
  </li>
  <li>
    <p>ToolProvider: 툴 카탈로그를 노출하고 호출을 처리하는 표준 인터페이스.</p>
  </li>
  <li>
    <p>Orchestrator: messages + tools만으로 루프를 돌린다. 어떤 에이전트 SDK 분기도 없다.</p>
  </li>
</ol>

<p>설치<br />
pip install mcp requests pydantic orjson</p>

<p>tools_only.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== 공통 데이터 모델 ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI/함수콜 호환 포맷으로 통일
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(str or dict)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    OpenAI Chat Completions 호환(또는 유사) 엔드포인트용 백엔드.
    /v1/chat/completions 또는 /chat 같은 곳에 맞춰 최소한의 어댑터만 제공.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>  <span class="c1"># "/v1/chat/completions"로 바꿔도 됨
</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="c1"># 서버 규격에 맞게 필요한 키만 담는다. 필요시 여기만 수정.
</span>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="c1"># data를 ChatResponse로 매핑; 너의 엔드포인트 규격에 맞게 여기만 조정하면 된다.
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 2) ToolProvider 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ToolProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span> <span class="bp">...</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>

<span class="c1"># ---- 2-1) MCP 프로바이더 (여러 서버 포함) ----
# mcp 설치 필요
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># 네임스페이스
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="c1"># 동기 인터페이스 요구 때문에 캐시 기반. 최초 호출 전에 warmup()을 호출하거나,
</span>        <span class="c1"># Orchestrator가 응답 전 await ensure_ready()를 한 번 수행.
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await provider.ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="c1"># list_tools는 async라 여기서 미리 모은다.
</span>        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># tool_name은 "server:tool"이어야 함
</span>        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server namespace: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ---- 2-2) 로컬 툴 프로바이더(선택) ----
</span>
<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                    <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (도구만 입력해서 동작) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    목적: 툴만 입력해서 동작. 어떤 Chat(백엔드)에도 재사용.
    - providers: ToolProvider들의 리스트
    - backend: ChatBackend 구현체 1개
    - expose_fn: 선택적으로 </span><span class="sh">'</span><span class="s">툴 소출</span><span class="sh">'</span><span class="s"> 전략을 주입 (기본값: 전부 노출)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolProvider</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># MCPProvider 같은 async 준비가 필요한 프로바이더를 워밍업
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 각 프로바이더가 책임지는 네임스페이스로 라우팅
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># 빠른 판별: MCP는 "server:" 네임스페이스, 로컬은 "local." 같은 규칙 추천
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">):</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>  <span class="c1"># server:tool
</span>                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># 마지막 fallback: 모든 provider에 시도
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider could handle tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="c1"># 툴 카탈로그를 수집하고 소출 전략 적용
</span>            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="c1"># 모델에게 도구결과를 일괄 재주입
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 서버들: 필요 서버만 나열
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>

    <span class="c1"># 2) 로컬 툴(선택)
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># 3) 어떤 Chat이든 붙일 백엔드. base_url과 path만 맞추면 끝.
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span>               <span class="c1"># 필요에 따라 "/v1/chat/completions" 등으로 변경
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) 오케스트레이터: 입력은 “툴(프로바이더)”뿐
</span>    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="c1"># 간단 소출: 파일/SQL 관련 단어가 없으면 MCP를 숨기고 로컬만 노출
</span>        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSV를 읽고 합계를 계산한 뒤 수치가 맞는지 계산기로 검증해줘. 파일은 ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 MCP 툴을 신중히 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>설명과 사용법 요약<br />
입력은 툴(프로바이더)만 넘긴다. 오케스트레이터는 툴 카탈로그를 합치고, LLM 응답의 tool_calls를 받아 적절한 프로바이더로 라우팅한다. 특정 에이전트 SDK 분기가 전혀 없다. 다른 Chat 백엔드로 바꾸고 싶으면 OpenAICompatibleBackend만 교체하거나 send 메소드가 동일한 시그니처를 가지는 새 클래스를 하나 추가하면 된다.</p>

<p>운영 팁<br />
툴 소출 함수(expose_fn)로 턴별 필터링을 꼭 넣자. 단순 키워드만으로도 선택 오류와 불필요 호출이 크게 준다.<br />
네임스페이스를 일관되게 유지하자. MCP는 server:tool, 로컬은 local.*처럼 구분하면 충돌이 없다.<br />
고위험 툴은 parameters에 dry_run, confirm 문자열 같은 제약을 넣어야 한다.<br />
대용량 결과는 MCP 서버가 파일 핸들(리소스)로 반환하고, 모델에는 요약/메타데이터만 재주입해 토큰을 아끼자.</p>

<p>이 구조면 같은 Orchestrator를 그대로 두고, 어떤 Chat UI/엔진에도 쉽게 이식할 수 있다. 필요하면 네 엔드포인트의 정확한 JSON 규격을 알려줘. OpenAICompatibleBackend의 매핑만 10줄쯤 손보면 바로 물릴 수 있게 맞춰줄 수 있다.</p>

<p class="chat--user">

이건 또 openai agent는 안 쓰는 것 같은데

</p>

<p>맞아, 방금 준 스캐폴딩은 “오픈AI Agents SDK”를 쓰지 않는 순수 오케스트레이터였지. 너가 원하는 건 그 코드를 그대로 유지하면서, 백엔드만 갈아끼워 “OpenAI Agents Python SDK”를 LLM 백엔드로 사용할 수 있게 하는 것. 아래처럼 백엔드 어댑터 하나만 추가하면 된다. 오케스트레이터·툴 프로바이더·라우팅은 그대로 재사용하고, 에이전트 SDK는 단지 “텍스트+툴콜 JSON을 뱉는 모델 백엔드”로만 쓴다. 즉, Agents SDK에게 MCP 실행을 맡기지 않고, 우리가 만든 라우터가 계속 MCP를 호출한다.</p>

<p>핵심 아이디어<br />
에이전트 SDK에게 도구를 등록하지 않는다(tool_choice 없이). 대신 우리가 넘긴 툴 카탈로그를 프롬프트에 JSON으로 주고, 에이전트가 반드시 다음 포맷의 JSON만 출력하도록 강제한다. 그러면 우리 오케스트레이터가 그 JSON을 파싱해 실제 MCP/로컬 툴로 라우팅한다. 이러면 Agent 전용 코드 분기가 생기지 않는다. 백엔드를 바꿔 끼우는 것만으로 같은 오케스트레이터가 그대로 동작한다.</p>

<p>설치<br />
pip install openai-agents mcp requests pydantic orjson</p>

<p>agents_backend.py<br />
아래 파일은 네가 이전에 받은 tools_only.py의 구조를 그대로 따르되, ChatBackend 구현체로 AgentsBackend를 추가한 버전이다. 나머지는 동일하니 이 파일 하나로 교체해도 되고, 필요한 부분만 가져다 써도 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== 공통 데이터 모델 ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {"name": ..., "arguments": str|dict}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 1-b) OpenAI Agents SDK 백엔드 어댑터 ==========
</span>
<span class="c1"># Agents SDK는 내부적으로 도구 실행까지 맡길 수 있지만,
# 여기서는 "텍스트+툴콜 JSON을 생성하는 모델"로만 사용한다.
# 프롬프트 강제 형식으로 tool_calls를 JSON으로 출력하게 만든다.
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># LiteLLM 모델 확장을 사용해 임의의 OpenAI 호환 엔드포인트를 붙일 수 있다.
</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># 도구는 에이전트에 등록하지 않는다. 우리가 직접 라우팅할 것이기 때문.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 절대 자동 도구 호출 금지
</span>        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 툴 목록을 JSON으로 주고, 정확한 출력 포맷을 강제한다.
</span>        <span class="n">tools_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span>
            <span class="n">tools_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tools_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_prompt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">위는 대화 내역이다. 아래는 사용 가능한 도구 목록이다.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">TOOLS_JSON=</span><span class="si">{</span><span class="n">tools_json</span><span class="si">}</span><span class="se">\n\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">반드시 다음 JSON 포맷으로만 답하라. 다른 텍스트는 절대 출력하지 말라.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">{</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;최종 자연어 응답(있으면)&gt;</span><span class="sh">"</span><span class="s"> ,</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-1</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}},</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-2</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}}</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">"</span><span class="s">  ]</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">}</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">여러 도구가 필요하면 tool_calls 배열에 순서대로 넣어라. 도구가 필요 없으면 빈 배열을 넣어라.</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">history</span> <span class="o">+</span> <span class="p">[</span><span class="sh">""</span><span class="p">,</span> <span class="n">guide</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_build_prompt</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
        <span class="c1"># Developer 메시지에 강제 포맷 가이드를 넣어 JSON만 출력하게 한다.
</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">JSON 포맷만 출력</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># JSON 파싱 실패 시, 일반 텍스트만 채워서 반환
</span>            <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">tool_calls</span><span class="o">=</span><span class="p">[])</span>
        <span class="c1"># 표준 ChatResponse로 맵
</span>        <span class="n">tc_raw</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># arguments가 dict가 아닐 수도 있으니 그대로 통과(오케스트레이터 쪽에서 정규화)
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span><span class="nc">ToolCall</span><span class="p">(</span><span class="o">**</span><span class="n">tc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tc_raw</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tc_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

<span class="c1"># ========== 2) ToolProvider (MCP/로컬) ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                <span class="p">}))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산. 입력 {expr:string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">})]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (변경 없음) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># 네임스페이스 단서
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LocalToolsProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># 폴백
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider can handle </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># MCP 서버 예시
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>
    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># A) OpenAI Agents SDK를 백엔드로 사용
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">AgentsBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># OpenAI 호환 엔드포인트(LiteLLM도 가능)
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>                <span class="c1"># 혹은 네 임의 모델명
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>

    <span class="c1"># B) 필요하면 기존 OpenAICompatibleBackend로 교체 가능
</span>    <span class="c1"># backend = OpenAICompatibleBackend(base_url="http://localhost:8000", path="/chat", model="my-model")
</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSV를 읽고 합계를 구한 뒤 계산기로 수치 검증까지 해줘. 파일은 ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 MCP 툴을 신중히 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>작동 방식 정리<br />
1단계. AgentsBackend는 OpenAI Agents Python SDK의 Agent를 모델 백엔드로만 쓴다. 도구는 등록하지 않는다.<br />
2단계. 우리가 노출할 툴 목록을 JSON으로 프롬프트에 넣고, 에이전트가 content와 tool_calls 배열을 정확히 담은 JSON만 출력하게 강제한다.<br />
3단계. 오케스트레이터는 그 tool_calls를 받아 기존과 똑같이 MCP/로컬 툴로 라우팅한다.<br />
4단계. 즉, 같은 오케스트레이터 코드를 유지한 채, 백엔드만 갈아끼워 Agents SDK 또는 일반 OpenAI 호환 엔드포인트를 자유롭게 선택할 수 있다.</p>

<p>주의점과 팁<br />
JSON 강제 프롬프트가 중요하다. 모델이 장식 텍스트를 섞지 않도록 developer_instructions로 “JSON만 출력”을 반복해서 고정하라.<br />
툴 스키마를 엄격하게. required, enum, format을 충분히 넣으면 arguments 파싱 실패가 줄어든다.<br />
성능. AgentsBackend는 Runner.run_sync를 한 턴마다 호출한다. 대화 길어지면 토큰·시간이 늘어나므로 expose_fn으로 툴을 턴별로 소출하고, 결과는 요약해서 재주입하라.<br />
대체. 에이전트 SDK의 모델 대신 OpenAICompatibleBackend로 바꾸면 바로 동일 코드가 다른 Chat에도 붙는다. 목적에 맞춰 백엔드만 교체하면 된다.</p>

<p>이렇게 하면 에이전트 SDK를 “백엔드 모델”로만 쓰면서, 너의 툴 중심 인터페이스와 라우터는 그대로 유지된다. 다음에는 네 실제 엔드포인트의 출력 JSON 예시를 알려줘. AgentsBackend의 JSON 파싱 부분을 거기에 맞춰 2~3줄만 조정하면 된다.</p>

<p class="chat--user">

아 복잡해 그냥 function_tool로 각 tool을 등록하면 어떨까

</p>

<p>좋지. “그냥 function_tool로 각 툴을 등록”하는 가장 깔끔한 방법은, MCP 서버들에서 list_tools를 긁어와서 각각을 Agents SDK의 FunctionTool로 동적으로 래핑하는 거야. 그러면 Agent 쪽은 전혀 커스텀 분기 없이 표준 툴만 본다. 아래 코드가 바로 그 패턴이고, 커스텀 LLM도 LiteLLM 모델 어댑터로 붙인다.</p>

<p>핵심 개념 한 줄 요약<br />
MCP의 tool 메타데이터(name, description, input_schema)를 Agents SDK의 FunctionTool(name, description, params_json_schema, on_invoke_tool)에 그대로 매핑하고, on_invoke_tool에서 해당 MCP 세션으로 call_tool만 라우팅한다. FunctionTool/<code class="language-plaintext highlighter-rouge">@function_tool</code> 사용법과 JSON 스키마 포맷은 Agents 문서 그대로다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a> 또한 모델은 LiteLLMModel로 너의 베이스 URL을 모델처럼 쓸 수 있다. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson</p>

<p>mcp_as_function_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># 네임스페이스(툴 이름 prefix에 들어감)
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cdfg</span><span class="p">.</span><span class="n">name</span> <span class="nf">if </span><span class="p">(</span><span class="n">cdfg</span> <span class="p">:</span><span class="o">=</span> <span class="n">cfg</span><span class="p">)</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    MCP tool -&gt; Agents FunctionTool
    tool_meta: has .name, .description, .input_schema (JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Agents SDK가 args_json을 JSON 문자열로 넘겨준다 → dict로 파싱 후 MCP 호출
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 모델이 형식 어기면 raw로 전달(서버 쪽 검증에 맡김)
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="c1"># MCP 표준 content를 텍스트/JSON 위주로 정규화
</span>        <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="c1"># 에이전트에게는 문자열을 반환하므로 JSON 문자열로 묶어준다
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="c1"># FunctionTool은 name/description/params_json_schema/on_invoke_tool만 주면 된다.
</span>    <span class="c1"># 공식 문서의 "Custom function tools" 섹션과 동일한 생성자. :contentReference[oaicite:2]{index=2}
</span>    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) 여러 MCP 서버를 선언
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>        <span class="c1"># MCPServerCfg(name="db", kind="stdio", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">]</span>

    <span class="c1"># 2) MCP의 모든 툴을 FunctionTool로 등록
</span>    <span class="n">mcp_function_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>

    <span class="c1"># 3) 커스텀 LLM(너의 엔드포인트)을 LiteLLM 모델로 사용
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># 네 엔드포인트를 OpenAI 호환으로 노출했다는 가정
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) 에이전트 구성: “function_tool로 등록된 MCP 툴”만 전달
</span>    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP-through-FunctionTools</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_function_tools</span><span class="p">,</span>  <span class="c1"># 포인트: 오직 function_tool만
</span>    <span class="p">)</span>

    <span class="c1"># 5) 실행
</span>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data 폴더에서 sales.csv를 읽고 합계 계산해줘. 필요하면 스스로 적절한 MCP 툴을 골라 써.</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>어떻게 돌아가나<br />
1단계. 여러 MCP 서버에 연결하고 list_tools로 메타를 긁는다.<br />
2단계. 각 MCP 툴을 FunctionTool로 감싼다. name은 server:tool로 네임스페이스, description과 JSON 스키마는 MCP의 description/input_schema를 그대로 쓴다. 이 매핑은 Agents 문서의 Function tools/Custom function tools 규약에 맞다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a><br />
3단계. on_invoke_tool에서 session.call_tool만 호출해 결과를 문자열(JSON)로 반환한다.<br />
4단계. Agent는 “function_tool로 등록된 툴”만 보므로, 네가 원한 단순한 툴 등록 모델 그대로다. 모델은 LiteLLM을 통해 임의 베이스 URL의 LLM을 쓸 수 있다. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>실전 팁<br />
툴 과적재를 피하려면 tools=mcp_function_tools 대신, 프롬프트를 보고 필요한 서버만 필터링해서 전달해라(예: 파일/CSV가 있으면 files:*만). Function tools는 설명과 인자 스키마를 자동 소비하니, MCP 쪽 스키마를 빡빡하게 유지하면 arguments 오류가 줄어든다. FunctionTool로 직접 생성하면 데코레이터 없이도 이름·설명·스키마를 원하는 대로 넣을 수 있다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a></p>

<p>확장 아이디어<br />
고위험 툴에 dry_run, confirm 같은 필드를 MCP input_schema에 추가하면, 그대로 FunctionTool 인자 스키마에 반영되어 실행 전에 모델이 스스로 안전 절차를 따른다.<br />
툴 결과가 크면 on_invoke_tool에서 요약만 반환하고, 원본은 파일 핸들이나 URL로 제공하도록 MCP 서버를 설계해 토큰 사용량을 줄인다.</p>

<p>원하면 네 파일/DB MCP 서버의 실제 tool 이름과 input_schema를 알려줘. 위 스크립트가 해당 스키마를 그대로 FunctionTool로 옮겨주기 때문에 추가 코드는 사실상 없다.</p>

<p class="chat--user">

응 내가 원하는거랑 가까워진듯. 질문이 더 있어. 질문 1. MCP 말고 일반 Function 툴과 섞인 버젼 추가해줘. 질문 2. 일반 chat completions (with tools) 예제도 바로 아래에 추가해줘. 질문 3. MCP Client Session은 저절로 종료되나? 질문 4. 여러 Agent가 있으면 MCP 종류별로 세션을 여러개 열게될수도 있을거 같은데 하나로 유지하는건 어때? 문제가 있으려나

</p>

<p>좋아. 네 질문 4개를 순서대로, 바로 쓸 수 있는 코드와 함께 정리한다. 인용구문은 쓰지 않는다.</p>

<h1 id="1-mcp-툴--일반-function-툴을-섞어-등록하는-버전">1) MCP 툴 + 일반 Function 툴을 섞어 등록하는 버전</h1>

<p>아래는 앞서 만든 “MCP → FunctionTool 래핑”에 더해, 일반 파이썬 함수도 FunctionTool로 함께 등록하는 예시다. 에이전트는 두 종류를 한꺼번에 본다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># ========== MCP 연결 ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">args_json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_function_tools</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># ========== 일반 파이썬 함수 → FunctionTool ==========
</span>
<span class="k">def</span> <span class="nf">make_local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">math_eval</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 툴
</span>    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_mcp_function_tools</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="db", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">])</span>

    <span class="c1"># 2) 일반 Function 툴
</span>    <span class="n">local_tools</span> <span class="o">=</span> <span class="nf">make_local_tools</span><span class="p">()</span>

    <span class="c1"># 3) 모델 (네 커스텀 LLM OpenAI-호환 엔드포인트)
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MixedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_tools</span> <span class="o">+</span> <span class="n">local_tools</span><span class="p">,</span>  <span class="c1"># 섞어서 등록
</span>    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data 폴더의 sales.csv를 읽어 합계를 구하고, local.math_eval로 숫자 검증까지 해줘</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h1 id="2-일반-chat-completions-with-tools-예제">2) 일반 Chat Completions (with tools) 예제</h1>

<p>OpenAI 호환 Chat Completions API를 직접 쓰는 순수 예시다. tools에 함수 스키마를 주고, tool_calls를 받아서 너의 실행기로 라우팅한다. 여기서는 로컬 계산기 하나만 보여주지만, 위의 MCP tools 리스트를 그대로 합쳐 넣으면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>  <span class="c1"># 네 OpenAI 호환 엔드포인트
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산 계산기</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># 여기에 MCP에서 긁어온 tools도 그대로 append 가능
</span><span class="p">]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">3*(2+5) 값을 계산해줘</span><span class="sh">"</span><span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># 1차 요청
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
<span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="c1"># tool_calls 처리
</span><span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="c1"># 2차 요청(도구 결과 반영)
</span>    <span class="n">resp2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp2</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">resp2</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
</code></pre></div></div>

<p>포인트<br />
tools에 MCP에서 긁은 스키마를 그대로 추가하면, 일반 chat completions 루프에서도 MCP와 로컬 툴을 함께 쓸 수 있다. 단, MCP 호출부는 너의 라우터가 처리해 tool 역할 메시지를 만들어 넣으면 된다.</p>

<h1 id="3-mcp-clientsession은-저절로-종료되나">3) MCP ClientSession은 저절로 종료되나?</h1>

<p>자동 종료를 기대하면 안 된다. 표준 패턴은 세 가지다.</p>

<ol>
  <li>
    <p>세션을 감싼 트랜스포트(StdIO/SSE)에 대해 stop/close를 명시적으로 호출한다.</p>
  </li>
  <li>
    <p>async with 컨텍스트를 제공하는 래퍼를 만들어 with 블록이 끝날 때 정리한다.</p>
  </li>
  <li>
    <p>프로세스 종료 훅에서 전역 세션들을 순서대로 정리한다.</p>
  </li>
</ol>

<p>간단 정리 함수 예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 세션과 트랜스포트를 함께 추적해야 안전
</span><span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<p>세션을 열 때 MCPHandle을 만들어 리스트에 넣고, 애플리케이션 종료 시 모든 handle.close()를 await 하면 된다.</p>

<h1 id="4-여러-agent가-세션을-공유해도-될까-하나로-유지하는-전략과-주의점">4) 여러 Agent가 세션을 공유해도 될까? 하나로 유지하는 전략과 주의점</h1>

<p>결론부터 말하면, 공유 풀을 두고 재사용하는 게 일반적으로 좋다. 다만 몇 가지 주의점이 있다.</p>

<p>장점<br />
메모리·프로세스 수 절감. stdio 서버는 프로세스를 하나만 띄우면 된다.<br />
콜드 스타트 지연 감소. list_tools 캐시와 연결 수립 시간이 절약된다.</p>

<p>주의점<br />
동시성. 하나의 MCP 세션이 다중 호출을 처리할 때, 서버/클라이언트가 동시 호출을 안전하게 처리하는지 확인해야 한다. 대부분의 MCP 서버 구현은 괜찮지만, 특정 서버가 순차 처리만 안전하게 지원한다면 큐잉이나 세마포어가 필요하다.<br />
격리. 사용자·권한이 다른 Agent가 같은 세션을 쓰면 권한 경계가 흐려질 수 있다. 서버 인스턴스를 권한 단위로 분리하는 게 안전하다.<br />
생명주기. 누가 언제 닫을지 합의가 필요하다. 레퍼런스 카운팅 또는 명시적 init/close API가 필요하다.<br />
버전·옵션 차이. 같은 서버라도 플래그(예: dry_run 기본값)가 다른 Agent마다 다를 수 있다. 이땐 세션을 공유하지 말고 별도 인스턴스를 띄워라.</p>

<p>간단한 세션 풀 스캐폴딩(RefCount + AsyncLock):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPSessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,...]],</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># key 예시: ("stdio", ("npx","-y","@modelcontextprotocol/server-filesystem","./data"))
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acquire_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientSession</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">:</span>
                <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
            <span class="c1"># 새로 생성
</span>            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">transport</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">release_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>사용 패턴<br />
Agent가 시작할 때 acquire_stdio로 세션을 받아 쓰고, 끝날 때 release_stdio로 반납한다. 동일한 command/args 조합은 한 세션을 공유한다. 권한 격리가 필요한 경우 key에 추가 식별자(tenant, role 등)를 포함시키면 된다. 동시성 밀도가 높다면 각 MCP 서버 특성에 맞춰 per-server 세마포어를 더해주는 게 안전하다.</p>

<p>마무리 팁<br />
섞인 환경(일반 함수 + MCP)에서는 툴 수가 늘어 혼란이 생기기 쉬우니, 에이전트에 등록할 때 도메인별 프리픽스(server:tool, local.*)와 짧고 명확한 설명, 엄격한 JSON 스키마(required/enum/format)를 유지하자. 필요하면 한 턴에 노출할 툴을 필터링해 과적재를 줄이는 것도 효과적이다.</p>

<p class="chat--user">

1번과 2번을 합쳐서 써야지. 두 개 툴 구현이 너무 다르잖아. 툴 구현을 한 번만 하고 두 군데 모두에서 쓰고 싶은거야.

</p>

<p>좋아, “툴 구현은 한 번만” 하고, 그걸 두 방식 모두에서 재사용하도록 합치자. 아래 스캐폴딩은 단일 ToolRegistry에 툴을 등록하고, 같은 구현을 1) OpenAI Agents SDK(FunctionTool) 경로, 2) 일반 Chat Completions(with tools) 경로 양쪽에서 그대로 씁니다. MCP 툴도 동일한 추상화로 래핑합니다.</p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>unified_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1">###############################################################################
# 공통 추상화: 한 번 구현한 툴을 어디서든 재사용
###############################################################################
</span>
<span class="c1"># Tool 핸들러 시그니처: args(dict) -&gt; dict/str (awaitable)
</span><span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># 실제 실행 로직(동일 구현을 양쪽에서 재사용)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool name: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">list_for_chat_completions</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># OpenAI tools 포맷으로 직렬화
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# 로컬(일반) 툴 구현 예시: 한 번만 구현
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">LOCAL_MATH_TOOL</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기. 입력 {expr: string}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="n">handler</span><span class="o">=</span><span class="n">math_eval_handler</span>
<span class="p">)</span>

<span class="c1">###############################################################################
# MCP 툴을 동일 추상화로 래핑: 세션별로 ToolSpec을 생성
###############################################################################
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># 네임스페이스 prefix
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈 필요</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mcp_toolspecs_from_session</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="c1"># 동기 함수로 명세만 만들고, handler는 session을 캡처하여 비동기로 호출
</span>    <span class="c1"># list_tools 는 async라 밖에서 호출해 metadata를 넘겨줘야 한다.
</span>    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">call build_mcp_tools(...) instead</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">MCPHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">handle</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">):</span>
            <span class="c1"># _tool를 default 인자로 바인딩해 late-binding 이슈 방지
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">packed</span>

        <span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">specs</span>

<span class="c1">###############################################################################
# 1) OpenAI Agents SDK 경로: FunctionTool로 래핑하되, handler는 동일 구현 사용
###############################################################################
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_function_tool</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># 에이전트는 문자열 반환이 표준이므로 JSON 문자열로 직렬화
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_function_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">()]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">user_text</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1">###############################################################################
# 2) 일반 Chat Completions 경로: tools JSON + 동일 handler로 tool_calls 라우팅
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_for_chat_completions</span><span class="p">()</span>

        <span class="c1"># 1차 호출
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 도구 호출 처리 루프(필요 시 반복)
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw_args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">}</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# 실행 예시: 한 번 구현 → 두 경로에서 사용
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) 레지스트리 생성 및 로컬 툴 등록(한 번만)
</span>    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">LOCAL_MATH_TOOL</span><span class="p">)</span>

    <span class="c1"># 1) MCP 세션 연결 후, MCP 툴들을 동일 추상화로 등록
</span>    <span class="n">files_cfg</span> <span class="o">=</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">files_handle</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">files_cfg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="k">await</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">files_handle</span><span class="p">):</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># A) Agents SDK 경로
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Agents SDK 경로 ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더의 sales.csv를 읽고 합계를 계산한 뒤 local.math_eval로 2배를 계산해줘</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># B) 일반 Chat Completions 경로
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Chat Completions 경로 ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">files 서버 툴로 sales.csv 합계를 구하고 local.math_eval로 100+23도 계산해줘</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">files_handle</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트 정리<br />
툴은 ToolSpec(handler 포함)으로 한 번만 구현한다. MCP도 build_mcp_tools가 동일한 ToolSpec을 만들고, 로컬 툴도 같은 형태다.<br />
OpenAI Agents SDK는 FunctionTool로 얇게 래핑만 한다. on_invoke는 같은 handler를 호출한다.<br />
Chat Completions(with tools)도 registry의 tools JSON을 그대로 사용하고, tool_calls를 같은 handler로 라우팅한다.<br />
MCP 세션은 MCPHandle.close로 명시 종료한다. 여러 Agent나 여러 러너가 있을 때 공유하고 싶다면 핸들 풀을 두고 레퍼런스 카운팅만 얹으면 된다.</p>

<p>이제 “툴 구현은 한 번만” 쓰고, Agents와 Chat Completions 어디서든 동일하게 돌아간다. 필요한 경우 expose(툴 소출) 정책이나 권한 게이트를 registry 레벨에서 필터링 훅으로 추가하면 된다.</p>

<p class="chat--user">

흠 차라리 MCP에 대한 정보를 따로 받고 에이전트에게 알아서 처리하는게 나을까? 이러너 레이어를 내가 직접 만드는것보다?

</p>

<p>짚고 가자. “MCP 정보를 에이전트에게 그대로 넘겨서 알아서 쓰게 할지” vs “네가 러너 레이어(오케스트레이터)를 직접 만들어 통제할지”는 트레이드오프다. 한쪽이 항상 더 낫지는 않다. 아래를 기준으로 선택하면 된다.</p>

<p>선택 기준 요약<br />
에이전트가 MCP를 직접 다루게 한다<br />
장점: 설정이 단순하고 빠르다. SDK가 세션 관리, 툴 호출, 반환 형식 등을 알아서 처리한다. 호스티드/원격 MCP는 코드 없이 붙이기 쉽다. <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io+1</a><br />
단점: 턴별 툴 소출(Selective exposure), 고급 승인 흐름, 로깅 표준화, 네임스페이스 규칙, 재시도·서킷브레이커 같은 “플랫폼 공통 정책”을 세밀하게 넣기 어렵다. 모델이 많은 툴을 동시에 보게 되면 호출 혼선이 늘어난다. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI Platform+1</a></p>

<p>직접 러너(오케스트레이터)를 둔다<br />
장점: 툴 노출·권한·에러 처리·관측성을 전부 네가 표준화할 수 있다. 여러 채팅 백엔드(Agents, 일반 Chat Completions, 사내 엔진)를 같은 규약으로 꿰매 쓸 수 있다.<br />
단점: 네가 세션 풀, 라우팅, 재시도, 포맷 강제(JSON만 출력 등)를 구현·유지해야 한다.</p>

<p>권장 결론<br />
운영 기준이 빡빡하다면(권한 분리, 승인, 로그, 복구 전략, 비용/지연 관리), 지금까지 만든 얇은 러너를 유지하되 백엔드는 갈아끼우는 방식이 적합하다. 반대로 빠른 초기 통합·PoC, 공개 원격 MCP만 쓰는 경우에는 에이전트가 MCP를 직접 다루게 하는 구성이 가볍다. 둘을 섞는 하이브리드도 가능하다. 즉, 저위험·읽기 전용 MCP는 에이전트가 직접, 고위험 MCP는 러너를 통해서만 노출.</p>

<p>둘 중 하나를 고른 뒤 바로 쓸 수 있게, 실제 사용 스니펫을 2개 붙인다.</p>

<p>에이전트가 MCP를 직접 다루는 최소 예시<br />
여기서는 OpenAI Agents Python SDK에 여러 MCP 서버를 그대로 넘긴다. 모델은 OpenAI 호환 REST로 노출된 커스텀 엔드포인트를 쓴다(LiteLLM 래퍼).<br />
주의: 에이전트에 툴을 모두 노출하면 혼선이 생길 수 있으니, 필요하면 툴 필터·승인 옵션을 병행하라.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>  <span class="c1"># SDK 내장 MCP 커넥터
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://your-mcp.example/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">your-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">AgentManagedMCP</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요한 MCP 툴만 선택해서 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>  <span class="c1"># 포인트: MCP 정보를 그대로 넘김
</span>        <span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더에서 sales.csv 총합을 구하고, 검색 서버로 관련 리포트를 찾아 요약해줘</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>일반 Chat Completions(with tools)에 바로 붙이는 최소 예시<br />
여기서는 MCP 정보를 직접 넘기지 않고, MCP가 노출한 툴들을 OpenAI “tools” 포맷으로 변환해서 모델에게 보여준다. 모델의 tool_calls를 받으면 네가 call_tool을 실행한다. 이 경로는 러너가 얇게나마 필요하지만, 너가 이미 가진 통일 인터페이스(단일 ToolRegistry + handler 재사용)를 유지하기 좋다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="n">BASE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>
<span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">your-model</span><span class="sh">"</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">list_mcp_tools_as_openai_tools</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]))</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">);</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">files:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">session</span><span class="p">,</span> <span class="n">tools</span>  <span class="c1"># session은 뒤에서 call_tool에 사용
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">session</span><span class="p">,</span> <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">list_mcp_tools_as_openai_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">필요한 툴만 호출한다.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">files 서버 툴로 sales.csv 합계를 구해줘</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># 1차 요청
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>            <span class="c1"># e.g., files:read
</span>            <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># MCP 실행
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="c1"># 표준화하여 툴 메시지로 재주입
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,{})</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">]})</span>
            <span class="p">})</span>

        <span class="c1"># 2차 요청
</span>        <span class="n">data2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="n">_transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>언제 “에이전트에게 맡기기”가 유리한가<br />
MCP 서버가 전부 원격·공개이고, 권한 경계가 단순하며, 툴 수가 많지 않고, 빠르게 결과를 내야 할 때. SDK가 세션·호출을 대신 관리하므로 개발 비용이 낮다. OpenAI Agents SDK의 MCP 가이드는 이 경로를 기본으로 상정한다. <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io</a></p>

<p>언제 “직접 오케스트레이션”이 유리한가<br />
툴이 많고 성격이 다양해서 턴별 소출이 필요할 때, 실패·재시도·백오프 같은 SRE 룰을 도입해야 할 때, 감사 로그와 승인 플로우가 필요한 조직 환경일 때. 이때는 네가 만든 ToolRegistry/handler 단일화 구조가 유지보수에 유리하다. 모델/플랫폼을 바꿀 때도 백엔드만 교체하면 된다. OpenAI 표준 함수콜 루프는 문서의 권장 패턴이며, 이 위에 정책을 얹기 쉽다. <a href="https://platform.openai.com/docs/guides/function-calling?api-mode=chat&amp;utm_source=chatgpt.com">OpenAI Platform+1</a></p>

<p>하이브리드 팁<br />
저위험·읽기 전용 MCP는 에이전트 직결로 빨리 붙이고, 고위험(쓰기/삭제/결제/배포) MCP는 러너 경유 툴로만 노출한다. 에이전트 쪽에는 해당 툴을 숨겨 두고, 러너가 승인된 요청만 대리 호출한다. 이 구성이 현업에서 가장 에러율·사고율이 낮고, 초기 속도도 빠르다.</p>

<p>마지막 체크리스트<br />
툴 과적재를 피하려면 툴 노출 수를 턴당 8~12개 수준에서 시작하자.<br />
namespacing은 server:tool 패턴을 고정해 충돌을 막자.<br />
input_schema를 엄격하게(required, enum, format) 잡아 잘못된 arguments를 줄이자.<br />
MCP 세션은 자동 종료가 아니므로 종료 훅을 두거나 컨텍스트 매니저를 사용하자.<br />
세션 공유는 가능하지만 권한·동시성·생명주기 규칙을 먼저 정해둬야 한다.</p>

<p>원한다면 지금 네 실제 MCP 서버 목록과 위험도(읽기/쓰기), 그리고 사용 중인 모델 엔드포인트를 알려줘. 위 스니펫을 네 환경에 맞게 바로 돌아가도록 깔끔하게 커스터마이즈해주겠다.</p>

<p class="chat--user">

MCP가 3개 이상들어왔을 때 처리에 대해 알려줘. 그리고 OpenAI Agent 말고 다른 Agent도 있어. 1. MCP에 관한 정보를 통일되게 다룰 수 있는 클래스가 필요해. 2. 1에서 만든 정보를 각각의 Agent에 맞게 Adapt를 해줄 수 있는 얇은 클래스나 함수가 필요할 것 같아.

</p>

<p>좋아. “MCP 서버가 3개 이상”일 때 흔들리지 않게 돌리는 구조를 딱 두 층으로 깔끔하게 나눠줄게.</p>

<ol>
  <li>
    <p>MCP 정보를 “완전히 통일된 포맷”으로 다루는 허브 클래스</p>
  </li>
  <li>
    <p>그 통일 포맷을 각 에이전트별로 얇게 변환하는 어댑터들</p>
  </li>
</ol>

<p>한 번의 구현으로 OpenAI Agents, 일반 Chat Completions(with tools), 그리고 다른 프레임워크(원하면 LangChain/Autogen 등)까지 같은 툴 구현을 재사용할 수 있다. 아래 스캐폴딩은 그대로 복붙해서 시작해도 된다.</p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>mcp_unified_adapters.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">uuid</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>

<span class="c1"># =========================
# 0) 통일된 툴 스펙/레지스트리
# =========================
</span>
<span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">UnifiedToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># 예: "files:read_csv" or "local.math_eval"
</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># 모든 백엔드에서 재사용되는 실제 실행 로직
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">UnifiedToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">UnifiedToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UnifiedToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

<span class="c1"># =========================
# 1) MCP 허브(3개+ 서버 안정 운용)
# =========================
</span>
<span class="c1"># a) 설정과 핸들
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># 네임스페이스
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># 선택: 동시성 제한 등
</span>    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sema</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># b) MCP 허브: 3개 이상 서버를 연결·통일 스펙으로 변환·실행 라우팅
</span><span class="k">class</span> <span class="nc">MCPHub</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MCPHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">)</span>

        <span class="c1"># list_tools를 모두 긁어 통일 스펙으로 등록(네임스페이스: server:tool)
</span>        <span class="k">for</span> <span class="n">server</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="c1"># 동시성 보호 + 타임아웃
</span>                    <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">sema</span><span class="p">:</span>
                        <span class="n">coro</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">packed</span>

                <span class="n">self</span><span class="p">.</span><span class="n">_registry</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">UnifiedToolSpec</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
                <span class="p">))</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">registry</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_ready</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPHub.start() 호출 전입니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_registry</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># =========================
# 2) 공통 로컬 툴(선택)
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedToolSpec</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">UnifiedToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">math_eval</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># =========================
# 3) 어댑터 레이어(얇게)
# =========================
</span>
<span class="c1"># 3-a) OpenAI Agents Python SDK(FunctionTool) 어댑터
</span><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_agents_function_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">UnifiedToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="nf">wrap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">()]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">model_impl</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출하고, 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_impl</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="nf">to_agents_function_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1"># 3-b) OpenAI 호환 Chat Completions(with tools) 어댑터
</span><span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_tools_json</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
        <span class="p">}}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_json</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw</span><span class="p">}</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>

<span class="c1"># 3-c) 다른 에이전트(예: LangChain Tool)로의 얇은 어댑터(옵션)
# 필요하면 이런 형태로 추가:
</span><span class="k">def</span> <span class="nf">to_langchain_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">langchain.tools</span> <span class="kn">import</span> <span class="n">StructuredTool</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">t</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">StructuredTool</span><span class="p">.</span><span class="nf">from_function</span><span class="p">(</span>
            <span class="n">coroutine</span><span class="o">=</span><span class="n">_run</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">__</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 프레임워크 명명 규칙 맞추기
</span>            <span class="n">description</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">description</span>
            <span class="c1"># schema는 프레임워크별로 별도 지정 가능
</span>        <span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># =========================
# 4) 3개+ MCP 서버 포함 실행 예시
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># a) MCP 서버 3개 이상 선언
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># 공개/원격이면 SSE 가능(모듈 설치 필요)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="nc">MCPHub</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">hub</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">hub</span><span class="p">.</span><span class="nf">registry</span><span class="p">()</span>

        <span class="c1"># 로컬(일반) 툴도 같은 레지스트리에 추가
</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">local_tools</span><span class="p">():</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># 노출 과적재 방지 팁(선택): 필요할 때만 서브셋을 뽑아 다른 레지스트리에 복사해도 됨
</span>        <span class="c1"># 여기서는 전체를 그대로 사용
</span>
        <span class="c1"># A) OpenAI Agents 경로
</span>        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span>
            <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># OpenAI 호환 엔드포인트
</span>            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="sh">"</span><span class="s">files 서버로 sales.csv 합계를 구하고, local.math_eval로 100+23 계산도 해줘</span><span class="sh">"</span>
        <span class="p">)</span>

        <span class="c1"># B) Chat Completions 경로
</span>        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">system</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="sh">"</span><span class="s">db 서버 요약 툴로 고객별 구매 합계를 요약하고, 수치 검증은 local.math_eval로 2*(50+5) 계산해줘</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">hub</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 설계 포인트 정리<br />
MCP가 3개 이상이어도 MCPHub가 모든 세션을 들고 있고, list_tools를 네임스페이스(server:tool)로 묶어 하나의 ToolRegistry에 올린다. 실행도 같은 handler를 통해 라우팅되므로 구현이 한 번뿐이다.<br />
어댑터 레이어는 얇다. Agents(FunctionTool 리스트 생성), Chat Completions(tools JSON 생성), LangChain 등 아무 프레임워크나 20~30줄 내로 붙는다.<br />
동시성·타임아웃을 MCPHandle에 통합했다. 서버마다 max_concurrency와 timeout을 다르게 줄 수 있다.<br />
세션 종료는 MCPHub.close에서 일괄 처리한다. 자동 종료에 기대지 않는다.</p>

<p>3개 이상 서버일 때 실전 운영 팁<br />
툴 소출: 턴별로 필요한 서브셋만 노출하면 툴 선택 오류가 급감한다. 간단한 키워드 룰부터 시작해도 효과가 크다.<br />
네임스페이스: server:tool을 고정하고, description에도 서버명을 반복 표기하면 혼동이 줄어든다.<br />
스키마 엄격화: required, enum, format을 가능한 한 많이 넣자. arguments 파싱 오류가 줄어든다.<br />
관측성: handler에서 입력/출력/지연을 JSONL로 로깅하면 후속 최적화가 쉬워진다.<br />
고위험 툴: parameters에 dry_run(boolean, default true)와 confirm 문자열을 추가해 모델이 자체로 안전 절차를 밟게 하자.</p>

<p>이 스캐폴딩이면 MCP 정보를 한 번만 수집·정규화하고, 어떤 에이전트든 어댑터만 갈아끼워 재사용할 수 있다. 필요하면 expose(툴 소출) 전략 함수와 세션 풀(여러 프로세스/서비스 간 공유)을 덧대서 팀 표준 플랫폼으로 굳히면 된다.</p>

<p class="chat--user">

아니 mcp 서버는 그대로 넘길거야 툴로 내가 래핑 안할거야

</p>

<p>좋아. “MCP 서버는 그대로 넘긴다(툴로 래핑 안 함)”를 전제로, 여러 개(3개 이상) MCP를 한꺼번에 다루는 통일 정보 클래스와 각 에이전트별 얇은 어댑터를 만들어줄게. 핵심은 툴 레벨 래핑이 아니라, MCP 서버 메타(연결 방식·자격증명·네임라벨)를 그대로 전달하는 것이다.</p>

<p>아래 스캐폴딩은 세 파트다.</p>

<ol>
  <li>
    <p>UnifiedMCPConfig: MCP 서버 정보를 통일된 포맷으로 보관·검증.</p>
  </li>
  <li>
    <p>Adapters: 이 정보를 각 에이전트 SDK에 맞게 그대로 투사.<br />
2-1) OpenAI Agents Python SDK용 어댑터<br />
2-2) Anthropic Messages API(MCP connector)용 어댑터<br />
2-3) MCP 미지원 프레임워크용 “프로토콜 유지” 대안: 합성 프록시 서버(선택). 툴로 감싸지 않고, 하나의 MCP 서버로 프록시 제공.</p>
  </li>
</ol>

<p>추가로 3개 이상 서버일 때의 수명주기, 동시성, 공유 전략까지 포함했다.</p>

<p>설치<br />
pip install mcp pydantic orjson "openai-agents[litellm]" requests</p>

<p>unified_mcp_pass_through.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">HttpUrl</span><span class="p">,</span> <span class="n">field_validator</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># 1) 통일 포맷: MCP 서버 정보를 “그대로” 담아 에이전트로 전달하기 위한 모델
</span>
<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># 필요시 확장
</span>
<span class="k">class</span> <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">에이전트에서 보일 서버 라벨(네임스페이스)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># 공통 옵션
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span>
    <span class="n">cache_tools_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">non_empty</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">name must be non-empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="k">class</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedMCPServer</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">dup</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate server names: </span><span class="si">{</span><span class="n">dup</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">no MCP servers provided</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># 최소 가드: stdio면 command 필수, sse면 url 필수
</span>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2) 어댑터들
# 2-1) OpenAI Agents Python SDK 어댑터: 그대로 mcp_servers에 꽂는 팩토리
</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span><span class="p">,</span> <span class="n">MCPServerStreamableHttp</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>

<span class="k">class</span> <span class="nc">OpenAIAgentsMCPAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">build_context_managers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">cms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerStdio</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">env</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerSse</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                    <span class="n">require_approval</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">require_approval</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerStreamableHttp</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                    <span class="n">require_approval</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">require_approval</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cms</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">cms</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">build_context_managers</span><span class="p">()</span>
        <span class="c1"># 여러 context manager를 한 번에 열기
</span>        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncExitStackGroup</span><span class="p">(</span><span class="n">cms</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">PassThroughMCPAgent</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP 서버의 툴을 안전하게 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">mcp_servers</span><span class="o">=</span><span class="n">opened</span><span class="p">,</span>                             <span class="c1"># 포인트: 서버를 '그대로' 넘김
</span>                <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span>

<span class="c1"># 여러 async context manager를 묶어 여닫는 유틸
</span><span class="k">class</span> <span class="nc">AsyncExitStackGroup</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cms</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cms</span> <span class="o">=</span> <span class="n">cms</span>
        <span class="n">self</span><span class="p">.</span><span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">opened</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="c1"># 역순으로 안전 종료
</span>        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="nf">reversed</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c1"># 2-2) Anthropic Messages API(MCP connector) 어댑터: payload만 만들어 반환
# 주의: 여기서는 실제 호출까지 하지 않고, mcp_servers JSON을 만들어 돌려준다.
# 너는 이 JSON을 바로 API 바디에 넣으면 된다.
</span>
<span class="k">class</span> <span class="nc">AnthropicMCPAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">to_messages_payload</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">mcp_servers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="c1"># Anthropic 커넥터는 원격만 직접 붙이는 패턴이 일반적이므로, stdio는 보통 불가.
</span>                <span class="c1"># 필요하면 너의 서버를 HTTP로 노출해야 한다.
</span>                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: Anthropic payload는 stdio를 직접 전달할 수 없다. HTTP/SSE로 전환 필요</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mcp_servers</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">authorization_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">tool_configuration</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">enabled</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_text</span><span class="p">}],</span>
            <span class="sh">"</span><span class="s">mcp_servers</span><span class="sh">"</span><span class="p">:</span> <span class="n">mcp_servers</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c1"># 2-3) MCP 미지원 프레임워크를 위한 “프로토콜 유지” 대안: 합성 프록시(선택)
# 툴 래핑 없이, 여러 상류 MCP를 하나의 '가짜 MCP 서버'로 노출.
# 에이전트는 MCP 한 대만 본다. 내부에서 list_tools/ call_tool를 서버별로 프록시.
# 간단 버전(개념 코드): 실제 MCP 서버 스펙에 맞춘 완성 서버는 별도 구현 필요.
</span>
<span class="k">class</span> <span class="nc">CompositeMCPProxy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    아이디어: upstream 여러 MCP 세션에 붙어, 외부에는 단일 MCP 서버처럼 동작.
    - list_tools: 모든 upstream에서 툴을 긁어 namespaced 이름(server:tool)으로 합쳐 반환
    - call_tool: </span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">을 파싱해 해당 upstream에 위임
    이 클래스 자체는 프로토콜 처리(transport)는 생략하고, 콜백 형태만 제공.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># upstream 연결만 담당(프록시 서버로 공개하려면 별도 transport/서버 구현 필요)
</span>        <span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
        <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
            <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 필요</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 필요하면 streamable-http 등 추가
</span>                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unsupported kind for proxy: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">tr</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">sess</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_all_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">server</span><span class="p">][</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">packed</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

<span class="c1"># 3) 사용 예시
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">demo_openai_agents</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">servers</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span>  <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}),</span>
    <span class="p">])</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="nc">OpenAIAgentsMCPAdapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">run_once</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="sh">"</span><span class="s">files와 db, search MCP를 적절히 사용해 sales.csv의 통찰을 요약해줘</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">demo_anthropic_payload</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">servers</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">git</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.git.example/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer Y</span><span class="sh">"</span><span class="p">}),</span>
    <span class="p">])</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="nc">AnthropicMCPAdapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">).</span><span class="nf">to_messages_payload</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">claude-3-7-sonnet</span><span class="sh">"</span><span class="p">,</span> <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">두 MCP를 활용해서 리포트를 만들어줘</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="n">OPT_INDENT_2</span><span class="p">).</span><span class="nf">decode</span><span class="p">())</span>

<span class="c1"># 메인
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">asyncio</span>
    <span class="kn">from</span> <span class="n">contextlib</span> <span class="kn">import</span> <span class="n">suppress</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">demo_openai_agents</span><span class="p">())</span>
    <span class="k">with</span> <span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
        <span class="nf">demo_anthropic_payload</span><span class="p">()</span>
</code></pre></div></div>

<p>어떻게 쓰면 되나 단계별 요약</p>

<ol>
  <li>
    <p>UnifiedMCPConfig에 3개 이상 MCP 서버를 그대로 나열한다. stdio면 command/args, sse면 url/headers만 채우면 된다.</p>
  </li>
  <li>
    <p>OpenAI Agents를 쓸 때는 OpenAIAgentsMCPAdapter로 context manager들을 만들어 Agent(mcp_servers=[…])에 꽂는다. 이 흐름은 MCP 툴을 “래핑하지 않고” 서버 정보를 그대로 전달한다.</p>
  </li>
  <li>
    <p>Anthropic Messages API를 쓸 때는 AnthropicMCPAdapter가 messages.create 바디에 넣을 mcp_servers JSON을 생성해준다. stdio는 원격 공개가 아니면 바로 붙일 수 없으니 SSE/HTTP로 노출해야 한다.</p>
  </li>
  <li>
    <p>MCP 미지원 프레임워크에는 CompositeMCPProxy 같은 방식으로 “MCP 프로토콜은 유지”한 채 합성 서버를 하나 띄우는 선택지가 있다. 이건 툴 래핑이 아니라 “MCP 서버를 하나 더 제공”하는 방식이라 네 조건과 어긋나지 않는다.</p>
  </li>
</ol>

<p>3개 이상 서버에서의 실무 체크<br />
툴 과적재 방지. Agent에 넘길 때 서버를 전부 주되, 모델 프롬프트에 “이런 작업에는 files만, 요약은 db만” 같은 지침을 한 줄 넣는 것만으로도 혼선이 줄어든다.<br />
세션/자원 관리. OpenAI Agents 어댑터는 context manager가 종료 시 자동 정리를 수행한다. Anthropic 경로는 원격 서버이므로 별도 세션 정리는 필요 없다.<br />
권한 경계. 서로 다른 테넌트나 위험도를 가진 MCP는 서버 라벨을 명확히 구분하고, require_approval 옵션을 “always/auto”로 둔다(Hosted/원격에서 의미 있음).<br />
동시성·타임아웃. 서버별 max_concurrency, request_timeout_sec를 다르게 주어 병목을 피한다.</p>

<p>이 구성은 “MCP 서버 정보를 있는 그대로 넘긴다”는 원칙을 지키면서, 서로 다른 에이전트들에 같은 정보를 재사용하도록 해준다. 필요한 프레임워크가 더 있으면 같은 패턴으로 어댑터를 20~30줄로 추가하면 된다.</p>

<p class="chat--user">

근데 MCP를 보니 그냥 툴만 있는게 아니라 Sampling, 사용자에게 물어보기, 프롬프트 등등 있잖아. 그걸 Chat이랑 연동할 수 있을까

</p>

<p>좋아, 핵심은 “MCP가 제공하는 건 툴만이 아니다”는 점을 전제로, Sampling(서버가 모델 호출을 위임), 사용자에게 물어보기(ask-user), 프롬프트/프롬프트 템플릿(list/get) 같은 채널을 Chat 루프에 붙이는 얇은 어댑터 레이어를 여기에 딱 만들어두는 거다. 래핑으로 툴로 바꾸지 않고, MCP 메타(프롬프트/샘플링/질의)를 그대로 전달·왕복시켜 결합한다.</p>

<p>아래 설계와 스캐폴딩은 이전에 만든 “백엔드 갈아끼우기(Chat Completions or OpenAI Agents)” 구조를 유지하면서, MCP의 네 가지 면을 모두 연동한다.</p>

<ol>
  <li>
    <p>툴: 기존과 동일, call_tool 라우팅</p>
  </li>
  <li>
    <p>프롬프트: list_prompts/get_prompt를 통해 시스템/도우미 메시지 주입</p>
  </li>
  <li>
    <p>사용자에게 물어보기: MCP가 사용자 입력을 요청하면, Chat UI에 질문을 띄우고 답을 다시 MCP에 돌려줌</p>
  </li>
  <li>
    <p>샘플링: MCP 서버가 “모델 호출을 대신 해달라”고 요청하면, 현재 백엔드로 대리 샘플링 후 결과를 MCP에게 반환</p>
  </li>
</ol>

<p>아래는 그대로 붙이는 최소 스캐폴딩이다. MCP SDK의 일부 API는 서버 구현/버전에 따라 차이가 있어서, 함수 존재 여부를 동적으로 체크하도록 방어코드를 넣었다.</p>

<p>설치<br />
pip install mcp pydantic orjson requests "openai-agents[litellm]"</p>

<p>mcp_chat_bridge.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">################################################################################
# 공통: Chat 백엔드(두 가지 구현: OpenAI 호환 Chat Completions, OpenAI Agents)
################################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">OpenAIChatBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">tools</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span><span class="p">;</span> <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

<span class="c1"># 선택: OpenAI Agents를 백엔드로 쓰고 싶다면 이 어댑터를 사용
</span><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">FunctionTool</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">))</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 도구는 Agent에 등록하지 않고, 프롬프트 강제 포맷으로 tool_calls를 JSON으로 받는 전략도 가능
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">가능하면 JSON만 출력</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">txt</span><span class="p">}}]}</span>

<span class="c1">################################################################################
# MCP 연결: 여러 서버를 그대로 붙이고, 프롬프트/샘플링/질문을 브릿지
################################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span> <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈 필요</span><span class="sh">"</span><span class="p">)</span>
        <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>

<span class="c1">################################################################################
# 브릿지: MCP의 툴/프롬프트/ask-user/샘플링을 Chat 루프에 접속
################################################################################
</span>
<span class="k">class</span> <span class="nc">MCPChatBridge</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span>
        <span class="n">chat_backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span>
        <span class="n">ask_user</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>     <span class="c1"># 사용자에게 질문 보여주고 응답 받는 콜백
</span>        <span class="n">prompt_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">sampling_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c1"># 샘플링 옵션 정규화
</span>    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">chat_backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ask_user</span> <span class="o">=</span> <span class="n">ask_user</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prompt_selector</span> <span class="o">=</span> <span class="n">prompt_selector</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sampling_policy</span> <span class="o">=</span> <span class="n">sampling_policy</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">opts</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)})</span>

        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MCPHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="k">return</span> <span class="n">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_list_all_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                    <span class="p">}</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_collect_prompts</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]:</span>
        <span class="c1"># 서버별 프롬프트 목록 취합. 세션에 list_prompts/get_prompt 가 없으면 건너뜀.
</span>        <span class="n">collected</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">list_prompts</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">list_prompts</span><span class="sh">"</span><span class="p">)()</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># 각 항목마다 get_prompt(name)로 템플릿/메시지 구성 요소를 가져올 수 있다는 가정(서버 구현마다 상이)
</span>                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">prompts</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)})</span>
                    <span class="n">collected</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">collected</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_get_prompt_messages</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">server</span><span class="p">]</span>
        <span class="n">msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_prompt</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_prompt</span><span class="sh">"</span><span class="p">)(</span><span class="n">prompt_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># resp가 messages 비슷한 구조라고 가정하고 표준화
</span>                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">))</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">msgs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_server_sampling</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        MCP 서버가 </span><span class="sh">'</span><span class="s">샘플링 요구</span><span class="sh">'</span><span class="s">를 보내는 상황을 가정.
        request = {</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">:[...], </span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="s">:{...}} 같은 형태를 정책에 맞춰 백엔드에 대리 호출
        </span><span class="sh">"""</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">sampling_policy</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="c1"># request["messages"]는 OpenAI 포맷을 가정하고 그대로 전달
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">([</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="o">**</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])],</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1"># 필요하면 온전한 응답을 그대로 돌려주거나, 텍스트만 추출
</span>        <span class="n">content</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 1) 서버별 프롬프트 목록을 모아서 선택
</span>        <span class="n">base_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">)]</span>
        <span class="n">prompt_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_prompts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prompt_selector</span><span class="p">:</span>
            <span class="c1"># prompt_selector는 {server:[{name,desc},...]}를 보고 초기 메시지(예: system 프롬프트들) 리스트를 반환
</span>            <span class="n">injected</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prompt_selector</span><span class="p">(</span><span class="n">prompt_catalog</span><span class="p">)</span>
            <span class="n">base_messages</span> <span class="o">=</span> <span class="n">injected</span> <span class="o">+</span> <span class="n">base_messages</span>

        <span class="c1"># 2) MCP 툴들을 OpenAI tools 포맷으로 그대로 넘김
</span>        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_list_all_tools</span><span class="p">()</span>

        <span class="c1"># 3) 1차 모델 호출
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">base_messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
        <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)))</span>

        <span class="c1"># 4) tool_calls 처리 루프 + ask-user + server-sampling 훅 예시
</span>        <span class="c1"># 실제 ask/sampling 이벤트는 서버가 별도 툴로 노출하거나, resource/protocol 필드를 통해 트리거할 수 있다.
</span>        <span class="c1"># 여기서는 관습적으로 이름을 잡아 예시를 보인다.
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">tool_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># e.g., "files:read_csv" or "db:sql_summary" or "search:ask_user" 등
</span>                <span class="n">args_raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

                <span class="c1"># 4-a) ask-user 패턴: 특정 서버가 사용자 입력을 받아달라고 하는 툴을 제공한다고 가정
</span>                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">:ask_user</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">ask.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">question</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">추가 정보가 필요합니다. 입력해 주세요.</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">user_answer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">answer</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_answer</span><span class="p">})</span>
                    <span class="p">})</span>
                    <span class="k">continue</span>

                <span class="c1"># 4-b) server-side sampling: 서버가 모델 호출을 위임하는 툴(예: server:sample)로 구현돼 있다고 가정
</span>                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">:sample</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">sample.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{}})</span>
                    <span class="n">sampling_out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_maybe_server_sampling</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">sampling_out</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="k">continue</span>

                <span class="c1"># 4-c) 일반 MCP 툴 호출
</span>                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">namespaced tool required</span><span class="sh">"</span><span class="p">})})</span>
                    <span class="k">continue</span>
                <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">unknown server</span><span class="sh">"</span><span class="p">})})</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                    <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[]}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()})</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})})</span>

            <span class="c1"># 4-d) 툴 결과 재주입
</span>            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">tool_results</span><span class="p">:</span>
                <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">tr</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]))</span>
                <span class="c1"># 일부 백엔드/모델은 tool 메시지에 name/tool_call_id를 요구하므로,
</span>                <span class="c1"># OpenAIChatBackend를 직접 사용할 때는 messages에 dict 그대로 넣는 경로를 따로 두어도 된다.
</span>
            <span class="c1"># 4-e) 다음 턴 호출
</span>            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">base_messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
            <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)))</span>

        <span class="c1"># 5) 최종 답변
</span>        <span class="k">return</span> <span class="n">base_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span>
</code></pre></div></div>

<p>어떻게 쓰는가 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">ui_ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[QUESTION from MCP] </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># 실제 앱/UI에서는 모달·입력창으로 구현
</span>    <span class="k">return</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">pick_prompts</span><span class="p">(</span><span class="n">prompt_catalog</span><span class="p">):</span>
    <span class="c1"># prompt_catalog: {server: [{name,description}, ...]}
</span>    <span class="c1"># 간단 예시: files 서버에 "analysis_default" 프롬프트가 있으면 불러와 system에 삽입
</span>    <span class="c1"># 실제로는 bridge._get_prompt_messages(server, prompt_name)로 메시지를 받아 prepend
</span>    <span class="k">return</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 조심스럽고 정확한 분석가다.</span><span class="sh">"</span><span class="p">)]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">]</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAIChatBackend</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPChatBridge</span><span class="p">(</span><span class="n">servers</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">ask_user</span><span class="o">=</span><span class="n">ui_ask_user</span><span class="p">,</span> <span class="n">prompt_selector</span><span class="o">=</span><span class="n">pick_prompts</span><span class="p">)</span> <span class="k">as</span> <span class="n">bridge</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bridge</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sh">"</span><span class="s">sales.csv를 분석하고, 필요한 추가 정보가 있으면 먼저 나에게 질문해줘</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ANSWER ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트 요약<br />
샘플링. 서버가 “모델 호출을 대리해달라” 요청하면, 현재 연결된 Chat 백엔드로 그대로 라우팅해 결과를 돌려준다. 이렇게 하면 서버-주도 플로우까지 연동된다.<br />
사용자에게 물어보기. MCP가 사용자 입력이 필요할 때를 툴 혹은 별도 시그널로 노출하는 패턴을 잡고, ask_user 콜백으로 Chat UI와 왕복한다. 러너를 두더라도 로직은 콜백 한 줄이다.<br />
프롬프트. 서버별 프롬프트 레지스트리를 조회(list/get)해서 초기 system 메시지로 주입한다. 프롬프트가 파라미터화되어 있다면 get_prompt(name, **kwargs) 식으로 받아 메시지로 변환한다.<br />
호환성. 같은 브릿지를 OpenAI Chat Completions, OpenAI Agents 어느 쪽에도 꽂을 수 있다. Agents를 백엔드로 쓸 땐 JSON 강제 출력 같은 프롬프트 전략을 써도 되고, 필요하면 Agents의 FunctionTool을 병행해서 ask-user나 sampling을 명시 툴로 노출하는 하이브리드도 가능하다.<br />
3개 이상 서버. 서버 수에 상관없이 namespacing(server:tool) 룰을 유지하고, 프롬프트·질문·샘플링은 서버 라벨과 함께 로깅해 추적 가능성을 높인다. 서버별 타임아웃/동시성은 handle 단에서 개별 튜닝하는 게 안전하다.</p>

<p>이렇게 하면 “툴로 래핑하지 않고”도 MCP의 넓은 표면적(툴·프롬프트·샘플링·유저질문)을 동일 Chat 경험에 자연스럽게 녹일 수 있다. 실제 네 서버에서 프롬프트/샘플링/ask가 어떤 엔드포인트/이벤트로 노출되는지 알려주면, 위 브릿지의 해당 함수만 너의 스펙에 딱 맞게 구체화해 줄 수 있다.</p>

<p class="chat--user">

아니 Elicitation이라고 따로 있는데

</p>

<p>맞아, MCP에는 “Elicitation(엘리시테이션)”이 따로 있다. 요지는 서버가 작업 도중 사용자에게 추가 정보를 표준 형식으로 요청할 수 있게 해주는 기능이고, 툴과는 별개의 채널이다. 결론부터 말하면 Chat 루프에 깔끔하게 연동할 수 있다. 아래처럼 “질문 라운드트립”을 브릿지에 끼우면 된다. 핵심 포인트와 최소 코드를 단계별로 정리한다.</p>

<ol>
  <li>
    <p>개념 정리<br />
Elicitation은 MCP 서버가 대화 도중 “사용자에게 이 정보 좀 받아줘”라고 요청하는 표준 메커니즘이다. 요청에는 프롬프트 문구와 함께 JSON 스키마가 따라오고, 클라이언트는 그 스키마에 맞게 사용자 입력을 받아 검증한 뒤 서버에 돌려준다. 2025-06-18 스펙에 정식 포함되었고, “툴 실행 중간에 끼어드는 질문”을 안전하고 구조화된 방식으로 다루려는 목적이다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p>아키텍처 선택지<br />
A. 프로토콜-네이티브 처리: MCP 클라이언트가 서버의 Elicitation 이벤트를 직접 수신해 UI로 띄우고 응답을 서버에 돌려준다. Chat 모델은 “최종 답변 생성”에 집중하고, 추가 정보 수집은 브릿지가 담당한다.<br />
B. 모델-중개 처리: Elicitation을 “ask_user” 같은 툴로도 노출하는 서버가 있다면, 기존 tool_call 루프에 섞어 처리해도 된다. 하지만 권장되는 방식은 스펙에 맞춘 네이티브 처리다(질문·응답이 중첩 흐름에서도 안정적). <a href="https://modelcontextprotocol.io/specification/draft/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a></p>
  </li>
  <li>
    <p>브릿지 확장 패턴<br />
너의 기존 Chat 오케스트레이터/브릿지에 아래 훅 두 개만 더해주면 된다.<br />
a) elicitation 이벤트 수신 → UI로 질문 띄우기 → JSON 스키마 검증 → 서버에 제출<br />
b) 샘플링·프롬프트·툴 루프와 자연스럽게 공존하도록 순서 제어</p>
  </li>
</ol>

<p>아래 코드는 “개념적으로 정확한 동작 흐름”을 보여주는 미니 스캐폴딩이다. MCP SDK의 세부 메서드명은 릴리스별로 다를 수 있으므로, 이벤트 구독/응답 부분은 네 SDK 버전에 맞춰 함수명만 치환하면 된다.</p>

<p>설치<br />
pip install mcp jsonschema orjson requests</p>

<p>코드 스니펫: MCP Elicitation 브릿지 훅</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="c1"># 가정: 이미 MCP 세션을 여러 개 열어놓았고, handles = {server: session} 형태로 보유
# 또한 ask_user 콜백(UI 입력)과 chat_backend(네 Chat 또는 Agent 백엔드)가 있다.
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_elicitation_loop</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]):</span>
    <span class="sh">"""</span><span class="s">
    한 MCP 세션에 대해 서버가 보내는 Elicitation 요청을 처리하는 루프.
    SDK마다 이벤트 수신 API 이름이 다를 수 있으므로, 아래 </span><span class="sh">'</span><span class="s">await session.next_elicitation()</span><span class="sh">'</span><span class="s">는
    네가 쓰는 SDK의 실제 호출로 치환하면 된다.
    </span><span class="sh">"""</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">next_elicitation</span><span class="p">()</span>  <span class="c1"># 예시: {"id": "...", "message": "날짜를 입력하세요", "schema": {...}}
</span>        <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">추가 정보가 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>

        <span class="c1"># UI에 질문 띄우고, 스키마에 맞는 dict로 응답 받기
</span>        <span class="n">user_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c1"># 로컬에서 1차 검증(선택이지만 권장)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="nf">validate</span><span class="p">(</span><span class="n">user_payload</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># 검증 실패 시 재질문
</span>            <span class="n">user_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">ask_user</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">입력 형식 오류: </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s">다시 입력해 주세요.</span><span class="sh">"</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
            <span class="nf">validate</span><span class="p">(</span><span class="n">user_payload</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c1"># 서버에 제출(실제 API명/필드명은 SDK에 맞춰 치환)
</span>        <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">submit_elicitation</span><span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="n">user_payload</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_chat_with_elicitation</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">):</span>
    <span class="c1"># 1) 병행으로 각 세션의 elicitation 루프를 가동
</span>    <span class="n">loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">handle_elicitation_loop</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">))</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>

    <span class="c1"># 2) 모델 호출 루프(툴/프롬프트/샘플링 등 기존 처리와 동일)
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_text</span><span class="p">}]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 필요하면 MCP list_tools를 OpenAI tools 포맷으로 넣기
</span>
    <span class="c1"># 첫 턴
</span>    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># tool_calls 처리(생략) + 중간에 서버가 elicitation을 보낼 수 있으므로, 다음 턴 전에 잠깐 yield
</span>    <span class="c1"># ...
</span>    <span class="c1"># 다음 턴 계속
</span>    <span class="c1"># ...
</span>
    <span class="c1"># 3) 종료 시 elicitation 루프 정리
</span>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">loops</span><span class="p">:</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">t</span>
</code></pre></div></div>

<p>UI 입력 콜백 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">ask_user_via_console</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[MCP 질문] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">요구 스키마: </span><span class="si">{</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; JSON으로 응답: </span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">ask_user_via_console</span><span class="p">(</span><span class="sh">"</span><span class="s">JSON 파싱 실패. 다시 입력해 주세요.</span><span class="sh">"</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></div>

<p>여기서 중요한 점<br />
스키마 검증. 서버가 스키마를 제공하므로 클라이언트에서 jsonschema로 1차 검증을 돌리면 왕복 횟수와 오류가 줄어든다. 스펙이 권장하는 보안·프라이버시 정책도 함께 지켜라(민감정보 요구 금지 등). <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
중첩 가능성. Elicitation은 다른 MCP 기능(툴, 프롬프트, 샘플링) 안쪽에 중첩되어 등장할 수 있다. 그러므로 이벤트 루프를 Chat 루프와 병행 실행하는 패턴이 안전하다. <a href="https://modelcontextprotocol.io/specification/draft/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
호환성. MCP를 직접 지원하는 클라이언트/에이전트(예: 일부 IDE, 일부 Agents SDK)는 Elicitation을 네이티브로 뜯어서 보여줄 예정이거나 이미 실험 중이다. 하지만 서버·SDK에 따라 이벤트/메서드명이 다르므로, 위 루프의 두 함수(next_elicitation, submit_elicitation) 위치만 실제 SDK 이름으로 바꾸면 된다. 개념과 흐름은 동일하다. <a href="https://github.com/anthropics/claude-code/issues/2799?utm_source=chatgpt.com">GitHub+1</a></p>

<p>OpenAI Agents나 일반 Chat과의 결합 방식 요약<br />
OpenAI Agents를 백엔드 모델로 쓸 때도 동일하다. “에이전트에게 MCP 서버를 그대로 넘겨서 에이전트가 툴 호출을 처리”하도록 둘 수도 있지만, Elicitation은 클라이언트(UI) 레벨의 사용자 상호작용이므로, 브릿지에서 이벤트를 수신해 UI와 왕복 후 결과를 서버에 전달하는 편이 제일 예측 가능하다.<br />
일반 Chat Completions(with tools) 경로에서도 마찬가지다. 모델은 답변/계획에 집중시키고, 사용자 질문은 브릿지가 담당한다. 필요하면 Elicitation으로 수집된 값을 시스템/유저 메시지로도 주입해 다음 턴 답변 품질을 올릴 수 있다.</p>

<p>실전 팁<br />
서버 수가 3개 이상이면 서버 라벨을 질문 메시지에 명시해준다. 예: “[files] 어떤 디렉토리를 생성할까요?”.<br />
민감정보 가드. 스펙이 금지하는 내용(비밀번호/토큰 등)은 브릿지에서 차단하고, 허용 목록만 통과시키는 것이 안전하다. <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
UX. 스키마에 enum/format을 적극 사용하게 서버 쪽에 권장하라. 클라이언트는 enum이면 드롭다운, format=email이면 이메일 입력 UI처럼 친화적으로 렌더링하기 쉽다. <a href="https://medium.com/data-science-collective/a-practical-guide-to-mcp-elicitation-with-fastapi-fastmcp-65f57fd91896?utm_source=chatgpt.com">Medium</a></p>

<p>한 줄 결론<br />
Elicitation은 MCP의 “인간-개입 표준 채널”이고, 툴과 별개로 Chat 루프에 깨끗하게 붙일 수 있다. 위 브릿지 훅 두 개만 넣으면, 모델-툴-사용자 삼자 협업이 안정적으로 돈다. 네가 쓰는 MCP Python SDK의 정확한 elicitation API 이름을 알려주면, next_elicitation/submit_elicitation 부분을 해당 버전에 딱 맞춰 즉시 치환해 준다.</p>

<p class="chat--user">

근데 MCP Server 라고 클래스명을 하니깐 진짜 서버 같이 느껴져 다른 이름 없어? 이건 설정 값에 가까운거 같은데

</p>

<p>맞아, “MCPServer”라고 하면 네트워크 서버 프로세스를 직접 돌린다는 느낌이 강하다. 실제 네가 다루는 건 세션을 열 때 필요한 <strong>설정 정보(Descriptor, Config, Profile, Endpoint)</strong>에 가까워.</p>

<p>보통 이런 경우 네이밍을 이렇게 바꿔 쓰면 더 자연스럽다.</p>

<ul>
  <li>
    <p><strong>MCPServerConfig</strong> : 가장 직설적. 서버에 접속하는 데 필요한 설정값 묶음.</p>
  </li>
  <li>
    <p><strong>MCPServerSpec</strong> : “사양/스펙”이라는 의미로, 서버를 기술하는 선언적 정보라는 뉘앙스.</p>
  </li>
  <li>
    <p><strong>MCPServerProfile</strong> : 여러 환경(개발/운영/테스트)에서 쓰일 수 있는 “프로필”이라는 톤.</p>
  </li>
  <li>
    <p><strong>MCPServerEndpoint</strong> : 특히 SSE/HTTP 주소처럼 원격 엔드포인트를 지칭할 때 적합.</p>
  </li>
  <li>
    <p><strong>MCPConnectionConfig</strong> : 실제로는 연결 구성에 해당한다는 걸 분명히 함.</p>
  </li>
</ul>

<p>네가 만든 UnifiedMCPConfig 같은 컨테이너 안에 들어갈 원소라면,</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MCPServerConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span> <span class="bp">...</span>
</code></pre></div></div>

<p>혹은 조금 더 가볍게</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MCPServerSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span> <span class="bp">...</span>
</code></pre></div></div>

<p>정도가 가장 무난하다.</p>

<p>정리하자면: <strong>서버(server)</strong>라는 단어 대신 <strong>Config / Spec / Endpoint / Profile</strong> 계열을 붙여주면 “실제 서버 객체”가 아니라 “접속 선언”이라는 의미가 명확해진다.</p>

<p>너의 코드베이스에서 MCP 서버를 실제로 구동하는 책임이 아니라 <strong>연결 정보를 담는 데이터 모델</strong> 이라면, <code class="language-plaintext highlighter-rouge">MCPServerConfig</code>가 가장 안전한 선택이다.</p>

<p>원한다면, 네가 지금 가지고 있는 클래스 정의를 내가 <code class="language-plaintext highlighter-rouge">MCPServerConfig</code> 식으로 리팩터링해서 전체 코드 스니펫을 다시 정리해줄 수도 있어.</p>

<p class="chat--user">

MCPSpec은 어때

</p>

<p>좋다. MCPSpec 괜찮다. 다만 “Spec”은 선언적·불변 설정이라는 뉘앙스를 주니, 런타임 상태(세션, 캐시, 동시성 제어)는 다른 이름에 두는 걸 추천한다. 정리하면 이렇게 쓰면 깔끔하다.</p>

<p>권장 의미 구분</p>

<ul>
  <li>
    <p>MCPSpec: 연결·인증·전송방식 같은 선언형 스펙. 직렬화 가능, 불변 취급.</p>
  </li>
  <li>
    <p>MCPHandle 또는 MCPSession: MCPSpec을 바탕으로 실제 연결을 연 뒤 갖게 되는 런타임 객체.</p>
  </li>
  <li>
    <p>MCPConfig: 여러 MCPSpec을 담는 컨테이너.</p>
  </li>
</ul>

<p>작은 리팩터 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">사람과 모델이 보는 라벨</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># 정책/힌트(스펙이므로 기본값만 보관)
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span>
    <span class="n">cache_tools_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">class</span> <span class="nc">MCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPSpec</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate names: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>런타임 분리 패턴</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">MCPSpec</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">open_handle</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">MCPSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">env</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 필요 시 http_streamable 등 추가
</span>        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unsupported kind: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span> <span class="k">await</span> <span class="n">s</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</code></pre></div></div>

<p>어댑터에서의 사용 느낌</p>

<ul>
  <li>
    <p>OpenAI Agents 어댑터: MCPSpec → MCPServerStdio/MCPServerSse 생성 시 그대로 넘김.</p>
  </li>
  <li>
    <p>Anthropic 어댑터: MCPSpec(kind="sse"/"http_streamable")를 mcp_servers 페이로드로 직렬화.</p>
  </li>
</ul>

<p>장단점 한줄 요약</p>

<ul>
  <li>
    <p>MCPSpec은 “진짜 서버”가 아니라 “접속 선언”이라는 의도가 분명해져 오해가 줄고, 테스트·직렬화·버전관리도 쉬워진다.</p>
  </li>
  <li>
    <p>세션·동시성 같은 런타임은 Handle/Session 쪽으로 분리되니 책임이 선명해진다.</p>
  </li>
</ul>

<p>결론<br />
MCPSpec 네이밍 채택 추천. 이미 만들어둔 코드에서 클래스명만 바꾸고, 핸들(세션) 계층을 분리하면 지금까지의 어댑터/브릿지 구조와도 잘 맞물린다.</p>

<p class="chat--user">

응 런타임 처리는 안할거야. MCPSpec // ToolSpec 이렇게 할까 하는데 MCPConfig // ToolConfig 이게 나으려나 어떻게 생각해

</p>

<p>좋아, 런타임은 안 다룬다고 했으니 이름은 “무슨 값을 선언·기술해 두는가”에만 맞추면 된다. 핵심은 Spec과 Config가 주는 뉘앙스 차이를 의도대로 쓰는 것.</p>

<p>정의 요약<br />
Spec: 인터페이스·스키마·불변에 가까운 선언. 엔드포인트, 툴 시그니처, JSON 스키마 같은 “계약서”.<br />
Config: 실행 맥락에 맞춘 선택·오버레이. 어떤 Spec을 노출할지, 별칭, 기본 옵션, 켜기/끄기 같은 “정책”.</p>

<p>권장 네이밍 매트릭스<br />
단일 선언 단위<br />
MCPSpec: MCP 접속 선언. kind, url/command, headers 같은 연결 스펙과 라벨, 태그 등.<br />
ToolSpec: 툴 선언. name, description, parameters(JSON Schema), 위험도 플래그 등.</p>

<p>컬렉션과 정책<br />
MCPConfig: 여러 MCPSpec을 담고, 환경별로 enable/disable·라벨·승인정책 등 오버레이.<br />
ToolConfig: 여러 ToolSpec에 대한 정책 오버레이와 노출 규칙(필터링, 별칭, 기본 파라미터 등).</p>

<p>즉, MCPSpec // ToolSpec은 “순수 선언”, MCPConfig // ToolConfig는 “선택과 정책”으로 역할을 분리하면 깔끔하다.</p>

<p>바로 쓸 수 있는 최소 모델 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">사람/모델이 볼 라벨, 네임스페이스 키</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># 메타
</span>    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                             <span class="c1"># 예: "files:read_csv" 또는 "local.math_eval"
</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span>            <span class="c1"># JSON Schema
</span>    <span class="n">server_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>      <span class="c1"># MCP 네임스페이스(예: "files"). 로컬 툴이면 None.
</span>    <span class="n">risk_level</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">med</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">low</span><span class="sh">"</span>
    <span class="n">default_dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>        <span class="c1"># name -&gt; on/off
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>         <span class="c1"># name -&gt; alias for UI/LLM
</span>    <span class="c1"># 간단 검증
</span>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate MCP names</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ToolConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>        <span class="c1"># tool name -&gt; on/off
</span>    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>         <span class="c1"># tool name -&gt; alias
</span>    <span class="n">defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># tool name -&gt; default args
</span>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate tool names</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>어댑터는 “런타임 없이” 정적 변환만 하면 된다</p>

<p>OpenAI Chat Completions tools 변환<br />
ToolSpec → tools JSON으로 직렬화</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tools_for_openai</span><span class="p">(</span><span class="n">tool_cfg</span><span class="p">:</span> <span class="n">ToolConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">aliases</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></div>

<p>Anthropic Messages API용 MCP 서버 페이로드<br />
MCPSpec → mcp_servers 항목으로 직렬화(SSE/HTTP 계열만)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mcp_servers_for_anthropic</span><span class="p">(</span><span class="n">mcp_cfg</span><span class="p">:</span> <span class="n">MCPConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># Anthropic는 원격 URL 타입만 직접 붙일 수 있음
</span>            <span class="k">continue</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">aliases</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">authorization_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_configuration</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">enabled</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<p>OpenAI Agents Python SDK용 MCP 컨텍스트 매니저 생성<br />
MCPSpec → SDK의 MCPServerSse/MCPServerStdio로 변환에 필요한 파라미터만 준비<br />
런타임은 안 만들지만, 어댑터가 어느 클래스를 써야 하는지 결정할 수 있도록 정적 매핑만 책임지게 하면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mcp_params_for_openai_agents</span><span class="p">(</span><span class="n">mcp_cfg</span><span class="p">:</span> <span class="n">MCPConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">env</span><span class="p">}})</span>
        <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">}})</span>
        <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">}})</span>
    <span class="k">return</span> <span class="n">params</span>
</code></pre></div></div>

<p>왜 이렇게 나누길 권하냐<br />
MCPSpec / ToolSpec은 불변 계약서다. 코드 리뷰·버전 관리·테스트 더블 작성이 쉽다.<br />
MCPConfig / ToolConfig는 환경별 설정과 정책을 담아 배포 파이프라인에서 바꿔치우기 좋다. 스테이징과 프로덕션을 오버레이로 구분하기 편하다.<br />
추후 런타임을 붙이고 싶어도 모델이 흔들리지 않는다. Handle/Session은 별 파일에서 추가하면 된다.</p>

<p>실무 팁<br />
Spec에 version, tags, capabilities 같은 필드를 두면 나중에 필터링이 편하다(예: tag가 readonly인 MCP만 노출).<br />
ToolSpec.parameters는 반드시 엄격하게(required, enum, format, min/max) 기입해 모델의 잘못된 호출을 줄인다.<br />
Config의 aliases는 LLM 혼동을 줄이는 데 효과적이다. 네임스페이스가 긴 툴은 별칭을 짧고 명확하게.</p>

<p>결론<br />
네 목표가 선언값만 관리하는 거라면 MCPSpec // ToolSpec로 가는 게 맞다. 여기에 환경·정책을 얹는 용도로 MCPConfig // ToolConfig를 추가하면 운영 친화적이다. 한 줄 요약은 이거다.<br />
Spec = 계약, Config = 선택과 정책.<br />
둘 다 쓰되, 각자 역할을 분명히 나누자.</p>

<p class="chat--user">

근데 클래스명을 McpSpec MCPSpec 이거 계속 헷갈림 

</p>

<p>헷갈리는 게 정상이다. 파이썬에서 약어를 클래스명에 넣을 때 선택지는 두 가지뿐이다. 하나만 고르고 끝까지 일관하면 된다.</p>

<p>권장 결론<br />
McpSpec로 통일하자. 이유는 가독성(대문자 덩어리 줄임), 타이핑 편의, 그리고 파이썬 생태계에서 HttpServer, XmlParser처럼 약어를 단어 취급하는 관례가 널리 쓰이기 때문이다. 그러면 패밀리도 자연스럽게 McpConfig, McpEndpoint, McpHandle 같은 리듬이 된다.</p>

<p>빠른 규칙 세트<br />
클래스: McpSpec, McpConfig, McpToolSpec, McpToolConfig<br />
모듈 파일: mcp_spec.py, mcp_config.py<br />
변수/매개변수: mcp_spec, mcp_config<br />
JSON 키: snake_case 면 "mcp_spec", camelCase면 "mcpSpec" (팀 컨벤션 하나만 선택)<br />
상수: MCP_SPEC_DEFAULTS처럼 전부 대문자도 가능하지만 클래스명과 혼동되니 피하는 편이 좋다</p>

<p>작게 맛보기 리팩터 스니펫</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_spec.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">McpSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">라벨/네임스페이스</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate MCP names</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>레거시 호환이 필요하면 한 줄로 다리 걸어두면 된다</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 임시 호환(향후 제거 예정)
</span><span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">McpSpec</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>만약 팀이 전통적인 “약어는 전부 대문자”를 고집한다면 MCPSpec로 가도 된다. 그 경우엔 문서·코드 전반에 동일 규칙을 강제하자. 예를 들어 클래스는 MCPSpec/MCPEndpoint, 변수는 mcp_spec, 파일은 mcp_spec.py처럼 “클래스만 ALLCAPS+CapWords, 나머진 snake_case”로 선을 긋는 식이다. 핵심은 혼용 금지다.</p>

<p>한 줄 요약<br />
파이썬 프로젝트라면 McpSpec 계열이 덜 헷갈리고 읽기 좋다. 팀 합의로 한 스타일만 박고, 클래스·모듈·변수·JSON 키에 같은 원칙을 반복 적용하면 혼란이 사라진다.</p>

<p class="chat--user">

StdioClientTransport랑 SSEClientTransport가 없다는ㄷ

</p>

<p>좋아, 이건 보통 다음 세 가지 경우 중 하나다. 차근차근 정리하고, 바로 쓸 수 있는 호환 셰임(shim) 코드까지 붙일게.</p>

<ol>
  <li>
    <p>패키지/버전 문제<br />
mcp Python SDK의 트랜스포트 경로가 버전별로 조금 달라서, 네 환경에선 <code class="language-plaintext highlighter-rouge">mcp.client.stdio</code> / <code class="language-plaintext highlighter-rouge">mcp.client.sse</code> 모듈이 없을 수 있다. 설치가 다르거나 구버전일 가능성이 높다.</p>
  </li>
  <li>
    <p>선택적 의존성 미설치<br />
SSE 트랜스포트는 선택(extra)로 분리된 경우가 있다. 즉, 기본 <code class="language-plaintext highlighter-rouge">pip install mcp</code>로는 SSE 클라이언트가 없고, 추가 의존성을 깔아야 한다.</p>
  </li>
  <li>
    <p>다른 SDK를 보고 있다<br />
이름이 비슷한 포크/래퍼(예: 예전 model-context-protocol 패키지)나 프록시 클라이언트를 깔아 두면 경로가 어긋난다.</p>
  </li>
</ol>

<p>해결 순서 한 번에 끝내기<br />
아래 명령으로 네 환경을 표준화해보자. 실패하면 바로 호환 셰임 코드가 뒤에 있다.</p>

<p>1단계. 설치/업그레이드<br />
pip install -U mcp<br />
SSE까지 쓸 거면 아래 둘 중 환경에 맞게 하나를 시도<br />
pip install -U "mcp[sse]"<br />
또는<br />
pip install -U httpx sse-starlette</p>

<p>2단계. 버전·모듈 확인<br />
python - «'PY'<br />
import pkgutil, mcp, sys<br />
print("mcp version:", getattr(mcp, "<strong>version</strong> ", "unknown"))<br />
print("has mcp.client.stdio:", pkgutil.find_loader("mcp.client.stdio") is not None)<br />
print("has mcp.client.sse:", pkgutil.find_loader("mcp.client.sse") is not None)<br />
print("has mcp.transport.stdio:", pkgutil.find_loader("mcp.transport.stdio") is not None)<br />
print("has mcp.transport.sse:", pkgutil.find_loader("mcp.transport.sse") is not None)<br />
PY</p>

<p>이제 어떤 경로가 있는지 알았으니, 호환 임포트 셰임으로 깔끔하게 처리하면 된다.</p>

<p>호환 임포트 셰임(둘 중 있는 걸 자동으로 씀)<br />
이 스니펫을 너의 공통 유틸에 넣고, 나머지 코드에선 항상 여기서 임포트한 클래스를 쓰면 경로 차이에 안 흔들린다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_compat.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># stdio
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>  <span class="c1"># 신형 경로
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.transport.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>  <span class="c1"># 구형/다른 빌드
</span>    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">StdioClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>        <span class="n">StdioServerParameters</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>
<span class="c1"># sse
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>  <span class="c1"># 신형 경로
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.transport.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>  <span class="c1"># 구형/다른 빌드
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">SSEClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>
<span class="k">def</span> <span class="nf">have_stdio</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">StdioClientTransport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">StdioServerParameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">have_sse</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">SSEClientTransport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</code></pre></div></div>

<p>사용 예시(네 기존 코드 그대로, 단 임포트만 바꿈)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 기존: from mcp.client.stdio import StdioClientTransport, StdioServerParameters
# 기존: from mcp.client.sse import SSEClientTransport
</span><span class="kn">from</span> <span class="n">mcp_compat</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span><span class="p">,</span> <span class="n">SSEClientTransport</span><span class="p">,</span> <span class="n">have_stdio</span><span class="p">,</span> <span class="n">have_sse</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_stdio</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">have_stdio</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">STDIO transport가 이 환경에 없습니다. mcp 패키지 또는 버전을 확인하세요.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}))</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">transport</span><span class="p">,</span> <span class="n">sess</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_sse</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">have_sse</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">SSE transport가 이 환경에 없습니다. </span><span class="sh">'</span><span class="s">pip install </span><span class="se">\"</span><span class="s">mcp[sse]</span><span class="se">\"</span><span class="sh">'</span><span class="s"> 또는 httpx 계열을 설치하세요.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">transport</span><span class="p">,</span> <span class="n">sess</span>
</code></pre></div></div>

<p>대체 경로가 모두 없다면<br />
OpenAI Agents Python SDK의 내장 커넥터를 써서 트랜스포트 문제를 아예 우회할 수도 있다. 네가 “MCP 서버를 그대로 넘긴다” 전략을 쓰는 경우 특히 간단하다. 이 경로에선 파이썬에서 transport를 직접 임포트하지 않는다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search</span><span class="p">:</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">pass-through</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files</span><span class="p">,</span> <span class="n">search</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">((</span><span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">sales.csv 합계를 구해줘</span><span class="sh">"</span><span class="p">)).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>정리<br />
StdioClientTransport / SSEClientTransport가 “없다”는 에러는 거의 항상 모듈 경로/버전 차이에서 온다. 위 셰임을 쓰면 코드 한 번으로 양쪽 경로를 자동 지원할 수 있고, 그래도 안 되면 Agents SDK의 내장 MCP 커넥터로 트랜스포트 계층을 통째로 맡겨 버리는 것도 깔끔한 해결책이다.</p>

<p>계속 쓰는 스타일을 정리하자면</p>

<ol>
  <li>
    <p>직접 SDK를 쓸 거면 mcp_compat.py 셰임으로 경로 차이를 흡수</p>
  </li>
  <li>
    <p>빠른 통합이면 Agents SDK의 MCPServerStdio/MCPServerSse를 사용</p>
  </li>
</ol>

<p>여기까지로 안 잡히면 네 <code class="language-plaintext highlighter-rouge">pip show mcp</code> 출력과 <code class="language-plaintext highlighter-rouge">python -c "import pkgutil; import mcp, sys; ..."</code> 결과를 알려줘. 그 정보로 정확한 임포트 경로를 딱 맞춰줄 수 있다.</p>

<p class="chat--user">

음 그냥 FastMcp 쓰는게 편할것 같네. FastMCP에서 config = { 'mcpServers': { "weather": {"url": "https://weather-api.example.com/mcp"}, "assistant": {"command": "python", "args": ["./assistant_servers.py"]} } } client = Client(config) 를 하면 바로 만들어 주는 것 같거든? 각각의 McpSpec에서 각각 한 줄을 만드는 함수 작성 + McpConfig에서 Config 자체를 만드는 함수 작성하면 좋을 것 같아.

</p>

<p>좋아, FastMCP를 기준으로 “스펙 → 한 줄”과 “스펙 모음 → 최종 config”를 자동 생성하는 얇은 레이어를 딱 만들어줄게. 네가 원하는 건 런타임이 아니라 선언값이니, McpSpec은 선언, McpConfig는 컬렉션+검증+직렬화만 맡는다.</p>

<p>아래 코드는 그대로 붙여 쓰면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_specs.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># FastMCP 관점: 원격(url) 또는 로컬(stdio)
</span>
<span class="k">class</span> <span class="nc">McpSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">FastMCP에서 사용할 서버 라벨</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># url 서버
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># stdio 서버
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>           <span class="c1"># 선택: 필터링/문서화에 유용
</span>    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>                       <span class="c1"># 선택: 사람 읽는 설명
</span>
    <span class="nd">@field_validator</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_name_non_empty</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">name must be non-empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">to_fastmcp_entry</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        FastMCP 설정의 </span><span class="sh">'</span><span class="s">한 줄</span><span class="sh">'</span><span class="s">을 만든다.
        반환 예시:
          {</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">https://...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="s">: {...}}
          {</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="s">: [</span><span class="sh">"</span><span class="s">./server.py</span><span class="sh">"</span><span class="s">], </span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="s">: {...}}
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: url kind requires url</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">headers</span>
            <span class="k">return</span> <span class="n">entry</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio kind requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">command</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">args</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="k">return</span> <span class="n">entry</span>

        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: unknown kind </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">kind</span><span class="si">!r}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpSpec</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">dupes</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate spec names: </span><span class="si">{</span><span class="nf">sorted</span><span class="p">(</span><span class="n">dupes</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: url is required for kind=</span><span class="sh">'</span><span class="s">url</span><span class="sh">'"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: command is required for kind=</span><span class="sh">'</span><span class="s">stdio</span><span class="sh">'"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_fastmcp_config</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">exclude_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">enable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">name_alias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        FastMCP가 바로 먹는 dict를 만든다.
        반환 예시:
          {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="s">: {...}, </span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="s">: {...}}}
        옵션:
          include_tags: 지정된 태그가 하나라도 있는 스펙만 포함
          exclude_tags: 지정된 태그가 하나라도 있으면 제외
          enable: {</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: True/False} 형태의 on/off 오버라이드
          name_alias: {</span><span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">alias</span><span class="sh">"</span><span class="s">} 키 변경(LLM/사람에게 보일 라벨 바꾸기)
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">servers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">include_tags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">tags</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exclude_tags</span> <span class="ow">and</span> <span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">exclude_tags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">tags</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">enable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">enable</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">key</span> <span class="o">=</span> <span class="n">name_alias</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name_alias</span> <span class="k">else</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span>
            <span class="n">servers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="nf">to_fastmcp_entry</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">servers</span><span class="p">}</span>

    <span class="c1"># 편의: 체이닝 등록
</span>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">McpSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">McpConfig</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span>
</code></pre></div></div>

<p>간단 사용 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 예시 1) 질문에서 준 config를 코드로 생성
</span><span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpSpec</span><span class="p">,</span> <span class="n">McpConfig</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="p">[</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]),</span>
<span class="p">])</span>

<span class="n">fastmcp_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">()</span>
<span class="c1"># fastmcp_config == {
#   "mcpServers": {
#     "weather": {"url": "https://weather-api.example.com/mcp"},
#     "assistant": {"command": "python", "args": ["./assistant_servers.py"]}
#   }
# }
</span>
<span class="c1"># FastMCP 클라이언트에 그대로 투입
# from fastmcp import Client
# client = Client(fastmcp_config)
</span></code></pre></div></div>

<p>태그/별칭/부분 사용 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">().</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">readonly</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">public</span><span class="sh">"</span><span class="p">])</span>
<span class="p">).</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./db_server.py</span><span class="sh">"</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">MODE</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">prod</span><span class="sh">"</span><span class="p">},</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">write</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">internal</span><span class="sh">"</span><span class="p">])</span>
<span class="p">).</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">],</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">helper</span><span class="sh">"</span><span class="p">])</span>
<span class="p">)</span>

<span class="c1"># 읽기 전용만 포함하고, weather를 public-weather로 라벨링
</span><span class="n">fastmcp_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">(</span>
    <span class="n">include_tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">readonly</span><span class="sh">"</span><span class="p">],</span>
    <span class="n">name_alias</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">public-weather</span><span class="sh">"</span><span class="p">}</span>
<span class="p">)</span>
<span class="c1"># 결과:
# {"mcpServers": {"public-weather": {"url": "https://weather-api.example.com/mcp"}}}
</span></code></pre></div></div>

<p>검증 포인트 요약</p>

<ol>
  <li>
    <p>McpSpec.to_fastmcp_entry가 “url”과 “stdio” 케이스를 각각 한 줄로 생성한다.</p>
  </li>
  <li>
    <p>McpConfig.to_fastmcp_config가 필터링과 on/off, 별칭을 지원한다.</p>
  </li>
  <li>
    <p>FastMCP의 Client(config) 호출에 바로 넣을 수 있는 구조를 만든다.</p>
  </li>
</ol>

<p>확장 아이디어<br />
headers, env에 비밀값이 들어가면 McpConfig에서 별도 시크릿 소스로 병합하는 훅을 추가해도 좋다.<br />
테넌트별로 enable dict를 바꾸는 것만으로 동일 스펙에서 다른 배포 구성을 만들 수 있다.<br />
나중에 Elicitation/Prompt 같은 메타가 필요하면 McpSpec에 meta: Dict[str, Any] 정도를 추가해도 직렬화 흐름엔 영향이 없다.</p>

<p>이렇게 두면 “각각의 McpSpec에서 각각 한 줄”과 “McpConfig에서 최종 config”가 둘 다 한 번에 해결된다.</p>

<p class="chat--user">

아 그런데 config가 없으면 어떻게 되지?

</p>

<p>좋은 포인트다. “config가 없을 때”는 두 가지를 분리해서 생각하면 깔끔하다.</p>

<ol>
  <li>FastMCP Client 레벨에서의 기대 동작<br />
일반적으로 Client는 최소한 {"mcpServers": {}} 형태의 딕셔너리를 기대한다. 완전히 None이거나 키가 없으면 내부에서 KeyError/TypeError 류가 날 가능성이 높다. 안전하게 가려면 다음을 지키자.</li>
</ol>

<ul>
  <li>
    <p>비어 있어도 된다: 빈 설정은 곧 “연결된 MCP 서버 없음”이니, Client는 뜨지만 툴은 없다.</p>
  </li>
  <li>
    <p>키는 반드시 있어야 한다: {"mcpServers": {}} 형태를 보장하자.</p>
  </li>
  <li>
    <p>잘못된 형태는 막자: 문자열이나 리스트 같은 타입이 들어가면 바로 예외를 던지게 하자.</p>
  </li>
</ul>

<ol>
  <li>네 선언 계층(McpSpec / McpConfig)에서의 방어 전략<br />
런타임을 다루지 않기로 했으니, 선언-직렬화 단계에서 다음의 fallbacks를 두면 실전에서 편하다.</li>
</ol>

<ul>
  <li>
    <p>config가 None이면 빈 구조로 만들어 준다.</p>
  </li>
  <li>
    <p>mcpServers 키가 없으면 생성해 준다.</p>
  </li>
  <li>
    <p>specs가 비어 있으면 빈 딕셔너리를 넣되, 로거 경고를 남긴다.</p>
  </li>
  <li>
    <p>환경변수나 기본 파일 경로에서 자동으로 끌어오는 선택지를 둔다(있으면 사용, 없으면 빈 dict).</p>
  </li>
</ul>

<p>아래 헬퍼를 넣으면 실수해도 안전하게 동작한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_guard.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="c1"># 이전에 만든 선언 모델이라고 가정
# from fastmcp_specs import McpSpec, McpConfig
</span>
<span class="k">def</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="sh">"</span><span class="s">McpSpec</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>     <span class="c1"># 문자열 인용은 순환 import 회피용
</span>    <span class="n">env_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">FASTMCP_SERVERS_JSON</span><span class="sh">"</span><span class="p">,</span>       <span class="c1"># 옵션: {"weather":{"url":"..."}, "assistant":{...}} 형태
</span>    <span class="n">file_env_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">FASTMCP_CONFIG_PATH</span><span class="sh">"</span>    <span class="c1"># 옵션: JSON 파일 경로
</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    1순위: 명시 config
    2순위: specs → {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: {...}} 직렬화
    3순위: 환경변수에서 로드
    4순위: 빈 설정으로 폴백
    항상 {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: dict} 형태를 보장한다.
    </span><span class="sh">"""</span>
    <span class="c1"># 1) 명시 config
</span>    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">config must be a dict or None</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="c1"># 부분 설정만 온 경우 보완
</span>            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)}</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="c1"># 2) specs → 직렬화
</span>    <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpConfig</span>  <span class="c1"># 지역 임포트로 순환 참조 회피
</span>        <span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">()</span>

    <span class="c1"># 3) 환경변수: 파일 경로 우선
</span>    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">file_env_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># 파일이 {"mcpServers":{...}} 형태이거나 {"weather":{...}} 같은 맵일 수도 있음
</span>        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">file config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">file config must be a dict</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">env config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">env config must be a dict</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 4) 최종 폴백: 빈 설정
</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
</code></pre></div></div>

<p>즉시 사용 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1) config가 None인 상황
</span><span class="kn">from</span> <span class="n">fastmcp_guard</span> <span class="kn">import</span> <span class="n">ensure_fastmcp_config</span>
<span class="c1"># from fastmcp import Client
</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>  <span class="c1"># {"mcpServers": {}}
# client = Client(cfg)  # 툴 없이 실행
</span>
<span class="c1"># 2) McpSpec만 있고 config가 없는 상황
</span><span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpSpec</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]),</span>
<span class="p">]</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>
<span class="c1"># client = Client(cfg)
</span>
<span class="c1"># 3) 환경변수로만 공급하는 상황
# export FASTMCP_SERVERS_JSON='{"weather":{"url":"https://weather-api.example.com/mcp"}}'
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">()</span>
<span class="c1"># client = Client(cfg)
</span></code></pre></div></div>

<p>운영 팁 한 줄 요약<br />
빈 설정은 허용하되 형태는 항상 보장하자. 즉, 최소 {"mcpServers": {}}를 만들어서 Client가 안정적으로 뜨게 하고, 실제 서버 없으면 “툴 없음” 상태로만 동작하게 하는 게 제일 안전하다. 필요하면 ensure_fastmcp_config 내부에 로깅을 넣어 “현재 MCP 서버 0개” 같은 경고를 남기면 실수도 빨리 잡힌다.</p>

<p class="chat--user">

이렇게 만든 FastMcp Client의 툴과 내가 만든 일반 ToolSpec을 둘 다 고려해서 chat completions 호출 -&gt; 그 후 요청하는 함수 실행을 만들고 싶어 async with Client(cfg) as client: client.list_tools() # mcp tool 반환 client.call_tool(함수명, 인자) 이렇게 쓸 수 있어. fastmcp는 이 두 가지를 어떻게 하면 잘 쓰게 할 수 있을까

</p>

<p>좋아. 목표는 FastMCP의 툴들과 네가 직접 정의한 일반 ToolSpec들을 “하나의 툴 세트”처럼 묶어서 Chat Completions with tools를 돌리고, 모델이 요청한 tool_calls를 각각 알맞은 실행기로 라우팅하는 것. 아래 스캐폴딩은 그대로 붙여서 돌아가도록 설계했다.</p>

<p>핵심 아이디어</p>

<ol>
  <li>
    <p>FastMCP의 client.list_tools() 결과를 OpenAI tools 포맷으로 정규화하고 이름에 접두사 mcp:를 붙인다.</p>
  </li>
  <li>
    <p>네 로컬 ToolSpec들도 같은 포맷으로 직렬화한다.</p>
  </li>
  <li>
    <p>Chat Completions 첫 호출에 두 종류 툴을 모두 넣는다.</p>
  </li>
  <li>
    <p>tool_calls 루프에서 이름이 mcp:면 client.call_tool로, 아니면 LocalToolRegistry 핸들러로 실행한다.</p>
  </li>
</ol>

<p>코드</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># unified_fastmcp_chat.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="c1">###############################################################################
# 0) 로컬 ToolSpec 정의(한 번만 구현해서 공통 사용)
###############################################################################
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">LocalToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate tool: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_openai_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">.</span><span class="nf">values</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# 1) FastMCP → OpenAI tools 정규화
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    FastMCP client.list_tools()를 호출해 OpenAI tools 포맷으로 변환.
    각 이름에는 </span><span class="sh">'</span><span class="s">mcp:</span><span class="sh">'</span><span class="s"> 접두사를 붙여 로컬 툴과 충돌을 방지.
    FastMCP 툴 메타는 다음 필드를 가진다고 가정: name, description, parameters(JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">def</span> <span class="nf">is_mcp_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">strip_mcp_prefix</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tool_name</span><span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span> <span class="k">if</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">else</span> <span class="n">tool_name</span>

<span class="c1">###############################################################################
# 2) Chat Completions 호출 러너(두 툴 세트를 한꺼번에 노출)
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">local_registry</span><span class="p">:</span> <span class="n">LocalToolRegistry</span><span class="p">,</span>
        <span class="n">fastmcp_client</span><span class="p">,</span>
        <span class="n">expose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 1) 툴 카탈로그 합치기
</span>        <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">fastmcp_client</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">local_tools</span> <span class="o">=</span> <span class="n">local_registry</span><span class="p">.</span><span class="nf">list_openai_tools</span><span class="p">()</span>
        <span class="n">all_tools</span> <span class="o">=</span> <span class="n">local_tools</span> <span class="o">+</span> <span class="n">mcp_tools</span>
        <span class="k">if</span> <span class="n">expose</span><span class="p">:</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="nf">expose</span><span class="p">(</span><span class="n">all_tools</span><span class="p">)</span>  <span class="c1"># 턴별 소출 정책(선택)
</span>
        <span class="c1"># 2) 1차 모델 호출
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 3) tool_calls 루프
</span>        <span class="n">rounds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">rounds</span> <span class="o">&lt;</span> <span class="n">max_rounds</span><span class="p">:</span>
            <span class="n">rounds</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw</span><span class="p">}</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nf">is_mcp_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">):</span>
                        <span class="c1"># FastMCP 경로
</span>                        <span class="n">mcp_name</span> <span class="o">=</span> <span class="nf">strip_mcp_prefix</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fastmcp_client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">mcp_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># 로컬 툴 경로
</span>                        <span class="n">spec</span> <span class="o">=</span> <span class="n">local_registry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span>
                <span class="p">})</span>

            <span class="c1"># 다음 턴
</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# 3) 사용 예시
###############################################################################
</span>
<span class="c1"># 예시 로컬 툴 구현
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) FastMCP 클라이언트 준비
</span>    <span class="c1"># from fastmcp import Client
</span>    <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">},</span>
            <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># async with Client(cfg) as client:
</span>    <span class="c1">#     ...
</span>
    <span class="c1"># 데모를 위해 간이 더미 클라이언트를 흉내내자. 실제로는 fastmcp.Client를 사용.
</span>    <span class="k">class</span> <span class="nc">DummyFastMCP</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">self</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
            <span class="c1"># 이름은 서버 네임스페이스를 포함해주면 LLM이 더 잘 고른다
</span>            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">weather:get_forecast</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">도시/날짜별 일기예보</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">}},</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">]</span>
                <span class="p">}},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant:read_csv_sum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CSV 합계 계산</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">]</span>
                <span class="p">}}</span>
            <span class="p">]</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="c1"># 여기서는 결과 형태만 맞춰준다
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo-result</span><span class="sh">"</span><span class="p">}</span>

    <span class="c1"># 1) 로컬 툴 레지스트리
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolRegistry</span><span class="p">()</span>
    <span class="n">local</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
        <span class="n">handler</span><span class="o">=</span><span class="n">math_eval</span>
    <span class="p">))</span>

    <span class="c1"># 2) 러너
</span>    <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 3) 통합 실행
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">필요한 도구만 호출한다. 파괴적 작업은 dry_run 우선.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant:read_csv_sum으로 data/sales.csv 합계를 구하고, local.math_eval로 (100+23)도 계산해줘</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">async</span> <span class="k">with</span> <span class="nc">DummyFastMCP</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">local_registry</span><span class="o">=</span><span class="n">local</span><span class="p">,</span> <span class="n">fastmcp_client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== FINAL ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>운영 포인트<br />
이름 규칙을 고정하자. mcp: 접두사로 FastMCP에서 온 툴을 표시하면 충돌을 방지하고 라우팅이 단순해진다. FastMCP 쪽 툴 이름에 이미 server:tool 형태가 들어가 있어도 상관없다. 최종 노출명은 mcp:server:tool처럼 되지만 LLM이 의외로 잘 고른다.<br />
툴 소출을 넣자. expose 콜백으로 턴별로 필요한 서브셋만 tools에 담으면 선택 오류와 지연이 줄어든다.<br />
결과 포맷을 통일하자. tool role 메시지 content는 항상 JSON 문자열로 넣는 게 후속 라운드에서 안정적이다.<br />
에러는 JSON으로. 실행기 에러도 {"error": "…"}로 통일해 모델이 복구 플랜을 세우기 좋게 만든다.</p>

<p>이 구조면 FastMCP가 제공하는 툴과 네 로컬 ToolSpec을 동시에 들고, 표준 Chat Completions 루프에서 자연스럽게 섞어 쓸 수 있다. 필요한 경우 expose 정책, 이름 별칭, 기본 인자 주입 같은 정책 훅을 runner.run의 인자로 얹어 확장하면 된다.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python MCP 연결 방법</title><link href="https://hvppyarchive.github.io/llm/unified-mcp-interface/" rel="alternate" type="text/html" title="Python MCP 연결 방법" /><published>2025-10-28T20:16:40+09:00</published><updated>2025-10-28T20:16:40+09:00</updated><id>https://hvppyarchive.github.io/llm/unified-mcp-interface</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/unified-mcp-interface/"><![CDATA[<p class="chat--user">

너는 LLM Agent 전문가야. MCP 두 개 이상(이건 입력으로 커맨드를 여러개 받을 수 있어)을 띄우고 모든 MCP 툴을 LLM에게 전달 및 실행하고 싶어. 

</p>

<p>좋아, 여러 개의 MCP 서버를 동시에 붙여서 “모든 MCP 툴을 LLM이 한 번에 보고 실행”하게 만드는 방법을 두 가지 경로로 정리해줄게. 첫째는 Anthropic Messages API의 MCP 커넥터를 그대로 쓰는 방법(가장 간단). 둘째는 직접 MCP 클라이언트를 만들어 여러 서버에 붙고, 툴 카탈로그를 합쳐서 LLM에게 제공하는 방법(커스텀 제어). 단계별로 바로 따라하면 된다. 인용구문은 쓰지 않는다.</p>

<h1 id="1-가장-쉬운-길-claude-messages-api의-mcp-커넥터로-여러-서버-붙이기">1) 가장 쉬운 길: Claude Messages API의 MCP 커넥터로 여러 서버 붙이기</h1>

<p>핵심은 <code class="language-plaintext highlighter-rouge">messages.create</code> 호출에 <code class="language-plaintext highlighter-rouge">mcp_servers</code> 배열을 넣어 여러 서버를 동시에 선언하는 것. 서버마다 이름을 부여하면 충돌 없이 툴을 구분할 수 있고, 모델은 각 서버에서 노출된 MCP 툴을 필요할 때 호출한다. 베타 헤더가 필요하다.</p>

<p>요청 바디 예시(둘 이상의 서버 연결):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">"claude-sonnet-4-5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"max_tokens"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"두 서버의 툴을 모두 활용해서 작업을 끝내줘"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"mcp_servers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example1.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tool_configuration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example2.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>이 방식의 포인트</p>

<ol>
  <li>
    <p>한 요청에서 여러 MCP 서버의 툴을 모두 노출할 수 있다.</p>
  </li>
  <li>
    <p>서버 이름(<code class="language-plaintext highlighter-rouge">name</code>)이 툴 호출 블록에 함께 들어가서 충돌을 피한다.</p>
  </li>
  <li>
    <p>현재는 “MCP의 툴 호출”만 지원(리소스/프롬프트 등은 제외)되고, HTTP로 공개된 원격 서버만 직접 연결된다(로컬 stdio는 불가). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>
  </li>
</ol>

<p>문서 근거와 스펙<br />
• MCP 커넥터 사용법과 멀티 서버 예시는 Claude 공식 문서의 “MCP connector”와 “Multiple MCP servers” 섹션에 그대로 있다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• MCP 자체 개념과 스펙은 프로토콜 사이트와 스펙 문서 참고. <a href="https://modelcontextprotocol.io/?utm_source=chatgpt.com">모델 컨텍스트 프로토콜+1</a></p>

<p>이 경로로 가면 “LLM에게 MCP 툴 전체를 그대로 전달하고, 실행은 모델이 알아서 서버별로 라우팅”해준다. 운영에서 OAuth 토큰이 필요한 서버는 <code class="language-plaintext highlighter-rouge">authorization_token</code> 필드로 전달하면 된다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>

<h1 id="2-더-유연한-길-직접-mcp-클라이언트를-만들어-멀티-서버--단일-툴-레지스트리로-합치기">2) 더 유연한 길: 직접 MCP 클라이언트를 만들어 “멀티 서버 → 단일 툴 레지스트리”로 합치기</h1>

<p>로컬/사내용 툴까지 다 엮고 싶거나, 툴 노출/로그/권한을 섬세하게 통제하려면 직접 클라이언트를 만드는 편이 좋다. 공식 SDK가 있다(타입스크립트, 파이썬 등). <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>

<p>아키텍처 개요</p>

<ol>
  <li>
    <p>각 MCP 서버와 별도의 세션으로 연결(stdio 또는 HTTP).</p>
  </li>
  <li>
    <p>모든 서버에서 <code class="language-plaintext highlighter-rouge">list_tools</code>를 받아 합친다. 이때 충돌을 막기 위해 <code class="language-plaintext highlighter-rouge">serverName:toolName</code> 같은 네임스페이스를 붙인다.</p>
  </li>
  <li>
    <p>합쳐진 툴 목록을 LLM의 “도구(Function/Tool Use)”로 등록한다.</p>
  </li>
  <li>
    <p>LLM이 <code class="language-plaintext highlighter-rouge">serverName:toolName</code>을 호출하면, 해당 서버 세션으로 라우팅해서 <code class="language-plaintext highlighter-rouge">call_tool</code> 실행 → 결과를 모델에 <code class="language-plaintext highlighter-rouge">tool_result</code>로 되돌린다.</p>
  </li>
</ol>

<p>예시 코드(타입스크립트, Node). 여러 서버에서 툴을 모아 네임스페이스화하고, 호출 시 라우팅한다. SDK는 공식 TS SDK를 사용한다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

// package.json: @modelcontextprotocol/sdk, zod, anthropic 등 설치 가정
// npm i @modelcontextprotocol/sdk zod anthropic

import { ClientSession } from '@modelcontextprotocol/sdk/client/session.js';
import { StdioClientTransport, StdioServerParameters } from '@modelcontextprotocol/sdk/client/stdio.js';
import Anthropic from '@anthropic-ai/sdk';

// 서버 설정
type ServerCfg = { name: string; command: string; args: string[] };
const SERVERS: ServerCfg[] = [
  { name: 'files', command: 'node', args: ['./servers/files/index.js'] },
  { name: 'db', command: 'python', args: ['./servers/db/server.py'] },
];

type Connected = {
  name: string;
  session: ClientSession;
};

const connected: Connected[] = [];

async function connectAll() {
  for (const s of SERVERS) {
    const params: StdioServerParameters = { command: s.command, args: s.args };
    const transport = new StdioClientTransport(params);
    await transport.start();
    const session = new ClientSession(transport);
    await session.initialize();
    connected.push({ name: s.name, session });
    console.log(`[MCP] connected: ${s.name}`);
  }
}

type ToolDesc = {
  name: string;              // namespaced: `${server}:${tool}`
  description?: string;
  input_schema: any;         // JSON Schema
};

// 모든 서버의 툴을 수집하여 네임스페이스 부여
async function collectTools(): Promise&lt;ToolDesc[]&gt; {
  const all: ToolDesc[] = [];
  for (const { name: serverName, session } of connected) {
    const { tools } = await session.listTools();
    for (const t of tools) {
      all.push({
        name: `${serverName}:${t.name}`,
        description: t.description,
        input_schema: t.inputSchema,
      });
    }
  }
  return all;
}

// LLM이 namespaced 툴을 호출하면 해당 서버로 라우팅
async function callNamespacedTool(nsName: string, args: any) {
  const [serverName, toolName] = nsName.split(':');
  const target = connected.find(c =&gt; c.name === serverName);
  if (!target) throw new Error(`Server not found: ${serverName}`);
  return target.session.callTool(toolName, args);
}

async function main() {
  await connectAll();
  const tools = await collectTools();

  const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! });

  // 대화 루프의 한 턴 예시
  let messages: any[] = [{ role: 'user', content: 'CSV를 DB에 적재하고 요약해줘' }];

  // Anthropic의 Tool Use 포맷에 맞춰 툴 전달
  const toolDefs = tools.map(t =&gt; ({
    name: t.name,
    description: t.description,
    input_schema: t.input_schema,
  }));

  let resp = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 1000,
    messages,
    tools: toolDefs,
  });

  // tool_use 처리 루프
  while (resp.content.some((c: any) =&gt; c.type === 'tool_use')) {
    const assistantContent: any[] = [];
    const toolResults: any[] = [];

    for (const c of resp.content) {
      if (c.type === 'text') assistantContent.push(c);
      if (c.type === 'tool_use') {
        const result = await callNamespacedTool(c.name, c.input);
        toolResults.push({
          type: 'tool_result',
          tool_use_id: c.id,
          content: result.content, // MCP 표준 content 배열
        });
      }
    }

    messages.push({ role: 'assistant', content: assistantContent.concat(resp.content.filter((c: any) =&gt; c.type === 'tool_use')) });
    messages.push({ role: 'user', content: toolResults });

    resp = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1000,
      messages,
      tools: toolDefs,
    });
  }

  console.log(resp.content.map((c: any) =&gt; (c.type === 'text' ? c.text : '')).join('\n'));
}

main().catch(e =&gt; { console.error(e); process.exit(1); });
</code></pre></div></div>

<p>이 패턴의 장점<br />
• 어떤 LLM이든(Anthropic/OpenAI/로컬) 표준 “툴 호출” 인터페이스만 있으면 같은 레지스트리를 재활용할 수 있다.<br />
• 서버별 권한, 로깅, 레이트 리밋, 입력 검증을 중앙에서 통제 가능.<br />
• 네임스페이스 전략으로 툴 이름 충돌을 확실히 방지.<br />
• stdio 로컬 서버와 원격 HTTP 서버를 섞어서 붙일 수 있다(직접 클라이언트 방식이므로). SDK가 stdio/HTTP 모두 지원한다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>설치·참고<br />
• 공식 TS SDK와 예제 서버/클라이언트, Streamable HTTP/stdio 전송계층은 깃허브 README와 예제에 상세. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a><br />
• “Build an MCP client” 튜토리얼(파이썬/노드 포함)도 멀티 서버로 확장하기 쉽다. 위 예시 로직은 그 흐름을 일반화한 것. <a href="https://modelcontextprotocol.io/quickstart/client">모델 컨텍스트 프로토콜</a></p>

<h1 id="운영-팁과-함정실무-체크리스트">운영 팁과 함정(실무 체크리스트)</h1>

<p>네임스페이스 규칙<br />
• <code class="language-plaintext highlighter-rouge">${server}:${tool}</code>로 고정하면 라우팅이 단순해진다. 툴 설명에도 서버명을 적어 LLM의 선택을 돕는다.<br />
• 모델이 “비슷한 두 툴”을 혼동할 수 있으니 설명에 차이를 명확히 쓰고 스키마에 제약을 넣는다.</p>

<p>권한과 안전장치<br />
• 서버별 <code class="language-plaintext highlighter-rouge">allowed_tools</code>로 노출 툴을 제한하거나, 자체 클라이언트라면 툴 화이트리스트를 적용한다. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• 파괴적 툴(삭제/결제 등)은 “dry_run” 플래그를 스키마에 추가해 2단계 확인을 강제.<br />
• 프롬프트 인젝션 방지: 서버 측에서 입력 검증과 URL/경로 화이트리스트를 둔다.</p>

<p>성능/안정성<br />
• 초기에 모든 서버에 <code class="language-plaintext highlighter-rouge">list_tools</code>를 한 번만 호출하고 캐싱하라.<br />
• 툴 호출은 타임아웃과 재시도를 둔다. 실패 시 에러 메시지와 복구 힌트를 모델에게 짧게 제공하면 후속 계획을 모델이 스스로 조정한다.<br />
• 결과가 큰 경우(파일/표)는 리소스 링크를 반환하도록 MCP 쪽에서 설계하면 토큰 압박을 줄일 수 있다(리소스는 커넥터 경로에 따라 제한될 수 있음).</p>

<p>배포 토막 가이드<br />
• 원격 연결 위주면 Claude의 MCP 커넥터가 가장 빠른 온보딩이다(단, HTTP 공개 필요). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
• 사내망·로컬 혼합이면 직접 클라이언트 구성이 유리하다. TS SDK의 streamable HTTP + stdio를 혼용하면 된다. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>다음 확장 아이디어<br />
• “자동 라우터”: 툴 메타데이터에 domain 태그를 두고, 사용자 요청을 분류해 관련 서버 툴만 모델에 노출(토큰/혼란 감소).<br />
• “관측성”: 모든 tool_use/tool_result를 이벤트로 로그 수집해 실패율/지연/입력 분포를 대시보드로 본다.<br />
• “권한 승격”: 고위험 툴 호출은 사람 확인을 요구하는 인가 훅을 중앙 클라이언트에 추가.</p>

<p>원하면 네가 쓰려는 서버 목록과 전송 방식(stdio/HTTP), 붙일 모델(Claude/OpenAI 등)을 알려줘. 거기에 맞춰 완성 스캐폴딩을 바로 내줄게.</p>

<p class="chat--user">

타입스크립트 말고 파이썬 mcp 로 부탁해 그리고 커스텀 엔드포인트 LLM을 사용할거야.

</p>

<p>좋아. 파이썬으로 MCP 다중 서버를 붙이고, 커스텀 LLM 엔드포인트(자체 호스팅 모델)에 “툴 콜링”을 돌리는 전체 오케스트레이터 스캐폴딩을 바로 줄게. 핵심 아이디어는 두 가지다. 첫째, 여러 MCP 서버에 각각 세션을 열고 툴 목록을 합쳐서 네임스페이스(server:tool)로 노출. 둘째, 커스텀 LLM의 /chat API에 툴 스키마를 전달하고, 응답 내 tool_calls를 받아 해당 MCP 서버로 라우팅해 실행 결과를 다시 모델에 피드백하는 루프를 돈다.</p>

<p>아래 코드는 바로 실행 가능한 단일 파일 예시다. 커스텀 LLM의 API 포맷은 OpenAI 함수콜과 유사한 형태를 가정했지만, 클래스 한 군데만 바꾸면 어떤 엔드포인트든 맞출 수 있도록 어댑터를 분리해두었다.</p>

<p>설치 가정<br />
pip install mcp requests pydantic orjson</p>

<p>main.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># 선택: SSE(원격 HTTP) 서버를 붙일 때
</span>    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#######################################################################
# 0) 데이터 모델: LLM과 툴콜 인터페이스(커스텀 엔드포인트 어댑터용)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI style에 가깝게 노멀라이즈해 커스텀 LLM에 전달
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(JSON str)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># 필요 시 stop_reason 등 추가
</span>
<span class="c1">#######################################################################
# 1) MCP 연결 유틸: 여러 서버 연결하고 툴 합치기(네임스페이스)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># stdio 또는 sse
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># sse
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 설치되어야 SSE 연결을 사용할 수 있습니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="c1"># t.name, t.description, t.input_schema
</span>                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># JSON Schema
</span>                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># namespaced = "server:tool"
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">툴 이름은 </span><span class="sh">'</span><span class="s">server:tool</span><span class="sh">'</span><span class="s"> 형식이어야 합니다: </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server_name</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="c1"># MCP 표준 content를 단일 문자열 또는 JSON으로 정리
</span>                <span class="c1"># MCP content는 list of {type: "text"|"json"|"blob", ...}
</span>                <span class="c1"># 여기서는 간단히 text/json만 지원 예시
</span>                <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># blob/resource 등은 필요 시 확장
</span>                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">서버를 찾을 수 없음: </span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1">#######################################################################
# 2) 커스텀 LLM 어댑터: 너의 사설 /chat 엔드포인트에 맞춰 조정
#######################################################################
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    너의 커스텀 엔드포인트 규약을 한 곳에 캡슐화.
    아래는 예시 규약:
      POST {base_url}/chat
      json: {
        </span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}],
        </span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...}}}]
      }
    응답:
      {
        </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">assistant text...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [
          {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">{</span><span class="se">\"</span><span class="s">k</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">v</span><span class="se">\"</span><span class="s">}</span><span class="sh">"</span><span class="s">}}
        ]
      }
    필요한 경우 이 클래스만 수정하면 된다.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">extra_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span> <span class="o">=</span> <span class="n">extra_headers</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span> <span class="k">if</span> <span class="n">tools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

<span class="c1">#######################################################################
# 3) 오케스트레이터: 툴 병합 → LLM 대화 루프 → MCP 라우팅
#######################################################################
</span>
<span class="k">def</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">merged_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
    <span class="n">defs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">merged_tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP tool </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="p">}</span>
        <span class="n">defs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">defs</span>

<span class="k">def</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">args_raw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">args_raw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args_raw</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args_raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sh">""</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 모델이 JSON이 아닌 걸 내는 경우 방어
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_conversation</span><span class="p">(</span>
    <span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">):</span>
    <span class="n">tools_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">llm_tools</span> <span class="o">=</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">tools_catalog</span><span class="p">)</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">system_prompt</span><span class="p">:</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">))</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">llm_tools</span><span class="p">)</span>
        <span class="c1"># 우선 어시스턴트 텍스트가 있으면 추가
</span>        <span class="n">assistant_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="n">assistant_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">assistant_text</span><span class="p">))</span>

        <span class="c1"># 툴콜 없으면 종료
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># MCP 라우팅 → 결과를 tool_result로 user에 피드백
</span>        <span class="n">tool_results_acc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="c1"># 결과를 다시 모델에게 피드백: 단순화를 위해 JSON 텍스트로 합침
</span>                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="c1"># 다수 툴 호출 결과를 하나의 user 메시지로 재주입
</span>        <span class="n">feedback_text</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tool_results_acc</span><span class="p">)</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="si">{</span><span class="n">feedback_text</span><span class="si">}</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1">#######################################################################
# 4) 샘플 엔트리포인트
#######################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 4-1) 붙일 MCP 서버들 정의
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># 로컬 stdio 예시
</span>        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># 원격 SSE 예시(있다면)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"authorization":"Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>

    <span class="c1"># 4-2) 커스텀 LLM 엔드포인트 설정
</span>    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_API_KEY</span><span class="sh">"</span><span class="p">),</span>            <span class="c1"># 필요 시
</span>        <span class="n">extra_headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">x-tenant</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo</span><span class="sh">"</span><span class="p">}</span>                 <span class="c1"># 필요 시
</span>    <span class="p">)</span>

    <span class="c1"># 4-3) 대화 한 턴 예시
</span>    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">너는 MCP 툴을 활용해 일을 끝내는 에이전트다. 위험 작업은 dry_run을 선호하고, 명시적으로 승인받기 전에는 파괴적 변경을 하지 않는다.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSV를 files 서버의 ingest_csv 툴로 적재하고, db 서버의 sql_summary로 요약해줘. 파일 경로는 ./data/sales.csv</span><span class="sh">"</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_conversation</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 대화 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">2000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>동작 흐름 설명<br />
1단계. MCPMux가 각 서버에 세션을 연다. stdio 서버는 command+args로 프로세스를 실행하고, sse 서버는 HTTP SSE로 연결한다.<br />
2단계. list_tools를 모든 서버에서 모아서 네임스페이스(server:tool)로 변환한다.<br />
3단계. 커스텀 LLM 엔드포인트에 messages와 tools를 넘긴다. tools는 OpenAI식 function 포맷으로 정규화해서 전달한다.<br />
4단계. LLM이 tool_calls를 반환하면, 각 call의 function.name이 server:tool이므로 해당 서버로 라우팅해서 call_tool을 실행한다.<br />
5단계. 결과를 TOOL_RESULTS 텍스트로 user 역할 메시지에 합쳐서 모델에 다시 주입한다. 모델은 추가적인 tool_calls를 내거나, 최종 답변을 낸다.<br />
6단계. tool_calls가 더 이상 없으면 루프 종료.</p>

<p>운영 팁<br />
네임스페이스 고정. server:tool 네이밍을 스키마 description에도 반복해서 LLM의 선택 오류를 줄인다.<br />
권한 경계. 삭제·결제·배포 같은 툴에는 parameters에 dry_run(boolean, default true) 같은 필드를 추가해 2단계 승인을 유도하라.<br />
타임아웃·재시도. SSE나 stdio 모두 외부 프로세스/네트워크에 민감하니 call_tool에는 서버 측 타임아웃과 재시도를 둔다. 필요 시 MCPMux.call에 재시도를 추가하라.<br />
대용량 결과. 파일·표·바이너리 결과는 MCP 리소스(파일 핸들)나 외부 저장소 URL을 반환하고, LLM에는 메타데이터만 보내 토큰을 아끼는 설계를 추천한다.<br />
적응층. CustomLLMClient를 너의 실제 /chat 규격에 맞게 수정한다. 예컨대 문서화된 JSON 키 이름이 다르면 ChatResponse 파싱만 바꾸면 된다.</p>

<p>테스트 방법<br />
가짜 서버부터. servers 디렉터리에 echo 수준의 간단한 MCP 서버 두 개(files, db)를 만들어 list_tools와 call_tool만 최소 구현한다.<br />
단위 테스트. CustomLLMClient.send를 모킹해 tool_calls를 강제로 내보내고, MCPMux.call이 올바른 서버로 라우팅되는지 확인한다.<br />
엔드투엔드. 실제 LLM 엔드포인트로 교체해 CSV → SQL 요약 같은 워크플로를 한 번에 돌려본다.</p>

<p>확장 아이디어<br />
자동 라우팅. 도메인 태그(files/db/search 등)를 보고 관련 툴만 tools 배열에 노출해 토큰과 혼란을 줄인다.<br />
감사 로그. 모든 tool_call 입력·출력을 JSONL로 파일에 적재해 지연, 실패율, 위험 호출을 모니터링한다.<br />
휴먼 게이트. 위험한 툴콜이 감지되면 CustomLLMClient로 바로 보내지 말고, 별도 승인 UI 혹은 CLI에서 1회 승인 후 재주입한다.</p>

<p>원하는 /chat 규격(JSON 예시 스펙)이나 실제 엔드포인트 샘플을 알려주면, 위 어댑터를 거기에 딱 맞춰 구체화해서 리라이트해줄 수 있다.</p>

<p class="chat--user">

질문이 있어. 1. 그냥 툴을 그대로 보내면 오류가 더 많을까? 2. 일반 툴 콜링과 섞여 있는 예시도 보여주면 좋겠어. 

</p>

<p>좋아, 두 가지 모두 딱 꽂히게 정리해줄게. 결론 먼저, 그다음 바로 실행 가능한 파이썬 예시로 마무리한다.</p>

<ol>
  <li>그냥 “서버에서 받은 툴을 전부” 모델에 그대로 보여주면 오류가 더 많을까?<br />
짧은 답: 보통 그렇다. 이유는 예측 가능하다.</li>
</ol>

<ul>
  <li>
    <p>과적재(too many tools). 툴이 많아질수록 선택 오류가 늘고, 모델이 비슷한 툴을 혼동한다. 비슷한 이름, 비슷한 설명은 특히 위험하다.</p>
  </li>
  <li>
    <p>스키마 느슨함. parameters(JSON Schema)에 타입·필수 필드·enum 제약이 약하면 arguments 형식 오류가 증가한다.</p>
  </li>
  <li>
    <p>문맥 미스매치. 현재 턴과 관계없는 툴까지 모두 보이면 “근처에 있는 도구” 편향 때문에 엉뚱한 걸 집는다.</p>
  </li>
  <li>
    <p>네임 충돌·의도 충돌. 서로 다른 서버에 같은 이름, 유사 기능이 있으면 라우팅·선택 모두 흔들린다.</p>
  </li>
  <li>
    <p>부작용 위험. 삭제/결제/배포 같은 툴을 아무 맥락 없이 노출하면 모델이 성급히 실행하려 한다(모델은 과감하다).</p>
  </li>
  <li>
    <p>레이턴시·실패 전파. 원격/SSE 툴 다수는 타임아웃과 429가 뒤섞여 에러 증폭을 만든다.</p>
  </li>
</ul>

<p>현업에서 에러를 줄이는 실전 처방</p>

<ul>
  <li>
    <p>턴별 툴 소출(Selective exposure). 유저 입력을 기준으로 관련 서버/도메인의 툴만 노출한다. 단순 키워드 라우팅만 넣어도 실패율이 뚝 떨어진다.</p>
  </li>
  <li>
    <p>네임스페이스 필수. server:tool 이름으로 고정하고, description에도 서버/도메인을 반복 명시한다.</p>
  </li>
  <li>
    <p>스키마를 엄격하게. type/enum/minItems/format까지 빡빡하게 걸어라. 가능하면 예제(example) 필드까지 넣는다.</p>
  </li>
  <li>
    <p>고위험 툴에 세이프티 플래그. dry_run 기본값 true, confirmation string 같은 이중 잠금.</p>
  </li>
  <li>
    <p>응답 정규화. MCP tool_result를 항상 같은 JSON 포맷으로 묶어 모델에 재주입해 학습된 기대 형태를 유지한다.</p>
  </li>
  <li>
    <p>타임아웃/재시도/백오프 표준화. 서버별 기본값이 달라도 클라이언트에서 상한을 통일한다.</p>
  </li>
  <li>
    <p>툴 캡. 한 턴에 최대 10~20개 정도만 노출(경험상 8~12에서 가장 안정적).</p>
  </li>
</ul>

<ol>
  <li>“일반 툴 콜링”과 “MCP 툴 콜링”이 섞여 있는 예시<br />
아래는 이전 파이썬 스캐폴딩을 얇게 확장한 버전이다. 핵심은 디스패처에 로컬(일반) 툴 네임스페이스 local.* 를 추가하고, LLM이 같은 턴에서 local.* 과 server:tool(MCP)을 섞어서 호출해도 자연스럽게 라우팅되는 구조다.</li>
</ol>

<p>필요 패키지<br />
pip install mcp requests pydantic orjson</p>

<p>mixed_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="c1"># ======== 공용 데이터 모델 ========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># ======== MCP 멀티 서버 MUX ========
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ======== 로컬(일반) 툴: 예시 구현 ========
</span>
<span class="k">def</span> <span class="nf">local_tools_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전한 사칙연산/간단식 평가기. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">텍스트에서 자주 등장하는 단어 상위 K를 뽑아준다. 입력: {text: string, k: integer}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># 아주 보수적인 계산기(숫자, + - * / () 만 허용)
</span>        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}}]}</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">collections</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[A-Za-z0-9가-힣]+</span><span class="sh">"</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="nc">Counter</span><span class="p">([</span><span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">])</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">.</span><span class="nf">most_common</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">top</span><span class="sh">"</span><span class="p">:</span> <span class="n">top</span><span class="p">}}]}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ======== 커스텀 LLM 어댑터(예시) ========
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>

<span class="c1"># ======== 툴 노출 전략(간단 소출 예시) ========
</span>
<span class="k">def</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">keep</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">user_text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>

    <span class="c1"># 키워드 기반 라우팅(아주 얕은 예시)
</span>    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ingest</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">load</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">데이터베이스</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">요약</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">summary</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># 항상 노출할 로컬 도구
</span>    <span class="n">local_basics</span> <span class="o">=</span> <span class="nf">local_tools_catalog</span><span class="p">()</span>

    <span class="c1"># 중복 제거 및 이름 네임스페이스 적용
</span>    <span class="k">def</span> <span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

    <span class="n">uniq</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
        <span class="n">uniq</span><span class="p">[(</span><span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">tooldefs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">uniq</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>
    <span class="n">tooldefs</span> <span class="o">+=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]})</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">local_basics</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tooldefs</span>

<span class="c1"># ======== 대화 루프 ========
</span>
<span class="k">def</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>
    <span class="n">all_mcp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system</span><span class="p">),</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">tools_exposed</span> <span class="o">=</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">)</span>  <span class="c1"># 턴별 소출
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools_exposed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># 섞여 있는 툴콜 처리: local.* ↔ server:tool
</span>        <span class="n">results_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_texts</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ======== 실행 예시 ========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
    <span class="p">])</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">너는 안전하고 신중한 에이전트다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSV를 적재하고(sql 요약까지). 수치 확인은 계산기로 한번 검증해줘. 파일은 ./data/sales.csv 이야.</span><span class="sh">"</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== LOG ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>이 코드에서 확인할 수 있는 것</p>

<ul>
  <li>
    <p>한 턴에 LLM이 local.math_eval(일반 툴)과 files:ingest_csv(MCP) / db:sql_summary(MCP)를 섞어 호출해도 디스패처가 각각 맞는 경로로 라우팅한다.</p>
  </li>
  <li>
    <p>selective_expose가 턴별 툴 소출을 해준다. 유저 요청에 필요 없는 서버 툴은 숨겨서 혼란과 에러를 줄인다.</p>
  </li>
  <li>
    <p>로컬 툴은 파이썬 함수로 바로 처리하므로 레이턴시가 적고, 간단한 검증·후처리(예: 계산으로 sanity-check)를 빠르게 수행할 수 있다.</p>
  </li>
</ul>

<p>마지막으로, 에러를 더 줄이려면</p>

<ul>
  <li>
    <p>툴 설명에 “언제 쓰는지/언제 쓰지 말아야 하는지”를 한 문장씩 명시한다.</p>
  </li>
  <li>
    <p>위험 툴의 parameters에 confirm 문자열(예: "I understand this deletes data")을 required로 추가한다.</p>
  </li>
  <li>
    <p>TOOL_RESULTS 포맷을 팀 공통 JSON 스키마로 고정해 모델이 예측 가능한 후속 계획을 세우도록 한다.</p>
  </li>
  <li>
    <p>각 서버/툴별 타임아웃·재시도·서킷브레이커를 공통 미들웨어로 묶는다.</p>
  </li>
</ul>

<p>여기까지면 커스텀 LLM 엔드포인트에서도 “일반+MCP 혼합 툴콜”을 안정적으로 돌릴 수 있다. 다음 단계는 네가 쓰는 /chat 스펙에 맞춰 CustomLLMClient의 직렬화/역직렬화 부분만 미세조정하고, 실제 서버 두 개(files/db) 최소 구현으로 E2E를 한 번 굴려보는 것이다.</p>

<p class="chat--user">

오호. 다음은 어려운 문제야. 이걸 openai agent python sdk에 붙일 수 있을까?

</p>

<p>가능하다. 게다가 “여러 MCP 서버”와 “커스텀 LLM 엔드포인트”를 동시에 쓰는 구성이 OpenAI Agents Python SDK에서 정석으로 지원된다. 요점만 단계별로 정리하고, 바로 돌아가는 최소 예시를 준다.</p>

<p>핵심 정리</p>

<ol>
  <li>
    <p>Agents SDK는 MCP를 4가지 전송으로 붙인다: Hosted MCP(Responses API가 원격서버를 직접 호출), Streamable HTTP, HTTP+SSE, stdio(로컬 프로세스). 서버 여러 개를 mcp_servers 리스트에 넣으면 한 에이전트가 전부를 본다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>모델은 OpenAI 모델 말고도 LiteLLM 확장을 통해 “OpenAI 호환 REST”로 노출된 임의의 엔드포인트를 모델처럼 쓸 수 있다. base_url만 네 엔드포인트로 바꾸면 된다. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Hosted MCP를 쓰면 OpenAI 인프라가 원격 MCP 서버를 직접 호출하므로 파이썬 쪽 콜백이 필요 없다(공개 접근 가능한 원격 서버에 적합). 반대로 사내망/로컬은 stdio·SSE 등 “직접 붙이기”가 맞다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Agents SDK에는 MCP 전용 클래스들이 이미 들어있다(MCPServerStdio, MCPServerSse, MCPServerStreamableHttp, HostedMCPTool 등). <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub+1</a></p>
  </li>
</ol>

<p>빠른 스캐폴딩(파이썬)<br />
설치<br />
pip install openai-agents mcp</p>

<p>예시 1) 커스텀 LLM(base_url) + stdio/SSE MCP 다중 서버 한 번에 붙이기<br />
아래는 파일시스템 MCP를 로컬(stdio)로, 사내용 검색 MCP를 SSE로 붙이고, 모델은 너의 커스텀 /v1 Chat 호환 엔드포인트를 씀.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>  <span class="c1"># 커스텀 엔드포인트용
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 서버들을 context manager로 기동/연결
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer XYZ</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="c1"># 2) 커스텀 LLM 엔드포인트(OpenAI 호환) 모델로 지정
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>                 <span class="c1"># 엔진/이름
</span>            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>     <span class="c1"># 네 엔드포인트
</span>            <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">sk-your-key</span><span class="sh">"</span><span class="p">,</span>                   <span class="c1"># 필요시
</span>        <span class="p">)</span>

        <span class="c1"># 3) 에이전트 구성: 여러 MCP 서버를 한 번에 노출
</span>        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Orchestrator</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP 툴을 안전하게 사용하고, 필요할 때만 호출한다.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 필요 시 "required"로 강제
</span>        <span class="p">)</span>

        <span class="c1"># 4) 실행
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더의 CSV를 읽고, search 서버로 관련 문서 찾아 요약해줘</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>예시 2) Hosted MCP를 섞는 변형<br />
원격에 공개된 MCP 서버는 HostedMCPTool 하나만 tools에 넣으면 모델이 OpenAI 인프라에서 직접 목록조회/호출까지 한다. 파이썬 쪽 콜백이 거의 없다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">HostedMCPTool</span>

<span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">HostedMCPUser</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="nc">HostedMCPTool</span><span class="p">(</span><span class="n">tool_config</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_label</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gitmcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://gitmcp.io/openai/codex</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">require_approval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">})],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">이 저장소의 주요 언어를 알려줘</span><span class="sh">"</span><span class="p">).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>위 두 방식은 공식 문서의 사용법과 동일한 흐름이다. Hosted MCP, stdio/SSE/HTTP 서버, 툴 필터링, 승인 훅까지 포함된 가이드를 참고해 세부옵션을 맞추면 된다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>

<p>툴 소출 전략(오류 줄이는 팁)</p>

<ol>
  <li>
    <p>툴 필터링: 서버 생성자에 tool_filter를 걸거나 정적/동적 필터를 써서 턴별로 필요한 툴만 노출하라. SDK가 도우미를 제공한다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>위험 툴 승인: HostedMCPTool은 require_approval 및 on_approval_request 콜백으로 민감 작업을 승인 플로로 감싼다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>캐싱과 재시도: cache_tools_list, max_retry_attempts 등 옵션으로 지연과 실패 확률을 줄일 수 있다. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
</ol>

<p>한 줄 결론<br />
OpenAI Agents Python SDK에 네가 만든 “멀티 MCP + 커스텀 LLM 엔드포인트”를 그대로 붙일 수 있다. 모델은 LiteLLMModel로 커스텀 REST를 쓰고, MCP는 mcp_servers에 여러 개를 열거하거나 HostedMCPTool을 병용하면 된다. 필요하면 너의 엔드포인트 스펙에 맞춰 모델 어댑터를 더 촘촘하게 설정하는 코드도 만들어주겠다. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub+2</a></p>

<p class="chat--user">

아니 난 너가 만든 코드를 그대로 쓰고 싶어. 왜냐면 이렇게 만든 인터페이스를 다른 Chat 에도 쓰고 싶거든. Agent만을 위한 다른 코드가 분기 되는 것이 싫어. Tool만 입력해서 동작하게 하는 방법 없어?

</p>

<p>좋아. “Agent 전용 분기 없이” 너가 만든 인터페이스를 어떤 Chat에도 재사용하려면, 입력은 오직 툴(=프로바이더)과 LLM 엔드포인트만 주고 돌아가는 얇은 오케스트레이터가 필요하다. 아래는 그 목적에 맞춘 단일 파일 스캐폴딩이다. 핵심은 세 가지 인터페이스다.</p>

<ol>
  <li>
    <p>ChatBackend: 어떤 채팅 모델이든 붙일 수 있는 백엔드 어댑터.</p>
  </li>
  <li>
    <p>ToolProvider: 툴 카탈로그를 노출하고 호출을 처리하는 표준 인터페이스.</p>
  </li>
  <li>
    <p>Orchestrator: messages + tools만으로 루프를 돌린다. 어떤 에이전트 SDK 분기도 없다.</p>
  </li>
</ol>

<p>설치<br />
pip install mcp requests pydantic orjson</p>

<p>tools_only.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== 공통 데이터 모델 ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI/함수콜 호환 포맷으로 통일
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(str or dict)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    OpenAI Chat Completions 호환(또는 유사) 엔드포인트용 백엔드.
    /v1/chat/completions 또는 /chat 같은 곳에 맞춰 최소한의 어댑터만 제공.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>  <span class="c1"># "/v1/chat/completions"로 바꿔도 됨
</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="c1"># 서버 규격에 맞게 필요한 키만 담는다. 필요시 여기만 수정.
</span>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="c1"># data를 ChatResponse로 매핑; 너의 엔드포인트 규격에 맞게 여기만 조정하면 된다.
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 2) ToolProvider 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ToolProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span> <span class="bp">...</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>

<span class="c1"># ---- 2-1) MCP 프로바이더 (여러 서버 포함) ----
# mcp 설치 필요
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># 네임스페이스
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="c1"># 동기 인터페이스 요구 때문에 캐시 기반. 최초 호출 전에 warmup()을 호출하거나,
</span>        <span class="c1"># Orchestrator가 응답 전 await ensure_ready()를 한 번 수행.
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await provider.ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="c1"># list_tools는 async라 여기서 미리 모은다.
</span>        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># tool_name은 "server:tool"이어야 함
</span>        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server namespace: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ---- 2-2) 로컬 툴 프로바이더(선택) ----
</span>
<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                    <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (도구만 입력해서 동작) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    목적: 툴만 입력해서 동작. 어떤 Chat(백엔드)에도 재사용.
    - providers: ToolProvider들의 리스트
    - backend: ChatBackend 구현체 1개
    - expose_fn: 선택적으로 </span><span class="sh">'</span><span class="s">툴 소출</span><span class="sh">'</span><span class="s"> 전략을 주입 (기본값: 전부 노출)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolProvider</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># MCPProvider 같은 async 준비가 필요한 프로바이더를 워밍업
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 각 프로바이더가 책임지는 네임스페이스로 라우팅
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># 빠른 판별: MCP는 "server:" 네임스페이스, 로컬은 "local." 같은 규칙 추천
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">):</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>  <span class="c1"># server:tool
</span>                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># 마지막 fallback: 모든 provider에 시도
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider could handle tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="c1"># 툴 카탈로그를 수집하고 소출 전략 적용
</span>            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="c1"># 모델에게 도구결과를 일괄 재주입
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 서버들: 필요 서버만 나열
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>

    <span class="c1"># 2) 로컬 툴(선택)
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># 3) 어떤 Chat이든 붙일 백엔드. base_url과 path만 맞추면 끝.
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span>               <span class="c1"># 필요에 따라 "/v1/chat/completions" 등으로 변경
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) 오케스트레이터: 입력은 “툴(프로바이더)”뿐
</span>    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="c1"># 간단 소출: 파일/SQL 관련 단어가 없으면 MCP를 숨기고 로컬만 노출
</span>        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSV를 읽고 합계를 계산한 뒤 수치가 맞는지 계산기로 검증해줘. 파일은 ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 MCP 툴을 신중히 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>설명과 사용법 요약<br />
입력은 툴(프로바이더)만 넘긴다. 오케스트레이터는 툴 카탈로그를 합치고, LLM 응답의 tool_calls를 받아 적절한 프로바이더로 라우팅한다. 특정 에이전트 SDK 분기가 전혀 없다. 다른 Chat 백엔드로 바꾸고 싶으면 OpenAICompatibleBackend만 교체하거나 send 메소드가 동일한 시그니처를 가지는 새 클래스를 하나 추가하면 된다.</p>

<p>운영 팁<br />
툴 소출 함수(expose_fn)로 턴별 필터링을 꼭 넣자. 단순 키워드만으로도 선택 오류와 불필요 호출이 크게 준다.<br />
네임스페이스를 일관되게 유지하자. MCP는 server:tool, 로컬은 local.*처럼 구분하면 충돌이 없다.<br />
고위험 툴은 parameters에 dry_run, confirm 문자열 같은 제약을 넣어야 한다.<br />
대용량 결과는 MCP 서버가 파일 핸들(리소스)로 반환하고, 모델에는 요약/메타데이터만 재주입해 토큰을 아끼자.</p>

<p>이 구조면 같은 Orchestrator를 그대로 두고, 어떤 Chat UI/엔진에도 쉽게 이식할 수 있다. 필요하면 네 엔드포인트의 정확한 JSON 규격을 알려줘. OpenAICompatibleBackend의 매핑만 10줄쯤 손보면 바로 물릴 수 있게 맞춰줄 수 있다.</p>

<p class="chat--user">

이건 또 openai agent는 안 쓰는 것 같은데

</p>

<p>맞아, 방금 준 스캐폴딩은 “오픈AI Agents SDK”를 쓰지 않는 순수 오케스트레이터였지. 너가 원하는 건 그 코드를 그대로 유지하면서, 백엔드만 갈아끼워 “OpenAI Agents Python SDK”를 LLM 백엔드로 사용할 수 있게 하는 것. 아래처럼 백엔드 어댑터 하나만 추가하면 된다. 오케스트레이터·툴 프로바이더·라우팅은 그대로 재사용하고, 에이전트 SDK는 단지 “텍스트+툴콜 JSON을 뱉는 모델 백엔드”로만 쓴다. 즉, Agents SDK에게 MCP 실행을 맡기지 않고, 우리가 만든 라우터가 계속 MCP를 호출한다.</p>

<p>핵심 아이디어<br />
에이전트 SDK에게 도구를 등록하지 않는다(tool_choice 없이). 대신 우리가 넘긴 툴 카탈로그를 프롬프트에 JSON으로 주고, 에이전트가 반드시 다음 포맷의 JSON만 출력하도록 강제한다. 그러면 우리 오케스트레이터가 그 JSON을 파싱해 실제 MCP/로컬 툴로 라우팅한다. 이러면 Agent 전용 코드 분기가 생기지 않는다. 백엔드를 바꿔 끼우는 것만으로 같은 오케스트레이터가 그대로 동작한다.</p>

<p>설치<br />
pip install openai-agents mcp requests pydantic orjson</p>

<p>agents_backend.py<br />
아래 파일은 네가 이전에 받은 tools_only.py의 구조를 그대로 따르되, ChatBackend 구현체로 AgentsBackend를 추가한 버전이다. 나머지는 동일하니 이 파일 하나로 교체해도 되고, 필요한 부분만 가져다 써도 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== 공통 데이터 모델 ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {"name": ..., "arguments": str|dict}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend 인터페이스 ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 1-b) OpenAI Agents SDK 백엔드 어댑터 ==========
</span>
<span class="c1"># Agents SDK는 내부적으로 도구 실행까지 맡길 수 있지만,
# 여기서는 "텍스트+툴콜 JSON을 생성하는 모델"로만 사용한다.
# 프롬프트 강제 형식으로 tool_calls를 JSON으로 출력하게 만든다.
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># LiteLLM 모델 확장을 사용해 임의의 OpenAI 호환 엔드포인트를 붙일 수 있다.
</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># 도구는 에이전트에 등록하지 않는다. 우리가 직접 라우팅할 것이기 때문.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 절대 자동 도구 호출 금지
</span>        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 툴 목록을 JSON으로 주고, 정확한 출력 포맷을 강제한다.
</span>        <span class="n">tools_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span>
            <span class="n">tools_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tools_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_prompt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">위는 대화 내역이다. 아래는 사용 가능한 도구 목록이다.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">TOOLS_JSON=</span><span class="si">{</span><span class="n">tools_json</span><span class="si">}</span><span class="se">\n\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">반드시 다음 JSON 포맷으로만 답하라. 다른 텍스트는 절대 출력하지 말라.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">{</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;최종 자연어 응답(있으면)&gt;</span><span class="sh">"</span><span class="s"> ,</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-1</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}},</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-2</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}}</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">"</span><span class="s">  ]</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">}</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">여러 도구가 필요하면 tool_calls 배열에 순서대로 넣어라. 도구가 필요 없으면 빈 배열을 넣어라.</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">history</span> <span class="o">+</span> <span class="p">[</span><span class="sh">""</span><span class="p">,</span> <span class="n">guide</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_build_prompt</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
        <span class="c1"># Developer 메시지에 강제 포맷 가이드를 넣어 JSON만 출력하게 한다.
</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">JSON 포맷만 출력</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># JSON 파싱 실패 시, 일반 텍스트만 채워서 반환
</span>            <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">tool_calls</span><span class="o">=</span><span class="p">[])</span>
        <span class="c1"># 표준 ChatResponse로 맵
</span>        <span class="n">tc_raw</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># arguments가 dict가 아닐 수도 있으니 그대로 통과(오케스트레이터 쪽에서 정규화)
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span><span class="nc">ToolCall</span><span class="p">(</span><span class="o">**</span><span class="n">tc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tc_raw</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tc_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

<span class="c1"># ========== 2) ToolProvider (MCP/로컬) ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                <span class="p">}))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산. 입력 {expr:string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">})]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (변경 없음) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># 네임스페이스 단서
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LocalToolsProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># 폴백
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider can handle </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># MCP 서버 예시
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>
    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># A) OpenAI Agents SDK를 백엔드로 사용
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">AgentsBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># OpenAI 호환 엔드포인트(LiteLLM도 가능)
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>                <span class="c1"># 혹은 네 임의 모델명
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>

    <span class="c1"># B) 필요하면 기존 OpenAICompatibleBackend로 교체 가능
</span>    <span class="c1"># backend = OpenAICompatibleBackend(base_url="http://localhost:8000", path="/chat", model="my-model")
</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">파일</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">쿼리</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSV를 읽고 합계를 구한 뒤 계산기로 수치 검증까지 해줘. 파일은 ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">너는 MCP 툴을 신중히 사용한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== 최종 로그 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>작동 방식 정리<br />
1단계. AgentsBackend는 OpenAI Agents Python SDK의 Agent를 모델 백엔드로만 쓴다. 도구는 등록하지 않는다.<br />
2단계. 우리가 노출할 툴 목록을 JSON으로 프롬프트에 넣고, 에이전트가 content와 tool_calls 배열을 정확히 담은 JSON만 출력하게 강제한다.<br />
3단계. 오케스트레이터는 그 tool_calls를 받아 기존과 똑같이 MCP/로컬 툴로 라우팅한다.<br />
4단계. 즉, 같은 오케스트레이터 코드를 유지한 채, 백엔드만 갈아끼워 Agents SDK 또는 일반 OpenAI 호환 엔드포인트를 자유롭게 선택할 수 있다.</p>

<p>주의점과 팁<br />
JSON 강제 프롬프트가 중요하다. 모델이 장식 텍스트를 섞지 않도록 developer_instructions로 “JSON만 출력”을 반복해서 고정하라.<br />
툴 스키마를 엄격하게. required, enum, format을 충분히 넣으면 arguments 파싱 실패가 줄어든다.<br />
성능. AgentsBackend는 Runner.run_sync를 한 턴마다 호출한다. 대화 길어지면 토큰·시간이 늘어나므로 expose_fn으로 툴을 턴별로 소출하고, 결과는 요약해서 재주입하라.<br />
대체. 에이전트 SDK의 모델 대신 OpenAICompatibleBackend로 바꾸면 바로 동일 코드가 다른 Chat에도 붙는다. 목적에 맞춰 백엔드만 교체하면 된다.</p>

<p>이렇게 하면 에이전트 SDK를 “백엔드 모델”로만 쓰면서, 너의 툴 중심 인터페이스와 라우터는 그대로 유지된다. 다음에는 네 실제 엔드포인트의 출력 JSON 예시를 알려줘. AgentsBackend의 JSON 파싱 부분을 거기에 맞춰 2~3줄만 조정하면 된다.</p>

<p class="chat--user">

아 복잡해 그냥 function_tool로 각 tool을 등록하면 어떨까

</p>

<p>좋지. “그냥 function_tool로 각 툴을 등록”하는 가장 깔끔한 방법은, MCP 서버들에서 list_tools를 긁어와서 각각을 Agents SDK의 FunctionTool로 동적으로 래핑하는 거야. 그러면 Agent 쪽은 전혀 커스텀 분기 없이 표준 툴만 본다. 아래 코드가 바로 그 패턴이고, 커스텀 LLM도 LiteLLM 모델 어댑터로 붙인다.</p>

<p>핵심 개념 한 줄 요약<br />
MCP의 tool 메타데이터(name, description, input_schema)를 Agents SDK의 FunctionTool(name, description, params_json_schema, on_invoke_tool)에 그대로 매핑하고, on_invoke_tool에서 해당 MCP 세션으로 call_tool만 라우팅한다. FunctionTool/<code class="language-plaintext highlighter-rouge">@function_tool</code> 사용법과 JSON 스키마 포맷은 Agents 문서 그대로다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a> 또한 모델은 LiteLLMModel로 너의 베이스 URL을 모델처럼 쓸 수 있다. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson</p>

<p>mcp_as_function_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># 네임스페이스(툴 이름 prefix에 들어감)
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈이 필요합니다.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cdfg</span><span class="p">.</span><span class="n">name</span> <span class="nf">if </span><span class="p">(</span><span class="n">cdfg</span> <span class="p">:</span><span class="o">=</span> <span class="n">cfg</span><span class="p">)</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    MCP tool -&gt; Agents FunctionTool
    tool_meta: has .name, .description, .input_schema (JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Agents SDK가 args_json을 JSON 문자열로 넘겨준다 → dict로 파싱 후 MCP 호출
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 모델이 형식 어기면 raw로 전달(서버 쪽 검증에 맡김)
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="c1"># MCP 표준 content를 텍스트/JSON 위주로 정규화
</span>        <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="c1"># 에이전트에게는 문자열을 반환하므로 JSON 문자열로 묶어준다
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="c1"># FunctionTool은 name/description/params_json_schema/on_invoke_tool만 주면 된다.
</span>    <span class="c1"># 공식 문서의 "Custom function tools" 섹션과 동일한 생성자. :contentReference[oaicite:2]{index=2}
</span>    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) 여러 MCP 서버를 선언
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>        <span class="c1"># MCPServerCfg(name="db", kind="stdio", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">]</span>

    <span class="c1"># 2) MCP의 모든 툴을 FunctionTool로 등록
</span>    <span class="n">mcp_function_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>

    <span class="c1"># 3) 커스텀 LLM(너의 엔드포인트)을 LiteLLM 모델로 사용
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># 네 엔드포인트를 OpenAI 호환으로 노출했다는 가정
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) 에이전트 구성: “function_tool로 등록된 MCP 툴”만 전달
</span>    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP-through-FunctionTools</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_function_tools</span><span class="p">,</span>  <span class="c1"># 포인트: 오직 function_tool만
</span>    <span class="p">)</span>

    <span class="c1"># 5) 실행
</span>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data 폴더에서 sales.csv를 읽고 합계 계산해줘. 필요하면 스스로 적절한 MCP 툴을 골라 써.</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>어떻게 돌아가나<br />
1단계. 여러 MCP 서버에 연결하고 list_tools로 메타를 긁는다.<br />
2단계. 각 MCP 툴을 FunctionTool로 감싼다. name은 server:tool로 네임스페이스, description과 JSON 스키마는 MCP의 description/input_schema를 그대로 쓴다. 이 매핑은 Agents 문서의 Function tools/Custom function tools 규약에 맞다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a><br />
3단계. on_invoke_tool에서 session.call_tool만 호출해 결과를 문자열(JSON)로 반환한다.<br />
4단계. Agent는 “function_tool로 등록된 툴”만 보므로, 네가 원한 단순한 툴 등록 모델 그대로다. 모델은 LiteLLM을 통해 임의 베이스 URL의 LLM을 쓸 수 있다. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>실전 팁<br />
툴 과적재를 피하려면 tools=mcp_function_tools 대신, 프롬프트를 보고 필요한 서버만 필터링해서 전달해라(예: 파일/CSV가 있으면 files:*만). Function tools는 설명과 인자 스키마를 자동 소비하니, MCP 쪽 스키마를 빡빡하게 유지하면 arguments 오류가 줄어든다. FunctionTool로 직접 생성하면 데코레이터 없이도 이름·설명·스키마를 원하는 대로 넣을 수 있다. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a></p>

<p>확장 아이디어<br />
고위험 툴에 dry_run, confirm 같은 필드를 MCP input_schema에 추가하면, 그대로 FunctionTool 인자 스키마에 반영되어 실행 전에 모델이 스스로 안전 절차를 따른다.<br />
툴 결과가 크면 on_invoke_tool에서 요약만 반환하고, 원본은 파일 핸들이나 URL로 제공하도록 MCP 서버를 설계해 토큰 사용량을 줄인다.</p>

<p>원하면 네 파일/DB MCP 서버의 실제 tool 이름과 input_schema를 알려줘. 위 스크립트가 해당 스키마를 그대로 FunctionTool로 옮겨주기 때문에 추가 코드는 사실상 없다.</p>

<p class="chat--user">

응 내가 원하는거랑 가까워진듯. 질문이 더 있어. 질문 1. MCP 말고 일반 Function 툴과 섞인 버젼 추가해줘. 질문 2. 일반 chat completions (with tools) 예제도 바로 아래에 추가해줘. 질문 3. MCP Client Session은 저절로 종료되나? 질문 4. 여러 Agent가 있으면 MCP 종류별로 세션을 여러개 열게될수도 있을거 같은데 하나로 유지하는건 어때? 문제가 있으려나

</p>

<p>좋아. 네 질문 4개를 순서대로, 바로 쓸 수 있는 코드와 함께 정리한다. 인용구문은 쓰지 않는다.</p>

<h1 id="1-mcp-툴--일반-function-툴을-섞어-등록하는-버전">1) MCP 툴 + 일반 Function 툴을 섞어 등록하는 버전</h1>

<p>아래는 앞서 만든 “MCP → FunctionTool 래핑”에 더해, 일반 파이썬 함수도 FunctionTool로 함께 등록하는 예시다. 에이전트는 두 종류를 한꺼번에 본다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># ========== MCP 연결 ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">args_json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_function_tools</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># ========== 일반 파이썬 함수 → FunctionTool ==========
</span>
<span class="k">def</span> <span class="nf">make_local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기. 입력: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">math_eval</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># ========== 실행 예시 ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP 툴
</span>    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_mcp_function_tools</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="db", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">])</span>

    <span class="c1"># 2) 일반 Function 툴
</span>    <span class="n">local_tools</span> <span class="o">=</span> <span class="nf">make_local_tools</span><span class="p">()</span>

    <span class="c1"># 3) 모델 (네 커스텀 LLM OpenAI-호환 엔드포인트)
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MixedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_tools</span> <span class="o">+</span> <span class="n">local_tools</span><span class="p">,</span>  <span class="c1"># 섞어서 등록
</span>    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data 폴더의 sales.csv를 읽어 합계를 구하고, local.math_eval로 숫자 검증까지 해줘</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h1 id="2-일반-chat-completions-with-tools-예제">2) 일반 Chat Completions (with tools) 예제</h1>

<p>OpenAI 호환 Chat Completions API를 직접 쓰는 순수 예시다. tools에 함수 스키마를 주고, tool_calls를 받아서 너의 실행기로 라우팅한다. 여기서는 로컬 계산기 하나만 보여주지만, 위의 MCP tools 리스트를 그대로 합쳐 넣으면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>  <span class="c1"># 네 OpenAI 호환 엔드포인트
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">안전 사칙연산 계산기</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># 여기에 MCP에서 긁어온 tools도 그대로 append 가능
</span><span class="p">]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">3*(2+5) 값을 계산해줘</span><span class="sh">"</span><span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># 1차 요청
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
<span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="c1"># tool_calls 처리
</span><span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="c1"># 2차 요청(도구 결과 반영)
</span>    <span class="n">resp2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp2</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">resp2</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
</code></pre></div></div>

<p>포인트<br />
tools에 MCP에서 긁은 스키마를 그대로 추가하면, 일반 chat completions 루프에서도 MCP와 로컬 툴을 함께 쓸 수 있다. 단, MCP 호출부는 너의 라우터가 처리해 tool 역할 메시지를 만들어 넣으면 된다.</p>

<h1 id="3-mcp-clientsession은-저절로-종료되나">3) MCP ClientSession은 저절로 종료되나?</h1>

<p>자동 종료를 기대하면 안 된다. 표준 패턴은 세 가지다.</p>

<ol>
  <li>
    <p>세션을 감싼 트랜스포트(StdIO/SSE)에 대해 stop/close를 명시적으로 호출한다.</p>
  </li>
  <li>
    <p>async with 컨텍스트를 제공하는 래퍼를 만들어 with 블록이 끝날 때 정리한다.</p>
  </li>
  <li>
    <p>프로세스 종료 훅에서 전역 세션들을 순서대로 정리한다.</p>
  </li>
</ol>

<p>간단 정리 함수 예시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 세션과 트랜스포트를 함께 추적해야 안전
</span><span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<p>세션을 열 때 MCPHandle을 만들어 리스트에 넣고, 애플리케이션 종료 시 모든 handle.close()를 await 하면 된다.</p>

<h1 id="4-여러-agent가-세션을-공유해도-될까-하나로-유지하는-전략과-주의점">4) 여러 Agent가 세션을 공유해도 될까? 하나로 유지하는 전략과 주의점</h1>

<p>결론부터 말하면, 공유 풀을 두고 재사용하는 게 일반적으로 좋다. 다만 몇 가지 주의점이 있다.</p>

<p>장점<br />
메모리·프로세스 수 절감. stdio 서버는 프로세스를 하나만 띄우면 된다.<br />
콜드 스타트 지연 감소. list_tools 캐시와 연결 수립 시간이 절약된다.</p>

<p>주의점<br />
동시성. 하나의 MCP 세션이 다중 호출을 처리할 때, 서버/클라이언트가 동시 호출을 안전하게 처리하는지 확인해야 한다. 대부분의 MCP 서버 구현은 괜찮지만, 특정 서버가 순차 처리만 안전하게 지원한다면 큐잉이나 세마포어가 필요하다.<br />
격리. 사용자·권한이 다른 Agent가 같은 세션을 쓰면 권한 경계가 흐려질 수 있다. 서버 인스턴스를 권한 단위로 분리하는 게 안전하다.<br />
생명주기. 누가 언제 닫을지 합의가 필요하다. 레퍼런스 카운팅 또는 명시적 init/close API가 필요하다.<br />
버전·옵션 차이. 같은 서버라도 플래그(예: dry_run 기본값)가 다른 Agent마다 다를 수 있다. 이땐 세션을 공유하지 말고 별도 인스턴스를 띄워라.</p>

<p>간단한 세션 풀 스캐폴딩(RefCount + AsyncLock):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPSessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,...]],</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># key 예시: ("stdio", ("npx","-y","@modelcontextprotocol/server-filesystem","./data"))
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acquire_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientSession</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">:</span>
                <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
            <span class="c1"># 새로 생성
</span>            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">transport</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">release_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>사용 패턴<br />
Agent가 시작할 때 acquire_stdio로 세션을 받아 쓰고, 끝날 때 release_stdio로 반납한다. 동일한 command/args 조합은 한 세션을 공유한다. 권한 격리가 필요한 경우 key에 추가 식별자(tenant, role 등)를 포함시키면 된다. 동시성 밀도가 높다면 각 MCP 서버 특성에 맞춰 per-server 세마포어를 더해주는 게 안전하다.</p>

<p>마무리 팁<br />
섞인 환경(일반 함수 + MCP)에서는 툴 수가 늘어 혼란이 생기기 쉬우니, 에이전트에 등록할 때 도메인별 프리픽스(server:tool, local.*)와 짧고 명확한 설명, 엄격한 JSON 스키마(required/enum/format)를 유지하자. 필요하면 한 턴에 노출할 툴을 필터링해 과적재를 줄이는 것도 효과적이다.</p>

<p class="chat--user">

1번과 2번을 합쳐서 써야지. 두 개 툴 구현이 너무 다르잖아. 툴 구현을 한 번만 하고 두 군데 모두에서 쓰고 싶은거야.

</p>

<p>좋아, “툴 구현은 한 번만” 하고, 그걸 두 방식 모두에서 재사용하도록 합치자. 아래 스캐폴딩은 단일 ToolRegistry에 툴을 등록하고, 같은 구현을 1) OpenAI Agents SDK(FunctionTool) 경로, 2) 일반 Chat Completions(with tools) 경로 양쪽에서 그대로 씁니다. MCP 툴도 동일한 추상화로 래핑합니다.</p>

<p>설치<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>unified_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1">###############################################################################
# 공통 추상화: 한 번 구현한 툴을 어디서든 재사용
###############################################################################
</span>
<span class="c1"># Tool 핸들러 시그니처: args(dict) -&gt; dict/str (awaitable)
</span><span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># 실제 실행 로직(동일 구현을 양쪽에서 재사용)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool name: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">list_for_chat_completions</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># OpenAI tools 포맷으로 직렬화
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# 로컬(일반) 툴 구현 예시: 한 번만 구현
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">LOCAL_MATH_TOOL</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">안전 사칙연산 계산기. 입력 {expr: string}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="n">handler</span><span class="o">=</span><span class="n">math_eval_handler</span>
<span class="p">)</span>

<span class="c1">###############################################################################
# MCP 툴을 동일 추상화로 래핑: 세션별로 ToolSpec을 생성
###############################################################################
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># 네임스페이스 prefix
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse 모듈 필요</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mcp_toolspecs_from_session</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="c1"># 동기 함수로 명세만 만들고, handler는 session을 캡처하여 비동기로 호출
</span>    <span class="c1"># list_tools 는 async라 밖에서 호출해 metadata를 넘겨줘야 한다.
</span>    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">call build_mcp_tools(...) instead</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">MCPHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">handle</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">):</span>
            <span class="c1"># _tool를 default 인자로 바인딩해 late-binding 이슈 방지
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">packed</span>

        <span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">specs</span>

<span class="c1">###############################################################################
# 1) OpenAI Agents SDK 경로: FunctionTool로 래핑하되, handler는 동일 구현 사용
###############################################################################
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_function_tool</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># 에이전트는 문자열 반환이 표준이므로 JSON 문자열로 직렬화
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_function_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">()]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">user_text</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1">###############################################################################
# 2) 일반 Chat Completions 경로: tools JSON + 동일 handler로 tool_calls 라우팅
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_for_chat_completions</span><span class="p">()</span>

        <span class="c1"># 1차 호출
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 도구 호출 처리 루프(필요 시 반복)
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw_args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">}</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# 실행 예시: 한 번 구현 → 두 경로에서 사용
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) 레지스트리 생성 및 로컬 툴 등록(한 번만)
</span>    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">LOCAL_MATH_TOOL</span><span class="p">)</span>

    <span class="c1"># 1) MCP 세션 연결 후, MCP 툴들을 동일 추상화로 등록
</span>    <span class="n">files_cfg</span> <span class="o">=</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">files_handle</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">files_cfg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="k">await</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">files_handle</span><span class="p">):</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># A) Agents SDK 경로
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Agents SDK 경로 ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="sh">"</span><span class="s">data 폴더의 sales.csv를 읽고 합계를 계산한 뒤 local.math_eval로 2배를 계산해줘</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># B) 일반 Chat Completions 경로
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Chat Completions 경로 ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">필요할 때만 툴을 호출한다. 파괴적 작업은 dry_run을 우선한다.</span><span class="sh">"</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">files 서버 툴로 sales.csv 합계를 구하고 local.math_eval로 100+23도 계산해줘</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">files_handle</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>핵심 포인트 정리<br />
툴은 ToolSpec(handler 포함)으로 한 번만 구현한다. MCP도 build_mcp_tools가 동일한 ToolSpec을 만들고, 로컬 툴도 같은 형태다.<br />
OpenAI Agents SDK는 FunctionTool로 얇게 래핑만 한다. on_invoke는 같은 handler를 호출한다.<br />
Chat Completions(with tools)도 registry의 tools JSON을 그대로 사용하고, tool_calls를 같은 handler로 라우팅한다.<br />
MCP 세션은 MCPHandle.close로 명시 종료한다. 여러 Agent나 여러 러너가 있을 때 공유하고 싶다면 핸들 풀을 두고 레퍼런스 카운팅만 얹으면 된다.</p>

<p>이제 “툴 구현은 한 번만” 쓰고, Agents와 Chat Completions 어디서든 동일하게 돌아간다. 필요한 경우 expose(툴 소출) 정책이나 권한 게이트를 registry 레벨에서 필터링 훅으로 추가하면 된다.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python 데코레이터 설명</title><link href="https://hvppyarchive.github.io/python/python-decorator/" rel="alternate" type="text/html" title="Python 데코레이터 설명" /><published>2025-10-28T16:53:51+09:00</published><updated>2025-10-28T16:53:51+09:00</updated><id>https://hvppyarchive.github.io/python/python-decorator</id><content type="html" xml:base="https://hvppyarchive.github.io/python/python-decorator/"><![CDATA[<p class="chat--user">

python decorator 가 너무 헷갈려

</p>

<p>좋아, 데코레이터를 “마법”이 아니라 “함수로 함수를 꾸미는 평범한 기술”로 풀어서 볼게. 차근차근 따라가면 헷갈림이 사라진다.</p>

<h1 id="1-한-문장-정의">1) 한 문장 정의</h1>

<p>데코레이터는 “함수를 받아서 새로운 함수를 반환하는 함수”다. <code class="language-plaintext highlighter-rouge">@something</code>은 단지 설탕 문법(syntax sugar)이고, 실제로는 <code class="language-plaintext highlighter-rouge">func = something(func)</code>과 같다.</p>

<h1 id="2-가장-작은-예제부터">2) 가장 작은 예제부터</h1>

<p>먼저 아무 장식도 없는 함수.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Hello, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
</code></pre></div></div>

<p>이제 이 함수를 받아 살짝 바꾸는 “데코레이터 함수”를 만든다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">shout_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>     <span class="c1"># 원래 함수 실행
</span>        <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span>              <span class="c1"># 결과를 변형
</span>    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div>

<p>적용은 두 가지 방법이 있다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 방법 A: @ 문법
</span><span class="nd">@shout_decorator</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Hello, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>

<span class="c1"># 방법 B: 수동 적용 (동치)
</span><span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Hello, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
<span class="n">greet</span> <span class="o">=</span> <span class="nf">shout_decorator</span><span class="p">(</span><span class="n">greet</span><span class="p">)</span>
</code></pre></div></div>

<p>이제 <code class="language-plaintext highlighter-rouge">greet("world")</code>는 "HELLO, WORLD"를 반환한다.</p>

<p>핵심 포인트는 wrapper가 원본 함수를 감싸고 있다는 것.</p>

<h1 id="3-꼭-쓰는-도구-functoolswraps">3) 꼭 쓰는 도구: functools.wraps</h1>

<p>데코레이터를 쓰면 원래 함수의 이름, docstring이 wrapper로 바뀌어 버린다. 이를 바로잡는 게 <code class="language-plaintext highlighter-rouge">functools.wraps</code>.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">shout_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div>

<p>이제 <code class="language-plaintext highlighter-rouge">greet.__name__</code>, <code class="language-plaintext highlighter-rouge">help(greet)</code> 등이 원본과 일치한다. 실무에선 wraps를 항상 쓴다고 생각하자.</p>

<h1 id="4-인자가-있는-데코레이터">4) 인자가 있는 데코레이터</h1>

<p>가끔 데코레이터 자체에도 옵션이 필요하다. 이때는 “함수를 만드는 함수”를 한 번 더 감싼다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="n">times</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
                <span class="n">last</span> <span class="o">=</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">last</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="nd">@repeat</span><span class="p">(</span><span class="n">times</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ping</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ping</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>정신승리 포인트: <code class="language-plaintext highlighter-rouge">@repeat(3)</code>는 즉시 <code class="language-plaintext highlighter-rouge">repeat(3)</code>을 호출해 “진짜 데코레이터(decorator)”를 만든 다음 그게 <code class="language-plaintext highlighter-rouge">ping</code>을 감싼다.</p>

<h1 id="5-적용-순서스택">5) 적용 순서(스택)</h1>

<p>여러 데코레이터를 쌓으면, 코드에선 위에서 아래로 읽히지만 적용은 아래에서 위로 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@A</span>
<span class="nd">@B</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span> <span class="bp">...</span>
</code></pre></div></div>

<p>이는 <code class="language-plaintext highlighter-rouge">f = A(B(f))</code>와 같다. 즉 B가 먼저 감싸고, 그 다음 A가 감싼다.</p>

<h1 id="6-자주-쓰는-패턴들">6) 자주 쓰는 패턴들</h1>

<p>로그/타이밍</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">timeit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s"> took </span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div>

<p>메모이제이션(이미 표준 라이브러리에 있음)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>권한 체크(개념 예시)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">require_role</span><span class="p">(</span><span class="n">role</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">.</span><span class="n">roles</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">nope</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">func</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div></div>

<p>프로퍼티/정적/클래스 메서드(내장 데코레이터)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">s</span><span class="p">():</span> <span class="bp">...</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span> <span class="bp">...</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="bp">...</span>
</code></pre></div></div>

<p>클래스 데코레이터(클래스를 받아 클래스/인스턴스를 돌려줌)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">add_repr</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">=</span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="sh">"</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">__dict__</span><span class="p">.</span><span class="nf">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">cls</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>
    <span class="n">cls</span><span class="p">.</span><span class="n">__repr__</span> <span class="o">=</span> <span class="n">__repr__</span>
    <span class="k">return</span> <span class="n">cls</span>

<span class="nd">@add_repr</span>
<span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div></div>

<h1 id="7-비동기-함수-꾸미기중요-포인트">7) 비동기 함수 꾸미기(중요 포인트)</h1>

<p><code class="language-plaintext highlighter-rouge">async def</code> 함수를 감쌀 땐 wrapper도 <code class="language-plaintext highlighter-rouge">async def</code>여야 await를 안전하게 전달할 수 있다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">def</span> <span class="nf">async_timeit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>   <span class="c1"># await 잊지 말기
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s"> took </span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div>

<p>동기/비동기 둘 다 지원하려면 오버로드하거나, 감싸기 전에 <code class="language-plaintext highlighter-rouge">asyncio.iscoroutinefunction(func)</code>로 분기한다.</p>

<h1 id="8-흔한-함정들-체크리스트">8) 흔한 함정들 체크리스트</h1>

<p>함수 시그니처 손실 문제: <code class="language-plaintext highlighter-rouge">wraps</code>로 메타데이터는 살리지만, 정교한 시그니처(IDE 인텔리센스)까지 유지하려면 <code class="language-plaintext highlighter-rouge">inspect.signature</code>를 쓰거나 <code class="language-plaintext highlighter-rouge">wrapt</code> 같은 라이브러리를 고려.</p>

<p>인자 바인딩: wrapper는 보통 <code class="language-plaintext highlighter-rouge">*args, **kwargs</code>로 받아 원본에 그대로 전달한다. 특정 인자를 바꾸면 서프라이즈 발생.</p>

<p>평가 시점: 데코레이터는 함수 정의 시점에 실행된다. 모듈 import만 해도 동작할 수 있다는 뜻. 사이드이펙트는 신중히.</p>

<p>상태 보관: 카운터 같은 상태가 필요하면 <code class="language-plaintext highlighter-rouge">nonlocal</code> 변수나 <code class="language-plaintext highlighter-rouge">functools.partial</code>, 또는 클래스형 데코레이터를 쓴다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">counted</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">count</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">called </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s"> times</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div>

<p>타입 힌트: 데코레이터는 타입 체커에 어려움을 준다. <code class="language-plaintext highlighter-rouge">typing.Callable</code>, <code class="language-plaintext highlighter-rouge">TypeVar</code>, <code class="language-plaintext highlighter-rouge">ParamSpec</code>, <code class="language-plaintext highlighter-rouge">Concatenate</code>를 적절히 쓰면 정적 분석 품질이 좋아진다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">ParamSpec</span>
<span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="n">P</span> <span class="o">=</span> <span class="nc">ParamSpec</span><span class="p">(</span><span class="sh">"</span><span class="s">P</span><span class="sh">"</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="nc">TypeVar</span><span class="p">(</span><span class="sh">"</span><span class="s">R</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log_calls</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]:</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="p">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">calling</span><span class="sh">"</span><span class="p">,</span> <span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div>

<h1 id="9-마음속-모델헷갈림-방지-요약">9) 마음속 모델(헷갈림 방지 요약)</h1>

<p>함수는 1급 객체다. 즉, 숫자처럼 전달·반환할 수 있다. 데코레이터는 “함수를 입력으로 받아 함수를 출력하는 공장”이다. <code class="language-plaintext highlighter-rouge">@</code>는 그 공장을 짧게 부르는 표기다. wrapper가 원본 함수를 실행하기 전후로 무언가를 덧붙이거나, 결과를 바꾸거나, 실행 자체를 막을 수도 있다.</p>

<h1 id="10-손에-익히는-미니-연습문제-5개">10) 손에 익히는 미니 연습문제 5개</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">time.sleep</code>을 써서 어떤 함수의 실행 시간을 출력하는 <code class="language-plaintext highlighter-rouge">timeit</code> 데코레이터를 직접 작성.</p>
  </li>
  <li>
    <p>실패하면 최대 3번까지 재시도하는 <code class="language-plaintext highlighter-rouge">retry(times=3, exceptions=(Exception,))</code> 데코레이터 작성.</p>
  </li>
  <li>
    <p>순수 함수에 한해 간단한 캐시를 붙이는 <code class="language-plaintext highlighter-rouge">memoize</code> 데코레이터 작성(딕셔너리 키는 인자 튜플).</p>
  </li>
  <li>
    <p>비동기 함수용 <code class="language-plaintext highlighter-rouge">async_retry</code> 버전 구현(await 필수).</p>
  </li>
  <li>
    <p>접근 제한: 특정 환경변수(<code class="language-plaintext highlighter-rouge">APP_ENV=prod</code>)일 때만 함수를 실행하고 아니면 경고만 출력하는 데코레이터 작성.</p>
  </li>
</ol>

<p>원하는 패턴이 있으면 그대로 구현 예시를 더 만들어 줄게.</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry></feed>