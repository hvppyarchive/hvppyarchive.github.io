<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://hvppyarchive.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://hvppyarchive.github.io/" rel="alternate" type="text/html" /><updated>2025-11-05T12:28:23+09:00</updated><id>https://hvppyarchive.github.io/feed.xml</id><title type="html">ARCHIVE</title><subtitle>An amazing archive.</subtitle><author><name>hvppyarchive</name></author><entry><title type="html"></title><link href="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/" rel="alternate" type="text/html" title="" /><published>2025-11-05T12:28:23+09:00</published><updated>2025-11-05T12:28:23+09:00</updated><id>https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str</id><content type="html" xml:base="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/"><![CDATA[<p class="chat--user">

Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> í•¨ìˆ˜ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> í•¨ìˆ˜ì˜ ì°¨ì´ì 

</p>

<p>Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> ê³¼ <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ì°¨ì´ì ì€ <strong>ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ í‘œí˜„í•˜ëŠ” ëª©ì </strong> ì—ì„œ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì°¨ì´ë¥¼ ë‹¨ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.</p>

<hr />

<h2 id="1-__repr__-ì˜-ëª©ì ">1. <code class="language-plaintext highlighter-rouge">__repr__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ê°œë°œì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ê°œë°œì"ê°€ ë³´ê³  ì´í•´í•  ìˆ˜ ìˆë„ë¡ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì¬í˜„ ê°€ëŠ¥(reproducible)</strong> : ê°€ëŠ¥í•œ í•œ ê°ì²´ë¥¼ ë‹¤ì‹œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì½”ë“œ í˜•íƒœë¡œ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë³´í†µ <code class="language-plaintext highlighter-rouge">eval(repr(obj)) == obj</code> ê°€ ì„±ë¦½í•˜ëŠ” í˜•íƒœë¥¼ ì§€í–¥í•©ë‹ˆë‹¤ (ê¼­ í•­ìƒ ê·¸ëŸ° ê±´ ì•„ë‹ˆì§€ë§Œ ê¶Œì¥).</p>
  </li>
  <li>
    <p>ë””ë²„ê¹…í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Person(name=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">'</span><span class="s">, age=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># Person(name='Alice', age=30)
</span></code></pre></div></div>

<hr />

<h2 id="2-__str__-ì˜-ëª©ì ">2. <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ì‚¬ìš©ì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ì‚¬ìš©ì"ê°€ ë³´ê¸° ì¢‹ì€ ë¬¸ìì—´ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì½ê¸° ì‰½ê³  ê¹”ë”í•˜ê²Œ ì¶œë ¥í•˜ëŠ” ë° ì´ˆì ì„ ë‘¡ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">print(obj)</code> ë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ë³´ì—¬ì§€ëŠ” ê°’ì´ <code class="language-plaintext highlighter-rouge">__str__</code> ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s"> years old)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Alice (30 years old)
</span></code></pre></div></div>

<hr />

<h2 id="3-__repr__-vs-__str__-ë¹„êµ">3. <code class="language-plaintext highlighter-rouge">__repr__</code> vs <code class="language-plaintext highlighter-rouge">__str__</code> ë¹„êµ</h2>

<table>
  <thead>
    <tr>
      <th>íŠ¹ì§•</th>
      <th><code class="language-plaintext highlighter-rouge">__repr__</code></th>
      <th><code class="language-plaintext highlighter-rouge">__str__</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ëª©ì </td>
      <td>ê°œë°œììš©, ë””ë²„ê¹…</td>
      <td>ì‚¬ìš©ììš©, ê°€ë…ì„±</td>
    </tr>
    <tr>
      <td>ì¶œë ¥ ëŒ€ìƒ</td>
      <td><code class="language-plaintext highlighter-rouge">repr(obj)</code>, ëŒ€í™”í˜• ì‰˜ì—ì„œ ê¸°ë³¸</td>
      <td><code class="language-plaintext highlighter-rouge">str(obj)</code>, <code class="language-plaintext highlighter-rouge">print(obj)</code></td>
    </tr>
    <tr>
      <td>í˜•ì‹</td>
      <td>ê°ì²´ ì¬í˜„ ê°€ëŠ¥í•˜ê±°ë‚˜ ìƒì„¸</td>
      <td>ì½ê¸° ì‰¬ìš´ ì„¤ëª… ìœ„ì£¼</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="4-êµ¬í˜„-ì‹œ-ì£¼ì˜ì‚¬í•­">4. êµ¬í˜„ ì‹œ ì£¼ì˜ì‚¬í•­</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code> ê°€ ì—†ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ê°€ ëŒ€ì‹  ì‚¬ìš©</strong>ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë”°ë¼ì„œ ìµœì†Œí•œ <code class="language-plaintext highlighter-rouge">__repr__</code> ì€ ì •ì˜í•´ ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>ğŸ‘‰ ì •ë¦¬í•˜ë©´,</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__repr__</code></strong> : â€œê°œë°œìê°€ ë””ë²„ê¹…í•  ë•Œâ€ ê°ì²´ì˜ ì •í™•í•œ í‘œí˜„.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code></strong> : â€œì‚¬ìš©ìê°€ ì¶œë ¥ë¬¼ì„ ë³¼ ë•Œâ€ ë³´ê¸° ì¢‹ê²Œ í‘œí˜„.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> ë¥¼ ë™ì‹œì— êµ¬í˜„í–ˆì„ ë•Œ <code class="language-plaintext highlighter-rouge">print(obj)</code> ì™€ <code class="language-plaintext highlighter-rouge">obj</code> (ì‰˜ ì¶œë ¥) ì˜ ì°¨ì´ë¥¼ ì§ì ‘ ì‹¤í–‰í•´ ë³´ì—¬ë“œë¦´ ìˆ˜ë„ ìˆëŠ”ë°, ì˜ˆì œ ì½”ë“œ ì‹œì—°ì„ ì›í•˜ì‹œë‚˜ìš”?</p>]]></content><author><name>hvppyarchive</name></author></entry><entry><title type="html">Python ì½”ë“œ ì‹¤í–‰ Tool Calling</title><link href="https://hvppyarchive.github.io/llm/python-interpreter-tool-calling/" rel="alternate" type="text/html" title="Python ì½”ë“œ ì‹¤í–‰ Tool Calling" /><published>2025-11-05T12:28:16+09:00</published><updated>2025-11-05T12:28:16+09:00</updated><id>https://hvppyarchive.github.io/llm/python-interpreter-tool-calling</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/python-interpreter-tool-calling/"><![CDATA[<p class="chat--user">

ì•„ë˜ì™€ ê°™ì€ Code Interpreter íˆ´ì„ ë‚˜ì˜ (vLLM + GPTOSS / Qwen) + (OpenAI Agents SDK) ì‹œìŠ¤í…œì— ë„£ê³  ì‹¶ì–´. ë‚´ê°€ ì›í•˜ëŠ” ê²ƒì€ ì‚¬ì‹¤ ì´ê±° í•˜ë‚˜ì•¼. íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë˜, ì™¸ë¶€ì˜ íŒŒì¼ë“¤ì„ ë§ì¹˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¢‹ê² ì–´. ê·¸ì™€ ë™ì‹œì— í˜¸ìŠ¤íŠ¸ íŒŒì¼ë“¤ì— ë‹¨ìˆœ ì ‘ê·¼ì€ ì¢€ ììœ ë¡œì›Œë„ ì¢‹ì„ ê²ƒ ê°™ì•„. íŒŒì¼ì„ ìƒì„±/ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ ì§€ì •í•œ í´ë” ì•ˆì— ë³µì‚¬í•´ì„œ ë‹¤ë£¨ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„. ê·¸ë¦¬ê³  ë„ì»¤ê°€ ì—†ì´ ì´ëŸ° ì‹œìŠ¤í…œì„ êµ¬ì„±í•˜ê³  ì‹¶ì–´ #!/usr/bin/env python # coding: utf-8 # ## Build Your Own Code Interpreter - Dynamic Tool Generation and Execution With o3-mini # # At the core of providing a LLM Agent capability to interact with the outside world or other Agents is â€œtool (or function) calling,â€ where a LLM can invoke a function (a block of code) with arguments. Typically, these functions are predefined by the developer, along with their expected inputs and outputs. However, in this Cookbook, we explore a more flexible paradigm - to <strong>dynamically generate tools</strong> using LLM models (in this case <strong>o3-mini</strong>), with ability to execute the tool using a code interpreter. # # ### Dynamically Generated Tool Calling with Code Interpreter # A Dynamically Generated Tool is a function or code block created by the LLM itself at runtime based on the userâ€™s prompt. This means you donâ€™t have to predefine every possible scenario in your codebaseâ€”enabling far more open-ended, creative, and adaptive problem-solving. # # Dynamically Generated Tool Calling goes a step further by granting the LLM the ability to generate tools and execute code blocks on the fly. This dynamic approach is particularly useful for tasks that involve: # # - Data analysis and visualization # - Data manipulation and transformation # - Machine learning workflow generation and execution # - Process automation and scripting # - And much more, as new possibilities emerge through experimentation # # ### Using o3-mini for Dynamic Tool generation # # Released on 31-Jan-25, o3-mini model has exceptional STEM capabilitiesâ€”with particular strength in science, math, and codingâ€”all while maintaining the low cost and reduced latency of smaller models. In this Cookbook, we will demonstrate o3-mini's capabilities to generate python code to interpret data and draw insights. # # Reasoning models are particularly good at generating dynamic tools to analyze data since they can reason on their own, without the need of an explicit chain-of-thought prompt. In fact, providing explicit chain of thought instructions may interfere with model's internal reasoning and lead to suboptimal outcomes. You can learn more about o3-mini <a href="https://openai.com/index/openai-o3-mini/">here.</a> # # ### Why build your own code interpreter # # Many API providersâ€”such as OpenAIâ€™s Assistants APIâ€”offer built-in code interpreter functionality. These built-in code interpreters can be immensely powerful, but there are situations where developers may need to create their own custom code interpreter. For example: # # 1. <strong>Language or library support</strong>: The built-in interpreter may not support the specific programming language (e.g., C++, Java, etc.) or libraries required for your task. # 2. <strong>Task compatibility</strong>: Your use case may not be compatible with the providerâ€™s built-in solution. # 3. <strong>Model constraints</strong>: You might require a language model that isnâ€™t supported by the providerâ€™s interpreter. # 4. <strong>Cost considerations</strong>: The cost structure for code execution or model usage may not fit your budget or constraints. # 5. <strong>File size</strong>: The file size of input data is too large or not supported by the provider's interpreter. # 6. <strong>Integrating with internal systems</strong>: The provider's interpreter may not be able to integrate with your internal systems. # # ### What Youâ€™ll Learn # By following this Cookbook, you will learn how to: # # - Set up an isolated Python code execution environment using Docker # - Configure your own code interpreter tool for LLM agents # - Establish a clear separation of â€œAgenticâ€ concerns for security and safety # - Using <strong>o3-mini</strong> model to dynamically generate code for data analysis # - Orchestrate agents to efficiently accomplish a given task # - Design an agentic application that can dynamically generate and execute code # # Youâ€™ll learn how to build a custom code interpreter tool from the ground up, leverage the power of LLMs to generate sophisticated code, and safely execute that code in an isolated environmentâ€”all in pursuit of making your AI-powered applications more flexible, powerful, and cost-effective. # ### Example Scenario # # We'll use the sample data provided at <a href="https://www.kaggle.com/datasets/willianoliveiragibin/key-factors-traffic-accidents">Key Factors Traffic Accidents</a> to answer a set of questions. These questions do not require to be pre-defined, we will give LLM the ability to generate code to answer such question. # # Sample questions could be: # - What factors contribute the most to accident frequency? (Feature importance analysis) # - Which areas are at the highest risk of accidents? (Classification/Clustering) # - How does traffic fine amount influence the number of accidents? (Regression/Causal inference) # - Can we determine the optimal fine amounts to reduce accident rates? (Optimization models) # - Do higher fines correlate with lower average speeds or reduced accidents? (Correlation/Regression) # - and so on â€¦ # # Using the traditional <strong>Predefined Tool Calling</strong> approach, developer would need to pre-define the function for each of these questions. This limits the LLM's ability to answer any other questions not defined in the pre-defined set of functions. We overcome this limitation by using the <strong>Dynamic Tool Calling</strong> approach where the LLM generates code and uses a Code Interpretter tool to execute the code. # ## Overview # Let's dive into the steps to build this Agentic Applicaiton with Dynamically generated tool calling. There are three components to this application: # #### Step 1: Set up an isolated code execution container environment # # We need a secure environment where our LLM generated function calls can be executed. We want to avoid directly running the LLM generated code on the host machine so will create a Docker container environment with restricted resource access (e.g., no network access). By default, Docker containers cannot access the host machineâ€™s file system, which helps ensure that any code generated by the LLM remains contained. # # ##### âš ï¸ A WORD OF CAUTION: Implement Strong Gaurdrails for the LLM generated code # LLMs could generate harmful code with unintended consequences. As a best practice, isolate the code execution environment with only required access to resources as needed by the task. Avoid running the LLM generated code on your host machine or laptop. # # #### Step 2: Define and Test the Agents # # "<strong>What is an Agent?</strong>" In the context of this Cookbook, an Agent is: # 1. Set of instructions for the LLM to follow, i.e. the developer prompt # 2. A LLM model, and ability to call the model via the API # 3. Tool call access to a function, and ability to execute the function # # We will define two agents: # 1. FileAccessAgent: This agent will read the file and provide the context to the PythonCodeExecAgent. # 2. PythonCodeExecAgent: This agent will generate the Python code to answer the user's question and execute the code in the Docker container. # # #### Step 3: Set up Agentic Orchestration to run the application # There are various ways to orchestrate the Agents based on the application requirements. In this example, we will use a simple orchestration where the user provides a task and the agents are called in sequence to accomplish the task. # # The overall orchestration is shown below: # # <img src="../../images/oo_aa_image_1_code_interpreter_agents.png" alt="" /> # ## Let's get started # # # ### Prerequisites # Before you begin, ensure you have the following installed and configured on your host machine: # # 1. Docker: installed and running on your local machine. You can learn more about Docker and <a href="https://www.docker.com/">install it from here</a>. # 2. Python: installed on your local machine. You can learn more about Python and <a href="https://www.python.org/downloads/">install it from here</a>. # 3. OpenAI API key: set up on your local machine as an environment variable or in the .env file in the root directory. You can learn more about OpenAI API key and <a href="https://platform.openai.com/docs/api-reference/introduction">set it up from here</a>. # # ### Step 1: Set up an Isolated Code Execution Environment # # Lets define a Dockerized container environment that will be used to execute our code. I have defined the <strong><a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/docker/dockerfile">dockerfile</a></strong> under <code class="language-plaintext highlighter-rouge">resources/docker</code> directory that will be used to create the container environment with the following specifications: # - Python 3.10 as the base # - A non-root user # - Preinstall the packages in requirements.txt # # The requirements.txt included in the docker image creation process contains all the potential packages our LLM generated code may need to accomplish its tasks. Given we will restrict the container from network access, so we need to pre-install the packages that are required for the task. Our LLM will not be allowed to install any additional packages for security purposes. # # You could create your own docker image with the language requirements (such as Python 3.10) and pre-install the packages that are required for the task, or create a custom docker image with the specific language (such as Java, C++, etc.) and packages that are required for the task. # Let's build the docker image with the following command. For the sake of brevity, I have redirected the output to grep the success message and print a message if the build fails. # In[1]: get_ipython().system('docker build -t python_sandbox:latest ./resources/docker 2&gt;&amp;1 | grep -E "View build details|ERROR" || echo "Build failed."') # Let's run the container in restricted mode. The container will run in the background. This is our opportunity to define the security policies for the container. It is good practice to only allow the bare minimum features to the container that are required for the task. By default, the container cannot access the host file system from within the container. Let's also restrict its access to network so it cannot access the Internet or any other network resources. # In[2]: # Run the container in restricted mode. The container will run in the background. get_ipython().system('docker run -d â€“name sandbox â€“network none â€“cap-drop all â€“pids-limit 64 â€“tmpfs /tmp:rw,size=64M python_sandbox:latest sleep infinity') # Let's make sure container is running using the <code class="language-plaintext highlighter-rouge">docker ps</code> that should list our container. # In[3]: get_ipython().system('docker ps') # ### Step 2: Define and Test the Agents # # For our purposes, we will define two agents. # 1. <strong>Agent 1: File Access Agent (with Pre-defined Tool Calling)</strong> # - Instructions to understand the contents of the file to provide as context to Agent 2. # - Has access to the host machineâ€™s file system. # - Can read a file from the host and copy it into the Docker container. # - Cannot access the code interpreter tool. # - Uses gpt-4o model. # # 2. <strong>Agent 2: Python Code Generator and Executor (with Dynamically Generated Tool Calling and Code Execution)</strong> # - Recieve the file content's context from Agent 1. # - Instructions to generate a Python script to answer the user's question. # - Has access to the code interpreter within the Docker container, which is used to execute Python code. # - Has access only to the file system inside the Docker container (not the host). # - Cannot access the host machineâ€™s file system or the network. # - Uses our newest <strong>o3-mini</strong> model that excels at code generation. # # This separation concerns of the File Access (Agent 1) and the Code Generator and Executor (Agent 2) is crucial to prevent the LLM from directly accessing or modifying the host machine. # # # <strong>Limit the Agent 1 to Static Tool Calling as it has access to the host file system.</strong> # # # | Agent | Type of Tool Call | Access to Host File System | Access to Docker Container File System | Access to Code Interpreter | # |â€”â€”-|â€”â€”â€”â€”â€”â€”-|â€”â€”â€”â€”â€”â€”â€”â€”â€”-|â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-|â€”â€”â€”â€”â€”â€”â€”â€”â€”-| # | Agent 1: File Access | Pre-defined Tools | Yes | Yes | No | # | Agent 2: Python Code Generator and Executor | Dynamically Generated Tools | No | Yes | Yes | # # To keep the Agents and Tools organized, we've defined a set of <strong>core classes</strong> that will be used to create the two agents for consistency using Object Oriented Programming principles. # # - <strong>BaseAgent</strong>: We start with an abstract base class that enforces common method signatures such as <code class="language-plaintext highlighter-rouge">task()</code>. Base class also provides a logger for debugging, a language model interface and other common functions such as <code class="language-plaintext highlighter-rouge">add_context()</code> to add context to the agent. # - <strong>ChatMessages</strong>: A class to store the conversation history given ChatCompletions API is stateless. # - <strong>ToolManager</strong>: A class to manage the tools that an agent can call. # - <strong>ToolInterface</strong>: An abstract class for any 'tool' that an agent can call so that the tools will have a consistent interface. # # These classes are defined in the <a href="./resources/object_oriented_agents/core_classes">object_oriented_agents/core_classes</a> directory. # #### UML Class Diagram for Core Classes # The following class diagram shows the relationship between the core classes. This UML (Unified Modeling Language) has been generated using <a href="https://mermaid">Mermaid</a> # # <img src="../../images/oo_aa_image_2_uml_diagram.png" alt="" /> # <strong>Define Agent 1: FileAccessAgent with FileAccessTool</strong> # # Let's start with definin the FileAccessTool that inherits from the ToolInterface class. The <strong>FileAccessTool</strong> tool is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/tools/file_access_tool.py">file_access_tool.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/tools</code> directory. # # - FileAccessTool implements the ToolInterface class, which ensures that the tools will have a consistent interface. # - Binding the tool definition for the OpenAI Function Calling API in the <code class="language-plaintext highlighter-rouge">get_definition</code> method and the tool's <code class="language-plaintext highlighter-rouge">run</code> method ensures maintainability, scalability, and reusability. # Now, let's define the <strong>FileAccessAgent</strong> that extends the BaseAgent class and bind the <strong>FileAccessTool</strong> to the agent. The FileAccessAgent is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/agents/file_access_agent.py">file_acess_agent.py</a> file in <code class="language-plaintext highlighter-rouge">resources/registry/agents</code> directory. The FileAccessAgent is: # # - A concrete implementation of the BaseAgent class. # - Initialized with the developer prompt, model name, logger, and language model interface. These values can be overridden by the developer if needed. # - Has a setup_tools method that registers the FileAccessTool to the tool manager. # - Has a <code class="language-plaintext highlighter-rouge">task</code> method that calls the FileAccessTool to read the file and provide the context to the PythonCodeExecAgent. # - <code class="language-plaintext highlighter-rouge">model_name='gpt-4o'</code> that provides sufficient reasoning and tool calling ability for the task. # # <strong>Define Agent 2: PythonExecAgent with PythonExecTool</strong> # # Similarly, PythonExecTool inherits from the ToolInterface class and implements the get_definition and run methods. The get_definition method returns the tool definition in the format expected by the OpenAI Function Calling API. The run method executes the Python code in a Docker container and returns the output. This tool is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/tools/python_code_interpreter_tool.py">python_code_interpreter_tool.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/tools</code> directory. # # Likewise, PythonExecAgent is a concrete implementation of the BaseAgent class. It is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/agents/python_code_exec_agent.py">python_code_exec_agent.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/agents</code> directory. The PythonExecAgent is: # # - A concrete implementation of the BaseAgent class. # - Initialized with the developer prompt, model name, logger, and language model interface. These values can be overridden by the developer if needed. # - Has a setup_tools method that registers the PythonExecTool to the tool manager. # - Has a <code class="language-plaintext highlighter-rouge">task</code> method that calls the OpenAI API to perform the user's task, which in this case involves generating a Python script to answer the user's question and run it with Code Interpreter tool. # - <code class="language-plaintext highlighter-rouge">model_name='o3-mini'</code> that excels at STEM tasks such as code generation. # - <code class="language-plaintext highlighter-rouge">reasoning_effort='high'</code> that allows for more complete reasoning given the complexity of the task at the cost of more tokens generated and slower responses. The default value is medium, which is a balance between speed and reasoning accuracy. # # You can learn more about the <code class="language-plaintext highlighter-rouge">reasoning_effort</code> parameter <a href="https://platform.openai.com/docs/guides/reasoning">here</a>. # ### Step 3: Set up Agentic Orchestration to run the application # # With the Agents defined, now we can define the orchestration loop that will run the application. This loop will prompt the user for a question or task, and then call the FileAccessAgent to read the file and provide the context to the PythonExecAgent. The PythonExecAgent will generate the Python code to answer the user's question and execute the code in the Docker container. The output from the code execution will be displayed to the user. # # User can type 'exit' to stop the application. Our question: <strong>What factors contribute the most to accident frequency?</strong> Note that we did not pre-define the function to answer this question. # # # In[4]: # Import the agents from registry/agents from resources.registry.agents.file_access_agent import FileAccessAgent from resources.registry.agents.python_code_exec_agent import PythonExecAgent prompt = """Use the file traffic_accidents.csv for your analysis. The column names are: Variable Description accidents Number of recorded accidents, as a positive integer. traffic_fine_amount Traffic fine amount, expressed in thousands of USD. traffic_density Traffic density index, scale from 0 (low) to 10 (high). traffic_lights Proportion of traffic lights in the area (0 to 1). pavement_quality Pavement quality, scale from 0 (very poor) to 5 (excellent). urban_area Urban area (1) or rural area (0), as an integer. average_speed Average speed of vehicles in km/h. rain_intensity Rain intensity, scale from 0 (no rain) to 3 (heavy rain). vehicle_count Estimated number of vehicles, in thousands, as an integer. time_of_day Time of day in 24-hour format (0 to 24). accidents traffic_fine_amount """ print("Setup: ") print(prompt) print("Setting up the agentsâ€¦ ") # Instantiate the agents with the default constructor defined values # Developer may override the default values - prompt, model, logger, and language model interface if needed # This agent use gpt-4o by default file_ingestion_agent = FileAccessAgent() # Let's make sure agent uses o3-mini model and set the reasoning_effort to high data_analysis_agent = PythonExecAgent(model_name='o3-mini', reasoning_effort='high') print("Understanding the contents of the fileâ€¦") # Give a task to the file ingestion agent to read the file and provide the context to the data analysis agent file_ingestion_agent_output = file_ingestion_agent.task(prompt) # Add the file content as context to the data analysis agent # The context is added to the agent's tool manager so that the tool manager can use the context to generate the code data_analysis_agent.add_context(prompt) data_analysis_agent.add_context(file_ingestion_agent_output) while True: print("Type your question related to the data in the file. Type 'exit' to exit.") user_input = input("Type your question.") if user_input == "exit": print("Exiting the application.") break print(f"User question: {user_input}") print("Generating dynamic tools and using code interpreterâ€¦") data_analysis_agent_output = data_analysis_agent.task(user_input) print("Outputâ€¦") print(data_analysis_agent_output) # In this example, the <strong>o3-mini</strong> dynamically generated a tool (Python script) based on user's question to analyze the data. Note that <strong>o3-mini</strong> examined the problem using multiple approaches such as correlation analysis, linear regression and random forest models. This approach highlights the following: # # <strong>reasoning_effort</strong>: The depth of reasoning the model performs e.g., in this case number of approaches, generally increases when the parameter is increased from low, medium to high. You can try with different levels of reasoning effort to see the difference. # # <strong>Dynamically Generated Tool Calling</strong>: The tool (Python script) to analyze the data was not manually written or predetermined by the developer. Instead, the o3-mini model created the relevant data exploration and correlation analysis code at runtime. # # <strong>Isolated Code Execution</strong>: To ensure security and avoid running untrusted code on the host machine, the Python script was executed inside a Docker container using the <code class="language-plaintext highlighter-rouge">execute_python_code</code> tool. This container had restricted resource access (e.g., no network and limited filesystem access), minimizing potential risks posed by arbitrary code execution. # # ### Conclusion # # The Cookbook provides a guide for developing a <strong>custom code interpreter</strong> tailored to specific application needs, addressing limitations found in vendor-provided solutions such as language constraints, cost considerations, and the need for flexibility with different LLMs or models. # # <strong>Approach for Managing Agents and Tools</strong>: We also defined a set of core classes to manage the agents and tools. This approach ensures that the agents and tools will have a consistent interface and can be reused across different applications. A repository of agents and tools such as the <a href="https://github.com/openai/openai-cookbook/tree/main/examples/object_oriented_agentic_approach/resources/registry">registry</a> folder can be created to manage the agents and tools. # # <strong>o3-mini model</strong>: We demonstrated o3-mini model's ability to generate sophisticated code at run time to analyze data based on user's minimal prompt. o3-mini model then reasoned over the outcome of the analysis to explain the results to the user. # # Finally, <strong>to recap</strong>, the three steps to build an Agentic Application with Dynamic Tool Calling are: # 1. Set up an isolated code execution container environment # 2. Define and Test the Agents # 3. Set up Agentic Orchestration to run the application # # We discussed the importance of isolating the code execution environment to ensure security and avoid running untrusted code on the host machine. With the use case of a CSV file, we demonstrated how to dynamically generate a tool (a Python script) to analyze the data and answer the user's question. We also showed how to execute the code in a Docker container and return the output to the user.

</p>

<p>í•œêµ­ì–´ë¡œ ë‹µí•¨.<br />
ë¬¸ì¥ ì•ì— ì¸ìš©(Blockquote) ê¸ˆì§€, ê·¸ëŒ€ë¡œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ ì„œìˆ .</p>

<hr />

<h3 id="ë‹¹ì‹ ì´-ì›í•˜ëŠ”-ëª©í‘œë¥¼-ë‹¤ì‹œ-ì •ë¦¬í•˜ë©´-ë‹¤ìŒê³¼-ê°™ì•„">ë‹¹ì‹ ì´ ì›í•˜ëŠ” ëª©í‘œë¥¼ ë‹¤ì‹œ ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì•„:</h3>

<ol>
  <li>
    <p>LLMì´ ìƒì„±í•œ <strong>íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰</strong> í•˜ê³  ì‹¶ë‹¤.</p>
  </li>
  <li>
    <p>í•˜ì§€ë§Œ <strong>í˜¸ìŠ¤íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì„ ë§ê°€ëœ¨ë¦¬ê±°ë‚˜ ìˆ˜ì •í•˜ë©´ ì•ˆ ëœë‹¤</strong>.</p>
  </li>
  <li>
    <p>í•„ìš”í•  ê²½ìš° íŒŒì¼ì€ <strong>ì§€ì •ëœ ì‘ì—… í´ë”ì— ë³µì‚¬í•´ì„œ ê·¸ ì•ˆì—ì„œë§Œ ì²˜ë¦¬</strong> ë˜ê¸¸ ì›í•œë‹¤.</p>
  </li>
  <li>
    <p>Docker ì—†ì´ (ì¦‰, ì»¨í…Œì´ë„ˆ ì—†ì´) êµ¬í˜„í•˜ê³  ì‹¶ë‹¤.</p>
  </li>
  <li>
    <p>ì‹œìŠ¤í…œì€ vLLM + Qwen + OpenAI Agents SDK ë˜ëŠ” GPTOSS ê¸°ë°˜ìœ¼ë¡œ êµ¬ì„±í•˜ë ¤ê³  í•œë‹¤.</p>
  </li>
</ol>

<p>ì—¬ê¸°ì„œ ê°€ì¥ í° ë„ì „ì€ <strong>ë³´ì•ˆ ê²©ë¦¬ ì—†ì´ í˜¸ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œ</strong> ë¥¼ ì–´ë–»ê²Œ ì•ˆì „í•˜ê²Œ ì œí•œí•˜ëŠëƒì´ë‹¤. DockerëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í•´ê²°ì±…ì´ì§€ë§Œ, ë‹¹ì‹ ì´ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í–ˆìœ¼ë¯€ë¡œ <strong>Python ìì²´ì˜ ê°€ìƒí™” + ì‹œìŠ¤í…œ ìˆ˜ì¤€ì˜ sand-boxing(ê¶Œí•œ ì œí•œ)</strong> ë°©í–¥ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•œë‹¤.</p>

<p>ë‚˜ëŠ” ì•„ë˜ ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼ì„ ì¶”ì²œí•œë‹¤.</p>

<hr />

<h2 id="ë‹¨ê³„ë³„-ì„¤ê³„-step-by-step">ë‹¨ê³„ë³„ ì„¤ê³„ (step-by-step)</h2>

<h3 id="1ë‹¨ê³„-ì‘ì—…-ë””ë ‰í† ë¦¬sandbox-workspace-êµ¬ì¡°-ì •ì˜">1ë‹¨ê³„. "ì‘ì—… ë””ë ‰í† ë¦¬(sandbox workspace)" êµ¬ì¡° ì •ì˜</h3>

<p>ì˜ˆì‹œ êµ¬ì¡°:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/host
   /data              â† ì›ë³¸ íŒŒì¼ë“¤ <span class="o">(</span>ì½ê¸° ì „ìš©<span class="o">)</span>
   /sandbox           â† LLM ìƒì„± ì½”ë“œê°€ ì‹¤í–‰ë˜ëŠ” í´ë” <span class="o">(</span>ì“°ê¸° ê°€ëŠ¥<span class="o">)</span>
   /runner            â† ì½”ë“œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
</code></pre></div></div>

<p>ì›ë³¸ íŒŒì¼ ì ‘ê·¼ ë°©ì¹¨:</p>

<ul>
  <li>
    <p>í˜¸ìŠ¤íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">/data</code> ëŠ” ì½ê¸°ë§Œ í—ˆìš©.</p>
  </li>
  <li>
    <p>ì‘ì—…ì— í•„ìš”í•œ íŒŒì¼ì´ ìˆìœ¼ë©´ <code class="language-plaintext highlighter-rouge">/sandbox</code> ë¡œ ë³µì‚¬í•œ ë’¤ ê·¸ ì•ˆì—ì„œë§Œ ì‚¬ìš©.</p>
  </li>
</ul>

<p>íŒŒì´ì¬ ì‹¤í–‰ í™˜ê²½ì—ì„œ <code class="language-plaintext highlighter-rouge">open()</code> ì´ /data ë¥¼ ìˆ˜ì •í•˜ì§€ ëª»í•˜ë„ë¡ ê°•ì œí•˜ë ¤ë©´, <code class="language-plaintext highlighter-rouge">runner</code> ë ˆë²¨ì—ì„œ path ê²€ì¦ì„ ë„£ì–´ì•¼ í•œë‹¤.</p>

<hr />

<h3 id="2ë‹¨ê³„-python-ì‹¤í–‰ì„-ì§„ì§œ-ë¶„ë¦¬ëœ-í”„ë¡œì„¸ìŠ¤ì—ì„œ-ì‹¤í–‰í•˜ê²Œ-í•˜ê¸°">2ë‹¨ê³„. Python ì‹¤í–‰ì„ "ì§„ì§œ ë¶„ë¦¬ëœ í”„ë¡œì„¸ìŠ¤"ì—ì„œ ì‹¤í–‰í•˜ê²Œ í•˜ê¸°</h3>

<p>í•µì‹¬ì€ ì½”ë“œ ì‹¤í–‰ì„ <strong>ì„œë¸Œ í”„ë¡œì„¸ìŠ¤ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒ</strong>.</p>

<p>ì˜ì‚¬ ì½”ë“œ:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arduino

# runner.py
def run_code(code_string):
    ìƒì„±ëœ_ì½”ë“œë¥¼ /sandbox/temp.py ë¡œ ì €ì¥
    subprocess.run(["python", "/sandbox/temp.py"], timeout=5, cwd="/sandbox")
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì•ˆì „ì¥ì¹˜:</p>

<ul>
  <li>
    <p>cwd ë¥¼ /sandbox ë¡œ ê³ ì •</p>
  </li>
  <li>
    <p>timeout (= ë¬´í•œ ë£¨í”„, while True ë°©ì§€)</p>
  </li>
  <li>
    <p>subprocess ì‹¤í–‰ ì „ì— íŒŒì¼ëª… ë° path ê²€ì¦</p>
  </li>
</ul>

<hr />

<h3 id="3ë‹¨ê³„-íŒŒì¼-ì ‘ê·¼-í•„í„°ë§-ì•ˆì „-ì¥ì¹˜">3ë‹¨ê³„. íŒŒì¼ ì ‘ê·¼ í•„í„°ë§ (ì•ˆì „ ì¥ì¹˜)</h3>

<p>íŒŒì´ì¬ ì½”ë“œì— ì§ì ‘ì ì¸ íŒŒì¼ ì ‘ê·¼ì„ ë§‰ìœ¼ë ¤ë©´:<br />
ë°©ë²• A. exec í™˜ê²½ì—ì„œ <code class="language-plaintext highlighter-rouge">open</code> ê°™ì€ builtins ì œê±°<br />
ë°©ë²• B. Python restricted environment ì ìš© (ëŒ€ì‹  ì™„ì „í•˜ì§€ ì•ŠìŒ)<br />
ë°©ë²• C. ì˜¤ë²„ë ˆì´ íŒŒì¼ì‹œìŠ¤í…œ ë˜ëŠ” chroot (Docker ì—†ì´ ê°€ëŠ¥)</p>

<p>ì—¬ê¸°ì„œëŠ” <strong>ê°€ì¥ ê°„ë‹¨í•œ ì‹¤ìš©ì  ë³´í˜¸</strong> ë¥¼ ì¶”ì²œí•œë‹¤.</p>

<p>ì˜ˆì œ ì½”ë“œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">safe_globals</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">range</span><span class="sh">"</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">len</span><span class="sh">"</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">print</span><span class="sh">"</span><span class="p">:</span> <span class="k">print</span><span class="p">,</span>
        <span class="c1"># í•„ìš”í•œ ìµœì†Œ ê¸°ëŠ¥ë§Œ í—ˆìš©
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">exec</span><span class="p">(</span><span class="n">code_string</span><span class="p">,</span> <span class="n">safe_globals</span><span class="p">)</span>
</code></pre></div></div>

<p>ë‹¨, ë°ì´í„° ë¶„ì„ ëª©ì ì´ë¼ë©´ pandas, numpy í•„ìš”í•˜ë¯€ë¡œ ìœ„ ë°©ì‹ì´ ë„ˆë¬´ ì œí•œëœë‹¤.<br />
ê·¸ë˜ì„œ ë” í˜„ì‹¤ì ì¸ ë°©ë²•ì€ <strong>subprocess ì‹¤í–‰ + sys.setrecursionlimit ì œí•œ + resource ëª¨ë“ˆë¡œ ë©”ëª¨ë¦¬/CPU ì œí•œ</strong> ì´ë‹¤.</p>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">resource</span>

<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>          <span class="c1"># CPU ì œí•œ 2ì´ˆ
</span><span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="p">(</span><span class="mi">800</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span>  <span class="c1"># ë©”ëª¨ë¦¬ 800MB ì œí•œ
</span></code></pre></div></div>

<hr />

<h3 id="4ë‹¨ê³„-openai-agents-sdk-ë˜ëŠ”-vllm-function-calling-ì„¤ê³„">4ë‹¨ê³„. OpenAI Agents SDK (ë˜ëŠ” vLLM Function-calling) ì„¤ê³„</h3>

<p>ì½”ë“œ ì‹¤í–‰ì„ í•˜ë‚˜ì˜ Tool ë¡œ ì •ì˜í•œë‹¤.</p>

<p>ê°œë…ì  pseudo-code:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute_python_tool</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sandbox_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/sandbox/temp.py</span><span class="sh">"</span>
    <span class="n">codeë¥¼</span> <span class="n">sandbox_path</span> <span class="n">ì—</span> <span class="n">ì €ì¥</span>
    <span class="n">subprocessë¡œ</span> <span class="n">ì‹¤í–‰í•˜ê³ </span> <span class="n">stdout</span><span class="o">/</span><span class="n">stderr</span> <span class="n">ë°˜í™˜</span>
</code></pre></div></div>

<p>LLM ì—ê²Œ tool spec ì„ ì œê³µ:</p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">tools</span> <span class="p">=</span> <span class="s">[</span>
    <span class="err">{</span>
        <span class="err">"type":</span> <span class="err">"function",</span>
        <span class="err">"name":</span> <span class="err">"execute_python_tool",</span>
        <span class="err">"description":</span> <span class="err">"Executes</span> <span class="err">python</span> <span class="err">code</span> <span class="err">inside</span> <span class="err">sandbox",</span>
        <span class="err">"parameters":</span> <span class="err">{</span>
            <span class="err">"type":</span> <span class="err">"object",</span>
            <span class="err">"properties":</span> <span class="err">{</span>
                <span class="err">"code":</span> <span class="err">{"type":</span> <span class="err">"string"}</span>
            <span class="err">},</span>
            <span class="err">"required":</span> <span class="nn">["code"]</span>
        <span class="err">}</span>
    <span class="err">}</span>
<span class="err">]</span>
</code></pre></div></div>

<p>vLLM(Qwen/GPTOSS) + Agents SDK ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë™ì‘:</p>

<ul>
  <li>ì‚¬ìš©ìê°€ â€œë¶„ì„í•´ì¤˜â€ â†’ LLM â†’ ì½”ë“œ ìƒì„± â†’ tool í˜¸ì¶œ â†’ python ì‹¤í–‰ â†’ ê²°ê³¼ ë°˜í™˜.</li>
</ul>

<hr />

<h3 id="5ë‹¨ê³„-í˜¸ìŠ¤íŠ¸-íŒŒì¼-ë³´í˜¸-ì •ë¦¬">5ë‹¨ê³„. í˜¸ìŠ¤íŠ¸ íŒŒì¼ ë³´í˜¸ (ì •ë¦¬)</h3>

<p>ë³´ì•ˆ ìˆ˜ì¹™:</p>

<ol>
  <li>
    <p>ì½”ë“œ ì‹¤í–‰ì€ í•­ìƒ <strong>subprocessì—ì„œ</strong> ì‹¤í–‰.</p>
  </li>
  <li>
    <p>sandbox ë””ë ‰í† ë¦¬ ì™¸ ê²½ë¡œ ì ‘ê·¼ ì‹œ <strong>ì‹¤í–‰ ê±°ë¶€</strong>.</p>
  </li>
  <li>
    <p>CPU / ë©”ëª¨ë¦¬ / ì‹¤í–‰ì‹œê°„ ì œí•œ.</p>
  </li>
  <li>
    <p>ìƒì„±ëœ íŒŒì¼ë„ sandbox ë‚´ë¶€ì—ì„œë§Œ.</p>
  </li>
</ol>

<hr />

<h3 id="ìš”ì•½-ë‹¹ì‹ ì´-ì–»ëŠ”-ê²ƒ">ìš”ì•½ (ë‹¹ì‹ ì´ ì–»ëŠ” ê²ƒ)</h3>

<ul>
  <li>
    <p><strong>Docker ì—†ì´ë„ ê°€ëŠ¥í•œ code interpreter</strong></p>
  </li>
  <li>
    <p><strong>LLMì´ generate â†’ ì‹¤í–‰ â†’ ê²°ê³¼ ë°˜í™˜</strong> í•˜ëŠ” Pipeline</p>
  </li>
  <li>
    <p><strong>í˜¸ìŠ¤íŠ¸ íŒŒì¼ì„ ì½ê¸° ì „ìš©ìœ¼ë¡œ ìœ ì§€</strong> í•˜ë©´ì„œ, ìˆ˜ì •ì€ ì „ë¶€ sandboxì—ì„œë§Œ</p>
  </li>
  <li>
    <p><strong>LLM ê¸°ë°˜ ë™ì  tool execution</strong></p>
  </li>
</ul>

<hr />

<h3 id="ë‹¤ìŒ-ë‹¨ê³„">ë‹¤ìŒ ë‹¨ê³„</h3>

<p>ì›í•œë‹¤ë©´,</p>

<ul>
  <li>
    <p>ë‚´ê°€ ì§ì ‘ í”„ë¡œë•ì…˜ ìˆ˜ì¤€ ì½”ë“œ (ì˜ˆ: runner.py, tool binding ì½”ë“œ) ë¥¼ ì‘ì„±í•´ ì¤„ ìˆ˜ ìˆë‹¤</p>
  </li>
  <li>
    <p>ë˜ëŠ” vLLM + Agents SDK ì™€ í†µí•©ëœ ì „ì²´ í”„ë¡œì íŠ¸ í…œí”Œë¦¿ì„ ë§Œë“¤ì–´ ì¤„ ìˆ˜ ìˆë‹¤</p>
  </li>
</ul>

<p>í•œë§ˆë””ë¡œ, ë‹¹ì‹ ì´ ë§Œë“¤ë ¤ëŠ” ê±´ <strong>Code Interpreter Clone, but without Docker</strong>.</p>

<p>ê³„ì† ë„ì™€ì¤„ê²Œ.<br />
ë‹¤ìŒ ë©”ì‹œì§€ì— ì•„ë˜ ì¤‘ í•˜ë‚˜ ì„ íƒí•´ì¤˜:</p>

<ol>
  <li>
    <p>Python ì‹¤ì œ ì‹¤í–‰ ì½”ë“œ + tool ì½”ë“œ ìƒì„± ì›í•¨</p>
  </li>
  <li>
    <p>vLLM + Qwen + Agents SDK í†µí•© êµ¬ì¡° ìƒ˜í”Œ ì›í•¨</p>
  </li>
  <li>
    <p>ë‘˜ ë‹¤ ì›í•¨</p>
  </li>
</ol>

<p>ì–¸ì œë“  í™•ì¥í•´ì„œ ê³ ê³ !</p>

<p class="chat--user">

1. ì–´ì œ ë„ˆê°€ ë§Œë“¤ì–´ì¤€ ì½”ë“œë„ ì°¸ê³ í•´ì¤˜. ì´ ì½”ë“œì˜ ì¥ì ì€ Kernelì´ ìœ ì§€ëœë‹¤ëŠ” ì¥ì ì´ ìˆëŠ” ê²ƒ ê°™ì•„ 2. data í´ë”ë¥¼ ë”°ë¡œ ì•ˆ ë§Œë“¤ê³  ëª¨ë“  ê²½ë¡œì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë˜ ì“¸ íŒŒì¼ì€ copy_to_sandbox(source, destination) ê°™ì€ Toolë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ í•˜ë©´ ì¢‹ê² ì–´. 3. ë„ˆê°€ ì¤€ ì˜ˆì‹œì—ì„œ temp.py ê°€ sanbox ì•ˆì˜ íŒŒì¼ë§Œ ì ‘ê·¼í•œë‹¤ëŠ” ë³´ì¥ì´ ì—†ì§€ ì•Šì•„? ì´ëŸ° ê±¸ í•´ì¤„ ìˆ˜ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì–´? ë„ì»¤ ê°™ì€ ì™¸ë¶€ í”„ë¡œê·¸ë¨ì€ ë³„ë¡œ ì•ˆ ì“°ê³  ì‹¶ë„¤ import os, time, base64, re from typing import Dict, Any, List from openai import OpenAI from jupyter_client import KernelManager # ========= ì„¤ì • ========= # í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEY í•„ìš” MODEL = os.environ.get("OPENAI_MODEL", "gpt-5.1") DATA_DIR = os.environ.get("DATA_DIR", "/mnt/data") os.makedirs(DATA_DIR, exist_ok=True) # ========= ì„ë² ë””ë“œ ì»¤ë„ ì‹¤í–‰ê¸° ========= class KernelSession: def <strong>init</strong>(self): # íˆìŠ¤í† ë¦¬ ë¹„í™œì„±í™”ë¡œ ê¹”ë”í•˜ê²Œ self.km = KernelManager() self.km.start_kernel(extra_arguments=["â€“HistoryManager.enabled=False"]) self.kc = self.km.client(); self.kc.start_channels() def shutdown(self): try: self.kc.stop_channels() self.km.shutdown_kernel(now=True) except Exception: pass def execute(self, code: str, timeout: float = 3.0) -&gt; Dict[str, Any]: # ê°„ë‹¨í•œ ì•ˆì „ í•„í„°(ì •ì±…ì— ë§ê²Œ í™•ì¥ ê°€ëŠ¥) if re.search(r"\bseaborn\b", code): return {"returncode": 2, "stdout": "", "stderr": "Do not use seaborn", "artifacts": []} msg_id = self.kc.execute(code, allow_stdin=False, stop_on_error=True) t0 = time.time(); out=[]; err=[]; arts=[] while True: if time.time() - t0 &gt; timeout: # íƒ€ì„ì•„ì›ƒ ì‹œ ì»¤ë„ ê°•ì œ ì¢…ë£Œ(ë¬´í•œë£¨í”„ ë°©ì§€) self.km.shutdown_kernel(now=True) return {"returncode":124,"stdout":"".join(out),"stderr":"Timeout","artifacts":[]} try: msg = self.kc.get_iopub_msg(timeout=0.1) except Exception: continue if msg["parent_header"].get("msg_id") != msg_id: continue typ = msg["header"]["msg_type"]; content = msg["content"] if typ == "stream": (out if content["name"]=="stdout" else err).append(content["text"]) elif typ == "error": err.append("\n".join(content.get("traceback", []))) elif typ in ("display_data","execute_result"): data = content.get("data", {}) if "image/png" in data: b = data["image/png"] if isinstance(b, str): b = b.encode() png = base64.b64decode(b) fn = f"plot_{int(time.time()<em>1000)}.png" fp = os.path.join(DATA_DIR, fn) with open(fp, "wb") as f: f.write(png) arts.append({"name": fn, "path": f"/mnt/data/{fn}", "mime": "image/png"}) elif typ == "status" and content["execution_state"] == "idle": break return { "returncode": 0, "stdout": "".join(out)[:20000], "stderr": "".join(err)[:20000], "artifacts": arts } class KernelPool: def <strong>init</strong>(self): self.sessions: Dict[str, KernelSession] = {} def get(self, session_id: str) -&gt; KernelSession: if session_id not in self.sessions: self.sessions[session_id] = KernelSession() return self.sessions[session_id] def kill(self, session_id: str): s = self.sessions.pop(session_id, None) if s: s.shutdown() POOL = KernelPool() def _plot_rule_check(code: str) -&gt; str | None: # ë‹¨ì¼ í”Œë¡¯, ìƒ‰ìƒ/ìŠ¤íƒ€ì¼ ì§€ì • ê¸ˆì§€(ì›í•˜ëŠ” ì •ì±…ì´ë©´ ì™„í™” ê°€ëŠ¥) if re.search(r"\.subplot\(", code) or re.search(r"subplots\(", code): return "Do not use subplots" if re.search(r"(color\s</em>=|palette\s<em>=|style\s</em>=)", code): return "Do not set explicit colors or styles" return None # ========= OpenAI tools ì •ì˜(HTTP ì„œë²„ ì—†ì´ in-process) ========= python_exec_internal_tool = { "type": "function", "function": { "name": "python_exec_internal", "description": "ë‚´ë¶€ ë¶„ì„ìš© íŒŒì´ì¬ ì‹¤í–‰(ì‚¬ìš©ìì—ê² ì¶œë ¥ ìˆ¨ê¹€). ì„¸ì…˜ì€ session_idë¡œ ìœ ì§€.", "parameters": { "type": "object", "properties": { "session_id": {"type": "string", "description": "ëŒ€í™”/ìŠ¤ë ˆë“œ ì‹ë³„ì"}, "code": {"type": "string"}, "timeout_sec": {"type": "integer","minimum":1,"maximum":10,"default":3} }, "required": ["session_id", "code"], "additionalProperties": False }, "strict": True } } python_exec_visible_tool = { "type": "function", "function": { "name": "python_exec_visible", "description": "ì‚¬ìš©ì ê°€ì‹œ íŒŒì´ì¬ ì‹¤í–‰(ë‹¨ì¼ matplotlib í”Œë¡¯, ìƒ‰/ìŠ¤íƒ€ì¼ ì§€ì • ê¸ˆì§€).", "parameters": { "type": "object", "properties": { "session_id": {"type": "string"}, "code": {"type": "string"}, "timeout_sec": {"type":"integer","minimum":1,"maximum":10,"default":3}, "enforce_plot_rules": {"type":"boolean","default": True} }, "required": ["session_id", "code"], "additionalProperties": False }, "strict": True } } def run_tool_locally(name: str, args: Dict[str, Any]) -&gt; Dict[str, Any]: session_id = args["session_id"] code = args["code"] timeout = int(args.get("timeout_sec", 3)) if name == "python_exec_visible" and args.get("enforce_plot_rules", True): v = _plot_rule_check(code) if v: return {"returncode": 2, "stdout": "", "stderr": v, "artifacts": []} sess = POOL.get(session_id) return sess.execute(code, timeout=timeout) # ========= ëª¨ë¸ ë¼ìš´ë“œíŠ¸ë¦½ ========= def roundtrip(client: OpenAI, user_msg: str, session_id: str): # 1) ì²« í˜¸ì¶œ: ì‚¬ìš©ì ì§ˆë¬¸ + íˆ´ ìŠ¤í™ ì œê³µ resp = client.responses.create( model=MODEL, input=[{"role": "user", "content": user_msg}], tools=[python_exec_internal_tool, python_exec_visible_tool], parallel_tool_calls=False ) # 2) tool_call ê°ì§€ ë° in-process ì‹¤í–‰ â†’ ì¬í”¼ë“œë°± messages = [{"role": "user", "content": user_msg}] final_text = None for item in resp.output: if item.type == "message": # ëª¨ë¸ì´ ì¦‰ë‹µí–ˆë‹¤ë©´ ê·¸ ë‚´ìš© final_text = item.content[0].text if item.type == "tool_call": name = item.name args = item.arguments result = run_tool_locally(name, args) # íˆ´ ê²°ê³¼ë¥¼ ëª¨ë¸ì— ë‹¤ì‹œ ë„£ì–´ ìì—°ì–´ ë‹µë³€ ìƒì„± follow = client.responses.create( model=MODEL, input=messages + [{"role": "tool", "name": name, "content": result}], tools=[python_exec_internal_tool, python_exec_visible_tool], parallel_tool_calls=False ) final_text = follow.output_text break return final_text # ========= ì‹¤í–‰ ì˜ˆì‹œ ========= if <strong>name</strong> == "<strong>main</strong>": client = OpenAI() print("ì˜ˆì‹œ 1) ë‚´ë¶€ìš© ì‹¤í–‰: sum(range(10))") msg1 = "sum(range(10))ì„ ë‚´ë¶€ ì‹¤í–‰ê¸°ë¡œ ê³„ì‚°í•´ì„œ ê²°ê³¼ë§Œ ë§í•´ì¤˜." print(roundtrip(client, msg1, session_id="sess-1")) print("\nì˜ˆì‹œ 2) ê°€ì‹œ ì‹¤í–‰: ê°„ë‹¨ í”Œë¡¯ ìƒì„±") code = """ import matplotlib.pyplot as plt x = [1,2,3,4]; y = [v*v for v in x] plt.figure() plt.plot(x,y) # ìƒ‰/ìŠ¤íƒ€ì¼ ì§€ì • ê¸ˆì§€ plt.title("y = x^2") plt.savefig("/mnt/data/curve.png") print("done") """ msg2 = f"ì´ ì½”ë“œë¥¼ ê°€ì‹œ ì‹¤í–‰ê¸°ë¡œ ëŒë¦¬ê³  ì‚°ì¶œë¬¼ ê²½ë¡œë¥¼ ìš”ì•½í•´ì„œ ì•Œë ¤ì¤˜:\n{code}" print(roundtrip(client, msg2, session_id="sess-1"))

</p>

<p>ì¢‹ì•„. ì»¤ë„ì´ ìœ ì§€ë˜ëŠ” ë„¤ ê¸°ì¡´ êµ¬ì¡°ë¥¼ ì‚´ë¦¬ë©´ì„œ, â€œì½ê¸°ëŠ” ì–´ë””ë“  ê°€ëŠ¥, ì“°ê¸°ëŠ” ìƒŒë“œë°•ìŠ¤ ë””ë ‰í„°ë¦¬ë¡œë§Œâ€ì„ ê°•ì œí•˜ê³ , ë„ì»¤ ì—†ì´ ì‹¤í–‰í•˜ëŠ” í˜•íƒœë¡œ ì •ë¦¬í–ˆë‹¤. í•µì‹¬ì€ ë‘ ê²¹ì˜ ì•ˆì „ì¥ì¹˜ë‹¤.</p>

<ol>
  <li>
    <p>ì†Œí”„íŠ¸ ê°€ë“œ: ì»¤ë„ ë‚´ë¶€ì—ì„œ open/os/pathlib ë“±ì„ ëª½í‚¤íŒ¨ì¹˜í•´ ì“°ê¸° ë™ì‘ì„ ìƒŒë“œë°•ìŠ¤ë¡œë§Œ ì œí•œ. subprocess/os.systemë„ ë§‰ìŒ.</p>
  </li>
  <li>
    <p>í•˜ë“œ ê°€ë“œ(ì„ íƒ, Linux): Landlock(ì»¤ë„ LSM) ë°”ì¸ë”©ìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ ìì²´ì— â€œìƒŒë“œë°•ìŠ¤ ë°– ì“°ê¸° ê¸ˆì§€â€ë¥¼ ì»¤ë„ ìˆ˜ì¤€ì—ì„œ ì ìš©. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ˆ: pylandlock. ì´ê±´ ë„ì»¤ë‚˜ ì™¸ë¶€ í”„ë¡œê·¸ë¨ì´ ì•„ë‹ˆë¼ ì»¤ë„ ê¸°ëŠ¥ì„ ì§ì ‘ ì´ìš©í•˜ë¯€ë¡œ ìš”êµ¬ì‚¬í•­ê³¼ ë¶€í•©.</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œëŠ” ë„¤ê°€ ì˜¬ë¦° ì»¤ë„ ìœ ì§€í˜• ì„¤ê³„ë¥¼ ê·¸ëŒ€ë¡œ í™•ì¥í–ˆë‹¤. copy_to_sandbox(source, dest_rel) íˆ´ì„ ì¶”ê°€í–ˆê³ , temp.py ê°™ì€ ì„ì˜ ì½”ë“œê°€ ìƒŒë“œë°•ìŠ¤ ë°–ì„ ì“°ë ¤ í•˜ë©´ ì»¤ë„ ì•ˆì—ì„œ PermissionErrorë¥¼ ì¼ìœ¼í‚¤ë„ë¡ ê°•ì œí–ˆë‹¤. ì½ê¸°ëŠ” ì–´ë””ë“  ê°€ëŠ¥í•˜ë„ë¡ ë‘ì—ˆë‹¤.</p>

<p>ì½”ë“œ ê·¸ëŒ€ë¡œ ë¶™ì—¬ ë„£ì–´ ì‹¤í–‰í•˜ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# coding: utf-8
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">base64</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>

<span class="c1"># ========= ì„¤ì • =========
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-5.1</span><span class="sh">"</span><span class="p">)</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">DATA_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/data</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ê°€ì‹œ ì‚°ì¶œë¬¼ ì €ì¥ ìš©
</span><span class="n">SANDBOX_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ì“°ê¸° í—ˆìš© ë””ë ‰í„°ë¦¬
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ========= ì»¤ë„ ë‚´ ìƒŒë“œë°•ìŠ¤ ê°€ë“œ ì½”ë“œ =========
# ì“°ê¸°ëŠ” SANDBOX_DIR ë‚´ë¶€ì—ì„œë§Œ í—ˆìš©, ì½ê¸°ëŠ” ì–´ë””ë“  í—ˆìš©
</span><span class="n">KERNEL_GUARD_CODE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, builtins, pathlib, subprocess, sys

SANDBOX_DIR = os.environ.get(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="s">)
SANDBOX_DIR = os.path.realpath(SANDBOX_DIR)

_ORIG_OPEN = builtins.open
_ORIG_OS_OPEN = os.open
_ORIG_RENAME = os.rename
_ORIG_REPLACE = os.replace
_ORIG_REMOVE = os.remove
_ORIG_UNLINK = os.unlink
_ORIG_MKDIR = os.mkdir
_ORIG_MAKEDIRS = os.makedirs
_ORIG_RMDIR = os.rmdir
_ORIG_CHMOD = os.chmod

def _real(p): return os.path.realpath(p)
def _in_sb(p):
    rp = _real(p)
    return rp == SANDBOX_DIR or rp.startswith(SANDBOX_DIR + os.sep)

def _open_guard(file, mode=</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">, buffering=-1, encoding=None, errors=None, newline=None, closefd=True, opener=None):
    write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">))
    if write_intent and not _in_sb(file):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_OPEN(file, mode, buffering, encoding, errors, newline, closefd, opener)

def _os_open_guard(file, flags, mode=0o777, *, dir_fd=None):
    write_flags = (flags &amp; (os.O_WRONLY | os.O_RDWR | os.O_CREAT | os.O_TRUNC | os.O_APPEND)) != 0
    if write_flags and not _in_sb(file):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_OS_OPEN(file, flags, mode, dir_fd=dir_fd)

def _rename_guard(src, dst, *a, **k):
    if not (_in_sb(src) and _in_sb(dst)):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rename/replace restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_RENAME(src, dst, *a, **k)

def _replace_guard(src, dst, *a, **k):
    if not (_in_sb(src) and _in_sb(dst)):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rename/replace restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_REPLACE(src, dst, *a, **k)

def _remove_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Deletion restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_REMOVE(path, *a, **k)

def _unlink_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Deletion restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_UNLINK(path, *a, **k)

def _mkdir_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Mkdir restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_MKDIR(path, *a, **k)

def _makedirs_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Makedirs restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_MAKEDIRS(path, *a, **k)

def _rmdir_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rmdir restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_RMDIR(path, *a, **k)

def _chmod_guard(path, mode, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">chmod restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_CHMOD(path, mode, *a, **k)

builtins.open = _open_guard
os.open = _os_open_guard
os.rename = _rename_guard
os.replace = _replace_guard
os.remove = _remove_guard
os.unlink = _unlink_guard
os.mkdir = _mkdir_guard
os.makedirs = _makedirs_guard
os.rmdir = _rmdir_guard
os.chmod = _chmod_guard

import pathlib
_ORIG_PATH_OPEN = pathlib.Path.open
def _path_open_guard(self, *args, **kwargs):
    mode = kwargs.get(</span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">)
    if len(args) &gt;= 1: mode = args[0]
    write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">))
    if write_intent and not _in_sb(str(self)):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_PATH_OPEN(self, *args, **kwargs)
pathlib.Path.open = _path_open_guard

# ì°¨ë‹¨: ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì…¸ ì‹¤í–‰
def _blocked(*a, **k):
    raise PermissionError(</span><span class="sh">"</span><span class="s">Subprocess execution is disabled in sandbox</span><span class="sh">"</span><span class="s">)
subprocess.Popen = _blocked
subprocess.call = _blocked
subprocess.check_call = _blocked
subprocess.check_output = _blocked
os.system = lambda *a, **k: (_ for _ in ()).throw(PermissionError(</span><span class="sh">"</span><span class="s">os.system disabled</span><span class="sh">"</span><span class="s">))

# ë¦¬ì†ŒìŠ¤ ì œí•œ (ìœ ë‹‰ìŠ¤ë§Œ)
try:
    import resource
    resource.setrlimit(resource.RLIMIT_CPU, (3, 3))
    resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024, 1024*1024*1024))  # 1GB
except Exception:
    pass

print(</span><span class="sh">"</span><span class="s">[sandbox-guard] active:</span><span class="sh">"</span><span class="s">, SANDBOX_DIR)
</span><span class="sh">"""</span>

<span class="c1"># ========= ì„ë² ë””ë“œ ì»¤ë„ ì‹¤í–‰ê¸° =========
</span><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">stop_channels</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_ensure_guard</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># ìƒŒë“œë°•ìŠ¤ ë””ë ‰í„°ë¦¬ë¥¼ ì»¤ë„ í™˜ê²½ì— ì£¼ì…
</span>        <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">] = </span><span class="si">{</span><span class="n">SANDBOX_DIR</span><span class="si">!r}</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">KERNEL_GUARD_CODE</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_exec_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># ê°„ë‹¨í•œ ì •ì±… í•„í„°
</span>        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\bseaborn\b</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Do not use seaborn</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1"># ìƒŒë“œë°•ìŠ¤ ê°€ë“œ ë³´ì¥
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_guard</span><span class="p">()</span>

        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[];</span> <span class="n">arts</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_data</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">execute_result</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
                    <span class="kn">import</span> <span class="n">base64</span> <span class="k">as</span> <span class="n">_b64</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">_b64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">plot_</span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s">.png</span><span class="sh">"</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
                    <span class="n">arts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mime</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="n">arts</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">KernelPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">KernelSession</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KernelSession</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="n">POOL</span> <span class="o">=</span> <span class="nc">KernelPool</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\.subplot\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">subplots\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not use subplots</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">(color\s*=|palette\s*=|style\s*=)</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not set explicit colors or styles</span><span class="sh">"</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># ========= íŒŒì¼ íˆ´: copy_to_sandbox =========
</span><span class="k">def</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">source not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">dest_rel</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">dest_rel</span>
    <span class="c1"># ëª©ì ì§€ëŠ” ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ë¡œ ê°•ì œ
</span>    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">SANDBOX_DIR</span> <span class="ow">or</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">SANDBOX_DIR</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="c1"># ë””ë ‰í„°ë¦¬ ë³µì‚¬
</span>        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">destination exists: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># ì½ê¸°/ì“°ê¸° í—ˆìš© í¼ë¯¸ì…˜ (ì†Œìœ ì)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">rel</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">relpath</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">SANDBOX_DIR</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span> <span class="sh">"</span><span class="s">relative_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">rel</span><span class="p">}</span>

<span class="c1"># ========= OpenAI tools ì •ì˜ =========
</span><span class="n">python_exec_internal_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_exec_internal</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë‚´ë¶€ ë¶„ì„ìš© íŒŒì´ì¬ ì‹¤í–‰(ì‚¬ìš©ìì—ê² ì¶œë ¥ ìˆ¨ê¹€). ì„¸ì…˜ì€ session_idë¡œ ìœ ì§€.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_exec_visible_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì‚¬ìš©ì ê°€ì‹œ íŒŒì´ì¬ ì‹¤í–‰(ë‹¨ì¼ matplotlib í”Œë¡¯, ìƒ‰/ìŠ¤íƒ€ì¼ ì§€ì • ê¸ˆì§€).</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">copy_to_sandbox_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í˜¸ìŠ¤íŠ¸ì˜ ì„ì˜ ê²½ë¡œì—ì„œ íŒŒì¼/í´ë”ë¥¼ ìƒŒë“œë°•ìŠ¤ë¡œ ë³µì‚¬. ì“°ê¸° ê°€ëŠ¥í•œ ê²½ë¡œëŠ” ìƒŒë“œë°•ìŠ¤ë¿.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í˜¸ìŠ¤íŠ¸ì˜ ê¸°ì¡´ ê²½ë¡œ</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">dest_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ ìƒëŒ€ê²½ë¡œ</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_exec_internal_tool</span><span class="p">,</span> <span class="n">python_exec_visible_tool</span><span class="p">,</span> <span class="n">copy_to_sandbox_tool</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">run_tool_locally</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">dest_rel</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">session_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

<span class="c1"># ========= ëª¨ë¸ ë¼ìš´ë“œíŠ¸ë¦½ =========
</span><span class="k">def</span> <span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_msg</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">parallel_tool_calls</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_msg</span><span class="p">}]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">output</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">final_text</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">name</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">arguments</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_tool_locally</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">follow</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">messages</span> <span class="o">+</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}],</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
                <span class="n">parallel_tool_calls</span><span class="o">=</span><span class="bp">False</span>
            <span class="p">)</span>
            <span class="n">final_text</span> <span class="o">=</span> <span class="n">follow</span><span class="p">.</span><span class="n">output_text</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># ========= ì‹¤í–‰ ì˜ˆì‹œ =========
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì˜ˆì‹œ 0) ìƒŒë“œë°•ìŠ¤ì— íŒŒì¼ ë³µì‚¬</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">__file__</span>   <span class="c1"># í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒŒë“œë°•ìŠ¤ë¡œ ë³µì‚¬í•´ë³´ì
</span>    <span class="n">result</span> <span class="o">=</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="sh">"</span><span class="s">example/copied_script.py</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">ì˜ˆì‹œ 1) ë‚´ë¶€ìš© ì‹¤í–‰: sum(range(10))</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">msg1</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sum(range(10))ì„ ë‚´ë¶€ ì‹¤í–‰ê¸°ë¡œ ê³„ì‚°í•´ì„œ ê²°ê³¼ë§Œ ë§í•´ì¤˜.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">msg1</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="sh">"</span><span class="s">sess-1</span><span class="sh">"</span><span class="p">))</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">ì˜ˆì‹œ 2) ê°€ì‹œ ì‹¤í–‰: ê°„ë‹¨ í”Œë¡¯ ìƒì„± í›„ ì‚°ì¶œë¬¼ ê²½ë¡œ ì¶œë ¥</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
import matplotlib.pyplot as plt, os
x = [1,2,3,4]; y = [v*v for v in x]
plt.figure(); plt.plot(x,y); plt.title(</span><span class="sh">"</span><span class="s">y = x^2</span><span class="sh">"</span><span class="s">)
plt.savefig(os.path.join(os.environ.get(</span><span class="sh">"</span><span class="s">DATA_DIR</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">/mnt/data</span><span class="sh">"</span><span class="s">), </span><span class="sh">"</span><span class="s">curve.png</span><span class="sh">"</span><span class="s">))
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">'''</span>
    <span class="n">msg2</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">ì´ ì½”ë“œë¥¼ ê°€ì‹œ ì‹¤í–‰ê¸°ë¡œ ëŒë¦¬ê³  ì‚°ì¶œë¬¼ ê²½ë¡œë¥¼ ìš”ì•½í•´ì„œ ì•Œë ¤ì¤˜:</span><span class="se">\\</span><span class="s">n</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">msg2</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="sh">"</span><span class="s">sess-1</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸ë¥¼ ì§šì–´ë‘”ë‹¤.</p>

<ol>
  <li>
    <p>ì»¤ë„ ì§€ì†ì„± ìœ ì§€<br />
ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ jupyter_client.KernelManagerë¥¼ ì‚¬ìš©í•˜ë˜, ì„¸ì…˜ë§ˆë‹¤ ìƒŒë“œë°•ìŠ¤ ê°€ë“œë¥¼ í•œ ë²ˆë§Œ ì£¼ì…í•´ ìœ ì§€í•œë‹¤. íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì»¤ë„ì„ killí•˜ë©´ ìƒˆ ì»¤ë„ì—ì„œ ê°€ë“œë¥¼ ì¬ì£¼ì…í•œë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë“  ê²½ë¡œ ì½ê¸° í—ˆìš©, ì“°ê¸°ëŠ” ìƒŒë“œë°•ìŠ¤ë§Œ<br />
ì»¤ë„ ë‚´ë¶€ì—ì„œ open/os.open/pathlib.Path.open/rename/remove ë“± ì“°ê¸°ì„± ì‘ì—…ì„ ê°€ë“œí•œë‹¤. ì½”ë“œë¥¼ í†µí•œ ì„ì˜ì˜ íŒŒì¼ ì“°ê¸°ëŠ” ìƒŒë“œë°•ìŠ¤ ë°–ìœ¼ë¡œ ë‚˜ê°ˆ ìˆ˜ ì—†ë‹¤. copy_to_sandbox(source, dest_rel) íˆ´ì€ í˜¸ìŠ¤íŠ¸ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì•ˆì „ ê²€ì¦ í›„ ìƒŒë“œë°•ìŠ¤ì— ë³µì‚¬í•œë‹¤.</p>
  </li>
  <li>
    <p>temp.pyê°€ ìƒŒë“œë°•ìŠ¤ ë°–ì„ ë§Œì§€ì§€ ëª»í•œë‹¤ëŠ” ë³´ì¥<br />
ì†Œí”„íŠ¸ ê°€ë“œë§Œìœ¼ë¡œë„ ëŒ€ë¶€ë¶„ì˜ íŒŒì´ì¬ ë ˆë²¨ I/Oë¥¼ ë§‰ì§€ë§Œ, ì´ë¡ ì ìœ¼ë¡œ C í™•ì¥/ctypesë¡œ ìš°íšŒí•  ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ ë¦¬ëˆ…ìŠ¤ë¼ë©´ ì»¤ë„ ë ˆë²¨ í•˜ë“œ ê°€ë“œë¥¼ ì¶”ì²œí•œë‹¤.</p>
  </li>
</ol>

<p>í•˜ë“œ ê°€ë“œ ì˜µì…˜(Linux, ì„ íƒ ì‚¬í•­, ë„ì»¤/ì™¸ë¶€ í”„ë¡œê·¸ë¨ ë¶ˆí•„ìš”)<br />
Landlock LSM ë°”ì¸ë”©(pylandlock ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬)ì„ ì‚¬ìš©í•˜ë©´ í”„ë¡œì„¸ìŠ¤ê°€ ìŠ¤ìŠ¤ë¡œ â€œìƒŒë“œë°•ìŠ¤ ë°– ì“°ê¸° ê¸ˆì§€â€ ê·œì¹™ì„ ì»¤ë„ì— ë“±ë¡í•  ìˆ˜ ìˆë‹¤. ë£¨íŠ¸ ê¶Œí•œì´ í•„ìš” ì—†ê³ , í”„ë¡œì„¸ìŠ¤ ìì‹ ì—ê²Œë§Œ ì ìš©ëœë‹¤. ì ìš© ì§€ì ì€ KernelSession ìƒì„± ì§í›„ë‹¤.</p>

<p>ê°œë… ì½”ë“œ(ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ë¥¼ ë¬´ì‹œí•˜ê³  ì†Œí”„íŠ¸ ê°€ë“œë§Œ ì‚¬ìš©):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">apply_landlock_allow_write_only_to_sandbox</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">landlock</span>  <span class="c1"># ë˜ëŠ” pylandlock: ë°°í¬íŒì— ë”°ë¼ íŒ¨í‚¤ì§€ëª…ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
</span>        <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span><span class="p">,</span> <span class="n">AccessFs</span><span class="p">,</span> <span class="n">PathBeneath</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>
        <span class="c1"># ê¸°ë³¸ì€ ì•„ë¬´ ì“°ê¸°ë„ ë¶ˆê°€, ìƒŒë“œë°•ìŠ¤ë§Œ ì“°ê¸° í—ˆìš©
</span>        <span class="n">write_perms</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_FROM</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_TO</span>
        <span class="p">)</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">add_rule</span><span class="p">(</span><span class="nc">PathBeneath</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">write_perms</span><span class="p">))</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">restrict_self</span><span class="p">()</span>  <span class="c1"># ì—¬ê¸°ì„œë¶€í„° í˜„ì¬ í”„ë¡œì„¸ìŠ¤ëŠ” ìƒŒë“œë°•ìŠ¤ ë°– ì“°ê¸° ë¶ˆê°€
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[landlock] active</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[landlock] not available:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<p>ì´ í•¨ìˆ˜ëŠ” KernelManagerê°€ ë„ìš°ëŠ” ì»¤ë„ í”„ë¡œì„¸ìŠ¤ ì•ˆì´ ì•„ë‹ˆë¼, ë„¤ ëŸ°ë„ˆ í”„ë¡œì„¸ìŠ¤ì— ì ìš©í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼ëŠ” ì ì„ ìŠì§€ ë§ê³ , ì»¤ë„ í”„ë¡œì„¸ìŠ¤ì— ì ìš©í•˜ë ¤ë©´ ì»¤ë„ ì‹œì‘ í›„ ì²« ì…€ë¡œ Landlock ì ìš© ì½”ë“œë¥¼ ì£¼ì…í•´ì•¼ í•œë‹¤. ìœ„ KERNEL_GUARD_CODE ìƒë‹¨ì— Landlock ì ìš© ì½”ë“œë¥¼ ë„£ê³ , ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰í•˜ë„ë¡ êµ¬ì„±í•˜ë©´ ëœë‹¤. ì»¤ë„ ë²„ì „ì´ 5.13+ ì´ì–´ì•¼ í•œë‹¤.</p>

<p>ì¶”ê°€ í•˜ë“œë‹ ì•„ì´ë””ì–´<br />
seccomp(pylibseccomp)ë¡œ socket/subprocess ê´€ë ¨ ì‹œìŠ¤í…œì½œ ìì²´ë¥¼ ì°¨ë‹¨í•´ ë„¤íŠ¸ì›Œí¬/ì…¸ì„ ë¬´ë ¥í™”í•  ìˆ˜ ìˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ì´ í•„ìš”í•˜ë©´ ì´ê±¸ ë³‘í–‰í•˜ì.</p>

<p>ì£¼ì˜ì <br />
ì½ê¸°ë¥¼ ì–´ë””ë“  í—ˆìš©í•˜ë©´ ë¯¼ê°í•œ í‚¤/í† í° íŒŒì¼(ì˜ˆ: ~/.ssh, .env)ë„ ì½í ìˆ˜ ìˆë‹¤. ìš´ì˜ ì‹œì—” copy_to_sandboxë¡œ ì½ê¸° í—ˆìš© ëª©ë¡ì„ ì¢íˆê±°ë‚˜, ê°€ë“œ ì½”ë“œì— â€œì½ê¸° í—ˆìš© ê²½ë¡œ allowlistâ€ë¥¼ ì¶”ê°€í•˜ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.</p>

<p>ì´ì œ ë„¤ ìŠ¤íƒ(vLLM + Qwen/GPTOSS + OpenAI Agents SDK)ì— ê·¸ëŒ€ë¡œ ì ‘ëª©í•˜ë©´ ëœë‹¤. ëª¨ë¸ì—ê²ŒëŠ” ë‹¤ìŒ ì„¸ ê°€ì§€ íˆ´ì„ ë…¸ì¶œí•œë‹¤.</p>

<ol>
  <li>
    <p>copy_to_sandbox(source, dest_rel?)</p>
  </li>
  <li>
    <p>python_exec_internal(session_id, code, â€¦)</p>
  </li>
  <li>
    <p>python_exec_visible(session_id, code, â€¦)</p>
  </li>
</ol>

<p>ì‹¤í–‰ ë™ì„ ì€ ê°„ë‹¨í•˜ë‹¤. ëª¨ë¸ì´ íŒŒì¼ì´ í•„ìš”í•˜ë©´ copy_to_sandboxë¥¼ ë¨¼ì € ë¶€ë¥´ê³ , ê·¸ ë‹¤ìŒ ì‹¤í–‰ íˆ´ë¡œ ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ ê²½ë¡œë§Œ ì“°ê²Œ ëœë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì»¤ë„ì„ ìœ ì§€í•˜ë©´ì„œë„ íŒŒì¼ ì•ˆì „ì„±ì´ ë³´ì¥ëœë‹¤.</p>

<p>ì›í•˜ë©´ Landlock ì£¼ì…ê¹Œì§€ í¬í•¨í•œ ë²„ì „ìœ¼ë¡œ ë¦¬íŒ©í„°ë§í•´ ì¤„ê²Œ.</p>

<p class="chat--user">

ì´ëŸ° ì¼ì„ í•˜ëŠ” íŒŒì´ì¬ íŒ¨í‚¤ì§€ê°€ ìˆì„ ë²• í•œë° ì°¾ì•„ë³´ê³  ì•Œë ¤ì£¼ë¼

</p>

<p>ì§§ì€ ê²°ë¡ ë¶€í„° ë§í• ê²Œ. ìˆœìˆ˜ íŒŒì´ì¬ë§Œìœ¼ë¡œ â€œì§„ì§œâ€ ì•ˆì „í•œ ìƒŒë“œë°•ìŠ¤ë¥¼ ë§Œë“œëŠ” ê±´ ì—¬ëŸ¬ ì°¨ë¡€ ì‹¤íŒ¨í–ˆê³ , í˜„ì¬ë„ ê¶Œì¥ë˜ì§€ ì•ŠëŠ”ë‹¤. ëŒ€ì‹  ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ê¸°ëŠ¥ì„ ë…¸ì¶œí•œ íŒŒì´ì¬ íŒ¨í‚¤ì§€ë¥¼ ì¡°í•©í•˜ë©´ ë„ì»¤ ì—†ì´ë„ â€œìƒŒë“œë°•ìŠ¤ ë°– ì“°ê¸° ê¸ˆì§€â€ë¥¼ ê½¤ ë‹¨ë‹¨í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤. ëŒ€í‘œ ì¡°í•©ì€ Landlock(+ì„ íƒì ìœ¼ë¡œ seccomp)ì´ë‹¤. <a href="https://lwn.net/Articles/574323/?utm_source=chatgpt.com">LWN.net</a></p>

<p>ë‹¤ìŒì´ ì§€ê¸ˆ ëª©ì (ì»¤ë„ ìœ ì§€, ì–´ë””ë“  ì½ê¸° ê°€ëŠ¥Â·ì“°ê¸°ë§Œ ìƒŒë“œë°•ìŠ¤)ê³¼ ì˜ ë§ëŠ” íŒ¨í‚¤ì§€ë“¤ì´ì•¼.</p>

<ol>
  <li>ì»¤ë„ ë ˆë²¨ ê²©ë¦¬(ë„ì»¤ ì—†ì´ ê°•ë ¥Â·ê¶Œì¥)</li>
</ol>

<ul>
  <li>
    <p>landlock: ë¦¬ëˆ…ìŠ¤ 5.13+ì—ì„œ í”„ë¡œì„¸ìŠ¤ê°€ â€œì´ ë””ë ‰í„°ë¦¬ë§Œ ì“°ê¸° í—ˆìš©â€ ê°™ì€ ê·œì¹™ì„ ìŠ¤ìŠ¤ë¡œ ê±¸ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” LSM ë°”ì¸ë”©. í•œ ì¤„ ìš”ì•½: ì»¤ë„ì´ íŒŒì¼ ì“°ê¸°ë¥¼ ì°¨ë‹¨í•˜ë¯€ë¡œ temp.pyê°€ ë°–ìœ¼ë¡œ ë‚˜ê°€ì„œ write/rename/deleteë¥¼ í•˜ë ¤ í•´ë„ ê±°ê¸°ì„œ ë§‰íŒë‹¤. ì„¸ì…˜ ì»¤ë„ì„ ìœ ì§€í•œ ì±„, ì»¤ë„ ì‹œì‘ ì§í›„ ê·œì¹™ì„ ì ìš©í•˜ë©´ ëœë‹¤. <a href="https://pypi.org/project/landlock/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
  <li>
    <p>pyseccomp / python3-seccomp: libseccomp ë°”ì¸ë”©. execve/fork/socket ê°™ì€ ì‹œìŠ¤í…œì½œì„ ë§‰ì•„ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ ë“± â€œíƒˆì¶œ ë£¨íŠ¸â€ë¥¼ ì¶”ê°€ë¡œ ë´‰ì‡„í•  ìˆ˜ ìˆë‹¤. Landlockê³¼ ë³‘í–‰í•˜ë©´ íš¨ê³¼ê°€ ì¢‹ë‹¤. <a href="https://pypi.org/project/pyseccomp/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
</ul>

<ol>
  <li>ìš´ì˜ì²´ì œ í”„ë¡œíŒŒì¼ ê¸°ë°˜(í™˜ê²½ ì˜ì¡´Â·ì„¤ì • í•„ìš”)</li>
</ol>

<ul>
  <li>edx-codejail: â€œíŒŒì´ì¬ ì½”ë“œ ê°ì˜¥â€ì„ ê´€ë¦¬í•˜ëŠ” íŒ¨í‚¤ì§€. ë³´ì•ˆì€ AppArmor í”„ë¡œíŒŒì¼ë¡œ ê°•ì œí•œë‹¤. ì¦‰ íŒ¨í‚¤ì§€ëŠ” íŒŒì´ì¬ì´ì§€ë§Œ, ì»¤ë„ì˜ AppArmor ì„¤ì •ì´ ì œëŒ€ë¡œ ìˆì–´ì•¼ ë³´í˜¸ê°€ ëœë‹¤. ë„ì»¤ëŠ” í•„ìš” ì—†ì§€ë§Œ ì‹œìŠ¤í…œ ì„¤ì •ì€ í•„ìš”. <a href="https://pypi.org/project/edx-codejail/?utm_source=chatgpt.com">PyPI</a></li>
</ul>

<ol>
  <li>ëŒ€ì•ˆ ëŸ°íƒ€ì„(ì•„í‚¤í…ì²˜ë¥¼ ë°”ê¿”ì„œ ìƒŒë“œë°•ìŠ¤)</li>
</ol>

<ul>
  <li>WebAssembly ëŸ°íƒ€ì„ì„ íŒŒì´ì¬ì—ì„œ ì§ì ‘ ì“°ê¸°: wasmer-python/wasmtime-pyë¡œ WASI í™˜ê²½ì—ì„œ CPython/py2wasm ë“±ì„ ëŒë¦¬ë©´ ê¸°ë³¸ì´ â€œí—ˆìš© ì•ˆ í•¨â€ì´ë¼ íŒŒì¼Â·ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ì´ ëª…ì‹œì ìœ¼ë¡œ ì—´ì–´ì£¼ê¸° ì „ê¹Œì§€ ë§‰íŒë‹¤. ì„¸ì…˜í˜• ìœ ì§€ë„ êµ¬í˜„ ê°€ëŠ¥. ë‹¤ë§Œ ë„¤ì´í‹°ë¸Œ í™•ì¥ ëª¨ë“ˆ(ì˜ˆ: numpy) í˜¸í™˜ì„±ì€ ì „ëµì´ í•„ìš”í•˜ë‹¤. <a href="https://github.com/wasmerio/wasmer-python?utm_source=chatgpt.com">GitHub</a></li>
</ul>

<p>ë³´ì¡°(ë‹¨ë… ì‚¬ìš© ë¹„ê¶Œì¥, í•˜ì§€ë§Œ ë ˆì´ì–´ë¡œ ìœ ìš©)</p>

<ul>
  <li>
    <p>RestrictedPython: ì–¸ì–´ ê¸°ëŠ¥ì„ ì œí•œí•˜ëŠ” ë„êµ¬(ë¬¸ë²•/ë°”ì´íŠ¸ì½”ë“œ ë ˆë²¨)ë¼ OS íŒŒì¼ ì‹œìŠ¤í…œì„ ê°€ë‘ëŠ” ê±´ ì•„ë‹ˆë‹¤. Landlock/seccomp ìœ„ì—ì„œ â€œì¶”ê°€ ìš¸íƒ€ë¦¬â€ë¡œ ì“°ë©´ ì¢‹ë‹¤. <a href="https://restrictedpython.readthedocs.io/?utm_source=chatgpt.com">restrictedpython.readthedocs.io</a></p>
  </li>
  <li>
    <p>pyfakefs: í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ íŒŒì¼ì‹œìŠ¤í…œ. ì‹¤ì œ ë””ìŠ¤í¬ë¥¼ ë§Œì§€ì§€ ì•Šê²Œ ë§Œë“¤ ìˆ˜ ìˆì§€ë§Œ â€œë³´ì•ˆ ê²©ë¦¬â€ëŠ” ì•„ë‹ˆë‹¤. ì£¼ ëª©ì ì€ íšŒê·€ ë°©ì§€/í…ŒìŠ¤íŠ¸ ì•ˆì •ì„±.</p>
  </li>
</ul>

<p>ì¶”ì²œ ì„¤ê³„(ë„ˆì˜ ì»¤ë„ ìœ ì§€ êµ¬ì¡°ì— ë°”ë¡œ ì–¹ê¸°)</p>

<ol>
  <li>
    <p>ì»¤ë„ ì‹œì‘ ì§í›„ ì²« ì…€ì—ì„œ Landlockì„ ì ìš©í•´ â€œSANDBOX_DIRë§Œ ì“°ê¸° í—ˆìš©â€ ê·œì¹™ì„ ê±´ë‹¤.</p>
  </li>
  <li>
    <p>seccompë¡œ execve/fork/socket ë“±ì„ ë§‰ëŠ”ë‹¤(ì„ íƒ).</p>
  </li>
  <li>
    <p>LLMì´ ì™¸ë¶€ íŒŒì¼ì„ ì“°ê³  ì‹¶ë‹¤ë©´ ë°˜ë“œì‹œ copy_to_sandbox(source, dest_rel) íˆ´ì„ í˜¸ì¶œí•˜ë„ë¡ ì—ì´ì „íŠ¸ ì •ì±…ì„ ê°•ì œí•œë‹¤.</p>
  </li>
  <li>
    <p>íŒŒì´ì¬ ë‹¨ì˜ ëª½í‚¤íŒ¨ì¹˜(open/rename/remove ë“±)ëŠ” ì—¬ì „íˆ ìœ ìš©í•œ ì†Œí”„íŠ¸ ê°€ë“œì§€ë§Œ, ì§„ì§œ ë°©ì–´ì„ ì€ ì»¤ë„(Landlock/seccomp)ì´ ë§¡ëŠ”ë‹¤.</p>
  </li>
</ol>

<p>Landlock ê°„ë‹¨ ì˜ˆì‹œ(ì•„ì´ë””ì–´ ìŠ¤ì¼€ì¹˜)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install landlock  (ë¦¬ëˆ…ìŠ¤ 5.13+ í•„ìš”)
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span><span class="p">,</span> <span class="n">AccessFs</span><span class="p">,</span> <span class="n">PathBeneath</span>

<span class="n">SANDBOX_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 1) ê·œì¹™ ëª¨ìŒ ìƒì„±: ê¸°ë³¸ì€ ì“°ê¸° ë¶ˆê°€, íŠ¹ì • ë””ë ‰í„°ë¦¬ë§Œ ì“°ê¸° í—ˆìš©
</span><span class="n">rules</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>
<span class="n">write_perms</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_FROM</span> <span class="o">|</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_TO</span>
<span class="p">)</span>
<span class="n">rules</span><span class="p">.</span><span class="nf">add_rule</span><span class="p">(</span><span class="nc">PathBeneath</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">write_perms</span><span class="p">))</span>

<span class="c1"># 2) í˜„ì¬ í”„ë¡œì„¸ìŠ¤(= ë„¤ê°€ ìœ ì§€í•˜ëŠ” Jupyter ì»¤ë„)ì— ì ìš©
</span><span class="n">rules</span><span class="p">.</span><span class="nf">restrict_self</span><span class="p">()</span>

<span class="c1"># ì´ì œë¶€í„° ì´ í”„ë¡œì„¸ìŠ¤ì™€ ìì‹ì€ SANDBOX_DIR ë°–ìœ¼ë¡œì˜ ì“°ê¸°ê°€ ì»¤ë„ì—ì„œ ê±°ë¶€ë¨
</span></code></pre></div></div>

<p>ì°¸ê³ ë¡œ execve/fork/socketë„ ë§‰ê³  ì‹¶ë‹¤ë©´, ì»¤ë„ ì‹œì‘ ì§í›„ seccomp í•„í„°ë¥¼ ê°™ì´ ë¡œë“œí•˜ë©´ ëœë‹¤(ì˜ˆ: execve/execveat/fork/vfork/sys_socket ì°¨ë‹¨). <a href="https://pypi.org/project/pyseccomp/?utm_source=chatgpt.com">PyPI</a></p>

<p>ì •ë¦¬í•˜ë©´ ì´ë ‡ê²Œ ê³¨ë¼ ì“°ë©´ ëœë‹¤.</p>

<ul>
  <li>
    <p>â€œë„ì»¤ ì—†ì´, íŒŒì¼ ì“°ê¸°ë§Œ ìƒŒë“œë°•ìŠ¤ë¡œâ€: landlock í•„ìˆ˜, í•„ìš” ì‹œ seccomp ì¶”ê°€. <a href="https://pypi.org/project/landlock/?utm_source=chatgpt.com">PyPI+1</a></p>
  </li>
  <li>
    <p>â€œì‹œìŠ¤í…œ í”„ë¡œíŒŒì¼ì„ ì¨ë„ ê´œì°®ë‹¤â€: codejail(AppArmor)ë¡œ ê´€ë¦¬. <a href="https://pypi.org/project/edx-codejail/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
  <li>
    <p>â€œì•„ì˜ˆ ë‹¤ë¥¸ ëŸ°íƒ€ì„ì— ê°€ë‘”ë‹¤â€: wasmer-python/wasmtime-py ê¸°ë°˜ WASM ìƒŒë“œë°•ìŠ¤. <a href="https://github.com/wasmerio/wasmer-python?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p>â€œìˆœìˆ˜ íŒŒì´ì¬ ìƒŒë“œë°•ìŠ¤ë§Œìœ¼ë¡œëŠ” ìœ„í—˜â€: ê³¼ê±° ì‹œë„ê°€ â€˜ì„¤ê³„ìƒ ì·¨ì•½â€™ìœ¼ë¡œ ê²°ë¡  ë‚¬ë‹¤. ì»¤ë„/ëŸ°íƒ€ì„ ë ˆë²¨ ë°©ì–´ë¥¼ ë°˜ë“œì‹œ ê³ë“¤ì—¬ë¼. <a href="https://lwn.net/Articles/574323/?utm_source=chatgpt.com">LWN.net</a></p>
  </li>
</ul>

<p>ì›í•˜ë©´ ë„¤ê°€ ì–´ì œ ì£¼ì‹  ì»¤ë„-ì„¸ì…˜ êµ¬ì¡°ì— Landlock+seccompë¥¼ ì •í™•íˆ ì£¼ì…í•œ ë²„ì „(íˆ´ í˜¸ì¶œê³¼ ì—°ë™ê¹Œì§€)ë¡œ ë¦¬ë¼ì´íŒ…í•´ì„œ ì „ë‹¬í•˜ê² ë‹¤.</p>

<p class="chat--user">

ê·¸ë ‡ê²Œ ê¹Œì§€ ì™„ë²½í•œ ìƒŒë“œë°•ìŠ¤ëŠ” í•„ìš”ì—†ì–´

</p>

<p>ì¢‹ì•„. â€œì™„ë²½í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ”â€ í˜„ì‹¤ì  80/20 í•´ë²•ìœ¼ë¡œ ì •ë¦¬í•´ ì¤„ê²Œ. í•µì‹¬ì€ ì»¤ë„ì€ ê³„ì† ìœ ì§€í•˜ë©´ì„œ, ì‹¤ìˆ˜ë¡œ í˜¸ìŠ¤íŠ¸ë¥¼ ë”ëŸ½íˆëŠ” ê±¸ ë§‰ëŠ” 3ì¤‘ ì™„ì¶©ì¥ì¹˜ë‹¤.</p>

<ol>
  <li>
    <p>ì»¤ë„ ì‹œì‘ ì§í›„ í•œ ë²ˆë§Œ ì£¼ì…í•˜ëŠ” audit hookìœ¼ë¡œ ì“°ê¸°/ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ë„¤íŠ¸ì›Œí¬ë¥¼ ê°€ë³ê²Œ ì°¨ë‹¨</p>
  </li>
  <li>
    <p>í•„ìš”í•œ íŒŒì¼ì€ copy_to_sandbox(source, dest_rel)ë¡œ ë³µì‚¬í•´ ìƒŒë“œë°•ìŠ¤ ì•ˆì—ì„œë§Œ ë‹¤ë£¸</p>
  </li>
  <li>
    <p>CPU/ë©”ëª¨ë¦¬/íŒŒì¼ì‚¬ì´ì¦ˆ ê°™ì€ ë¦¬ì†ŒìŠ¤ ì œí•œìœ¼ë¡œ í­ì£¼ ë°©ì§€</p>
  </li>
</ol>

<p>ì´ ì¡°í•©ì€ â€œê°•ì²  ê°ì˜¥â€ì€ ì•„ë‹ˆì§€ë§Œ, ì‹¤ë¬´ì—ì„œ ë°œìƒí•˜ëŠ” ëŒ€ë¶€ë¶„ì˜ ì‹¤ìˆ˜ì„± íŒŒê´´ë¥¼ í™•ì‹¤íˆ ê±¸ëŸ¬ì¤€ë‹¤. ê·¸ë¦¬ê³  ë„ì»¤ë„ í•„ìš” ì—†ë‹¤.</p>

<p>ì•„ë˜ëŠ” ë„¤ê°€ ì¤€ ì»¤ë„-ì„¸ì…˜ ì½”ë“œì— ë”± í•„ìš”í•œ ë§Œí¼ë§Œ ì¶”ê°€/êµì²´í•˜ëŠ” ìŠ¤ë‹ˆí«ì´ë‹¤.</p>

<ol>
  <li>ì»¤ë„ì— ì£¼ì…í•  ê°€ë²¼ìš´ ê°€ë“œ ì½”ë“œ(sys.addaudithook ê¸°ë°˜)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì»¤ë„ì— ì¸ì ì…˜í•  ì½”ë“œ: AUDIT_GUARD_CODE
</span><span class="n">AUDIT_GUARD_CODE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys
SANDBOX_DIR = os.path.realpath(os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">))
os.makedirs(SANDBOX_DIR, exist_ok=True)

def _in_sb(p):
    rp = os.path.realpath(p)
    return rp == SANDBOX_DIR or rp.startswith(SANDBOX_DIR + os.sep)

def _audit(event, args):
    # íŒŒì¼ ì“°ê¸° ì‹œë„ ì°¨ë‹¨: open ë° os.openì€ </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s"> ì´ë²¤íŠ¸ë¡œ ë“¤ì–´ì˜´
    if event == </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">:
        path = str(args[0])
        mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="s">
        flags = int(args[2]) if len(args) &gt; 2 else 0
        write_intent = any(ch in mode for ch in (</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="s">)) or (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
        if write_intent and not _in_sb(path):
            raise PermissionError(f</span><span class="sh">'</span><span class="s">Writes are restricted to {SANDBOX_DIR}: {path}</span><span class="sh">'</span><span class="s">)
    # ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì…¸ ì°¨ë‹¨
    elif event.startswith(</span><span class="sh">'</span><span class="s">subprocess.</span><span class="sh">'</span><span class="s">):
        raise PermissionError(</span><span class="sh">'</span><span class="s">Subprocess disabled in this session</span><span class="sh">'</span><span class="s">)
    elif event == </span><span class="sh">'</span><span class="s">os.system</span><span class="sh">'</span><span class="s">:
        raise PermissionError(</span><span class="sh">'</span><span class="s">os.system disabled in this session</span><span class="sh">'</span><span class="s">)
    # ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨(ì›í•˜ë©´ ì£¼ì„ í•´ì œ)
    elif event.startswith(</span><span class="sh">'</span><span class="s">socket.</span><span class="sh">'</span><span class="s">):
        raise PermissionError(</span><span class="sh">'</span><span class="s">Network disabled in this session</span><span class="sh">'</span><span class="s">)

sys.addaudithook(_audit)

# ê°€ë²¼ìš´ í•œë„ ì„¤ì •(ìœ ë‹‰ìŠ¤ ê³„ì—´ì—ì„œë§Œ ì‘ë™)
try:
    import resource
    resource.setrlimit(resource.RLIMIT_CPU, (3, 3))             # CPU 3ì´ˆ
    resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024,)*2) # 1GB ë©”ëª¨ë¦¬
    resource.setrlimit(resource.RLIMIT_FSIZE, (200*1024*1024,)*2) # íŒŒì¼ ìµœëŒ€ 200MB
    resource.setrlimit(resource.RLIMIT_NOFILE, (256, 256))
except Exception:
    pass

print(</span><span class="sh">'</span><span class="s">[audit-guard] active for sandbox:</span><span class="sh">'</span><span class="s">, SANDBOX_DIR)
</span><span class="sh">"""</span>
</code></pre></div></div>

<ol>
  <li>KernelSessionì— ê°€ë“œ ì£¼ì… í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ë„ë¡ ë³´ê°•</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_ensure_guard</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">] = </span><span class="si">{</span><span class="n">SANDBOX_DIR</span><span class="si">!r}</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">AUDIT_GUARD_CODE</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<ol>
  <li>copy_to_sandbox(source, dest_rel) íˆ´(ê°„ê²°íŒ)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">source not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dest_rel</span> <span class="k">else</span> <span class="n">dest_rel</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">SANDBOX_DIR</span> <span class="ow">or</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">SANDBOX_DIR</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">destination exists: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>ì‹¤í–‰ê¸°ì—ì„œ ê°€ë“œ ë³´ì¥ í›„ ì½”ë“œ ìˆ˜í–‰</li>
</ol>

<p>ë„¤ê°€ ì´ë¯¸ ê°€ì§„ <code class="language-plaintext highlighter-rouge">KernelSession.execute()</code> ì•ë¶€ë¶„ì— <code class="language-plaintext highlighter-rouge">_ensure_guard()</code> í•œ ì¤„ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_guard</span><span class="p">()</span>  <span class="c1"># ê°€ë“œê°€ ì£¼ì…ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì§€ê¸ˆ ì£¼ì…
</span>    <span class="c1"># ì´í•˜ ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ
</span></code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ ë‹¤ìŒì´ ìì—°ìŠ¤ëŸ½ê²Œ ì¶©ì¡±ëœë‹¤.</p>

<ul>
  <li>
    <p>ì–´ë””ë“  ì½ê¸° ê°€ëŠ¥</p>
  </li>
  <li>
    <p>ì“°ê¸°ëŠ” ìƒŒë“œë°•ìŠ¤ ë””ë ‰í† ë¦¬ ì•ˆì—ì„œë§Œ ê°€ëŠ¥</p>
  </li>
  <li>
    <p>temp.py ê°™ì€ ì„ì˜ ì½”ë“œê°€ /etc, ~, /var ë“±ì— ì“°ë ¤ê³  í•˜ë©´ audit hookì—ì„œ ì¦‰ì‹œ PermissionError</p>
  </li>
  <li>
    <p>ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ë„¤íŠ¸ì›Œí¬ëŠ” ê¸°ë³¸ ì°¨ë‹¨(ì˜µì…˜)</p>
  </li>
  <li>
    <p>ì»¤ë„ì€ ì„¸ì…˜ ë‹¨ìœ„ë¡œ ê³„ì† ìœ ì§€</p>
  </li>
</ul>

<p>ìš´ì˜ íŒ ëª‡ ê°€ì§€ë§Œ ë§ë¶™ì¸ë‹¤.</p>

<ul>
  <li>
    <p>ë¯¼ê° ê²½ë¡œ ì½ê¸°ê¹Œì§€ í—ˆìš©í•˜ë©´ ì˜ë„ì¹˜ ì•Šê²Œ ë¹„ë°€ í† í°ì„ ì½ì„ ìˆ˜ ìˆë‹¤. í•„ìš”í•˜ë©´ audit hookì—ì„œ ì½ê¸° í—ˆìš© ê²½ë¡œë„ allowlistë¡œ ì¢í˜€ë¼.</p>
  </li>
  <li>
    <p>Windowsì—ì„œëŠ” resource ì œí•œì´ ì œí•œì ì´ë‹¤. ê·¸ë˜ë„ audit hookì€ ë™ì‘í•˜ë‹ˆ íŒŒì¼ ì“°ê¸°/ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì°¨ë‹¨ì—” ìœ ìš©í•˜ë‹¤.</p>
  </li>
  <li>
    <p>CPython 3.8+ì—ì„œ audit hookì´ ì§€ì›ëœë‹¤. ê·¸ ì•„ë˜ ë²„ì „ì€ ì´ ë°©ì‹ì´ ì•ˆ ëœë‹¤.</p>
  </li>
  <li>
    <p>numpy/pandas/matplotlib ê°™ì€ ì¼ë°˜ ê³¼í•™ ìŠ¤íƒì€ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤. ë„¤ê°€ ì¡ì•„ ë‘” â€œë‹¨ì¼ í”Œë¡¯Â·ìƒ‰ìƒ ì§€ì • ê¸ˆì§€â€ ì •ì±…ì€ ê¸°ì¡´ ê²€ì‚¬ë¡œ ìœ ì§€í•˜ë©´ ëœë‹¤.</p>
  </li>
</ul>

<p>ì´ ì •ë„ë©´ â€œì™„ë²½í•œ ê°ì˜¥â€ì€ ì•„ë‹ˆì§€ë§Œ, ì‹¤ë¬´ì—ì„œ ì‹¤ìˆ˜ì„± íŒŒê´´ë¥¼ ê±°ì˜ ì—†ì• ë©´ì„œ ì»¤ë„ ì§€ì†ì„±ê³¼ ê°œë°œ í¸ì˜ì„±ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ê°ˆ ìˆ˜ ìˆë‹¤. ë‹¤ìŒìœ¼ë¡œ vLLM + Agents SDKì— ë…¸ì¶œí•  íˆ´ ìŠ¤í™ì„ ì •ë¦¬í•´ì£¼ê¸¸ ì›í•˜ë©´ ê·¸ ë¶€ë¶„ë„ ë°”ë¡œ ì´ì–´ì„œ ë§Œë“¤ì–´ ì¤„ê²Œ.</p>

<p class="chat--user">

landlockì„ ì½ê¸° ê°€ëŠ¥ í´ë” ë”°ë¡œ ì“°ê¸° ê°€ëŠ¥ í´ë” ë”°ë¡œ ì§€ì •ê°€ëŠ¥í•´?

</p>

<p>ê°€ëŠ¥í•´. LandlockëŠ” â€œê²½ë¡œë³„ ê¶Œí•œ ë¹„íŠ¸ë§ˆìŠ¤í¬â€ë¥¼ ì¤˜ì„œ ì½ê¸° ì „ìš© ë””ë ‰í„°ë¦¬ì™€ ì“°ê¸° í—ˆìš© ë””ë ‰í„°ë¦¬ë¥¼ ê°ê° ë”°ë¡œ ì§€ì •í•  ìˆ˜ ìˆì–´. ë°©ë²•ì˜ ë¼ˆëŒ€ëŠ” ì´ë ‡ë‹¤.</p>

<ol>
  <li>
    <p>rulesetì„ ë§Œë“¤ ë•Œ ì½ê¸°ì™€ ì“°ê¸°ì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  ê¶Œí•œì„ handled_access_fsì— í¬í•¨í•œë‹¤. ì˜ˆì‹œë¡œ ë¬¸ì„œì— ë‚˜ì˜¤ëŠ” READ_FILE, READ_DIR, WRITE_FILE, MAKE__(íŒŒì¼/ë””ë ‰í„°ë¦¬ ìƒì„±), REMOVE__(ì‚­ì œ), TRUNCATE(ABI v3+), REFER(ë””ë ‰í„°ë¦¬ ê°„ ì´ë™/ë§í¬, ABI v2+) ë“±ì„ ë¬¶ëŠ”ë‹¤. ì´ë ‡ê²Œ í•´ì•¼ â€œëª…ì‹œí•œ ê¶Œí•œë§Œ í—ˆìš©, ë‚˜ë¨¸ì§€ëŠ” ê±°ë¶€â€ê°€ ì œëŒ€ë¡œ ì‘ë™í•œë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ</a></p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>ì½ê¸° ì „ìš© ë””ë ‰í„°ë¦¬ ê·œì¹™ì„ ì¶”ê°€í•œë‹¤. í•´ë‹¹ ê²½ë¡œì— ëŒ€í•´ allowed_accessë¥¼ READ_FILE</td>
          <td>READ_DIR(í•„ìš”í•˜ë©´ EXECUTE) ì •ë„ë§Œ ì£¼ëŠ” PathBeneath ê·œì¹™ì„ rulesetì— ë„£ëŠ”ë‹¤. ì»¤ë„ ë¬¸ì„œ ì˜ˆì œë„ /usrë¥¼ ì´ëŸ° ì‹ìœ¼ë¡œ â€œì½ê¸°ë§Œ í—ˆìš©â€ìœ¼ë¡œ ì¶”ê°€í•œë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ+1</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>ì“°ê¸° í—ˆìš© ë””ë ‰í„°ë¦¬ ê·œì¹™ì„ ë³„ë„ë¡œ ì¶”ê°€í•œë‹¤. ë³´í†µì€ READ_DIR(ê²½ë¡œ íƒìƒ‰/ëª©ë¡), WRITE_FILE, MAKE_REG/MAKE_DIR, REMOVE_FILE/REMOVE_DIR, TRUNCATE(ABI v3+)ë¥¼ ë¬¶ê³ , ë””ë ‰í„°ë¦¬ ê°„ rename/linkê°€ í•„ìš”í•˜ë©´ REFER(ABI v2+)ê¹Œì§€ í¬í•¨í•œë‹¤. ê·¸ëŸ° ë‹¤ìŒ landlock_restrict_selfë¡œ í˜„ì¬ ìŠ¤ë ˆë“œ(â†’ ìì‹ í”„ë¡œì„¸ìŠ¤ í¬í•¨)ì— ì ìš©í•œë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ+1</a></li>
</ol>

<p>íŒê³¼ ì£¼ì˜ì </p>

<ul>
  <li>
    <p>â€œì§„ì§œâ€ ì˜ë¯¸ì˜ write-only ë””ë ‰í„°ë¦¬ë¥¼ ë§Œë“¤ê³  ì‹¶ë”ë¼ë„, íŒŒì¼ì„ ë§Œë“¤ê±°ë‚˜ ì—´ë ¤ë©´ ìµœì†Œí•œ ë””ë ‰í„°ë¦¬ íƒìƒ‰ì„ ìœ„í•œ READ_DIR ê¶Œí•œì´ í•„ìš”í•´ì§€ëŠ” ê²½ìš°ê°€ ë§ë‹¤. ì»¤ë„ ë¬¸ì„œë„ ì‹¤ì „ì—ì„œëŠ” ì½ê¸°/ì“°ê¸° ê¶Œí•œì„ ë””ë ‰í„°ë¦¬ ë‹¨ìœ„ë¡œ ê¹¨ë—í•˜ê²Œ ë¶„ë¦¬í•´ ë‘ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤(ì˜ˆ: ~/docì€ read-only, ~/tmpëŠ” read-write). <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ</a></p>
  </li>
  <li>
    <p>TRUNCATEëŠ” ABI v3(ë¦¬ëˆ…ìŠ¤ 6.2)ë¶€í„° ì œì–´ ê°€ëŠ¥, REFERëŠ” ABI v2(ë¦¬ëˆ…ìŠ¤ 5.19)ë¶€í„°. ì‹¤í–‰ í™˜ê²½ì˜ Landlock ABI ë²„ì „ì„ ì¡°íšŒí•´ ê°€ìš© ê¶Œí•œë§Œ ì“°ë„ë¡ í•˜ëŠ” â€œë² ìŠ¤íŠ¸ ì—í¬íŠ¸â€ íŒ¨í„´ì´ ê³µì‹ ì˜ˆì œì— ìˆë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ+1</a></p>
  </li>
  <li>
    <p>íŒŒì´ì¬ì—ì„œ ì“°ë ¤ë©´ C syscallsë¥¼ ì§ì ‘ í˜¸ì¶œí•´ë„ ë˜ê³ , PyPIì˜ landlock ë°”ì¸ë”©ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì´ íŒ¨í‚¤ì§€ëŠ” íŒŒì´ì¬ì—ì„œ rulesetì„ ë§Œë“¤ê³  ê²½ë¡œë¥¼ í—ˆìš© ëª©ë¡ìœ¼ë¡œ ì¶”ê°€í•œ ë’¤ apply()ë¡œ ì ìš©í•˜ëŠ” íë¦„ì„ ì œê³µí•œë‹¤(ì„¸ë¶€ ê¶Œí•œ í”Œë˜ê·¸ëŠ” ë²„ì „ì— ë”°ë¼ ë‹¤ë¦„). <a href="https://pypi.org/project/landlock/">PyPI+1</a></p>
  </li>
</ul>

<p>ìš”ì•½í•˜ë©´, í•˜ë‚˜ì˜ ruleset ì•ˆì— â€œì½ê¸° ì „ìš© A ë””ë ‰í„°ë¦¬ìš© ê·œì¹™â€ê³¼ â€œì“°ê¸° í—ˆìš© B ë””ë ‰í„°ë¦¬ìš© ê·œì¹™â€ì„ ê°ê° ì¶”ê°€í•˜ë©´ ëœë‹¤. ì›í•˜ë©´ ë„¤ ì»¤ë„-ì„¸ì…˜ êµ¬ì¡°ì— ë§ì¶°ì„œ, AëŠ” READ_FILE/READ_DIRë§Œ, BëŠ” READ_DIR+WRITE_FILE+MAKE__/REMOVE__ +TRUNCATE(+REFER ì„ íƒ)ë¡œ ë¬¶ì€ ìµœì†Œ ì˜ˆì œ ì½”ë“œë¥¼ ë°”ë¡œ ë§ì¶° ë“œë¦´ê²Œ.</p>

<p class="chat--user">

ê·¼ë° ë£°ì…‹ì„ íŒŒì´ì¬ ì½”ë“œê°€ í’€ì–´ë²„ë¦´ìˆ˜ë„ì‡ì§€ì•Šë‚˜

</p>

<p>ì§§ê²Œ ë‹µí•˜ë©´ â€œì •ìƒ ë™ì‘í•˜ëŠ” Landlockì— í•œí•´ì„ , íŒŒì´ì¬ ì½”ë“œê°€ ë£°ì„ â€˜í’€ì–´ë²„ë¦¬ëŠ”â€™ ê±´ ë¶ˆê°€ëŠ¥â€ì´ ë§ë‹¤. LandlockëŠ” ì»¤ë„ì´ ê°•ì œí•˜ëŠ” ì¼ë°©í–¥(one-way) ì œì•½ì´ë¼, í•œ ë²ˆ <code class="language-plaintext highlighter-rouge">landlock_restrict_self()</code>ë¡œ ì ìš©í•˜ë©´ í•´ì œÂ·ì™„í™”ê°€ ì•ˆ ë˜ê³  ë” ì¢íˆëŠ” ê²ƒë§Œ ê°€ëŠ¥í•˜ë‹¤. ê·¸ë¦¬ê³  ìƒˆë¡œ ìƒì„±ë˜ëŠ” ìì‹ í”„ë¡œì„¸ìŠ¤ë“¤ì€ ê·¸ ì œì•½ì„ ê·¸ëŒ€ë¡œ ìƒì†ë°›ëŠ”ë‹¤. í˜•ì œ ìŠ¤ë ˆë“œì—ëŠ” ìë™ ì „íŒŒê°€ ì•ˆ ë˜ë¯€ë¡œ, ìŠ¤ë ˆë“œê°€ ìƒê¸°ê¸° ì „ì— ì ìš©í•˜ê±°ë‚˜ ê° ìŠ¤ë ˆë“œì—ì„œ ì ìš©í•´ì•¼ í•œë‹¤. <a href="https://landlock.io/talks/2025-01-29_landlock-workshop.pdf?utm_source=chatgpt.com">landlock.io+1</a></p>

<p>í˜„ì‹¤ì ì¸ ì˜ˆì™¸Â·ì£¼ì˜ì ë„ ìˆë‹¤.</p>

<ol>
  <li>
    <p>2024ë…„ì— â€œì œì•½ì„ ìƒì–´ë²„ë¦´ ìˆ˜ ìˆëŠ”â€ ì»¤ë„ ë²„ê·¸ê°€ ìˆì—ˆë‹¤(CVE-2024-42318). íŠ¹ìˆ˜í•œ <code class="language-plaintext highlighter-rouge">keyctl(KEYCTL_SESSION_TO_PARENT)</code> ê²½ë¡œì—ì„œ Landlock ì •ë³´ê°€ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œì˜€ê³ , ì»¤ë„ ì¸¡ì—ì„œ <code class="language-plaintext highlighter-rouge">cred_transfer</code> í›…ì„ ì¶”ê°€í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •ëë‹¤. ë©”ì¸ë¼ì¸ì— ë¨¸ì§€ë˜ì—ˆê³  ê° ì•ˆì •í™” ë¸Œëœì¹˜ë¡œ ë°±í¬íŠ¸ëë‹¤. ë°°í¬íŒ ì»¤ë„ì´ ì´ ìˆ˜ì •ì´ í¬í•¨ëœ ë²„ì „ì´ë©´, ì‚¬ìš©ì ê³µê°„ ì½”ë“œê°€ Landlockì„ í•´ì œí•˜ëŠ” ìš°íšŒëŠ” ë” ì´ìƒ í†µí•˜ì§€ ì•ŠëŠ”ë‹¤. í™˜ê²½ ì ê²€ë§Œ í•´ë‘ë©´ ëœë‹¤. <a href="https://nvd.nist.gov/vuln/detail/cve-2024-42318?utm_source=chatgpt.com">NVD+1</a></p>
  </li>
  <li>
    <p>ì œì•½ì€ â€œê·¸ ì‹œì  ì´í›„ì˜ ì ‘ê·¼â€ì— ì ìš©ëœë‹¤. ì œì•½ì„ ê±¸ê¸° ì „ì— ì´ë¯¸ ì“°ê¸° ê¶Œí•œìœ¼ë¡œ ì—° ì—´ë¦° íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ê°€ ìˆë‹¤ë©´ ê·¸ FDë¥¼ í†µí•´ì„œëŠ” ê³„ì† ì“¸ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ì»¤ë„(ë˜ëŠ” ì»¤ë„ í”„ë¡œì„¸ìŠ¤) ì‹œì‘ ì§í›„, ì‚¬ìš©ì ì½”ë“œê°€ ëŒê¸° ì „ì— ë°”ë¡œ ì œí•œì„ ê±¸ê³ , ë¯¸ë¦¬ ì—´ë¦° ë¶ˆí•„ìš”í•œ FDë¥¼ ë‹«ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤. ì´ê±´ Landlockì˜ ì„¤ê³„ ì² í•™(ëˆ„ì Â·ì¼ë°©í–¥)ê³¼ ë™ì¼í•œ ì£¼ì˜ì ì´ë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html?utm_source=chatgpt.com">Kernel ë¬¸ì„œ</a></p>
  </li>
</ol>

<p>ì •ë¦¬í•˜ë©´ ë‹¤ìŒì²˜ëŸ¼ ìš´ìš©í•˜ë©´ ëœë‹¤.</p>

<p>â€¢ â€œí’€ ìˆ˜ ì—†ë‹¤â€ëŠ” ë³´ì¥ì€ ì»¤ë„ì´ ì¤€ë‹¤. ì‚¬ìš©ì íŒŒì´ì¬ì´ <code class="language-plaintext highlighter-rouge">ctypes</code>Â·<code class="language-plaintext highlighter-rouge">os</code>Â·<code class="language-plaintext highlighter-rouge">subprocess</code>ë¡œ ë°œë²„ë‘¥ì³ë„ Landlock ìì²´ë¥¼ í•´ì œí•˜ì§„ ëª»í•œë‹¤. ì œì•½ì€ ëˆ„ì ë§Œ ëœë‹¤. <a href="https://landlock.io/talks/2025-01-29_landlock-workshop.pdf?utm_source=chatgpt.com">landlock.io</a><br />
â€¢ ë‹¨, ì»¤ë„ì´ CVE-2024-42318 ìˆ˜ì •ë¶„ì„ í¬í•¨í•´ì•¼ í•œë‹¤. 2024-07 ë§ì— ë©”ì¸ë¼ì¸ì— ë“¤ì–´ê°”ê³  ë°°í¬íŒ ì»¤ë„ì—ë„ ë°˜ì˜ëë‹¤. ìš´ì˜ í™˜ê²½ì˜ ì»¤ë„ ì—…ë°ì´íŠ¸ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì. <a href="https://nvd.nist.gov/vuln/detail/cve-2024-42318?utm_source=chatgpt.com">NVD+1</a><br />
â€¢ ìŠ¤ë ˆë“œ/í”„ë¡œì„¸ìŠ¤ ëª¨ë¸ì„ ê¸°ì–µí•˜ì. í˜„ì¬ ìŠ¤ë ˆë“œì— ì ìš©í•˜ë©´ ìì‹ì—ëŠ” ìƒì†ë˜ì§€ë§Œ, ì´ë¯¸ ë–  ìˆëŠ” ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—” ìë™ ì ìš© ì•ˆ ëœë‹¤. ì»¤ë„ í”„ë¡œì„¸ìŠ¤ ì´ˆê¸°í™” ì§í›„ ì œì¼ ë¨¼ì € ì œí•œì„ ê±´ë‹¤. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org</a></p>

<p>ë§ë¶™ì—¬, ì½ê¸° ì „ìš© í´ë”ì™€ ì“°ê¸° í—ˆìš© í´ë”ë¥¼ ê°ê° ë”°ë¡œ ì£¼ëŠ” ê²ƒë„ í•œ ruleset ì•ˆì—ì„œ ê·œì¹™ ë‘ ê°œë¡œ ì¶©ë¶„í•˜ë©°, í•„ìš” ê¶Œí•œ ë¹„íŠ¸(READ_FILE/READ_DIRâ€¦ vs WRITE_FILE/MAKE_DIR/REMOVE_* ë“±)ë¥¼ ë¶„ë¦¬í•´ ì£¼ë©´ ëœë‹¤. ABI ë²„ì „ì— ë”°ë¼ TRUNCATE/REFER ê°™ì€ ê¶Œí•œ ê°€ìš©ì„±ì´ ë‹¬ë¼ì§€ë‹ˆ â€œbest-effortâ€ ë°©ì‹ìœ¼ë¡œ ê°ì§€í•´ ì“°ë©´ í˜¸í™˜ì„±ì´ ì¢‹ë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html?utm_source=chatgpt.com">Kernel ë¬¸ì„œ</a></p>

<p>ì´ ìƒíƒœì—ì„œ ë„¤ ì»¤ë„-ì„¸ì…˜ êµ¬ì¡° ìœ„ì— ì–¹ìœ¼ë©´, íŒŒì´ì¬ ìª½ ëª½í‚¤íŒ¨ì¹˜ë‚˜ audit hookì€ â€œì†Œí”„íŠ¸ ê°€ë“œâ€ë¡œ í¸ì˜ì™€ ë©”ì‹œì§€ í’ˆì§ˆì„ ì˜¬ë ¤ì£¼ê³ , Landlockì´ â€œí•˜ë“œ ê°€ë“œâ€ë¡œ ë°”ë‹¥ì„ ë°›ì³ì¤€ë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì»¤ë„ ì²« ì…€ì—ì„œ Landlockì„ ì ìš©í•˜ëŠ” ìµœì†Œ ìƒ˜í”Œì„ ë¶™ì—¬ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì•„í•˜ ë‹¤ì‹œ í•œ ë²ˆ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´ë³´ì. íŒŒì´ì¬ ì‹¤í–‰ íˆ´ì„ LLMì´ ì“¸ ìˆ˜ ìˆë„ë¡ ë§Œë“¤ ê²ƒ íˆ´ Config ë‹¨ê³„ -&gt; LLMì—ê²Œ íˆ´ ì‚¬ìš© ë²• ì „ë‹¬í•˜ëŠ” ë‹¨ê³„ -&gt; ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ë‹¨ê³„ ì´ë ‡ê²Œ 3ë‹¨ê³„ë¥¼ ë‚˜ëˆ ì„œ ìƒê°í•˜ì. ìš”êµ¬ ì‚¬í•­ 1. íˆ´ Config ë‹¨ê³„ì—ì„œ landlockìœ¼ë¡œ WRITE/READ ê°€ ê°€ëŠ¥í•œ í´ë”, READë§Œ ê°€ëŠ¥í•œ í´ë”ë¥¼ ì§€ì •í•´ë‘”ë‹¤. (í•˜ìœ„ í´ë”ê¹Œì§€ í¬í•¨) 2. ì„¸ì…˜ì€ jupyter client ë“  ë­ë“  ìœ ì§€í•œë‹¤(jupyter client ë§ê³  ë‹¤ë¥¸ ì ì ˆí•œ ë°©ë²•ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©í•  ê²ƒ). ê° ì—ì´ì „íŠ¸ë³„ ì„¸ì…˜ì„ ìœ ì§€í•œë‹¤. ì´ ë•Œ ì„¸ì…˜ì— ëŒ€í•œ id ê°™ì€ê±¸ ê°™ì´ ë°›ëŠ” ë°©ë²•ì´ ìˆì„ ë“¯. 3. ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•ŒëŠ” (1) ì„¸ì…˜ì„ ìœ ì§€í• ì§€ ë§ì§€, (2) ì¼íšŒìš© ì½”ë“œ ì‹¤í–‰í• ì§€ ì„ íƒí•  ìˆ˜ë„ ìˆì„ ê²ƒ ê°™ë„¤. ì„¤ê³„ ì˜ í•´ì¤˜.

</p>

<p>ì¢‹ì•„, 3ë‹¨ê³„ íë¦„ì— ë”± ë§ì¶° ì„¤ê³„ì™€ ìµœì†Œ êµ¬í˜„ ìŠ¤ì¼€ì¹˜ë¥¼ ì •ë¦¬í•œë‹¤. ëª©í‘œëŠ” LLMì´ íŒŒì´ì¬ì„ ì‹¤í–‰í•˜ë˜, ì„¤ì • ë‹¨ê³„ì—ì„œ ì½ê¸°/ì“°ê¸° í´ë” ì •ì±…ì„ ì •í•˜ê³ , ì„¸ì…˜ì„ í•„ìš”ì— ë”°ë¼ ìœ ì§€í•˜ê±°ë‚˜ 1íšŒì„±ìœ¼ë¡œ ì“°ëŠ” ê²ƒ.</p>

<h1 id="0-ì „ì²´-êµ¬ì¡°-í•œëˆˆì—">0. ì „ì²´ êµ¬ì¡° í•œëˆˆì—</h1>

<ul>
  <li>
    <p>PythonExecManager: íˆ´ ì§„ì…ì . ì •ì±…(ëœë“œë½), ì„¸ì…˜ ìƒì„±/í•´ì œ, ì‹¤í–‰ì„ ê´€ë¦¬.</p>
  </li>
  <li>
    <p>ë‘ ê°€ì§€ ì‹¤í–‰ ë°±ì—”ë“œ ì¤‘ ì„ íƒ</p>

    <ul>
      <li>
        <p>KernelBackend: Jupyter ì»¤ë„ì„ ì„¸ì…˜ ë‹¨ìœ„ë¡œ ìœ ì§€. ì²« ì…€ì—ì„œ Landlock + ê°€ë²¼ìš´ ê°€ë“œ ì£¼ì….</p>
      </li>
      <li>
        <p>SubprocessBackend: ê°€ë²¼ìš´ 1íšŒì„± í˜¹ì€ ìœ ì§€í˜• ì„œë¸Œí”„ë¡œì„¸ìŠ¤(JSON-RPC) ë°±ì—”ë“œ.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>íˆ´ ì„¸íŠ¸</p>

    <ul>
      <li>
        <p>configure_python_exec(readwrite_dirs, readonly_dirs)</p>
      </li>
      <li>
        <p>start_python_session(agent_id, backend, keep_alive, idle_timeout_sec)</p>
      </li>
      <li>
        <p>python_execute(code, session_id?, backend?, ephemeral?)</p>
      </li>
      <li>
        <p>copy_to_sandbox(source, dest_rel?)</p>
      </li>
    </ul>
  </li>
</ul>

<h1 id="1ë‹¨ê³„-íˆ´-config-ë‹¨ê³„">1ë‹¨ê³„. íˆ´ Config ë‹¨ê³„</h1>

<p>ìš”êµ¬ì‚¬í•­: ì´ ë‹¨ê³„ì—ì„œ Landlockìœ¼ë¡œ â€œì“°ê¸° ê°€ëŠ¥ í´ë”â€ì™€ â€œì½ê¸° ì „ìš© í´ë”â€ë¥¼ ì§€ì •í•´ë‘”ë‹¤. ì‹¤ì œ Landlock ì ìš©ì€ ê° ì„¸ì…˜ í”„ë¡œì„¸ìŠ¤ê°€ ëœ¨ê³  ì‚¬ìš©ì ì½”ë“œê°€ ëŒê¸° ì „ì— ìˆ˜í–‰ëœë‹¤.</p>

<p>ê¸°ëŠ¥ ìš”ì•½</p>

<ul>
  <li>
    <p>ì½ê¸° ì „ìš© ë””ë ‰í„°ë¦¬: READ_FILE/READ_DIR(+EXECUTE ì„ íƒ)ë§Œ í—ˆìš©.</p>
  </li>
  <li>
    <p>ì“°ê¸° ê°€ëŠ¥ ë””ë ‰í„°ë¦¬: READ_DIR + WRITE_FILE + MAKE_* + REMOVE_* (+TRUNCATE/REFERì€ ABI ì§€ì› ì‹œ) í—ˆìš©.</p>
  </li>
  <li>
    <p>Linuxê°€ ì•„ë‹ˆê±°ë‚˜ Landlock ë¯¸íƒ‘ì¬ë©´ ì†Œí”„íŠ¸ ê°€ë“œ(audit hook)ë§Œ ì¼ ë‹¤.</p>
  </li>
</ul>

<p>íˆ´ ìŠ¤í™(LLMì— ë“±ë¡í•  JSON, OpenAI Agents SDK/Function calling ì–‘ì‹ ì˜ˆ)</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"configure_python_exec"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ìƒŒë“œë°•ìŠ¤ ì •ì±…ì„ ì„¤ì •í•œë‹¤. ì½ê¸°/ì“°ê¸° í´ë”ë¥¼ ì§€ì •í•˜ê³  ì´í›„ ì„¸ì…˜ì— ì ìš©ëœë‹¤."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"readwrite_dirs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"readonly_dirs"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"sandbox_dir"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ì“°ê¸° ê¸°ë³¸ ë£¨íŠ¸(ìƒŒë“œë°•ìŠ¤). ìƒëµ ì‹œ ë‚´ë¶€ ê¸°ë³¸ê°’ ì‚¬ìš©"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"readwrite_dirs"</span><span class="p">,</span><span class="w"> </span><span class="s2">"readonly_dirs"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>íŒŒì´ì¬ ìµœì†Œ êµ¬í˜„(ì •ì±… ì €ì¥ë§Œ, ì‹¤ì œ ì ìš©ì€ ì„¸ì…˜ì´ ì¼œì§ˆ ë•Œ)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SandboxPolicy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ro</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sandbox_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">readwrite_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rw</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">readonly_dirs</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sandbox_dir</span>    <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">sandbox_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">sandbox_dir</span> <span class="k">else</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">PythonExecManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="sh">"</span><span class="s">BaseSession</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ro</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sandbox_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">sandbox_dir</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="nc">SandboxPolicy</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">ro</span><span class="p">,</span> <span class="n">sandbox_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">}</span>
</code></pre></div></div>

<h1 id="2ë‹¨ê³„-llmì—ê²Œ-íˆ´-ì‚¬ìš©ë²•-ì „ë‹¬-ë‹¨ê³„">2ë‹¨ê³„. â€œLLMì—ê²Œ íˆ´ ì‚¬ìš©ë²•â€ ì „ë‹¬ ë‹¨ê³„</h1>

<p>ì‹œìŠ¤í…œ/ê°œë°œì ì§€ì¹¨ì— ë„£ì„ í•µì‹¬ ê·œì¹™</p>

<ul>
  <li>
    <p>íŒŒì¼ì„ ì“°ê±°ë‚˜ ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € copy_to_sandboxë¥¼ í˜¸ì¶œí•´ ìƒŒë“œë°•ìŠ¤ ì•ˆìœ¼ë¡œ ê°€ì ¸ì˜¬ ê²ƒ.</p>
  </li>
  <li>
    <p>ì„¸ì…˜ì´ í•„ìš”í•˜ë©´ start_python_sessionì„ ë¨¼ì € í˜¸ì¶œí•˜ê³  ë°˜í™˜ëœ session_idë¥¼ python_executeì— ë„˜ê²¨ë¼.</p>
  </li>
  <li>
    <p>1íšŒì„± ì‹¤í–‰ì€ session_id ì—†ì´ python_execute(ephemeral=true, backend=â€¦)ë¡œ í˜¸ì¶œí•´ë¼.</p>
  </li>
  <li>
    <p>ê²½ë¡œë¥¼ ì œì‹œí•  ë•ŒëŠ” ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ ê²½ë¡œë¥¼ ìš°ì„  ì‚¬ìš©í•´ë¼. ì“°ê¸° ì‹œë„ëŠ” ìƒŒë“œë°•ìŠ¤ ë°–ì—ì„œ ì‹¤íŒ¨í•œë‹¤.</p>
  </li>
</ul>

<p>LLMìš© íˆ´ ìŠ¤í™</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"start_python_session"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"íŒŒì´ì¬ ì‹¤í–‰ ì„¸ì…˜ì„ ì—°ë‹¤(ì»¤ë„ ë˜ëŠ” ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ë°±ì—”ë“œ)."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"agent_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ì—ì´ì „íŠ¸/ìŠ¤ë ˆë“œ ì‹ë³„ì"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"backend"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"kernel"</span><span class="p">,</span><span class="w"> </span><span class="s2">"subprocess"</span><span class="p">],</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kernel"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"keep_alive"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"idle_timeout_sec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"agent_id"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python_execute"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰í•œë‹¤. ì„¸ì…˜ ìœ ì§€ ë˜ëŠ” 1íšŒì„±(ephemeral) ì‹¤í–‰ ëª¨ë‘ ì§€ì›."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ìœ ì§€í˜• ì„¸ì…˜ ì‹¤í–‰ ì‹œ í•„ìš”"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"backend"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"kernel"</span><span class="p">,</span><span class="w"> </span><span class="s2">"subprocess"</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"ephemeral"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"timeout_sec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"visible_mode"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"code"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"copy_to_sandbox"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"í˜¸ìŠ¤íŠ¸ ê²½ë¡œì—ì„œ íŒŒì¼/í´ë”ë¥¼ ìƒŒë“œë°•ìŠ¤ë¡œ ë³µì‚¬í•œë‹¤."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"dest_rel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ ìƒëŒ€ê²½ë¡œ"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"source"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>LLMì—ê²Œ ì£¼ëŠ” ê°„ë‹¨ ì§€ì¹¨ í…ìŠ¤íŠ¸</p>

<ul>
  <li>
    <p>ë¶„ì„ì— ì“¸ íŒŒì¼ì€ ë¨¼ì € copy_to_sandboxë¡œ ê°€ì ¸ì™€ë¼.</p>
  </li>
  <li>
    <p>í”Œë¡¯/íŒŒì¼ ì €ì¥ì€ í•­ìƒ ${SANDBOX_DIR} ì•ˆìœ¼ë¡œ ì €ì¥í•˜ë¼.</p>
  </li>
  <li>
    <p>ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰Â·ìƒíƒœ ìœ ì§€ê°€ í•„ìš”í•˜ë©´ start_python_session â†’ python_execute(session_id=â€¦).</p>
  </li>
  <li>
    <p>í•œ ë²ˆë§Œ ëŒë¦´ ê±°ë©´ python_execute(ephemeral=true, backend="subprocess")ë¡œ í˜¸ì¶œí•˜ë¼.</p>
  </li>
</ul>

<h1 id="3ë‹¨ê³„-ì‹¤ì œ-ì‚¬ìš©-ë‹¨ê³„-ì„¤ê³„">3ë‹¨ê³„. ì‹¤ì œ ì‚¬ìš© ë‹¨ê³„ ì„¤ê³„</h1>

<p>A. ìœ ì§€í˜• ì„¸ì…˜ íë¦„(ì˜ˆ: ì—ì´ì „íŠ¸ë³„ ìƒíƒœ ìœ ì§€)</p>

<ol>
  <li>
    <p>configure_python_exec í˜¸ì¶œë¡œ ì •ì±… ë“±ë¡</p>
  </li>
  <li>
    <p>start_python_session(agent_id="agent-A", backend="kernel", keep_alive=true)</p>
  </li>
  <li>
    <p>copy_to_sandbox í•„ìš” ì‹œ í˜¸ì¶œ</p>
  </li>
  <li>
    <p>python_execute(session_id=â€¦, code=â€¦)</p>
  </li>
  <li>
    <p>í•„ìš” ì‹œ ê°™ì€ session_idë¡œ ì—°ì† ì‹¤í–‰</p>
  </li>
  <li>
    <p>ì•„ì´ë“¤ íƒ€ì„ì•„ì›ƒ ì´ˆê³¼ ì‹œ ì„¸ì…˜ ìë™ ì¢…ë£Œ</p>
  </li>
</ol>

<p>B. 1íšŒì„± ì‹¤í–‰ íë¦„</p>

<ol>
  <li>
    <p>configure_python_exec í˜¸ì¶œ(ì•± ì‹œì‘ ì‹œ 1íšŒ í•´ë„ ë¨)</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code=â€¦)</p>
  </li>
</ol>

<p>ì´ì›í™” ì´ìœ </p>

<ul>
  <li>
    <p>kernelì€ í’ë¶€í•œ ê³¼í•™ ìŠ¤íƒ/ìƒíƒœ ìœ ì§€ì— ê°•í•¨</p>
  </li>
  <li>
    <p>subprocessëŠ” ê¸°ë™ì´ ë¹ ë¥´ê³ , ì¼íšŒì„± ì½”ë“œì— ì í•©</p>
  </li>
</ul>

<h1 id="ì„¸ì…˜-ë°±ì—”ë“œ-êµ¬í˜„-í•µì‹¬">ì„¸ì…˜ ë°±ì—”ë“œ êµ¬í˜„ í•µì‹¬</h1>

<p>Landlock ì ìš© ì „ëµ</p>

<ul>
  <li>
    <p>ì‹¤ì œ ì œì•½ì€ â€œê° ì„¸ì…˜ í”„ë¡œì„¸ìŠ¤ ë‚´ë¶€â€ì—ì„œ ê±¸ì–´ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>KernelBackend: ì»¤ë„ ì‹œì‘ í›„ ì²« ì‹¤í–‰ ì…€ì—ì„œ Landlockì„ ì ìš©í•˜ê³ , ì´ì–´ì„œ audit hook(ì†Œí”„íŠ¸ ê°€ë“œ)ë„ ì£¼ì….</p>
  </li>
  <li>
    <p>SubprocessBackend: ìì‹ í”„ë¡œì„¸ìŠ¤ê°€ ëœ¨ìë§ˆì Landlockì„ restrict_self()ë¡œ ì ìš©í•œ í›„ JSON-RPC ë£¨í”„ ì§„ì….</p>
  </li>
</ul>

<p>ê¶Œí•œ ë§ˆìŠ¤í¬ êµ¬ì„±(ABI ì°¨ì´ ì•ˆì „ ì²˜ë¦¬)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_access_mask</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">landlock</span>
    <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">AccessFs</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">READ_DIR</span>
    <span class="c1"># ì½ê¸°/ì‹¤í–‰ í•„ìš” ì‹œ
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">|=</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">EXECUTE</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">acc</span>

<span class="k">def</span> <span class="nf">build_write_mask</span><span class="p">():</span>
    <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">AccessFs</span>
    <span class="n">perms</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># ABI v2+: REFER, v3+: TRUNCATE ë“±ì€ ìˆìœ¼ë©´ ì¶”ê°€
</span>    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># ë””ë ‰í„°ë¦¬ íŠ¸ë˜ë²„ìŠ¤ í—ˆìš©
</span>    <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></div>

<p>KernelBackend ì´ˆê¸°í™” ì½”ë“œ ìŠ¤ì¼€ì¹˜</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AUDIT_GUARD</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys
SBOX = os.path.realpath(os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">))
os.makedirs(SBOX, exist_ok=True)
def _in_sb(p): import os; rp=os.path.realpath(p); return rp==SBOX or rp.startswith(SBOX+os.sep)
def _audit(ev, args):
    if ev == </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">:
        path = str(args[0]); mode = str(args[1]) if len(args)&gt;1 else </span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="s">
        flags = int(args[2]) if len(args)&gt;2 else 0
        wr = any(ch in mode for ch in (</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="s">)) or (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
        if wr and not _in_sb(path): raise PermissionError(f</span><span class="sh">'</span><span class="s">Writes restricted to {SBOX}: {path}</span><span class="sh">'</span><span class="s">)
    elif ev.startswith(</span><span class="sh">'</span><span class="s">subprocess.</span><span class="sh">'</span><span class="s">) or ev==</span><span class="sh">'</span><span class="s">os.system</span><span class="sh">'</span><span class="s">: raise PermissionError(</span><span class="sh">'</span><span class="s">Subprocess disabled</span><span class="sh">'</span><span class="s">)
sys.addaudithook(_audit)
</span><span class="sh">"""</span>

<span class="n">LANDLOCK_INIT</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os
SANDBOX_DIR = os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">)
try:
    import landlock
    from landlock import Ruleset, PathBeneath
    from landlock import AccessFs as A
    rw_dirs = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">) else []
    ro_dirs = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">) else []
    handled = 0
    for name in dir(A):
        if name.isupper():
            handled |= getattr(A, name)
    rs = Ruleset(handled_access_fs=handled)
    write_mask = 0
    for n in (</span><span class="sh">'</span><span class="s">WRITE_FILE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REMOVE_FILE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REMOVE_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_REG</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_SYM</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REFER</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">TRUNCATE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">):
        write_mask |= getattr(A, n, 0)
    read_mask = getattr(A,</span><span class="sh">'</span><span class="s">READ_FILE</span><span class="sh">'</span><span class="s">,0) | getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0) | getattr(A,</span><span class="sh">'</span><span class="s">EXECUTE</span><span class="sh">'</span><span class="s">,0)
    for d in ro_dirs:
        if d: rs.add_rule(PathBeneath(d, read_mask))
    for d in rw_dirs + [SANDBOX_DIR]:
        if d: rs.add_rule(PathBeneath(d, write_mask | read_mask))
    rs.restrict_self()
    print(</span><span class="sh">'</span><span class="s">[landlock] active</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">'</span><span class="s">[landlock] unavailable:</span><span class="sh">'</span><span class="s">, e)
</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">KernelBackendSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="c1"># ì •ì±… ì „ë‹¬ ë° ì´ˆê¸° ê°€ë“œ/ëœë“œë½ ì£¼ì…
</span>        <span class="n">env</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="si">!r}</span><span class="s">;</span><span class="sh">"</span> \
              <span class="sa">f</span><span class="sh">"</span><span class="s">os.environ[</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">readwrite_dirs</span><span class="p">)</span><span class="si">!r}</span><span class="s">;</span><span class="sh">"</span> \
              <span class="sa">f</span><span class="sh">"</span><span class="s">os.environ[</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">readonly_dirs</span><span class="p">)</span><span class="si">!r}</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_exec</span><span class="p">(</span><span class="n">env</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">LANDLOCK_INIT</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">AUDIT_GUARD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_exec</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># â€¦ (iopub ìˆ˜ì§‘/timeout ì²˜ë¦¬ëŠ” ìƒëµ)
</span></code></pre></div></div>

<p>SubprocessBackend ì´ˆê¸°í™” ì½”ë“œ ìŠ¤ì¼€ì¹˜</p>

<ul>
  <li>ìì‹ì´ ë¶€íŒ…í•˜ìë§ˆì Landlock ì ìš© í›„ stdinìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” JSON ëª…ë ¹ì„ ì‹¤í–‰</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SUBPROCESS_BOOT</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import sys, os, json
SANDBOX_DIR = os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">)
def apply_ll():
    try:
        import landlock
        from landlock import Ruleset, PathBeneath
        from landlock import AccessFs as A
        handled = 0
        for n in dir(A):
            if n.isupper(): handled |= getattr(A,n)
        rs = Ruleset(handled_access_fs=handled)
        rw = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">) else []
        ro = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">) else []
        wm = getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">WRITE_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">MAKE_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">MAKE_REG</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REMOVE_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REMOVE_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REFER</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">TRUNCATE</span><span class="sh">'</span><span class="s">,0)
        rm = getattr(A,</span><span class="sh">'</span><span class="s">READ_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">EXECUTE</span><span class="sh">'</span><span class="s">,0)
        for d in ro: 
            if d: rs.add_rule(PathBeneath(d, rm))
        for d in rw+[SANDBOX_DIR]:
            if d: rs.add_rule(PathBeneath(d, rm|wm))
        rs.restrict_self()
    except Exception as e:
        print(</span><span class="sh">'</span><span class="s">[landlock] unavailable:</span><span class="sh">'</span><span class="s">, e, file=sys.stderr)
def loop():
    apply_ll()
    while True:
        line = sys.stdin.readline()
        if not line: break
        req = json.loads(line)
        code = req.get(</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">)
        g = {}
        try:
            exec(code, g, g)
            print(json.dumps({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">: True, </span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="s">: </span><span class="sh">""</span><span class="s">}))
        except Exception as e:
            print(json.dumps({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">: False, </span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="s">: str(e)}))
        sys.stdout.flush()
loop()
</span><span class="sh">"""</span>
</code></pre></div></div>

<h1 id="copy_to_sandbox-êµ¬í˜„-ë©”ëª¨">copy_to_sandbox êµ¬í˜„ ë©”ëª¨</h1>

<ul>
  <li>
    <p>ì‹¬ë³¼ë¦­ ë§í¬ ê±°ë¶€, ëª©ì ì§€ëŠ” ë°˜ë“œì‹œ sandbox_dir í•˜ìœ„ ê²½ë¡œë¡œ ê°•ì œ.</p>
  </li>
  <li>
    <p>ë””ë ‰í„°ë¦¬ ë³µì‚¬ ì‹œ ê¸°ì¡´ ëŒ€ìƒ ì¶©ëŒ ë°©ì§€.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span><span class="p">):</span>
    <span class="kn">import</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">not found</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">,</span> <span class="n">dest_rel</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dst</span> <span class="o">!=</span> <span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dest exists</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
</code></pre></div></div>

<h1 id="ì‹¤í–‰-ë‹¨ê³„-ì˜ˆì‹œ-ì‹œí€€ìŠ¤">ì‹¤í–‰ ë‹¨ê³„ ì˜ˆì‹œ ì‹œí€€ìŠ¤</h1>

<p>ìœ ì§€í˜•(ì»¤ë„) ì˜ˆì‹œ</p>

<ol>
  <li>
    <p>configure_python_exec(readwrite_dirs=["/mnt/sandbox"], readonly_dirs=["/","/usr","/home/you/data"])</p>
  </li>
  <li>
    <p>start_python_session(agent_id="analyst-1", backend="kernel", keep_alive=true)</p>
  </li>
  <li>
    <p>copy_to_sandbox("/home/you/data/df.csv", "data/df.csv")</p>
  </li>
  <li>
    <p>python_execute(session_id="sess-analyst-1", code='import pandas as pd; df=pd.read_csv("data/df.csv"); print(df.shape)')</p>
  </li>
  <li>
    <p>ê°™ì€ session_idë¡œ ê³„ì† ì‹¤í–‰</p>
  </li>
</ol>

<p>1íšŒì„±(ì„œë¸Œí”„ë¡œì„¸ìŠ¤) ì˜ˆì‹œ</p>

<ol>
  <li>
    <p>configure_python_exec(â€¦)</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code='open("/etc/hosts","w").write("x")') â†’ ì»¤ë„ì´ ê±°ë¶€</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code='print("ok")') â†’ ì •ìƒ</p>
  </li>
</ol>

<h1 id="ì„¤ê³„-ì„ íƒ-ì´ìœ ì™€-í•œê³„">ì„¤ê³„ ì„ íƒ ì´ìœ ì™€ í•œê³„</h1>

<ul>
  <li>
    <p>Landlockì€ ì»¤ë„ì´ ê°•ì œí•˜ëŠ” ì¼ë°©í–¥ ì œì•½ì´ë¼ í•œ ë²ˆ ì ìš©í•˜ë©´ ì‚¬ìš©ì íŒŒì´ì¬ì´ â€œí•´ì œâ€í•˜ì§„ ëª»í•œë‹¤. ë‹¤ë§Œ OSê°€ Linux 5.13+ì—¬ì•¼ í•˜ë©°, ABI ê¸°ëŠ¥(TRUNCATE/REFER ë“±)ì€ ë²„ì „ì— ë”°ë¼ ë‹¤ë¥´ë‹¤. ìœ„ ì½”ë“œëŠ” â€œê°€ëŠ¥í•˜ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ê±´ë„ˆë›°ëŠ”â€ ë² ìŠ¤íŠ¸ì—í¬íŠ¸ ë°©ì‹ìœ¼ë¡œ êµ¬ì„±.</p>
  </li>
  <li>
    <p>ì™„ë²½í•œ ê²©ë¦¬ëŠ” ì•„ë‹ˆì§€ë§Œ, ì‹¤ìˆ˜ë¡œ í˜¸ìŠ¤íŠ¸ë¥¼ ë”ëŸ½íˆëŠ” ê²½ë¡œë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì°¨ë‹¨í•œë‹¤. ì¶”ê°€ë¡œ audit hookê³¼ ë¦¬ì†ŒìŠ¤ ì œí•œ(CPU/ë©”ëª¨ë¦¬/íŒŒì¼ì‚¬ì´ì¦ˆ)ì„ ê³ë“¤ì´ë©´ 80/20 ëª©ì ì— ì¶©ë¶„íˆ ì‹¤ìš©ì .</p>
  </li>
</ul>

<p>ì›í•˜ë©´ ì—¬ê¸°ì— ë°”ë¡œ ë¶™ì—¬ ì“¸ ìˆ˜ ìˆëŠ” ì™„ì„±í˜• ëª¨ë“ˆ(Manager + ë‘ ë°±ì—”ë“œ + ìµœì†Œ RPC ë£¨í”„)ë¡œ ë¬¶ì–´ì„œ ë“œë¦´ ìˆ˜ ìˆë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">vLLMì— pdf ë„£ëŠ”ë²•</title><link href="https://hvppyarchive.github.io/llm/vllm-pdf/" rel="alternate" type="text/html" title="vLLMì— pdf ë„£ëŠ”ë²•" /><published>2025-11-04T14:13:34+09:00</published><updated>2025-11-04T14:13:34+09:00</updated><id>https://hvppyarchive.github.io/llm/vllm-pdf</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/vllm-pdf/"><![CDATA[<p class="chat--user">

vllm ì„œë¹™í•˜ëŠ” ëª¨ë¸ gptossì— pdf ë„£ëŠ”ë²•

</p>

<p>ìš”ì•½ ë¨¼ì €: vLLMìœ¼ë¡œ ì„œë¹™ ì¤‘ì¸ gpt-ossëŠ” â€œPDF íŒŒì¼ì„ ì§ì ‘ ë„£ì–´ ì²˜ë¦¬â€í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. vLLM OpenAI í˜¸í™˜ ì„œë²„ëŠ” í…ìŠ¤íŠ¸/í† í° ìŠ¤íŠ¸ë¦¼ì„ ë°›ëŠ” APIì´ê³ , gpt-ossëŠ” ê³µê°œëœ ê°€ì´ë“œ ê¸°ì¤€ í…ìŠ¤íŠ¸ ì „ìš© ëª¨ë¸ì´ë¼ì„œ(ì´ë¯¸ì§€Â·PDF ì—…ë¡œë“œ íŒŒë¼ë¯¸í„° ì—†ìŒ) PDFëŠ” ì‚¬ì „ ì „ì²˜ë¦¬(í…ìŠ¤íŠ¸ ì¶”ì¶œâ†’ì²­ì†Œâ†’ì²­í¬â†’ê²€ìƒ‰/RAG)ë¡œ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai+4</a></p>

<p>ì•„ë˜ëŠ” â€œPDFë¥¼ gpt-oss(vLLM ì„œë²„)ë¡œ ë„£ëŠ”â€ ê°€ì¥ í”í•œ êµ¬í˜„ ë ˆì‹œí”¼ì…ë‹ˆë‹¤. ë‹¨ê³„ë³„ë¡œ ê·¸ëŒ€ë¡œ ë”°ë¼í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>vLLM ì„œë²„ë¡œ gpt-oss ë„ìš°ê¸°</li>
</ol>

<ul>
  <li>CUDA í™˜ê²½ì—ì„œ ì˜ˆì‹œ:</li>
</ul>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">pip</span> <span class="nt">install</span> <span class="nt">vllm</span>
<span class="nt">python</span> <span class="nt">-m</span> <span class="nt">vllm</span><span class="nc">.entrypoints.openai.api_server</span> <span class="err">\</span>
  <span class="nt">--model</span> <span class="nt">openai</span><span class="o">/</span><span class="nt">gpt-oss-20b</span> <span class="err">\</span>
  <span class="nt">--max-model-len</span> <span class="err">32768</span> <span class="err">\</span>
  <span class="nt">--port</span> <span class="err">8000</span>
</code></pre></div></div>

<p>ì„œë²„ëŠ” OpenAI í˜¸í™˜ Chat/Completions ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ íŒŒì¼ ì—…ë¡œë“œ í•„ë“œëŠ” ì—†ê³  ë¬¸ìì—´ í”„ë¡¬í”„íŠ¸ë§Œ ë°›ìŠµë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai</a></p>

<ol>
  <li>PDF â†’ í…ìŠ¤íŠ¸ ì¶”ì¶œ</li>
</ol>

<ul>
  <li>
    <p>Python ë„êµ¬ ì˜ˆ: pypdf, pdfminer.six, unstructured, docling ë“±.</p>
  </li>
  <li>
    <p>í‘œÂ·ë¨¸ë¦¬ê¸€Â·ê°ì£¼ê°€ ì„ì—¬ ìˆìœ¼ë©´ docling/Unstructured ê³„ì—´ì´ í’ˆì§ˆì´ ë” ë‚«ìŠµë‹ˆë‹¤. ì¶”ì¶œ í›„ ë‹¤ìŒì„ ê¼­ í•˜ì„¸ìš”.<br />
â€¢ í˜ì´ì§€ í—¤ë”/í‘¸í„° ì œê±°, ê³µë°± ì •ê·œí™”, ë³¸ë¬¸ ë³‘í•©<br />
â€¢ ë„ˆë¬´ ê¸´ í‘œëŠ” CSVë¡œ ë”°ë¡œ ì €ì¥(í•„ìš”ì‹œ)<br />
ê´€ë ¨ ì´ìŠˆì™€ íŒŒì´í”„ë¼ì¸ ì„ íƒì€ ì»¤ë®¤ë‹ˆí‹°/ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ìŠˆë¥¼ ì°¸ê³ í•˜ì„¸ìš”. <a href="https://github.com/docling-project/docling/issues/1365?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<ol>
  <li>ì²­í¬ ë‚˜ëˆ„ê¸°</li>
</ol>

<ul>
  <li>
    <p>800~1500ì(ë˜ëŠ” 200~400 í† í°) ë‹¨ìœ„ë¡œ ìë¥´ê³ , ë¬¸ë‹¨ ê²½ê³„ë¥¼ ìµœëŒ€í•œ ìœ ì§€í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê° ì²­í¬ì— ì›ë¬¸ í˜ì´ì§€/ì„¹ì…˜ ë©”íƒ€ë°ì´í„°ë¥¼ ë¶™ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>ì„ë² ë”© ìƒì„± â†’ ë²¡í„°DB ì ì¬</li>
</ol>

<ul>
  <li>
    <p>ì„ë² ë”© ëª¨ë¸(ì˜ˆ: bge-m3, jina-embeddings, sentence-transformers ë“±)ë¡œ ê° ì²­í¬ë¥¼ ë²¡í„°í™”í•˜ê³ , FAISS/Chroma/PGVectorì— ë„£ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì´ ë‹¨ê³„ëŠ” LLM(gpt-oss/vLLM)ê³¼ ë¶„ë¦¬ëœ ë³„ë„ ê³¼ì •ì…ë‹ˆë‹¤. vLLM ìì²´ëŠ” ì„ë² ë”©ì„ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤. RAG íŒ¨í„´ ì˜ˆì‹œëŠ” ë‹¤ìˆ˜ì˜ vLLM ë°°í¬ ì˜ˆì œì—ì„œë„ ë™ì¼í•©ë‹ˆë‹¤. <a href="https://validatedpatterns.io/patterns/rag-llm-gitops/?utm_source=chatgpt.com">validatedpatterns.io+1</a></p>
  </li>
</ul>

<ol>
  <li>ì§ˆì˜ ì‹œ ê²€ìƒ‰(RAG) â†’ í”„ë¡¬í”„íŠ¸ êµ¬ì„± â†’ vLLMì— ì „ë‹¬</li>
</ol>

<ul>
  <li>
    <p>ìœ ì € ì§ˆë¬¸ì„ ë²¡í„° ê²€ìƒ‰ìœ¼ë¡œ top-k ì²­í¬ì™€ ë§¤ì¹­</p>
  </li>
  <li>
    <p>ì•„ë˜ System/Assistant ì»¨í…ìŠ¤íŠ¸ì— â€œê²€ìƒ‰ ê²°ê³¼â€ë¥¼ ë„£ê³ , gpt-ossì˜ ê¶Œì¥ í¬ë§·(í•˜ëª¨ë‹ˆ í¬ë§·)ì„ ì§€í‚¤ë©° ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. gpt-ossëŠ” OpenAI í˜¸í™˜ ì„œë²„ì—ì„œ ì˜ ë™ì‘í•˜ë„ë¡ ê°€ì´ë“œê°€ ìˆìŠµë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm?utm_source=chatgpt.com">cookbook.openai.com+1</a></p>
  </li>
</ul>

<p>ì‹¤ì „ ì½”ë“œ ìŠ¤ë‹ˆí«</p>

<p>A. PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ/ì²­í¬(ê°„ë‹¨ ì˜ˆì‹œ)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pypdf</span> <span class="kn">import</span> <span class="n">PdfReader</span>

<span class="k">def</span> <span class="nf">extract_pdf_text</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="nc">PdfReader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">pages</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">extract_text</span><span class="p">()</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="n">pages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">())})</span>
    <span class="k">return</span> <span class="n">pages</span>

<span class="k">def</span> <span class="nf">chunk_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_chars</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">start</span> <span class="o">+</span> <span class="n">max_chars</span><span class="p">)</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">overlap</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">pages</span> <span class="o">=</span> <span class="nf">extract_pdf_text</span><span class="p">(</span><span class="sh">"</span><span class="s">sample.pdf</span><span class="sh">"</span><span class="p">)</span>
<span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">chunk_text</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">page</span><span class="p">[</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">})</span>
</code></pre></div></div>

<p>B. ì„ë² ë”©â†’FAISS ì ì¬(ì˜ˆì‹œ: sentence-transformers)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">import</span> <span class="n">faiss</span><span class="p">,</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">SentenceTransformer</span><span class="p">(</span><span class="sh">"</span><span class="s">sentence-transformers/all-MiniLM-L6-v2</span><span class="sh">"</span><span class="p">)</span>
<span class="n">emb</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">encode</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">],</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="p">.</span><span class="nc">IndexFlatIP</span><span class="p">(</span><span class="n">emb</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">index</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>
</code></pre></div></div>

<p>C. ê²€ìƒ‰â†’vLLM(gpt-oss) í˜¸ì¶œ(OpenAI í˜¸í™˜)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span><span class="p">,</span> <span class="n">requests</span><span class="p">,</span> <span class="n">json</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">encode</span><span class="p">([</span><span class="n">query</span><span class="p">],</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">scores</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">topk</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">ctx</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[p.</span><span class="si">{</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">]</span><span class="se">\n</span><span class="si">{</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ask_vllm</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">You are a helpful assistant. Use the provided CONTEXT; if missing, say you don</span><span class="sh">'</span><span class="s">t know.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sa">f</span><span class="sh">"</span><span class="s">CONTEXT:</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n\n</span><span class="s">QUESTION:</span><span class="se">\n</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">http://localhost:8000/v1/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">},</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">openai/gpt-oss-20b</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span><span class="n">messages</span><span class="p">,</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span><span class="mf">0.2</span><span class="p">})</span>
    <span class="p">).</span><span class="nf">json</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">ask_vllm</span><span class="p">(</span><span class="sh">"</span><span class="s">ì´ PDFì—ì„œ ë°˜í’ˆ ì •ì±… í•µì‹¬ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>D. curlë¡œ ê°„ë‹¨ í…ŒìŠ¤íŠ¸</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">curl</span> <span class="nv">http</span><span class="p">:</span><span class="c1">//localhost:8000/v1/chat/completions \</span>
  <span class="o">-</span><span class="kt">H</span> <span class="s">"Content-Type: application/json"</span> <span class="p">\</span>
  <span class="o">-</span><span class="n">d</span> <span class="err">'</span><span class="p">{</span>
    <span class="s">"model"</span><span class="p">:</span> <span class="s">"openai/gpt-oss-20b"</span><span class="p">,</span>
    <span class="s">"messages"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="s">"role"</span><span class="p">:</span><span class="s">"system"</span><span class="p">,</span><span class="s">"content"</span><span class="p">:</span><span class="s">"Answer using the context."</span><span class="p">},</span>
      <span class="p">{</span><span class="s">"role"</span><span class="p">:</span><span class="s">"user"</span><span class="p">,</span><span class="s">"content"</span><span class="p">:</span><span class="s">"CONTEXT:</span><span class="se">\n</span><span class="s">&lt;ì—¬ê¸°ì— ê²€ìƒ‰ìœ¼ë¡œ ëª¨ì€ PDF ì²­í¬&gt;</span><span class="se">\n\n</span><span class="s">QUESTION:</span><span class="se">\n</span><span class="s">ìš”ì•½í•´ì¤˜"</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">0.2</span>
  <span class="p">}</span><span class="err">'</span>
</code></pre></div></div>

<p>ìì£¼ ë¬»ëŠ” í¬ì¸íŠ¸</p>

<ul>
  <li>
    <p>ì™œ PDF íŒŒì¼ ìì²´ë¥¼ ë°”ë¡œ ëª» ë„£ë‚˜?<br />
vLLMì˜ OpenAI í˜¸í™˜ ì„œë²„ëŠ” íŒŒì¼ ì—…ë¡œë“œ/ìŠ¤í† ë¦¬ì§€ ê¸°ëŠ¥ì´ ì•„ë‹ˆë¼ í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ APIì…ë‹ˆë‹¤. ì¦‰, íŒŒì¼ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆì´ì–´ì—ì„œ ì²˜ë¦¬í•´ì„œ í…ìŠ¤íŠ¸(ë˜ëŠ” ê²€ìƒ‰ëœ ì»¨í…ìŠ¤íŠ¸)ë¡œ ë°”ê¾¼ ë‹¤ìŒ ëª¨ë¸ì— ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai</a></p>
  </li>
  <li>
    <p>gpt-ossê°€ PDFë‚˜ ì´ë¯¸ì§€ê¹Œì§€ ì§ì ‘ ì½ëŠ” ë©€í‹°ëª¨ë‹¬ì¸ê°€?<br />
ê³µê°œ ê°€ì´ë“œ ê¸°ì¤€ gpt-ossëŠ” í…ìŠ¤íŠ¸ ì¤‘ì‹¬ì˜ ì˜¤í”ˆ ì›¨ì´íŠ¸ íŒ¨ë°€ë¦¬ë¡œ ì†Œê°œë˜ì—ˆìŠµë‹ˆë‹¤. ë©€í‹°ëª¨ë‹¬ ì…ë ¥ì„ ì§ì ‘ ë°›ëŠ” í˜•íƒœê°€ ì•„ë‹ˆë¼, í…ìŠ¤íŠ¸ë¡œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì£¼ëŠ” ë°©ì‹ì´ í‘œì¤€ì…ë‹ˆë‹¤. <a href="https://openai.com/index/introducing-gpt-oss/?utm_source=chatgpt.com">OpenAI+2</a></p>
  </li>
  <li>
    <p>â€œPDF ì§ˆì˜ì‘ë‹µâ€ ì •ë°€ë„ë¥¼ ë” ë†’ì´ë ¤ë©´?<br />
ì²­í¬ í¬ê¸°/ì˜¤ë²„ë© ìµœì í™”, í‘œ/ì½”ë“œ ë¸”ë¡ ë³´ì¡´, ì„¹ì…˜ë³„ ì¬ìˆœìœ„í™”(re-ranking), â€œì¶œì²˜ í˜ì´ì§€ í‘œì‹œâ€ë¥¼ í”„ë¡¬í”„íŠ¸ì— ê°•ì œ, ê·¸ë¦¬ê³  ë‹µë³€ ê·¼ê±°ë¥¼ ë”°ë¡œ ì¶œë ¥í•˜ë„ë¡ ê·œì¹™ì„ ë„£ìœ¼ë©´ í’ˆì§ˆì´ ì•ˆì •ë©ë‹ˆë‹¤. vLLM ë ˆì‹œí”¼/ì¿ í¬ë¶ì˜ gpt-oss ìš´ì˜ ê°€ì´ë“œë„ í•¨ê»˜ ë³´ì„¸ìš”. <a href="https://docs.vllm.ai/projects/recipes/en/latest/OpenAI/GPT-OSS.html?utm_source=chatgpt.com">docs.vllm.ai+1</a></p>
  </li>
</ul>

<p>í•œ ì¤„ ì •ë¦¬: vLLM+gpt-ossë¡œ PDFë¥¼ â€œë„£ëŠ”â€ ê²ƒì€ PDFë¥¼ í…ìŠ¤íŠ¸ë¡œ ì „ì²˜ë¦¬í•˜ê³ , ê²€ìƒ‰ ê¸°ë°˜(RAG)ìœ¼ë¡œ ê´€ë ¨ ì²­í¬ë¥¼ ì¶”ë ¤ OpenAI í˜¸í™˜ APIì— ë¬¸ìì—´ë¡œ ë³´ë‚´ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ íë¦„ì„ ì½”ë“œì™€ ê°™ì´ êµ¬ì„±í•˜ë©´ ë°”ë¡œ ìš´ì˜ì— ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p class="chat--user">

openai agent ë¼ëŠ” íŒ¨í‚¤ì§€ê°€ ìˆëŠ”ë° ì—¬ê¸°ì— ê·¸ëŸ° ë ˆì´ì–´ê°€ í¬í•¨ë˜ì–´ìˆë‚˜?

</p>

<p>ì§§ì€ ê²°ë¡ ë¶€í„° ë§í•˜ë©´, â€œopenai agentâ€ë¡œ ì•Œë ¤ì§„ OpenAI Agents SDKëŠ” ì—ì´ì „íŠ¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜(íˆ´ í˜¸ì¶œ, ì„¸ì…˜/ë©”ëª¨ë¦¬, í•¸ë“œì˜¤í”„, ê°€ë“œë ˆì¼ ë“±)ì„ ì œê³µí•˜ì§€ë§Œ PDF íŒŒì‹±Â·ì²­í¬Â·ì„ë² ë”©Â·ë²¡í„°ìŠ¤í† ì–´ ì ì¬ ê°™ì€ â€œë¬¸ì„œ RAG ì¸ì… ë ˆì´ì–´â€ëŠ” ê¸°ë³¸ ë‚´ì¥ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë§Œ OpenAI ëª¨ë¸ì„ ì“¸ ë•ŒëŠ” í˜¸ìŠ¤í‹°ë“œ ë„êµ¬(FileSearchTool ë“±)ë¥¼ í†µí•´ OpenAI Vector Storesì— ì˜¬ë ¤ë‘” ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ëŠ” ë°©ì‹ì€ ì§€ì›í•©ë‹ˆë‹¤. ìì²´ vLLM+gpt-ossë¡œ ëŒë¦´ ë•ŒëŠ” ê·¸ ë ˆì´ì–´ë¥¼ ì§ì ‘ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/">openai.github.io+1</a></p>

<p>í•µì‹¬ í¬ì¸íŠ¸ë¥¼ ì •ë¦¬í•˜ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>SDKê°€ í•´ì£¼ëŠ” ì¼<br />
ì—ì´ì „íŠ¸ ë£¨í”„, í•¨ìˆ˜íˆ´(FunctionTool), ì„¸ì…˜/íŠ¸ë ˆì´ì‹±, í•¸ë“œì˜¤í”„, MCP(Model Context Protocol) ì—°ê²° ë“± â€œì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜â€ì´ ì£¼ì—­í• ì…ë‹ˆë‹¤. PDFë¥¼ ì½ì–´ í…ìŠ¤íŠ¸ë¡œ ë§Œë“¤ê³  ì„ë² ë”©ì„ ë½‘ì•„ ë²¡í„°DBì— ì ì¬í•˜ëŠ” íŒŒì´í”„ë¼ì¸ì€ ì•± ìª½ì—ì„œ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/">openai.github.io+1</a></p>
  </li>
  <li>
    <p>OpenAI í˜¸ìŠ¤í‹°ë“œ ë„êµ¬ê°€ ìˆì„ ë•Œ<br />
OpenAI Responses ëª¨ë¸ì„ ì“°ë©´ FileSearchTool, WebSearchTool, Code Interpreter ê°™ì€ â€œí˜¸ìŠ¤í‹°ë“œ íˆ´â€ì„ ë°”ë¡œ ë¶™ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° PDFëŠ” OpenAI Vector Stores APIë¡œ ì—…ë¡œë“œÂ·ì²˜ë¦¬í•˜ê³ , ì—ì´ì „íŠ¸ëŠ” FileSearchToolë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤. SDK ìì²´ê°€ PDFë¥¼ íŒŒì‹±í•´ì£¼ì§„ ì•Šê³ , ë²¡í„°ìŠ¤í† ì–´ë„ OpenAI ìª½ ë¦¬ì†ŒìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” êµ¬ì„±ì…ë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io</a></p>
  </li>
  <li>
    <p>gpt-oss(+vLLM)ì™€ í•¨ê»˜ ì“°ëŠ” ê²½ìš°<br />
vLLMì˜ OpenAI-í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì—ì´ì „íŠ¸ì˜ ëª¨ë¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë°”ê¿”ì¹˜ê¸° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ ì´ë•ŒëŠ” OpenAI í˜¸ìŠ¤í‹°ë“œ ë„êµ¬(FileSearchTool ë“±)ê°€ ê·¸ëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•Šê±°ë‚˜ ì „ì œê°€ ë°”ë€Œë¯€ë¡œ, ì§ì ‘ í•¨ìˆ˜íˆ´ë¡œ â€œê²€ìƒ‰/RAGâ€ë¥¼ êµ¬í˜„í•˜ê±°ë‚˜ MCP ì„œë²„(ìì²´ ë¬¸ì„œ ê²€ìƒ‰ ì„œë²„)ë¥¼ ë¶™ì—¬ì„œ ë¬¸ì„œ ê²€ìƒ‰ì„ ë…¸ì¶œí•˜ëŠ” íŒ¨í„´ì´ ì¼ë°˜ì ì…ë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm?utm_source=chatgpt.com">cookbook.openai.com+2</a></p>
  </li>
  <li>
    <p>ìµœì†Œ êµ¬í˜„ ìŠ¤ì¼€ì¹˜</p>
  </li>
</ol>

<ul>
  <li>
    <p>PDF ì¸ì…: pypdf/unstructuredë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ ì²­í¬ â†’ ì„ë² ë”©(bge/jina/sentence-transformers) â†’ FAISS/Chroma ì ì¬</p>
  </li>
  <li>
    <p>ì—ì´ì „íŠ¸ íˆ´: search(query) ê°™ì€ Python í•¨ìˆ˜íˆ´ì„ ì •ì˜í•´ top-k ì²­í¬ë¥¼ ë°˜í™˜í•˜ë„ë¡ êµ¬í˜„</p>
  </li>
  <li>
    <p>ì—ì´ì „íŠ¸: Agent(tools=[search])ë¡œ ë“±ë¡, ëª¨ë¸ì€ vLLMì˜ Chat Completions/Responses í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì§€ì •</p>
  </li>
  <li>
    <p>OpenAI ëª¨ë¸ë¡œ ë°”ê¿€ ë•Œë§Œ FileSearchToolì„ ì‚¬ìš©í•´ OpenAI Vector Storeë¥¼ ì¡°íšŒ ê°€ëŠ¥<br />
ì´ êµ¬ì„±ì€ SDK ë¬¸ì„œì˜ â€œToolsâ€, â€œContext managementâ€, â€œMCPâ€ ì„¹ì…˜ íë¦„ê³¼ ë”± ë§ìŠµë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io+2</a></p>
  </li>
</ul>

<ol>
  <li>ì´ë¦„ í˜¼ë™ ì£¼ì˜<br />
Assistants APIëŠ” Responses APIë¡œ ëŒ€ì²´ë˜ëŠ” íë¦„ì´ë©°, Agents SDKëŠ” ì´ Responses ê¸°ë°˜ì—ì„œ ëŒì•„ê°‘ë‹ˆë‹¤. ìµœì‹  ê°€ì´ë“œì™€ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì°¸ê³ í•´ì„œ êµ¬ì„±í•˜ì„¸ìš”. <a href="https://www.reuters.com/technology/artificial-intelligence/openai-launches-new-developer-tools-chinese-ai-startups-gain-ground-2025-03-11/?utm_source=chatgpt.com">reuters.com+1</a></li>
</ol>

<p>ì •ë¦¬</p>

<ul>
  <li>í¬í•¨ë˜ì–´ ìˆëŠ”ê°€? ì—ì´ì „íŠ¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ì€ í¬í•¨, â€œPDFâ†’RAG ì¸ì… ë ˆì´ì–´â€ëŠ” ë¯¸í¬í•¨. OpenAI ëª¨ë¸ì¼ ë•Œë§Œ FileSearchToolë¡œ OpenAI Vector Storesë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŒ. vLLM+gpt-ossì—ì„œëŠ” ì§ì ‘ í•¨ìˆ˜íˆ´ì´ë‚˜ MCPë¡œ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io+1</a></li>
</ul>

<p>ì›í•˜ì‹œë©´ ì§€ê¸ˆ ì“°ì‹œëŠ” vLLM ì„œë²„ ì£¼ì†Œì™€ ì„ í˜¸ ì„ë² ë”©/ë²¡í„°DBë¥¼ ê°€ì •í•´, Agents SDKìš© ìµœì†Œ ì˜ˆì œ(í•¨ìˆ˜íˆ´ ê¸°ë°˜ ê²€ìƒ‰ + vLLM ì—°ê²°) ìŠ¤ë‹ˆí«ì„ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦½ë‹ˆë‹¤.</p>

<p class="chat--user">

openai vector storeëŠ” ì–´ë–¤ì‹ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ìˆì–´?

</p>

<p>ì¢‹ì•„ìš” â€” â€œOpenAI Vector Storeâ€ê°€ ëŒ€ì²´ë¡œ ì–´ë–»ê²Œ êµ¬ì„±ë˜ì–´ ìˆëŠ”ì§€(=ì•„í‚¤í…ì²˜, ì£¼ìš” ì»´í¬ë„ŒíŠ¸, API íë¦„) ê°™ì´ ì‚´í´ë´…ì‹œë‹¤. (ì•½ê°„ ê¸°ìˆ ì ì´ê¸´ í•˜ì§€ë§Œ, ì „ì²´ ê·¸ë¦¼ì„ ì´í•´í•˜ë©´ ì´í›„ êµ¬í˜„í•  ë•Œ í›¨ì”¬ ìˆ˜ì›”í•´ìš”.)</p>

<hr />

<h2 id="1-ê¸°ë³¸-ê°œë…">1. ê¸°ë³¸ ê°œë…</h2>

<p>Vector StoreëŠ” ê°„ë‹¨íˆ ë§í•´ â€œë¬¸ì„œ/ì²­í¬(í…ìŠ¤íŠ¸ ë‹¨ìœ„)ë¥¼ ì„ë² ë”© ë²¡í„°ë¡œ ë³€í™˜í•´ ì €ì¥í•˜ê³ , ì´í›„ ê²€ìƒ‰ ê°€ëŠ¥í•˜ë„ë¡ ì¡°íšŒí•˜ëŠ” ì €ì¥ì†Œâ€ì…ë‹ˆë‹¤. OpenAI ìª½ì—ì„œ ì œê³µí•˜ëŠ” APIëŠ” ë¬¸ì„œë¥¼ ì—…ë¡œë“œ â†’ ì„ë² ë”©/ì²­í¬í™”(ë‚´ë¶€ ì²˜ë¦¬) â†’ ë²¡í„°ì €ì¥ì†Œ ìƒì„± ë° íŒŒì¼ ë°”ì¸ë”© â†’ ê²€ìƒ‰ ì§ˆì˜(Query) â†’ ê´€ë ¨ ì²­í¬ ë°˜í™˜í•˜ëŠ” íë¦„ì„ ì§€ì›í•©ë‹ˆë‹¤. <a href="https://platform.openai.com/docs/assistants/tools/file-search/vector-stores?utm_source=chatgpt.com">platform.openai.com+3</a></p>

<p>ì¦‰, ë‚´ë¶€ì ìœ¼ë¡œëŠ” ë‹¤ìŒ ìš”ì†Œë“¤ì´ ìˆìŠµë‹ˆë‹¤:</p>

<ul>
  <li>
    <p>ë¬¸ì„œ íŒŒì¼(ì˜ˆ: PDF, í…ìŠ¤íŠ¸) ì—…ë¡œë“œ ë° ì²˜ë¦¬ëœ íŒŒì¼ ë°°ì¹˜(file batch)</p>
  </li>
  <li>
    <p>ë²¡í„° ë³€í™˜(ì„ë² ë”©) + ì²­í¬(metadata í¬í•¨)</p>
  </li>
  <li>
    <p>ì €ì¥ì†Œ(Vector store) ê°ì²´: ì—¬ëŸ¬ íŒŒì¼/ì²­í¬ë“¤ì„ ë¬¶ìŒ</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ API: ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜ ì¡°íšŒ â†’ ë°˜í™˜ëœ ì²­í¬ì™€ ë©”íƒ€ì •ë³´</p>
  </li>
</ul>

<hr />

<h2 id="2-openai-api-ìƒì˜-êµ¬ì„±-ìš”ì†Œ">2. OpenAI API ìƒì˜ êµ¬ì„± ìš”ì†Œ</h2>

<p>OpenAI ë¬¸ì„œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ìš” ë¦¬ì†ŒìŠ¤(resource)ë“¤ì´ ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ”ì§€ìš”:</p>

<ul>
  <li>
    <p><strong>Vector Store ë¦¬ì†ŒìŠ¤</strong> : <code class="language-plaintext highlighter-rouge">/v1/vector_stores</code> ì—”ë“œí¬ì¸íŠ¸ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŒ. <a href="https://platform.openai.com/docs/api-reference/vector-stores?utm_source=chatgpt.com">platform.openai.com+1</a></p>
  </li>
  <li>
    <p><strong>íŒŒì¼ ë°°ì¹˜(File Batches)</strong> : ì—…ë¡œë“œëœ íŒŒì¼ì´ ì²­í¬/ë²¡í„°í™”ë˜ì–´ ì €ì¥ë˜ëŠ” ë‹¨ìœ„. <code class="language-plaintext highlighter-rouge">/v1/vector_stores/{vector_store_id}/file_batches</code> ê°™ì€ êµ¬ì¡° ìˆìŒ. <a href="https://platform.openai.com/docs/api-reference/vector-stores-file-batches?utm_source=chatgpt.com">platform.openai.com</a></p>
  </li>
  <li>
    <p><strong>íŒŒì¼(íŒŒì¼ ì—…ë¡œë“œ)</strong> : <code class="language-plaintext highlighter-rouge">/v1/vector_stores/{vs_id}/files</code> ì—”ë“œí¬ì¸íŠ¸ì—ì„œ íŒŒì¼ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŒ. <a href="https://platform.openai.com/docs/api-reference/vector-stores-files?utm_source=chatgpt.com">platform.openai.com</a></p>
  </li>
  <li>
    <p><strong>ê²€ìƒ‰(Search)</strong> : ì €ì¥ëœ Vector Storeì— ëŒ€í•´ â€œìœ ì‚¬ë²¡í„° ê¸°ë°˜ ê²€ìƒ‰â€ì„ ìš”ì²­ ê°€ëŠ¥ (ì˜ˆ: íŒŒì¼ ê²€ìƒ‰, ì²­í¬ ê²€ìƒ‰) <a href="https://platform.openai.com/docs/assistants/tools/file-search/vector-stores?utm_source=chatgpt.com">platform.openai.com+1</a></p>
  </li>
</ul>

<hr />

<h2 id="3-íë¦„-ì˜ˆì‹œë¡œ-ë³´ê¸°">3. íë¦„ ì˜ˆì‹œë¡œ ë³´ê¸°</h2>

<p>ì•„ë˜ì²˜ëŸ¼ ë‹¨ê³„ë³„ êµ¬ì„±ë©ë‹ˆë‹¤:</p>

<ol>
  <li>
    <p>íŒŒì¼ ì—…ë¡œë“œ</p>

    <ul>
      <li>ì˜ˆ: PDFë¥¼ ì—…ë¡œë“œ â†’ OpenAI ì¸¡ì—ì„œ ìë™ìœ¼ë¡œ ì²­í¬í™”/ì„ë² ë”©/ì €ì¥ ì¤€ë¹„ â†’ íŒŒì¼ ë°°ì¹˜ ìƒì„±</li>
    </ul>
  </li>
  <li>
    <p>Vector Store ìƒì„±</p>

    <ul>
      <li>ì €ì¥ì†Œ ì´ë¦„, ì„¤ëª… ë“±ì˜ ë©”íƒ€ë°ì´í„° ì œê³µ â†’ ìƒì„±</li>
    </ul>
  </li>
  <li>
    <p>íŒŒì¼ì„ Vector Storeì— ë°”ì¸ë”©(=íŒŒì¼ ì¶”ê°€)</p>

    <ul>
      <li>ìƒì„±í•œ Vector Store IDì— íŒŒì¼ ë°°ì¹˜/íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” API í˜¸ì¶œ</li>
    </ul>
  </li>
  <li>
    <p>ê²€ìƒ‰ ìš”ì²­</p>

    <ul>
      <li>
        <p>ì‚¬ìš©ìê°€ ì§ˆì˜(query)ë¥¼ ë³´ë‚´ë©´, APIëŠ” ì„ë² ë”© ìƒì„± â†’ ì €ì¥ëœ ë²¡í„°ë“¤ê³¼ ìœ ì‚¬ë„ ë¹„êµ â†’ ê´€ë ¨ ì²­í¬ ë°˜í™˜</p>
      </li>
      <li>
        <p>ë°˜í™˜ëœ ì²­í¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ë‹µ ìƒì„±(LLM í˜¸ì¶œ ì „ì²˜ë¦¬ ì—­í• )</p>
      </li>
    </ul>
  </li>
  <li>
    <p>LLM í˜¸ì¶œ(ë³„ë„)</p>

    <ul>
      <li>ê²€ìƒ‰ëœ ì²­í¬ëŠ” LLM(ì˜ˆ: gpt-ëª¨ë¸)ì— ì»¨í…ìŠ¤íŠ¸ë¡œ ì „ë‹¬ â†’ ë‹µë³€ ìƒì„±</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="4-ì£¼ìš”-íŠ¹ì„±-ë°-í•œê³„">4. ì£¼ìš” íŠ¹ì„± ë° í•œê³„</h2>

<ul>
  <li>
    <p>íŒŒì¼/ë¬¸ì„œ ë©”íƒ€ë°ì´í„°ëŠ” ë¹„êµì  ì œí•œì : ì—…ë¡œë“œëœ íŒŒì¼ì´ ì–¼ë§ˆë‚˜ ê¸´ì§€(token count, char count) ë“±ì˜ ì •ë³´ ë¶€ì¡±í•˜ë‹¤ëŠ” ì‚¬ìš©ìì˜ í”¼ë“œë°±ì´ ìˆìŒ. <a href="https://www.reddit.com/r/OpenAI/comments/1lacgqe/openais_vector_store_api_is_missing_basic/?utm_source=chatgpt.com">Reddit</a></p>
  </li>
  <li>
    <p>ì²­í¬í™” + ì„ë² ë”© + ì €ì¥/ê´€ë¦¬ ê³¼ì •ì„ â€œì‚¬ìš©ìì œì–´â€ í•˜ë ¤ë©´ OpenAI í˜¸ìŠ¤í‹°ë“œ ê¸°ëŠ¥ë³´ë‹¤ëŠ” ìì²´ ë²¡í„°DB + ì„ë² ë”© ì›Œí¬í”Œë¡œìš°ê°€ ë” ìœ ì—°í•¨</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ í’ˆì§ˆì€ ì„ë² ë”© ëª¨ë¸(ì–´ë–¤ ëª¨ë¸ì„ ì¼ëŠ”ê°€) + ì²­í¬ ë‹¨ìœ„/ë¬¸ì„œ êµ¬ì¡° ì„¤ê³„ì— í¬ê²Œ ì¢Œìš°ë¨</p>
  </li>
</ul>

<hr />

<h2 id="5-gpt-ossvllm-í™œìš©-ì‹œ-ê³ ë ¤ì‚¬í•­">5. gpt-oss/vLLM í™œìš© ì‹œ ê³ ë ¤ì‚¬í•­</h2>

<p>ë‹¹ì‹ ì´ vLLM + gpt-oss ì¡°í•©ìœ¼ë¡œ ì“°ëŠ” ìƒí™©ì´ë¼ë©´, OpenAI Vector Store APIë¥¼ ê·¸ëŒ€ë¡œ ì˜ì¡´í•˜ê¸°ë³´ë‹¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë³€í˜•ì´ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”:</p>

<ul>
  <li>
    <p>OpenAI Vector Store APIë¥¼ ì“°ê³  ì‹¶ìœ¼ë©´ OpenAI ì¸ì¦/ìš”ê¸ˆ/í˜¸ìŠ¤íŒ… êµ¬ì¡° ë”°ë¼ì•¼ í•¨</p>
  </li>
  <li>
    <p>ë˜ëŠ” ìì²´ ë²¡í„°DB(ì˜ˆ: FAISS, Milvus ë“±) + ì„ë² ë”© ëª¨ë¸ + ê²€ìƒ‰ í•¨ìˆ˜íˆ´ì„ ë§Œë“¤ì–´ì„œ â€œìœ ì‚¬ ê¸°ëŠ¥â€ì„ êµ¬í˜„</p>
  </li>
  <li>
    <p>Agents SDKë‚˜ ì›Œí¬í”Œë¡œìš°ì—ì„œëŠ” â€œê²€ìƒ‰ íˆ´(tool)â€ì´ ì´ ì €ì¥ì†Œì™€ ì—°ê²°ë¨: ì‚¬ìš©ìê°€ ì§ˆì˜í•˜ë©´ ê²€ìƒ‰íˆ´ì´ ê´€ë ¨ ì²­í¬ë¥¼ êº¼ë‚´ì˜¤ê³ , LLMì—ê²Œ ë¬¸ë§¥ìœ¼ë¡œ ì œê³µ</p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ì‹œë‹¤ë©´, OpenAI Vector Store APIë¥¼ ì‹¤ì œë¡œ í˜¸ì¶œí•˜ëŠ” ì˜ˆì œ ì½”ë“œ(Python) ë§Œë“¤ì–´ ë“œë¦´ ìˆ˜ ìˆì–´ìš”â€”íŠ¹íˆ íŒŒì¼ ì—…ë¡œë“œ â†’ ê²€ìƒ‰ê¹Œì§€ íë¦„. ê·¸ë ‡ê²Œ í• ê¹Œìš”?</p>

<p class="chat--user">

ë§ˆì§€ë§‰ì— ë§í•œ ê²€ìƒ‰íˆ´ì€ ìë™ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ê±´ì§€ llmì´ ìš”ì²­í•˜ë©´ ë™ì‘í•˜ëŠ”ê±´ì§€ ê¶ê¸ˆí•´

</p>

<p>ì•„ì£¼ í•µì‹¬ì„ ì§šìœ¼ì…¨ìŠµë‹ˆë‹¤.<br />
OpenAIì˜ â€œê²€ìƒ‰ íˆ´(FileSearchTool)â€ì€ <strong>ìë™ìœ¼ë¡œ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</strong>.<br />
LLMì´ â€œí•„ìš”í•˜ë‹¤ê³  íŒë‹¨í•  ë•Œâ€ â€” ì¦‰, <strong>ëª¨ë¸ì´ íˆ´ í˜¸ì¶œì„ ìƒì„±í•˜ë©´</strong> â€” ê·¸ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>

<p>ì´ê±¸ ì¡°ê¸ˆ ë” ì„¸ë°€í•˜ê²Œ ëœ¯ì–´ë³´ë©´ ì´ë ‡ê²Œ ë©ë‹ˆë‹¤.</p>

<hr />

<h3 id="1-ì—ì´ì „íŠ¸ì˜-ê¸°ë³¸-êµ¬ì¡°">1. ì—ì´ì „íŠ¸ì˜ ê¸°ë³¸ êµ¬ì¡°</h3>

<p>OpenAI Agents SDK(í˜¹ì€ Responses API)ì—ì„œ ì—ì´ì „íŠ¸ëŠ” ë‹¤ìŒ ë‘ ê°€ì§€ë¥¼ ê°–ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>
    <p><strong>LLM ëª¨ë¸</strong> : gpt-4o, gpt-4o-mini ë“±</p>
  </li>
  <li>
    <p><strong>íˆ´(tool)</strong> : í•¨ìˆ˜ í˜¸ì¶œ(Function Tool), FileSearchTool, WebSearchTool, CodeInterpreter ë“±</p>
  </li>
</ul>

<p>ì—ì´ì „íŠ¸ëŠ” LLMì—ê²Œ â€œë„ˆëŠ” ì´ëŸ° íˆ´ë“¤ì„ ì“¸ ìˆ˜ ìˆë‹¤â€ê³  ì•Œë ¤ì£¼ê³ ,<br />
ëŒ€í™” ì¤‘ì— LLMì´ íŒë‹¨í•´ íŠ¹ì • íˆ´ì„ í˜¸ì¶œí•  ë•Œë§Œ ì‹¤ì œ ì‹¤í–‰ ë¡œì§ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.</p>

<hr />

<h3 id="2-íˆ´-í˜¸ì¶œ-ê³¼ì •">2. íˆ´ í˜¸ì¶œ ê³¼ì •</h3>

<p>ëª¨ë¸ì´ ë‚´ë¶€ì ìœ¼ë¡œ ì´ëŸ° êµ¬ì¡°ì˜ ì‘ë‹µì„ ëƒ…ë‹ˆë‹¤.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function_call"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"arguments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ê³„ì•½ì„œ ìš”ì•½"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>SDKëŠ” ì´ê±¸ ê°ì§€í•˜ê³  <strong>search() í•¨ìˆ˜</strong> (í˜¹ì€ FileSearchTool)ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.<br />
ê·¸ ê²°ê³¼ë¥¼ ë°›ì•„ ëª¨ë¸ì—ê²Œ ë‹¤ì‹œ ì „ë‹¬í•˜ë©´, ëª¨ë¸ì€ ê·¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ <strong>ìµœì¢… ë‹µë³€</strong> ì„ ë§Œë“­ë‹ˆë‹¤.</p>

<p>ì¦‰, LLMì´ íˆ´ ì‚¬ìš©ì„ â€œê²°ì •â€í•˜ê³ , í˜¸ì¶œì€ SDKê°€ â€œëŒ€ë¦¬ ì‹¤í–‰â€í•©ë‹ˆë‹¤.</p>

<hr />

<h3 id="3-ìë™ì„±ê³¼-ììœ¨ì„±ì˜-ì •ë„">3. ìë™ì„±ê³¼ ììœ¨ì„±ì˜ ì •ë„</h3>

<ul>
  <li>
    <p><strong>ìë™ ì‹¤í–‰ ì•„ë‹˜</strong> : ì‚¬ìš©ìê°€ â€œê²€ìƒ‰ì„ ê¼­ í•˜ë¼â€ê³  ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´, ëª¨ë¸ì´ ë¬¸ë§¥ìƒ í•„ìš”í•˜ë‹¤ê³  íŒë‹¨í•´ì•¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í”„ë¡¬í”„íŠ¸ ì„¤ê³„ ê°€ëŠ¥</strong> : system prompt ì— â€œíŒŒì¼ ë‚´ìš©ì„ ì°¸ì¡°í•  ë•ŒëŠ” í•­ìƒ FileSearchToolì„ ì‚¬ìš©í•˜ë¼â€ì²˜ëŸ¼ ëª…ì‹œí•´ ì£¼ë©´ í˜¸ì¶œ í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>Agent Loop</strong> : SDKê°€ ì´ ê³¼ì •ì„ ìë™ ë°˜ë³µí•´ì¤ë‹ˆë‹¤. ëª¨ë¸ì´ íˆ´ í˜¸ì¶œ â†’ ì‹¤í–‰ â†’ ê²°ê³¼ ì „ë‹¬ â†’ ë‹¤ì‹œ ëª¨ë¸ í˜¸ì¶œ â€¦ ìµœì¢… ë‹µë³€ì´ ì™„ì„±ë  ë•Œê¹Œì§€ ë£¨í”„ë¥¼ ë•ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h3 id="4-ì˜ˆì‹œë¡œ-ë³´ëŠ”-íë¦„">4. ì˜ˆì‹œë¡œ ë³´ëŠ” íë¦„</h3>

<p>ì‚¬ìš©ì: â€œì´ ê³„ì•½ì„œ ìš”ì•½í•´ì¤˜.â€</p>

<ol>
  <li>
    <p>ëª¨ë¸ì€ FileSearchToolì´ ë“±ë¡ë˜ì–´ ìˆìŒì„ ì•Œê³  ìˆìŒ.</p>
  </li>
  <li>
    <p>LLMì´ ë‚´ë¶€ì ìœ¼ë¡œ íŒë‹¨: â€œíŒŒì¼ì—ì„œ ë‚´ìš© ê°€ì ¸ì™€ì•¼ í•˜ë„¤.â€</p>
  </li>
  <li>
    <p>LLM â†’ <code class="language-plaintext highlighter-rouge">function_call: file_search(query="ê³„ì•½ì„œ ìš”ì•½")</code></p>
  </li>
  <li>
    <p>SDK â†’ ì‹¤ì œ Vector Store ê²€ìƒ‰ ìˆ˜í–‰</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ ê²°ê³¼ë¥¼ ëª¨ë¸ì—ê²Œ ë‹¤ì‹œ ì…ë ¥</p>
  </li>
  <li>
    <p>ëª¨ë¸ â†’ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ìš”ì•½í•œ ìµœì¢… ë‹µë³€ ìƒì„±</p>
  </li>
</ol>

<hr />

<h3 id="5-vllm--gpt-oss-ì¡°í•©ì—ì„œëŠ”">5. vLLM + gpt-oss ì¡°í•©ì—ì„œëŠ”</h3>

<p>vLLMì€ OpenAIì˜ Responses API ë‚´ë¶€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤.<br />
ë”°ë¼ì„œ â€œìë™ íˆ´ í˜¸ì¶œâ€ì„ êµ¬í˜„í•˜ë ¤ë©´ SDKê°€ í•„ìš”í•©ë‹ˆë‹¤.<br />
ì§ì ‘ ì„œë²„ë‚˜ ì—ì´ì „íŠ¸ ë£¨í”„ë¥¼ ë§Œë“¤ê³ , ëª¨ë¸ì˜ í•¨ìˆ˜ í˜¸ì¶œ ê²°ê³¼(JSON)ë¥¼ í•´ì„í•´ ìˆ˜ë™ìœ¼ë¡œ â€œsearch() â†’ ê²°ê³¼ â†’ ëª¨ë¸ ì¬í˜¸ì¶œâ€ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<hr />

<p>ì •ë¦¬í•˜ìë©´:<br />
<strong>FileSearchToolì€ ëª¨ë¸ì´ í•„ìš”í•˜ë‹¤ê³  íŒë‹¨í•  ë•Œë§Œ í˜¸ì¶œë˜ê³ , SDKê°€ ì‹¤í–‰ì„ ì¤‘ê³„í•©ë‹ˆë‹¤.</strong><br />
ì¦‰, â€œëª¨ë¸ì´ ìš”ì²­í•˜ë©´ ìë™ìœ¼ë¡œ ë™ì‘í•œë‹¤â€ëŠ” í‘œí˜„ì´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.</p>

<p>ë‹¤ìŒ ë‹¨ê³„ë¡œ, ì›í•˜ì‹ ë‹¤ë©´ vLLM + gpt-oss ì¡°í•©ì—ì„œ ì´ â€œíˆ´ í˜¸ì¶œ ë£¨í”„â€ë¥¼ í‰ë‚´ë‚´ëŠ” ìµœì†Œ ì˜ˆì œ(ëª¨ë¸ â†’ function_call â†’ search â†’ ì¬í˜¸ì¶œ)ë¥¼ ë§Œë“¤ì–´ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p class="chat--user">

ì˜ì–´ë¡œ ì‘ì„±ëœ ë¬¸ì„œ ragë¥¼ í•œê¸€ë¡œ ì¿¼ë¦¬í•  ìˆ˜ ìˆì–´?

</p>

<p>ê°€ëŠ¥í•©ë‹ˆë‹¤. ë°©ë²•ì€ í¬ê²Œ ë‘ ê°€ì§€ ê³„ì—´ì…ë‹ˆë‹¤. í•œê¸€ ì¿¼ë¦¬ â†’ ì˜ì–´ ë¬¸ì„œ RAGë¥¼ ì§€ì›í•˜ë ¤ë©´ â€œë‹¤êµ­ì–´ ì„ë² ë”©â€ì„ ì“°ê±°ë‚˜ â€œë²ˆì—­ ë ˆì´ì–´â€ë¥¼ ë¼ìš°ë©´ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>ë‹¤êµ­ì–´ ì„ë² ë”©ìœ¼ë¡œ ì§ì ‘ ê²€ìƒ‰</li>
</ol>

<ul>
  <li>
    <p>í•µì‹¬: ì˜ì–´ ë¬¸ì„œ ì²­í¬ì™€ í•œêµ­ì–´ ì¿¼ë¦¬ë¥¼ ê°™ì€ ì„ë² ë”© ê³µê°„ìœ¼ë¡œ ë§¤í•‘.</p>
  </li>
  <li>
    <p>ëª¨ë¸ ì˜ˆ: bge-m3, e5-multilingual, LaBSE, mContriever ë“±.</p>
  </li>
  <li>
    <p>ì¥ì : ë²ˆì—­ ì—†ì´ë„ ê°œë… ë§ì¶¤. ê³ ìœ ëª…ì‚¬Â·ì „ë¬¸ìš©ì–´ì— ê°•í•¨.</p>
  </li>
  <li>
    <p>ë‹¨ì : ì„ë² ë”© í’ˆì§ˆÂ·ì°¨ì› ìˆ˜ê°€ ì»¤ì„œ ë©”ëª¨ë¦¬â†‘. ì˜ì–´ ì „ìš© ì„ë² ë”© ëŒ€ë¹„ ì•½ê°„ì˜ ì •ë°€ë„ ì†ì‹¤ì´ ìˆì„ ìˆ˜ ìˆìŒ.</p>
  </li>
</ul>

<ol>
  <li>ë²ˆì—­ í›„ ê²€ìƒ‰(translate-then-retrieve)</li>
</ol>

<ul>
  <li>
    <p>íŒŒì´í”„ë¼ì¸: í•œê¸€ ì¿¼ë¦¬ â†’ ì˜ì–´ë¡œ ë²ˆì—­ â†’ ì˜ì–´ ì „ìš© ì„ë² ë”©(ì˜ˆ: e5-large, bge-large-en ë“±)ìœ¼ë¡œ ê²€ìƒ‰ â†’ ë‹µë³€ì€ í•œê¸€ë¡œ ìƒì„±.</p>
  </li>
  <li>
    <p>ì¥ì : ì˜ì–´ ì „ìš© ì„ë² ë”©/ë¦¬ë­ì»¤ í’ˆì§ˆì„ ê·¸ëŒ€ë¡œ í™œìš© ê°€ëŠ¥.</p>
  </li>
  <li>
    <p>ë‹¨ì : ë²ˆì—­ ì˜¤ë¥˜ê°€ ì¿¼ë¦¬ì˜ í•µì‹¬ í† í”½ì„ ë¹„íŠ¸ëŠ” ê²½ìš°ê°€ ìˆìŒ. ì—”í‹°í‹°(ì œí’ˆëª…, í‘œê¸°) ì£¼ì˜.</p>
  </li>
</ul>

<p>ê¶Œì¥ ì„¤ê³„(í˜„ì—… ì•ˆì •íŒ)</p>

<ul>
  <li>
    <p>ì¸ë±ì‹±: ì˜ì–´ ë¬¸ì„œë¥¼ ë¬¸ë‹¨/ë¬¸ì¥ ë‹¨ìœ„ë¡œ ì²­í¬, ë©”íƒ€ë°ì´í„°(í˜ì´ì§€, ì„¹ì…˜, ì–¸ì–´=en) ì €ì¥.</p>
  </li>
  <li>
    <p>ì„ë² ë”©: ë‹¤êµ­ì–´ ì„ë² ë”© ì¸ë±ìŠ¤ 1ê°œëŠ” ë°˜ë“œì‹œ êµ¬ì¶•. ì—¬ë ¥ì´ ë˜ë©´ ì˜ì–´ ì „ìš© ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€ë¡œ êµ¬ì„±í•´ ë“€ì–¼ ì¸ë±ìŠ¤ ê²€ìƒ‰.</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ ì „ëµ: í•œê¸€ ì¿¼ë¦¬ì— ëŒ€í•´</p>

    <ol>
      <li>
        <p>ë‹¤êµ­ì–´ ì¸ë±ìŠ¤ì—ì„œ top-k</p>
      </li>
      <li>
        <p>ì˜ì–´ ì „ìš© ì¸ë±ìŠ¤(ì¿¼ë¦¬ ë²ˆì—­)ì—ì„œë„ top-k</p>
      </li>
      <li>
        <p>ë‘ ê²°ê³¼ë¥¼ ì ìˆ˜ ì •ê·œí™” í›„ ë³‘í•©</p>
      </li>
    </ol>
  </li>
  <li>
    <p>ë¦¬ë­í‚¹: ë‹¤êµ­ì–´ ë¦¬ë­ì»¤(bge-reranker-v2-m3 ê°™ì€ ë²”ìš© ë‹¤êµ­ì–´ ë¦¬ë­ì»¤)ë¡œ ìƒìœ„ 50â†’10 ì¬ì •ë ¬.</p>
  </li>
  <li>
    <p>í•˜ì´ë¸Œë¦¬ë“œ: BM25(í‚¤ì›Œë“œ) + ë²¡í„° ì ìˆ˜ ê°€ì¤‘ í‰ê· . ê³ ìœ ëª…ì‚¬ ë§¤ì¹­ ê°•í™”.</p>
  </li>
  <li>
    <p>ìƒì„±: gpt-oss(vLLM)ì— â€œì¶œì²˜ í‘œì‹œ, ì˜ì–´ ì¸ìš©ë¬¸ì€ ì›ë¬¸ ìœ ì§€, ìµœì¢… ë‹µë³€ì€ í•œêµ­ì–´â€ë¥¼ ì‹œìŠ¤í…œ ê·œì¹™ìœ¼ë¡œ ì£¼ì….</p>
  </li>
</ul>

<p>ê°„ë‹¨ íŒŒì´í”„ë¼ì¸ ì˜ˆì‹œ(í•µì‹¬ ë¡œì§ë§Œ)</p>

<ul>
  <li>
    <p>ì¸ë±ì‹±</p>

    <ol>
      <li>
        <p>PDF â†’ í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ ì²­í¬</p>
      </li>
      <li>
        <p>multilingual_embed(chunks) â†’ FAISS/Chroma/PGVectorì— ì €ì¥</p>
      </li>
      <li>
        <p>ì„ íƒ: english_embed(chunks)ë¡œ ì˜ì–´ ì „ìš© ì¸ë±ìŠ¤ë„ ë³‘í–‰ êµ¬ì¶•</p>
      </li>
    </ol>
  </li>
  <li>
    <p>ì§ˆì˜</p>

    <ol>
      <li>
        <p>ko_query â†’ multilingual_embed(ko_query)ë¡œ ê²€ìƒ‰</p>
      </li>
      <li>
        <p>ko_query â†’ en_queryë¡œ ë²ˆì—­ â†’ english_embed(en_query)ë¡œ ê²€ìƒ‰</p>
      </li>
      <li>
        <p>ê²°ê³¼ ë³‘í•© â†’ ë‹¤êµ­ì–´ ë¦¬ë­í‚¹</p>
      </li>
      <li>
        <p>ìƒìœ„ nê°œë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ vLLMì— ë„£ê³  í•œêµ­ì–´ë¡œ ë‹µë³€ ìƒì„±</p>
      </li>
    </ol>
  </li>
</ul>

<p>í”„ë¡¬í”„íŠ¸ íŒ</p>

<ul>
  <li>
    <p>ì‹œìŠ¤í…œ ê·œì¹™ì— â€œë¬¸í—Œì€ ì˜ì–´ ì›ë¬¸ì„ ê·¸ëŒ€ë¡œ ì¸ìš©, ì„¤ëª…ì€ í•œêµ­ì–´ë¡œ ì‘ì„±, ì¶œì²˜ í˜ì´ì§€/ì„¹ì…˜ì„ í•¨ê»˜ ì ì‹œâ€ë¥¼ ëª…ì‹œ.</p>
  </li>
  <li>
    <p>ë‹¤êµ­ì–´ í˜¼ìš© ë¬¸ì„œì¼ ê²½ìš° â€œì–¸ì–´ ê°ì§€ â†’ ì¿¼ë¦¬ì™€ ë‹¤ë¥¸ ì–¸ì–´ë¼ë„ ë™ì¼ ê°œë…ì´ë©´ í¬í•¨â€ ê°™ì€ ì§€ì¹¨ì„ ì¶”ê°€.</p>
  </li>
</ul>

<p>ì‹¤ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸</p>

<ul>
  <li>
    <p>í† í¬ë‚˜ì´ì € ê¸¸ì´: ì²­í¬ëŠ” 200~400í† í°(ë¬¸ë‹¨ ê²½ê³„ ìœ ì§€).</p>
  </li>
  <li>
    <p>ë©”íƒ€ë°ì´í„°: page, section, filename, lang. ë‹µë³€ì— ê·¼ê±° í‘œì‹œ ìš©ì´.</p>
  </li>
  <li>
    <p>ê³ ìœ ëª…ì‚¬: ëŒ€ì†Œë¬¸ìÂ·í•˜ì´í”ˆÂ·ìŠ¤ë„¤ì´í¬ì¼€ì´ìŠ¤ ë³´ì¡´. ì •ê·œí™” ê³¼ë„í•˜ê²Œ í•˜ì§€ ì•Šê¸°.</p>
  </li>
  <li>
    <p>ìºì‹±: ë¹ˆë²ˆí•œ ì¿¼ë¦¬ ë²ˆì—­/ì„ë² ë”© ê²°ê³¼ ìºì‹œ.</p>
  </li>
  <li>
    <p>í‰ê°€: í•œ-ì˜ ìŒìœ¼ë¡œ ì§ˆì˜â€“ì •ë‹µ ê³¨ë“œì…‹ì„ ë§Œë“¤ì–´ MRR@n, Hit@n, nDCGë¡œ ë¹„êµ.</p>
  </li>
</ul>

<p>vLLM + gpt-oss ì—°ê²° í¬ì¸íŠ¸</p>

<ul>
  <li>
    <p>ìœ„ ê²€ìƒ‰ ê²°ê³¼(top-k ì²­í¬)ë¥¼ user ë©”ì‹œì§€ì— CONTEXTë¡œ ë„£ê³  ì§ˆë¬¸ì€ í•œêµ­ì–´ë¡œ ì „ë‹¬.</p>
  </li>
  <li>
    <p>ë‹µë³€ì€ í•œêµ­ì–´ë¡œ ê°•ì œ, í•„ìš”í•œ ë¶€ë¶„ë§Œ ì˜ì–´ ì›ë¬¸ ì¸ìš©.</p>
  </li>
  <li>
    <p>í•¨ìˆ˜íˆ´(ì˜ˆ: search_docs)ì„ í•œ ê°œ ì œê³µí•´ â€œëª¨ë¸ì´ í•„ìš” ì‹œ í˜¸ì¶œâ€í•˜ë„ë¡í•˜ë©´ ìë™ ë£¨í”„(ì—ì´ì „íŠ¸ ìŠ¤íƒ€ì¼)ë„ ì¬í˜„ ê°€ëŠ¥.</p>
  </li>
</ul>

<p>ìš”ì•½</p>

<ul>
  <li>ê°€ëŠ¥í•˜ê³ , ì‹¤ì „ì—ì„œëŠ” â€œë‹¤êµ­ì–´ ì„ë² ë”© + ë²ˆì—­ ë³‘í–‰ + ë¦¬ë­í‚¹â€ì´ ì•ˆì •ì ì…ë‹ˆë‹¤. ì´ë¯¸ êµ¬ì¶•ëœ ì˜ì–´ ì½”í¼ìŠ¤ì— ìµœì†Œ ë³€ê²½ìœ¼ë¡œ í•œê¸€ ì§ˆì˜ë¥¼ ë¶™ì¼ ìˆ˜ ìˆê³ , gpt-oss ì„œë¹™ê³¼ë„ ì˜ ë§ìŠµë‹ˆë‹¤.</li>
</ul>

<p class="chat--user">

ì•„ ê·¸ë¦¬ê³  ì•„ê¹Œ search functionì„ ë§Œë“ ë‹¤ê³  í–ˆì–ì•„. ê·¸ í•¨ìˆ˜ëŠ” ëª¨ë“  RAG ë¬¸ì„œë¥¼ ë‹¤ ë’¤ì ¸ ì•„ë‹ˆë©´ ë¬¸ì„œê°€ ë§Œì•½ 100ê°œ ë“±ë¡ëë‹¤ê³  ì¹˜ë©´ ê°€ì¥ ê´€ë ¨ëœ 10ê°œë§Œ ì¶”ë ¤ì„œ 10ê°œì— ëŒ€í•œ ë§¤ì¹­ë§Œ í•´?

</p>

<p>ì§§ê²Œ í•µì‹¬ë¶€í„°: ì˜ ë§Œë“  search í•¨ìˆ˜ëŠ” â€œì „ë¶€ ë’¤ì§€ê¸°â€ê°€ ì•„ë‹ˆë¼ ë³´í†µ 2ë‹¨ê³„ë¡œ ì¢í™ë‹ˆë‹¤. 1ë‹¨ê³„ì—ì„œ ë¬¸ì„œ ë ˆë²¨ë¡œ ìƒìœ„ Nê°œë¥¼ ê³ ë¥´ê³ , 2ë‹¨ê³„ì—ì„œ ê·¸ ë¬¸ì„œë“¤ ì•ˆì—ì„œ ì²­í¬ ë ˆë²¨ë¡œ ìƒìœ„ Kê°œë§Œ ë½‘ì•„ LLMì— ë„£ìŠµë‹ˆë‹¤. ë³´í¸ê°’ì€ Nâ‰ˆ5~20, Kâ‰ˆ3~8, ê·¸ë¦¬ê³  ìµœì¢… ì»¨í…ìŠ¤íŠ¸ í† í° ìƒí•œìœ¼ë¡œ ì»·ì„ ê²ë‹ˆë‹¤.</p>

<p>ì•„í‚¤í…ì²˜ë¥¼ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•´ë³¼ê²Œìš”.</p>

<ol>
  <li>ì»¬ë ‰ì…˜ê³¼ ì¸ë±ìŠ¤</li>
</ol>

<ul>
  <li>
    <p>ë¬¸ì„œ 100ê°œê°€ ë“±ë¡ë˜ì–´ ìˆë‹¤ë©´ ìš°ì„  ì „ë¶€ë¥¼ í•˜ë‚˜ì˜ ë²¡í„° ì¸ë±ìŠ¤(ë˜ëŠ” ì»¬ë ‰ì…˜)ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë¬¸ì„œ ë©”íƒ€ë°ì´í„°(íŒŒì¼ëª…, ì„¹ì…˜, ë‚ ì§œ, ì–¸ì–´, ê¶Œí•œ, íƒœê·¸)ë¥¼ í•¨ê»˜ ì €ì¥í•´ í•„í„°ë§ì— í™œìš©í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ê¶Œì¥: ë²¡í„°(ì˜ë¯¸) + BM25(í‚¤ì›Œë“œ)ë¥¼ í•¨ê»˜ ì¨ì„œ ê³ ìœ ëª…ì‚¬Â·ìˆ«ì ë§¤ì¹­ì„ ë³´ì™„í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>1ë‹¨ê³„: ë¬¸ì„œ ë ˆë²¨ í”„ë¦¬ì…€ë ‰ì…˜</li>
</ol>

<ul>
  <li>
    <p>ì¿¼ë¦¬ ì„ë² ë”©ê³¼ ë¬¸ì„œ ëŒ€í‘œ ë²¡í„°ë¥¼ ë¹„êµí•´ ìƒìœ„ Nê°œ ë¬¸ì„œë¥¼ ê³ ë¦…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë¬¸ì„œ ëŒ€í‘œ ë²¡í„°ëŠ” ë³´í†µ ë¬¸ì„œ ì œëª©+ìš”ì•½(abstract) ë˜ëŠ” ìƒìœ„ ëª‡ ê°œ ì²­í¬ì˜ í‰ê· ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í•„í„° ì˜ˆ: lang=en, updated_at&gt;2025-01-01, tag in [â€œpolicyâ€, â€œspecâ€] ê°™ì€ ì¡°ê±´ì„ ë¨¼ì € ê±¸ì–´ íƒìƒ‰ ê³µê°„ì„ ì¤„ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë‹¤ì¤‘ ì „ëµ ê²°í•©: ë²¡í„° ìƒìœ„ N1, BM25 ìƒìœ„ N2ë¥¼ ë½‘ì•„ Reciprocal Rank Fusion ê°™ì€ ë°©ì‹ìœ¼ë¡œ í•©ì¹©ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>2ë‹¨ê³„: ì²­í¬ ë ˆë²¨ ì •ë°€ ê²€ìƒ‰</li>
</ol>

<ul>
  <li>
    <p>ì„ íƒëœ Nê°œ ë¬¸ì„œ ê°ê°ì—ì„œ top_k_chunks_per_doc=Kë¡œ ì²­í¬ë¥¼ ë½‘ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¤‘ë³µÂ·ìœ ì‚¬ ì²­í¬ëŠ” Max Marginal Relevance(MMR)ë¡œ ë‹¤ì–‘í™”í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì „ì²´ ëª¨ì•„ì„œ ì¬ë­í‚¹: ë‹¤êµ­ì–´ ë¦¬ë­ì»¤ ë˜ëŠ” cross-encoderë¡œ ìƒìœ„ 50â†’ìµœì¢… 10ê°œë¡œ ì¤„ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>ì»¨í…ìŠ¤íŠ¸ ë¹Œë”</li>
</ol>

<ul>
  <li>
    <p>ìµœì¢… ì²­í¬ë“¤ì„ ê·¼ê±° ë©”íƒ€ë°ì´í„°ì™€ í•¨ê»˜ LLM ì»¨í…ìŠ¤íŠ¸ë¡œ ì§ì¡°í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í† í° í•œë„(max_context_tokens)ì— ë§ì¶° ìë¥´ê³ , ê°€ëŠ¥í•œ í•œ ë¬¸ë‹¨ ê²½ê³„ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê·œì¹™ì„ ê°•ì œ: ë‹µë³€ì€ í•œêµ­ì–´, ì¸ìš©ì€ ì›ë¬¸ ìœ ì§€, ê° ê·¼ê±°ì— í˜ì´ì§€/ì„¹ì…˜ í‘œê¸°.</p>
  </li>
</ul>

<ol>
  <li>ìš´ì˜ íŒ</li>
</ol>

<ul>
  <li>
    <p>ì¿¼ë¦¬ ë¼ìš°íŒ…: ë¶„ì•¼ë³„ ì»¬ë ‰ì…˜ì´ ì—¬ëŸ¬ ê°œë©´ ë¨¼ì € ë¼ìš°í„°(ë¶„ì•¼ ë¶„ë¥˜ê¸°)ë¡œ ì»¬ë ‰ì…˜ì„ 1~2ê°œë¡œ ì¢íŒ ë’¤ ìœ„ ê³¼ì •ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìºì‹±: ì¦ì€ ì¿¼ë¦¬ì˜ ì„ë² ë”©ê³¼ ìƒìœ„ ê²°ê³¼ë¥¼ ìºì‹œí•´ ì§€ì—°ì„ ì¤„ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì„ê³„ê°’: ìœ ì‚¬ë„ ìŠ¤ì½”ì–´ê°€ ì„ê³„ê°’ ë¯¸ë§Œì´ë©´ â€œê·¼ê±° ì—†ìŒâ€ìœ¼ë¡œ ì²˜ë¦¬í•´ í™˜ê°ì„ ì¤„ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê¶Œí•œ: ë©€í‹°ìœ ì €ë¼ë©´ ë¬¸ì„œë³„ ACLì„ ë©”íƒ€ë°ì´í„° í•„í„°ì— ë°˜ë“œì‹œ ë°˜ì˜í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì‹¤í—˜: N, K, ì„ê³„ê°’ì„ ê²€ì¦ì…‹ìœ¼ë¡œ íŠœë‹í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ Nì„ ëŠ˜ë¦¬ë©´ ë¦¬ì½œâ†‘, ì§€ì—°/ë¹„ìš©â†‘.</p>
  </li>
</ul>

<p>ê°„ë‹¨í•œ ì˜ì‚¬ì½”ë“œ</p>

<ul>
  <li>
    <p>ì…ë ¥: query, filters, top_docs=N, top_chunks_per_doc=K, max_context_tokens</p>
  </li>
  <li>
    <p>ì¶œë ¥: ranked_chunks</p>
  </li>
</ul>

<ol>
  <li>
    <p>q_emb = embed(query)</p>
  </li>
  <li>
    <p>doc_candidates = fuse(<br />
vector_search(DOC_INDEX, q_emb, N_vec),<br />
bm25_search(DOC_TEXTS, query, N_bm25)<br />
)[:N]</p>
  </li>
  <li>
    <p>chunk_pool = []<br />
for d in doc_candidates:<br />
chunk_pool += vector_search(d.CHUNK_INDEX, q_emb, K)</p>
  </li>
  <li>
    <p>chunk_pool = mmr_dedup(chunk_pool)</p>
  </li>
  <li>
    <p>ranked = rerank_cross_encoder(query, chunk_pool)</p>
  </li>
  <li>
    <p>context = pack_by_tokens(ranked, max_context_tokens)</p>
  </li>
  <li>
    <p>return context, ranked[:final_k]</p>
  </li>
</ol>

<p>ì§ˆë¬¸ìœ¼ë¡œ ì£¼ì‹  ë‘ ì„ íƒì§€ë¥¼ ì •ë¦¬í•˜ìë©´</p>

<ul>
  <li>
    <p>ëª¨ë“  RAG ë¬¸ì„œë¥¼ ë‹¤ ë’¤ì§€ëŠ” ì¼ê´„ ì „ìˆ˜ê²€ìƒ‰ì€ ê·œëª¨ê°€ ì»¤ì§ˆìˆ˜ë¡ ëŠë ¤ì§€ê³  ë¹„ìš©ì´ í½ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë³´í†µì€ â€œê°€ì¥ ê´€ë ¨ëœ ë¬¸ì„œ ìƒìœ„ Nê°œâ€ë¥¼ ì¶”ë ¤ ê·¸ ì•ˆì—ì„œë§Œ Kê°œ ì²­í¬ë¥¼ ë½‘ëŠ” ê³„ì¸µì  ê²€ìƒ‰ì„ ì”ë‹ˆë‹¤. 100ê°œ ë¬¸ì„œë©´ ìƒìœ„ 10ê°œ ë¬¸ì„œ Ã— ë¬¸ì„œë‹¹ 5ê°œ ì²­í¬ ê°™ì€ êµ¬ì„±ì´ í˜„ì‹¤ì ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ ìˆ«ì ë ˆì‹œí”¼ ì˜ˆì‹œ</p>

<ul>
  <li>
    <p>top_docs=10, top_chunks_per_doc=5, rerank_top=60â†’final=12, max_context_tokens=6k</p>
  </li>
  <li>
    <p>í•˜ì´ë¸Œë¦¬ë“œ ë¹„ìœ¨: vector:bm25 = 0.7:0.3 ê°€ì¤‘ í‰ê· </p>
  </li>
  <li>
    <p>ì„ê³„ê°’: cosine &lt; 0.25ë©´ ì œì™¸, ë¬¸ì„œ ìµœì‹ ê°€ì¤‘ì¹˜ e^(âˆ’Î»Â·age_days) ì ìš©</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œ êµ¬ì„±í•˜ë©´ ì •í™•ë„Â·ì§€ì—°Â·ë¹„ìš©ì˜ ê· í˜•ì´ ì¢‹ì•„ì§€ê³ , ì¿¼ë¦¬ í­ì´ ë„“ì–´ì ¸ë„ ê¹”ë”í•˜ê²Œ í™•ì¥ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

FunctionToolë¡œ ë„ˆê°€ ë§í•œ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê³  ì‹¶ì–´. ëŒ€ëµì ì¸ ì¸í„°í˜ì´ìŠ¤ í•¨ìˆ˜ë“¤ê³¼ ë™ì‘ì„ ì¡ì•„ë³´ì

</p>

<p>ì¢‹ì•„, FunctionToolë¡œ RAG ê²€ìƒ‰ì„ ë¶™ì¼ ë•Œ ì“¸ â€œëŒ€ëµì  ì¸í„°í˜ì´ìŠ¤â€ì™€ ë™ì‘ íë¦„ì„ ì¡ì•„ë³¼ê²Œ. vLLM+gpt-ossì—ì„œë„ ê·¸ëŒ€ë¡œ ì“°ê³ , OpenAI Agents SDKì—ë„ ê±°ì˜ ê·¸ëŒ€ë¡œ ë§µí•‘ë˜ë„ë¡ ì„¤ê³„í–ˆì–´.</p>

<p>í•µì‹¬ êµ¬ì„±ìš”ì†Œ</p>

<ul>
  <li>
    <p>ì¸ë±ì‹± íŒŒì´í”„ë¼ì¸: íŒŒì¼â†’í…ìŠ¤íŠ¸â†’ì²­í¬â†’ì„ë² ë”©â†’ì €ì¥</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸: ì§ˆì˜â†’í•„í„°â†’ë¬¸ì„œ ìƒìœ„ Nâ†’ì²­í¬ ìƒìœ„ Kâ†’ì¬ë­í¬â†’ì»¨í…ìŠ¤íŠ¸ íŒ¨í‚¹</p>
  </li>
  <li>
    <p>FunctionTool: ëª¨ë¸ì´ í˜¸ì¶œí•˜ë©´ ìœ„ ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•´ ì»¨í…ìŠ¤íŠ¸ì™€ ê·¼ê±° ë©”íƒ€ë¥¼ ë°˜í™˜</p>
  </li>
</ul>

<p>ë°ì´í„° ëª¨ë¸(ê°„ë‹¨)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

type DocMeta = {
  doc_id: string
  title: string
  path?: string
  lang?: 'en'|'ko'|'mixed'
  tags?: string[]
  created_at?: string
  updated_at?: string
  acl?: string[]            // ì ‘ê·¼ í—ˆìš© ì‚¬ìš©ì/ì—­í• 
}

type Chunk = {
  chunk_id: string
  doc_id: string
  content: string
  page?: number
  section?: string
  tokens?: number
}

type Scored&lt;T&gt; = T &amp; { score: number }
</code></pre></div></div>

<p>FunctionTool ì‹œê·¸ë‹ˆì²˜(ê²€ìƒ‰ ì „ìš©)<br />
OpenAI-style JSON ìŠ¤í‚¤ë§ˆë¥¼ ë”°ë¼ ì„¤ê³„. íˆ´ ì´ë¦„ì€ search_docs.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search_docs"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ì§ˆë¬¸ê³¼ í•„í„°ë¥¼ ë°›ì•„ ê´€ë ¨ ë¬¸ì„œì™€ ì²­í¬ë¥¼ ê²€ìƒ‰í•´ LLM ì»¨í…ìŠ¤íŠ¸ë¥¼ ë§Œë“ ë‹¤."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ì‚¬ìš©ì ì§ˆë¬¸(ko/en ê°€ëŠ¥)"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"filters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"langs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"tags"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"doc_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"updated_after"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ISO8601"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"top_docs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"top_chunks_per_doc"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"final_chunks"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"max_context_tokens"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"use_hybrid"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"use_mmr"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"use_reranker"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"translate_query_to_en"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"query"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>FunctionTool ë°˜í™˜ í¬ë§·<br />
LLMì´ ë°”ë¡œ ë¨¹ì¼ ìˆ˜ ìˆê²Œ ì»¨í…ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ì™€ ê·¼ê±° ë¦¬ìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ì¤Œ.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

type SearchResult = {
  context: string                 // LLMì— ë°”ë¡œ ë„£ì„ ì»¨í…ìŠ¤íŠ¸
  citations: Array&lt;{
    doc_id: string
    title?: string
    page?: number
    section?: string
    snippet: string
    score: number
  }&gt;
  diagnostics?: {
    used_docs: Array&lt;Scored&lt;DocMeta&gt;&gt;
    used_chunks: Array&lt;Scored&lt;Chunk&gt;&gt;
    query_lang?: 'ko'|'en'|'unknown'
    translated_query?: string
  }
}
</code></pre></div></div>

<p>ë™ì‘ ì˜ì‚¬ì½”ë“œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">search_docs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">top_docs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">top_chunks_per_doc</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">final_chunks</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_context_tokens</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                <span class="n">use_hybrid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_mmr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_reranker</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">translate_query_to_en</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SearchResult</span><span class="p">:</span>

    <span class="c1"># 0) ê¶Œí•œ/í•„í„°ë§ í”„ë ˆë”•íŠ¸
</span>    <span class="n">candidate_docs</span> <span class="o">=</span> <span class="nf">filter_docs</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>  <span class="c1"># lang/tags/doc_ids/updated_after/ACL ë°˜ì˜
</span>
    <span class="c1"># 1) ì¿¼ë¦¬ ì¤€ë¹„
</span>    <span class="n">lang</span> <span class="o">=</span> <span class="nf">detect_lang</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># ko/en ì¶”ì •
</span>    <span class="n">q_for_vec</span> <span class="o">=</span> <span class="n">query</span>
    <span class="k">if</span> <span class="n">translate_query_to_en</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="sh">'</span><span class="s">ko</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">q_for_vec</span> <span class="o">=</span> <span class="nf">translate_ko_to_en</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># ì„ íƒ ê¸°ëŠ¥
</span>
    <span class="c1"># 2) ë¬¸ì„œ ë ˆë²¨ í”„ë¦¬ì…€ë ‰ì…˜
</span>    <span class="n">doc_scores_vec</span> <span class="o">=</span> <span class="nf">vector_search_docs</span><span class="p">(</span><span class="n">candidate_docs</span><span class="p">,</span> <span class="n">q_for_vec</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_docs</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">doc_scores_kw</span>  <span class="o">=</span> <span class="nf">bm25_search_docs</span><span class="p">(</span><span class="n">candidate_docs</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_docs</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_hybrid</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">doc_candidates</span> <span class="o">=</span> <span class="nf">fuse_scores</span><span class="p">(</span><span class="n">doc_scores_vec</span><span class="p">,</span> <span class="n">doc_scores_kw</span><span class="p">)[:</span><span class="n">top_docs</span><span class="p">]</span>

    <span class="c1"># 3) ì²­í¬ ë ˆë²¨ ì •ë°€ ê²€ìƒ‰
</span>    <span class="n">chunk_pool</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">doc_candidates</span><span class="p">:</span>
        <span class="n">chunks_vec</span> <span class="o">=</span> <span class="nf">vector_search_chunks</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">q_for_vec</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_chunks_per_doc</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">chunks_kw</span>  <span class="o">=</span> <span class="nf">bm25_search_chunks</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_chunks_per_doc</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_hybrid</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">chunk_pool</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">fuse_scores</span><span class="p">(</span><span class="n">chunks_vec</span><span class="p">,</span> <span class="n">chunks_kw</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">use_mmr</span><span class="p">:</span>
        <span class="n">chunk_pool</span> <span class="o">=</span> <span class="nf">mmr_diversify</span><span class="p">(</span><span class="n">chunk_pool</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">final_chunks</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># 4) ì¬ë­í‚¹
</span>    <span class="n">ranked</span> <span class="o">=</span> <span class="n">chunk_pool</span>
    <span class="k">if</span> <span class="n">use_reranker</span><span class="p">:</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="nf">cross_encoder_rerank</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">chunk_pool</span><span class="p">)</span>  <span class="c1"># ìƒìœ„ 50â†’ì •ë ¬
</span>
    <span class="c1"># 5) ì»¨í…ìŠ¤íŠ¸ íŒ¨í‚¹
</span>    <span class="n">selected</span> <span class="o">=</span> <span class="nf">take_until_token_budget</span><span class="p">(</span><span class="n">ranked</span><span class="p">,</span> <span class="n">final_chunks</span><span class="p">,</span> <span class="n">max_context_tokens</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="nf">build_context</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>  <span class="c1"># [Doc:Title p.X] + ë³¸ë¬¸â€¦ í˜•íƒœ
</span>
    <span class="c1"># 6) ì¸ìš©/ë””ë²„ê·¸ ì •ë³´
</span>    <span class="n">citations</span> <span class="o">=</span> <span class="p">[{</span>
        <span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">doc_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="nf">get_title</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">doc_id</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">section</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">snippet</span><span class="sh">"</span><span class="p">:</span> <span class="nf">shorten</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">score</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>

    <span class="n">diags</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">used_docs</span><span class="sh">"</span><span class="p">:</span> <span class="n">doc_candidates</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">used_chunks</span><span class="sh">"</span><span class="p">:</span> <span class="n">selected</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">query_lang</span><span class="sh">"</span><span class="p">:</span> <span class="n">lang</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">translated_query</span><span class="sh">"</span><span class="p">:</span> <span class="n">q_for_vec</span> <span class="k">if</span> <span class="n">q_for_vec</span> <span class="o">!=</span> <span class="n">query</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span> <span class="sh">"</span><span class="s">citations</span><span class="sh">"</span><span class="p">:</span> <span class="n">citations</span><span class="p">,</span> <span class="sh">"</span><span class="s">diagnostics</span><span class="sh">"</span><span class="p">:</span> <span class="n">diags</span><span class="p">}</span>
</code></pre></div></div>

<p>ì»¨í…ìŠ¤íŠ¸ ë¹Œë“œ ê·œì¹™(ìš”ì•½)</p>

<ul>
  <li>
    <p>ë¬¸ì„œ/í˜ì´ì§€/ì„¹ì…˜ ë©”íƒ€ë¥¼ ëª…ì‹œ</p>
  </li>
  <li>
    <p>ì²­í¬ ì‚¬ì´ì— êµ¬ë¶„ì</p>
  </li>
  <li>
    <p>ì›ë¬¸ì´ ì˜ì–´ë¼ë„ ê·¸ëŒ€ë¡œ ë‘ê³ , ìµœì¢… ë‹µë³€ ì–¸ì–´ëŠ” LLM ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¡œ ê°•ì œ</p>
  </li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Source] Title="Spec ABC", DocID=doc_123, Page=5, Section="3.2"
"Chunk content here..."

[Source] Title="Spec XYZ", DocID=doc_987, Page=12
"Another chunk..."
</code></pre></div></div>

<p>Agents SDKì— ë“±ë¡ ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">search_docs_tool</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">search_docs</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">search_docs</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë¬¸ì„œ/ì²­í¬ ê²€ìƒ‰</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="n">ìœ„</span> <span class="n">JSON</span> <span class="n">ìŠ¤í‚¤ë§ˆ</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">ë‹µë³€ì€ í•œêµ­ì–´ë¡œ. ë°˜ë“œì‹œ search_docsë¥¼ ì´ìš©í•´ ê·¼ê±°ë¥¼ í™•ì¸í•˜ê³ , ì¸ìš©ì„ í¬í•¨í•´ë¼.</span><span class="sh">"</span><span class="p">},</span>
  <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">ì˜ì–´ë¡œ ëœ ì œí’ˆ ë³´ì¦ ì¡°ê±´ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">}</span>
<span class="p">]</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
  <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
  <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
  <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
<span class="p">)</span>
<span class="c1"># tool_calls ê°ì§€ â†’ search_docs_tool ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ tool ë©”ì‹œì§€ë¡œ ì²¨ë¶€ â†’ ëª¨ë¸ ì¬í˜¸ì¶œ
</span></code></pre></div></div>

<p>vLLM+gpt-oss ì»¤ìŠ¤í…€ ë£¨í”„</p>

<ul>
  <li>
    <p>vLLMì€ íˆ´ í˜¸ì¶œ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ì´ ì—†ìœ¼ë‹ˆ, ëª¨ë¸ ì¶œë ¥ì˜ function_call(JSON)ì„ ì§ì ‘ íŒŒì‹±í•´ì„œ search_docsë¥¼ í˜¸ì¶œí•œ ë’¤ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— ë„£ëŠ” ë£¨í”„ë¥¼ êµ¬í˜„í•˜ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ë˜ëŠ” â€œìˆ˜ë™ ëª¨ë“œâ€ë¡œ, ì‚¬ìš©ì ì§ˆë¬¸ì´ ì˜¤ë©´ ì„œë²„ì—ì„œ search_docsë¥¼ ë¨¼ì € ì‹¤í–‰í•´ contextë¥¼ ë§Œë“¤ê³ , ê·¸ê±¸ user ë©”ì‹œì§€ì— ë¶™ì—¬ ëª¨ë¸ì„ í•œ ë²ˆë§Œ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ë„ ê°„ë‹¨í•˜ê³  íŠ¼íŠ¼í•˜ë‹¤.</p>
  </li>
</ul>

<p>ì¸ë±ì‹±ìš© ë³´ì¡° íˆ´(ì„ íƒ)<br />
íŒŒì¼ ì—…ë¡œë“œ/ì¬ë¹Œë“œ/ìƒíƒœ í™•ì¸ì„ ìœ„í•´ ì¶”ê°€ FunctionToolì„ ë‘ë©´ ìš´ì˜ì´ í¸í•˜ë‹¤.</p>

<ul>
  <li>
    <p>upsert_documents(files, tags, lang_hint)</p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>rebuild_index(scope='all'</td>
          <td>'doc_id')</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>describe_doc(doc_id)</p>
  </li>
  <li>purge_docs(doc_ids)</li>
</ul>

<p>ìµœì†Œ ìš´ì˜ íŒŒë¼ë¯¸í„°ì˜ ì¶”ì²œ ê¸°ë³¸ê°’</p>

<ul>
  <li>
    <p>top_docs=10</p>
  </li>
  <li>
    <p>top_chunks_per_doc=5</p>
  </li>
  <li>
    <p>final_chunks=12</p>
  </li>
  <li>
    <p>max_context_tokens=6000</p>
  </li>
  <li>
    <p>use_hybrid=true, use_mmr=true, use_reranker=true</p>
  </li>
  <li>
    <p>translate_query_to_en=false (ë‹¤êµ­ì–´ ì„ë² ë”©ì´ë©´ ë¶ˆí•„ìš”, ì˜ì–´ ì „ìš© ì„ë² ë”©ì´ë©´ true)</p>
  </li>
</ul>

<p>ì—¬ê¸°ê¹Œì§€ê°€ ê²¬ê³ í•œ ê³¨ê²©ì´ì•¼. ë‹¤ìŒ ë‹¨ê³„ë¡œëŠ” ë„ˆí¬ê°€ ì“°ëŠ” ì„ë² ë”©/ë²¡í„°DBë¥¼ ê°€ì •í•´ì„œ search_docs ë‚´ë¶€ì˜ vector_search_*ì™€ bm25, reranker, íŒ¨í‚¹ í•¨ìˆ˜ë¥¼ ì‹¤ì½”ë“œë¡œ ë©”ì›Œ ë„£ìœ¼ë©´ ë°”ë¡œ ë¶™ì¼ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

Databaseë¥¼ ë§Œë“¤ê¸°ë„ í•´ì•¼í•´. ì´ë¥¼ ìœ„í•´ ë¬¸ì„œë¥¼ DBì— ì¶”ê°€í•˜ê±°ë‚˜ í•˜ëŠ” ê²ƒë„ í•„ìš”í•  ê²ƒ ê°™ì€ë°

</p>

<p>ì¢‹ì•„, RAGìš© Databaseê¹Œì§€ í¬í•¨í•œ â€œë¬¸ì„œ ìˆ˜ì§‘Â·ì €ì¥Â·ì¸ë±ì‹±Â·ê²€ìƒ‰â€ í’€ì‚¬ì´í´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¡ì•„ë³´ì. ìš´ì˜ì„ ì—¼ë‘ì— ë‘ê³  ì„¤ê³„í•˜ë©´ ë‚˜ì¤‘ì— ì•ˆ ì•„íŒŒìš”.</p>

<p>í•µì‹¬ êµ¬ì¡° ê°œìš”</p>

<ol>
  <li>
    <p>ì›ë³¸ ì €ì¥ì†Œ: ì—…ë¡œë“œí•œ íŒŒì¼ì„ ë³´ê´€í•˜ëŠ” Object Storage(S3, GCS, MinIO ë“±)</p>
  </li>
  <li>
    <p>ë©”íƒ€Â·í…ìŠ¤íŠ¸ DB: ë¬¸ì„œ/ì²­í¬/íƒœê·¸/ACL/ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” RDB(PostgreSQL ê¶Œì¥)</p>
  </li>
  <li>
    <p>ë²¡í„° ì¸ë±ìŠ¤: pgvector ë˜ëŠ” ì™¸ë¶€ ë²¡í„°DB(FAISS, Milvus, Chroma, Qdrant)</p>
  </li>
  <li>
    <p>ì¡ í: ì„ë² ë”©Â·ì¬ì¸ë±ì‹± ê°™ì€ ë¹„ë™ê¸° ì‘ì—…ìš©(ì˜ˆ: Celery, RQ, Sidekiq, Temporal)</p>
  </li>
</ol>

<p>ê¶Œì¥ êµ¬í˜„ í”„ë¡œíŒŒì¼<br />
PostgreSQL + pgvector í•œ ë°©ìœ¼ë¡œ ëë‚´ê¸°<br />
ì¥ì : íŠ¸ëœì­ì…˜, ì¡°ì¸, í•„í„°ë§, ê¶Œí•œì²´í¬ê°€ ê¹”ë”. ìš´ì˜ ë‹¨ìˆœ.<br />
ëŒ€ì•ˆ: í…ìŠ¤íŠ¸ëŠ” Postgres, ë²¡í„°ëŠ” FAISS/Milvusë¡œ ë¶„ë¦¬. ì„±ëŠ¥ íŠœë‹ ììœ ë„â†‘.</p>

<p>ë°ì´í„° ëª¨ë¸ ìŠ¤í‚¤ë§ˆ(Postgres + pgvector)<br />
SQL DDL ì˜ˆì‹œ. ì„ë² ë”© ì°¨ì›ì€ ì˜ˆë¡œ 1024ë¥¼ ì‚¬ìš©.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sql

create extension if not exists vector;

create table documents (
  doc_id          uuid primary key,
  title           text not null,
  source_uri      text,                 -- S3 í‚¤, GCS ê²½ë¡œ ë“±
  mime_type       text,
  lang            text,                 -- 'en','ko','mixed' ë“±
  tags            text[],
  bytes           bigint,
  pages           int,
  created_at      timestamptz default now(),
  updated_at      timestamptz default now(),
  status          text not null default 'ready',  -- 'ready','processing','error','disabled'
  acl_roles       text[] default array[]::text[], -- ì ‘ê·¼ í—ˆìš© ì—­í• 
  acl_users       text[] default array[]::text[]  -- ì ‘ê·¼ í—ˆìš© ì‚¬ìš©ì
);

create table chunks (
  chunk_id        uuid primary key,
  doc_id          uuid references documents(doc_id) on delete cascade,
  page            int,
  section         text,
  content         text not null,
  token_count     int,
  created_at      timestamptz default now(),
  updated_at      timestamptz default now()
);

-- í•˜ë‚˜ì˜ ì»¬ëŸ¼ì— ë‹¤êµ­ì–´ ì„ë² ë”©ì„ ì €ì¥(ê¶Œì¥). í•„ìš”í•˜ë©´ ì˜ì–´ ì „ìš© ì¶”ê°€ ì»¬ëŸ¼ë„.
create table chunk_embeddings (
  chunk_id        uuid primary key references chunks(chunk_id) on delete cascade,
  emb_mtext       vector(1024),         -- ë‹¤êµ­ì–´ ì„ë² ë”©
  emb_en          vector(1024)          -- ì„ íƒ: ì˜ì–´ ì „ìš© ì„ë² ë”©
);

-- BM25 ëŒ€ì²´ìš© ì „ì²´ê²€ìƒ‰ ì¸ë±ìŠ¤
create index idx_chunks_fts on chunks using gin (to_tsvector('simple', content));

-- íƒœê·¸/ì–¸ì–´/ìƒíƒœ/ì—…ë°ì´íŠ¸ì¼ í•„í„°ë§
create index idx_documents_tags on documents using gin (tags);
create index idx_documents_lang on documents (lang);
create index idx_documents_status on documents (status);
create index idx_documents_updated on documents (updated_at);

-- ë²¡í„° ì¸ë±ìŠ¤(IVFFlat ì˜ˆì‹œ). ê·œëª¨ ì»¤ì§€ë©´ lists íŒŒë¼ë¯¸í„° íŠœë‹.
create index idx_chunk_emb_mtext on chunk_embeddings using ivfflat (emb_mtext vector_cosine_ops) with (lists = 200);
create index idx_chunk_emb_en    on chunk_embeddings using ivfflat (emb_en    vector_cosine_ops) with (lists = 200);
</code></pre></div></div>

<p>ìŠ¤í† ë¦¬ì§€ ê³„ì¸µ<br />
ì›ë¬¸ íŒŒì¼ì€ RDBì— ë„£ì§€ ë§ê³  Object Storageì— ë„£ê³  documents.source_urië¡œ ì—°ê²°. ì¸ë„¤ì¼Â·í…ìŠ¤íŠ¸ ì¶”ì¶œ ìºì‹œë¥¼ ë‘ë©´ ì†ë„ê°€ ë¹¨ë¼ì§.</p>

<p>FunctionTool ì¸í„°í˜ì´ìŠ¤ ì„¤ê³„<br />
ê²€ìƒ‰ë¿ ì•„ë‹ˆë¼ ì—…ì„œíŠ¸Â·ì¬ì¸ë±ì‹±Â·ê´€ë¦¬ê¹Œì§€ FunctionToolë¡œ ë…¸ì¶œí•˜ë©´ LLM ì—ì´ì „íŠ¸ë‚˜ ê´€ë¦¬ìš© UIì—ì„œ ìë™í™”í•˜ê¸° ì¢‹ë‹¤.</p>

<ol>
  <li>ë¬¸ì„œ ì—…ì„œíŠ¸<br />
ì´ í•¨ìˆ˜ëŠ” DBì™€ ìŠ¤í† ë¦¬ì§€ë¥¼ ê°±ì‹ í•˜ê³ , ë¹„ë™ê¸° ì¸ë±ì‹± ì¡ì„ ë°œí–‰.</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"upsert_documents"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë¬¸ì„œë¥¼ DBì™€ ìŠ¤í† ë¦¬ì§€ì— ì¶”ê°€/ê°±ì‹ í•˜ê³  ì¸ë±ì‹± ì¡ì„ íì— ë„£ëŠ”ë‹¤."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"source_uri"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"mime_type"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"lang_hint"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"acl_roles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"acl_users"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"doc_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ê°±ì‹  ì‹œ ì§€ì •"</span><span class="w"> </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"source_uri"</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"reindex"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"items"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ë™ì‘</p>

<ol>
  <li>
    <p>source_uri ìœ íš¨ì„± í™•ì¸ ë° ë©”íƒ€ ì¶”ì¶œ(bytes, pages ë“±)</p>
  </li>
  <li>
    <p>documents upsert</p>
  </li>
  <li>
    <p>ìƒíƒœë¥¼ processingìœ¼ë¡œ ë°”ê¾¸ê³  ì¸ë±ì‹± ì¡ enqueue</p>
  </li>
  <li>
    <p>ì¸ë±ì‹± ì›Œì»¤(ë¹„ë™ê¸° ì¡)<br />
ì¶”ì¶œâ†’ì²­í¬â†’ì„ë² ë”©â†’ì €ì¥ íŒŒì´í”„ë¼ì¸. ì‹¤íŒ¨ ì‹œ documents.status='error'ì™€ ë©”ì‹œì§€ ì €ì¥.<br />
ì˜ì‚¬ì½”ë“œ</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">worker_index_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">get_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">source_uri</span><span class="p">)</span>
    <span class="n">text</span><span class="p">,</span> <span class="n">pages</span> <span class="o">=</span> <span class="nf">extract_text</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>             <span class="c1"># pypdf/unstructured/docling
</span>    <span class="n">chunks</span> <span class="o">=</span> <span class="nf">chunking</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>                     <span class="c1"># 200~400 í† í° ê¶Œì¥
</span>    <span class="n">db</span><span class="p">.</span><span class="nf">delete_chunks</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>                    <span class="c1"># ì „ì²´ ì¬ë¹Œë“œ ì‹œ
</span>    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="n">chunk_id</span> <span class="o">=</span> <span class="nf">uuid4</span><span class="p">()</span>
        <span class="n">db</span><span class="p">.</span><span class="nf">insert_chunk</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">page</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">section</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">tokens</span><span class="p">)</span>
    <span class="c1"># ì„ë² ë”©
</span>    <span class="n">vecs_m</span> <span class="o">=</span> <span class="nf">embed_multilingual</span><span class="p">([</span><span class="n">c</span><span class="p">.</span><span class="n">content</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">])</span>
    <span class="n">vecs_en</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># í•„ìš”í•˜ë©´ ë²ˆì—­ í›„ ë˜ëŠ” ì˜ì–´ì „ìš© ì„ë² ë”©
</span>    <span class="n">db</span><span class="p">.</span><span class="nf">insert_embeddings</span><span class="p">([</span> <span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nb">id</span><span class="p">,</span> <span class="n">vecs_m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vecs_en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">vecs_en</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">))</span> <span class="p">])</span>
    <span class="n">db</span><span class="p">.</span><span class="nf">update_document_status</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="sh">'</span><span class="s">ready</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>ë¬¸ì„œ ìƒíƒœ ì¡°íšŒ/ì„¤ëª…</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"describe_doc"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë¬¸ì„œ ë©”íƒ€ë°ì´í„°ì™€ ì¸ë±ì‹± ìƒíƒœë¥¼ ì¡°íšŒí•œë‹¤."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"doc_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"doc_id"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ë°˜í™˜ì€ title, lang, tags, updated_at, status, chunk_count ë“±.</p>

<ol>
  <li>ì„ íƒì  ì¬ë¹Œë“œ</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rebuild_index"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë¬¸ì„œ ë˜ëŠ” ì „ì²´ ì»¬ë ‰ì…˜ì˜ ì¸ë±ìŠ¤ë¥¼ ì¬ìƒì„±í•œë‹¤."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"all"</span><span class="p">,</span><span class="s2">"doc"</span><span class="p">],</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"doc"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"doc_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"scope"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ì‚­ì œ</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"purge_docs"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë¬¸ì„œë¥¼ ì™„ì „íˆ ì‚­ì œí•œë‹¤(ì²­í¬, ì„ë² ë”© í¬í•¨)."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"doc_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"doc_ids"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ê²€ìƒ‰ íˆ´(ì•ì„œ ì •ì˜í•œ search_docs)<br />
í•„í„°ì— tags/lang/updated_after/acl í¬í•¨. top_docs, top_chunks_per_doc, final_chunksë¡œ í­ì„ ì œì–´.</li>
</ol>

<p>ê¶Œí•œ(ACL) ì²˜ë¦¬<br />
ê²€ìƒ‰ ì¿¼ë¦¬ì—ì„œ ë°˜ë“œì‹œ ë‹¤ìŒì„ ì ìš©.</p>

<ol>
  <li>
    <p>ë¡œê·¸ì¸ ìœ ì €ì˜ roles, user_idë¥¼ ë°›ì•„ documents.acl_roles/acl_usersì— ë§¤ì¹­</p>
  </li>
  <li>
    <p>í•„í„° ë‹¨ê³„ì—ì„œ ë¯¸ë¦¬ ì œì™¸</p>
  </li>
  <li>
    <p>ê°ì‚¬ ë¡œê·¸: ëˆ„ê°€ ì–´ë–¤ doc_idë¥¼ ê·¼ê±°ë¡œ ë³´ì•˜ëŠ”ì§€ ê¸°ë¡</p>
  </li>
</ol>

<p>ì„±ëŠ¥ íŒ</p>

<ol>
  <li>
    <p>í† í° ì˜ˆì‚° ìš°ì„ : final_chunksëŠ” 8~16 ì‚¬ì´, ì´ 4~8k í† í° ë‚´ì—ì„œ íŒ¨í‚¹</p>
  </li>
  <li>
    <p>ì¸ë±ìŠ¤ íŠœë‹: IVFFlat lists, probes ì¡°ì •. pgvectorì˜ SET ivfflat.probes=ê°’</p>
  </li>
  <li>
    <p>í•˜ì´ë¸Œë¦¬ë“œ: to_tsvector(simple)ë¡œ í‚¤ì›Œë“œ ì¸ë±ìŠ¤. ê³ ìœ ëª…ì‚¬/ìˆ«ì ê°•í™”</p>
  </li>
  <li>
    <p>ìºì‹±: ì¿¼ë¦¬â†’ìƒìœ„ doc_ids, chunk_ids ìºì‹œ. ì„ë² ë”© ê²°ê³¼ë„ ë©”ëª¨ë¦¬ ìºì‹œ</p>
  </li>
  <li>
    <p>ìµœì‹  ê°€ì¤‘ì¹˜: score = Î±Â·cosine + Î²Â·bm25 + Î³Â·recency_boost</p>
  </li>
</ol>

<p>ê°„ë‹¨ API íë¦„ ì˜ˆì‹œ</p>

<ol>
  <li>
    <p>í´ë¼ì´ì–¸íŠ¸ê°€ íŒŒì¼ ì—…ë¡œë“œ â†’ ë°±ì—”ë“œê°€ S3ì— ì €ì¥ í›„ upsert_documents í˜¸ì¶œ</p>
  </li>
  <li>
    <p>ì›Œì»¤ê°€ ì¸ë±ì‹± ì™„ë£Œ â†’ ë¬¸ì„œ status=ready</p>
  </li>
  <li>
    <p>ì‚¬ìš©ìê°€ ì§ˆë¬¸ â†’ search_docs í˜¸ì¶œ â†’ ì»¨í…ìŠ¤íŠ¸ì™€ citations ë°˜í™˜</p>
  </li>
  <li>
    <p>LLM í˜¸ì¶œ ì‹œ ì»¨í…ìŠ¤íŠ¸ ì‚½ì… â†’ í•œêµ­ì–´ ë‹µë³€ ìƒì„±</p>
  </li>
</ol>

<p>ì„œë²„ ì‚¬ì´ë“œ ì˜ì‚¬ì½”ë“œ ìŠ¤ë‹ˆí«<br />
ë¬¸ì„œ ì—…ì„œíŠ¸</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">upsert_documents</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">reindex</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">uuid4</span><span class="p">()</span>
        <span class="n">db</span><span class="p">.</span><span class="nf">upsert_document</span><span class="p">(</span>
            <span class="n">doc_id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">it</span><span class="p">[</span><span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">],</span>
            <span class="n">source_uri</span><span class="o">=</span><span class="n">it</span><span class="p">[</span><span class="sh">"</span><span class="s">source_uri</span><span class="sh">"</span><span class="p">],</span>
            <span class="n">mime_type</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">mime_type</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">lang</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">lang_hint</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">acl_roles</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">acl_roles</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">acl_users</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">acl_users</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">status</span><span class="o">=</span><span class="sh">"</span><span class="s">processing</span><span class="sh">"</span> <span class="k">if</span> <span class="n">reindex</span> <span class="k">else</span> <span class="sh">"</span><span class="s">ready</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">reindex</span><span class="p">:</span>
            <span class="n">queue</span><span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="sh">"</span><span class="s">worker_index_document</span><span class="sh">"</span><span class="p">,</span> <span class="n">doc_id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">)</span>
        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">doc_id</span><span class="p">),</span> <span class="sh">"</span><span class="s">queued</span><span class="sh">"</span><span class="p">:</span> <span class="n">reindex</span><span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>
</code></pre></div></div>

<p>ê²€ìƒ‰ í•µì‹¬ ì¿¼ë¦¬(pgvector)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sql

-- ë‹¤êµ­ì–´ ì„ë² ë”©ìœ¼ë¡œ top N ì²­í¬
select c.chunk_id, c.doc_id, c.page, c.section, c.content,
       1 - (ce.emb_mtext &lt;=&gt; :qvec) as score
from chunk_embeddings ce
join chunks c on c.chunk_id = ce.chunk_id
join documents d on d.doc_id = c.doc_id
where d.status = 'ready'
  and (:lang is null or d.lang = :lang)
  and (:tags is null or d.tags &amp;&amp; :tags::text[])
  and (:user_id = any(d.acl_users) or array_length(d.acl_users,1) is null
       or :role &amp;&amp; d.acl_roles)
order by ce.emb_mtext &lt;=&gt; :qvec
limit :k;
</code></pre></div></div>

<p>ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸<br />
ë¬¸ì„œ ìƒíƒœ ì „ì´: ready â†” processing â†” error<br />
ì¤‘ë³µ ë°©ì§€: ê°™ì€ source_uri+hashë¡œ idempotent ì—…ì„œíŠ¸<br />
ê´€ì°°ì„±: ì¸ë±ì‹± ì‹œê°„, ì²­í¬ ìˆ˜, ì„ë² ë”© ì‹œê°„, ê²€ìƒ‰ ì§€ì—°, íˆíŠ¸ìœ¨ ì§€í‘œ ìˆ˜ì§‘<br />
ì¬í˜„ì„±: ì„ë² ë”© ëª¨ë¸ ë²„ì „ ì €ì¥. êµì²´ ì‹œ ë¡¤ë§ ì¬ì¸ë±ì‹±</p>

<p>ì •ë¦¬</p>

<ol>
  <li>
    <p>ë¬¸ì„œ ë©”íƒ€Â·ì²­í¬Â·ì„ë² ë”©ì„ RDBë¡œ ëª…í™•íˆ ë¶„ë¦¬í•˜ê³ , íŒŒì¼ì€ Object Storageì— ë‘”ë‹¤.</p>
  </li>
  <li>
    <p>FunctionToolë¡œ upsert/rebuild/describe/purge/searchë¥¼ ë…¸ì¶œí•´ LLMì´ í•„ìš”í•œ ìˆœê°„ì—ë§Œ í˜¸ì¶œí•˜ê²Œ í•œë‹¤.</p>
  </li>
  <li>
    <p>ë¹„ë™ê¸° ì›Œì»¤ë¥¼ ë‘ì–´ ì¸ë±ì‹±ì„ ì˜¤í”„ë¡œë“œí•œë‹¤.</p>
  </li>
  <li>
    <p>pgvector í•˜ë‚˜ë¡œë„ ì¶©ë¶„íˆ ë‹¨ë‹¨í•œ RAG DBë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.</p>
  </li>
</ol>

<p>ë‹¤ìŒìœ¼ë¡œ ì›í•˜ì‹œë©´ ì´ ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹¤ì œ Python ì €ì¥ì†Œ ë ˆì´ì–´(ORM), ì›Œì»¤(Celery), ê·¸ë¦¬ê³  search_docs ë‚´ë¶€ SQLê¹Œì§€ ê½‚ì•„ ë„£ì€ ë¯¸ë‹ˆ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë§Œë“¤ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

ì„ë² ë”© ë“±ì€ ê·¸ëƒ¥ ìœ ì €ì˜ ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œì— ì €ì¥í•œë‹¤ê³  ê°€ì •í•˜ì.

</p>

<p>ì¢‹ì•„. â€œì„ë² ë”©ê³¼ ì¸ë±ìŠ¤ê¹Œì§€ ëª¨ë‘ ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œì— ì €ì¥â€í•œë‹¤ëŠ” ê°€ì •ìœ¼ë¡œ, í’€ì‚¬ì´í´ ì¸í„°í˜ì´ìŠ¤ì™€ ë””ë ‰í„°ë¦¬ êµ¬ì¡°, íŒŒì¼ í¬ë§·, FunctionTool ì‹œê·¸ë‹ˆì²˜, ë™ì‘ ìŠ¤ì¼€ì¹˜ë¥¼ ì¡ì•„ì¤„ê²Œ. ì™¸ë¶€ DB ì—†ì´ë„ ë‹¨ë‹¨íˆ ëŒì•„ê°€ë„ë¡ ì„¤ê³„í–ˆì–´. í•„ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” pypdf/unstructured, sentence-transformers(or bge/e5), faiss, sqlite3 ì •ë„ë¡œ ê°€ì •í•œë‹¤.</p>

<p>ì„¤ê³„ ìš”ì•½</p>

<ol>
  <li>
    <p>ìŠ¤í† ë¦¬ì§€ ê³„ì¸µì€ ì „ë¶€ ë¡œì»¬ ë””ë ‰í„°ë¦¬. ì›ë³¸ íŒŒì¼ê³¼ íŒŒìƒ ì‚°ì¶œë¬¼(í…ìŠ¤íŠ¸, ì²­í¬, ì„ë² ë”©, ì¸ë±ìŠ¤)ì„ ê·œì¹™ì ìœ¼ë¡œ ì €ì¥.</p>
  </li>
  <li>
    <p>ë©”íƒ€ë°ì´í„°ëŠ” SQLite í•œ íŒŒì¼ë¡œ ê´€ë¦¬í•´ ì¡°íšŒÂ·í•„í„°Â·ACLê°€ ë¹ ë¦„. ëŒ€ì•ˆìœ¼ë¡œ JSONLë§Œ ì¨ë„ ë˜ì§€ë§Œ ê·œëª¨ê°€ ì»¤ì§€ë©´ ëŠë ¤ì§.</p>
  </li>
  <li>
    <p>ë²¡í„° ê²€ìƒ‰ì€ FAISSë¥¼ ì‚¬ìš©í•˜ê³  ì¸ë±ìŠ¤ íŒŒì¼ë¡œ ì˜ì†í™”. í‚¤ì›Œë“œ ê²€ìƒ‰ì€ SQLite FTS5ë¡œ ëŒ€ì²´.</p>
  </li>
  <li>
    <p>FunctionToolì€ ì—…ì„œíŠ¸, ì¬ì¸ë±ì‹±, ê²€ìƒ‰, ì„¤ëª…, ì‚­ì œê¹Œì§€ í•œ ì„¸íŠ¸ë¡œ ë…¸ì¶œ.</p>
  </li>
</ol>

<p>ë””ë ‰í„°ë¦¬ êµ¬ì¡° ì˜ˆì‹œ<br />
rag_store/<br />
blobs/ ì›ë³¸ íŒŒì¼ ë³´ê´€<br />
{doc_id}/{filename}<br />
texts/ í…ìŠ¤íŠ¸ ì¶”ì¶œ ìºì‹œ<br />
{doc_id}.txt<br />
chunks/ ì²­í¬ JSONL<br />
{doc_id}.jsonl [{"chunk_id","page","section","content","tokens"}â€¦]<br />
embeddings/ ì„ë² ë”© íŒŒì¼<br />
mtext/{doc_id}.npy float32 [num_chunks, dim]<br />
en/{doc_id}.npy ì„ íƒ: ì˜ì–´ ì „ìš©<br />
indices/ ì „ì²´ ì»¬ë ‰ì…˜ìš© ì¸ë±ìŠ¤<br />
faiss_mtext.index<br />
faiss_en.index<br />
manifest/ ë²„ì „Â·ëª¨ë¸ ì¶”ì <br />
embedding_manifest.json [{"model":"bge-m3","dim":1024,"built_at":â€¦}]<br />
locks/<br />
index.lock<br />
rag_meta.sqlite SQLite ë©”íƒ€DB(ë¬¸ì„œÂ·ì²­í¬Â·ACLÂ·FTS5)</p>

<p>SQLite ìŠ¤í‚¤ë§ˆ ìš”ì•½<br />
documents(doc_id pk, title, source_path, mime, lang, tags json, bytes, pages, status, acl_users json, acl_roles json, created_at, updated_at, embed_model_mtext, embed_model_en)<br />
chunks(chunk_id pk, doc_id fk, page, section, content, tokens)<br />
fts_chunks(content) USING FTS5(content, content='chunks', content_rowid='rowid')<br />
ì¸ë±ìŠ¤: documents(status, updated_at), chunks(doc_id)</p>

<p>FunctionTool ì¸í„°í˜ì´ìŠ¤</p>

<ol>
  <li>
    <p>upsert_documents<br />
name: upsert_documents<br />
description: ë¡œì»¬ íŒŒì¼ì„ ë“±ë¡í•˜ê³  ì¸ë±ì‹± ì¡ì„ íŠ¸ë¦¬ê±°í•œë‹¤.<br />
parameters:<br />
items: [{title, source_path, lang_hint?, tags?, acl_users?, acl_roles?, doc_id?}]<br />
reindex: boolean = true</p>
  </li>
  <li>
    <p>rebuild_index<br />
name: rebuild_index<br />
description: ì „ì²´ ë˜ëŠ” íŠ¹ì • ë¬¸ì„œì˜ ì„ë² ë”©Â·FAISS ì¸ë±ìŠ¤ë¥¼ ì¬ìƒì„±í•œë‹¤.<br />
parameters:<br />
scope: "all"|"doc"<br />
doc_id?: string<br />
which: "mtext"|"en"|"both" = "mtext"</p>
  </li>
  <li>
    <p>describe_doc<br />
name: describe_doc<br />
description: ë¬¸ì„œ ë©”íƒ€Â·ìƒíƒœÂ·ì²­í¬ ìˆ˜ë¥¼ ì¡°íšŒí•œë‹¤.<br />
parameters:<br />
doc_id: string</p>
  </li>
  <li>
    <p>purge_docs<br />
name: purge_docs<br />
description: ë¬¸ì„œë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì™€ ë©”íƒ€DB, ì¸ë±ìŠ¤ì—ì„œ ì™„ì „ ì‚­ì œí•œë‹¤.<br />
parameters:<br />
doc_ids: string[]</p>
  </li>
  <li>
    <p>search_docs<br />
name: search_docs<br />
description: ì¿¼ë¦¬ì™€ í•„í„°ë¡œ ë¬¸ì„œ ìƒìœ„ N â†’ ì²­í¬ ìƒìœ„ K â†’ ì¬ë­í¬ í›„ ì»¨í…ìŠ¤íŠ¸ ë¹Œë“œ<br />
parameters:<br />
query: string<br />
filters?: { langs?: string[], tags?: string[], doc_ids?: string[], updated_after?: string }<br />
top_docs?: int = 10<br />
top_chunks_per_doc?: int = 5<br />
final_chunks?: int = 12<br />
max_context_tokens?: int = 6000<br />
use_hybrid?: boolean = true ë²¡í„° + FTS5<br />
use_mmr?: boolean = true<br />
use_reranker?: boolean = true í¬ë¡œìŠ¤ ì¸ì½”ë”ê°€ ìˆìœ¼ë©´ ì‚¬ìš©<br />
translate_query_to_en?: boolean = false</p>
  </li>
</ol>

<p>ì£¼ìš” ë™ì‘ ìŠ¤ì¼€ì¹˜</p>

<p>A) ì—…ì„œíŠ¸ì™€ ì¸ë±ì‹±</p>

<ol>
  <li>
    <p>upsert_documents(items):<br />
a. íŒŒì¼ ì¡´ì¬ í™•ì¸ â†’ rag_store/blobs/{doc_id}/ì— ë³µì‚¬<br />
b. rag_meta.sqliteì˜ documentsì— upsert, status='processing'<br />
c. ì¸ë±ì‹± ì›Œì»¤ íŠ¸ë¦¬ê±°(worker_index_document(doc_id))</p>
  </li>
  <li>
    <p>worker_index_document(doc_id):<br />
a. í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ rag_store/texts/{doc_id}.txt<br />
b. ì²­í¬ ìƒì„± â†’ rag_store/chunks/{doc_id}.jsonl ì €ì¥, chunks í…Œì´ë¸” êµì²´ ì‚½ì…<br />
c. ì„ë² ë”© ìƒì„± â†’ rag_store/embeddings/mtext/{doc_id}.npy ì €ì¥<br />
d. SQLite FTS5 ë™ê¸°í™”: chunksë¥¼ fts_chunksì— ì‚½ì…<br />
e. documents.status='ready', updated_at=now<br />
f. ê¸€ë¡œë²Œ FAISS ì¸ë±ìŠ¤ ê°±ì‹ : indices/faiss_mtext.index ë¡œë“œ â†’ add_with_ids â†’ ì €ì¥</p>
  </li>
</ol>

<p>B) ê²€ìƒ‰<br />
search_docs(query, â€¦):</p>

<ol>
  <li>
    <p>ì¿¼ë¦¬ ì „ì²˜ë¦¬ì™€ ì„ë² ë”© ì¤€ë¹„(í•„ìš”ì‹œ koâ†’en ë²ˆì—­)</p>
  </li>
  <li>
    <p>ë¬¸ì„œ ë ˆë²¨ í”„ë¦¬ì…€ë ‰ì…˜<br />
a. FTS5 ë¬¸ì„œ í›„ë³´: SELECT doc_id FROM fts_chunks WHERE fts_chunks MATCH ? LIMIT N_bm25<br />
b. FAISS í›„ë³´: ì¿¼ë¦¬ ì„ë² ë”©ìœ¼ë¡œ topN ì²­í¬ ê²€ìƒ‰ â†’ doc_id ì§‘ê³„ ìƒìœ„ N_vec<br />
c. ë‘ ê²°ê³¼ë¥¼ RRFë¡œ í•©ì³ ìƒìœ„ top_docs ë„ì¶œ</p>
  </li>
  <li>
    <p>ì²­í¬ ë ˆë²¨ ì •ë°€ ê²€ìƒ‰<br />
a. ì„ íƒ ë¬¸ì„œë³„ë¡œ top_chunks_per_docì”© FAISS ê²€ìƒ‰<br />
b. í•„ìš”ì‹œ FTS5 ê²°ê³¼ë„ ë³‘í•©<br />
c. MMRë¡œ ë‹¤ì–‘í™”, í¬ë¡œìŠ¤ ì¸ì½”ë” ì¬ë­í¬</p>
  </li>
  <li>
    <p>ì»¨í…ìŠ¤íŠ¸ íŒ¨í‚¹<br />
a. final_chunks ê°œìˆ˜ì™€ max_context_tokens ì•ˆì—ì„œ íŒ¨í‚¹<br />
b. citationsì— doc_id, title, page, section, score í¬í•¨</p>
  </li>
  <li>
    <p>ë°˜í™˜: {context, citations, diagnostics}</p>
  </li>
</ol>

<p>C) ì‚­ì œì™€ ì¬ì¸ë±ì‹±<br />
purge_docs: íŒŒì¼ ë””ë ‰í„°ë¦¬, í…ìŠ¤íŠ¸, ì²­í¬ jsonl, npy ì œê±° â†’ SQLiteì—ì„œ ë¬¸ì„œÂ·ì²­í¬ ì‚­ì œ â†’ FAISSì—ì„œ í•´ë‹¹ ID ì‚­ì œ í›„ ì €ì¥<br />
rebuild_index: scope='all'ì´ë©´ ì„ë² ë”©ê³¼ FAISSë¥¼ ì œë¡œë¶€í„° ë¦¬ë¹Œë“œ, whichë¡œ mtext/en ì„ íƒ</p>

<p>íŒŒì¼ í¬ë§·ê³¼ ì €ì¥ ë°©ì‹<br />
ì„ë² ë”© ì €ì¥: NumPy .npy, dtype=float32, shape=[num_chunks, dim]<br />
FAISS ì¸ë±ìŠ¤: IVF_FLAT ë˜ëŠ” HNSW. index.reset(); index.add_with_ids(vecs, global_ids) í›„ write_index<br />
ê¸€ë¡œë²Œ ID: 64-bit ì •ìˆ˜. ê¶Œì¥ ë§¤í•‘ì€ hash64("{doc_id}:{chunk_id}")ë¡œ ë§Œë“¤ê³  SQLiteì— gid ì»¬ëŸ¼ìœ¼ë¡œ ì €ì¥<br />
ì²­í¬ JSONL: í•œ ì¤„ì— í•œ ì²­í¬. ëŒ€ìš©ëŸ‰ append/replaceê°€ ì‰¬ì›Œ ìš´ì˜ ê°„ë‹¨</p>

<p>ê°„ë‹¨ ì½”ë“œ ìŠ¤ë‹ˆí«ë“¤</p>

<ol>
  <li>ì„ë² ë”© npy ì €ì¥/ë¡œë“œ<br />
import numpy as np</li>
</ol>

<p>def save_embeddings_npy(path, matrix):<br />
path.parent.mkdir(parents=True, exist_ok=True)<br />
np.save(path, matrix.astype(np.float32))</p>

<p>def load_embeddings_npy(path):<br />
return np.load(path).astype(np.float32)</p>

<ol>
  <li>FAISS ì¸ë±ìŠ¤ ë¡œë“œ/ì €ì¥/ê°±ì‹ <br />
import faiss<br />
from pathlib import Path</li>
</ol>

<p>def load_faiss(path, dim):<br />
if Path(path).exists():<br />
return faiss.read_index(str(path))<br />
index = faiss.index_factory(dim, "IVF4096,Flat", faiss.METRIC_INNER_PRODUCT)<br />
quantizer = faiss.IndexFlatIP(dim)<br />
index_ivf = faiss.IndexIVFFlat(quantizer, dim, 4096, faiss.METRIC_INNER_PRODUCT)<br />
return index if isinstance(index, faiss.Index) else index_ivf</p>

<p>def save_faiss(index, path):<br />
Path(path).parent.mkdir(parents=True, exist_ok=True)<br />
faiss.write_index(index, str(path))</p>

<p>def add_embeddings(index, vecs, ids):<br />
faiss.normalize_L2(vecs)<br />
if hasattr(index, "is_trained") and not index.is_trained:<br />
index.train(vecs)<br />
index.add_with_ids(vecs, ids)</p>

<ol>
  <li>SQLite FTS5 ì‚½ì…<br />
import sqlite3, json</li>
</ol>

<p>def upsert_chunks_sqlite(db_path, doc_id, chunks):<br />
conn = sqlite3.connect(db_path)<br />
c = conn.cursor()<br />
c.execute("DELETE FROM chunks WHERE doc_id=?", (doc_id,))<br />
for ch in chunks:<br />
c.execute("INSERT INTO chunks(chunk_id,doc_id,page,section,content,tokens) VALUES(?,?,?,?,?,?)",<br />
(ch["chunk_id"], doc_id, ch.get("page"), ch.get("section"), ch["content"], ch.get("tokens",0)))<br />
c.execute("INSERT INTO fts_chunks(rowid, content) SELECT rowid, content FROM chunks WHERE doc_id=?", (doc_id,))<br />
conn.commit()<br />
conn.close()</p>

<ol>
  <li>ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸ í•µì‹¬<br />
def search_pipeline(query, top_docs=10, top_chunks_per_doc=5, final_chunks=12):</li>
</ol>

<h1 id="1-ì¿¼ë¦¬-ì„ë² ë”©">1) ì¿¼ë¦¬ ì„ë² ë”©</h1>

<p>q_vec = embed_mtext([query])[0].astype("float32")<br />
faiss.normalize_L2(q_vec.reshape(1,-1))</p>

<h1 id="2-ê¸€ë¡œë²Œ-ì²­í¬ì—ì„œ-topn-í›„ë³´">2) ê¸€ë¡œë²Œ ì²­í¬ì—ì„œ topN í›„ë³´</h1>

<p>D, I = faiss_index.search(q_vec.reshape(1,-1), 200)<br />
chunk_candidates = gather_chunks_by_ids(I[0], D[0]) # SQLiteì—ì„œ ë©”íƒ€ ë¡œë“œ</p>

<h1 id="3-ë¬¸ì„œ-ì§‘ê³„--ìƒìœ„-top_docs">3) ë¬¸ì„œ ì§‘ê³„ â†’ ìƒìœ„ top_docs</h1>

<p>doc_scores = aggregate_by_doc(chunk_candidates)<br />
doc_top = take_top(doc_scores, top_docs)</p>

<h1 id="4-ë¬¸ì„œë³„-ì¬ê²€ìƒ‰">4) ë¬¸ì„œë³„ ì¬ê²€ìƒ‰</h1>

<p>refined = []<br />
for d in doc_top:<br />
refined += search_chunks_in_doc(d.doc_id, q_vec, top_chunks_per_doc)<br />
refined = mmr_diversify(refined, k=final_chunks*4)<br />
ranked = rerank_cross_encoder(query, refined)[:final_chunks]</p>

<h1 id="5-ì»¨í…ìŠ¤íŠ¸-ë¹Œë“œ">5) ì»¨í…ìŠ¤íŠ¸ ë¹Œë“œ</h1>

<p>context, citations = build_context_and_citations(ranked)<br />
return {"context": context, "citations": citations}</p>

<p>ìš´ì˜Â·ì•ˆì „ í¬ì¸íŠ¸<br />
ë½í‚¹: indices/index.lock íŒŒì¼ë¡œ íŒŒì¼ ì ê¸ˆ í›„ ì¸ë±ìŠ¤ ì €ì¥.<br />
ì›ìì„±: ì¸ë±ìŠ¤ ì €ì¥ì€ tmpì— ì“´ ë’¤ renameìœ¼ë¡œ êµì²´.<br />
ë²„ì „ê´€ë¦¬: manifest/embedding_manifest.jsonì— ëª¨ë¸ëª…, ì°¨ì›, í† í°ë¼ì´ì € ë²„ì „ ê¸°ë¡.<br />
ê¶Œí•œ: documents.acl_users/acl_rolesë¥¼ ê²€ìƒ‰ ì „ í•„í„°ì— ë°˜ì˜.<br />
ë³µêµ¬: ì²­í¬ JSONL â†’ SQLite ì¬êµ¬ì¶•, npy â†’ FAISS ì¬ë¹Œë“œê°€ ê°€ëŠ¥í•˜ë„ë¡ ìœ ì§€.</p>

<p>ì¶”ì²œ ê¸°ë³¸ê°’<br />
embedding ëª¨ë¸: bge-m3, dim=1024<br />
ì²­í¬ í¬ê¸°: 200~400 í† í°, overlap 15%<br />
faiss nprobe: 8~32, IVF lists: 4096ë¶€í„° ì‹œì‘<br />
ê²€ìƒ‰ í­: top_docs=10, top_chunks_per_doc=5, final_chunks=12, max_context_tokens=6000<br />
í•˜ì´ë¸Œë¦¬ë“œ: use_hybrid=true, FTS5 ê°€ì¤‘ì¹˜ 0.3, ë²¡í„° 0.7</p>

<p>ì •ë¦¬<br />
ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œë§Œìœ¼ë¡œë„ ë¬¸ì„œ ë“±ë¡ë¶€í„° ì¸ë±ì‹±, ê²€ìƒ‰ê¹Œì§€ ì¶©ë¶„íˆ ì•ˆì •ì ì¸ RAG ìŠ¤í† ì–´ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤. í•µì‹¬ì€ ê·œì¹™ì ì¸ ë””ë ‰í„°ë¦¬ êµ¬ì¡°, SQLite+FTS5ë¡œì˜ ë©”íƒ€Â·í‚¤ì›Œë“œ ì²˜ë¦¬, FAISS ì¸ë±ìŠ¤ì˜ ì•ˆì „ ì €ì¥, ê·¸ë¦¬ê³  FunctionTool ì„¸íŠ¸ë¥¼ í†µí•œ ì¼ê´€ëœ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ì´ë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì›í•˜ë©´ ì´ ìŠ¤í™ì„ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ìµœì†Œ Python íŒ¨í‚¤ì§€ êµ¬ì¡°ì™€ CLIê¹Œì§€ í¬í•¨í•´ ë¼ˆëŒ€ ì½”ë“œë¥¼ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ìœ ì €ê°€ ì‚¬ìš©í•  ë• ì–´ë–¤ ìˆœì„œë¡œ í•´ì•¼í•´?

</p>

<p>ë‹¤ìŒ ìˆœì„œëŒ€ë¡œ ì“°ë©´ ë©ë‹ˆë‹¤. í•œ ë²ˆ ìµíˆë©´ íë¦„ì´ ëŠ˜ ê°™ìŠµë‹ˆë‹¤: ë“±ë¡ â†’ ì¸ë±ì‹± â†’ ê²€ìƒ‰ â†’ ë‹µë³€.</p>

<ol>
  <li>ìµœì´ˆ 1íšŒ ì„¤ì •</li>
</ol>

<ul>
  <li>
    <p>ë¡œì»¬ ë””ë ‰í„°ë¦¬ ì¤€ë¹„: rag_store/ í•˜ìœ„ì— blobs, texts, chunks, embeddings, indices, manifest, locksì™€ rag_meta.sqlite ìƒì„±.</p>
  </li>
  <li>
    <p>ì„ë² ë”©/ì¸ë±ìŠ¤ ì´ˆê¸°í™”: embedding ëª¨ë¸ ì„ íƒ(bge-m3 ë“±), FAISS ì¸ë±ìŠ¤ íŒŒì¼ ìƒì„±(indices/faiss_mtext.index).</p>
  </li>
</ul>

<ol>
  <li>ë¬¸ì„œ ë“±ë¡</li>
</ol>

<ul>
  <li>
    <p>íŒŒì¼ì„ ì¤€ë¹„í•˜ê³  upsert_documents í•¨ìˆ˜(ë˜ëŠ” API/CLI)ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.<br />
ì˜ˆì‹œ(Python/FunctionTool í˜¸ì¶œ íŒŒë¼ë¯¸í„°)<br />
{<br />
"items": [<br />
{<br />
"title": "spec_A.pdf",<br />
"source_path": "/path/spec_A.pdf",<br />
"lang_hint": "en",<br />
"tags": ["spec","v1"]<br />
}<br />
],<br />
"reindex": true<br />
}</p>
  </li>
  <li>
    <p>ë‚´ë¶€ ë™ì‘: íŒŒì¼ì„ blobs/{doc_id}/ë¡œ ë³µì‚¬í•˜ê³  documents í…Œì´ë¸”ì— ê¸°ë¡, status='processing', ì¸ë±ì‹± ì¡ì„ íì— ë„£ìŒ.</p>
  </li>
</ul>

<ol>
  <li>ì¸ë±ì‹± ìë™ ì²˜ë¦¬</li>
</ol>

<ul>
  <li>
    <p>ì›Œì»¤ê°€ í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ ì²­í¬ â†’ ì„ë² ë”©(npy) ì €ì¥ â†’ FAISS ì¸ë±ìŠ¤ ê°±ì‹  â†’ FTS5 ì—…ë°ì´íŠ¸ â†’ status='ready'ë¡œ ì „í™˜.</p>
  </li>
  <li>
    <p>í•„ìš”í•˜ë©´ describe_doc(doc_id)ë¡œ ìƒíƒœ í™•ì¸. ì²­í¬ ìˆ˜, í˜ì´ì§€ ìˆ˜, ì„ë² ë”© ëª¨ë¸ ë²„ì „ ë“±ì„ ë°”ë¡œ í™•ì¸ ê°€ëŠ¥.</p>
  </li>
</ul>

<ol>
  <li>ê²€ìƒ‰ê³¼ ì§ˆì˜ì‘ë‹µ</li>
</ol>

<ul>
  <li>
    <p>ì‚¬ìš©ìê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë¨¼ì € search_docsë¥¼ í˜¸ì¶œí•´ ì»¨í…ìŠ¤íŠ¸ë¥¼ í™•ë³´í•©ë‹ˆë‹¤.<br />
ê¶Œì¥ íŒŒë¼ë¯¸í„° ì˜ˆ:<br />
{<br />
"query": "ë°˜í’ˆ ì •ì±… í•µì‹¬ì´ ë­ì•¼?",<br />
"filters": { "langs": ["en"], "tags": ["policy"] },<br />
"top_docs": 10,<br />
"top_chunks_per_doc": 5,<br />
"final_chunks": 12,<br />
"use_hybrid": true,<br />
"use_mmr": true,<br />
"use_reranker": true,<br />
"max_context_tokens": 6000<br />
}</p>
  </li>
  <li>
    <p>search_docsê°€ ë°˜í™˜í•œ contextì™€ citationsë¥¼ LLMì— ë„£ì–´ ë‹µë³€ ìƒì„±.</p>
  </li>
  <li>
    <p>í•œê¸€ ì§ˆì˜ë¡œ ì˜ì–´ ë¬¸ì„œë¥¼ ì°¾ìœ¼ë ¤ë©´ ë‹¤êµ­ì–´ ì„ë² ë”© ë˜ëŠ” translate_query_to_en=trueë¥¼ ì‚¬ìš©.</p>
  </li>
</ul>

<ol>
  <li>ìš´ì˜ ì¤‘ ë¬¸ì„œ ì¶”ê°€/ê°±ì‹ </li>
</ol>

<ul>
  <li>
    <p>ìƒˆ íŒŒì¼ ì¶”ê°€: upsert_documents(items=[â€¦], reindex=true).</p>
  </li>
  <li>
    <p>ê¸°ì¡´ ë¬¸ì„œ êµì²´: ê°™ì€ doc_idë¡œ upsertí•˜ê±°ë‚˜ source_pathë¥¼ ì—…ë°ì´íŠ¸ í›„ reindex.</p>
  </li>
  <li>
    <p>ì—¬ëŸ¬ íŒŒì¼ ë°°ì¹˜ ë“±ë¡ë„ ë™ì¼. ìƒíƒœê°€ â€˜readyâ€™ê°€ ë˜ë©´ ë°”ë¡œ ê²€ìƒ‰ì— í¬í•¨ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>ì¬ì¸ë±ì‹±ê³¼ ì²­ì†Œ</li>
</ol>

<ul>
  <li>
    <p>ì„ë² ë”© ëª¨ë¸ êµì²´ë‚˜ ì²­í¬ ê·œì¹™ ë³€ê²½ ì‹œ rebuild_indexë¡œ ì „ì²´ ë˜ëŠ” íŠ¹ì • ë¬¸ì„œë¥¼ ì¬ë¹Œë“œ.<br />
{<br />
"scope": "all",<br />
"which": "mtext"<br />
}</p>
  </li>
  <li>
    <p>ë¬¸ì„œ ì‚­ì œëŠ” purge_docsë¡œ ì²˜ë¦¬. ë¡œì»¬ íŒŒì¼, í…ìŠ¤íŠ¸, ì²­í¬, ì„ë² ë”©, ë©”íƒ€DB, FAISS ì°¸ì¡°ê¹Œì§€ ì •ë¦¬.</p>
  </li>
</ul>

<ol>
  <li>ê¶Œí•œê³¼ í•„í„°ë§</li>
</ol>

<ul>
  <li>
    <p>ì‚¬ìš©ìë³„ë¡œ roles/user_idë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì „ë‹¬í•˜ê³ , search_docsê°€ ACLì„ ë°˜ì˜í•´ í•„í„°ë§.</p>
  </li>
  <li>
    <p>íƒœê·¸, ì–¸ì–´, ìˆ˜ì •ì¼(updated_after)ë¡œ ê²€ìƒ‰ ë²”ìœ„ë¥¼ ì¤„ì—¬ ì§€ì—°ì„ ì•ˆì •í™”.</p>
  </li>
</ul>

<ol>
  <li>ì¥ì• /í’ˆì§ˆ ê´€ë¦¬ íŒ</li>
</ol>

<ul>
  <li>
    <p>status='error'ì¼ ë•Œ describe_docë¡œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸ í›„ ì¬ì‹œë„.</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ í’ˆì§ˆ ì €í•˜ ì‹œ ì´ ìˆœì„œë¡œ ì ê²€: ì²­í¬ í¬ê¸°(200~400 í† í°), ì„ë² ë”© ëª¨ë¸ ì¼ì¹˜, í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ í™œì„±í™”, ë¦¬ë­ì»¤ ì ìš©, MMR ë‹¤ì–‘í™”, ìµœì‹  ê°€ì¤‘ì¹˜ ì ìš©.</p>
  </li>
  <li>
    <p>ì§€ì—°ì´ ëŠë¦¬ë©´ top_docs, top_chunks_per_doc, final_chunksë¥¼ ì¤„ì´ê³ , FAISS nprobe íŠœë‹.</p>
  </li>
</ul>

<p>ì‚¬ìš©ì ê²½í—˜ ê´€ì ì˜ ìµœì†Œ íë¦„(ì§„ì§œ ì‹¤ë¬´ìš© ì••ì¶•ë³¸)</p>

<ol>
  <li>
    <p>íŒŒì¼ ë“œë˜ê·¸Â·ë“œë¡­ ë˜ëŠ” ì—…ë¡œë“œ â†’ upsert_documents(reindex=true)</p>
  </li>
  <li>
    <p>ì ì‹œ í›„ ì¤€ë¹„ ì™„ë£Œ â†’ describe_docë¡œ ready í™•ì¸</p>
  </li>
  <li>
    <p>ì§ˆë¬¸ ì…ë ¥ â†’ ë°±ì—”ë“œê°€ search_docs í˜¸ì¶œ â†’ context ìˆ˜ì§‘</p>
  </li>
  <li>
    <p>LLM í˜¸ì¶œ â†’ í•œêµ­ì–´ ë‹µë³€ê³¼ ì¶œì²˜ í‘œì‹œ</p>
  </li>
  <li>
    <p>ì¶”ê°€ íŒŒì¼ì´ ìƒê¸°ë©´ 1ë¡œ ëŒì•„ê°</p>
  </li>
</ol>

<p>API/CLI ì˜ˆì‹œ í•œ ì¤„ì”©</p>

<ul>
  <li>
    <p>ë“±ë¡: cli upsert â€“path /docs/spec.pdf â€“title "spec" â€“lang en â€“tag spec â€“reindex</p>
  </li>
  <li>
    <p>ìƒíƒœ: cli describe â€“doc-id <uuid></uuid></p>
  </li>
  <li>
    <p>ê²€ìƒ‰: cli search â€“q "refund policy" â€“lang en â€“top-docs 10 â€“top-chunks 5</p>
  </li>
  <li>
    <p>ì¬ë¹Œë“œ: cli rebuild â€“scope all</p>
  </li>
  <li>
    <p>ì‚­ì œ: cli purge â€“doc-ids <uuid1>,<uuid2></uuid2></uuid1></p>
  </li>
</ul>

<p>ì´ íë¦„ì„ ì•±ì— ë…¹ì´ë©´ ìµœì¢… ì‚¬ìš©ìëŠ” â€œë¬¸ì„œ ì—…ë¡œë“œ â†’ ì§ˆë¬¸â€ë§Œ ì•Œë©´ ë˜ê³ , ë‚˜ë¨¸ì§€ ì „ì²˜ë¦¬Â·ê²€ìƒ‰Â·ì»¨í…ìŠ¤íŠ¸ íŒ¨í‚¹ì€ ë°±ì—”ë“œê°€ FunctionToolë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì›í•˜ë©´, ìœ„ ìˆœì„œë¥¼ ê·¸ëŒ€ë¡œ ìˆ˜í–‰í•˜ëŠ” REST ë¼ìš°íŠ¸ ë˜ëŠ” ê°„ë‹¨í•œ CLI ìŠ¤ì¼ˆë ˆí†¤ì„ ë§Œë“¤ì–´ ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI Debug ë…¸ë“œ ë¦¬íŒ©í„°ë§</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor/" rel="alternate" type="text/html" title="ComfyUI Debug ë…¸ë“œ ë¦¬íŒ©í„°ë§" /><published>2025-11-04T12:48:12+09:00</published><updated>2025-11-04T12:48:12+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor/"><![CDATA[<p class="chat--user">

ì´ê±° ë‚´ê°€ ê°œë°œí•œ ComfyUI ë…¸ë“œì•¼. ìŠ¤íŠ¸ë§ ì—¬ëŸ¬ ê°œê°€ ì…ë ¥ë˜ì—ˆì„ ë•Œ ì¸ë±ìŠ¤ ì„ íƒí•˜ëŠ” ì½¤ë³´ ìœ„ì ¯ + ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ëŠ” í…ìŠ¤íŠ¸ ìœ„ì ¯ìœ¼ë¡œ ë˜ì–´ ìˆì–´. 
<code class="language-plaintext highlighter-rouge">
js
import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
    name: "hvppyflow.debug_nodes",
    async beforeRegisterNodeDef(nodeType, nodeData, app) {
        if (nodeData.name === "HFDebug") {
            const onExecuted = nodeType.prototype.onExecuted;
            nodeType.prototype.onExecuted = function (message) {
                onExecuted?.apply(this, arguments);

                this.properties.text = message["text"]

                let comboWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displayindex");
                let textWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displaytext");
                if (!comboWidget) {
                    comboWidget = this.addWidget("combo", "displayindex", 0, () =&gt; {
                        comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                        textWidget.value = message["text"]?.[comboWidget.value];       
                    }, {values: Array.from({ length: message["text"].length }, (_, i) =&gt; i)});
                    comboWidget.value = 0;
                } 
                if (!textWidget) {
                    textWidget = ComfyWidgets["STRING"](this, "displaytext", ["STRING", { multiline: true }], app).widget;
                    textWidget.inputEl.readOnly = true;
                    textWidget.inputEl.style.border = "none";
                    textWidget.inputEl.style.backgroundColor = "transparent";
                    textWidget.serialize = false;
                    textWidget.options.serialize = false; // Prevent prompt serialization
                }
                
                if (comboWidget.options.values.length !== message["text"].length) {
                    comboWidget.options.values = Array.from({ length: message["text"].length }, (_, i) =&gt; i);
                    comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                }
                textWidget.value = message["text"]?.[comboWidget.value];

                comboWidget.onChange = (data) =&gt; {
                    console.log("Combo changed" + comboWidget.value);
                    const index = comboWidget.value;
                    textWidget.value = message["text"]?.[index];
                };
            };

            const onConfigure = nodeType.prototype.onConfigure;
            nodeType.prototype.onConfigure = function () {
                onConfigure?.apply(this, arguments);
                
                let comboWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displayindex");
                let textWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displaytext");
                if (!comboWidget) {
                    comboWidget = this.addWidget("combo", "displayindex", 0, () =&gt; {
                        comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                        textWidget.value = this.properties?.text?.[comboWidget.value];
                    }, {values: Array.from({ length: this.properties?.text.length ?? 0 }, (_, i) =&gt; i)});
                    comboWidget.value = 0;
                }
                if (!textWidget) {
                    textWidget = ComfyWidgets["STRING"](this, "displaytext", ["STRING", { multiline: true }], app).widget;
                    textWidget.inputEl.readOnly = true;
                    textWidget.inputEl.style.border = "none";
                    textWidget.inputEl.style.backgroundColor = "transparent";
                    textWidget.serialize = false;
                    textWidget.options.serialize = false; // Prevent prompt serialization
                }

                if (comboWidget.options.values.length !== this.properties?.text.length) {
                    comboWidget.options.values = Array.from({ length: this.properties?.text.length }, (_, i) =&gt; i);
                    comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                }

                comboWidget.onChange = (data) =&gt; {
                    console.log("Combo changed" + comboWidget.value);
                    const index = comboWidget.value;
                    textWidget.value = this.properties?.text?.[index];
                };

                if (this.properties?.text) {
                    textWidget.value = this.properties?.text?.[comboWidget.value];
                }
            };
        }
    },
});
</code>
<code class="language-plaintext highlighter-rouge">python
class HFDebug:
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "text": ("STRING", {"forceInput": True}),
            },
            "hidden": {
                "unique_id": "UNIQUE_ID",
            },
        }

    @classmethod
    def IS_CHANGED(cls, **kwargs):
        import logging
        logging.info("HPDebug - IS_CHANGED called with kwargs: %s", kwargs)
        text = kwargs.get("text")
        if isinstance(text, list):
            return tuple(text)
        return text

    INPUT_IS_LIST = True
    RETURN_TYPES = ("STRING",)
    FUNCTION = "notify"
    OUTPUT_NODE = True
    OUTPUT_IS_LIST = (True,)
    CATEGORY = "utils"

    def notify(self, text, unique_id=None):
        return {"ui": {"text": text}, "result": (text,)}
</code>

ì—¬ê¸°ì„œ string ë¦¬ìŠ¤íŠ¸ ê¸¸ì´ê°€ 1ì´ë©´ ì½¤ë³´ ìœ„ì ¯ì€ í—·ê°ˆê¸°ë§Œ í•˜ë‹ˆê¹Œ ê·¸ëƒ¥ ìƒì„±ì„ ì•ˆí•˜ë„ë¡ í•˜ê³  ì‹¶ì–´. ë‹¤ì–‘í•œ ë³€ìˆ˜ë¥¼ ê³ ë ¤í•´ì„œ ì‘ì„±í•´ì¤˜(ë¦¬ìŠ¤íŠ¸ ê¸¸ë‹¤ê°€ -&gt; 1ê°œë¡œ ì¤„ì–´ë“¤ ë•Œ, 1ê°œ ì˜€ë‹¤ê°€ ì—¬ëŸ¬ê°œê°€ ë  ë•Œ, ê¸¸ì´ê°€ ë³€í•  ë•Œ ë“±ë“±) ê·¸ë¦¬ê³  ë‚´ê°€ js ì´ˆë³´ìë¼ ì¢€ ì“¸ë° ì—†ì´ ì½”ë“œê°€ ê¸´ ê²ƒ ê°™ì€ë° ì •ë¦¬ë„ í•´ì£¼ë©´ ì¢‹ê² ì–´. ê·¸ë¦¬ê³  ë²„ê·¸ì¸ì§„ ëª¨ë¥´ê² ëŠ”ë° ë²„ê·¸ê°€ ìˆì–´. í™”ì‚´í‘œë¡œ ë„˜ê¸°ë©´ pageê°€ 1 -&gt; 2 ì´ëŸ° ì‹ìœ¼ë¡œ ë³€í•´ì•¼í•  ê²ƒ ê°™ì€ë° í•­ìƒ 0ìœ¼ë¡œ ëŒì•„ê°€. í´ë¦­í•´ì„œ ì½¤ë³´ ì„ íƒìœ¼ë¡œ ë„˜ê²¨ì•¼ë§Œ ì˜ ëŒì•„ê°€. ì´ ë²„ê·¸ë„ ê³ ì³ì£¼ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„, ìš”êµ¬ì‚¬í•­ì„ ì „ë¶€ ë°˜ì˜í•´ì„œ JS ìª½ì„ ê¹”ë”í•˜ê²Œ ë¦¬íŒ©í„°ë§í•˜ê³ , â€œë¦¬ìŠ¤íŠ¸ ê¸¸ì´ = 1ì´ë©´ ì½¤ë³´ ìœ„ì ¯ì„ ë§Œë“¤ì§€ ì•Šê¸°â€, â€œê¸¸ì´ê°€ ëŠ˜ì—ˆë‹¤/ì¤„ì—ˆë‹¤/ë³€í–ˆë‹¤ ì¼€ì´ìŠ¤ ëª¨ë‘ ì²˜ë¦¬â€, â€œí‚¤ë³´ë“œ í™”ì‚´í‘œë¡œ ë°”ê¿€ ë•Œ 0ìœ¼ë¡œ ë˜ëŒì•„ê°€ëŠ” ë²„ê·¸â€ê¹Œì§€ ì¡ì€ ë²„ì „ì„ ì•„ë˜ì— ì œì‹œí• ê²Œ. í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ë‹¤ìŒì´ì•¼.</p>

<ol>
  <li>
    <p>ì„ íƒ ì¸ë±ìŠ¤ë¥¼ this.properties.selectedIndexë¡œ ë³´ì¡´í•´ì„œ ì¬ì‹¤í–‰(onExecuted)Â·ì¬êµ¬ì„±(onConfigure) ì‹œì— ê°’ì´ ë®ì–´ì¨ì§€ì§€ ì•Šê²Œ í•¨.</p>
  </li>
  <li>
    <p>ì½¤ë³´ ìœ„ì ¯ì€ â€œí•„ìš”í•  ë•Œë§Œâ€ ë§Œë“¤ê³ (ê¸¸ì´ â‰¥ 2), ë¶ˆí•„ìš”í•˜ë©´ ì œê±°. ì œê±° ì‹œì— ì•ˆì „í•˜ê²Œ widgets ë°°ì—´ì—ì„œ ëº€ ë’¤ ë…¸ë“œ í¬ê¸° ì¬ê³„ì‚°.</p>
  </li>
  <li>
    <p>onChange ì•ˆì—ì„œ comboWidget.valueë¥¼ ë‹¤ì‹œ ê±´ë“œë¦¬ì§€ ì•ŠìŒ. ì‚¬ìš©ìê°€ í‚¤ë³´ë“œ/ë§ˆìš°ìŠ¤ë¡œ ë°”ê¾¼ ê°’ì„ ê·¸ëŒ€ë¡œ ì“°ê³ , ê·¸ ê°’ì„ propertiesì— ì €ì¥ë§Œ í•¨.</p>
  </li>
  <li>
    <p>ì˜µì…˜ ê¸¸ì´ê°€ ë°”ë€Œì–´ë„ í˜„ì¬ selectedIndexë¥¼ ìµœëŒ€ ê¸¸ì´-1ë¡œë§Œ í´ë¨í”„í•˜ê³ , êµ³ì´ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ.</p>
  </li>
  <li>
    <p>ì…ë ¥ì´ string í•˜ë‚˜ì´ë“  listì´ë“  ì•ˆì „í•˜ê²Œ ì²˜ë¦¬(Array ë˜í•‘). ê¸¸ì´ 0ë„ ë°©ì–´.</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œë¡œ êµì²´í•˜ë©´ ë¼.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // ---------- ìœ í‹¸: ì•ˆì „í•œ remove ----------
    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        // LiteGraph/ComfyUIì—ì„œëŠ” í¬ê¸° ì¬ê³„ì‚°ì´ í•„ìš”í•¨
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    // ---------- ìœ í‹¸: í…ìŠ¤íŠ¸ë¥¼ í•­ìƒ ë°°ì—´ë¡œ ----------
    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    // ---------- ìœ í‹¸: í…ìŠ¤íŠ¸ ìœ„ì ¯ í™•ë³´ ----------
    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false; // í”„ë¡¬í”„íŠ¸ ì§ë ¬í™” ë°©ì§€
      }
      return textWidget;
    }

    // ---------- ìœ í‹¸: ì½¤ë³´ ìœ„ì ¯ ë³´ì¥/ì—…ë°ì´íŠ¸ ë˜ëŠ” ì œê±° ----------
    function syncComboWidget(node, count) {
      let comboWidget = node.widgets?.find(w =&gt; w.name === "displayindex");

      // ê¸¸ì´ 0 ë˜ëŠ” 1ì´ë©´ ì½¤ë³´ ì œê±°
      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      // í•„ìš”: ì½¤ë³´ ìƒì„±
      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "displayindex",
          0,
          // ì½œë°±ì—ì„œëŠ” valueë¥¼ ë‹¤ì‹œ ì„¸íŒ…í•˜ì§€ ë§ê³ , properties/í…ìŠ¤íŠ¸ë§Œ ë™ê¸°í™”
          () =&gt; {
            const idx = Number(comboWidget.value) || 0;
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values: Array.from({ length: count }, (_, i) =&gt; i) }
        );
        comboWidget.serialize = false; // í•„ìš”ì‹œ ì§ë ¬í™” ë°©ì§€
      }

      // ì˜µì…˜ ê¸¸ì´ ë³€ê²½ ë°˜ì˜
      const needUpdate =
        !comboWidget.options?.values ||
        comboWidget.options.values.length !== count;

      if (needUpdate) {
        comboWidget.options.values = Array.from({ length: count }, (_, i) =&gt; i);
      }

      // í˜„ì¬ ì„ íƒ ì¸ë±ìŠ¤ë¥¼ ë³´ì¡´/í´ë¨í”„
      const current = Number(node.properties.selectedIndex ?? comboWidget.value ?? 0);
      const clamped = Math.max(0, Math.min(current, count - 1));
      // ì‚¬ìš©ì í‚¤ì…ë ¥ì„ ë®ì–´ì“°ì§€ ì•Šê¸° ìœ„í•´ "í•„ìš”í•  ë•Œë§Œ" ë™ê¸°í™”
      if (comboWidget.value !== clamped) {
        comboWidget.value = clamped;
      }
      node.properties.selectedIndex = clamped;

      return comboWidget;
    }

    // ---------- ìœ í‹¸: í…ìŠ¤íŠ¸/ì½¤ë³´/ì„ íƒ ìƒíƒœ ë™ê¸°í™” ----------
    function syncUI(node, texts) {
      // í…ìŠ¤íŠ¸ë¥¼ propertiesì— ì €ì¥ (onConfigure ì¬êµ¬ì„±ìš©)
      node.properties.text = texts;

      // ì½¤ë³´ ìƒì„±/ì œê±°
      const comboWidget = syncComboWidget(node, texts.length);

      // í…ìŠ¤íŠ¸ ìœ„ì ¯ ë³´ì¥ ë° ê°’ ë°˜ì˜
      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      // onChangeëŠ” í•œ ë²ˆë§Œ ì„¤ì • (ì¤‘ë³µ ë“±ë¡ ë°©ì§€)
      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = Number(comboWidget.value) || 0;
          node.properties.selectedIndex = i;
          textWidget.value = texts[i] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    // ---------- onExecuted ----------
    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      // ìµœì‹  ê²°ê³¼ ìˆ˜ì‹ 
      const texts = normalizeToArray(message?.text);

      // ê¸¸ì´ ë³€í™”(ëŠ˜ê±°ë‚˜/ì¤„ê±°ë‚˜/1ê°œê°€ ë¨/ì—¬ëŸ¬ ê°œê°€ ë¨)ë¥¼ ëª¨ë‘ ì»¤ë²„
      // ì„ íƒ ì¸ë±ìŠ¤ë¥¼ "í•„ìš” ì‹œ"ë§Œ í´ë¨í”„í•˜ì—¬ ë³´ì¡´
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };

    // ---------- onConfigure ----------
    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>ë²„ê·¸ ì›ì¸ê³¼ í•´ê²° í¬ì¸íŠ¸ ì„¤ëª…</p>

<ol>
  <li>
    <p>ê°’ ë¦¬ì…‹ ìš”ì¸ ì œê±°<br />
ê¸°ì¡´ ì½”ë“œì—ì„œëŠ” ì½¤ë³´ ìƒì„± ì§í›„ comboWidget.value = 0 ê°™ì€ ê°•ì œ ì´ˆê¸°í™”ê°€ ìˆì—ˆê³ , addWidget ì½œë°±ì—ì„œ comboWidget.valueë¥¼ ë‹¤ì‹œ ì„¸íŒ…í•˜ëŠ” ë¡œì§ë„ ì„ì—¬ ìˆì–´ì„œ ì‚¬ìš©ìì˜ í‚¤ë³´ë“œ ë³€ê²½ ì§í›„ ì—¬ëŸ¬ ê²½ë¡œë¡œ ê°’ì´ ë®ì–´ì¨ì§ˆ ì—¬ì§€ê°€ ìˆì—ˆì–´. ìƒˆ ì½”ë“œëŠ” ì‚¬ìš©ì ì…ë ¥ íë¦„ì„ ì¡´ì¤‘í•´ â€œonChangeì—ì„œ propertiesì™€ í…ìŠ¤íŠ¸ë§Œ ë™ê¸°í™”â€í•˜ê³ , ì½¤ë³´ valueë¥¼ ì„ì˜ë¡œ ë‹¤ì‹œ ì“°ì§€ ì•Šì•„ í‚¤ë³´ë“œ(í™”ì‚´í‘œ) ì¡°ì‘ ì‹œ 0ìœ¼ë¡œ ë¦¬ì…‹ë˜ì§€ ì•Šì•„.</p>
  </li>
  <li>
    <p>ìƒíƒœì˜ ë‹¨ì¼ ì†ŒìŠ¤<br />
ì„ íƒ ì¸ë±ìŠ¤ë¥¼ this.properties.selectedIndexë¡œ í†µì¼í•´ì„œ onExecuted, onConfigure ì‚¬ì´ì—ì„œ ì¼ê´€ì„± ìˆê²Œ ìœ ì§€ë¼. ë°ì´í„° ê¸¸ì´ê°€ ë³€í•  ë•Œë„ selectedIndexë¥¼ ìµœëŒ€ ê¸¸ì´-1ë¡œë§Œ í´ë¨í”„í•˜ë‹ˆ ì‚¬ìš©ìê°€ ê³ ë¥¸ í˜ì´ì§€ê°€ ê°€ëŠ¥í•œ í•œ ìœ ì§€ë¼.</p>
  </li>
  <li>
    <p>ì½¤ë³´ ë™ì  ìƒì„±/ì œê±°<br />
texts.length â‰¤ 1ì´ë©´ ì½¤ë³´ë¥¼ ì œê±°í•˜ê³ , â‰¥ 2ì´ë©´ í•„ìš” ì‹œì—ë§Œ ìƒì„±í•´. ê¸¸ì´ê°€ 1â†’ì—¬ëŸ¬ ê°œ, ì—¬ëŸ¬ ê°œâ†’1, í˜¹ì€ Nì´ ë°”ë€ŒëŠ” ê²½ìš°ì—ë„ syncComboWidgetì´ ì•Œì•„ì„œ ì˜µì…˜/ì„ íƒ/ì œê±°ë¥¼ ì²˜ë¦¬í•´.</p>
  </li>
  <li>
    <p>ìœ„ì ¯ ì œê±° ì•ˆì „ì„±<br />
removeWidget ìœ í‹¸ë¡œ widgets ë°°ì—´ì—ì„œ ì•ˆì „í•˜ê²Œ ë¹¼ê³ , computeSizeë¥¼ í˜¸ì¶œí•´ì„œ ë…¸ë“œ ë ˆì´ì•„ì›ƒì´ ê¹¨ì§€ì§€ ì•Šë„ë¡ í–ˆì–´.</p>
  </li>
</ol>

<p>ì¶”ê°€ë¡œ ê³ ë ¤í•œ ì—£ì§€ ì¼€ì´ìŠ¤</p>

<ul>
  <li>
    <p>textê°€ ì•„ì˜ˆ ì˜¤ì§€ ì•Šê±°ë‚˜(null/undefined) ë¹ˆ ë¦¬ìŠ¤íŠ¸ì¼ ë•Œì—ë„ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬í•˜ê³  í…ìŠ¤íŠ¸ ìœ„ì ¯ì—” ë¹ˆ ë¬¸ìì—´ í‘œì‹œ.</p>
  </li>
  <li>
    <p>ì½¤ë³´ ì˜µì…˜ì´ ê°±ì‹ ë  ë•Œ í˜„ì¬ ì„ íƒ ì¸ë±ìŠ¤ë¥¼ ìœ ì§€ ê°€ëŠ¥í•œ ë²”ìœ„ì—ì„œ ìœ ì§€(í´ë¨í”„ë§Œ ìˆ˜í–‰).</p>
  </li>
  <li>
    <p>ì§ë ¬í™” ë°©ì§€: í‘œì‹œìš© ìœ„ì ¯ë“¤ì€ serializeë¥¼ falseë¡œ ë‘¬ì„œ í”„ë¡¬í”„íŠ¸ì— ìƒˆëŠ” ê±¸ ë§‰ìŒ.</p>
  </li>
</ul>

<p>íŒŒì´ì¬ ìª½ì€ ê±´ë“œë¦´ í•„ìš” ì—†ì–´ ë³´ì´ì§€ë§Œ, í˜¹ì‹œ í…ìŠ¤íŠ¸ê°€ í•­ìƒ ë¦¬ìŠ¤íŠ¸ê°€ ë˜ê¸¸ ì›í•œë‹¤ë©´ notifyì—ì„œ ui ìª½ìœ¼ë¡œ í•­ìƒ listë¥¼ ì£¼ëŠ” ì§€ê¸ˆ êµ¬í˜„ì´ ì´ë¯¸ ì ì ˆí•´. IS_CHANGEDì—ì„œ ë¦¬ìŠ¤íŠ¸ë©´ íŠœí”Œë¡œ ë°”ê¿”ì£¼ëŠ” ê²ƒë„ ìºì‹œ ë¬´íš¨í™”ì— ë„ì›€ì´ ë˜ë‹ˆ ê·¸ëŒ€ë¡œ ë‘ë©´ ë¼.</p>

<p>ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ì–´ê°€ê¸°</p>

<ul>
  <li>
    <p>ì½¤ë³´ ëŒ€ì‹  ì¢Œìš° í™”ì‚´í‘œ ë²„íŠ¼(ë‘ ê°œì˜ push ë²„íŠ¼ ìœ„ì ¯)ì„ ì›í•˜ëŠ” ê²½ìš°ì—ë„ ê°™ì€ selectedIndexë¥¼ ì¨ì„œ ì‰½ê²Œ í™•ì¥ ê°€ëŠ¥í•´.</p>
  </li>
  <li>
    <p>í…ìŠ¤íŠ¸ê°€ ë§¤ìš° ê¸¸ë‹¤ë©´ í‘œì‹œìš© ìœ„ì ¯ ë†’ì´/ìë™ ì¤„ë°”ê¿ˆì„ ì¶”ê°€ë¡œ ì¡°ì ˆí•  ìˆ˜ ìˆì–´(style.whiteSpace, style.height ë“±).</p>
  </li>
</ul>

<p class="chat--user">

Array ì›ì†Œê°€ ìˆ«ìë¡œ ë˜ì–´ìˆìœ¼ë‹ˆ ì˜ ë™ì‘ì„ ì•ˆ í•˜ëŠ” ê²ƒ ê°™ì•„. ë¬¸ìì—´ë¡œ ë°”ê¿”ì¤˜

</p>

<p>ì¢‹ì•„. ì½¤ë³´ ì˜µì…˜ê³¼ valueë¥¼ ì „ë¶€ ë¬¸ìì—´ë¡œ ë°”ê¾¸ê³ , ë‚´ë¶€ ìƒíƒœëŠ” ìˆ«ìë¡œ ìœ ì§€í•˜ë„ë¡ ì •ë¦¬í–ˆì–´. í•µì‹¬ì€ ë‹¤ìŒ ë‘ ê°€ì§€ì•¼.</p>

<ol>
  <li>
    <p>UI ìª½(ì½¤ë³´)ì€ "ë¼ë²¨ ë¬¸ìì—´"ì„ ì‚¬ìš©í•œë‹¤. ì˜ˆ: "0", "1", "2"</p>
  </li>
  <li>
    <p>ë¡œì§ ìª½(í”„ë¡œí¼í‹° selectedIndex, ì¸ë±ì‹±)ì€ ìˆ«ìë¥¼ ì‚¬ìš©í•œë‹¤. ë³€í™˜ê¸°ëŠ” labelToIndex, indexToLabel ë‘ í•¨ìˆ˜ë¥¼ ì“´ë‹¤.</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œëŠ” ì´ì „ì— ì¤€ ë¦¬íŒ©í„° ë²„ì „ì—ì„œ â€œë¬¸ìì—´ ë¼ë²¨â€ë§Œì„ ìœ„í•œ ë³€ê²½ì„ ë°˜ì˜í•œ ì™„ì„±ë³¸ì´ì•¼.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // ë¼ë²¨/ì¸ë±ìŠ¤ ë³€í™˜ê¸°
    const indexToLabel = (i) =&gt; String(i);
    const labelToIndex = (v) =&gt; {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : 0;
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // countì— ë§ì¶° ì½¤ë³´ë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸(ë¼ë²¨ì€ ë¬¸ìì—´), ë¶ˆí•„ìš”í•˜ë©´ ì œê±°
    function syncComboWidget(node, count) {
      let comboWidget = node.widgets?.find(w =&gt; w.name === "displayindex");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "displayindex",
          indexToLabel(0), // ë¬¸ìì—´ ë¼ë²¨ë¡œ ì´ˆê¸°ê°’
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values: Array.from({ length: count }, (_, i) =&gt; indexToLabel(i)) }
        );
        comboWidget.serialize = false;
      }

      const needUpdate =
        !comboWidget.options?.values ||
        comboWidget.options.values.length !== count;

      if (needUpdate) {
        comboWidget.options.values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i));
      }

      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx);

      if (comboWidget.value !== desiredLabel) {
        comboWidget.value = desiredLabel; // ì½¤ë³´ì—ëŠ” ë¬¸ìì—´ ë¼ë²¨ì„ ë„£ëŠ”ë‹¤
      }
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);

      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          node.properties.selectedIndex = i;
          textWidget.value = texts[i] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>ë¬´ì—‡ì´ ë°”ë€Œì—ˆëŠ”ì§€ í•œ ì¤„ ìš”ì•½<br />
ì½¤ë³´ì˜ options.valuesì™€ valueë¥¼ ëª¨ë‘ ë¬¸ìì—´("0","1","2", â€¦)ë¡œ í†µì¼í–ˆê³ , ì„ íƒ ìƒíƒœëŠ” this.properties.selectedIndexì— ìˆ«ìë¡œ ì €ì¥ë˜ë©° labelToIndex/indexToLabelë¡œ ë³€í™˜í•´ ë™ê¸°í™”í•œë‹¤. ì´ë¡œì¨ ìˆ«ì ì›ì†Œ ë•Œë¬¸ì— ì„ íƒì´ ê¼¬ì´ëŠ” ë¬¸ì œì™€ í™”ì‚´í‘œ ì¡°ì‘ ì‹œ ë˜ëŒì•„ê°€ëŠ” ì¦ìƒ ëª¨ë‘ ë°©ì§€ëœë‹¤.</p>

<p>ë‹¤ìŒ í™•ì¥ ì•„ì´ë””ì–´<br />
ë¼ë²¨ì„ ë‹¨ìˆœ ìˆœë²ˆì´ ì•„ë‹ˆë¼ â€œ1 / Nâ€ ê°™ì€ ì‚¬ìš©ì ì¹œí™”í˜• ë¬¸ìì—´ë¡œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ indexToLabelì„ i =&gt; <code class="language-plaintext highlighter-rouge">${i+1} / ${count}</code> í˜•íƒœë¡œ ë°”ê¿”ë„ ëœë‹¤. ì´ë•ŒëŠ” labelToIndexë¥¼ í•´ë‹¹ í˜•ì‹ì— ë§ê²Œ íŒŒì‹±í•´ì£¼ë©´ ëœë‹¤.</p>

<p class="chat--user">

ì‘ ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ê°€ì. 1ë¶€í„° ì¸ë±ìŠ¤ë¡œ ê°€ê³  ë¶„ëª¨ë„ ì¨ì£¼ì. ë¼ë²¨ ì´ë¦„ë„ displayindex ëŒ€ì‹  page ë¡œ ë°”ê¾¸ì.

</p>

<p>ì¢‹ì§€. ì½¤ë³´ ë¼ë²¨ì„ â€œ1 / Nâ€ í˜•ì‹ìœ¼ë¡œ ë°”ê¾¸ê³ , ìœ„ì ¯ ì´ë¦„ë„ displayindex â†’ pageë¡œ ë³€ê²½í–ˆì–´. ë‚´ë¶€ ë¡œì§ì€ 0-based ìˆ«ì ì¸ë±ìŠ¤ë¥¼ ìœ ì§€í•˜ê³ , UIì™€ì˜ ê²½ê³„ì—ì„œë§Œ ë¬¸ìì—´ ë¼ë²¨ë¡œ ë³€í™˜í•´. ê¸°ì¡´ ë…¸ë“œì— displayindexê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ë°œê²¬ ì¦‰ì‹œ ì œê±°í•˜ë„ë¡ ì²˜ë¦¬í–ˆì–´.</p>

<p>í•µì‹¬ ë³€ê²½ì  ìš”ì•½</p>

<ul>
  <li>
    <p>ì½¤ë³´ ë¼ë²¨: â€œ1 / Nâ€ (1ë¶€í„° ì‹œì‘, ì „ì²´ ê¸¸ì´ í‘œê¸°)</p>
  </li>
  <li>
    <p>ì½¤ë³´ ìœ„ì ¯ ì´ë¦„: page</p>
  </li>
  <li>
    <p>selectedIndexëŠ” ìˆ«ì(0-based)ë¡œ ìœ ì§€, ë¼ë²¨â†”ì¸ë±ìŠ¤ ë³€í™˜ê¸°ë¡œ ë™ê¸°í™”</p>
  </li>
  <li>
    <p>ê¸¸ì´ ë³€í™”, 1ê°œì¼ ë•Œ ì½¤ë³´ ì œê±°, í™”ì‚´í‘œ ì¡°ì‘ ì‹œ ê°’ ë¦¬ì…‹ ë°©ì§€ ê·¸ëŒ€ë¡œ ê³„ìŠ¹</p>
  </li>
</ul>

<p>êµì²´ ì½”ë“œ</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // ë¼ë²¨/ì¸ë±ìŠ¤ ë³€í™˜ê¸°: "k / N" â†” 0-based index
    const indexToLabel = (i, count) =&gt; `${i + 1} / ${count}`;
    const labelToIndex = (label) =&gt; {
      // "12 / 34" ê°™ì€ ë¬¸ìì—´ì—ì„œ ì²« ë²ˆì§¸ ìˆ«ìë§Œ ì¡ì•„ì„œ 1 ë¹¼ê¸°
      const m = String(label).match(/\d+/);
      const k = m ? parseInt(m[0], 10) : 1;
      const idx = Number.isFinite(k) ? k - 1 : 0;
      return Math.max(0, idx);
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // countì— ë§ì¶° ì½¤ë³´(page)ë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸(ë¼ë²¨ì€ "1 / N"), ë¶ˆí•„ìš”í•˜ë©´ ì œê±°
    function syncComboWidget(node, count) {
      // êµ¬ë²„ì „(displayindex) ì”ì¡´ ì‹œ ì œê±° (ë§ˆì´ê·¸ë ˆì´ì…˜)
      const legacy = node.widgets?.find(w =&gt; w.name === "displayindex");
      if (legacy) removeWidget(node, legacy);

      let comboWidget = node.widgets?.find(w =&gt; w.name === "page");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      const values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i, count));

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "page",
          values[0],
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values }
        );
        comboWidget.serialize = false;
      } else {
        // ì˜µì…˜ ê¸¸ì´ ë³€ê²½ ë°˜ì˜
        const needUpdate = !comboWidget.options?.values ||
                           comboWidget.options.values.length !== count ||
                           comboWidget.options.values[0] !== values[0];
        if (needUpdate) comboWidget.options.values = values;
      }

      // í˜„ì¬ ì„ íƒ ì¸ë±ìŠ¤ ìœ ì§€(í´ë¨í”„) í›„ ë¼ë²¨ê³¼ ë™ê¸°í™”
      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx, count);

      if (comboWidget.value !== desiredLabel) comboWidget.value = desiredLabel;
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);

      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          const cl = Math.max(0, Math.min(i, texts.length - 1));
          node.properties.selectedIndex = cl;
          comboWidget.value = indexToLabel(cl, texts.length); // ë¶ˆì¼ì¹˜ ì‹œ êµì •
          textWidget.value = texts[cl] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;

      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>ì‘ë™ ë°©ì‹ ì„¤ëª…</p>

<ul>
  <li>
    <p>UI ë¼ë²¨ì€ í•­ìƒ â€œí˜„ì¬í˜ì´ì§€(1-based) / ì „ì²´ê¸¸ì´â€ ë¬¸ìì—´ë¡œ ë³´ì—¬ì£¼ê³ , ë‚´ë¶€ ìƒíƒœëŠ” 0-based ìˆ«ì ì¸ë±ìŠ¤ selectedIndexì— ì €ì¥í•œë‹¤.</p>
  </li>
  <li>
    <p>ê¸¸ì´ê°€ 1 ì´í•˜ê°€ ë˜ë©´ page ì½¤ë³´ëŠ” ì œê±°ëœë‹¤. 1â†’ì—¬ëŸ¬ ê°œ, ì—¬ëŸ¬ ê°œâ†’1, ê¸¸ì´ ì¦ê° ëª¨ë‘ ìë™ ë°˜ì˜ëœë‹¤.</p>
  </li>
  <li>
    <p>í™”ì‚´í‘œ ì¡°ì‘ ì‹œ onChangeê°€ ë¬¸ìì—´ ë¼ë²¨ì„ ì¸ë±ìŠ¤ë¡œ ë³€í™˜í•´ selectedIndexë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , í•„ìš”í•˜ë©´ ë¼ë²¨ì„ ì¬ë™ê¸°í™”í•´ ê°’ ì¼ê´€ì„±ì„ ìœ ì§€í•œë‹¤.</p>
  </li>
  <li>
    <p>êµ¬ë²„ì „ displayindex ìœ„ì ¯ì´ ì´ë¯¸ ë¶™ì–´ìˆë˜ ë…¸ë“œë„ ì•ˆì „í•˜ê²Œ ì œê±°í•´ í˜¼ì¬ ë¬¸ì œë¥¼ ë°©ì§€í•œë‹¤.</p>
  </li>
</ul>

<p>ì¶”ê°€ íŒ</p>

<ul>
  <li>ë¼ë²¨ í¬ë§·ì„ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ indexToLabelë§Œ ìˆ˜ì •í•˜ë©´ ëœë‹¤. ì˜ˆ: <code class="language-plaintext highlighter-rouge">${i+1} / ${count} (${texts[i].slice(0,10)}â€¦)</code>ì²˜ëŸ¼ ì¼ë¶€ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°ê¹Œì§€ ì²¨ë¶€ ê°€ëŠ¥.</li>
</ul>

<p class="chat--user">

ì•„ ê·¸ë¦¬ê³  page ì½¤ë³´ ìœ„ì ¯ì€ í…ìŠ¤íŠ¸ ìœ„ì— ì˜¤ë©´ ë³´ê¸°ê°€ ë” ì¢‹ì„ ê²ƒ ê°™ì•„. (1 í˜ì´ì§€ë©´ ì•„ì–˜ ì—†ëŠ” ê²ƒì€ ë™ì¼)

</p>

<p>ì¢‹ì§€. â€œpage ì½¤ë³´ë¥¼ í…ìŠ¤íŠ¸ ìœ„ì—â€ ë³´ì´ë„ë¡ ìœ„ì ¯ ìˆœì„œë¥¼ ì¬ë°°ì—´í•˜ëŠ” ìœ í‹¸ì„ ì¶”ê°€í•´ ì •ë¦¬í–ˆì–´. 1í˜ì´ì§€(ê¸¸ì´ â‰¤ 1)ì¼ ë• ì½¤ë³´ë¥¼ ë§Œë“¤ì§€ ì•ŠëŠ” ê¸°ì¡´ ë™ì‘ë„ ê·¸ëŒ€ë¡œ ìœ ì§€ë¼.</p>

<p>í•µ í¬ì¸íŠ¸</p>

<ol>
  <li>
    <p>widgets ë°°ì—´ì—ì„œ pageê°€ displaytextë³´ë‹¤ í•­ìƒ ì•ì— ì˜¤ë„ë¡ ì¬ë°°ì¹˜.</p>
  </li>
  <li>
    <p>ì½¤ë³´ ìƒì„±/ì œê±°, ê¸¸ì´ ë³€í™”, í™”ì‚´í‘œ ì¡°ì‘, 1í˜ì´ì§€ ì‹œ ì œê±° ë¡œì§ì€ ì´ì „ ë²„ì „ê³¼ ë™ì¼.</p>
  </li>
  <li>
    <p>êµ¬ë²„ì „(displayindex) ì”ì¡´ ìœ„ì ¯ì€ ê°ì§€ ì¦‰ì‹œ ì œê±°.</p>
  </li>
</ol>

<p>êµì²´ ì½”ë“œ</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // "1 / N" ë¼ë²¨ â†” 0-based index
    const indexToLabel = (i, count) =&gt; `${i + 1} / ${count}`;
    const labelToIndex = (label) =&gt; {
      const m = String(label).match(/\d+/);
      const k = m ? parseInt(m[0], 10) : 1;
      const idx = Number.isFinite(k) ? k - 1 : 0;
      return Math.max(0, idx);
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") node.size = node.computeSize();
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // page ì½¤ë³´ë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸(ë¼ë²¨ "1 / N"), ë¶ˆí•„ìš” ì‹œ ì œê±°
    function syncComboWidget(node, count) {
      // êµ¬ë²„ì „(displayindex) ì œê±°
      const legacy = node.widgets?.find(w =&gt; w.name === "displayindex");
      if (legacy) removeWidget(node, legacy);

      let comboWidget = node.widgets?.find(w =&gt; w.name === "page");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      const values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i, count));

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "page",
          values[0],
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values }
        );
        comboWidget.serialize = false;
      } else {
        const needUpdate =
          !comboWidget.options?.values ||
          comboWidget.options.values.length !== count ||
          comboWidget.options.values[0] !== values[0];
        if (needUpdate) comboWidget.options.values = values;
      }

      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx, count);

      if (comboWidget.value !== desiredLabel) comboWidget.value = desiredLabel;
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    // pageê°€ displaytext ìœ„ë¡œ ì˜¤ë„ë¡ ì¬ë°°ì¹˜
    function ensureOrderPageAboveText(node) {
      if (!node?.widgets) return;
      const pageIdx = node.widgets.findIndex(w =&gt; w.name === "page");
      const textIdx = node.widgets.findIndex(w =&gt; w.name === "displaytext");
      if (pageIdx === -1 || textIdx === -1) return;
      if (pageIdx &gt; textIdx) {
        const [w] = node.widgets.splice(pageIdx, 1);
        node.widgets.splice(textIdx, 0, w);
        if (typeof node.computeSize === "function") node.size = node.computeSize();
      }
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);
      const textWidget = ensureTextWidget(node);

      // ìˆœì„œ ì •ë¦¬: page -&gt; displaytext
      ensureOrderPageAboveText(node);

      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          const cl = Math.max(0, Math.min(i, texts.length - 1));
          node.properties.selectedIndex = cl;
          comboWidget.value = indexToLabel(cl, texts.length);
          textWidget.value = texts[cl] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);
      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;
      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);
      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;
      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>ë™ì‘ íë¦„ ìš”ì•½</p>

<ol>
  <li>
    <p>onExecuted/onConfigureì—ì„œ í…ìŠ¤íŠ¸ ë°°ì—´ì„ ì •ê·œí™”.</p>
  </li>
  <li>
    <p>ê¸¸ì´ì— ë§ì¶° page ì½¤ë³´ë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸(1í˜ì´ì§€ë©´ ì œê±°), displaytextëŠ” í•­ìƒ ìœ ì§€.</p>
  </li>
  <li>
    <p>ensureOrderPageAboveTextë¡œ pageê°€ displaytextë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì¬ë°°ì—´.</p>
  </li>
  <li>
    <p>ì„ íƒ ì¸ë±ìŠ¤ëŠ” properties.selectedIndexë¡œ ì¼ê´€ ê´€ë¦¬, UI ë¼ë²¨ì€ â€œ1 / Nâ€ ë¬¸ìì—´ë¡œ í‘œì‹œ.</p>
  </li>
  <li>
    <p>í‚¤ë³´ë“œ/ë§ˆìš°ìŠ¤ ì¡°ì‘ ì‹œ ë¼ë²¨â†’ì¸ë±ìŠ¤ ë³€í™˜ìœ¼ë¡œ ë™ê¸°í™”í•˜ë©° ë¦¬ì…‹ ë¬¸ì œ ì—†ìŒ.</p>
  </li>
</ol>

<p>ë” ë‹¤ë“¬ê³  ì‹¶ë‹¤ë©´ í…ìŠ¤íŠ¸ ìœ„ì ¯ ë†’ì´, ìë™ ì¤„ë°”ê¿ˆ, í”„ë¦¬ë·° ê¸¸ì´ ë“±ì„ ì˜µì…˜ìœ¼ë¡œ ë…¸ì¶œí•´ë„ ì¢‹ë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python Tool ì‘ì„±</title><link href="https://hvppyarchive.github.io/llm/python-systemfile-tools/" rel="alternate" type="text/html" title="Python Tool ì‘ì„±" /><published>2025-10-31T11:43:50+09:00</published><updated>2025-10-31T11:43:50+09:00</updated><id>https://hvppyarchive.github.io/llm/python-systemfile-tools</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/python-systemfile-tools/"><![CDATA[<p class="chat--user">

Python Tool ì‘ì„±ì„ í•´ë³´ì. OpenAI Agentì—ì„œ ì‚¬ìš©í•  Toolì„ ë§Œë“¤ê³  ì‹¶ì–´. ë„ˆê°€ ë§Œë“¤ì–´ì¤€ Toolì— agents.function_tool decoratorë¥¼ ë¶™ì¼ê±°ë‹ˆê¹ ë‚´ë¶€ documentationê³¼ Annotationì´ ëœ ìƒíƒœë¡œ ë˜ë©´ ì¢‹ê² ì–´. ê·¸ëŸ°ë° root í´ë”ëŠ” ìì²´ì ìœ¼ë¡œ root_dir ë¡œ ì§€ì •ì„ í•´ì„œ ê·¸ì— ë”°ë¼ ë§Œë“¤ì–´ì„œ ë‚˜ê°€ê²Œ í•˜ê³  ì‹¶ì–´. File System ê´€ë ¨ íˆ´ë“¤ - list_files - read_file - save_file ë§Œ ì¼ë‹¨ ë§Œë“¤ì–´ì¤˜. 

</p>

<p>ì¢‹ì•„. ì•„ë˜ëŠ” OpenAI Agentì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ <code class="language-plaintext highlighter-rouge">@agents.function_tool</code> ë°ì½”ë ˆì´í„°ë¥¼ ë¶™ì¸, ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ ê³ ì •í•´ì„œ ë™ì‘í•˜ëŠ” íŒŒì¼ ì‹œìŠ¤í…œ íˆ´ 3ì¢… ì„¸íŠ¸ì•¼. ê²½ë¡œ íƒˆì¶œ(<code class="language-plaintext highlighter-rouge">..</code>)ì„ ë§‰ê³ , ë°”ì´ë„ˆë¦¬/í…ìŠ¤íŠ¸ ëª¨ë‘ ì•ˆì „í•˜ê²Œ ë‹¤ë£° ìˆ˜ ìˆë„ë¡ ì„¤ê³„í–ˆì–´.</p>

<p>ê°„ë‹¨í•œ ì„¤ê³„ ìš”ì•½ (í•œ ì¤„ì”©):</p>

<ol>
  <li>
    <p>ëª¨ë“ˆ ì „ì—­ì˜ <code class="language-plaintext highlighter-rouge">ROOT_DIR</code>ë¡œ ì‘ì—… ë£¨íŠ¸ë¥¼ ê³ ì •í•˜ê³ , ëª¨ë“  ì…ì¶œë ¥ì€ ì—¬ê¸°ì— ìƒëŒ€ ê²½ë¡œë¡œë§Œ ì ‘ê·¼.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_resolve_safe()</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">Path.resolve()</code>ë¡œ ì •ê·œí™”í•œ ë’¤ <code class="language-plaintext highlighter-rouge">is_relative_to</code>ë¡œ ë£¨íŠ¸ ë‚´ ê²½ë¡œì¸ì§€ ê²€ì¦.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">list_files</code>ëŠ” ì¬ê·€/ê¸€ë¡­/ìˆ¨ê¹€íŒŒì¼ í¬í•¨ ì—¬ë¶€, ìµœëŒ€ ê°œìˆ˜ ì œí•œì„ ì œê³µ.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">read_file</code>ì€ í…ìŠ¤íŠ¸ ë˜ëŠ” ë°”ì´ë„ˆë¦¬(ë² ì´ìŠ¤64) ë°˜í™˜ì„ ì„ íƒ ê°€ëŠ¥. íŒŒì¼ í¬ê¸° ìƒí•œ(<code class="language-plaintext highlighter-rouge">max_bytes</code>)ìœ¼ë¡œ ê³¼ë„í•œ ì½ê¸° ë°©ì§€.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">save_file</code>ì€ í…ìŠ¤íŠ¸/ë² ì´ìŠ¤64 ì“°ê¸°, ìƒìœ„ í´ë” ìë™ ìƒì„±, ë®ì–´ì“°ê¸° ê°€ë“œ ì œê³µ.</p>
  </li>
  <li>
    <p>ëª¨ë“  í•¨ìˆ˜ëŠ” í’ë¶€í•œ íƒ€ì… íŒíŠ¸ì™€ ë…ìŠ¤íŠ¸ë§ì„ í¬í•¨í•˜ê³ , JSON ì§ë ¬í™” ê°€ëŠ¥í•œ ê²°ê³¼ë¥¼ ë°˜í™˜.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">asdict</span><span class="p">,</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ì´ ëª¨ë“ˆì´ ë¶ˆë¦¬ëŠ” ì‹œì ì— ê¸°ë³¸ root ì„¤ì • (í•„ìš”í•˜ë©´ set_root_dirë¡œ ì¬ì„¤ì •)
</span><span class="n">ROOT_DIR</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="sh">"</span><span class="s">agent_root</span><span class="sh">"</span>
<span class="n">ROOT_DIR</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">set_root_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ ì„¤ì •í•œë‹¤. ëª¨ë“  íˆ´ì€ ì´ ë””ë ‰í„°ë¦¬ í•˜ìœ„ì—ì„œë§Œ ë™ì‘í•œë‹¤.

    Parameters
    ----------
    path : str | Path
        ì‘ì—… ë£¨íŠ¸ë¡œ ì‚¬ìš©í•  ë””ë ‰í„°ë¦¬ ê²½ë¡œ.

    Returns
    -------
    str
        ì •ê·œí™”ëœ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ì˜ ì ˆëŒ€ ê²½ë¡œ ë¬¸ìì—´.
    </span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">ROOT_DIR</span>
    <span class="n">ROOT_DIR</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">ROOT_DIR</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relpath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ë‚´ë¶€ì˜ ì•ˆì „í•œ ì ˆëŒ€ ê²½ë¡œë¥¼ ê³„ì‚°í•œë‹¤.
    ê²½ë¡œ íƒˆì¶œ(../ ë“±)ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ resolve í›„ ROOT_DIR í•˜ìœ„ì¸ì§€ ê²€ì‚¬í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROOT_DIR</span> <span class="o">/</span> <span class="nc">Path</span><span class="p">(</span><span class="n">relpath</span><span class="p">)).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Python 3.9+: Path.is_relative_to ì§€ì›. ë¯¸ì§€ì› í™˜ê²½ ëŒ€ë¹„ ìˆ˜ë™ ì²´í¬.
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">):</span>  <span class="c1"># type: ignore[attr-defined]
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes ROOT_DIR</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="c1"># ìˆ˜ë™ êµ¬í˜„
</span>        <span class="k">if</span> <span class="n">ROOT_DIR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">ROOT_DIR</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes ROOT_DIR</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FileEntry</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_path</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">FileEntry</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="nc">FileEntry</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span> <span class="nb">type</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

<span class="c1"># ===== OpenAI Agent Tool Definitions =====
# í”„ë ˆì„ì›Œí¬ì— ë”°ë¼ import ê²½ë¡œê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ. ì˜ˆ:
# from openai import agents
# ì—¬ê¸°ì„œëŠ” ì‚¬ìš©ìê°€ ë§í•œ ë°ì½”ë ˆì´í„° ì´ë¦„ì„ ê·¸ëŒ€ë¡œ ì“´ë‹¤.
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">agents</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>  <span class="c1"># ëŸ°íƒ€ì„ í™˜ê²½ì—ì„œ ë°ì½”ë ˆì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ëŒ€ì²´ ì •ì˜
</span>    <span class="k">class</span> <span class="nc">_NoopDecorator</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">fn</span>
            <span class="k">return</span> <span class="n">wrapper</span>
    <span class="n">agents</span> <span class="o">=</span> <span class="nf">_NoopDecorator</span><span class="p">()</span>  <span class="c1"># type: ignore
</span>
<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">ë£¨íŠ¸ ë””ë ‰í„°ë¦¬(root_dir) ê¸°ì¤€ìœ¼ë¡œ íŒŒì¼/í´ë” ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">ì¬ê·€ íƒìƒ‰, ê¸€ë¡­ íŒ¨í„´, ìˆ¨ê¹€íŒŒì¼ í¬í•¨ ì—¬ë¶€, ìµœëŒ€ ê°œìˆ˜ ì œí•œì„ ì§€ì›í•œë‹¤.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    íŒŒì¼/í´ë” ëª©ë¡ ì¡°íšŒ.

    Parameters
    ----------
    relative_path : str, default=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="s">
        ROOT_DIR ê¸°ì¤€ ì‹œì‘ ê²½ë¡œ.
    glob : str | None, default=None
        ê¸€ë¡­ íŒ¨í„´ (ì˜ˆ: </span><span class="sh">"</span><span class="s">*.py</span><span class="sh">"</span><span class="s">). Noneì´ë©´ ì „ì²´.
    recursive : bool, default=True
        í•˜ìœ„ í´ë” ì¬ê·€ íƒìƒ‰ ì—¬ë¶€.
    include_hidden : bool, default=False
        ì (.)ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ìˆ¨ê¹€ í•­ëª© í¬í•¨ ì—¬ë¶€.
    max_items : int | None, default=None
        ë°˜í™˜ í•­ëª© ìµœëŒ€ ê°œìˆ˜. Noneì´ë©´ ì œí•œ ì—†ìŒ.

    Returns
    -------
    dict
        {
          </span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;ROOT_DIR&gt;</span><span class="sh">"</span><span class="s">,
          </span><span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;relative_path&gt;</span><span class="sh">"</span><span class="s">,
          </span><span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="s">: &lt;int&gt;,
          </span><span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">file|dir</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int|null&gt;}, ...]
        }

    Notes
    -----
    - ëª¨ë“  ê²½ë¡œëŠ” ROOT_DIR í•˜ìœ„ë¡œ ì œí•œëœë‹¤.
    - ê²½ë¡œ íƒˆì¶œì´ ê°ì§€ë˜ë©´ ValueErrorë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">relative_path</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
            <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># í›„ë³´ ê²½ë¡œ ì´í„°ë ˆì´ì…˜
</span>    <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
            <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

    <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FileEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="c1"># ROOT_DIR ë²”ìœ„ ì¬í™•ì¸ (ì‹¬ë³¼ë¦­ ë§í¬ ë“± ëŒ€ë¹„)
</span>        <span class="n">safe_p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">))</span>
        <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">FileEntry</span><span class="p">.</span><span class="nf">from_path</span><span class="p">(</span><span class="n">safe_p</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="nf">asdict</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">ë£¨íŠ¸ ë””ë ‰í„°ë¦¬(root_dir) ê¸°ì¤€ ê²½ë¡œì˜ íŒŒì¼ì„ ì½ëŠ”ë‹¤. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">í…ìŠ¤íŠ¸(encoding ì‚¬ìš©) ë˜ëŠ” ë°”ì´ë„ˆë¦¬(Base64) ëª¨ë“œë¡œ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    íŒŒì¼ ì½ê¸°.

    Parameters
    ----------
    relative_path : str
        ROOT_DIR ê¸°ì¤€ íŒŒì¼ ê²½ë¡œ.
    mode : {</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">}, default=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">
        </span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">ëŠ” ë¬¸ìì—´ë¡œ ë°˜í™˜(encoding ì‚¬ìš©), </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">ëŠ” Base64 ë¬¸ìì—´ë¡œ ë°˜í™˜.
    encoding : str, default=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="s">
        í…ìŠ¤íŠ¸ ëª¨ë“œì—ì„œ ì‚¬ìš©í•  ì¸ì½”ë”©.
    max_bytes : int | None, default=2*1024*1024
        ì½ê¸° ìµœëŒ€ ë°”ì´íŠ¸. Noneì´ë©´ ì œí•œ ì—†ìŒ.

    Returns
    -------
    dict
        í…ìŠ¤íŠ¸ ëª¨ë“œ:
          {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;str&gt;</span><span class="sh">"</span><span class="s">}
        ë°”ì´ë„ˆë¦¬ ëª¨ë“œ:
          {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;str&gt;</span><span class="sh">"</span><span class="s">}

    Raises
    ------
    FileNotFoundError
        ëŒ€ìƒ íŒŒì¼ì´ ì—†ì„ ë•Œ.
    IsADirectoryError
        ë””ë ‰í„°ë¦¬ë¥¼ ì½ìœ¼ë ¤ í•  ë•Œ.
    ValueError
        ê²½ë¡œ íƒˆì¶œ ë“± ë³´ì•ˆ ìœ„ë°˜.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s"> bytes) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">save_file</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">ë£¨íŠ¸ ë””ë ‰í„°ë¦¬(root_dir) ê¸°ì¤€ ê²½ë¡œì— íŒŒì¼ì„ ì €ì¥í•œë‹¤. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">í…ìŠ¤íŠ¸(encoding) ë˜ëŠ” Base64 ë°”ì´ë„ˆë¦¬ë¥¼ ì§€ì›í•˜ê³ , </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">ë®ì–´ì“°ê¸°/ìƒìœ„ ê²½ë¡œ ìë™ ìƒì„± ì˜µì…˜ì„ ì œê³µí•œë‹¤.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    íŒŒì¼ ì €ì¥.

    Parameters
    ----------
    relative_path : str
        ROOT_DIR ê¸°ì¤€ ì €ì¥ ê²½ë¡œ.
    content : str | None, default=None
        í…ìŠ¤íŠ¸ ëª¨ë“œì—ì„œ ì €ì¥í•  ë¬¸ìì—´. mode=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">ì¼ ë•Œ í•„ìš”.
    content_b64 : str | None, keyword-only, default=None
        ë°”ì´ë„ˆë¦¬ ëª¨ë“œì—ì„œ ì €ì¥í•  Base64 ë¬¸ìì—´. mode=</span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">ì¼ ë•Œ í•„ìš”.
    mode : {</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">}, default=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">
        ì €ì¥ ëª¨ë“œ.
    encoding : str, default=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="s">
        í…ìŠ¤íŠ¸ ëª¨ë“œ ì¸ì½”ë”©.
    overwrite : bool, default=False
        Trueë©´ ê¸°ì¡´ íŒŒì¼ì„ ë®ì–´ì“´ë‹¤. Falseë©´ ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ.
    create_parents : bool, default=True
        ìƒìœ„ ë””ë ‰í„°ë¦¬ë¥¼ ìë™ ìƒì„±í• ì§€ ì—¬ë¶€.

    Returns
    -------
    dict
        {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">text|binary</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="s">: &lt;bool&gt;, </span><span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="s">: &lt;bool&gt;}

    Raises
    ------
    IsADirectoryError
        ë””ë ‰í„°ë¦¬ ê²½ë¡œì— íŒŒì¼ì„ ì“°ë ¤ í•  ë•Œ.
    FileExistsError
        overwrite=Falseì´ê³  íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•  ë•Œ.
    ValueError
        ì˜ëª»ëœ ëª¨ë“œ/ì…ë ¥ ë˜ëŠ” ê²½ë¡œ íƒˆì¶œ ë“± ë³´ì•ˆ ìœ„ë°˜.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">created</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">created</span><span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># ì‚¬ìš© ì˜ˆì‹œ (Agent ì™¸ë¶€ ì´ˆê¸°í™” ì½”ë“œ)
# set_root_dir("./workspace")  # í•„ìš” ì‹œ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ì§€ì •
# list_files(relative_path=".", glob="*.py", recursive=True)
# save_file("docs/readme.txt", content="hello", overwrite=True)
# read_file("docs/readme.txt", mode="text")
</span></code></pre></div></div>

<p>ì—°ë™ íŒ:</p>

<ul>
  <li>
    <p>ì—ì´ì „íŠ¸ ì‹œì‘ ì‹œì ì— <code class="language-plaintext highlighter-rouge">set_root_dir("/desired/root")</code>ë¥¼ í•œ ë²ˆ í˜¸ì¶œí•´ ë£¨íŠ¸ ê³ ì •.</p>
  </li>
  <li>
    <p>ë³´ì•ˆìƒ ëª¨ë“  ì™¸ë¶€ ì…ë ¥ ê²½ë¡œëŠ” ìœ„ 3ê°œ íˆ´ì˜ <code class="language-plaintext highlighter-rouge">relative_path</code>ì— ê·¸ëŒ€ë¡œ ë„£ì§€ ë§ê³ , ê¼­ ì´ íˆ´ ì•ˆì—ì„œ <code class="language-plaintext highlighter-rouge">_resolve_safe</code>ê°€ ê²€ì¦í•˜ë„ë¡ ìœ ì§€.</p>
  </li>
  <li>
    <p>í° íŒŒì¼ì„ ë‹¤ë£¬ë‹¤ë©´ <code class="language-plaintext highlighter-rouge">read_file(max_bytes=None)</code>ì²˜ëŸ¼ ìƒí•œì„ ì¡°ì ˆí•˜ë˜, ì—ì´ì „íŠ¸ ì •ì±…ì— ë§ì¶° ì ì ˆí•œ ì œí•œì„ ë‘ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.</p>
  </li>
</ul>

<p>ë‹¤ìŒìœ¼ë¡œ ì›í•˜ë©´, ì‚­ì œ/ì´ë™/ë³µì‚¬ ê°™ì€ ì¶”ê°€ íˆ´ì´ë‚˜ íŒŒì¼ ì ê¸ˆ, íŠ¸ëœì­ì…˜ì„± ì €ì¥(ì„ì‹œ íŒŒì¼ë¡œ ì“°ê³  ì›ìì  êµì²´)ë„ í™•ì¥í•´ì¤„ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ìŒ ì´ëŸ° í˜•ì‹ì´ì•¼. ë„ˆê°€ ì°¾ì•„ë³¼ ì¤„ ì•Œì•˜ì§€. from agents import function_tool @function_tool def get_weather(city: str) -&gt; str: """returns weather info for the specified city.""" return f"The weather in {city} is sunny" ê·¸ëŸ°ë° ë£¨íŠ¸ë¥¼ í•¨ìˆ˜ë¡œ ì…ë ¥ ë°›ê³  ê·¸ì— ë”°ë¥¸ íˆ´ì„ ë¦¬í„´í•˜ë©´ ì˜ ë™ì‘í• ê¹Œ? ì˜ˆë¥¼ ë“¤ì–´ def get_systemfile_tools(root_dir: str): def list_files(â€¦): f"root dir: {root_dir} â€¦" â€¦ def save_file(â€¦): return [list_files, save_file, â€¦]

</p>

<p>ê°€ëŠ¥í•´. í•¨ìˆ˜ê°€ í´ë¡œì €ë¡œ <code class="language-plaintext highlighter-rouge">root_dir</code>ë¥¼ ìº¡ì²˜í•´ì„œ íˆ´ë¡œ ë‚´ë ¤ê°€ë„, ì—ì´ì „íŠ¸ê°€ â€œíŒŒì´ì¬ ì½œëŸ¬ë¸”ì„ í˜¸ì¶œâ€ë§Œ í•˜ë©´ ë¬¸ì œì—†ë‹¤. ë‹¤ë§Œ ëª‡ ê°€ì§€ í˜„ì‹¤ì  ì£¼ì˜ì ì´ ìˆë‹¤.</p>

<p>í•µì‹¬ í¬ì¸íŠ¸ ë¨¼ì € ì •ë¦¬</p>

<ol>
  <li>
    <p>ëŒ€ë¶€ë¶„ì˜ ëŸ°íƒ€ì„(ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤, ì¸ë©”ëª¨ë¦¬)ì€ í´ë¡œì € íˆ´ì„ ì˜ ì§€ì›í•œë‹¤.</p>
  </li>
  <li>
    <p>ë©€í‹°í”„ë¡œì„¸ìŠ¤/ì›ê²© ì‹¤í–‰(ì˜ˆ: í”„ë¡œì„¸ìŠ¤ ê°„ í, ì„œë²„ë¦¬ìŠ¤ ì›Œì»¤)ì—ì„œëŠ” â€œí”¼í´/ì§ë ¬í™” ê°€ëŠ¥í•œ ìµœìƒìœ„ í•¨ìˆ˜â€ë¥¼ ìš”êµ¬í•  ìˆ˜ ìˆë‹¤. ê·¸ë• í´ë¡œì € ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">functools.partial</code>ì´ë‚˜ í´ë˜ìŠ¤ ë°”ì¸ë”© íŒ¨í„´ì´ ì•ˆì „í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ë°ì½”ë ˆì´í„°ëŠ” ì •ì˜ ì‹œì ì— ì ìš©ëœë‹¤. íŒ©í† ë¦¬ ë‚´ë¶€ì—ì„œ â€œë°ì½”ë ˆì´í„°ë¥¼ í•¨ìˆ˜ì²˜ëŸ¼ í˜¸ì¶œâ€í•´ ì ìš©í•˜ë©´ ëœë‹¤.</p>
  </li>
</ol>

<p>ì•„ë˜ëŠ” ë„¤ê°€ ì œì‹œí•œ ìŠ¤íƒ€ì¼ì— ë§ì¶˜ ìµœì†Œ-ì˜ì¡´ì„± êµ¬í˜„ì´ë‹¤. <code class="language-plaintext highlighter-rouge">from agents import function_tool</code> ê°€ì •, <code class="language-plaintext highlighter-rouge">get_systemfile_tools(root_dir)</code>ê°€ ì•ˆì „ ê²½ë¡œ ê²€ì¦ê¹Œì§€ í¬í•¨í•œ 3ê°œ íˆ´(list_files, read_file, save_file)ì„ ë§Œë“¤ì–´ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜í•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">function_tool</span>  <span class="c1"># ì‚¬ìš©ì í™˜ê²½ì˜ ë°ì½”ë ˆì´í„°
</span>
<span class="c1"># ===== ë‚´ë¶€ ìœ í‹¸ =====
</span>
<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    root í•˜ìœ„ì˜ ì•ˆì „í•œ ì ˆëŒ€ ê²½ë¡œ ìƒì„±. ê²½ë¡œ íƒˆì¶œ ë°©ì§€.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="n">relpath</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="c1"># Path.is_relative_to: 3.9+ ì§€ì›. í•˜ìœ„ í˜¸í™˜ ìˆ˜ë™ ì²´í¬
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>  <span class="c1"># type: ignore[attr-defined]
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="c1"># ===== íˆ´ íŒ©í† ë¦¬ =====
</span>
<span class="k">def</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ì§€ì •í•œ root_dirë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë™ì‘í•˜ëŠ” íŒŒì¼ ì‹œìŠ¤í…œ íˆ´ 3ì¢…ì„ ìƒì„±í•´ ë°˜í™˜í•œë‹¤.
    ë°˜í™˜ ê°’ì€ ì—ì´ì „íŠ¸ì— ê·¸ëŒ€ë¡œ ë“±ë¡ ê°€ëŠ¥í•œ ë°ì½”ë ˆì´íŠ¸ëœ í•¨ìˆ˜ ë¦¬ìŠ¤íŠ¸.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">root</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># --- list_files ---------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_list_files_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        ë£¨íŠ¸(root_dir) ê¸°ì¤€ìœ¼ë¡œ íŒŒì¼/í´ë” ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤.
        ê¸€ë¡­ íŒ¨í„´, ì¬ê·€ íƒìƒ‰, ìˆ¨ê¹€ í¬í•¨ ì—¬ë¶€, ìµœëŒ€ ê°œìˆ˜ ì œí•œì„ ì§€ì›í•œë‹¤.
        </span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
                <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

        <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">safe</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">entries</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">list_files</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir ê¸°ì¤€ìœ¼ë¡œ íŒŒì¼/í´ë” ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤. ê¸€ë¡­/ì¬ê·€/ìˆ¨ê¹€/ìµœëŒ€ê°œìˆ˜ ì˜µì…˜ ì§€ì›.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_list_files_impl</span><span class="p">)</span>

    <span class="c1"># --- read_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_read_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        íŒŒì¼ ì½ê¸°. í…ìŠ¤íŠ¸(encoding) ë˜ëŠ” ë°”ì´ë„ˆë¦¬(Base64) ëª¨ë“œ ì„ íƒ.
        íŒŒì¼ í¬ê¸° ìƒí•œ(max_bytes)ìœ¼ë¡œ ê³¼ë„í•œ ì½ê¸° ë°©ì§€.
        </span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
        <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">read_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir ê¸°ì¤€ ê²½ë¡œì˜ íŒŒì¼ì„ ì½ëŠ”ë‹¤. í…ìŠ¤íŠ¸ ë˜ëŠ” Base64 ë°”ì´ë„ˆë¦¬ ë°˜í™˜.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_read_file_impl</span><span class="p">)</span>

    <span class="c1"># --- save_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_save_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        íŒŒì¼ ì €ì¥. í…ìŠ¤íŠ¸(content) ë˜ëŠ” Base64(content_b64) ì§€ì›.
        overwriteì™€ ìƒìœ„ ê²½ë¡œ ìë™ ìƒì„±(create_parents) ì˜µì…˜ ì œê³µ.
        </span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">created</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">created</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">save_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">save_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir ê¸°ì¤€ ê²½ë¡œì— íŒŒì¼ì„ ì €ì¥í•œë‹¤. í…ìŠ¤íŠ¸/ë°”ì´ë„ˆë¦¬, ë®ì–´ì“°ê¸°, ìƒìœ„ í´ë” ìƒì„± ì§€ì›.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_save_file_impl</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">list_files</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">save_file</span><span class="p">]</span>
</code></pre></div></div>

<p>ì‚¬ìš© ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tools</span> <span class="o">=</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="sh">"</span><span class="s">./workspace</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># ì—ì´ì „íŠ¸ ì´ˆê¸°í™” ì‹œ ë“±ë¡
# agent = Agent(tools=tools)  # í”„ë ˆì„ì›Œí¬ì— ë§ê²Œ ë“±ë¡
</span>
<span class="c1"># ë˜ëŠ” ì§ì ‘ í˜¸ì¶œë„ ê°€ëŠ¥(ë‚´ë¶€ì ìœ¼ë¡œ root="./workspace"ë¡œ ê³ ì •ë¨)
</span><span class="nf">print</span><span class="p">(</span><span class="n">tools</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">relative_path</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">glob</span><span class="o">=</span><span class="sh">"</span><span class="s">*.py</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>í´ë¡œì € íˆ´ì˜ í˜„ì‹¤ì  ì£¼ì˜ì‚¬í•­ê³¼ ëŒ€ì•ˆ</p>

<ul>
  <li>
    <p>ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ê°€ ë³„ë„ì—ì„œ íˆ´ì„ ë¡œë“œí•´ì•¼ í•˜ëŠ” ì•„í‚¤í…ì²˜ë¼ë©´ í´ë¡œì €ê°€ ì§ë ¬í™”ë˜ì§€ ì•Šì•„ ì‹¤íŒ¨í•  ìˆ˜ ìˆë‹¤. ì´ ê²½ìš° ë‘ ê°€ì§€ ëŒ€ì•ˆì´ ì•ˆì „í•˜ë‹¤.</p>

    <ol>
      <li>
        <p><code class="language-plaintext highlighter-rouge">functools.partial</code> íŒ¨í„´: ìµœìƒìœ„ í•¨ìˆ˜ì— <code class="language-plaintext highlighter-rouge">root</code> ì¸ìë¥¼ ë‘ê³ , <code class="language-plaintext highlighter-rouge">partial(fn, root=my_root)</code>ë¡œ ë°”ì¸ë”©í•œ ë’¤ ê·¸ partialì— ë°ì½”ë ˆì´í„°ë¥¼ ì”Œìš°ê±°ë‚˜, ë°ì½”ë ˆì´í„°ê°€ â€œí•¨ìˆ˜ì²˜ëŸ¼ í˜¸ì¶œ ê°€ëŠ¥â€í•˜ë‹¤ë©´ íŒ©í† ë¦¬ì—ì„œ <code class="language-plaintext highlighter-rouge">function_tool(...)(partial(...))</code>ë¡œ ë“±ë¡.</p>
      </li>
      <li>
        <p>í´ë˜ìŠ¤ íŒ¨í„´: <code class="language-plaintext highlighter-rouge">class FS:</code> ì•ˆì— <code class="language-plaintext highlighter-rouge">__init__(root)</code>ë¡œ ìƒíƒœë¥¼ ë“¤ê³ , ìµœìƒìœ„ ë˜í¼ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ <code class="language-plaintext highlighter-rouge">fs = FS(root)</code>ì˜ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê²Œ ë˜í•‘. ì´ ë˜í¼ë§Œ ë°ì½”ë ˆì´íŠ¸í•´ ë“±ë¡í•˜ë©´ ì§ë ¬í™” ì œì•½ì„ í”¼í•˜ê¸° ì‰½ë‹¤.</p>
      </li>
    </ol>
  </li>
</ul>

<p>ì§€ê¸ˆ ì œê³µí•œ êµ¬í˜„ì€ ê°€ì¥ ê°„ê²°í•œ í´ë¡œì €-íŒ©í† ë¦¬ ë²„ì „ì´ë‹¤. ë§Œì•½ ë„¤ ëŸ°íƒ€ì„ì´ ë©€í‹°í”„ë¡œì„¸ìŠ¤ ì§ë ¬í™”ë¥¼ ìš”êµ¬í•œë‹¤ë©´, ìœ„ ëŒ€ì•ˆ íŒ¨í„´ìœ¼ë¡œ ë°”ë¡œ ë°”ê¿”ì¤„ ìˆ˜ë„ ìˆë‹¤.</p>

<p class="chat--user">

function_toolì´ ìë™ìœ¼ë¡œ ì²«ì¤„ì„ descriptionìœ¼ë¡œ ë§Œë“œëŠ”ë° ê·¸ê±¸ f stringìœ¼ë¡œ ë§Œë“¤ê³  ì‹¶ë‹¤ëŠ”ê±°ì§€

</p>

<p>ì¢‹ì•„. í•µì‹¬ì€ â€œë°ì½”ë ˆì´í„°ê°€ ì²« ì¤„ docstringì„ ì½ëŠ” íƒ€ì´ë° ì „ì—, í•¨ìˆ˜ì˜ __doc__ì„ ë™ì ìœ¼ë¡œ ì±„ì›Œë„£ê¸°â€ì•¼. íŒŒì´ì¬ì—ì„œ í•¨ìˆ˜ ì •ì˜ ë¸”ë¡ ë§¨ ì²˜ìŒì˜ ë¬¸ìì—´ ë¦¬í„°ëŸ´ì€ ì»´íŒŒì¼ ì‹œ ê³ ì •ë˜ì§€ë§Œ, ëŸ°íƒ€ì„ì— <code class="language-plaintext highlighter-rouge">fn.__doc__</code>ì„ ë‹¤ì‹œ í• ë‹¹í•˜ëŠ” ê±´ ê°€ëŠ¥í•˜ë‹¤. ê·¸ëŸ¬ë‹ˆ íŒ©í† ë¦¬ì—ì„œ í´ë¡œì €ë¥¼ ë§Œë“¤ê³ , ê·¸ í•¨ìˆ˜ë“¤ì˜ <code class="language-plaintext highlighter-rouge">__doc__</code>ì„ f-string ê²°ê³¼ë¡œ ëŒ€ì…í•œ ë‹¤ìŒ, <code class="language-plaintext highlighter-rouge">function_tool</code>ì„ â€œë°ì½”ë ˆì´í„°ì²˜ëŸ¼ í˜¸ì¶œâ€í•´ì„œ ì ìš©í•˜ë©´ ëœë‹¤. í¬ì¸íŠ¸ëŠ” â€œdocstring ìˆ˜ì • â†’ function_tool ì ìš©â€ì˜ ìˆœì„œ.</p>

<p>ì•„ë˜ëŠ” ë™ì‘í•˜ëŠ” íŒ¨í„´ì„ ë‹¨ê³„ë³„ë¡œ í’€ì–´ì“´ ì½”ë“œë‹¤.</p>

<ol>
  <li>
    <p>í´ë¡œì €ë¡œ root_dirë¥¼ ìº¡ì²˜</p>
  </li>
  <li>
    <p>ë‚´ë¶€ í•¨ìˆ˜ì˜ ì›ë³¸ docstringì€ í¬ë§·ìš© í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ë‘”ë‹¤</p>
  </li>
  <li>
    <p>ì •ì˜ê°€ ëë‚œ ë’¤ <code class="language-plaintext highlighter-rouge">.__doc__ = f"...{root_dir}..."</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">.format(root=root_dir)</code>ë¡œ ì£¼ì…</p>
  </li>
  <li>
    <p>ë§ˆì§€ë§‰ì— <code class="language-plaintext highlighter-rouge">function_tool(...)</code>ë¡œ ë˜í•‘í•´ì„œ ë¦¬í„´</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">function_tool</span>

<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="n">relpath</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>  <span class="c1"># py3.9+
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    root_dirë¥¼ ìº¡ì²˜í•œ íŒŒì¼ ì‹œìŠ¤í…œ íˆ´ë“¤ì„ ë§Œë“¤ê³ , docstringì˜ ì²« ì¤„ì„ ë™ì ìœ¼ë¡œ ì±„ìš´ ë’¤ function_toolë¡œ ë˜í•‘í•´ ë°˜í™˜í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">root</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># --- list_files ---------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_list_files_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">List files under {root}: glob/recursive/hidden/max_items supported.</span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
                <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">safe</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

    <span class="c1"># docstring ì²« ì¤„ì„ ë™ì ìœ¼ë¡œ ì£¼ì…
</span>    <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">List files under </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: glob/recursive/hidden/max_items supported.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">list_files</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_list_files_impl</span><span class="p">)</span>  <span class="c1"># ì´ ì‹œì ì— ì²« ì¤„ì„ ì½ì–´ descriptionìœ¼ë¡œ ì‚¬ìš©
</span>
    <span class="c1"># --- read_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_read_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Read a file from {root}: return text or Base64 binary with size guard.</span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
        <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Read a file from </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: return text or Base64 binary with size guard.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">read_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_read_file_impl</span><span class="p">)</span>

    <span class="c1"># --- save_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_save_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Save a file under {root}: text/binary, overwrite and parent creation options.</span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">existed</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">existed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="ow">not</span> <span class="n">existed</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="n">existed</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Save a file under </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: text/binary, overwrite and parent creation options.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">save_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_save_file_impl</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">list_files</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">save_file</span><span class="p">]</span>
</code></pre></div></div>

<p>ì´ íŒ¨í„´ì˜ ì´ìœ ì™€ ì£¼ì˜ì  ì •ë¦¬</p>

<ol>
  <li>
    <p>ëŒ€ë¶€ë¶„ì˜ <code class="language-plaintext highlighter-rouge">function_tool</code> êµ¬í˜„ì€ â€œë˜í•‘ ì‹œì â€ì— <code class="language-plaintext highlighter-rouge">fn.__doc__</code>ì˜ ì²« ì¤„ì„ ì½ì–´ descriptionìœ¼ë¡œ ì”€. ë”°ë¼ì„œ ë°˜ë“œì‹œ docstringì„ ë°”ê¾¼ ë’¤ì— <code class="language-plaintext highlighter-rouge">function_tool(fn)</code>ì„ í˜¸ì¶œí•´ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>ë°ì½”ë ˆì´í„° êµ¬ë¬¸ <code class="language-plaintext highlighter-rouge">@function_tool</code>ë¥¼ í•¨ìˆ˜ ì •ì˜ ìœ„ì— ë°”ë¡œ ë¶™ì´ë©´, ë°ì½”ë ˆì´í„°ê°€ ë¨¼ì € ì‹¤í–‰ë˜ë¯€ë¡œ ê·¸ ë’¤ì˜ <code class="language-plaintext highlighter-rouge">__doc__</code> ì£¼ì…ì´ ë°˜ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤. ì§€ê¸ˆì²˜ëŸ¼ â€œcall-style ë°ì½”ë ˆì´ì…˜â€ìœ¼ë¡œ í•´ê²°í•œë‹¤.</p>
  </li>
  <li>
    <p>f-stringì„ í•¨ìˆ˜ ë³¸ë¬¸ ì²« ì¤„ ë¦¬í„°ëŸ´ì— ì§ì ‘ ì“¸ ìˆ˜ëŠ” ì—†ë‹¤. ëŒ€ì‹  ëŸ°íƒ€ì„ì— <code class="language-plaintext highlighter-rouge">__doc__</code>ì— f-string ê²°ê³¼ë¥¼ ëŒ€ì…í•˜ê±°ë‚˜, í…œí”Œë¦¿ ë¬¸ìì—´ì„ ë‘ê³  <code class="language-plaintext highlighter-rouge">.format(root=root_dir)</code>ë¡œ ì¹˜í™˜í•˜ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ë§Œì•½ ë„¤ <code class="language-plaintext highlighter-rouge">function_tool</code>ì´ description ì¸ìë¥¼ ì§ì ‘ ë°›ëŠ”ë‹¤ë©´ ë” ê°„ë‹¨íˆ <code class="language-plaintext highlighter-rouge">function_tool(description=f"...{root}...")(fn)</code>ë¡œ ëë‚¼ ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ â€œì²« ì¤„ docstring ìë™ ì‚¬ìš©â€ ê·œì•½ì„ ìœ ì§€í•˜ë ¤ë©´ ì§€ê¸ˆ ë°©ì‹ì´ ê°€ì¥ í˜¸í™˜ì„±ì´ ì¢‹ë‹¤.</p>
  </li>
</ol>

<p>í™•ì¥ íŒ</p>

<ul>
  <li>
    <p>ì²« ì¤„ ì™¸ì— ìƒì„¸ ë„ì›€ë§ì„ ê³„ì† ë‚¨ê¸°ê³  ì‹¶ìœ¼ë©´, ì›ë˜ docstringì„ ì½ì–´ ë‘ê³  ì²« ì¤„ë§Œ ë®ì–´ì“´ ë’¤ ë‚˜ë¨¸ì§€ë¥¼ ì´ì–´ë¶™ì´ëŠ” ì§€ê¸ˆ ë°©ì‹ì„ ì“°ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ì§ë ¬í™”ê°€ í•„ìš”í•œ í™˜ê²½ì—ì„œëŠ” ì´ í´ë¡œì €ë¥¼ ìµœìƒìœ„ í•¨ìˆ˜+<code class="language-plaintext highlighter-rouge">functools.partial</code>ë¡œ ë°”ê¿”ë„ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">__doc__</code> ì£¼ì… í›„ ë˜í•‘ì´ ê°€ëŠ¥í•˜ë‹¤.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI íƒ€ì… ìƒ‰ìƒ ì¶”ê°€</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-connection-color/" rel="alternate" type="text/html" title="ComfyUI íƒ€ì… ìƒ‰ìƒ ì¶”ê°€" /><published>2025-10-30T16:07:05+09:00</published><updated>2025-10-30T16:07:05+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-connection-color</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-connection-color/"><![CDATA[<p class="chat--user">

ComfyUI ì—ì„œ ë‚´ê°€ ë§Œë“  íƒ€ì…ì— ìƒ‰ê¹”ì„ ë„£ì„ ìˆœ ì—†ë‚˜

</p>

<p>ê°€ëŠ¥í•´ìš”. â€œë‚´ê°€ ë§Œë“  íƒ€ì…(ì˜ˆ: MYTYPE)â€ì˜ ë§í¬ ìƒ‰ì„ ì •í•´ë‘ë©´, ê·¸ íƒ€ì…ìœ¼ë¡œ ë“¤ì–´ì˜¤ê³  ë‚˜ê°€ëŠ” ì—°ê²°ì„ ì´ ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. í•µì‹¬ì€ í”„ëŸ°íŠ¸ì—”ë“œ(LiteGraph ìº”ë²„ìŠ¤) ìª½ì˜ â€œíƒ€ì…â†’ìƒ‰ìƒâ€ ë§¤í•‘ì„ ì¶”ê°€í•˜ëŠ” ê²ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ìˆœì„œëŒ€ë¡œ í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>íŒŒì´ì¬ ë…¸ë“œì—ì„œ íƒ€ì… ì´ë¦„ ì •í•˜ê¸°<br />
ì»¤ìŠ¤í…€ ë…¸ë“œì˜ RETURN_TYPES / INPUT_TYPES ë“±ì— ì‚¬ìš©í•  ë¬¸ìì—´ì´ ì‹¤ì œ íƒ€ì… ì´ë¦„ì´ ë©ë‹ˆë‹¤. ì˜ˆ: RETURN_TYPES = ("MYTYPE",). ì´ ë¬¸ìì—´ì´ í”„ëŸ°íŠ¸ì—”ë“œì—ì„œë„ ìƒ‰ìƒ í‚¤ë¡œ ì“°ì…ë‹ˆë‹¤. íƒ€ì… ë¬¸ìì—´ê³¼ ë§í¬ ìƒ‰ì€ LiteGraphê°€ íƒ€ì…ë³„ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/core-concepts/nodes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>í”„ëŸ°íŠ¸ì—”ë“œ í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ ë§Œë“¤ê¸°<br />
ComfyUIëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ë  ë•Œ ì‘ì€ JS í™•ì¥(extension)ì„ ìë™ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì— â€œíƒ€ì…â†’ìƒ‰ìƒâ€ ë§¤í•‘ì„ ì¶”ê°€í•©ë‹ˆë‹¤. í™•ì¥ì€ docsì˜ ComfyNode/JS í•˜ì´ì¬í‚¹ ê°€ì´ë“œê°€ ì•ˆë‚´í•˜ëŠ” app.registerExtension íŒ¨í„´ì„ ì“°ë©´ ê¹”ë”í•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/custom-nodes/js/javascript_objects_and_hijacking?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ol>

<p>ì˜ˆì‹œ: ComfyUI/web/extensions/mytype-colors.js íŒŒì¼ì„ ë§Œë“¤ê³  ì•„ë˜ì²˜ëŸ¼ ì‘ì„±í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ComfyUI 0.7ëŒ€ LiteGraph ê¸°ì¤€ ì˜ˆì‹œ
app.registerExtension({
  name: "mytype.color.map",
  setup() {
    const LGC = LGraphCanvas; // LiteGraph ìº”ë²„ìŠ¤
    // ì—°ê²°ì„ (í™œì„±/ë¹„í™œì„±) ìƒ‰ìƒì„ íƒ€ì… ë¬¸ìì—´ í‚¤ë¡œ ì§€ì •
    LGC.default_connection_color_byType = {
      ...(LGC.default_connection_color_byType || {}),
      "MYTYPE": "#a26bff"   // ì›í•˜ëŠ” HEX
    };
    LGC.default_connection_color_byTypeOff = {
      ...(LGC.default_connection_color_byTypeOff || {}),
      "MYTYPE": "#5b3a9a"   // ë¹„í™œì„±(êº¼ì§) ìƒíƒœì¼ ë•Œ ì–´ë‘ìš´ í†¤
    };
    // ìƒ‰ìƒ ë³€ê²½ í›„ ìº”ë²„ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    if (app?.graph?.canvas) app.graph.canvas.setDirty(true, true);
  }
});
</code></pre></div></div>

<p>LiteGraphëŠ” íƒ€ì… ë¬¸ìì—´ë³„ ê¸°ë³¸ ì—°ê²°ì„  ìƒ‰ì„ default_connection_color_byType / default_connection_color_byTypeOff ë‘ ê°ì²´ì—ì„œ ì°¾ìŠµë‹ˆë‹¤. ì´ ë‘ ë§µì— í‚¤ë¥¼ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ LiteGraphì— ì§ì ‘ ë¬¼ì–´ë³¸ ë‹µê³¼ ë™ì¼í•œ ë©”ì»¤ë‹ˆì¦˜ì„ ì”ë‹ˆë‹¤. <a href="https://stackoverflow.com/questions/78543805/how-do-i-change-the-color-of-a-slot?utm_source=chatgpt.com">Stack Overflow</a></p>

<ol>
  <li>ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨<br />
ComfyUIë¥¼ ì¬ì‹œì‘í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´, ì´ì œ MYTYPE íƒ€ì… ë§í¬ê°€ ì§€ì •í•œ ìƒ‰ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.</li>
</ol>

<p>ì¶”ê°€ íŒ</p>

<p>â€¢ ë…¸ë“œ ì¹´ë“œ(í—¤ë”) ë°°ê²½ìƒ‰ì€ íƒ€ì… ìƒ‰ê³¼ ë³„ê°œì…ë‹ˆë‹¤. í—¤ë” ë°°ê²½ì€ í…Œë§ˆ/íŒ”ë ˆíŠ¸(ì„¤ì •ì˜ Appearance)ë‚˜ CSSë¡œ ë°”ê¿€ ìˆ˜ ìˆì§€ë§Œ, â€œë°ì´í„° íƒ€ì…â€ ë§í¬ ìƒ‰ì€ ìœ„ì²˜ëŸ¼ íƒ€ì… ë§¤í•‘ì„ ì†ëŒ€ì•¼ ë°”ë€ë‹ˆë‹¤. íŒ”ë ˆíŠ¸ë§Œ ë°”ê¾¸ë©´ â€œìƒ‰ì´ ë” ì˜ ë³´ì´ê²Œâ€ ë˜ëŠ” ê²½ìš°ê°€ ìˆìœ¼ë‚˜, íƒ€ì…ë³„ ê³ ìœ ìƒ‰ì„ ìƒˆë¡œ ì •ì˜í•˜ëŠ” ê±´ ì•„ë‹™ë‹ˆë‹¤. <a href="https://docs.comfy.org/interface/appearance?utm_source=chatgpt.com">ComfyUI+1</a></p>

<p>â€¢ ComfyUIëŠ” ì»¤ìŠ¤í…€ LiteGraph ë¹Œë“œë¥¼ ì”ë‹ˆë‹¤. ë²„ì „ë§ˆë‹¤ ë‚´ë¶€ ê²½ë¡œê°€ ì•½ê°„ ë‹¤ë¥¼ ìˆ˜ ìˆì§€ë§Œ, ê³µê°œ íŒ¨í‚¤ì§€ ì„¤ëª…ì—ì„œë„ ComfyUIê°€ ìˆ˜ì •ëœ litegraphë¥¼ ì‚¬ìš©í•œë‹¤ê³  ëª…ì‹œë˜ì–´ ìˆì–´ ìœ„ íŒ¨í„´ì´ ì•ˆì •ì ì…ë‹ˆë‹¤. <a href="https://www.npmjs.com/package/%40comfyorg/litegraph/v/0.7.42?utm_source=chatgpt.com">Npm</a></p>

<p>â€¢ ì½”ë“œë¡œ í—¤ë” ìƒ‰ê¹Œì§€ ê°•ì œí•˜ê³  ì‹¶ë‹¤ë©´ node.color / node.bgcolor ê°™ì€ LiteGraph ì†ì„±ë„ ê±´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ ì›Œí¬í”Œë¡œ ì „ë°˜ì˜ ì¼ê´€ì„±ì„ ìƒê°í•˜ë©´ â€œë§í¬(íƒ€ì…) ìƒ‰ì€ íƒ€ì…-ë§µìœ¼ë¡œ, ì „ì²´ í…Œë§ˆëŠ” íŒ”ë ˆíŠ¸/ìŠ¤íƒ€ì¼ë¡œâ€ ë‚˜ëˆ„ëŠ” í¸ì´ ìœ ì§€ë³´ìˆ˜ì— ìœ ë¦¬í•©ë‹ˆë‹¤. ê´€ë ¨ JS í›…ì€ Comfyì˜ JS ì˜¤ë¸Œì íŠ¸/í•˜ì´ì¬í‚¹ ë¬¸ì„œê°€ ì¶œë°œì ìœ¼ë¡œ ì¢‹ìŠµë‹ˆë‹¤. <a href="https://docs.comfy.org/custom-nodes/js/javascript_objects_and_hijacking?utm_source=chatgpt.com">ComfyUI</a></p>

<p>ì •ë¦¬í•˜ë©´, íŒŒì´ì¬ ìª½ì—ì„œ íƒ€ì… ë¬¸ìì—´ì„ í•˜ë‚˜ ì •í•´ ì“°ê³ , í”„ëŸ°íŠ¸ì—”ë“œ í™•ì¥ìœ¼ë¡œ LGraphCanvas.default_connection_color_byType(ë° Off)ì— ê·¸ ë¬¸ìì—´ í‚¤ë¥¼ ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”. ê·¸ëŸ¬ë©´ ê·¸ íƒ€ì…ì˜ ì…ì¶œë ¥ ë§í¬ê°€ ì§€ì •í•œ ìƒ‰ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œëŠ” ì—¬ëŸ¬ ì»¤ìŠ¤í…€ íƒ€ì…ì„ ì“°ëŠ” ì›Œí¬í”Œë¡œì—ì„œ ìƒ‰ íŒ”ë ˆíŠ¸ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ ë‘ë©´, ë³µì¡í•œ ê·¸ë˜í”„ë„ í•œëˆˆì— ì½íˆëŠ” â€œì‹œê°ì  ë¬¸ë²•â€ì´ ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

ìœ„ì— ì„í¬íŠ¸ ê°™ì€ê±´ ë”°ë¡œ ì•ˆí•´ë„ ë˜ë‚˜

</p>

<p>ì•„ë‹ˆìš”. ë”°ë¡œ ì„í¬íŠ¸í•  ê±° ì—†ìŠµë‹ˆë‹¤.</p>

<p>ì™œëƒë©´ ComfyUIê°€ ë¸Œë¼ìš°ì €ì—ì„œ ì´ë¯¸ í•„ìš”í•œ ê²ƒë“¤ì„ ì „ì—­ìœ¼ë¡œ ì˜¬ë ¤ë‘¡ë‹ˆë‹¤. í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ë¥¼ <code class="language-plaintext highlighter-rouge">web/extensions/*.js</code>ì— ë‘ê³  <code class="language-plaintext highlighter-rouge">app.registerExtension({...})</code>ë¥¼ ì“°ë©´, ë‚´ë¶€ì—ì„œ <code class="language-plaintext highlighter-rouge">app</code>(ComfyUI ì•± ê°ì²´)ì™€ <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>(LiteGraph ìº”ë²„ìŠ¤)ê°€ ìë™ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ ì¶”ê°€ ì„í¬íŠ¸ ì—†ì´ ë°”ë¡œ ë§µì„ ê±´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì •ë¦¬í•´ë‘ë©´ ì´ë ‡ê²Œ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>JS ìª½<br />
íŒŒì¼ ìœ„ì¹˜: <code class="language-plaintext highlighter-rouge">ComfyUI/web/extensions/mytype-colors.js</code><br />
ì½”ë“œ ì•ˆì—ì„œ ë”°ë¡œ <code class="language-plaintext highlighter-rouge">import</code> ì•ˆ í•´ë„ ë¨. <code class="language-plaintext highlighter-rouge">app</code>ê³¼ <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>ëŠ” ì „ì—­. <code class="language-plaintext highlighter-rouge">registerExtension</code>ì´ ë¡œë”© íƒ€ì´ë°ë„ ì±…ì„ì ¸ì¤˜ì„œ â€œë¨¼ì € ë¡œë“œëë‚˜?â€ ê±±ì •ë„ ì¤„ì–´ë“­ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>íŒŒì´ì¬ ë…¸ë“œ ìª½<br />
ìƒ‰ìƒ ë§¤í•‘ì„ ìœ„í•´ ë³„ë„ì˜ ì„í¬íŠ¸ í•„ìš” ì—†ìŒ. ì»¤ìŠ¤í…€ ë…¸ë“œ í´ë˜ìŠ¤ì—ì„œ <code class="language-plaintext highlighter-rouge">RETURN_TYPES = ("MYTYPE",)</code> ê°™ì€ íƒ€ì… ë¬¸ìì—´ì„ í‰ì†Œì²˜ëŸ¼ ì •ì˜í•˜ë©´ ë. ìƒ‰ìƒì€ JS í™•ì¥ì—ì„œ íƒ€ì… ë¬¸ìì—´ í‚¤ë¡œ ë§¤í•‘í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¬ì‹œì‘/ìƒˆë¡œê³ ì¹¨<br />
íŒŒì¼ì„ ë„£ì€ ë’¤ ComfyUI ì¬ì‹œì‘ ë˜ëŠ” ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ë§Œ í•˜ë©´ ë°˜ì˜ë©ë‹ˆë‹¤. ìºì‹œê°€ ë¼ë©´ ê°•ë ¥ ìƒˆê³ ì¹¨ ì •ë„ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.</p>
  </li>
</ol>

<p>ì˜ˆì‹œ ìŠ¤ë‹ˆí«(ì„í¬íŠ¸ ì—†ìŒ):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

app.registerExtension({
  name: "mytype.color.map",
  setup() {
    const LGC = LGraphCanvas;
    LGC.default_connection_color_byType = {
      ...(LGC.default_connection_color_byType || {}),
      "MYTYPE": "#a26bff"
    };
    LGC.default_connection_color_byTypeOff = {
      ...(LGC.default_connection_color_byTypeOff || {}),
      "MYTYPE": "#5b3a9a"
    };
    if (app?.graph?.canvas) app.graph.canvas.setDirty(true, true);
  }
});
</code></pre></div></div>

<p>ì£¼ì˜í•  ì  ëª‡ ê°€ì§€ë§Œ ë§ë¶™ì´ë©´ ë” íƒ„íƒ„í•´ì§‘ë‹ˆë‹¤.<br />
â€¢ íŒŒì¼ ìœ„ì¹˜ê°€ ë§ì•„ì•¼ ìë™ ë¡œë“œë©ë‹ˆë‹¤. ë‹¤ë¥¸ ê²½ë¡œë¥¼ ì“°ë©´ ì§ì ‘ ë¡œë”ì— ë“±ë¡í•´ì•¼ í•´ìš”.<br />
â€¢ TypeScriptë¡œ ì‘ì„±í•œë‹¤ë©´ â€œì „ì—­ <code class="language-plaintext highlighter-rouge">app</code>, <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>â€ì— ëŒ€í•œ íƒ€ì… ì„ ì–¸ë§Œ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤. JSë¼ë©´ ê·¸ëƒ¥ ë„˜ì–´ê°€ë„ ë©ë‹ˆë‹¤.<br />
â€¢ ë§Œì•½ ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì¦‰ì„ ì‹¤í–‰í•œë‹¤ë©´ <code class="language-plaintext highlighter-rouge">window.app</code>, <code class="language-plaintext highlighter-rouge">window.LGraphCanvas</code>ë¡œ ì ‘ê·¼í•˜ì„¸ìš”.</p>

<p>í•œ ì¤„ ê²°ë¡ : ê¸°ë³¸ ì„¤ì¹˜ ê·¸ëŒ€ë¡œë¼ë©´ ì„í¬íŠ¸ëŠ” ì „í˜€ í•„ìš” ì—†ìŠµë‹ˆë‹¤. íƒ€ì… ë¬¸ìì—´ë§Œ ë§ì¶”ê³ , í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì „ì—­ ê°ì²´ë¥¼ ì‚´ì§ ì†ëŒ€ë©´ ë§í¬ ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ ê¹”ë”í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">npx ì„¤ì • ë³€ê²½ ë°©ë²•</title><link href="https://hvppyarchive.github.io/llm/npx-command-line-config/" rel="alternate" type="text/html" title="npx ì„¤ì • ë³€ê²½ ë°©ë²•" /><published>2025-10-30T13:40:18+09:00</published><updated>2025-10-30T13:40:18+09:00</updated><id>https://hvppyarchive.github.io/llm/npx-command-line-config</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/npx-command-line-config/"><![CDATA[<p class="chat--user">

npx (npm exec)ì„ ëŒë¦¬ë˜ ì»¤ë§¨ë“œë¼ì¸ì—ì„œ prefix, .npm ê²½ë¡œ, registry, strict-sslë¥¼ ì»¤ë§¨ë“œë¡œ ë°”ê¿€ ìˆ˜ ìˆì–´?

</p>

<p>ê°€ëŠ¥í•´. <code class="language-plaintext highlighter-rouge">npx</code>(npm v7+ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">npm exec</code>ì™€ ë™ì¼)ëŠ” ê±°ì˜ ëª¨ë“  npm ì„¤ì • ê°’ì„ â€œê·¸ ì‹¤í–‰ í•œ ë²ˆâ€ì— í•œí•´ CLI ì˜µì…˜ì´ë‚˜ í™˜ê²½ë³€ìˆ˜ë¡œ ì˜¤ë²„ë¼ì´ë“œí•  ìˆ˜ ìˆì–´. í•µì‹¬ì€ ë‹¤ìŒ ì…‹ ì¤‘ í•˜ë‚˜ë¥¼ ì“°ëŠ” ê²ƒ: 1) CLI í”Œë˜ê·¸, 2) <code class="language-plaintext highlighter-rouge">npm_config_*</code> í™˜ê²½ë³€ìˆ˜, 3) ë‹¤ë¥¸ <code class="language-plaintext highlighter-rouge">.npmrc</code>ë¥¼ ì§€ì •í•˜ëŠ” <code class="language-plaintext highlighter-rouge">--userconfig</code>.</p>

<p>ì•„ë˜ë¥¼ ì°¨ê·¼ì°¨ê·¼ ë³´ì.</p>

<ol>
  <li>CLI í”Œë˜ê·¸ë¡œ ë°”ë¡œ ì§€ì •</li>
</ol>

<ul>
  <li>
    <p>registry: <code class="language-plaintext highlighter-rouge">--registry=https://registry.npmmirror.com</code></p>
  </li>
  <li>
    <p>strict-ssl: <code class="language-plaintext highlighter-rouge">--strict-ssl=false</code></p>
  </li>
  <li>
    <p>prefix(ê¸€ë¡œë²Œ prefix): <code class="language-plaintext highlighter-rouge">--prefix=/opt/npm-global</code></p>
  </li>
  <li>
    <p>.npm ìºì‹œ ê²½ë¡œ: <code class="language-plaintext highlighter-rouge">--cache=/var/tmp/npm-cache</code> (ì¼ë°˜ì ìœ¼ë¡œ â€œ~/.npmâ€ì´ ì´ ê°’)</p>
  </li>
</ul>

<p>ì˜ˆì‹œë“¤:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># npm v7+ ìŠ¤íƒ€ì¼ (ê¶Œì¥): npm exec</span>
npm <span class="nb">exec</span> <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--</span> <span class="se">\</span>
  some-binary <span class="nt">--help</span>

<span class="c"># ì „í†µì ì¸ npx ìŠ¤íƒ€ì¼ (npm v6~): npx</span>
npx <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false </span>some-binary <span class="nt">--help</span>

<span class="c"># prefixì™€ cacheë„ í•œ ë²ˆì—</span>
npm <span class="nb">exec</span> <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="nt">--</span> <span class="se">\</span>
  eslint <span class="nt">-v</span>
</code></pre></div></div>

<ol>
  <li>í™˜ê²½ë³€ìˆ˜ë¡œ ì§€ì • (<code class="language-plaintext highlighter-rouge">npm_config_*</code>)<br />
ë™ì¼í•œ í‚¤ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ë„˜ê²¨ë„ ëœë‹¤. í•œ ë²ˆ ì“°ê³  ëë‚¼ ë•Œ ê¹”ë”í•˜ë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># POSIX ì‰˜</span>
<span class="nv">npm_config_registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
<span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nv">npm_config_prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
<span class="nv">npm_config_cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
npx eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>Windows PowerShellì´ë¼ë©´:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_registry</span><span class="o">=</span><span class="s2">"https://registry.npmmirror.com"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="s2">"false"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_prefix</span><span class="o">=</span><span class="s2">"C:\npm-global"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_cache</span><span class="o">=</span><span class="s2">"D:\npm-cache"</span><span class="w">
</span><span class="n">npx</span><span class="w"> </span><span class="nx">eslint</span><span class="w"> </span><span class="nt">-v</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ë³„ë„ .npmrcë¥¼ ì§€ì •<br />
í”„ë¡œì íŠ¸/ìœ ì € ê¸°ë³¸ ì„¤ì • ê±´ë“œë¦¬ì§€ ì•Šê³  íŠ¹ì • ì‹¤í–‰ì—ë§Œ ì“°ê³  ì‹¶ì„ ë•Œ ìœ ìš©í•˜ë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /tmp/my.npmrc ì•ˆì— ì›í•˜ëŠ” ì„¤ì •ì„ ì¨ë‘” ë’¤</span>
npm <span class="nb">exec</span> <span class="nt">--userconfig</span><span class="o">=</span>/tmp/my.npmrc <span class="nt">--</span> webpack <span class="nt">--version</span>
</code></pre></div></div>

<p>ì‹¤ë¬´ íŒê³¼ ì£¼ì˜ì </p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">npm exec</code>ì—ì„œ â€œì„¤ì • í”Œë˜ê·¸ë“¤ì€ ì‹¤í–‰í•  ë°”ì´ë„ˆë¦¬ ì´ë¦„ ì•â€ì— ë‘ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤. ê·¸ ë’¤ì˜ ì¸ìëŠ” ì‹¤í–‰ ëŒ€ìƒ íŒ¨í‚¤ì§€ê°€ ë°›ëŠ”ë‹¤. ì• ë§¤í•˜ë©´ <code class="language-plaintext highlighter-rouge">--</code>ë¡œ êµ¬ë¶„í•´ì£¼ê¸°.<br />
ì˜ˆ: <code class="language-plaintext highlighter-rouge">npm exec --registry=... -- strict-ssl-checker --verbose</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefix</code>ëŠ” â€œê¸€ë¡œë²Œ ì„¤ì¹˜ ìœ„ì¹˜â€ë¥¼ ì˜ë¯¸í•œë‹¤. <code class="language-plaintext highlighter-rouge">npm exec --package=foo</code> ê°™ì´ ì¼ì‹œ ì„¤ì¹˜ ì‹¤í–‰í•  ë•ŒëŠ” ì„ì‹œ ë””ë ‰í„°ë¦¬ë¥¼ ì“°ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">prefix</code>ë³´ë‹¤ <code class="language-plaintext highlighter-rouge">cache</code>ì™€ <code class="language-plaintext highlighter-rouge">tmp</code> ê´€ë ¨ ì„¤ì •ì´ ë™ì‘ì— ë” í° ì˜í–¥ì„ ì¤€ë‹¤.</p>
  </li>
  <li>
    <p>npm v6ì˜ <code class="language-plaintext highlighter-rouge">npx</code>ëŠ” ì˜µì…˜ íŒŒì‹±ì´ ë‹¤ì†Œ ê¹Œë‹¤ë¡œì› ë‹¤. íŒ¨í‚¤ì§€ ì¸ìì™€ npx ì˜µì…˜ì´ ì„ì´ë©´ <code class="language-plaintext highlighter-rouge">--</code>ë¡œ ê²½ê³„ í‘œì‹œ.</p>
  </li>
  <li>
    <p>CA ê²€ì¦ì„ ë„ëŠ” <code class="language-plaintext highlighter-rouge">--strict-ssl=false</code>ëŠ” í¸í•˜ì§€ë§Œ ë³´ì•ˆìƒ ìœ„í—˜í•˜ë‹ˆ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ ë“± ë¶ˆê°€í”¼í•  ë•Œë§Œ ì“°ì.</p>
  </li>
  <li>
    <p>ìì£¼ ì“°ëŠ” ê°’ì€ ì‚¬ìš©ì í™ˆì˜ <code class="language-plaintext highlighter-rouge">~/.npmrc</code>ë‚˜ í”„ë¡œì íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">.npmrc</code>ì— ì ì–´ ë‘ê³ , ì¼ì‹œì ìœ¼ë¡œ ë°”ê¿€ ë•Œë§Œ ìœ„ ë°©ì‹ì„ ì“°ë©´ ê¹”ë”í•˜ë‹¤.</p>
  </li>
</ul>

<p>ì—¬ê¸°ê¹Œì§€ë©´ ë³´í†µì€ ì¶©ë¶„í•˜ë‹¤. í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">proxy</code>, <code class="language-plaintext highlighter-rouge">https-proxy</code>, <code class="language-plaintext highlighter-rouge">cafile</code>, <code class="language-plaintext highlighter-rouge">always-auth</code> ê°™ì€ ë‹¤ë¥¸ npm ì„¤ì •ë“¤ë„ ë˜‘ê°™ì€ ë°©ì‹ìœ¼ë¡œ í•œ ë²ˆ ì‹¤í–‰ìš©ìœ¼ë¡œ ë§ì…í ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ëª¨ë‘ í•œ ë²ˆì— ì„¤ì •í•˜ëŠ” ë²•

</p>

<p>ê°€ëŠ¥. í•œ ì¤„ì—ì„œ ì „ë¶€ ë®ì–´ì”Œìš°ëŠ” ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²• 3ê°€ì§€ë¥¼ ë°”ë¡œ ì“¸ ìˆ˜ ìˆì–´. ê°ê° â€œì‹¤í–‰ í•œ ë²ˆâ€ì—ë§Œ ì ìš©ë¼ì„œ ê¸°ë³¸ ì„¤ì •ì€ ì•ˆ ë°”ë€ë‹¤.</p>

<ol>
  <li>CLI í”Œë˜ê·¸ í•œ ë²ˆì—(ê¶Œì¥: npm v7+ì—ì„œ npm exec)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">exec</span> <span class="se">\</span>
  <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
  <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
  <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
  <span class="nt">--package</span><span class="o">=</span>eslint <span class="nt">--</span> <span class="se">\</span>
  eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>í¬ì¸íŠ¸: ì„¤ì • í”Œë˜ê·¸ëŠ” ì‹¤í–‰í•  íŒ¨í‚¤ì§€ ì´ë¦„(ì—¬ê¸°ì„  eslint) ì•ì— ë‘ê³ , ê·¸ ë’¤ë¥¼ <code class="language-plaintext highlighter-rouge">--</code>ë¡œ êµ¬ë¶„í•´ ì‹¤í–‰ ëŒ€ìƒì˜ ì¸ìë¥¼ ì „ë‹¬í•œë‹¤.</p>

<ol>
  <li>í™˜ê²½ë³€ìˆ˜ í•œ ë²ˆì— (<code class="language-plaintext highlighter-rouge">npm_config_*</code>)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># POSIX ì‰˜</span>
<span class="nv">npm_config_registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
<span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nv">npm_config_prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
<span class="nv">npm_config_cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
npm <span class="nb">exec</span> <span class="nt">--package</span><span class="o">=</span>eslint <span class="nt">--</span> eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>PowerShellì´ë¼ë©´:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_registry</span><span class="o">=</span><span class="s2">"https://registry.npmmirror.com"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="s2">"false"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_prefix</span><span class="o">=</span><span class="s2">"C:\npm-global"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_cache</span><span class="o">=</span><span class="s2">"D:\npm-cache"</span><span class="w">
</span><span class="n">npm</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nt">--package</span><span class="o">=</span><span class="n">eslint</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nx">eslint</span><span class="w"> </span><span class="nt">-v</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ì„ì‹œ .npmrc íŒŒì¼ë¡œ í•œ ë²ˆì—</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&gt;</span> /tmp/once.npmrc <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">'
registry=https://registry.npmmirror.com
strict-ssl=false
prefix=/opt/npm-global
cache=/var/tmp/npm-cache
</span><span class="no">EOF

</span>npm <span class="nb">exec</span> <span class="nt">--userconfig</span><span class="o">=</span>/tmp/once.npmrc <span class="nt">--package</span><span class="o">=</span>eslint <span class="nt">--</span> eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>npxë¥¼ ê·¸ëŒ€ë¡œ ì“°ëŠ” ê²½ìš°(npm v6 ê³„ì—´)ë„ ë™ì¼í•˜ê²Œ ëœë‹¤:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
    <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
    eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>ì •ë¦¬í•´ë‘” ì‘ë™ ì›ì¹™</p>

<ul>
  <li>
    <p>ìš°ì„ ìˆœìœ„: CLI í”Œë˜ê·¸ &gt; í™˜ê²½ë³€ìˆ˜(npm_config_*) &gt; --userconfigë¡œ ì§€ì •í•œ .npmrc &gt; í”„ë¡œì íŠ¸/ìœ ì € .npmrc</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefix</code>ëŠ” ê¸€ë¡œë²Œ ì„¤ì¹˜ ê²½ë¡œë¥¼ ì˜ë¯¸í•œë‹¤. <code class="language-plaintext highlighter-rouge">npm exec --package=...</code>ì²˜ëŸ¼ ì¼ì‹œ ì„¤ì¹˜ ì‹¤í–‰ì—ì„œëŠ” ì„ì‹œ ë””ë ‰í„°ë¦¬ë¥¼ ì“°ë¯€ë¡œ ì‹¤ì œ ì²´ê° ì˜í–¥ì€ <code class="language-plaintext highlighter-rouge">cache</code>, <code class="language-plaintext highlighter-rouge">tmp</code>ê°€ ë” í¬ë‹¤.</p>
  </li>
  <li>
    <p>íŒ¨í‚¤ì§€ ì´ë¦„ê³¼ ì˜µì…˜ì´ ì„ì¼ ìœ„í—˜ì´ ìˆìœ¼ë©´ <code class="language-plaintext highlighter-rouge">--</code>ë¡œ ê²½ê³„ë¥¼ ë‚˜ëˆ ë¼.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--strict-ssl=false</code>ëŠ” í¸í•˜ì§€ë§Œ ë³´ì•ˆìƒ ìœ„í—˜í•˜ë‹ˆ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ ë“± ê¼­ í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©í•˜ë¼.</p>
  </li>
</ul>

<p>ì—¬ê¸° ì˜ˆì‹œì˜ registry, ê²½ë¡œë“¤ì€ ë„¤ í™˜ê²½ì— ë§ê²Œ ë°”ê¿” ê½‚ìœ¼ë©´ ëœë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œëŠ” proxy, cafile, always-auth ê°™ì€ ê°’ë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ í•¨ê»˜ ë¬¶ì–´ ë„˜ê²¨ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ë­”ê°€ ê¸¸ë‹¤? ë‚´ê°€ ì›ë˜ ì¹˜ë ¤ë˜ ê±´ npx -y @modelcontextprotocol/server-everythingì´ì•¼

</p>

<p>ì¢‹ì•„, ê·¸ í•œ ì¤„ì§œë¦¬ë¡œ ëë‚´ì. ë„¤ê°€ ì¹˜ë ¤ë˜ ëª…ë ¹ì— ì˜µì…˜ 4ì¢…ì„ â€œí•œ ë²ˆ ì‹¤í–‰ìš©â€ìœ¼ë¡œ ë®ì–´ì”Œìš°ëŠ” ìµœì†Œ ì˜ˆì‹œëŠ” ì•„ë˜ ë‘˜ ì¤‘ í•˜ë‚˜ë¡œ ëœë‹¤.</p>

<p>CLI í”Œë˜ê·¸ë¡œ í•œ ë°©ì—:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
    <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
    <span class="nt">-y</span> @modelcontextprotocol/server-everything
</code></pre></div></div>

<p>í™˜ê²½ë³€ìˆ˜ë¡œ ê¹”ë”í•˜ê²Œ(ì¶”ì²œ, ì‰˜ ì´ì‹ì„± ì¢‹ìŒ):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">npm_config_registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
<span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nv">npm_config_prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
<span class="nv">npm_config_cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
npx <span class="nt">-y</span> @modelcontextprotocol/server-everything
</code></pre></div></div>

<p>ì°¸ê³  ë©”ëª¨</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--</code> êµ¬ë¶„ìëŠ” íŒ¨í‚¤ì§€ì— ì¶”ê°€ ì¸ìë¥¼ ë„˜ê¸¸ ë•Œë§Œ ë¶™ì´ë©´ ëœë‹¤. ì—¬ê¸°ì„  ë¶ˆí•„ìš”.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefix</code>ëŠ” ì „ì—­ ì„¤ì¹˜ ê²½ë¡œì§€ë§Œ, npxëŠ” ì¼ì‹œ ì„¤ì¹˜Â·ì‹¤í–‰ì´ë¼ ì‹¤ì œë¡œëŠ” <code class="language-plaintext highlighter-rouge">cache</code>ì™€ ë„¤íŠ¸ì›Œí¬ ì„¤ì •(registry, strict-ssl)ì´ ë” ì˜í–¥ì´ í¬ë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">strict-ssl=false</code>ëŠ” ìœ„í—˜í•˜ë‹ˆ ë‚´ë¶€ë§ í…ŒìŠ¤íŠ¸ì²˜ëŸ¼ ê¼­ í•„ìš”í•  ë•Œë§Œ ì“°ì.</p>
  </li>
</ul>

<p>ê°™ì€ ë°©ì‹ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">proxy</code>, <code class="language-plaintext highlighter-rouge">https-proxy</code>, <code class="language-plaintext highlighter-rouge">cafile</code>, <code class="language-plaintext highlighter-rouge">always-auth</code>ë„ í•œ ì¤„ì— ì–¹ì„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ìœ ì € íŒŒì¼ë¡œ ì €ì¥í•´ë‘ê³  ëŒë¦¬ê¸°

</p>

<p>ì¢‹ì•„. â€œë§¤ë²ˆ ì˜µì…˜ ì¹˜ê¸° ê·€ì°®ë‹¤ â†’ ì‚¬ìš©ì ì„¤ì • íŒŒì¼(~/.npmrc)ì— ì €ì¥í•´ë‘ê³  ê·¸ëƒ¥ ì‹¤í–‰â€ìœ¼ë¡œ ê°€ì. ì•„ë˜ ìˆœì„œëŒ€ë¡œ í•˜ë©´ ëœë‹¤.</p>

<ol>
  <li>ê¸°ì¡´ ì„¤ì • ë°±ì—…</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="o">[</span> <span class="nt">-f</span> ~/.npmrc <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">cp</span> <span class="nt">-a</span> ~/.npmrc ~/.npmrc.bak.<span class="si">$(</span><span class="nb">date</span> +%Y%m%d-%H%M%S<span class="si">)</span>

<span class="c"># Windows PowerShell</span>
<span class="k">if</span> <span class="o">(</span>Test-Path <span class="nv">$HOME</span><span class="se">\.</span>npmrc<span class="o">)</span> <span class="o">{</span> Copy-Item <span class="nv">$HOME</span><span class="se">\.</span>npmrc <span class="s2">"</span><span class="nv">$HOME</span><span class="se">\.</span><span class="s2">npmrc.bak.</span><span class="k">$((</span>Get-Date<span class="o">)</span>.ToString<span class="o">(</span><span class="s1">'yyyyMMdd-HHmmss'</span><span class="k">))</span><span class="s2">"</span> <span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>ì‚¬ìš©ì .npmrc ì‘ì„±<br />
ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ë°”ê¿” ë„£ì. strict-ssl=falseëŠ” ë³´ì•ˆìƒ ìœ„í—˜í•˜ë‹ˆ ì •ë§ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì“´ë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="nb">cat</span> <span class="o">&gt;</span> ~/.npmrc <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">'
registry=https://registry.npmmirror.com
strict-ssl=false
prefix=/opt/npm-global
cache=/var/tmp/npm-cache
</span><span class="no">EOF
</span></code></pre></div></div>

<p>PowerShellì´ë¼ë©´:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">@"
registry=https://registry.npmmirror.com
strict-ssl=false
prefix=C:\npm-global
cache=D:\npm-cache
"@</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Set-Content</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">UTF8</span><span class="w"> </span><span class="bp">$HOME</span><span class="nx">\.npmrc</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>prefix ê²½ë¡œ ë§Œë“¤ê¸° ë° PATHì— ì¶”ê°€<br />
prefixë¥¼ ë°”ê¿¨ë‹¤ë©´ ê·¸ ìœ„ì¹˜ì˜ binì´ PATHì— ìˆì–´ì•¼ ì‹¤í–‰ íŒŒì¼ì´ ë³´ì¸ë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt/npm-global
<span class="c"># ì…¸ì— PATH ì¶”ê°€(ì˜ˆ: bash/zsh)</span>
<span class="nb">echo</span> <span class="s1">'export PATH="/opt/npm-global/bin:$PATH"'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
<span class="nb">echo</span> <span class="s1">'export PATH="/opt/npm-global/bin:$PATH"'</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="c"># ì ìš©</span>
<span class="nb">source</span> ~/.bashrc 2&gt;/dev/null <span class="o">||</span> <span class="nb">source</span> ~/.zshrc 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
</code></pre></div></div>

<p>PowerShell:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">New-Item</span><span class="w"> </span><span class="nt">-ItemType</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nx">C:\npm-global</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\npm-global;</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">Path</span><span class="s2">"</span><span class="w">
</span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s2">"Path"</span><span class="p">,</span><span class="w"> </span><span class="s2">"C:\npm-global;"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">GetEnvironmentVariable</span><span class="p">(</span><span class="s2">"Path"</span><span class="p">,</span><span class="s2">"User"</span><span class="p">),</span><span class="w"> </span><span class="s2">"User"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ìºì‹œ ë””ë ‰í„°ë¦¬ ì¤€ë¹„(ì„ íƒ)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /var/tmp/npm-cache

<span class="c"># PowerShell</span>
New-Item <span class="nt">-ItemType</span> Directory <span class="nt">-Force</span> D:<span class="se">\n</span>pm-cache | Out-Null
</code></pre></div></div>

<ol>
  <li>ì˜ ì €ì¥ëëŠ”ì§€ í™•ì¸</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm config list <span class="nt">-l</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'registry|strict-ssl|prefix|cache'</span>
<span class="c"># PowerShell</span>
npm config list <span class="nt">-l</span> | findstr /r <span class="s2">"registry strict-ssl prefix cache"</span>
</code></pre></div></div>

<ol>
  <li>ì´ì œ ê·¸ëƒ¥ ì‹¤í–‰<br />
ì´ì œë¶€í„°ëŠ” ì˜µì…˜ ì—†ì´ ë„¤ê°€ ì“°ë ¤ë˜ ëª…ë ¹ì„ ê·¸ëŒ€ë¡œ ì“°ë©´ ëœë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">-y</span> @modelcontextprotocol/server-everything
</code></pre></div></div>

<p>ì‹¤ë¬´ ë©”ëª¨</p>

<ul>
  <li>
    <p>ì‚¬ìš©ì ìˆ˜ì¤€(~/.npmrc)ì€ í˜„ì¬ ì‚¬ìš©ìì—ê²Œë§Œ ì ìš©ëœë‹¤. í”„ë¡œì íŠ¸ ì „ìš© ì„¤ì •ì„ ì›í•˜ë©´ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— .npmrcë¥¼ ë‘ë©´ í•´ë‹¹ ë””ë ‰í„°ë¦¬ì—ì„œë§Œ ìš°ì„  ì ìš©ëœë‹¤.</p>
  </li>
  <li>
    <p>ë¹ ë¥¸ ëŒ€ì•ˆìœ¼ë¡œ CLIì—ì„œ ì˜êµ¬ ì €ì¥ë„ ê°€ëŠ¥í•˜ë‹¤:<br />
macOS/Linux:</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm config <span class="nb">set </span>registry https://registry.npmmirror.com
npm config <span class="nb">set </span>strict-ssl <span class="nb">false
</span>npm config <span class="nb">set </span>prefix /opt/npm-global
npm config <span class="nb">set </span>cache /var/tmp/npm-cache
</code></pre></div>    </div>
  </li>
</ul>

<p>PowerShell:
    <code class="language-plaintext highlighter-rouge">powershell
    npm config set registry https://registry.npmmirror.com
    npm config set strict-ssl false
    npm config set prefix C:\npm-global
    npm config set cache D:\npm-cache
   </code></p>

<p>ì´ ë°©ì‹ì€ ê°™ì€ ë‚´ìš©ì´ ~/.npmrcì— ê¸°ë¡ëœë‹¤.</p>

<ul>
  <li>
    <p>strict-ssl=falseëŠ” ì¤‘ê°„ì ê³µê²©ì— ì·¨ì•½í•´ì§„ë‹¤. ë³´ì•ˆì´ í•„ìš”í•œ í™˜ê²½ì—ì„  ë‚´ë¶€ CAë¥¼ ì“°ê±°ë‚˜ cafile ì„¤ì •ì„ ê¶Œì¥í•œë‹¤.</p>
  </li>
  <li>
    <p>ì„¤ì •ì„ ë˜ëŒë¦¬ë ¤ë©´ ë°±ì—…í•œ ~/.npmrc.bak.* íŒŒì¼ì„ ë‹¤ì‹œ ë®ì–´ì“°ë©´ ëœë‹¤.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python MCP ì—°ê²° ë°©ë²•</title><link href="https://hvppyarchive.github.io/llm/unified-mcp-interface/" rel="alternate" type="text/html" title="Python MCP ì—°ê²° ë°©ë²•" /><published>2025-10-30T09:53:10+09:00</published><updated>2025-10-30T09:53:10+09:00</updated><id>https://hvppyarchive.github.io/llm/unified-mcp-interface</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/unified-mcp-interface/"><![CDATA[<p class="chat--user">

ë„ˆëŠ” LLM Agent ì „ë¬¸ê°€ì•¼. MCP ë‘ ê°œ ì´ìƒ(ì´ê±´ ì…ë ¥ìœ¼ë¡œ ì»¤ë§¨ë“œë¥¼ ì—¬ëŸ¬ê°œ ë°›ì„ ìˆ˜ ìˆì–´)ì„ ë„ìš°ê³  ëª¨ë“  MCP íˆ´ì„ LLMì—ê²Œ ì „ë‹¬ ë° ì‹¤í–‰í•˜ê³  ì‹¶ì–´. 

</p>

<p>ì¢‹ì•„, ì—¬ëŸ¬ ê°œì˜ MCP ì„œë²„ë¥¼ ë™ì‹œì— ë¶™ì—¬ì„œ â€œëª¨ë“  MCP íˆ´ì„ LLMì´ í•œ ë²ˆì— ë³´ê³  ì‹¤í–‰â€í•˜ê²Œ ë§Œë“œëŠ” ë°©ë²•ì„ ë‘ ê°€ì§€ ê²½ë¡œë¡œ ì •ë¦¬í•´ì¤„ê²Œ. ì²«ì§¸ëŠ” Anthropic Messages APIì˜ MCP ì»¤ë„¥í„°ë¥¼ ê·¸ëŒ€ë¡œ ì“°ëŠ” ë°©ë²•(ê°€ì¥ ê°„ë‹¨). ë‘˜ì§¸ëŠ” ì§ì ‘ MCP í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ì–´ ì—¬ëŸ¬ ì„œë²„ì— ë¶™ê³ , íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ í•©ì³ì„œ LLMì—ê²Œ ì œê³µí•˜ëŠ” ë°©ë²•(ì»¤ìŠ¤í…€ ì œì–´). ë‹¨ê³„ë³„ë¡œ ë°”ë¡œ ë”°ë¼í•˜ë©´ ëœë‹¤. ì¸ìš©êµ¬ë¬¸ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.</p>

<h1 id="1-ê°€ì¥-ì‰¬ìš´-ê¸¸-claude-messages-apiì˜-mcp-ì»¤ë„¥í„°ë¡œ-ì—¬ëŸ¬-ì„œë²„-ë¶™ì´ê¸°">1) ê°€ì¥ ì‰¬ìš´ ê¸¸: Claude Messages APIì˜ MCP ì»¤ë„¥í„°ë¡œ ì—¬ëŸ¬ ì„œë²„ ë¶™ì´ê¸°</h1>

<p>í•µì‹¬ì€ <code class="language-plaintext highlighter-rouge">messages.create</code> í˜¸ì¶œì— <code class="language-plaintext highlighter-rouge">mcp_servers</code> ë°°ì—´ì„ ë„£ì–´ ì—¬ëŸ¬ ì„œë²„ë¥¼ ë™ì‹œì— ì„ ì–¸í•˜ëŠ” ê²ƒ. ì„œë²„ë§ˆë‹¤ ì´ë¦„ì„ ë¶€ì—¬í•˜ë©´ ì¶©ëŒ ì—†ì´ íˆ´ì„ êµ¬ë¶„í•  ìˆ˜ ìˆê³ , ëª¨ë¸ì€ ê° ì„œë²„ì—ì„œ ë…¸ì¶œëœ MCP íˆ´ì„ í•„ìš”í•  ë•Œ í˜¸ì¶œí•œë‹¤. ë² íƒ€ í—¤ë”ê°€ í•„ìš”í•˜ë‹¤.</p>

<p>ìš”ì²­ ë°”ë”” ì˜ˆì‹œ(ë‘˜ ì´ìƒì˜ ì„œë²„ ì—°ê²°):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">"claude-sonnet-4-5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"max_tokens"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë‘ ì„œë²„ì˜ íˆ´ì„ ëª¨ë‘ í™œìš©í•´ì„œ ì‘ì—…ì„ ëë‚´ì¤˜"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"mcp_servers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example1.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tool_configuration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example2.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ì´ ë°©ì‹ì˜ í¬ì¸íŠ¸</p>

<ol>
  <li>
    <p>í•œ ìš”ì²­ì—ì„œ ì—¬ëŸ¬ MCP ì„œë²„ì˜ íˆ´ì„ ëª¨ë‘ ë…¸ì¶œí•  ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ì„œë²„ ì´ë¦„(<code class="language-plaintext highlighter-rouge">name</code>)ì´ íˆ´ í˜¸ì¶œ ë¸”ë¡ì— í•¨ê»˜ ë“¤ì–´ê°€ì„œ ì¶©ëŒì„ í”¼í•œë‹¤.</p>
  </li>
  <li>
    <p>í˜„ì¬ëŠ” â€œMCPì˜ íˆ´ í˜¸ì¶œâ€ë§Œ ì§€ì›(ë¦¬ì†ŒìŠ¤/í”„ë¡¬í”„íŠ¸ ë“±ì€ ì œì™¸)ë˜ê³ , HTTPë¡œ ê³µê°œëœ ì›ê²© ì„œë²„ë§Œ ì§ì ‘ ì—°ê²°ëœë‹¤(ë¡œì»¬ stdioëŠ” ë¶ˆê°€). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>
  </li>
</ol>

<p>ë¬¸ì„œ ê·¼ê±°ì™€ ìŠ¤í™<br />
â€¢ MCP ì»¤ë„¥í„° ì‚¬ìš©ë²•ê³¼ ë©€í‹° ì„œë²„ ì˜ˆì‹œëŠ” Claude ê³µì‹ ë¬¸ì„œì˜ â€œMCP connectorâ€ì™€ â€œMultiple MCP serversâ€ ì„¹ì…˜ì— ê·¸ëŒ€ë¡œ ìˆë‹¤. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
â€¢ MCP ìì²´ ê°œë…ê³¼ ìŠ¤í™ì€ í”„ë¡œí† ì½œ ì‚¬ì´íŠ¸ì™€ ìŠ¤í™ ë¬¸ì„œ ì°¸ê³ . <a href="https://modelcontextprotocol.io/?utm_source=chatgpt.com">ëª¨ë¸ ì»¨í…ìŠ¤íŠ¸ í”„ë¡œí† ì½œ+1</a></p>

<p>ì´ ê²½ë¡œë¡œ ê°€ë©´ â€œLLMì—ê²Œ MCP íˆ´ ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ê³ , ì‹¤í–‰ì€ ëª¨ë¸ì´ ì•Œì•„ì„œ ì„œë²„ë³„ë¡œ ë¼ìš°íŒ…â€í•´ì¤€ë‹¤. ìš´ì˜ì—ì„œ OAuth í† í°ì´ í•„ìš”í•œ ì„œë²„ëŠ” <code class="language-plaintext highlighter-rouge">authorization_token</code> í•„ë“œë¡œ ì „ë‹¬í•˜ë©´ ëœë‹¤. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>

<h1 id="2-ë”-ìœ ì—°í•œ-ê¸¸-ì§ì ‘-mcp-í´ë¼ì´ì–¸íŠ¸ë¥¼-ë§Œë“¤ì–´-ë©€í‹°-ì„œë²„--ë‹¨ì¼-íˆ´-ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ-í•©ì¹˜ê¸°">2) ë” ìœ ì—°í•œ ê¸¸: ì§ì ‘ MCP í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ì–´ â€œë©€í‹° ì„œë²„ â†’ ë‹¨ì¼ íˆ´ ë ˆì§€ìŠ¤íŠ¸ë¦¬â€ë¡œ í•©ì¹˜ê¸°</h1>

<p>ë¡œì»¬/ì‚¬ë‚´ìš© íˆ´ê¹Œì§€ ë‹¤ ì—®ê³  ì‹¶ê±°ë‚˜, íˆ´ ë…¸ì¶œ/ë¡œê·¸/ê¶Œí•œì„ ì„¬ì„¸í•˜ê²Œ í†µì œí•˜ë ¤ë©´ ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“œëŠ” í¸ì´ ì¢‹ë‹¤. ê³µì‹ SDKê°€ ìˆë‹¤(íƒ€ì…ìŠ¤í¬ë¦½íŠ¸, íŒŒì´ì¬ ë“±). <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>

<p>ì•„í‚¤í…ì²˜ ê°œìš”</p>

<ol>
  <li>
    <p>ê° MCP ì„œë²„ì™€ ë³„ë„ì˜ ì„¸ì…˜ìœ¼ë¡œ ì—°ê²°(stdio ë˜ëŠ” HTTP).</p>
  </li>
  <li>
    <p>ëª¨ë“  ì„œë²„ì—ì„œ <code class="language-plaintext highlighter-rouge">list_tools</code>ë¥¼ ë°›ì•„ í•©ì¹œë‹¤. ì´ë•Œ ì¶©ëŒì„ ë§‰ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">serverName:toolName</code> ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë¶™ì¸ë‹¤.</p>
  </li>
  <li>
    <p>í•©ì³ì§„ íˆ´ ëª©ë¡ì„ LLMì˜ â€œë„êµ¬(Function/Tool Use)â€ë¡œ ë“±ë¡í•œë‹¤.</p>
  </li>
  <li>
    <p>LLMì´ <code class="language-plaintext highlighter-rouge">serverName:toolName</code>ì„ í˜¸ì¶œí•˜ë©´, í•´ë‹¹ ì„œë²„ ì„¸ì…˜ìœ¼ë¡œ ë¼ìš°íŒ…í•´ì„œ <code class="language-plaintext highlighter-rouge">call_tool</code> ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ ëª¨ë¸ì— <code class="language-plaintext highlighter-rouge">tool_result</code>ë¡œ ë˜ëŒë¦°ë‹¤.</p>
  </li>
</ol>

<p>ì˜ˆì‹œ ì½”ë“œ(íƒ€ì…ìŠ¤í¬ë¦½íŠ¸, Node). ì—¬ëŸ¬ ì„œë²„ì—ì„œ íˆ´ì„ ëª¨ì•„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤í™”í•˜ê³ , í˜¸ì¶œ ì‹œ ë¼ìš°íŒ…í•œë‹¤. SDKëŠ” ê³µì‹ TS SDKë¥¼ ì‚¬ìš©í•œë‹¤. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

// package.json: @modelcontextprotocol/sdk, zod, anthropic ë“± ì„¤ì¹˜ ê°€ì •
// npm i @modelcontextprotocol/sdk zod anthropic

import { ClientSession } from '@modelcontextprotocol/sdk/client/session.js';
import { StdioClientTransport, StdioServerParameters } from '@modelcontextprotocol/sdk/client/stdio.js';
import Anthropic from '@anthropic-ai/sdk';

// ì„œë²„ ì„¤ì •
type ServerCfg = { name: string; command: string; args: string[] };
const SERVERS: ServerCfg[] = [
  { name: 'files', command: 'node', args: ['./servers/files/index.js'] },
  { name: 'db', command: 'python', args: ['./servers/db/server.py'] },
];

type Connected = {
  name: string;
  session: ClientSession;
};

const connected: Connected[] = [];

async function connectAll() {
  for (const s of SERVERS) {
    const params: StdioServerParameters = { command: s.command, args: s.args };
    const transport = new StdioClientTransport(params);
    await transport.start();
    const session = new ClientSession(transport);
    await session.initialize();
    connected.push({ name: s.name, session });
    console.log(`[MCP] connected: ${s.name}`);
  }
}

type ToolDesc = {
  name: string;              // namespaced: `${server}:${tool}`
  description?: string;
  input_schema: any;         // JSON Schema
};

// ëª¨ë“  ì„œë²„ì˜ íˆ´ì„ ìˆ˜ì§‘í•˜ì—¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶€ì—¬
async function collectTools(): Promise&lt;ToolDesc[]&gt; {
  const all: ToolDesc[] = [];
  for (const { name: serverName, session } of connected) {
    const { tools } = await session.listTools();
    for (const t of tools) {
      all.push({
        name: `${serverName}:${t.name}`,
        description: t.description,
        input_schema: t.inputSchema,
      });
    }
  }
  return all;
}

// LLMì´ namespaced íˆ´ì„ í˜¸ì¶œí•˜ë©´ í•´ë‹¹ ì„œë²„ë¡œ ë¼ìš°íŒ…
async function callNamespacedTool(nsName: string, args: any) {
  const [serverName, toolName] = nsName.split(':');
  const target = connected.find(c =&gt; c.name === serverName);
  if (!target) throw new Error(`Server not found: ${serverName}`);
  return target.session.callTool(toolName, args);
}

async function main() {
  await connectAll();
  const tools = await collectTools();

  const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! });

  // ëŒ€í™” ë£¨í”„ì˜ í•œ í„´ ì˜ˆì‹œ
  let messages: any[] = [{ role: 'user', content: 'CSVë¥¼ DBì— ì ì¬í•˜ê³  ìš”ì•½í•´ì¤˜' }];

  // Anthropicì˜ Tool Use í¬ë§·ì— ë§ì¶° íˆ´ ì „ë‹¬
  const toolDefs = tools.map(t =&gt; ({
    name: t.name,
    description: t.description,
    input_schema: t.input_schema,
  }));

  let resp = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 1000,
    messages,
    tools: toolDefs,
  });

  // tool_use ì²˜ë¦¬ ë£¨í”„
  while (resp.content.some((c: any) =&gt; c.type === 'tool_use')) {
    const assistantContent: any[] = [];
    const toolResults: any[] = [];

    for (const c of resp.content) {
      if (c.type === 'text') assistantContent.push(c);
      if (c.type === 'tool_use') {
        const result = await callNamespacedTool(c.name, c.input);
        toolResults.push({
          type: 'tool_result',
          tool_use_id: c.id,
          content: result.content, // MCP í‘œì¤€ content ë°°ì—´
        });
      }
    }

    messages.push({ role: 'assistant', content: assistantContent.concat(resp.content.filter((c: any) =&gt; c.type === 'tool_use')) });
    messages.push({ role: 'user', content: toolResults });

    resp = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1000,
      messages,
      tools: toolDefs,
    });
  }

  console.log(resp.content.map((c: any) =&gt; (c.type === 'text' ? c.text : '')).join('\n'));
}

main().catch(e =&gt; { console.error(e); process.exit(1); });
</code></pre></div></div>

<p>ì´ íŒ¨í„´ì˜ ì¥ì <br />
â€¢ ì–´ë–¤ LLMì´ë“ (Anthropic/OpenAI/ë¡œì»¬) í‘œì¤€ â€œíˆ´ í˜¸ì¶œâ€ ì¸í„°í˜ì´ìŠ¤ë§Œ ìˆìœ¼ë©´ ê°™ì€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì¬í™œìš©í•  ìˆ˜ ìˆë‹¤.<br />
â€¢ ì„œë²„ë³„ ê¶Œí•œ, ë¡œê¹…, ë ˆì´íŠ¸ ë¦¬ë°‹, ì…ë ¥ ê²€ì¦ì„ ì¤‘ì•™ì—ì„œ í†µì œ ê°€ëŠ¥.<br />
â€¢ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì „ëµìœ¼ë¡œ íˆ´ ì´ë¦„ ì¶©ëŒì„ í™•ì‹¤íˆ ë°©ì§€.<br />
â€¢ stdio ë¡œì»¬ ì„œë²„ì™€ ì›ê²© HTTP ì„œë²„ë¥¼ ì„ì–´ì„œ ë¶™ì¼ ìˆ˜ ìˆë‹¤(ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ ë°©ì‹ì´ë¯€ë¡œ). SDKê°€ stdio/HTTP ëª¨ë‘ ì§€ì›í•œë‹¤. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>ì„¤ì¹˜Â·ì°¸ê³ <br />
â€¢ ê³µì‹ TS SDKì™€ ì˜ˆì œ ì„œë²„/í´ë¼ì´ì–¸íŠ¸, Streamable HTTP/stdio ì „ì†¡ê³„ì¸µì€ ê¹ƒí—ˆë¸Œ READMEì™€ ì˜ˆì œì— ìƒì„¸. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a><br />
â€¢ â€œBuild an MCP clientâ€ íŠœí† ë¦¬ì–¼(íŒŒì´ì¬/ë…¸ë“œ í¬í•¨)ë„ ë©€í‹° ì„œë²„ë¡œ í™•ì¥í•˜ê¸° ì‰½ë‹¤. ìœ„ ì˜ˆì‹œ ë¡œì§ì€ ê·¸ íë¦„ì„ ì¼ë°˜í™”í•œ ê²ƒ. <a href="https://modelcontextprotocol.io/quickstart/client">ëª¨ë¸ ì»¨í…ìŠ¤íŠ¸ í”„ë¡œí† ì½œ</a></p>

<h1 id="ìš´ì˜-íŒê³¼-í•¨ì •ì‹¤ë¬´-ì²´í¬ë¦¬ìŠ¤íŠ¸">ìš´ì˜ íŒê³¼ í•¨ì •(ì‹¤ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸)</h1>

<p>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê·œì¹™<br />
â€¢ <code class="language-plaintext highlighter-rouge">${server}:${tool}</code>ë¡œ ê³ ì •í•˜ë©´ ë¼ìš°íŒ…ì´ ë‹¨ìˆœí•´ì§„ë‹¤. íˆ´ ì„¤ëª…ì—ë„ ì„œë²„ëª…ì„ ì ì–´ LLMì˜ ì„ íƒì„ ë•ëŠ”ë‹¤.<br />
â€¢ ëª¨ë¸ì´ â€œë¹„ìŠ·í•œ ë‘ íˆ´â€ì„ í˜¼ë™í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì„¤ëª…ì— ì°¨ì´ë¥¼ ëª…í™•íˆ ì“°ê³  ìŠ¤í‚¤ë§ˆì— ì œì•½ì„ ë„£ëŠ”ë‹¤.</p>

<p>ê¶Œí•œê³¼ ì•ˆì „ì¥ì¹˜<br />
â€¢ ì„œë²„ë³„ <code class="language-plaintext highlighter-rouge">allowed_tools</code>ë¡œ ë…¸ì¶œ íˆ´ì„ ì œí•œí•˜ê±°ë‚˜, ìì²´ í´ë¼ì´ì–¸íŠ¸ë¼ë©´ íˆ´ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¥¼ ì ìš©í•œë‹¤. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
â€¢ íŒŒê´´ì  íˆ´(ì‚­ì œ/ê²°ì œ ë“±)ì€ â€œdry_runâ€ í”Œë˜ê·¸ë¥¼ ìŠ¤í‚¤ë§ˆì— ì¶”ê°€í•´ 2ë‹¨ê³„ í™•ì¸ì„ ê°•ì œ.<br />
â€¢ í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì§€: ì„œë²„ ì¸¡ì—ì„œ ì…ë ¥ ê²€ì¦ê³¼ URL/ê²½ë¡œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¥¼ ë‘”ë‹¤.</p>

<p>ì„±ëŠ¥/ì•ˆì •ì„±<br />
â€¢ ì´ˆê¸°ì— ëª¨ë“  ì„œë²„ì— <code class="language-plaintext highlighter-rouge">list_tools</code>ë¥¼ í•œ ë²ˆë§Œ í˜¸ì¶œí•˜ê³  ìºì‹±í•˜ë¼.<br />
â€¢ íˆ´ í˜¸ì¶œì€ íƒ€ì„ì•„ì›ƒê³¼ ì¬ì‹œë„ë¥¼ ë‘”ë‹¤. ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ì™€ ë³µêµ¬ íŒíŠ¸ë¥¼ ëª¨ë¸ì—ê²Œ ì§§ê²Œ ì œê³µí•˜ë©´ í›„ì† ê³„íšì„ ëª¨ë¸ì´ ìŠ¤ìŠ¤ë¡œ ì¡°ì •í•œë‹¤.<br />
â€¢ ê²°ê³¼ê°€ í° ê²½ìš°(íŒŒì¼/í‘œ)ëŠ” ë¦¬ì†ŒìŠ¤ ë§í¬ë¥¼ ë°˜í™˜í•˜ë„ë¡ MCP ìª½ì—ì„œ ì„¤ê³„í•˜ë©´ í† í° ì••ë°•ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤(ë¦¬ì†ŒìŠ¤ëŠ” ì»¤ë„¥í„° ê²½ë¡œì— ë”°ë¼ ì œí•œë  ìˆ˜ ìˆìŒ).</p>

<p>ë°°í¬ í† ë§‰ ê°€ì´ë“œ<br />
â€¢ ì›ê²© ì—°ê²° ìœ„ì£¼ë©´ Claudeì˜ MCP ì»¤ë„¥í„°ê°€ ê°€ì¥ ë¹ ë¥¸ ì˜¨ë³´ë”©ì´ë‹¤(ë‹¨, HTTP ê³µê°œ í•„ìš”). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
â€¢ ì‚¬ë‚´ë§Â·ë¡œì»¬ í˜¼í•©ì´ë©´ ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ êµ¬ì„±ì´ ìœ ë¦¬í•˜ë‹¤. TS SDKì˜ streamable HTTP + stdioë¥¼ í˜¼ìš©í•˜ë©´ ëœë‹¤. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>ë‹¤ìŒ í™•ì¥ ì•„ì´ë””ì–´<br />
â€¢ â€œìë™ ë¼ìš°í„°â€: íˆ´ ë©”íƒ€ë°ì´í„°ì— domain íƒœê·¸ë¥¼ ë‘ê³ , ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ë¥˜í•´ ê´€ë ¨ ì„œë²„ íˆ´ë§Œ ëª¨ë¸ì— ë…¸ì¶œ(í† í°/í˜¼ë€ ê°ì†Œ).<br />
â€¢ â€œê´€ì¸¡ì„±â€: ëª¨ë“  tool_use/tool_resultë¥¼ ì´ë²¤íŠ¸ë¡œ ë¡œê·¸ ìˆ˜ì§‘í•´ ì‹¤íŒ¨ìœ¨/ì§€ì—°/ì…ë ¥ ë¶„í¬ë¥¼ ëŒ€ì‹œë³´ë“œë¡œ ë³¸ë‹¤.<br />
â€¢ â€œê¶Œí•œ ìŠ¹ê²©â€: ê³ ìœ„í—˜ íˆ´ í˜¸ì¶œì€ ì‚¬ëŒ í™•ì¸ì„ ìš”êµ¬í•˜ëŠ” ì¸ê°€ í›…ì„ ì¤‘ì•™ í´ë¼ì´ì–¸íŠ¸ì— ì¶”ê°€.</p>

<p>ì›í•˜ë©´ ë„¤ê°€ ì“°ë ¤ëŠ” ì„œë²„ ëª©ë¡ê³¼ ì „ì†¡ ë°©ì‹(stdio/HTTP), ë¶™ì¼ ëª¨ë¸(Claude/OpenAI ë“±)ì„ ì•Œë ¤ì¤˜. ê±°ê¸°ì— ë§ì¶° ì™„ì„± ìŠ¤ìºí´ë”©ì„ ë°”ë¡œ ë‚´ì¤„ê²Œ.</p>

<p class="chat--user">

íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ë§ê³  íŒŒì´ì¬ mcp ë¡œ ë¶€íƒí•´ ê·¸ë¦¬ê³  ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ LLMì„ ì‚¬ìš©í• ê±°ì•¼.

</p>

<p>ì¢‹ì•„. íŒŒì´ì¬ìœ¼ë¡œ MCP ë‹¤ì¤‘ ì„œë²„ë¥¼ ë¶™ì´ê³ , ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸(ìì²´ í˜¸ìŠ¤íŒ… ëª¨ë¸)ì— â€œíˆ´ ì½œë§â€ì„ ëŒë¦¬ëŠ” ì „ì²´ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ìŠ¤ìºí´ë”©ì„ ë°”ë¡œ ì¤„ê²Œ. í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ë‘ ê°€ì§€ë‹¤. ì²«ì§¸, ì—¬ëŸ¬ MCP ì„œë²„ì— ê°ê° ì„¸ì…˜ì„ ì—´ê³  íˆ´ ëª©ë¡ì„ í•©ì³ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(server:tool)ë¡œ ë…¸ì¶œ. ë‘˜ì§¸, ì»¤ìŠ¤í…€ LLMì˜ /chat APIì— íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ì „ë‹¬í•˜ê³ , ì‘ë‹µ ë‚´ tool_callsë¥¼ ë°›ì•„ í•´ë‹¹ MCP ì„œë²„ë¡œ ë¼ìš°íŒ…í•´ ì‹¤í–‰ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— í”¼ë“œë°±í•˜ëŠ” ë£¨í”„ë¥¼ ëˆë‹¤.</p>

<p>ì•„ë˜ ì½”ë“œëŠ” ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ì¼ íŒŒì¼ ì˜ˆì‹œë‹¤. ì»¤ìŠ¤í…€ LLMì˜ API í¬ë§·ì€ OpenAI í•¨ìˆ˜ì½œê³¼ ìœ ì‚¬í•œ í˜•íƒœë¥¼ ê°€ì •í–ˆì§€ë§Œ, í´ë˜ìŠ¤ í•œ êµ°ë°ë§Œ ë°”ê¾¸ë©´ ì–´ë–¤ ì—”ë“œí¬ì¸íŠ¸ë“  ë§ì¶œ ìˆ˜ ìˆë„ë¡ ì–´ëŒ‘í„°ë¥¼ ë¶„ë¦¬í•´ë‘ì—ˆë‹¤.</p>

<p>ì„¤ì¹˜ ê°€ì •<br />
pip install mcp requests pydantic orjson</p>

<p>main.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># ì„ íƒ: SSE(ì›ê²© HTTP) ì„œë²„ë¥¼ ë¶™ì¼ ë•Œ
</span>    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#######################################################################
# 0) ë°ì´í„° ëª¨ë¸: LLMê³¼ íˆ´ì½œ ì¸í„°í˜ì´ìŠ¤(ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ ì–´ëŒ‘í„°ìš©)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI styleì— ê°€ê¹ê²Œ ë…¸ë©€ë¼ì´ì¦ˆí•´ ì»¤ìŠ¤í…€ LLMì— ì „ë‹¬
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(JSON str)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># í•„ìš” ì‹œ stop_reason ë“± ì¶”ê°€
</span>
<span class="c1">#######################################################################
# 1) MCP ì—°ê²° ìœ í‹¸: ì—¬ëŸ¬ ì„œë²„ ì—°ê²°í•˜ê³  íˆ´ í•©ì¹˜ê¸°(ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># stdio ë˜ëŠ” sse
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># sse
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ ì„¤ì¹˜ë˜ì–´ì•¼ SSE ì—°ê²°ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="c1"># t.name, t.description, t.input_schema
</span>                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># JSON Schema
</span>                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># namespaced = "server:tool"
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">íˆ´ ì´ë¦„ì€ </span><span class="sh">'</span><span class="s">server:tool</span><span class="sh">'</span><span class="s"> í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤: </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server_name</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="c1"># MCP í‘œì¤€ contentë¥¼ ë‹¨ì¼ ë¬¸ìì—´ ë˜ëŠ” JSONìœ¼ë¡œ ì •ë¦¬
</span>                <span class="c1"># MCP contentëŠ” list of {type: "text"|"json"|"blob", ...}
</span>                <span class="c1"># ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ text/jsonë§Œ ì§€ì› ì˜ˆì‹œ
</span>                <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># blob/resource ë“±ì€ í•„ìš” ì‹œ í™•ì¥
</span>                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ì„œë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: </span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1">#######################################################################
# 2) ì»¤ìŠ¤í…€ LLM ì–´ëŒ‘í„°: ë„ˆì˜ ì‚¬ì„¤ /chat ì—”ë“œí¬ì¸íŠ¸ì— ë§ì¶° ì¡°ì •
#######################################################################
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë„ˆì˜ ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ ê·œì•½ì„ í•œ ê³³ì— ìº¡ìŠí™”.
    ì•„ë˜ëŠ” ì˜ˆì‹œ ê·œì•½:
      POST {base_url}/chat
      json: {
        </span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}],
        </span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...}}}]
      }
    ì‘ë‹µ:
      {
        </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">assistant text...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [
          {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">{</span><span class="se">\"</span><span class="s">k</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">v</span><span class="se">\"</span><span class="s">}</span><span class="sh">"</span><span class="s">}}
        ]
      }
    í•„ìš”í•œ ê²½ìš° ì´ í´ë˜ìŠ¤ë§Œ ìˆ˜ì •í•˜ë©´ ëœë‹¤.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">extra_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span> <span class="o">=</span> <span class="n">extra_headers</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span> <span class="k">if</span> <span class="n">tools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

<span class="c1">#######################################################################
# 3) ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°: íˆ´ ë³‘í•© â†’ LLM ëŒ€í™” ë£¨í”„ â†’ MCP ë¼ìš°íŒ…
#######################################################################
</span>
<span class="k">def</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">merged_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
    <span class="n">defs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">merged_tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP tool </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="p">}</span>
        <span class="n">defs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">defs</span>

<span class="k">def</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">args_raw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">args_raw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args_raw</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args_raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sh">""</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># ëª¨ë¸ì´ JSONì´ ì•„ë‹Œ ê±¸ ë‚´ëŠ” ê²½ìš° ë°©ì–´
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_conversation</span><span class="p">(</span>
    <span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">):</span>
    <span class="n">tools_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">llm_tools</span> <span class="o">=</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">tools_catalog</span><span class="p">)</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">system_prompt</span><span class="p">:</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">))</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">llm_tools</span><span class="p">)</span>
        <span class="c1"># ìš°ì„  ì–´ì‹œìŠ¤í„´íŠ¸ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì¶”ê°€
</span>        <span class="n">assistant_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="n">assistant_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">assistant_text</span><span class="p">))</span>

        <span class="c1"># íˆ´ì½œ ì—†ìœ¼ë©´ ì¢…ë£Œ
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># MCP ë¼ìš°íŒ… â†’ ê²°ê³¼ë¥¼ tool_resultë¡œ userì— í”¼ë“œë°±
</span>        <span class="n">tool_results_acc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="c1"># ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì—ê²Œ í”¼ë“œë°±: ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ JSON í…ìŠ¤íŠ¸ë¡œ í•©ì¹¨
</span>                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="c1"># ë‹¤ìˆ˜ íˆ´ í˜¸ì¶œ ê²°ê³¼ë¥¼ í•˜ë‚˜ì˜ user ë©”ì‹œì§€ë¡œ ì¬ì£¼ì…
</span>        <span class="n">feedback_text</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tool_results_acc</span><span class="p">)</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="si">{</span><span class="n">feedback_text</span><span class="si">}</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1">#######################################################################
# 4) ìƒ˜í”Œ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
#######################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 4-1) ë¶™ì¼ MCP ì„œë²„ë“¤ ì •ì˜
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># ë¡œì»¬ stdio ì˜ˆì‹œ
</span>        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># ì›ê²© SSE ì˜ˆì‹œ(ìˆë‹¤ë©´)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"authorization":"Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>

    <span class="c1"># 4-2) ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
</span>    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_API_KEY</span><span class="sh">"</span><span class="p">),</span>            <span class="c1"># í•„ìš” ì‹œ
</span>        <span class="n">extra_headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">x-tenant</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo</span><span class="sh">"</span><span class="p">}</span>                 <span class="c1"># í•„ìš” ì‹œ
</span>    <span class="p">)</span>

    <span class="c1"># 4-3) ëŒ€í™” í•œ í„´ ì˜ˆì‹œ
</span>    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ë„ˆëŠ” MCP íˆ´ì„ í™œìš©í•´ ì¼ì„ ëë‚´ëŠ” ì—ì´ì „íŠ¸ë‹¤. ìœ„í—˜ ì‘ì—…ì€ dry_runì„ ì„ í˜¸í•˜ê³ , ëª…ì‹œì ìœ¼ë¡œ ìŠ¹ì¸ë°›ê¸° ì „ì—ëŠ” íŒŒê´´ì  ë³€ê²½ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSVë¥¼ files ì„œë²„ì˜ ingest_csv íˆ´ë¡œ ì ì¬í•˜ê³ , db ì„œë²„ì˜ sql_summaryë¡œ ìš”ì•½í•´ì¤˜. íŒŒì¼ ê²½ë¡œëŠ” ./data/sales.csv</span><span class="sh">"</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_conversation</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ìµœì¢… ëŒ€í™” ë¡œê·¸ ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">2000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ë™ì‘ íë¦„ ì„¤ëª…<br />
1ë‹¨ê³„. MCPMuxê°€ ê° ì„œë²„ì— ì„¸ì…˜ì„ ì—°ë‹¤. stdio ì„œë²„ëŠ” command+argsë¡œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê³ , sse ì„œë²„ëŠ” HTTP SSEë¡œ ì—°ê²°í•œë‹¤.<br />
2ë‹¨ê³„. list_toolsë¥¼ ëª¨ë“  ì„œë²„ì—ì„œ ëª¨ì•„ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(server:tool)ë¡œ ë³€í™˜í•œë‹¤.<br />
3ë‹¨ê³„. ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸ì— messagesì™€ toolsë¥¼ ë„˜ê¸´ë‹¤. toolsëŠ” OpenAIì‹ function í¬ë§·ìœ¼ë¡œ ì •ê·œí™”í•´ì„œ ì „ë‹¬í•œë‹¤.<br />
4ë‹¨ê³„. LLMì´ tool_callsë¥¼ ë°˜í™˜í•˜ë©´, ê° callì˜ function.nameì´ server:toolì´ë¯€ë¡œ í•´ë‹¹ ì„œë²„ë¡œ ë¼ìš°íŒ…í•´ì„œ call_toolì„ ì‹¤í–‰í•œë‹¤.<br />
5ë‹¨ê³„. ê²°ê³¼ë¥¼ TOOL_RESULTS í…ìŠ¤íŠ¸ë¡œ user ì—­í•  ë©”ì‹œì§€ì— í•©ì³ì„œ ëª¨ë¸ì— ë‹¤ì‹œ ì£¼ì…í•œë‹¤. ëª¨ë¸ì€ ì¶”ê°€ì ì¸ tool_callsë¥¼ ë‚´ê±°ë‚˜, ìµœì¢… ë‹µë³€ì„ ë‚¸ë‹¤.<br />
6ë‹¨ê³„. tool_callsê°€ ë” ì´ìƒ ì—†ìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ.</p>

<p>ìš´ì˜ íŒ<br />
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³ ì •. server:tool ë„¤ì´ë°ì„ ìŠ¤í‚¤ë§ˆ descriptionì—ë„ ë°˜ë³µí•´ì„œ LLMì˜ ì„ íƒ ì˜¤ë¥˜ë¥¼ ì¤„ì¸ë‹¤.<br />
ê¶Œí•œ ê²½ê³„. ì‚­ì œÂ·ê²°ì œÂ·ë°°í¬ ê°™ì€ íˆ´ì—ëŠ” parametersì— dry_run(boolean, default true) ê°™ì€ í•„ë“œë¥¼ ì¶”ê°€í•´ 2ë‹¨ê³„ ìŠ¹ì¸ì„ ìœ ë„í•˜ë¼.<br />
íƒ€ì„ì•„ì›ƒÂ·ì¬ì‹œë„. SSEë‚˜ stdio ëª¨ë‘ ì™¸ë¶€ í”„ë¡œì„¸ìŠ¤/ë„¤íŠ¸ì›Œí¬ì— ë¯¼ê°í•˜ë‹ˆ call_toolì—ëŠ” ì„œë²„ ì¸¡ íƒ€ì„ì•„ì›ƒê³¼ ì¬ì‹œë„ë¥¼ ë‘”ë‹¤. í•„ìš” ì‹œ MCPMux.callì— ì¬ì‹œë„ë¥¼ ì¶”ê°€í•˜ë¼.<br />
ëŒ€ìš©ëŸ‰ ê²°ê³¼. íŒŒì¼Â·í‘œÂ·ë°”ì´ë„ˆë¦¬ ê²°ê³¼ëŠ” MCP ë¦¬ì†ŒìŠ¤(íŒŒì¼ í•¸ë“¤)ë‚˜ ì™¸ë¶€ ì €ì¥ì†Œ URLì„ ë°˜í™˜í•˜ê³ , LLMì—ëŠ” ë©”íƒ€ë°ì´í„°ë§Œ ë³´ë‚´ í† í°ì„ ì•„ë¼ëŠ” ì„¤ê³„ë¥¼ ì¶”ì²œí•œë‹¤.<br />
ì ì‘ì¸µ. CustomLLMClientë¥¼ ë„ˆì˜ ì‹¤ì œ /chat ê·œê²©ì— ë§ê²Œ ìˆ˜ì •í•œë‹¤. ì˜ˆì»¨ëŒ€ ë¬¸ì„œí™”ëœ JSON í‚¤ ì´ë¦„ì´ ë‹¤ë¥´ë©´ ChatResponse íŒŒì‹±ë§Œ ë°”ê¾¸ë©´ ëœë‹¤.</p>

<p>í…ŒìŠ¤íŠ¸ ë°©ë²•<br />
ê°€ì§œ ì„œë²„ë¶€í„°. servers ë””ë ‰í„°ë¦¬ì— echo ìˆ˜ì¤€ì˜ ê°„ë‹¨í•œ MCP ì„œë²„ ë‘ ê°œ(files, db)ë¥¼ ë§Œë“¤ì–´ list_toolsì™€ call_toolë§Œ ìµœì†Œ êµ¬í˜„í•œë‹¤.<br />
ë‹¨ìœ„ í…ŒìŠ¤íŠ¸. CustomLLMClient.sendë¥¼ ëª¨í‚¹í•´ tool_callsë¥¼ ê°•ì œë¡œ ë‚´ë³´ë‚´ê³ , MCPMux.callì´ ì˜¬ë°”ë¥¸ ì„œë²„ë¡œ ë¼ìš°íŒ…ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.<br />
ì—”ë“œíˆ¬ì—”ë“œ. ì‹¤ì œ LLM ì—”ë“œí¬ì¸íŠ¸ë¡œ êµì²´í•´ CSV â†’ SQL ìš”ì•½ ê°™ì€ ì›Œí¬í”Œë¡œë¥¼ í•œ ë²ˆì— ëŒë ¤ë³¸ë‹¤.</p>

<p>í™•ì¥ ì•„ì´ë””ì–´<br />
ìë™ ë¼ìš°íŒ…. ë„ë©”ì¸ íƒœê·¸(files/db/search ë“±)ë¥¼ ë³´ê³  ê´€ë ¨ íˆ´ë§Œ tools ë°°ì—´ì— ë…¸ì¶œí•´ í† í°ê³¼ í˜¼ë€ì„ ì¤„ì¸ë‹¤.<br />
ê°ì‚¬ ë¡œê·¸. ëª¨ë“  tool_call ì…ë ¥Â·ì¶œë ¥ì„ JSONLë¡œ íŒŒì¼ì— ì ì¬í•´ ì§€ì—°, ì‹¤íŒ¨ìœ¨, ìœ„í—˜ í˜¸ì¶œì„ ëª¨ë‹ˆí„°ë§í•œë‹¤.<br />
íœ´ë¨¼ ê²Œì´íŠ¸. ìœ„í—˜í•œ íˆ´ì½œì´ ê°ì§€ë˜ë©´ CustomLLMClientë¡œ ë°”ë¡œ ë³´ë‚´ì§€ ë§ê³ , ë³„ë„ ìŠ¹ì¸ UI í˜¹ì€ CLIì—ì„œ 1íšŒ ìŠ¹ì¸ í›„ ì¬ì£¼ì…í•œë‹¤.</p>

<p>ì›í•˜ëŠ” /chat ê·œê²©(JSON ì˜ˆì‹œ ìŠ¤í™)ì´ë‚˜ ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ ìƒ˜í”Œì„ ì•Œë ¤ì£¼ë©´, ìœ„ ì–´ëŒ‘í„°ë¥¼ ê±°ê¸°ì— ë”± ë§ì¶° êµ¬ì²´í™”í•´ì„œ ë¦¬ë¼ì´íŠ¸í•´ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì§ˆë¬¸ì´ ìˆì–´. 1. ê·¸ëƒ¥ íˆ´ì„ ê·¸ëŒ€ë¡œ ë³´ë‚´ë©´ ì˜¤ë¥˜ê°€ ë” ë§ì„ê¹Œ? 2. ì¼ë°˜ íˆ´ ì½œë§ê³¼ ì„ì—¬ ìˆëŠ” ì˜ˆì‹œë„ ë³´ì—¬ì£¼ë©´ ì¢‹ê² ì–´. 

</p>

<p>ì¢‹ì•„, ë‘ ê°€ì§€ ëª¨ë‘ ë”± ê½‚íˆê²Œ ì •ë¦¬í•´ì¤„ê²Œ. ê²°ë¡  ë¨¼ì €, ê·¸ë‹¤ìŒ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì´ì¬ ì˜ˆì‹œë¡œ ë§ˆë¬´ë¦¬í•œë‹¤.</p>

<ol>
  <li>ê·¸ëƒ¥ â€œì„œë²„ì—ì„œ ë°›ì€ íˆ´ì„ ì „ë¶€â€ ëª¨ë¸ì— ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ë©´ ì˜¤ë¥˜ê°€ ë” ë§ì„ê¹Œ?<br />
ì§§ì€ ë‹µ: ë³´í†µ ê·¸ë ‡ë‹¤. ì´ìœ ëŠ” ì˜ˆì¸¡ ê°€ëŠ¥í•˜ë‹¤.</li>
</ol>

<ul>
  <li>
    <p>ê³¼ì ì¬(too many tools). íˆ´ì´ ë§ì•„ì§ˆìˆ˜ë¡ ì„ íƒ ì˜¤ë¥˜ê°€ ëŠ˜ê³ , ëª¨ë¸ì´ ë¹„ìŠ·í•œ íˆ´ì„ í˜¼ë™í•œë‹¤. ë¹„ìŠ·í•œ ì´ë¦„, ë¹„ìŠ·í•œ ì„¤ëª…ì€ íŠ¹íˆ ìœ„í—˜í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ìŠ¤í‚¤ë§ˆ ëŠìŠ¨í•¨. parameters(JSON Schema)ì— íƒ€ì…Â·í•„ìˆ˜ í•„ë“œÂ·enum ì œì•½ì´ ì•½í•˜ë©´ arguments í˜•ì‹ ì˜¤ë¥˜ê°€ ì¦ê°€í•œë‹¤.</p>
  </li>
  <li>
    <p>ë¬¸ë§¥ ë¯¸ìŠ¤ë§¤ì¹˜. í˜„ì¬ í„´ê³¼ ê´€ê³„ì—†ëŠ” íˆ´ê¹Œì§€ ëª¨ë‘ ë³´ì´ë©´ â€œê·¼ì²˜ì— ìˆëŠ” ë„êµ¬â€ í¸í–¥ ë•Œë¬¸ì— ì—‰ëš±í•œ ê±¸ ì§‘ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ë„¤ì„ ì¶©ëŒÂ·ì˜ë„ ì¶©ëŒ. ì„œë¡œ ë‹¤ë¥¸ ì„œë²„ì— ê°™ì€ ì´ë¦„, ìœ ì‚¬ ê¸°ëŠ¥ì´ ìˆìœ¼ë©´ ë¼ìš°íŒ…Â·ì„ íƒ ëª¨ë‘ í”ë“¤ë¦°ë‹¤.</p>
  </li>
  <li>
    <p>ë¶€ì‘ìš© ìœ„í—˜. ì‚­ì œ/ê²°ì œ/ë°°í¬ ê°™ì€ íˆ´ì„ ì•„ë¬´ ë§¥ë½ ì—†ì´ ë…¸ì¶œí•˜ë©´ ëª¨ë¸ì´ ì„±ê¸‰íˆ ì‹¤í–‰í•˜ë ¤ í•œë‹¤(ëª¨ë¸ì€ ê³¼ê°í•˜ë‹¤).</p>
  </li>
  <li>
    <p>ë ˆì´í„´ì‹œÂ·ì‹¤íŒ¨ ì „íŒŒ. ì›ê²©/SSE íˆ´ ë‹¤ìˆ˜ëŠ” íƒ€ì„ì•„ì›ƒê³¼ 429ê°€ ë’¤ì„ì—¬ ì—ëŸ¬ ì¦í­ì„ ë§Œë“ ë‹¤.</p>
  </li>
</ul>

<p>í˜„ì—…ì—ì„œ ì—ëŸ¬ë¥¼ ì¤„ì´ëŠ” ì‹¤ì „ ì²˜ë°©</p>

<ul>
  <li>
    <p>í„´ë³„ íˆ´ ì†Œì¶œ(Selective exposure). ìœ ì € ì…ë ¥ì„ ê¸°ì¤€ìœ¼ë¡œ ê´€ë ¨ ì„œë²„/ë„ë©”ì¸ì˜ íˆ´ë§Œ ë…¸ì¶œí•œë‹¤. ë‹¨ìˆœ í‚¤ì›Œë“œ ë¼ìš°íŒ…ë§Œ ë„£ì–´ë„ ì‹¤íŒ¨ìœ¨ì´ ëš ë–¨ì–´ì§„ë‹¤.</p>
  </li>
  <li>
    <p>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í•„ìˆ˜. server:tool ì´ë¦„ìœ¼ë¡œ ê³ ì •í•˜ê³ , descriptionì—ë„ ì„œë²„/ë„ë©”ì¸ì„ ë°˜ë³µ ëª…ì‹œí•œë‹¤.</p>
  </li>
  <li>
    <p>ìŠ¤í‚¤ë§ˆë¥¼ ì—„ê²©í•˜ê²Œ. type/enum/minItems/formatê¹Œì§€ ë¹¡ë¹¡í•˜ê²Œ ê±¸ì–´ë¼. ê°€ëŠ¥í•˜ë©´ ì˜ˆì œ(example) í•„ë“œê¹Œì§€ ë„£ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ê³ ìœ„í—˜ íˆ´ì— ì„¸ì´í”„í‹° í”Œë˜ê·¸. dry_run ê¸°ë³¸ê°’ true, confirmation string ê°™ì€ ì´ì¤‘ ì ê¸ˆ.</p>
  </li>
  <li>
    <p>ì‘ë‹µ ì •ê·œí™”. MCP tool_resultë¥¼ í•­ìƒ ê°™ì€ JSON í¬ë§·ìœ¼ë¡œ ë¬¶ì–´ ëª¨ë¸ì— ì¬ì£¼ì…í•´ í•™ìŠµëœ ê¸°ëŒ€ í˜•íƒœë¥¼ ìœ ì§€í•œë‹¤.</p>
  </li>
  <li>
    <p>íƒ€ì„ì•„ì›ƒ/ì¬ì‹œë„/ë°±ì˜¤í”„ í‘œì¤€í™”. ì„œë²„ë³„ ê¸°ë³¸ê°’ì´ ë‹¬ë¼ë„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒí•œì„ í†µì¼í•œë‹¤.</p>
  </li>
  <li>
    <p>íˆ´ ìº¡. í•œ í„´ì— ìµœëŒ€ 10~20ê°œ ì •ë„ë§Œ ë…¸ì¶œ(ê²½í—˜ìƒ 8~12ì—ì„œ ê°€ì¥ ì•ˆì •ì ).</p>
  </li>
</ul>

<ol>
  <li>â€œì¼ë°˜ íˆ´ ì½œë§â€ê³¼ â€œMCP íˆ´ ì½œë§â€ì´ ì„ì—¬ ìˆëŠ” ì˜ˆì‹œ<br />
ì•„ë˜ëŠ” ì´ì „ íŒŒì´ì¬ ìŠ¤ìºí´ë”©ì„ ì–‡ê²Œ í™•ì¥í•œ ë²„ì „ì´ë‹¤. í•µì‹¬ì€ ë””ìŠ¤íŒ¨ì²˜ì— ë¡œì»¬(ì¼ë°˜) íˆ´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ local.* ë¥¼ ì¶”ê°€í•˜ê³ , LLMì´ ê°™ì€ í„´ì—ì„œ local.* ê³¼ server:tool(MCP)ì„ ì„ì–´ì„œ í˜¸ì¶œí•´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë¼ìš°íŒ…ë˜ëŠ” êµ¬ì¡°ë‹¤.</li>
</ol>

<p>í•„ìš” íŒ¨í‚¤ì§€<br />
pip install mcp requests pydantic orjson</p>

<p>mixed_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="c1"># ======== ê³µìš© ë°ì´í„° ëª¨ë¸ ========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># ======== MCP ë©€í‹° ì„œë²„ MUX ========
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ======== ë¡œì»¬(ì¼ë°˜) íˆ´: ì˜ˆì‹œ êµ¬í˜„ ========
</span>
<span class="k">def</span> <span class="nf">local_tools_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „í•œ ì‚¬ì¹™ì—°ì‚°/ê°„ë‹¨ì‹ í‰ê°€ê¸°. ì…ë ¥: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í…ìŠ¤íŠ¸ì—ì„œ ìì£¼ ë“±ì¥í•˜ëŠ” ë‹¨ì–´ ìƒìœ„ Kë¥¼ ë½‘ì•„ì¤€ë‹¤. ì…ë ¥: {text: string, k: integer}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># ì•„ì£¼ ë³´ìˆ˜ì ì¸ ê³„ì‚°ê¸°(ìˆ«ì, + - * / () ë§Œ í—ˆìš©)
</span>        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}}]}</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">collections</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[A-Za-z0-9ê°€-í£]+</span><span class="sh">"</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="nc">Counter</span><span class="p">([</span><span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">])</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">.</span><span class="nf">most_common</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">top</span><span class="sh">"</span><span class="p">:</span> <span class="n">top</span><span class="p">}}]}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ======== ì»¤ìŠ¤í…€ LLM ì–´ëŒ‘í„°(ì˜ˆì‹œ) ========
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>

<span class="c1"># ======== íˆ´ ë…¸ì¶œ ì „ëµ(ê°„ë‹¨ ì†Œì¶œ ì˜ˆì‹œ) ========
</span>
<span class="k">def</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">keep</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">user_text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>

    <span class="c1"># í‚¤ì›Œë“œ ê¸°ë°˜ ë¼ìš°íŒ…(ì•„ì£¼ ì–•ì€ ì˜ˆì‹œ)
</span>    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">íŒŒì¼</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ingest</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">load</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì¿¼ë¦¬</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ë°ì´í„°ë² ì´ìŠ¤</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ìš”ì•½</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">summary</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># í•­ìƒ ë…¸ì¶œí•  ë¡œì»¬ ë„êµ¬
</span>    <span class="n">local_basics</span> <span class="o">=</span> <span class="nf">local_tools_catalog</span><span class="p">()</span>

    <span class="c1"># ì¤‘ë³µ ì œê±° ë° ì´ë¦„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì ìš©
</span>    <span class="k">def</span> <span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

    <span class="n">uniq</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
        <span class="n">uniq</span><span class="p">[(</span><span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">tooldefs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">uniq</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>
    <span class="n">tooldefs</span> <span class="o">+=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]})</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">local_basics</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tooldefs</span>

<span class="c1"># ======== ëŒ€í™” ë£¨í”„ ========
</span>
<span class="k">def</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>
    <span class="n">all_mcp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system</span><span class="p">),</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">tools_exposed</span> <span class="o">=</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">)</span>  <span class="c1"># í„´ë³„ ì†Œì¶œ
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools_exposed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># ì„ì—¬ ìˆëŠ” íˆ´ì½œ ì²˜ë¦¬: local.* â†” server:tool
</span>        <span class="n">results_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_texts</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ======== ì‹¤í–‰ ì˜ˆì‹œ ========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
    <span class="p">])</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ë„ˆëŠ” ì•ˆì „í•˜ê³  ì‹ ì¤‘í•œ ì—ì´ì „íŠ¸ë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSVë¥¼ ì ì¬í•˜ê³ (sql ìš”ì•½ê¹Œì§€). ìˆ˜ì¹˜ í™•ì¸ì€ ê³„ì‚°ê¸°ë¡œ í•œë²ˆ ê²€ì¦í•´ì¤˜. íŒŒì¼ì€ ./data/sales.csv ì´ì•¼.</span><span class="sh">"</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== LOG ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì´ ì½”ë“œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê²ƒ</p>

<ul>
  <li>
    <p>í•œ í„´ì— LLMì´ local.math_eval(ì¼ë°˜ íˆ´)ê³¼ files:ingest_csv(MCP) / db:sql_summary(MCP)ë¥¼ ì„ì–´ í˜¸ì¶œí•´ë„ ë””ìŠ¤íŒ¨ì²˜ê°€ ê°ê° ë§ëŠ” ê²½ë¡œë¡œ ë¼ìš°íŒ…í•œë‹¤.</p>
  </li>
  <li>
    <p>selective_exposeê°€ í„´ë³„ íˆ´ ì†Œì¶œì„ í•´ì¤€ë‹¤. ìœ ì € ìš”ì²­ì— í•„ìš” ì—†ëŠ” ì„œë²„ íˆ´ì€ ìˆ¨ê²¨ì„œ í˜¼ë€ê³¼ ì—ëŸ¬ë¥¼ ì¤„ì¸ë‹¤.</p>
  </li>
  <li>
    <p>ë¡œì»¬ íˆ´ì€ íŒŒì´ì¬ í•¨ìˆ˜ë¡œ ë°”ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë ˆì´í„´ì‹œê°€ ì ê³ , ê°„ë‹¨í•œ ê²€ì¦Â·í›„ì²˜ë¦¬(ì˜ˆ: ê³„ì‚°ìœ¼ë¡œ sanity-check)ë¥¼ ë¹ ë¥´ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
</ul>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ, ì—ëŸ¬ë¥¼ ë” ì¤„ì´ë ¤ë©´</p>

<ul>
  <li>
    <p>íˆ´ ì„¤ëª…ì— â€œì–¸ì œ ì“°ëŠ”ì§€/ì–¸ì œ ì“°ì§€ ë§ì•„ì•¼ í•˜ëŠ”ì§€â€ë¥¼ í•œ ë¬¸ì¥ì”© ëª…ì‹œí•œë‹¤.</p>
  </li>
  <li>
    <p>ìœ„í—˜ íˆ´ì˜ parametersì— confirm ë¬¸ìì—´(ì˜ˆ: "I understand this deletes data")ì„ requiredë¡œ ì¶”ê°€í•œë‹¤.</p>
  </li>
  <li>
    <p>TOOL_RESULTS í¬ë§·ì„ íŒ€ ê³µí†µ JSON ìŠ¤í‚¤ë§ˆë¡œ ê³ ì •í•´ ëª¨ë¸ì´ ì˜ˆì¸¡ ê°€ëŠ¥í•œ í›„ì† ê³„íšì„ ì„¸ìš°ë„ë¡ í•œë‹¤.</p>
  </li>
  <li>
    <p>ê° ì„œë²„/íˆ´ë³„ íƒ€ì„ì•„ì›ƒÂ·ì¬ì‹œë„Â·ì„œí‚·ë¸Œë ˆì´ì»¤ë¥¼ ê³µí†µ ë¯¸ë“¤ì›¨ì–´ë¡œ ë¬¶ëŠ”ë‹¤.</p>
  </li>
</ul>

<p>ì—¬ê¸°ê¹Œì§€ë©´ ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸ì—ì„œë„ â€œì¼ë°˜+MCP í˜¼í•© íˆ´ì½œâ€ì„ ì•ˆì •ì ìœ¼ë¡œ ëŒë¦´ ìˆ˜ ìˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ëŠ” ë„¤ê°€ ì“°ëŠ” /chat ìŠ¤í™ì— ë§ì¶° CustomLLMClientì˜ ì§ë ¬í™”/ì—­ì§ë ¬í™” ë¶€ë¶„ë§Œ ë¯¸ì„¸ì¡°ì •í•˜ê³ , ì‹¤ì œ ì„œë²„ ë‘ ê°œ(files/db) ìµœì†Œ êµ¬í˜„ìœ¼ë¡œ E2Eë¥¼ í•œ ë²ˆ êµ´ë ¤ë³´ëŠ” ê²ƒì´ë‹¤.</p>

<p class="chat--user">

ì˜¤í˜¸. ë‹¤ìŒì€ ì–´ë ¤ìš´ ë¬¸ì œì•¼. ì´ê±¸ openai agent python sdkì— ë¶™ì¼ ìˆ˜ ìˆì„ê¹Œ?

</p>

<p>ê°€ëŠ¥í•˜ë‹¤. ê²Œë‹¤ê°€ â€œì—¬ëŸ¬ MCP ì„œë²„â€ì™€ â€œì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸â€ë¥¼ ë™ì‹œì— ì“°ëŠ” êµ¬ì„±ì´ OpenAI Agents Python SDKì—ì„œ ì •ì„ìœ¼ë¡œ ì§€ì›ëœë‹¤. ìš”ì ë§Œ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•˜ê³ , ë°”ë¡œ ëŒì•„ê°€ëŠ” ìµœì†Œ ì˜ˆì‹œë¥¼ ì¤€ë‹¤.</p>

<p>í•µì‹¬ ì •ë¦¬</p>

<ol>
  <li>
    <p>Agents SDKëŠ” MCPë¥¼ 4ê°€ì§€ ì „ì†¡ìœ¼ë¡œ ë¶™ì¸ë‹¤: Hosted MCP(Responses APIê°€ ì›ê²©ì„œë²„ë¥¼ ì§ì ‘ í˜¸ì¶œ), Streamable HTTP, HTTP+SSE, stdio(ë¡œì»¬ í”„ë¡œì„¸ìŠ¤). ì„œë²„ ì—¬ëŸ¬ ê°œë¥¼ mcp_servers ë¦¬ìŠ¤íŠ¸ì— ë„£ìœ¼ë©´ í•œ ì—ì´ì „íŠ¸ê°€ ì „ë¶€ë¥¼ ë³¸ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>ëª¨ë¸ì€ OpenAI ëª¨ë¸ ë§ê³ ë„ LiteLLM í™•ì¥ì„ í†µí•´ â€œOpenAI í˜¸í™˜ RESTâ€ë¡œ ë…¸ì¶œëœ ì„ì˜ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ëª¨ë¸ì²˜ëŸ¼ ì“¸ ìˆ˜ ìˆë‹¤. base_urlë§Œ ë„¤ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë°”ê¾¸ë©´ ëœë‹¤. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Hosted MCPë¥¼ ì“°ë©´ OpenAI ì¸í”„ë¼ê°€ ì›ê²© MCP ì„œë²„ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ë¯€ë¡œ íŒŒì´ì¬ ìª½ ì½œë°±ì´ í•„ìš” ì—†ë‹¤(ê³µê°œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì›ê²© ì„œë²„ì— ì í•©). ë°˜ëŒ€ë¡œ ì‚¬ë‚´ë§/ë¡œì»¬ì€ stdioÂ·SSE ë“± â€œì§ì ‘ ë¶™ì´ê¸°â€ê°€ ë§ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Agents SDKì—ëŠ” MCP ì „ìš© í´ë˜ìŠ¤ë“¤ì´ ì´ë¯¸ ë“¤ì–´ìˆë‹¤(MCPServerStdio, MCPServerSse, MCPServerStreamableHttp, HostedMCPTool ë“±). <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub+1</a></p>
  </li>
</ol>

<p>ë¹ ë¥¸ ìŠ¤ìºí´ë”©(íŒŒì´ì¬)<br />
ì„¤ì¹˜<br />
pip install openai-agents mcp</p>

<p>ì˜ˆì‹œ 1) ì»¤ìŠ¤í…€ LLM(base_url) + stdio/SSE MCP ë‹¤ì¤‘ ì„œë²„ í•œ ë²ˆì— ë¶™ì´ê¸°<br />
ì•„ë˜ëŠ” íŒŒì¼ì‹œìŠ¤í…œ MCPë¥¼ ë¡œì»¬(stdio)ë¡œ, ì‚¬ë‚´ìš© ê²€ìƒ‰ MCPë¥¼ SSEë¡œ ë¶™ì´ê³ , ëª¨ë¸ì€ ë„ˆì˜ ì»¤ìŠ¤í…€ /v1 Chat í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì”€.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>  <span class="c1"># ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ìš©
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP ì„œë²„ë“¤ì„ context managerë¡œ ê¸°ë™/ì—°ê²°
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer XYZ</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="c1"># 2) ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸(OpenAI í˜¸í™˜) ëª¨ë¸ë¡œ ì§€ì •
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>                 <span class="c1"># ì—”ì§„/ì´ë¦„
</span>            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>     <span class="c1"># ë„¤ ì—”ë“œí¬ì¸íŠ¸
</span>            <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">sk-your-key</span><span class="sh">"</span><span class="p">,</span>                   <span class="c1"># í•„ìš”ì‹œ
</span>        <span class="p">)</span>

        <span class="c1"># 3) ì—ì´ì „íŠ¸ êµ¬ì„±: ì—¬ëŸ¬ MCP ì„œë²„ë¥¼ í•œ ë²ˆì— ë…¸ì¶œ
</span>        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Orchestrator</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP íˆ´ì„ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•˜ê³ , í•„ìš”í•  ë•Œë§Œ í˜¸ì¶œí•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># í•„ìš” ì‹œ "required"ë¡œ ê°•ì œ
</span>        <span class="p">)</span>

        <span class="c1"># 4) ì‹¤í–‰
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data í´ë”ì˜ CSVë¥¼ ì½ê³ , search ì„œë²„ë¡œ ê´€ë ¨ ë¬¸ì„œ ì°¾ì•„ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì˜ˆì‹œ 2) Hosted MCPë¥¼ ì„ëŠ” ë³€í˜•<br />
ì›ê²©ì— ê³µê°œëœ MCP ì„œë²„ëŠ” HostedMCPTool í•˜ë‚˜ë§Œ toolsì— ë„£ìœ¼ë©´ ëª¨ë¸ì´ OpenAI ì¸í”„ë¼ì—ì„œ ì§ì ‘ ëª©ë¡ì¡°íšŒ/í˜¸ì¶œê¹Œì§€ í•œë‹¤. íŒŒì´ì¬ ìª½ ì½œë°±ì´ ê±°ì˜ ì—†ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">HostedMCPTool</span>

<span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">HostedMCPUser</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="nc">HostedMCPTool</span><span class="p">(</span><span class="n">tool_config</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_label</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gitmcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://gitmcp.io/openai/codex</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">require_approval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">})],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì´ ì €ì¥ì†Œì˜ ì£¼ìš” ì–¸ì–´ë¥¼ ì•Œë ¤ì¤˜</span><span class="sh">"</span><span class="p">).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>ìœ„ ë‘ ë°©ì‹ì€ ê³µì‹ ë¬¸ì„œì˜ ì‚¬ìš©ë²•ê³¼ ë™ì¼í•œ íë¦„ì´ë‹¤. Hosted MCP, stdio/SSE/HTTP ì„œë²„, íˆ´ í•„í„°ë§, ìŠ¹ì¸ í›…ê¹Œì§€ í¬í•¨ëœ ê°€ì´ë“œë¥¼ ì°¸ê³ í•´ ì„¸ë¶€ì˜µì…˜ì„ ë§ì¶”ë©´ ëœë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>

<p>íˆ´ ì†Œì¶œ ì „ëµ(ì˜¤ë¥˜ ì¤„ì´ëŠ” íŒ)</p>

<ol>
  <li>
    <p>íˆ´ í•„í„°ë§: ì„œë²„ ìƒì„±ìì— tool_filterë¥¼ ê±¸ê±°ë‚˜ ì •ì /ë™ì  í•„í„°ë¥¼ ì¨ì„œ í„´ë³„ë¡œ í•„ìš”í•œ íˆ´ë§Œ ë…¸ì¶œí•˜ë¼. SDKê°€ ë„ìš°ë¯¸ë¥¼ ì œê³µí•œë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>ìœ„í—˜ íˆ´ ìŠ¹ì¸: HostedMCPToolì€ require_approval ë° on_approval_request ì½œë°±ìœ¼ë¡œ ë¯¼ê° ì‘ì—…ì„ ìŠ¹ì¸ í”Œë¡œë¡œ ê°ì‹¼ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>ìºì‹±ê³¼ ì¬ì‹œë„: cache_tools_list, max_retry_attempts ë“± ì˜µì…˜ìœ¼ë¡œ ì§€ì—°ê³¼ ì‹¤íŒ¨ í™•ë¥ ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
</ol>

<p>í•œ ì¤„ ê²°ë¡ <br />
OpenAI Agents Python SDKì— ë„¤ê°€ ë§Œë“  â€œë©€í‹° MCP + ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸â€ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì¼ ìˆ˜ ìˆë‹¤. ëª¨ë¸ì€ LiteLLMModelë¡œ ì»¤ìŠ¤í…€ RESTë¥¼ ì“°ê³ , MCPëŠ” mcp_serversì— ì—¬ëŸ¬ ê°œë¥¼ ì—´ê±°í•˜ê±°ë‚˜ HostedMCPToolì„ ë³‘ìš©í•˜ë©´ ëœë‹¤. í•„ìš”í•˜ë©´ ë„ˆì˜ ì—”ë“œí¬ì¸íŠ¸ ìŠ¤í™ì— ë§ì¶° ëª¨ë¸ ì–´ëŒ‘í„°ë¥¼ ë” ì´˜ì´˜í•˜ê²Œ ì„¤ì •í•˜ëŠ” ì½”ë“œë„ ë§Œë“¤ì–´ì£¼ê² ë‹¤. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub+2</a></p>

<p class="chat--user">

ì•„ë‹ˆ ë‚œ ë„ˆê°€ ë§Œë“  ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì“°ê³  ì‹¶ì–´. ì™œëƒë©´ ì´ë ‡ê²Œ ë§Œë“  ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‹¤ë¥¸ Chat ì—ë„ ì“°ê³  ì‹¶ê±°ë“ . Agentë§Œì„ ìœ„í•œ ë‹¤ë¥¸ ì½”ë“œê°€ ë¶„ê¸° ë˜ëŠ” ê²ƒì´ ì‹«ì–´. Toolë§Œ ì…ë ¥í•´ì„œ ë™ì‘í•˜ê²Œ í•˜ëŠ” ë°©ë²• ì—†ì–´?

</p>

<p>ì¢‹ì•„. â€œAgent ì „ìš© ë¶„ê¸° ì—†ì´â€ ë„ˆê°€ ë§Œë“  ì¸í„°í˜ì´ìŠ¤ë¥¼ ì–´ë–¤ Chatì—ë„ ì¬ì‚¬ìš©í•˜ë ¤ë©´, ì…ë ¥ì€ ì˜¤ì§ íˆ´(=í”„ë¡œë°”ì´ë”)ê³¼ LLM ì—”ë“œí¬ì¸íŠ¸ë§Œ ì£¼ê³  ëŒì•„ê°€ëŠ” ì–‡ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ í•„ìš”í•˜ë‹¤. ì•„ë˜ëŠ” ê·¸ ëª©ì ì— ë§ì¶˜ ë‹¨ì¼ íŒŒì¼ ìŠ¤ìºí´ë”©ì´ë‹¤. í•µì‹¬ì€ ì„¸ ê°€ì§€ ì¸í„°í˜ì´ìŠ¤ë‹¤.</p>

<ol>
  <li>
    <p>ChatBackend: ì–´ë–¤ ì±„íŒ… ëª¨ë¸ì´ë“  ë¶™ì¼ ìˆ˜ ìˆëŠ” ë°±ì—”ë“œ ì–´ëŒ‘í„°.</p>
  </li>
  <li>
    <p>ToolProvider: íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ ë…¸ì¶œí•˜ê³  í˜¸ì¶œì„ ì²˜ë¦¬í•˜ëŠ” í‘œì¤€ ì¸í„°í˜ì´ìŠ¤.</p>
  </li>
  <li>
    <p>Orchestrator: messages + toolsë§Œìœ¼ë¡œ ë£¨í”„ë¥¼ ëŒë¦°ë‹¤. ì–´ë–¤ ì—ì´ì „íŠ¸ SDK ë¶„ê¸°ë„ ì—†ë‹¤.</p>
  </li>
</ol>

<p>ì„¤ì¹˜<br />
pip install mcp requests pydantic orjson</p>

<p>tools_only.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== ê³µí†µ ë°ì´í„° ëª¨ë¸ ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI/í•¨ìˆ˜ì½œ í˜¸í™˜ í¬ë§·ìœ¼ë¡œ í†µì¼
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(str or dict)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend ì¸í„°í˜ì´ìŠ¤ ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    OpenAI Chat Completions í˜¸í™˜(ë˜ëŠ” ìœ ì‚¬) ì—”ë“œí¬ì¸íŠ¸ìš© ë°±ì—”ë“œ.
    /v1/chat/completions ë˜ëŠ” /chat ê°™ì€ ê³³ì— ë§ì¶° ìµœì†Œí•œì˜ ì–´ëŒ‘í„°ë§Œ ì œê³µ.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>  <span class="c1"># "/v1/chat/completions"ë¡œ ë°”ê¿”ë„ ë¨
</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="c1"># ì„œë²„ ê·œê²©ì— ë§ê²Œ í•„ìš”í•œ í‚¤ë§Œ ë‹´ëŠ”ë‹¤. í•„ìš”ì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì •.
</span>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="c1"># dataë¥¼ ChatResponseë¡œ ë§¤í•‘; ë„ˆì˜ ì—”ë“œí¬ì¸íŠ¸ ê·œê²©ì— ë§ê²Œ ì—¬ê¸°ë§Œ ì¡°ì •í•˜ë©´ ëœë‹¤.
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 2) ToolProvider ì¸í„°í˜ì´ìŠ¤ ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ToolProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span> <span class="bp">...</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>

<span class="c1"># ---- 2-1) MCP í”„ë¡œë°”ì´ë” (ì—¬ëŸ¬ ì„œë²„ í¬í•¨) ----
# mcp ì„¤ì¹˜ í•„ìš”
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="c1"># ë™ê¸° ì¸í„°í˜ì´ìŠ¤ ìš”êµ¬ ë•Œë¬¸ì— ìºì‹œ ê¸°ë°˜. ìµœì´ˆ í˜¸ì¶œ ì „ì— warmup()ì„ í˜¸ì¶œí•˜ê±°ë‚˜,
</span>        <span class="c1"># Orchestratorê°€ ì‘ë‹µ ì „ await ensure_ready()ë¥¼ í•œ ë²ˆ ìˆ˜í–‰.
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await provider.ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="c1"># list_toolsëŠ” asyncë¼ ì—¬ê¸°ì„œ ë¯¸ë¦¬ ëª¨ì€ë‹¤.
</span>        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># tool_nameì€ "server:tool"ì´ì–´ì•¼ í•¨
</span>        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server namespace: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ---- 2-2) ë¡œì»¬ íˆ´ í”„ë¡œë°”ì´ë”(ì„ íƒ) ----
</span>
<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚°. ì…ë ¥: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                    <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (ë„êµ¬ë§Œ ì…ë ¥í•´ì„œ ë™ì‘) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ëª©ì : íˆ´ë§Œ ì…ë ¥í•´ì„œ ë™ì‘. ì–´ë–¤ Chat(ë°±ì—”ë“œ)ì—ë„ ì¬ì‚¬ìš©.
    - providers: ToolProviderë“¤ì˜ ë¦¬ìŠ¤íŠ¸
    - backend: ChatBackend êµ¬í˜„ì²´ 1ê°œ
    - expose_fn: ì„ íƒì ìœ¼ë¡œ </span><span class="sh">'</span><span class="s">íˆ´ ì†Œì¶œ</span><span class="sh">'</span><span class="s"> ì „ëµì„ ì£¼ì… (ê¸°ë³¸ê°’: ì „ë¶€ ë…¸ì¶œ)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolProvider</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># MCPProvider ê°™ì€ async ì¤€ë¹„ê°€ í•„ìš”í•œ í”„ë¡œë°”ì´ë”ë¥¼ ì›Œë°ì—…
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># ê° í”„ë¡œë°”ì´ë”ê°€ ì±…ì„ì§€ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ë¼ìš°íŒ…
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># ë¹ ë¥¸ íŒë³„: MCPëŠ” "server:" ë„¤ì„ìŠ¤í˜ì´ìŠ¤, ë¡œì»¬ì€ "local." ê°™ì€ ê·œì¹™ ì¶”ì²œ
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">):</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>  <span class="c1"># server:tool
</span>                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># ë§ˆì§€ë§‰ fallback: ëª¨ë“  providerì— ì‹œë„
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider could handle tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="c1"># íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ ìˆ˜ì§‘í•˜ê³  ì†Œì¶œ ì „ëµ ì ìš©
</span>            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="c1"># ëª¨ë¸ì—ê²Œ ë„êµ¬ê²°ê³¼ë¥¼ ì¼ê´„ ì¬ì£¼ì…
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== ì‹¤í–‰ ì˜ˆì‹œ ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP ì„œë²„ë“¤: í•„ìš” ì„œë²„ë§Œ ë‚˜ì—´
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>

    <span class="c1"># 2) ë¡œì»¬ íˆ´(ì„ íƒ)
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># 3) ì–´ë–¤ Chatì´ë“  ë¶™ì¼ ë°±ì—”ë“œ. base_urlê³¼ pathë§Œ ë§ì¶”ë©´ ë.
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span>               <span class="c1"># í•„ìš”ì— ë”°ë¼ "/v1/chat/completions" ë“±ìœ¼ë¡œ ë³€ê²½
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°: ì…ë ¥ì€ â€œíˆ´(í”„ë¡œë°”ì´ë”)â€ë¿
</span>    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="c1"># ê°„ë‹¨ ì†Œì¶œ: íŒŒì¼/SQL ê´€ë ¨ ë‹¨ì–´ê°€ ì—†ìœ¼ë©´ MCPë¥¼ ìˆ¨ê¸°ê³  ë¡œì»¬ë§Œ ë…¸ì¶œ
</span>        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">íŒŒì¼</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ì¿¼ë¦¬</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSVë¥¼ ì½ê³  í•©ê³„ë¥¼ ê³„ì‚°í•œ ë’¤ ìˆ˜ì¹˜ê°€ ë§ëŠ”ì§€ ê³„ì‚°ê¸°ë¡œ ê²€ì¦í•´ì¤˜. íŒŒì¼ì€ ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">ë„ˆëŠ” MCP íˆ´ì„ ì‹ ì¤‘íˆ ì‚¬ìš©í•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ìµœì¢… ë¡œê·¸ ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì„¤ëª…ê³¼ ì‚¬ìš©ë²• ìš”ì•½<br />
ì…ë ¥ì€ íˆ´(í”„ë¡œë°”ì´ë”)ë§Œ ë„˜ê¸´ë‹¤. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ëŠ” íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ í•©ì¹˜ê³ , LLM ì‘ë‹µì˜ tool_callsë¥¼ ë°›ì•„ ì ì ˆí•œ í”„ë¡œë°”ì´ë”ë¡œ ë¼ìš°íŒ…í•œë‹¤. íŠ¹ì • ì—ì´ì „íŠ¸ SDK ë¶„ê¸°ê°€ ì „í˜€ ì—†ë‹¤. ë‹¤ë¥¸ Chat ë°±ì—”ë“œë¡œ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ OpenAICompatibleBackendë§Œ êµì²´í•˜ê±°ë‚˜ send ë©”ì†Œë“œê°€ ë™ì¼í•œ ì‹œê·¸ë‹ˆì²˜ë¥¼ ê°€ì§€ëŠ” ìƒˆ í´ë˜ìŠ¤ë¥¼ í•˜ë‚˜ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p>ìš´ì˜ íŒ<br />
íˆ´ ì†Œì¶œ í•¨ìˆ˜(expose_fn)ë¡œ í„´ë³„ í•„í„°ë§ì„ ê¼­ ë„£ì. ë‹¨ìˆœ í‚¤ì›Œë“œë§Œìœ¼ë¡œë„ ì„ íƒ ì˜¤ë¥˜ì™€ ë¶ˆí•„ìš” í˜¸ì¶œì´ í¬ê²Œ ì¤€ë‹¤.<br />
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì¼ê´€ë˜ê²Œ ìœ ì§€í•˜ì. MCPëŠ” server:tool, ë¡œì»¬ì€ local.*ì²˜ëŸ¼ êµ¬ë¶„í•˜ë©´ ì¶©ëŒì´ ì—†ë‹¤.<br />
ê³ ìœ„í—˜ íˆ´ì€ parametersì— dry_run, confirm ë¬¸ìì—´ ê°™ì€ ì œì•½ì„ ë„£ì–´ì•¼ í•œë‹¤.<br />
ëŒ€ìš©ëŸ‰ ê²°ê³¼ëŠ” MCP ì„œë²„ê°€ íŒŒì¼ í•¸ë“¤(ë¦¬ì†ŒìŠ¤)ë¡œ ë°˜í™˜í•˜ê³ , ëª¨ë¸ì—ëŠ” ìš”ì•½/ë©”íƒ€ë°ì´í„°ë§Œ ì¬ì£¼ì…í•´ í† í°ì„ ì•„ë¼ì.</p>

<p>ì´ êµ¬ì¡°ë©´ ê°™ì€ Orchestratorë¥¼ ê·¸ëŒ€ë¡œ ë‘ê³ , ì–´ë–¤ Chat UI/ì—”ì§„ì—ë„ ì‰½ê²Œ ì´ì‹í•  ìˆ˜ ìˆë‹¤. í•„ìš”í•˜ë©´ ë„¤ ì—”ë“œí¬ì¸íŠ¸ì˜ ì •í™•í•œ JSON ê·œê²©ì„ ì•Œë ¤ì¤˜. OpenAICompatibleBackendì˜ ë§¤í•‘ë§Œ 10ì¤„ì¯¤ ì†ë³´ë©´ ë°”ë¡œ ë¬¼ë¦´ ìˆ˜ ìˆê²Œ ë§ì¶°ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì´ê±´ ë˜ openai agentëŠ” ì•ˆ ì“°ëŠ” ê²ƒ ê°™ì€ë°

</p>

<p>ë§ì•„, ë°©ê¸ˆ ì¤€ ìŠ¤ìºí´ë”©ì€ â€œì˜¤í”ˆAI Agents SDKâ€ë¥¼ ì“°ì§€ ì•ŠëŠ” ìˆœìˆ˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ì˜€ì§€. ë„ˆê°€ ì›í•˜ëŠ” ê±´ ê·¸ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œ, ë°±ì—”ë“œë§Œ ê°ˆì•„ë¼ì›Œ â€œOpenAI Agents Python SDKâ€ë¥¼ LLM ë°±ì—”ë“œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê²ƒ. ì•„ë˜ì²˜ëŸ¼ ë°±ì—”ë“œ ì–´ëŒ‘í„° í•˜ë‚˜ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°Â·íˆ´ í”„ë¡œë°”ì´ë”Â·ë¼ìš°íŒ…ì€ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©í•˜ê³ , ì—ì´ì „íŠ¸ SDKëŠ” ë‹¨ì§€ â€œí…ìŠ¤íŠ¸+íˆ´ì½œ JSONì„ ë±‰ëŠ” ëª¨ë¸ ë°±ì—”ë“œâ€ë¡œë§Œ ì“´ë‹¤. ì¦‰, Agents SDKì—ê²Œ MCP ì‹¤í–‰ì„ ë§¡ê¸°ì§€ ì•Šê³ , ìš°ë¦¬ê°€ ë§Œë“  ë¼ìš°í„°ê°€ ê³„ì† MCPë¥¼ í˜¸ì¶œí•œë‹¤.</p>

<p>í•µì‹¬ ì•„ì´ë””ì–´<br />
ì—ì´ì „íŠ¸ SDKì—ê²Œ ë„êµ¬ë¥¼ ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤(tool_choice ì—†ì´). ëŒ€ì‹  ìš°ë¦¬ê°€ ë„˜ê¸´ íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ í”„ë¡¬í”„íŠ¸ì— JSONìœ¼ë¡œ ì£¼ê³ , ì—ì´ì „íŠ¸ê°€ ë°˜ë“œì‹œ ë‹¤ìŒ í¬ë§·ì˜ JSONë§Œ ì¶œë ¥í•˜ë„ë¡ ê°•ì œí•œë‹¤. ê·¸ëŸ¬ë©´ ìš°ë¦¬ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ ê·¸ JSONì„ íŒŒì‹±í•´ ì‹¤ì œ MCP/ë¡œì»¬ íˆ´ë¡œ ë¼ìš°íŒ…í•œë‹¤. ì´ëŸ¬ë©´ Agent ì „ìš© ì½”ë“œ ë¶„ê¸°ê°€ ìƒê¸°ì§€ ì•ŠëŠ”ë‹¤. ë°±ì—”ë“œë¥¼ ë°”ê¿” ë¼ìš°ëŠ” ê²ƒë§Œìœ¼ë¡œ ê°™ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ ê·¸ëŒ€ë¡œ ë™ì‘í•œë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install openai-agents mcp requests pydantic orjson</p>

<p>agents_backend.py<br />
ì•„ë˜ íŒŒì¼ì€ ë„¤ê°€ ì´ì „ì— ë°›ì€ tools_only.pyì˜ êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ë”°ë¥´ë˜, ChatBackend êµ¬í˜„ì²´ë¡œ AgentsBackendë¥¼ ì¶”ê°€í•œ ë²„ì „ì´ë‹¤. ë‚˜ë¨¸ì§€ëŠ” ë™ì¼í•˜ë‹ˆ ì´ íŒŒì¼ í•˜ë‚˜ë¡œ êµì²´í•´ë„ ë˜ê³ , í•„ìš”í•œ ë¶€ë¶„ë§Œ ê°€ì ¸ë‹¤ ì¨ë„ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== ê³µí†µ ë°ì´í„° ëª¨ë¸ ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {"name": ..., "arguments": str|dict}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend ì¸í„°í˜ì´ìŠ¤ ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 1-b) OpenAI Agents SDK ë°±ì—”ë“œ ì–´ëŒ‘í„° ==========
</span>
<span class="c1"># Agents SDKëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë„êµ¬ ì‹¤í–‰ê¹Œì§€ ë§¡ê¸¸ ìˆ˜ ìˆì§€ë§Œ,
# ì—¬ê¸°ì„œëŠ” "í…ìŠ¤íŠ¸+íˆ´ì½œ JSONì„ ìƒì„±í•˜ëŠ” ëª¨ë¸"ë¡œë§Œ ì‚¬ìš©í•œë‹¤.
# í”„ë¡¬í”„íŠ¸ ê°•ì œ í˜•ì‹ìœ¼ë¡œ tool_callsë¥¼ JSONìœ¼ë¡œ ì¶œë ¥í•˜ê²Œ ë§Œë“ ë‹¤.
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># LiteLLM ëª¨ë¸ í™•ì¥ì„ ì‚¬ìš©í•´ ì„ì˜ì˜ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë¶™ì¼ ìˆ˜ ìˆë‹¤.
</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># ë„êµ¬ëŠ” ì—ì´ì „íŠ¸ì— ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤. ìš°ë¦¬ê°€ ì§ì ‘ ë¼ìš°íŒ…í•  ê²ƒì´ê¸° ë•Œë¬¸.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ì ˆëŒ€ ìë™ ë„êµ¬ í˜¸ì¶œ ê¸ˆì§€
</span>        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># íˆ´ ëª©ë¡ì„ JSONìœ¼ë¡œ ì£¼ê³ , ì •í™•í•œ ì¶œë ¥ í¬ë§·ì„ ê°•ì œí•œë‹¤.
</span>        <span class="n">tools_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span>
            <span class="n">tools_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tools_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_prompt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">ìœ„ëŠ” ëŒ€í™” ë‚´ì—­ì´ë‹¤. ì•„ë˜ëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ëª©ë¡ì´ë‹¤.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">TOOLS_JSON=</span><span class="si">{</span><span class="n">tools_json</span><span class="si">}</span><span class="se">\n\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">ë°˜ë“œì‹œ ë‹¤ìŒ JSON í¬ë§·ìœ¼ë¡œë§Œ ë‹µí•˜ë¼. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ë§ë¼.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">{</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;ìµœì¢… ìì—°ì–´ ì‘ë‹µ(ìˆìœ¼ë©´)&gt;</span><span class="sh">"</span><span class="s"> ,</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-1</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}},</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-2</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}}</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">"</span><span class="s">  ]</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">}</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">ì—¬ëŸ¬ ë„êµ¬ê°€ í•„ìš”í•˜ë©´ tool_calls ë°°ì—´ì— ìˆœì„œëŒ€ë¡œ ë„£ì–´ë¼. ë„êµ¬ê°€ í•„ìš” ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ì„ ë„£ì–´ë¼.</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">history</span> <span class="o">+</span> <span class="p">[</span><span class="sh">""</span><span class="p">,</span> <span class="n">guide</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_build_prompt</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
        <span class="c1"># Developer ë©”ì‹œì§€ì— ê°•ì œ í¬ë§· ê°€ì´ë“œë¥¼ ë„£ì–´ JSONë§Œ ì¶œë ¥í•˜ê²Œ í•œë‹¤.
</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">JSON í¬ë§·ë§Œ ì¶œë ¥</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, ì¼ë°˜ í…ìŠ¤íŠ¸ë§Œ ì±„ì›Œì„œ ë°˜í™˜
</span>            <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">tool_calls</span><span class="o">=</span><span class="p">[])</span>
        <span class="c1"># í‘œì¤€ ChatResponseë¡œ ë§µ
</span>        <span class="n">tc_raw</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># argumentsê°€ dictê°€ ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ í†µê³¼(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ìª½ì—ì„œ ì •ê·œí™”)
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span><span class="nc">ToolCall</span><span class="p">(</span><span class="o">**</span><span class="n">tc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tc_raw</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tc_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

<span class="c1"># ========== 2) ToolProvider (MCP/ë¡œì»¬) ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                <span class="p">}))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚°. ì…ë ¥ {expr:string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">})]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (ë³€ê²½ ì—†ìŒ) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‹¨ì„œ
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LocalToolsProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># í´ë°±
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider can handle </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== ì‹¤í–‰ ì˜ˆì‹œ ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># MCP ì„œë²„ ì˜ˆì‹œ
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>
    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># A) OpenAI Agents SDKë¥¼ ë°±ì—”ë“œë¡œ ì‚¬ìš©
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">AgentsBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸(LiteLLMë„ ê°€ëŠ¥)
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>                <span class="c1"># í˜¹ì€ ë„¤ ì„ì˜ ëª¨ë¸ëª…
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>

    <span class="c1"># B) í•„ìš”í•˜ë©´ ê¸°ì¡´ OpenAICompatibleBackendë¡œ êµì²´ ê°€ëŠ¥
</span>    <span class="c1"># backend = OpenAICompatibleBackend(base_url="http://localhost:8000", path="/chat", model="my-model")
</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">íŒŒì¼</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ì¿¼ë¦¬</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSVë¥¼ ì½ê³  í•©ê³„ë¥¼ êµ¬í•œ ë’¤ ê³„ì‚°ê¸°ë¡œ ìˆ˜ì¹˜ ê²€ì¦ê¹Œì§€ í•´ì¤˜. íŒŒì¼ì€ ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">ë„ˆëŠ” MCP íˆ´ì„ ì‹ ì¤‘íˆ ì‚¬ìš©í•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ìµœì¢… ë¡œê·¸ ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì‘ë™ ë°©ì‹ ì •ë¦¬<br />
1ë‹¨ê³„. AgentsBackendëŠ” OpenAI Agents Python SDKì˜ Agentë¥¼ ëª¨ë¸ ë°±ì—”ë“œë¡œë§Œ ì“´ë‹¤. ë„êµ¬ëŠ” ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤.<br />
2ë‹¨ê³„. ìš°ë¦¬ê°€ ë…¸ì¶œí•  íˆ´ ëª©ë¡ì„ JSONìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ì— ë„£ê³ , ì—ì´ì „íŠ¸ê°€ contentì™€ tool_calls ë°°ì—´ì„ ì •í™•íˆ ë‹´ì€ JSONë§Œ ì¶œë ¥í•˜ê²Œ ê°•ì œí•œë‹¤.<br />
3ë‹¨ê³„. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ëŠ” ê·¸ tool_callsë¥¼ ë°›ì•„ ê¸°ì¡´ê³¼ ë˜‘ê°™ì´ MCP/ë¡œì»¬ íˆ´ë¡œ ë¼ìš°íŒ…í•œë‹¤.<br />
4ë‹¨ê³„. ì¦‰, ê°™ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì½”ë“œë¥¼ ìœ ì§€í•œ ì±„, ë°±ì—”ë“œë§Œ ê°ˆì•„ë¼ì›Œ Agents SDK ë˜ëŠ” ì¼ë°˜ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ììœ ë¡­ê²Œ ì„ íƒí•  ìˆ˜ ìˆë‹¤.</p>

<p>ì£¼ì˜ì ê³¼ íŒ<br />
JSON ê°•ì œ í”„ë¡¬í”„íŠ¸ê°€ ì¤‘ìš”í•˜ë‹¤. ëª¨ë¸ì´ ì¥ì‹ í…ìŠ¤íŠ¸ë¥¼ ì„ì§€ ì•Šë„ë¡ developer_instructionsë¡œ â€œJSONë§Œ ì¶œë ¥â€ì„ ë°˜ë³µí•´ì„œ ê³ ì •í•˜ë¼.<br />
íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ì—„ê²©í•˜ê²Œ. required, enum, formatì„ ì¶©ë¶„íˆ ë„£ìœ¼ë©´ arguments íŒŒì‹± ì‹¤íŒ¨ê°€ ì¤„ì–´ë“ ë‹¤.<br />
ì„±ëŠ¥. AgentsBackendëŠ” Runner.run_syncë¥¼ í•œ í„´ë§ˆë‹¤ í˜¸ì¶œí•œë‹¤. ëŒ€í™” ê¸¸ì–´ì§€ë©´ í† í°Â·ì‹œê°„ì´ ëŠ˜ì–´ë‚˜ë¯€ë¡œ expose_fnìœ¼ë¡œ íˆ´ì„ í„´ë³„ë¡œ ì†Œì¶œí•˜ê³ , ê²°ê³¼ëŠ” ìš”ì•½í•´ì„œ ì¬ì£¼ì…í•˜ë¼.<br />
ëŒ€ì²´. ì—ì´ì „íŠ¸ SDKì˜ ëª¨ë¸ ëŒ€ì‹  OpenAICompatibleBackendë¡œ ë°”ê¾¸ë©´ ë°”ë¡œ ë™ì¼ ì½”ë“œê°€ ë‹¤ë¥¸ Chatì—ë„ ë¶™ëŠ”ë‹¤. ëª©ì ì— ë§ì¶° ë°±ì—”ë“œë§Œ êµì²´í•˜ë©´ ëœë‹¤.</p>

<p>ì´ë ‡ê²Œ í•˜ë©´ ì—ì´ì „íŠ¸ SDKë¥¼ â€œë°±ì—”ë“œ ëª¨ë¸â€ë¡œë§Œ ì“°ë©´ì„œ, ë„ˆì˜ íˆ´ ì¤‘ì‹¬ ì¸í„°í˜ì´ìŠ¤ì™€ ë¼ìš°í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ëœë‹¤. ë‹¤ìŒì—ëŠ” ë„¤ ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ì˜ ì¶œë ¥ JSON ì˜ˆì‹œë¥¼ ì•Œë ¤ì¤˜. AgentsBackendì˜ JSON íŒŒì‹± ë¶€ë¶„ì„ ê±°ê¸°ì— ë§ì¶° 2~3ì¤„ë§Œ ì¡°ì •í•˜ë©´ ëœë‹¤.</p>

<p class="chat--user">

ì•„ ë³µì¡í•´ ê·¸ëƒ¥ function_toolë¡œ ê° toolì„ ë“±ë¡í•˜ë©´ ì–´ë–¨ê¹Œ

</p>

<p>ì¢‹ì§€. â€œê·¸ëƒ¥ function_toolë¡œ ê° íˆ´ì„ ë“±ë¡â€í•˜ëŠ” ê°€ì¥ ê¹”ë”í•œ ë°©ë²•ì€, MCP ì„œë²„ë“¤ì—ì„œ list_toolsë¥¼ ê¸ì–´ì™€ì„œ ê°ê°ì„ Agents SDKì˜ FunctionToolë¡œ ë™ì ìœ¼ë¡œ ë˜í•‘í•˜ëŠ” ê±°ì•¼. ê·¸ëŸ¬ë©´ Agent ìª½ì€ ì „í˜€ ì»¤ìŠ¤í…€ ë¶„ê¸° ì—†ì´ í‘œì¤€ íˆ´ë§Œ ë³¸ë‹¤. ì•„ë˜ ì½”ë“œê°€ ë°”ë¡œ ê·¸ íŒ¨í„´ì´ê³ , ì»¤ìŠ¤í…€ LLMë„ LiteLLM ëª¨ë¸ ì–´ëŒ‘í„°ë¡œ ë¶™ì¸ë‹¤.</p>

<p>í•µì‹¬ ê°œë… í•œ ì¤„ ìš”ì•½<br />
MCPì˜ tool ë©”íƒ€ë°ì´í„°(name, description, input_schema)ë¥¼ Agents SDKì˜ FunctionTool(name, description, params_json_schema, on_invoke_tool)ì— ê·¸ëŒ€ë¡œ ë§¤í•‘í•˜ê³ , on_invoke_toolì—ì„œ í•´ë‹¹ MCP ì„¸ì…˜ìœ¼ë¡œ call_toolë§Œ ë¼ìš°íŒ…í•œë‹¤. FunctionTool/<code class="language-plaintext highlighter-rouge">@function_tool</code> ì‚¬ìš©ë²•ê³¼ JSON ìŠ¤í‚¤ë§ˆ í¬ë§·ì€ Agents ë¬¸ì„œ ê·¸ëŒ€ë¡œë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a> ë˜í•œ ëª¨ë¸ì€ LiteLLMModelë¡œ ë„ˆì˜ ë² ì´ìŠ¤ URLì„ ëª¨ë¸ì²˜ëŸ¼ ì“¸ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>ì„¤ì¹˜<br />
pip install "openai-agents[litellm]" mcp pydantic orjson</p>

<p>mcp_as_function_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤(íˆ´ ì´ë¦„ prefixì— ë“¤ì–´ê°)
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cdfg</span><span class="p">.</span><span class="n">name</span> <span class="nf">if </span><span class="p">(</span><span class="n">cdfg</span> <span class="p">:</span><span class="o">=</span> <span class="n">cfg</span><span class="p">)</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    MCP tool -&gt; Agents FunctionTool
    tool_meta: has .name, .description, .input_schema (JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Agents SDKê°€ args_jsonì„ JSON ë¬¸ìì—´ë¡œ ë„˜ê²¨ì¤€ë‹¤ â†’ dictë¡œ íŒŒì‹± í›„ MCP í˜¸ì¶œ
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># ëª¨ë¸ì´ í˜•ì‹ ì–´ê¸°ë©´ rawë¡œ ì „ë‹¬(ì„œë²„ ìª½ ê²€ì¦ì— ë§¡ê¹€)
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="c1"># MCP í‘œì¤€ contentë¥¼ í…ìŠ¤íŠ¸/JSON ìœ„ì£¼ë¡œ ì •ê·œí™”
</span>        <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="c1"># ì—ì´ì „íŠ¸ì—ê²ŒëŠ” ë¬¸ìì—´ì„ ë°˜í™˜í•˜ë¯€ë¡œ JSON ë¬¸ìì—´ë¡œ ë¬¶ì–´ì¤€ë‹¤
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="c1"># FunctionToolì€ name/description/params_json_schema/on_invoke_toolë§Œ ì£¼ë©´ ëœë‹¤.
</span>    <span class="c1"># ê³µì‹ ë¬¸ì„œì˜ "Custom function tools" ì„¹ì…˜ê³¼ ë™ì¼í•œ ìƒì„±ì. :contentReference[oaicite:2]{index=2}
</span>    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) ì—¬ëŸ¬ MCP ì„œë²„ë¥¼ ì„ ì–¸
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>        <span class="c1"># MCPServerCfg(name="db", kind="stdio", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">]</span>

    <span class="c1"># 2) MCPì˜ ëª¨ë“  íˆ´ì„ FunctionToolë¡œ ë“±ë¡
</span>    <span class="n">mcp_function_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>

    <span class="c1"># 3) ì»¤ìŠ¤í…€ LLM(ë„ˆì˜ ì—”ë“œí¬ì¸íŠ¸)ì„ LiteLLM ëª¨ë¸ë¡œ ì‚¬ìš©
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># ë„¤ ì—”ë“œí¬ì¸íŠ¸ë¥¼ OpenAI í˜¸í™˜ìœ¼ë¡œ ë…¸ì¶œí–ˆë‹¤ëŠ” ê°€ì •
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) ì—ì´ì „íŠ¸ êµ¬ì„±: â€œfunction_toolë¡œ ë“±ë¡ëœ MCP íˆ´â€ë§Œ ì „ë‹¬
</span>    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP-through-FunctionTools</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_function_tools</span><span class="p">,</span>  <span class="c1"># í¬ì¸íŠ¸: ì˜¤ì§ function_toolë§Œ
</span>    <span class="p">)</span>

    <span class="c1"># 5) ì‹¤í–‰
</span>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data í´ë”ì—ì„œ sales.csvë¥¼ ì½ê³  í•©ê³„ ê³„ì‚°í•´ì¤˜. í•„ìš”í•˜ë©´ ìŠ¤ìŠ¤ë¡œ ì ì ˆí•œ MCP íˆ´ì„ ê³¨ë¼ ì¨.</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì–´ë–»ê²Œ ëŒì•„ê°€ë‚˜<br />
1ë‹¨ê³„. ì—¬ëŸ¬ MCP ì„œë²„ì— ì—°ê²°í•˜ê³  list_toolsë¡œ ë©”íƒ€ë¥¼ ê¸ëŠ”ë‹¤.<br />
2ë‹¨ê³„. ê° MCP íˆ´ì„ FunctionToolë¡œ ê°ì‹¼ë‹¤. nameì€ server:toolë¡œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤, descriptionê³¼ JSON ìŠ¤í‚¤ë§ˆëŠ” MCPì˜ description/input_schemaë¥¼ ê·¸ëŒ€ë¡œ ì“´ë‹¤. ì´ ë§¤í•‘ì€ Agents ë¬¸ì„œì˜ Function tools/Custom function tools ê·œì•½ì— ë§ë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a><br />
3ë‹¨ê³„. on_invoke_toolì—ì„œ session.call_toolë§Œ í˜¸ì¶œí•´ ê²°ê³¼ë¥¼ ë¬¸ìì—´(JSON)ë¡œ ë°˜í™˜í•œë‹¤.<br />
4ë‹¨ê³„. AgentëŠ” â€œfunction_toolë¡œ ë“±ë¡ëœ íˆ´â€ë§Œ ë³´ë¯€ë¡œ, ë„¤ê°€ ì›í•œ ë‹¨ìˆœí•œ íˆ´ ë“±ë¡ ëª¨ë¸ ê·¸ëŒ€ë¡œë‹¤. ëª¨ë¸ì€ LiteLLMì„ í†µí•´ ì„ì˜ ë² ì´ìŠ¤ URLì˜ LLMì„ ì“¸ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>ì‹¤ì „ íŒ<br />
íˆ´ ê³¼ì ì¬ë¥¼ í”¼í•˜ë ¤ë©´ tools=mcp_function_tools ëŒ€ì‹ , í”„ë¡¬í”„íŠ¸ë¥¼ ë³´ê³  í•„ìš”í•œ ì„œë²„ë§Œ í•„í„°ë§í•´ì„œ ì „ë‹¬í•´ë¼(ì˜ˆ: íŒŒì¼/CSVê°€ ìˆìœ¼ë©´ files:*ë§Œ). Function toolsëŠ” ì„¤ëª…ê³¼ ì¸ì ìŠ¤í‚¤ë§ˆë¥¼ ìë™ ì†Œë¹„í•˜ë‹ˆ, MCP ìª½ ìŠ¤í‚¤ë§ˆë¥¼ ë¹¡ë¹¡í•˜ê²Œ ìœ ì§€í•˜ë©´ arguments ì˜¤ë¥˜ê°€ ì¤„ì–´ë“ ë‹¤. FunctionToolë¡œ ì§ì ‘ ìƒì„±í•˜ë©´ ë°ì½”ë ˆì´í„° ì—†ì´ë„ ì´ë¦„Â·ì„¤ëª…Â·ìŠ¤í‚¤ë§ˆë¥¼ ì›í•˜ëŠ” ëŒ€ë¡œ ë„£ì„ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a></p>

<p>í™•ì¥ ì•„ì´ë””ì–´<br />
ê³ ìœ„í—˜ íˆ´ì— dry_run, confirm ê°™ì€ í•„ë“œë¥¼ MCP input_schemaì— ì¶”ê°€í•˜ë©´, ê·¸ëŒ€ë¡œ FunctionTool ì¸ì ìŠ¤í‚¤ë§ˆì— ë°˜ì˜ë˜ì–´ ì‹¤í–‰ ì „ì— ëª¨ë¸ì´ ìŠ¤ìŠ¤ë¡œ ì•ˆì „ ì ˆì°¨ë¥¼ ë”°ë¥¸ë‹¤.<br />
íˆ´ ê²°ê³¼ê°€ í¬ë©´ on_invoke_toolì—ì„œ ìš”ì•½ë§Œ ë°˜í™˜í•˜ê³ , ì›ë³¸ì€ íŒŒì¼ í•¸ë“¤ì´ë‚˜ URLë¡œ ì œê³µí•˜ë„ë¡ MCP ì„œë²„ë¥¼ ì„¤ê³„í•´ í† í° ì‚¬ìš©ëŸ‰ì„ ì¤„ì¸ë‹¤.</p>

<p>ì›í•˜ë©´ ë„¤ íŒŒì¼/DB MCP ì„œë²„ì˜ ì‹¤ì œ tool ì´ë¦„ê³¼ input_schemaë¥¼ ì•Œë ¤ì¤˜. ìœ„ ìŠ¤í¬ë¦½íŠ¸ê°€ í•´ë‹¹ ìŠ¤í‚¤ë§ˆë¥¼ ê·¸ëŒ€ë¡œ FunctionToolë¡œ ì˜®ê²¨ì£¼ê¸° ë•Œë¬¸ì— ì¶”ê°€ ì½”ë“œëŠ” ì‚¬ì‹¤ìƒ ì—†ë‹¤.</p>

<p class="chat--user">

ì‘ ë‚´ê°€ ì›í•˜ëŠ”ê±°ë‘ ê°€ê¹Œì›Œì§„ë“¯. ì§ˆë¬¸ì´ ë” ìˆì–´. ì§ˆë¬¸ 1. MCP ë§ê³  ì¼ë°˜ Function íˆ´ê³¼ ì„ì¸ ë²„ì ¼ ì¶”ê°€í•´ì¤˜. ì§ˆë¬¸ 2. ì¼ë°˜ chat completions (with tools) ì˜ˆì œë„ ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€í•´ì¤˜. ì§ˆë¬¸ 3. MCP Client Sessionì€ ì €ì ˆë¡œ ì¢…ë£Œë˜ë‚˜? ì§ˆë¬¸ 4. ì—¬ëŸ¬ Agentê°€ ìˆìœ¼ë©´ MCP ì¢…ë¥˜ë³„ë¡œ ì„¸ì…˜ì„ ì—¬ëŸ¬ê°œ ì—´ê²Œë ìˆ˜ë„ ìˆì„ê±° ê°™ì€ë° í•˜ë‚˜ë¡œ ìœ ì§€í•˜ëŠ”ê±´ ì–´ë•Œ? ë¬¸ì œê°€ ìˆìœ¼ë ¤ë‚˜

</p>

<p>ì¢‹ì•„. ë„¤ ì§ˆë¬¸ 4ê°œë¥¼ ìˆœì„œëŒ€ë¡œ, ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì½”ë“œì™€ í•¨ê»˜ ì •ë¦¬í•œë‹¤. ì¸ìš©êµ¬ë¬¸ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.</p>

<h1 id="1-mcp-íˆ´--ì¼ë°˜-function-íˆ´ì„-ì„ì–´-ë“±ë¡í•˜ëŠ”-ë²„ì „">1) MCP íˆ´ + ì¼ë°˜ Function íˆ´ì„ ì„ì–´ ë“±ë¡í•˜ëŠ” ë²„ì „</h1>

<p>ì•„ë˜ëŠ” ì•ì„œ ë§Œë“  â€œMCP â†’ FunctionTool ë˜í•‘â€ì— ë”í•´, ì¼ë°˜ íŒŒì´ì¬ í•¨ìˆ˜ë„ FunctionToolë¡œ í•¨ê»˜ ë“±ë¡í•˜ëŠ” ì˜ˆì‹œë‹¤. ì—ì´ì „íŠ¸ëŠ” ë‘ ì¢…ë¥˜ë¥¼ í•œêº¼ë²ˆì— ë³¸ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># ========== MCP ì—°ê²° ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">args_json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_function_tools</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># ========== ì¼ë°˜ íŒŒì´ì¬ í•¨ìˆ˜ â†’ FunctionTool ==========
</span>
<span class="k">def</span> <span class="nf">make_local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°. ì…ë ¥: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">math_eval</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># ========== ì‹¤í–‰ ì˜ˆì‹œ ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP íˆ´
</span>    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_mcp_function_tools</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="db", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">])</span>

    <span class="c1"># 2) ì¼ë°˜ Function íˆ´
</span>    <span class="n">local_tools</span> <span class="o">=</span> <span class="nf">make_local_tools</span><span class="p">()</span>

    <span class="c1"># 3) ëª¨ë¸ (ë„¤ ì»¤ìŠ¤í…€ LLM OpenAI-í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸)
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MixedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_tools</span> <span class="o">+</span> <span class="n">local_tools</span><span class="p">,</span>  <span class="c1"># ì„ì–´ì„œ ë“±ë¡
</span>    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data í´ë”ì˜ sales.csvë¥¼ ì½ì–´ í•©ê³„ë¥¼ êµ¬í•˜ê³ , local.math_evalë¡œ ìˆ«ì ê²€ì¦ê¹Œì§€ í•´ì¤˜</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h1 id="2-ì¼ë°˜-chat-completions-with-tools-ì˜ˆì œ">2) ì¼ë°˜ Chat Completions (with tools) ì˜ˆì œ</h1>

<p>OpenAI í˜¸í™˜ Chat Completions APIë¥¼ ì§ì ‘ ì“°ëŠ” ìˆœìˆ˜ ì˜ˆì‹œë‹¤. toolsì— í•¨ìˆ˜ ìŠ¤í‚¤ë§ˆë¥¼ ì£¼ê³ , tool_callsë¥¼ ë°›ì•„ì„œ ë„ˆì˜ ì‹¤í–‰ê¸°ë¡œ ë¼ìš°íŒ…í•œë‹¤. ì—¬ê¸°ì„œëŠ” ë¡œì»¬ ê³„ì‚°ê¸° í•˜ë‚˜ë§Œ ë³´ì—¬ì£¼ì§€ë§Œ, ìœ„ì˜ MCP tools ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ í•©ì³ ë„£ìœ¼ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>  <span class="c1"># ë„¤ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># ì—¬ê¸°ì— MCPì—ì„œ ê¸ì–´ì˜¨ toolsë„ ê·¸ëŒ€ë¡œ append ê°€ëŠ¥
</span><span class="p">]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">3*(2+5) ê°’ì„ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># 1ì°¨ ìš”ì²­
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
<span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="c1"># tool_calls ì²˜ë¦¬
</span><span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="c1"># 2ì°¨ ìš”ì²­(ë„êµ¬ ê²°ê³¼ ë°˜ì˜)
</span>    <span class="n">resp2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp2</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">resp2</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
</code></pre></div></div>

<p>í¬ì¸íŠ¸<br />
toolsì— MCPì—ì„œ ê¸ì€ ìŠ¤í‚¤ë§ˆë¥¼ ê·¸ëŒ€ë¡œ ì¶”ê°€í•˜ë©´, ì¼ë°˜ chat completions ë£¨í”„ì—ì„œë„ MCPì™€ ë¡œì»¬ íˆ´ì„ í•¨ê»˜ ì“¸ ìˆ˜ ìˆë‹¤. ë‹¨, MCP í˜¸ì¶œë¶€ëŠ” ë„ˆì˜ ë¼ìš°í„°ê°€ ì²˜ë¦¬í•´ tool ì—­í•  ë©”ì‹œì§€ë¥¼ ë§Œë“¤ì–´ ë„£ìœ¼ë©´ ëœë‹¤.</p>

<h1 id="3-mcp-clientsessionì€-ì €ì ˆë¡œ-ì¢…ë£Œë˜ë‚˜">3) MCP ClientSessionì€ ì €ì ˆë¡œ ì¢…ë£Œë˜ë‚˜?</h1>

<p>ìë™ ì¢…ë£Œë¥¼ ê¸°ëŒ€í•˜ë©´ ì•ˆ ëœë‹¤. í‘œì¤€ íŒ¨í„´ì€ ì„¸ ê°€ì§€ë‹¤.</p>

<ol>
  <li>
    <p>ì„¸ì…˜ì„ ê°ì‹¼ íŠ¸ëœìŠ¤í¬íŠ¸(StdIO/SSE)ì— ëŒ€í•´ stop/closeë¥¼ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤.</p>
  </li>
  <li>
    <p>async with ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ë˜í¼ë¥¼ ë§Œë“¤ì–´ with ë¸”ë¡ì´ ëë‚  ë•Œ ì •ë¦¬í•œë‹¤.</p>
  </li>
  <li>
    <p>í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ í›…ì—ì„œ ì „ì—­ ì„¸ì…˜ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì •ë¦¬í•œë‹¤.</p>
  </li>
</ol>

<p>ê°„ë‹¨ ì •ë¦¬ í•¨ìˆ˜ ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì„¸ì…˜ê³¼ íŠ¸ëœìŠ¤í¬íŠ¸ë¥¼ í•¨ê»˜ ì¶”ì í•´ì•¼ ì•ˆì „
</span><span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<p>ì„¸ì…˜ì„ ì—´ ë•Œ MCPHandleì„ ë§Œë“¤ì–´ ë¦¬ìŠ¤íŠ¸ì— ë„£ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ëª¨ë“  handle.close()ë¥¼ await í•˜ë©´ ëœë‹¤.</p>

<h1 id="4-ì—¬ëŸ¬-agentê°€-ì„¸ì…˜ì„-ê³µìœ í•´ë„-ë ê¹Œ-í•˜ë‚˜ë¡œ-ìœ ì§€í•˜ëŠ”-ì „ëµê³¼-ì£¼ì˜ì ">4) ì—¬ëŸ¬ Agentê°€ ì„¸ì…˜ì„ ê³µìœ í•´ë„ ë ê¹Œ? í•˜ë‚˜ë¡œ ìœ ì§€í•˜ëŠ” ì „ëµê³¼ ì£¼ì˜ì </h1>

<p>ê²°ë¡ ë¶€í„° ë§í•˜ë©´, ê³µìœ  í’€ì„ ë‘ê³  ì¬ì‚¬ìš©í•˜ëŠ” ê²Œ ì¼ë°˜ì ìœ¼ë¡œ ì¢‹ë‹¤. ë‹¤ë§Œ ëª‡ ê°€ì§€ ì£¼ì˜ì ì´ ìˆë‹¤.</p>

<p>ì¥ì <br />
ë©”ëª¨ë¦¬Â·í”„ë¡œì„¸ìŠ¤ ìˆ˜ ì ˆê°. stdio ì„œë²„ëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ í•˜ë‚˜ë§Œ ë„ìš°ë©´ ëœë‹¤.<br />
ì½œë“œ ìŠ¤íƒ€íŠ¸ ì§€ì—° ê°ì†Œ. list_tools ìºì‹œì™€ ì—°ê²° ìˆ˜ë¦½ ì‹œê°„ì´ ì ˆì•½ëœë‹¤.</p>

<p>ì£¼ì˜ì <br />
ë™ì‹œì„±. í•˜ë‚˜ì˜ MCP ì„¸ì…˜ì´ ë‹¤ì¤‘ í˜¸ì¶œì„ ì²˜ë¦¬í•  ë•Œ, ì„œë²„/í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì‹œ í˜¸ì¶œì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•œë‹¤. ëŒ€ë¶€ë¶„ì˜ MCP ì„œë²„ êµ¬í˜„ì€ ê´œì°®ì§€ë§Œ, íŠ¹ì • ì„œë²„ê°€ ìˆœì°¨ ì²˜ë¦¬ë§Œ ì•ˆì „í•˜ê²Œ ì§€ì›í•œë‹¤ë©´ íì‰ì´ë‚˜ ì„¸ë§ˆí¬ì–´ê°€ í•„ìš”í•˜ë‹¤.<br />
ê²©ë¦¬. ì‚¬ìš©ìÂ·ê¶Œí•œì´ ë‹¤ë¥¸ Agentê°€ ê°™ì€ ì„¸ì…˜ì„ ì“°ë©´ ê¶Œí•œ ê²½ê³„ê°€ íë ¤ì§ˆ ìˆ˜ ìˆë‹¤. ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê¶Œí•œ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.<br />
ìƒëª…ì£¼ê¸°. ëˆ„ê°€ ì–¸ì œ ë‹«ì„ì§€ í•©ì˜ê°€ í•„ìš”í•˜ë‹¤. ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŒ… ë˜ëŠ” ëª…ì‹œì  init/close APIê°€ í•„ìš”í•˜ë‹¤.<br />
ë²„ì „Â·ì˜µì…˜ ì°¨ì´. ê°™ì€ ì„œë²„ë¼ë„ í”Œë˜ê·¸(ì˜ˆ: dry_run ê¸°ë³¸ê°’)ê°€ ë‹¤ë¥¸ Agentë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤. ì´ë• ì„¸ì…˜ì„ ê³µìœ í•˜ì§€ ë§ê³  ë³„ë„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë„ì›Œë¼.</p>

<p>ê°„ë‹¨í•œ ì„¸ì…˜ í’€ ìŠ¤ìºí´ë”©(RefCount + AsyncLock):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPSessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,...]],</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># key ì˜ˆì‹œ: ("stdio", ("npx","-y","@modelcontextprotocol/server-filesystem","./data"))
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acquire_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientSession</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">:</span>
                <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
            <span class="c1"># ìƒˆë¡œ ìƒì„±
</span>            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">transport</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">release_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>ì‚¬ìš© íŒ¨í„´<br />
Agentê°€ ì‹œì‘í•  ë•Œ acquire_stdioë¡œ ì„¸ì…˜ì„ ë°›ì•„ ì“°ê³ , ëë‚  ë•Œ release_stdioë¡œ ë°˜ë‚©í•œë‹¤. ë™ì¼í•œ command/args ì¡°í•©ì€ í•œ ì„¸ì…˜ì„ ê³µìœ í•œë‹¤. ê¶Œí•œ ê²©ë¦¬ê°€ í•„ìš”í•œ ê²½ìš° keyì— ì¶”ê°€ ì‹ë³„ì(tenant, role ë“±)ë¥¼ í¬í•¨ì‹œí‚¤ë©´ ëœë‹¤. ë™ì‹œì„± ë°€ë„ê°€ ë†’ë‹¤ë©´ ê° MCP ì„œë²„ íŠ¹ì„±ì— ë§ì¶° per-server ì„¸ë§ˆí¬ì–´ë¥¼ ë”í•´ì£¼ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.</p>

<p>ë§ˆë¬´ë¦¬ íŒ<br />
ì„ì¸ í™˜ê²½(ì¼ë°˜ í•¨ìˆ˜ + MCP)ì—ì„œëŠ” íˆ´ ìˆ˜ê°€ ëŠ˜ì–´ í˜¼ë€ì´ ìƒê¸°ê¸° ì‰¬ìš°ë‹ˆ, ì—ì´ì „íŠ¸ì— ë“±ë¡í•  ë•Œ ë„ë©”ì¸ë³„ í”„ë¦¬í”½ìŠ¤(server:tool, local.*)ì™€ ì§§ê³  ëª…í™•í•œ ì„¤ëª…, ì—„ê²©í•œ JSON ìŠ¤í‚¤ë§ˆ(required/enum/format)ë¥¼ ìœ ì§€í•˜ì. í•„ìš”í•˜ë©´ í•œ í„´ì— ë…¸ì¶œí•  íˆ´ì„ í•„í„°ë§í•´ ê³¼ì ì¬ë¥¼ ì¤„ì´ëŠ” ê²ƒë„ íš¨ê³¼ì ì´ë‹¤.</p>

<p class="chat--user">

1ë²ˆê³¼ 2ë²ˆì„ í•©ì³ì„œ ì¨ì•¼ì§€. ë‘ ê°œ íˆ´ êµ¬í˜„ì´ ë„ˆë¬´ ë‹¤ë¥´ì–ì•„. íˆ´ êµ¬í˜„ì„ í•œ ë²ˆë§Œ í•˜ê³  ë‘ êµ°ë° ëª¨ë‘ì—ì„œ ì“°ê³  ì‹¶ì€ê±°ì•¼.

</p>

<p>ì¢‹ì•„, â€œíˆ´ êµ¬í˜„ì€ í•œ ë²ˆë§Œâ€ í•˜ê³ , ê·¸ê±¸ ë‘ ë°©ì‹ ëª¨ë‘ì—ì„œ ì¬ì‚¬ìš©í•˜ë„ë¡ í•©ì¹˜ì. ì•„ë˜ ìŠ¤ìºí´ë”©ì€ ë‹¨ì¼ ToolRegistryì— íˆ´ì„ ë“±ë¡í•˜ê³ , ê°™ì€ êµ¬í˜„ì„ 1) OpenAI Agents SDK(FunctionTool) ê²½ë¡œ, 2) ì¼ë°˜ Chat Completions(with tools) ê²½ë¡œ ì–‘ìª½ì—ì„œ ê·¸ëŒ€ë¡œ ì”ë‹ˆë‹¤. MCP íˆ´ë„ ë™ì¼í•œ ì¶”ìƒí™”ë¡œ ë˜í•‘í•©ë‹ˆë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>unified_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1">###############################################################################
# ê³µí†µ ì¶”ìƒí™”: í•œ ë²ˆ êµ¬í˜„í•œ íˆ´ì„ ì–´ë””ì„œë“  ì¬ì‚¬ìš©
###############################################################################
</span>
<span class="c1"># Tool í•¸ë“¤ëŸ¬ ì‹œê·¸ë‹ˆì²˜: args(dict) -&gt; dict/str (awaitable)
</span><span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># ì‹¤ì œ ì‹¤í–‰ ë¡œì§(ë™ì¼ êµ¬í˜„ì„ ì–‘ìª½ì—ì„œ ì¬ì‚¬ìš©)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool name: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">list_for_chat_completions</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># OpenAI tools í¬ë§·ìœ¼ë¡œ ì§ë ¬í™”
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# ë¡œì»¬(ì¼ë°˜) íˆ´ êµ¬í˜„ ì˜ˆì‹œ: í•œ ë²ˆë§Œ êµ¬í˜„
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">LOCAL_MATH_TOOL</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°. ì…ë ¥ {expr: string}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="n">handler</span><span class="o">=</span><span class="n">math_eval_handler</span>
<span class="p">)</span>

<span class="c1">###############################################################################
# MCP íˆ´ì„ ë™ì¼ ì¶”ìƒí™”ë¡œ ë˜í•‘: ì„¸ì…˜ë³„ë¡œ ToolSpecì„ ìƒì„±
###############################################################################
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ prefix
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆ í•„ìš”</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mcp_toolspecs_from_session</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="c1"># ë™ê¸° í•¨ìˆ˜ë¡œ ëª…ì„¸ë§Œ ë§Œë“¤ê³ , handlerëŠ” sessionì„ ìº¡ì²˜í•˜ì—¬ ë¹„ë™ê¸°ë¡œ í˜¸ì¶œ
</span>    <span class="c1"># list_tools ëŠ” asyncë¼ ë°–ì—ì„œ í˜¸ì¶œí•´ metadataë¥¼ ë„˜ê²¨ì¤˜ì•¼ í•œë‹¤.
</span>    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">call build_mcp_tools(...) instead</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">MCPHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">handle</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">):</span>
            <span class="c1"># _toolë¥¼ default ì¸ìë¡œ ë°”ì¸ë”©í•´ late-binding ì´ìŠˆ ë°©ì§€
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">packed</span>

        <span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">specs</span>

<span class="c1">###############################################################################
# 1) OpenAI Agents SDK ê²½ë¡œ: FunctionToolë¡œ ë˜í•‘í•˜ë˜, handlerëŠ” ë™ì¼ êµ¬í˜„ ì‚¬ìš©
###############################################################################
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_function_tool</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># ì—ì´ì „íŠ¸ëŠ” ë¬¸ìì—´ ë°˜í™˜ì´ í‘œì¤€ì´ë¯€ë¡œ JSON ë¬¸ìì—´ë¡œ ì§ë ¬í™”
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_function_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">()]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">user_text</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1">###############################################################################
# 2) ì¼ë°˜ Chat Completions ê²½ë¡œ: tools JSON + ë™ì¼ handlerë¡œ tool_calls ë¼ìš°íŒ…
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_for_chat_completions</span><span class="p">()</span>

        <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># ë„êµ¬ í˜¸ì¶œ ì²˜ë¦¬ ë£¨í”„(í•„ìš” ì‹œ ë°˜ë³µ)
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw_args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">}</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# ì‹¤í–‰ ì˜ˆì‹œ: í•œ ë²ˆ êµ¬í˜„ â†’ ë‘ ê²½ë¡œì—ì„œ ì‚¬ìš©
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìƒì„± ë° ë¡œì»¬ íˆ´ ë“±ë¡(í•œ ë²ˆë§Œ)
</span>    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">LOCAL_MATH_TOOL</span><span class="p">)</span>

    <span class="c1"># 1) MCP ì„¸ì…˜ ì—°ê²° í›„, MCP íˆ´ë“¤ì„ ë™ì¼ ì¶”ìƒí™”ë¡œ ë“±ë¡
</span>    <span class="n">files_cfg</span> <span class="o">=</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">files_handle</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">files_cfg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="k">await</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">files_handle</span><span class="p">):</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># A) Agents SDK ê²½ë¡œ
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Agents SDK ê²½ë¡œ ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="sh">"</span><span class="s">data í´ë”ì˜ sales.csvë¥¼ ì½ê³  í•©ê³„ë¥¼ ê³„ì‚°í•œ ë’¤ local.math_evalë¡œ 2ë°°ë¥¼ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># B) ì¼ë°˜ Chat Completions ê²½ë¡œ
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Chat Completions ê²½ë¡œ ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">files ì„œë²„ íˆ´ë¡œ sales.csv í•©ê³„ë¥¼ êµ¬í•˜ê³  local.math_evalë¡œ 100+23ë„ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">files_handle</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸ ì •ë¦¬<br />
íˆ´ì€ ToolSpec(handler í¬í•¨)ìœ¼ë¡œ í•œ ë²ˆë§Œ êµ¬í˜„í•œë‹¤. MCPë„ build_mcp_toolsê°€ ë™ì¼í•œ ToolSpecì„ ë§Œë“¤ê³ , ë¡œì»¬ íˆ´ë„ ê°™ì€ í˜•íƒœë‹¤.<br />
OpenAI Agents SDKëŠ” FunctionToolë¡œ ì–‡ê²Œ ë˜í•‘ë§Œ í•œë‹¤. on_invokeëŠ” ê°™ì€ handlerë¥¼ í˜¸ì¶œí•œë‹¤.<br />
Chat Completions(with tools)ë„ registryì˜ tools JSONì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³ , tool_callsë¥¼ ê°™ì€ handlerë¡œ ë¼ìš°íŒ…í•œë‹¤.<br />
MCP ì„¸ì…˜ì€ MCPHandle.closeë¡œ ëª…ì‹œ ì¢…ë£Œí•œë‹¤. ì—¬ëŸ¬ Agentë‚˜ ì—¬ëŸ¬ ëŸ¬ë„ˆê°€ ìˆì„ ë•Œ ê³µìœ í•˜ê³  ì‹¶ë‹¤ë©´ í•¸ë“¤ í’€ì„ ë‘ê³  ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŒ…ë§Œ ì–¹ìœ¼ë©´ ëœë‹¤.</p>

<p>ì´ì œ â€œíˆ´ êµ¬í˜„ì€ í•œ ë²ˆë§Œâ€ ì“°ê³ , Agentsì™€ Chat Completions ì–´ë””ì„œë“  ë™ì¼í•˜ê²Œ ëŒì•„ê°„ë‹¤. í•„ìš”í•œ ê²½ìš° expose(íˆ´ ì†Œì¶œ) ì •ì±…ì´ë‚˜ ê¶Œí•œ ê²Œì´íŠ¸ë¥¼ registry ë ˆë²¨ì—ì„œ í•„í„°ë§ í›…ìœ¼ë¡œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p class="chat--user">

í  ì°¨ë¼ë¦¬ MCPì— ëŒ€í•œ ì •ë³´ë¥¼ ë”°ë¡œ ë°›ê³  ì—ì´ì „íŠ¸ì—ê²Œ ì•Œì•„ì„œ ì²˜ë¦¬í•˜ëŠ”ê²Œ ë‚˜ì„ê¹Œ? ì´ëŸ¬ë„ˆ ë ˆì´ì–´ë¥¼ ë‚´ê°€ ì§ì ‘ ë§Œë“œëŠ”ê²ƒë³´ë‹¤?

</p>

<p>ì§šê³  ê°€ì. â€œMCP ì •ë³´ë¥¼ ì—ì´ì „íŠ¸ì—ê²Œ ê·¸ëŒ€ë¡œ ë„˜ê²¨ì„œ ì•Œì•„ì„œ ì“°ê²Œ í• ì§€â€ vs â€œë„¤ê°€ ëŸ¬ë„ˆ ë ˆì´ì–´(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°)ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ í†µì œí• ì§€â€ëŠ” íŠ¸ë ˆì´ë“œì˜¤í”„ë‹¤. í•œìª½ì´ í•­ìƒ ë” ë‚«ì§€ëŠ” ì•Šë‹¤. ì•„ë˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„ íƒí•˜ë©´ ëœë‹¤.</p>

<p>ì„ íƒ ê¸°ì¤€ ìš”ì•½<br />
ì—ì´ì „íŠ¸ê°€ MCPë¥¼ ì§ì ‘ ë‹¤ë£¨ê²Œ í•œë‹¤<br />
ì¥ì : ì„¤ì •ì´ ë‹¨ìˆœí•˜ê³  ë¹ ë¥´ë‹¤. SDKê°€ ì„¸ì…˜ ê´€ë¦¬, íˆ´ í˜¸ì¶œ, ë°˜í™˜ í˜•ì‹ ë“±ì„ ì•Œì•„ì„œ ì²˜ë¦¬í•œë‹¤. í˜¸ìŠ¤í‹°ë“œ/ì›ê²© MCPëŠ” ì½”ë“œ ì—†ì´ ë¶™ì´ê¸° ì‰½ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io+1</a><br />
ë‹¨ì : í„´ë³„ íˆ´ ì†Œì¶œ(Selective exposure), ê³ ê¸‰ ìŠ¹ì¸ íë¦„, ë¡œê¹… í‘œì¤€í™”, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê·œì¹™, ì¬ì‹œë„Â·ì„œí‚·ë¸Œë ˆì´ì»¤ ê°™ì€ â€œí”Œë«í¼ ê³µí†µ ì •ì±…â€ì„ ì„¸ë°€í•˜ê²Œ ë„£ê¸° ì–´ë µë‹¤. ëª¨ë¸ì´ ë§ì€ íˆ´ì„ ë™ì‹œì— ë³´ê²Œ ë˜ë©´ í˜¸ì¶œ í˜¼ì„ ì´ ëŠ˜ì–´ë‚œë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI Platform+1</a></p>

<p>ì§ì ‘ ëŸ¬ë„ˆ(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°)ë¥¼ ë‘”ë‹¤<br />
ì¥ì : íˆ´ ë…¸ì¶œÂ·ê¶Œí•œÂ·ì—ëŸ¬ ì²˜ë¦¬Â·ê´€ì¸¡ì„±ì„ ì „ë¶€ ë„¤ê°€ í‘œì¤€í™”í•  ìˆ˜ ìˆë‹¤. ì—¬ëŸ¬ ì±„íŒ… ë°±ì—”ë“œ(Agents, ì¼ë°˜ Chat Completions, ì‚¬ë‚´ ì—”ì§„)ë¥¼ ê°™ì€ ê·œì•½ìœ¼ë¡œ ê¿°ë§¤ ì“¸ ìˆ˜ ìˆë‹¤.<br />
ë‹¨ì : ë„¤ê°€ ì„¸ì…˜ í’€, ë¼ìš°íŒ…, ì¬ì‹œë„, í¬ë§· ê°•ì œ(JSONë§Œ ì¶œë ¥ ë“±)ë¥¼ êµ¬í˜„Â·ìœ ì§€í•´ì•¼ í•œë‹¤.</p>

<p>ê¶Œì¥ ê²°ë¡ <br />
ìš´ì˜ ê¸°ì¤€ì´ ë¹¡ë¹¡í•˜ë‹¤ë©´(ê¶Œí•œ ë¶„ë¦¬, ìŠ¹ì¸, ë¡œê·¸, ë³µêµ¬ ì „ëµ, ë¹„ìš©/ì§€ì—° ê´€ë¦¬), ì§€ê¸ˆê¹Œì§€ ë§Œë“  ì–‡ì€ ëŸ¬ë„ˆë¥¼ ìœ ì§€í•˜ë˜ ë°±ì—”ë“œëŠ” ê°ˆì•„ë¼ìš°ëŠ” ë°©ì‹ì´ ì í•©í•˜ë‹¤. ë°˜ëŒ€ë¡œ ë¹ ë¥¸ ì´ˆê¸° í†µí•©Â·PoC, ê³µê°œ ì›ê²© MCPë§Œ ì“°ëŠ” ê²½ìš°ì—ëŠ” ì—ì´ì „íŠ¸ê°€ MCPë¥¼ ì§ì ‘ ë‹¤ë£¨ê²Œ í•˜ëŠ” êµ¬ì„±ì´ ê°€ë³ë‹¤. ë‘˜ì„ ì„ëŠ” í•˜ì´ë¸Œë¦¬ë“œë„ ê°€ëŠ¥í•˜ë‹¤. ì¦‰, ì €ìœ„í—˜Â·ì½ê¸° ì „ìš© MCPëŠ” ì—ì´ì „íŠ¸ê°€ ì§ì ‘, ê³ ìœ„í—˜ MCPëŠ” ëŸ¬ë„ˆë¥¼ í†µí•´ì„œë§Œ ë…¸ì¶œ.</p>

<p>ë‘˜ ì¤‘ í•˜ë‚˜ë¥¼ ê³ ë¥¸ ë’¤ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ, ì‹¤ì œ ì‚¬ìš© ìŠ¤ë‹ˆí«ì„ 2ê°œ ë¶™ì¸ë‹¤.</p>

<p>ì—ì´ì „íŠ¸ê°€ MCPë¥¼ ì§ì ‘ ë‹¤ë£¨ëŠ” ìµœì†Œ ì˜ˆì‹œ<br />
ì—¬ê¸°ì„œëŠ” OpenAI Agents Python SDKì— ì—¬ëŸ¬ MCP ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê¸´ë‹¤. ëª¨ë¸ì€ OpenAI í˜¸í™˜ RESTë¡œ ë…¸ì¶œëœ ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì“´ë‹¤(LiteLLM ë˜í¼).<br />
ì£¼ì˜: ì—ì´ì „íŠ¸ì— íˆ´ì„ ëª¨ë‘ ë…¸ì¶œí•˜ë©´ í˜¼ì„ ì´ ìƒê¸¸ ìˆ˜ ìˆìœ¼ë‹ˆ, í•„ìš”í•˜ë©´ íˆ´ í•„í„°Â·ìŠ¹ì¸ ì˜µì…˜ì„ ë³‘í–‰í•˜ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>  <span class="c1"># SDK ë‚´ì¥ MCP ì»¤ë„¥í„°
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://your-mcp.example/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">your-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">AgentManagedMCP</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•œ MCP íˆ´ë§Œ ì„ íƒí•´ì„œ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>  <span class="c1"># í¬ì¸íŠ¸: MCP ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê¹€
</span>        <span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data í´ë”ì—ì„œ sales.csv ì´í•©ì„ êµ¬í•˜ê³ , ê²€ìƒ‰ ì„œë²„ë¡œ ê´€ë ¨ ë¦¬í¬íŠ¸ë¥¼ ì°¾ì•„ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì¼ë°˜ Chat Completions(with tools)ì— ë°”ë¡œ ë¶™ì´ëŠ” ìµœì†Œ ì˜ˆì‹œ<br />
ì—¬ê¸°ì„œëŠ” MCP ì •ë³´ë¥¼ ì§ì ‘ ë„˜ê¸°ì§€ ì•Šê³ , MCPê°€ ë…¸ì¶œí•œ íˆ´ë“¤ì„ OpenAI â€œtoolsâ€ í¬ë§·ìœ¼ë¡œ ë³€í™˜í•´ì„œ ëª¨ë¸ì—ê²Œ ë³´ì—¬ì¤€ë‹¤. ëª¨ë¸ì˜ tool_callsë¥¼ ë°›ìœ¼ë©´ ë„¤ê°€ call_toolì„ ì‹¤í–‰í•œë‹¤. ì´ ê²½ë¡œëŠ” ëŸ¬ë„ˆê°€ ì–‡ê²Œë‚˜ë§ˆ í•„ìš”í•˜ì§€ë§Œ, ë„ˆê°€ ì´ë¯¸ ê°€ì§„ í†µì¼ ì¸í„°í˜ì´ìŠ¤(ë‹¨ì¼ ToolRegistry + handler ì¬ì‚¬ìš©)ë¥¼ ìœ ì§€í•˜ê¸° ì¢‹ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="n">BASE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>
<span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">your-model</span><span class="sh">"</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">list_mcp_tools_as_openai_tools</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]))</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">);</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">files:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">session</span><span class="p">,</span> <span class="n">tools</span>  <span class="c1"># sessionì€ ë’¤ì—ì„œ call_toolì— ì‚¬ìš©
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">session</span><span class="p">,</span> <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">list_mcp_tools_as_openai_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">í•„ìš”í•œ íˆ´ë§Œ í˜¸ì¶œí•œë‹¤.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">files ì„œë²„ íˆ´ë¡œ sales.csv í•©ê³„ë¥¼ êµ¬í•´ì¤˜</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># 1ì°¨ ìš”ì²­
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>            <span class="c1"># e.g., files:read
</span>            <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># MCP ì‹¤í–‰
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="c1"># í‘œì¤€í™”í•˜ì—¬ íˆ´ ë©”ì‹œì§€ë¡œ ì¬ì£¼ì…
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,{})</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">]})</span>
            <span class="p">})</span>

        <span class="c1"># 2ì°¨ ìš”ì²­
</span>        <span class="n">data2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="n">_transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì–¸ì œ â€œì—ì´ì „íŠ¸ì—ê²Œ ë§¡ê¸°ê¸°â€ê°€ ìœ ë¦¬í•œê°€<br />
MCP ì„œë²„ê°€ ì „ë¶€ ì›ê²©Â·ê³µê°œì´ê³ , ê¶Œí•œ ê²½ê³„ê°€ ë‹¨ìˆœí•˜ë©°, íˆ´ ìˆ˜ê°€ ë§ì§€ ì•Šê³ , ë¹ ë¥´ê²Œ ê²°ê³¼ë¥¼ ë‚´ì•¼ í•  ë•Œ. SDKê°€ ì„¸ì…˜Â·í˜¸ì¶œì„ ëŒ€ì‹  ê´€ë¦¬í•˜ë¯€ë¡œ ê°œë°œ ë¹„ìš©ì´ ë‚®ë‹¤. OpenAI Agents SDKì˜ MCP ê°€ì´ë“œëŠ” ì´ ê²½ë¡œë¥¼ ê¸°ë³¸ìœ¼ë¡œ ìƒì •í•œë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io</a></p>

<p>ì–¸ì œ â€œì§ì ‘ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜â€ì´ ìœ ë¦¬í•œê°€<br />
íˆ´ì´ ë§ê³  ì„±ê²©ì´ ë‹¤ì–‘í•´ì„œ í„´ë³„ ì†Œì¶œì´ í•„ìš”í•  ë•Œ, ì‹¤íŒ¨Â·ì¬ì‹œë„Â·ë°±ì˜¤í”„ ê°™ì€ SRE ë£°ì„ ë„ì…í•´ì•¼ í•  ë•Œ, ê°ì‚¬ ë¡œê·¸ì™€ ìŠ¹ì¸ í”Œë¡œìš°ê°€ í•„ìš”í•œ ì¡°ì§ í™˜ê²½ì¼ ë•Œ. ì´ë•ŒëŠ” ë„¤ê°€ ë§Œë“  ToolRegistry/handler ë‹¨ì¼í™” êµ¬ì¡°ê°€ ìœ ì§€ë³´ìˆ˜ì— ìœ ë¦¬í•˜ë‹¤. ëª¨ë¸/í”Œë«í¼ì„ ë°”ê¿€ ë•Œë„ ë°±ì—”ë“œë§Œ êµì²´í•˜ë©´ ëœë‹¤. OpenAI í‘œì¤€ í•¨ìˆ˜ì½œ ë£¨í”„ëŠ” ë¬¸ì„œì˜ ê¶Œì¥ íŒ¨í„´ì´ë©°, ì´ ìœ„ì— ì •ì±…ì„ ì–¹ê¸° ì‰½ë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling?api-mode=chat&amp;utm_source=chatgpt.com">OpenAI Platform+1</a></p>

<p>í•˜ì´ë¸Œë¦¬ë“œ íŒ<br />
ì €ìœ„í—˜Â·ì½ê¸° ì „ìš© MCPëŠ” ì—ì´ì „íŠ¸ ì§ê²°ë¡œ ë¹¨ë¦¬ ë¶™ì´ê³ , ê³ ìœ„í—˜(ì“°ê¸°/ì‚­ì œ/ê²°ì œ/ë°°í¬) MCPëŠ” ëŸ¬ë„ˆ ê²½ìœ  íˆ´ë¡œë§Œ ë…¸ì¶œí•œë‹¤. ì—ì´ì „íŠ¸ ìª½ì—ëŠ” í•´ë‹¹ íˆ´ì„ ìˆ¨ê²¨ ë‘ê³ , ëŸ¬ë„ˆê°€ ìŠ¹ì¸ëœ ìš”ì²­ë§Œ ëŒ€ë¦¬ í˜¸ì¶œí•œë‹¤. ì´ êµ¬ì„±ì´ í˜„ì—…ì—ì„œ ê°€ì¥ ì—ëŸ¬ìœ¨Â·ì‚¬ê³ ìœ¨ì´ ë‚®ê³ , ì´ˆê¸° ì†ë„ë„ ë¹ ë¥´ë‹¤.</p>

<p>ë§ˆì§€ë§‰ ì²´í¬ë¦¬ìŠ¤íŠ¸<br />
íˆ´ ê³¼ì ì¬ë¥¼ í”¼í•˜ë ¤ë©´ íˆ´ ë…¸ì¶œ ìˆ˜ë¥¼ í„´ë‹¹ 8~12ê°œ ìˆ˜ì¤€ì—ì„œ ì‹œì‘í•˜ì.<br />
namespacingì€ server:tool íŒ¨í„´ì„ ê³ ì •í•´ ì¶©ëŒì„ ë§‰ì.<br />
input_schemaë¥¼ ì—„ê²©í•˜ê²Œ(required, enum, format) ì¡ì•„ ì˜ëª»ëœ argumentsë¥¼ ì¤„ì´ì.<br />
MCP ì„¸ì…˜ì€ ìë™ ì¢…ë£Œê°€ ì•„ë‹ˆë¯€ë¡œ ì¢…ë£Œ í›…ì„ ë‘ê±°ë‚˜ ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•˜ì.<br />
ì„¸ì…˜ ê³µìœ ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ ê¶Œí•œÂ·ë™ì‹œì„±Â·ìƒëª…ì£¼ê¸° ê·œì¹™ì„ ë¨¼ì € ì •í•´ë‘¬ì•¼ í•œë‹¤.</p>

<p>ì›í•œë‹¤ë©´ ì§€ê¸ˆ ë„¤ ì‹¤ì œ MCP ì„œë²„ ëª©ë¡ê³¼ ìœ„í—˜ë„(ì½ê¸°/ì“°ê¸°), ê·¸ë¦¬ê³  ì‚¬ìš© ì¤‘ì¸ ëª¨ë¸ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì•Œë ¤ì¤˜. ìœ„ ìŠ¤ë‹ˆí«ì„ ë„¤ í™˜ê²½ì— ë§ê²Œ ë°”ë¡œ ëŒì•„ê°€ë„ë¡ ê¹”ë”í•˜ê²Œ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆí•´ì£¼ê² ë‹¤.</p>

<p class="chat--user">

MCPê°€ 3ê°œ ì´ìƒë“¤ì–´ì™”ì„ ë•Œ ì²˜ë¦¬ì— ëŒ€í•´ ì•Œë ¤ì¤˜. ê·¸ë¦¬ê³  OpenAI Agent ë§ê³  ë‹¤ë¥¸ Agentë„ ìˆì–´. 1. MCPì— ê´€í•œ ì •ë³´ë¥¼ í†µì¼ë˜ê²Œ ë‹¤ë£° ìˆ˜ ìˆëŠ” í´ë˜ìŠ¤ê°€ í•„ìš”í•´. 2. 1ì—ì„œ ë§Œë“  ì •ë³´ë¥¼ ê°ê°ì˜ Agentì— ë§ê²Œ Adaptë¥¼ í•´ì¤„ ìˆ˜ ìˆëŠ” ì–‡ì€ í´ë˜ìŠ¤ë‚˜ í•¨ìˆ˜ê°€ í•„ìš”í•  ê²ƒ ê°™ì•„.

</p>

<p>ì¢‹ì•„. â€œMCP ì„œë²„ê°€ 3ê°œ ì´ìƒâ€ì¼ ë•Œ í”ë“¤ë¦¬ì§€ ì•Šê²Œ ëŒë¦¬ëŠ” êµ¬ì¡°ë¥¼ ë”± ë‘ ì¸µìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ë‚˜ëˆ ì¤„ê²Œ.</p>

<ol>
  <li>
    <p>MCP ì •ë³´ë¥¼ â€œì™„ì „íˆ í†µì¼ëœ í¬ë§·â€ìœ¼ë¡œ ë‹¤ë£¨ëŠ” í—ˆë¸Œ í´ë˜ìŠ¤</p>
  </li>
  <li>
    <p>ê·¸ í†µì¼ í¬ë§·ì„ ê° ì—ì´ì „íŠ¸ë³„ë¡œ ì–‡ê²Œ ë³€í™˜í•˜ëŠ” ì–´ëŒ‘í„°ë“¤</p>
  </li>
</ol>

<p>í•œ ë²ˆì˜ êµ¬í˜„ìœ¼ë¡œ OpenAI Agents, ì¼ë°˜ Chat Completions(with tools), ê·¸ë¦¬ê³  ë‹¤ë¥¸ í”„ë ˆì„ì›Œí¬(ì›í•˜ë©´ LangChain/Autogen ë“±)ê¹Œì§€ ê°™ì€ íˆ´ êµ¬í˜„ì„ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì•„ë˜ ìŠ¤ìºí´ë”©ì€ ê·¸ëŒ€ë¡œ ë³µë¶™í•´ì„œ ì‹œì‘í•´ë„ ëœë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>mcp_unified_adapters.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">uuid</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>

<span class="c1"># =========================
# 0) í†µì¼ëœ íˆ´ ìŠ¤í™/ë ˆì§€ìŠ¤íŠ¸ë¦¬
# =========================
</span>
<span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">UnifiedToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># ì˜ˆ: "files:read_csv" or "local.math_eval"
</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># ëª¨ë“  ë°±ì—”ë“œì—ì„œ ì¬ì‚¬ìš©ë˜ëŠ” ì‹¤ì œ ì‹¤í–‰ ë¡œì§
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">UnifiedToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">UnifiedToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UnifiedToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

<span class="c1"># =========================
# 1) MCP í—ˆë¸Œ(3ê°œ+ ì„œë²„ ì•ˆì • ìš´ìš©)
# =========================
</span>
<span class="c1"># a) ì„¤ì •ê³¼ í•¸ë“¤
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># ì„ íƒ: ë™ì‹œì„± ì œí•œ ë“±
</span>    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sema</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># b) MCP í—ˆë¸Œ: 3ê°œ ì´ìƒ ì„œë²„ë¥¼ ì—°ê²°Â·í†µì¼ ìŠ¤í™ìœ¼ë¡œ ë³€í™˜Â·ì‹¤í–‰ ë¼ìš°íŒ…
</span><span class="k">class</span> <span class="nc">MCPHub</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MCPHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">)</span>

        <span class="c1"># list_toolsë¥¼ ëª¨ë‘ ê¸ì–´ í†µì¼ ìŠ¤í™ìœ¼ë¡œ ë“±ë¡(ë„¤ì„ìŠ¤í˜ì´ìŠ¤: server:tool)
</span>        <span class="k">for</span> <span class="n">server</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="c1"># ë™ì‹œì„± ë³´í˜¸ + íƒ€ì„ì•„ì›ƒ
</span>                    <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">sema</span><span class="p">:</span>
                        <span class="n">coro</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">packed</span>

                <span class="n">self</span><span class="p">.</span><span class="n">_registry</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">UnifiedToolSpec</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
                <span class="p">))</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">registry</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_ready</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPHub.start() í˜¸ì¶œ ì „ì…ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_registry</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># =========================
# 2) ê³µí†µ ë¡œì»¬ íˆ´(ì„ íƒ)
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedToolSpec</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">UnifiedToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">math_eval</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># =========================
# 3) ì–´ëŒ‘í„° ë ˆì´ì–´(ì–‡ê²Œ)
# =========================
</span>
<span class="c1"># 3-a) OpenAI Agents Python SDK(FunctionTool) ì–´ëŒ‘í„°
</span><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_agents_function_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">UnifiedToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="nf">wrap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">()]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">model_impl</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•˜ê³ , íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_impl</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="nf">to_agents_function_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1"># 3-b) OpenAI í˜¸í™˜ Chat Completions(with tools) ì–´ëŒ‘í„°
</span><span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_tools_json</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
        <span class="p">}}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_json</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw</span><span class="p">}</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>

<span class="c1"># 3-c) ë‹¤ë¥¸ ì—ì´ì „íŠ¸(ì˜ˆ: LangChain Tool)ë¡œì˜ ì–‡ì€ ì–´ëŒ‘í„°(ì˜µì…˜)
# í•„ìš”í•˜ë©´ ì´ëŸ° í˜•íƒœë¡œ ì¶”ê°€:
</span><span class="k">def</span> <span class="nf">to_langchain_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">langchain.tools</span> <span class="kn">import</span> <span class="n">StructuredTool</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">t</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">StructuredTool</span><span class="p">.</span><span class="nf">from_function</span><span class="p">(</span>
            <span class="n">coroutine</span><span class="o">=</span><span class="n">_run</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">__</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># í”„ë ˆì„ì›Œí¬ ëª…ëª… ê·œì¹™ ë§ì¶”ê¸°
</span>            <span class="n">description</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">description</span>
            <span class="c1"># schemaëŠ” í”„ë ˆì„ì›Œí¬ë³„ë¡œ ë³„ë„ ì§€ì • ê°€ëŠ¥
</span>        <span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># =========================
# 4) 3ê°œ+ MCP ì„œë²„ í¬í•¨ ì‹¤í–‰ ì˜ˆì‹œ
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># a) MCP ì„œë²„ 3ê°œ ì´ìƒ ì„ ì–¸
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># ê³µê°œ/ì›ê²©ì´ë©´ SSE ê°€ëŠ¥(ëª¨ë“ˆ ì„¤ì¹˜ í•„ìš”)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="nc">MCPHub</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">hub</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">hub</span><span class="p">.</span><span class="nf">registry</span><span class="p">()</span>

        <span class="c1"># ë¡œì»¬(ì¼ë°˜) íˆ´ë„ ê°™ì€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì¶”ê°€
</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">local_tools</span><span class="p">():</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># ë…¸ì¶œ ê³¼ì ì¬ ë°©ì§€ íŒ(ì„ íƒ): í•„ìš”í•  ë•Œë§Œ ì„œë¸Œì…‹ì„ ë½‘ì•„ ë‹¤ë¥¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë³µì‚¬í•´ë„ ë¨
</span>        <span class="c1"># ì—¬ê¸°ì„œëŠ” ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
</span>
        <span class="c1"># A) OpenAI Agents ê²½ë¡œ
</span>        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span>
            <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸
</span>            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="sh">"</span><span class="s">files ì„œë²„ë¡œ sales.csv í•©ê³„ë¥¼ êµ¬í•˜ê³ , local.math_evalë¡œ 100+23 ê³„ì‚°ë„ í•´ì¤˜</span><span class="sh">"</span>
        <span class="p">)</span>

        <span class="c1"># B) Chat Completions ê²½ë¡œ
</span>        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">system</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="sh">"</span><span class="s">db ì„œë²„ ìš”ì•½ íˆ´ë¡œ ê³ ê°ë³„ êµ¬ë§¤ í•©ê³„ë¥¼ ìš”ì•½í•˜ê³ , ìˆ˜ì¹˜ ê²€ì¦ì€ local.math_evalë¡œ 2*(50+5) ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">hub</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ ì„¤ê³„ í¬ì¸íŠ¸ ì •ë¦¬<br />
MCPê°€ 3ê°œ ì´ìƒì´ì–´ë„ MCPHubê°€ ëª¨ë“  ì„¸ì…˜ì„ ë“¤ê³  ìˆê³ , list_toolsë¥¼ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(server:tool)ë¡œ ë¬¶ì–´ í•˜ë‚˜ì˜ ToolRegistryì— ì˜¬ë¦°ë‹¤. ì‹¤í–‰ë„ ê°™ì€ handlerë¥¼ í†µí•´ ë¼ìš°íŒ…ë˜ë¯€ë¡œ êµ¬í˜„ì´ í•œ ë²ˆë¿ì´ë‹¤.<br />
ì–´ëŒ‘í„° ë ˆì´ì–´ëŠ” ì–‡ë‹¤. Agents(FunctionTool ë¦¬ìŠ¤íŠ¸ ìƒì„±), Chat Completions(tools JSON ìƒì„±), LangChain ë“± ì•„ë¬´ í”„ë ˆì„ì›Œí¬ë‚˜ 20~30ì¤„ ë‚´ë¡œ ë¶™ëŠ”ë‹¤.<br />
ë™ì‹œì„±Â·íƒ€ì„ì•„ì›ƒì„ MCPHandleì— í†µí•©í–ˆë‹¤. ì„œë²„ë§ˆë‹¤ max_concurrencyì™€ timeoutì„ ë‹¤ë¥´ê²Œ ì¤„ ìˆ˜ ìˆë‹¤.<br />
ì„¸ì…˜ ì¢…ë£ŒëŠ” MCPHub.closeì—ì„œ ì¼ê´„ ì²˜ë¦¬í•œë‹¤. ìë™ ì¢…ë£Œì— ê¸°ëŒ€ì§€ ì•ŠëŠ”ë‹¤.</p>

<p>3ê°œ ì´ìƒ ì„œë²„ì¼ ë•Œ ì‹¤ì „ ìš´ì˜ íŒ<br />
íˆ´ ì†Œì¶œ: í„´ë³„ë¡œ í•„ìš”í•œ ì„œë¸Œì…‹ë§Œ ë…¸ì¶œí•˜ë©´ íˆ´ ì„ íƒ ì˜¤ë¥˜ê°€ ê¸‰ê°í•œë‹¤. ê°„ë‹¨í•œ í‚¤ì›Œë“œ ë£°ë¶€í„° ì‹œì‘í•´ë„ íš¨ê³¼ê°€ í¬ë‹¤.<br />
ë„¤ì„ìŠ¤í˜ì´ìŠ¤: server:toolì„ ê³ ì •í•˜ê³ , descriptionì—ë„ ì„œë²„ëª…ì„ ë°˜ë³µ í‘œê¸°í•˜ë©´ í˜¼ë™ì´ ì¤„ì–´ë“ ë‹¤.<br />
ìŠ¤í‚¤ë§ˆ ì—„ê²©í™”: required, enum, formatì„ ê°€ëŠ¥í•œ í•œ ë§ì´ ë„£ì. arguments íŒŒì‹± ì˜¤ë¥˜ê°€ ì¤„ì–´ë“ ë‹¤.<br />
ê´€ì¸¡ì„±: handlerì—ì„œ ì…ë ¥/ì¶œë ¥/ì§€ì—°ì„ JSONLë¡œ ë¡œê¹…í•˜ë©´ í›„ì† ìµœì í™”ê°€ ì‰¬ì›Œì§„ë‹¤.<br />
ê³ ìœ„í—˜ íˆ´: parametersì— dry_run(boolean, default true)ì™€ confirm ë¬¸ìì—´ì„ ì¶”ê°€í•´ ëª¨ë¸ì´ ìì²´ë¡œ ì•ˆì „ ì ˆì°¨ë¥¼ ë°Ÿê²Œ í•˜ì.</p>

<p>ì´ ìŠ¤ìºí´ë”©ì´ë©´ MCP ì •ë³´ë¥¼ í•œ ë²ˆë§Œ ìˆ˜ì§‘Â·ì •ê·œí™”í•˜ê³ , ì–´ë–¤ ì—ì´ì „íŠ¸ë“  ì–´ëŒ‘í„°ë§Œ ê°ˆì•„ë¼ì›Œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. í•„ìš”í•˜ë©´ expose(íˆ´ ì†Œì¶œ) ì „ëµ í•¨ìˆ˜ì™€ ì„¸ì…˜ í’€(ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ì„œë¹„ìŠ¤ ê°„ ê³µìœ )ì„ ë§ëŒ€ì„œ íŒ€ í‘œì¤€ í”Œë«í¼ìœ¼ë¡œ êµ³íˆë©´ ëœë‹¤.</p>

<p class="chat--user">

ì•„ë‹ˆ mcp ì„œë²„ëŠ” ê·¸ëŒ€ë¡œ ë„˜ê¸¸ê±°ì•¼ íˆ´ë¡œ ë‚´ê°€ ë˜í•‘ ì•ˆí• ê±°ì•¼

</p>

<p>ì¢‹ì•„. â€œMCP ì„œë²„ëŠ” ê·¸ëŒ€ë¡œ ë„˜ê¸´ë‹¤(íˆ´ë¡œ ë˜í•‘ ì•ˆ í•¨)â€ë¥¼ ì „ì œë¡œ, ì—¬ëŸ¬ ê°œ(3ê°œ ì´ìƒ) MCPë¥¼ í•œêº¼ë²ˆì— ë‹¤ë£¨ëŠ” í†µì¼ ì •ë³´ í´ë˜ìŠ¤ì™€ ê° ì—ì´ì „íŠ¸ë³„ ì–‡ì€ ì–´ëŒ‘í„°ë¥¼ ë§Œë“¤ì–´ì¤„ê²Œ. í•µì‹¬ì€ íˆ´ ë ˆë²¨ ë˜í•‘ì´ ì•„ë‹ˆë¼, MCP ì„œë²„ ë©”íƒ€(ì—°ê²° ë°©ì‹Â·ìê²©ì¦ëª…Â·ë„¤ì„ë¼ë²¨)ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ëŠ” ê²ƒì´ë‹¤.</p>

<p>ì•„ë˜ ìŠ¤ìºí´ë”©ì€ ì„¸ íŒŒíŠ¸ë‹¤.</p>

<ol>
  <li>
    <p>UnifiedMCPConfig: MCP ì„œë²„ ì •ë³´ë¥¼ í†µì¼ëœ í¬ë§·ìœ¼ë¡œ ë³´ê´€Â·ê²€ì¦.</p>
  </li>
  <li>
    <p>Adapters: ì´ ì •ë³´ë¥¼ ê° ì—ì´ì „íŠ¸ SDKì— ë§ê²Œ ê·¸ëŒ€ë¡œ íˆ¬ì‚¬.<br />
2-1) OpenAI Agents Python SDKìš© ì–´ëŒ‘í„°<br />
2-2) Anthropic Messages API(MCP connector)ìš© ì–´ëŒ‘í„°<br />
2-3) MCP ë¯¸ì§€ì› í”„ë ˆì„ì›Œí¬ìš© â€œí”„ë¡œí† ì½œ ìœ ì§€â€ ëŒ€ì•ˆ: í•©ì„± í”„ë¡ì‹œ ì„œë²„(ì„ íƒ). íˆ´ë¡œ ê°ì‹¸ì§€ ì•Šê³ , í•˜ë‚˜ì˜ MCP ì„œë²„ë¡œ í”„ë¡ì‹œ ì œê³µ.</p>
  </li>
</ol>

<p>ì¶”ê°€ë¡œ 3ê°œ ì´ìƒ ì„œë²„ì¼ ë•Œì˜ ìˆ˜ëª…ì£¼ê¸°, ë™ì‹œì„±, ê³µìœ  ì „ëµê¹Œì§€ í¬í•¨í–ˆë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install mcp pydantic orjson "openai-agents[litellm]" requests</p>

<p>unified_mcp_pass_through.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">HttpUrl</span><span class="p">,</span> <span class="n">field_validator</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># 1) í†µì¼ í¬ë§·: MCP ì„œë²„ ì •ë³´ë¥¼ â€œê·¸ëŒ€ë¡œâ€ ë‹´ì•„ ì—ì´ì „íŠ¸ë¡œ ì „ë‹¬í•˜ê¸° ìœ„í•œ ëª¨ë¸
</span>
<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># í•„ìš”ì‹œ í™•ì¥
</span>
<span class="k">class</span> <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì—ì´ì „íŠ¸ì—ì„œ ë³´ì¼ ì„œë²„ ë¼ë²¨(ë„¤ì„ìŠ¤í˜ì´ìŠ¤)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># ê³µí†µ ì˜µì…˜
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span>
    <span class="n">cache_tools_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">non_empty</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">name must be non-empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="k">class</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedMCPServer</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">dup</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate server names: </span><span class="si">{</span><span class="n">dup</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">no MCP servers provided</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># ìµœì†Œ ê°€ë“œ: stdioë©´ command í•„ìˆ˜, sseë©´ url í•„ìˆ˜
</span>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2) ì–´ëŒ‘í„°ë“¤
# 2-1) OpenAI Agents Python SDK ì–´ëŒ‘í„°: ê·¸ëŒ€ë¡œ mcp_serversì— ê½‚ëŠ” íŒ©í† ë¦¬
</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span><span class="p">,</span> <span class="n">MCPServerStreamableHttp</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>

<span class="k">class</span> <span class="nc">OpenAIAgentsMCPAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">build_context_managers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">cms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerStdio</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">env</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerSse</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                    <span class="n">require_approval</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">require_approval</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerStreamableHttp</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                    <span class="n">require_approval</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">require_approval</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cms</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">cms</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">build_context_managers</span><span class="p">()</span>
        <span class="c1"># ì—¬ëŸ¬ context managerë¥¼ í•œ ë²ˆì— ì—´ê¸°
</span>        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncExitStackGroup</span><span class="p">(</span><span class="n">cms</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">PassThroughMCPAgent</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP ì„œë²„ì˜ íˆ´ì„ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">mcp_servers</span><span class="o">=</span><span class="n">opened</span><span class="p">,</span>                             <span class="c1"># í¬ì¸íŠ¸: ì„œë²„ë¥¼ 'ê·¸ëŒ€ë¡œ' ë„˜ê¹€
</span>                <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span>

<span class="c1"># ì—¬ëŸ¬ async context managerë¥¼ ë¬¶ì–´ ì—¬ë‹«ëŠ” ìœ í‹¸
</span><span class="k">class</span> <span class="nc">AsyncExitStackGroup</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cms</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cms</span> <span class="o">=</span> <span class="n">cms</span>
        <span class="n">self</span><span class="p">.</span><span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">opened</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="c1"># ì—­ìˆœìœ¼ë¡œ ì•ˆì „ ì¢…ë£Œ
</span>        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="nf">reversed</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c1"># 2-2) Anthropic Messages API(MCP connector) ì–´ëŒ‘í„°: payloadë§Œ ë§Œë“¤ì–´ ë°˜í™˜
# ì£¼ì˜: ì—¬ê¸°ì„œëŠ” ì‹¤ì œ í˜¸ì¶œê¹Œì§€ í•˜ì§€ ì•Šê³ , mcp_servers JSONì„ ë§Œë“¤ì–´ ëŒë ¤ì¤€ë‹¤.
# ë„ˆëŠ” ì´ JSONì„ ë°”ë¡œ API ë°”ë””ì— ë„£ìœ¼ë©´ ëœë‹¤.
</span>
<span class="k">class</span> <span class="nc">AnthropicMCPAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">to_messages_payload</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">mcp_servers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="c1"># Anthropic ì»¤ë„¥í„°ëŠ” ì›ê²©ë§Œ ì§ì ‘ ë¶™ì´ëŠ” íŒ¨í„´ì´ ì¼ë°˜ì ì´ë¯€ë¡œ, stdioëŠ” ë³´í†µ ë¶ˆê°€.
</span>                <span class="c1"># í•„ìš”í•˜ë©´ ë„ˆì˜ ì„œë²„ë¥¼ HTTPë¡œ ë…¸ì¶œí•´ì•¼ í•œë‹¤.
</span>                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: Anthropic payloadëŠ” stdioë¥¼ ì§ì ‘ ì „ë‹¬í•  ìˆ˜ ì—†ë‹¤. HTTP/SSEë¡œ ì „í™˜ í•„ìš”</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mcp_servers</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">authorization_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">tool_configuration</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">enabled</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_text</span><span class="p">}],</span>
            <span class="sh">"</span><span class="s">mcp_servers</span><span class="sh">"</span><span class="p">:</span> <span class="n">mcp_servers</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c1"># 2-3) MCP ë¯¸ì§€ì› í”„ë ˆì„ì›Œí¬ë¥¼ ìœ„í•œ â€œí”„ë¡œí† ì½œ ìœ ì§€â€ ëŒ€ì•ˆ: í•©ì„± í”„ë¡ì‹œ(ì„ íƒ)
# íˆ´ ë˜í•‘ ì—†ì´, ì—¬ëŸ¬ ìƒë¥˜ MCPë¥¼ í•˜ë‚˜ì˜ 'ê°€ì§œ MCP ì„œë²„'ë¡œ ë…¸ì¶œ.
# ì—ì´ì „íŠ¸ëŠ” MCP í•œ ëŒ€ë§Œ ë³¸ë‹¤. ë‚´ë¶€ì—ì„œ list_tools/ call_toolë¥¼ ì„œë²„ë³„ë¡œ í”„ë¡ì‹œ.
# ê°„ë‹¨ ë²„ì „(ê°œë… ì½”ë“œ): ì‹¤ì œ MCP ì„œë²„ ìŠ¤í™ì— ë§ì¶˜ ì™„ì„± ì„œë²„ëŠ” ë³„ë„ êµ¬í˜„ í•„ìš”.
</span>
<span class="k">class</span> <span class="nc">CompositeMCPProxy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì•„ì´ë””ì–´: upstream ì—¬ëŸ¬ MCP ì„¸ì…˜ì— ë¶™ì–´, ì™¸ë¶€ì—ëŠ” ë‹¨ì¼ MCP ì„œë²„ì²˜ëŸ¼ ë™ì‘.
    - list_tools: ëª¨ë“  upstreamì—ì„œ íˆ´ì„ ê¸ì–´ namespaced ì´ë¦„(server:tool)ìœ¼ë¡œ í•©ì³ ë°˜í™˜
    - call_tool: </span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">ì„ íŒŒì‹±í•´ í•´ë‹¹ upstreamì— ìœ„ì„
    ì´ í´ë˜ìŠ¤ ìì²´ëŠ” í”„ë¡œí† ì½œ ì²˜ë¦¬(transport)ëŠ” ìƒëµí•˜ê³ , ì½œë°± í˜•íƒœë§Œ ì œê³µ.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># upstream ì—°ê²°ë§Œ ë‹´ë‹¹(í”„ë¡ì‹œ ì„œë²„ë¡œ ê³µê°œí•˜ë ¤ë©´ ë³„ë„ transport/ì„œë²„ êµ¬í˜„ í•„ìš”)
</span>        <span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
        <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
            <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse í•„ìš”</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># í•„ìš”í•˜ë©´ streamable-http ë“± ì¶”ê°€
</span>                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unsupported kind for proxy: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">tr</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">sess</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_all_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">server</span><span class="p">][</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">packed</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

<span class="c1"># 3) ì‚¬ìš© ì˜ˆì‹œ
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">demo_openai_agents</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">servers</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span>  <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}),</span>
    <span class="p">])</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="nc">OpenAIAgentsMCPAdapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">run_once</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="sh">"</span><span class="s">filesì™€ db, search MCPë¥¼ ì ì ˆíˆ ì‚¬ìš©í•´ sales.csvì˜ í†µì°°ì„ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">demo_anthropic_payload</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">servers</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">git</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.git.example/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer Y</span><span class="sh">"</span><span class="p">}),</span>
    <span class="p">])</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="nc">AnthropicMCPAdapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">).</span><span class="nf">to_messages_payload</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">claude-3-7-sonnet</span><span class="sh">"</span><span class="p">,</span> <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">ë‘ MCPë¥¼ í™œìš©í•´ì„œ ë¦¬í¬íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="n">OPT_INDENT_2</span><span class="p">).</span><span class="nf">decode</span><span class="p">())</span>

<span class="c1"># ë©”ì¸
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">asyncio</span>
    <span class="kn">from</span> <span class="n">contextlib</span> <span class="kn">import</span> <span class="n">suppress</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">demo_openai_agents</span><span class="p">())</span>
    <span class="k">with</span> <span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
        <span class="nf">demo_anthropic_payload</span><span class="p">()</span>
</code></pre></div></div>

<p>ì–´ë–»ê²Œ ì“°ë©´ ë˜ë‚˜ ë‹¨ê³„ë³„ ìš”ì•½</p>

<ol>
  <li>
    <p>UnifiedMCPConfigì— 3ê°œ ì´ìƒ MCP ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë‚˜ì—´í•œë‹¤. stdioë©´ command/args, sseë©´ url/headersë§Œ ì±„ìš°ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>OpenAI Agentsë¥¼ ì“¸ ë•ŒëŠ” OpenAIAgentsMCPAdapterë¡œ context managerë“¤ì„ ë§Œë“¤ì–´ Agent(mcp_servers=[â€¦])ì— ê½‚ëŠ”ë‹¤. ì´ íë¦„ì€ MCP íˆ´ì„ â€œë˜í•‘í•˜ì§€ ì•Šê³ â€ ì„œë²„ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•œë‹¤.</p>
  </li>
  <li>
    <p>Anthropic Messages APIë¥¼ ì“¸ ë•ŒëŠ” AnthropicMCPAdapterê°€ messages.create ë°”ë””ì— ë„£ì„ mcp_servers JSONì„ ìƒì„±í•´ì¤€ë‹¤. stdioëŠ” ì›ê²© ê³µê°œê°€ ì•„ë‹ˆë©´ ë°”ë¡œ ë¶™ì¼ ìˆ˜ ì—†ìœ¼ë‹ˆ SSE/HTTPë¡œ ë…¸ì¶œí•´ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>MCP ë¯¸ì§€ì› í”„ë ˆì„ì›Œí¬ì—ëŠ” CompositeMCPProxy ê°™ì€ ë°©ì‹ìœ¼ë¡œ â€œMCP í”„ë¡œí† ì½œì€ ìœ ì§€â€í•œ ì±„ í•©ì„± ì„œë²„ë¥¼ í•˜ë‚˜ ë„ìš°ëŠ” ì„ íƒì§€ê°€ ìˆë‹¤. ì´ê±´ íˆ´ ë˜í•‘ì´ ì•„ë‹ˆë¼ â€œMCP ì„œë²„ë¥¼ í•˜ë‚˜ ë” ì œê³µâ€í•˜ëŠ” ë°©ì‹ì´ë¼ ë„¤ ì¡°ê±´ê³¼ ì–´ê¸‹ë‚˜ì§€ ì•ŠëŠ”ë‹¤.</p>
  </li>
</ol>

<p>3ê°œ ì´ìƒ ì„œë²„ì—ì„œì˜ ì‹¤ë¬´ ì²´í¬<br />
íˆ´ ê³¼ì ì¬ ë°©ì§€. Agentì— ë„˜ê¸¸ ë•Œ ì„œë²„ë¥¼ ì „ë¶€ ì£¼ë˜, ëª¨ë¸ í”„ë¡¬í”„íŠ¸ì— â€œì´ëŸ° ì‘ì—…ì—ëŠ” filesë§Œ, ìš”ì•½ì€ dbë§Œâ€ ê°™ì€ ì§€ì¹¨ì„ í•œ ì¤„ ë„£ëŠ” ê²ƒë§Œìœ¼ë¡œë„ í˜¼ì„ ì´ ì¤„ì–´ë“ ë‹¤.<br />
ì„¸ì…˜/ìì› ê´€ë¦¬. OpenAI Agents ì–´ëŒ‘í„°ëŠ” context managerê°€ ì¢…ë£Œ ì‹œ ìë™ ì •ë¦¬ë¥¼ ìˆ˜í–‰í•œë‹¤. Anthropic ê²½ë¡œëŠ” ì›ê²© ì„œë²„ì´ë¯€ë¡œ ë³„ë„ ì„¸ì…˜ ì •ë¦¬ëŠ” í•„ìš” ì—†ë‹¤.<br />
ê¶Œí•œ ê²½ê³„. ì„œë¡œ ë‹¤ë¥¸ í…Œë„ŒíŠ¸ë‚˜ ìœ„í—˜ë„ë¥¼ ê°€ì§„ MCPëŠ” ì„œë²„ ë¼ë²¨ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ê³ , require_approval ì˜µì…˜ì„ â€œalways/autoâ€ë¡œ ë‘”ë‹¤(Hosted/ì›ê²©ì—ì„œ ì˜ë¯¸ ìˆìŒ).<br />
ë™ì‹œì„±Â·íƒ€ì„ì•„ì›ƒ. ì„œë²„ë³„ max_concurrency, request_timeout_secë¥¼ ë‹¤ë¥´ê²Œ ì£¼ì–´ ë³‘ëª©ì„ í”¼í•œë‹¤.</p>

<p>ì´ êµ¬ì„±ì€ â€œMCP ì„œë²„ ì •ë³´ë¥¼ ìˆëŠ” ê·¸ëŒ€ë¡œ ë„˜ê¸´ë‹¤â€ëŠ” ì›ì¹™ì„ ì§€í‚¤ë©´ì„œ, ì„œë¡œ ë‹¤ë¥¸ ì—ì´ì „íŠ¸ë“¤ì— ê°™ì€ ì •ë³´ë¥¼ ì¬ì‚¬ìš©í•˜ë„ë¡ í•´ì¤€ë‹¤. í•„ìš”í•œ í”„ë ˆì„ì›Œí¬ê°€ ë” ìˆìœ¼ë©´ ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ì–´ëŒ‘í„°ë¥¼ 20~30ì¤„ë¡œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p class="chat--user">

ê·¼ë° MCPë¥¼ ë³´ë‹ˆ ê·¸ëƒ¥ íˆ´ë§Œ ìˆëŠ”ê²Œ ì•„ë‹ˆë¼ Sampling, ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸°, í”„ë¡¬í”„íŠ¸ ë“±ë“± ìˆì–ì•„. ê·¸ê±¸ Chatì´ë‘ ì—°ë™í•  ìˆ˜ ìˆì„ê¹Œ

</p>

<p>ì¢‹ì•„, í•µì‹¬ì€ â€œMCPê°€ ì œê³µí•˜ëŠ” ê±´ íˆ´ë§Œì´ ì•„ë‹ˆë‹¤â€ëŠ” ì ì„ ì „ì œë¡œ, Sampling(ì„œë²„ê°€ ëª¨ë¸ í˜¸ì¶œì„ ìœ„ì„), ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸°(ask-user), í”„ë¡¬í”„íŠ¸/í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿(list/get) ê°™ì€ ì±„ë„ì„ Chat ë£¨í”„ì— ë¶™ì´ëŠ” ì–‡ì€ ì–´ëŒ‘í„° ë ˆì´ì–´ë¥¼ ì—¬ê¸°ì— ë”± ë§Œë“¤ì–´ë‘ëŠ” ê±°ë‹¤. ë˜í•‘ìœ¼ë¡œ íˆ´ë¡œ ë°”ê¾¸ì§€ ì•Šê³ , MCP ë©”íƒ€(í”„ë¡¬í”„íŠ¸/ìƒ˜í”Œë§/ì§ˆì˜)ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬Â·ì™•ë³µì‹œì¼œ ê²°í•©í•œë‹¤.</p>

<p>ì•„ë˜ ì„¤ê³„ì™€ ìŠ¤ìºí´ë”©ì€ ì´ì „ì— ë§Œë“  â€œë°±ì—”ë“œ ê°ˆì•„ë¼ìš°ê¸°(Chat Completions or OpenAI Agents)â€ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©´ì„œ, MCPì˜ ë„¤ ê°€ì§€ ë©´ì„ ëª¨ë‘ ì—°ë™í•œë‹¤.</p>

<ol>
  <li>
    <p>íˆ´: ê¸°ì¡´ê³¼ ë™ì¼, call_tool ë¼ìš°íŒ…</p>
  </li>
  <li>
    <p>í”„ë¡¬í”„íŠ¸: list_prompts/get_promptë¥¼ í†µí•´ ì‹œìŠ¤í…œ/ë„ìš°ë¯¸ ë©”ì‹œì§€ ì£¼ì…</p>
  </li>
  <li>
    <p>ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸°: MCPê°€ ì‚¬ìš©ì ì…ë ¥ì„ ìš”ì²­í•˜ë©´, Chat UIì— ì§ˆë¬¸ì„ ë„ìš°ê³  ë‹µì„ ë‹¤ì‹œ MCPì— ëŒë ¤ì¤Œ</p>
  </li>
  <li>
    <p>ìƒ˜í”Œë§: MCP ì„œë²„ê°€ â€œëª¨ë¸ í˜¸ì¶œì„ ëŒ€ì‹  í•´ë‹¬ë¼â€ê³  ìš”ì²­í•˜ë©´, í˜„ì¬ ë°±ì—”ë“œë¡œ ëŒ€ë¦¬ ìƒ˜í”Œë§ í›„ ê²°ê³¼ë¥¼ MCPì—ê²Œ ë°˜í™˜</p>
  </li>
</ol>

<p>ì•„ë˜ëŠ” ê·¸ëŒ€ë¡œ ë¶™ì´ëŠ” ìµœì†Œ ìŠ¤ìºí´ë”©ì´ë‹¤. MCP SDKì˜ ì¼ë¶€ APIëŠ” ì„œë²„ êµ¬í˜„/ë²„ì „ì— ë”°ë¼ ì°¨ì´ê°€ ìˆì–´ì„œ, í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ë¥¼ ë™ì ìœ¼ë¡œ ì²´í¬í•˜ë„ë¡ ë°©ì–´ì½”ë“œë¥¼ ë„£ì—ˆë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install mcp pydantic orjson requests "openai-agents[litellm]"</p>

<p>mcp_chat_bridge.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">################################################################################
# ê³µí†µ: Chat ë°±ì—”ë“œ(ë‘ ê°€ì§€ êµ¬í˜„: OpenAI í˜¸í™˜ Chat Completions, OpenAI Agents)
################################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">OpenAIChatBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">tools</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span><span class="p">;</span> <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

<span class="c1"># ì„ íƒ: OpenAI Agentsë¥¼ ë°±ì—”ë“œë¡œ ì“°ê³  ì‹¶ë‹¤ë©´ ì´ ì–´ëŒ‘í„°ë¥¼ ì‚¬ìš©
</span><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">FunctionTool</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">))</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># ë„êµ¬ëŠ” Agentì— ë“±ë¡í•˜ì§€ ì•Šê³ , í”„ë¡¬í”„íŠ¸ ê°•ì œ í¬ë§·ìœ¼ë¡œ tool_callsë¥¼ JSONìœ¼ë¡œ ë°›ëŠ” ì „ëµë„ ê°€ëŠ¥
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">ê°€ëŠ¥í•˜ë©´ JSONë§Œ ì¶œë ¥</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">txt</span><span class="p">}}]}</span>

<span class="c1">################################################################################
# MCP ì—°ê²°: ì—¬ëŸ¬ ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì´ê³ , í”„ë¡¬í”„íŠ¸/ìƒ˜í”Œë§/ì§ˆë¬¸ì„ ë¸Œë¦¿ì§€
################################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span> <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆ í•„ìš”</span><span class="sh">"</span><span class="p">)</span>
        <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>

<span class="c1">################################################################################
# ë¸Œë¦¿ì§€: MCPì˜ íˆ´/í”„ë¡¬í”„íŠ¸/ask-user/ìƒ˜í”Œë§ì„ Chat ë£¨í”„ì— ì ‘ì†
################################################################################
</span>
<span class="k">class</span> <span class="nc">MCPChatBridge</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span>
        <span class="n">chat_backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span>
        <span class="n">ask_user</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>     <span class="c1"># ì‚¬ìš©ìì—ê²Œ ì§ˆë¬¸ ë³´ì—¬ì£¼ê³  ì‘ë‹µ ë°›ëŠ” ì½œë°±
</span>        <span class="n">prompt_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">sampling_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c1"># ìƒ˜í”Œë§ ì˜µì…˜ ì •ê·œí™”
</span>    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">chat_backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ask_user</span> <span class="o">=</span> <span class="n">ask_user</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prompt_selector</span> <span class="o">=</span> <span class="n">prompt_selector</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sampling_policy</span> <span class="o">=</span> <span class="n">sampling_policy</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">opts</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)})</span>

        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MCPHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="k">return</span> <span class="n">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_list_all_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                    <span class="p">}</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_collect_prompts</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]:</span>
        <span class="c1"># ì„œë²„ë³„ í”„ë¡¬í”„íŠ¸ ëª©ë¡ ì·¨í•©. ì„¸ì…˜ì— list_prompts/get_prompt ê°€ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€.
</span>        <span class="n">collected</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">list_prompts</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">list_prompts</span><span class="sh">"</span><span class="p">)()</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># ê° í•­ëª©ë§ˆë‹¤ get_prompt(name)ë¡œ í…œí”Œë¦¿/ë©”ì‹œì§€ êµ¬ì„± ìš”ì†Œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤ëŠ” ê°€ì •(ì„œë²„ êµ¬í˜„ë§ˆë‹¤ ìƒì´)
</span>                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">prompts</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)})</span>
                    <span class="n">collected</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">collected</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_get_prompt_messages</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">server</span><span class="p">]</span>
        <span class="n">msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_prompt</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_prompt</span><span class="sh">"</span><span class="p">)(</span><span class="n">prompt_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># respê°€ messages ë¹„ìŠ·í•œ êµ¬ì¡°ë¼ê³  ê°€ì •í•˜ê³  í‘œì¤€í™”
</span>                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">))</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">msgs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_server_sampling</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        MCP ì„œë²„ê°€ </span><span class="sh">'</span><span class="s">ìƒ˜í”Œë§ ìš”êµ¬</span><span class="sh">'</span><span class="s">ë¥¼ ë³´ë‚´ëŠ” ìƒí™©ì„ ê°€ì •.
        request = {</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">:[...], </span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="s">:{...}} ê°™ì€ í˜•íƒœë¥¼ ì •ì±…ì— ë§ì¶° ë°±ì—”ë“œì— ëŒ€ë¦¬ í˜¸ì¶œ
        </span><span class="sh">"""</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">sampling_policy</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="c1"># request["messages"]ëŠ” OpenAI í¬ë§·ì„ ê°€ì •í•˜ê³  ê·¸ëŒ€ë¡œ ì „ë‹¬
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">([</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="o">**</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])],</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1"># í•„ìš”í•˜ë©´ ì˜¨ì „í•œ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ ëŒë ¤ì£¼ê±°ë‚˜, í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
</span>        <span class="n">content</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 1) ì„œë²„ë³„ í”„ë¡¬í”„íŠ¸ ëª©ë¡ì„ ëª¨ì•„ì„œ ì„ íƒ
</span>        <span class="n">base_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">)]</span>
        <span class="n">prompt_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_prompts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prompt_selector</span><span class="p">:</span>
            <span class="c1"># prompt_selectorëŠ” {server:[{name,desc},...]}ë¥¼ ë³´ê³  ì´ˆê¸° ë©”ì‹œì§€(ì˜ˆ: system í”„ë¡¬í”„íŠ¸ë“¤) ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜
</span>            <span class="n">injected</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prompt_selector</span><span class="p">(</span><span class="n">prompt_catalog</span><span class="p">)</span>
            <span class="n">base_messages</span> <span class="o">=</span> <span class="n">injected</span> <span class="o">+</span> <span class="n">base_messages</span>

        <span class="c1"># 2) MCP íˆ´ë“¤ì„ OpenAI tools í¬ë§·ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ë„˜ê¹€
</span>        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_list_all_tools</span><span class="p">()</span>

        <span class="c1"># 3) 1ì°¨ ëª¨ë¸ í˜¸ì¶œ
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">base_messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
        <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)))</span>

        <span class="c1"># 4) tool_calls ì²˜ë¦¬ ë£¨í”„ + ask-user + server-sampling í›… ì˜ˆì‹œ
</span>        <span class="c1"># ì‹¤ì œ ask/sampling ì´ë²¤íŠ¸ëŠ” ì„œë²„ê°€ ë³„ë„ íˆ´ë¡œ ë…¸ì¶œí•˜ê±°ë‚˜, resource/protocol í•„ë“œë¥¼ í†µí•´ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆë‹¤.
</span>        <span class="c1"># ì—¬ê¸°ì„œëŠ” ê´€ìŠµì ìœ¼ë¡œ ì´ë¦„ì„ ì¡ì•„ ì˜ˆì‹œë¥¼ ë³´ì¸ë‹¤.
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">tool_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># e.g., "files:read_csv" or "db:sql_summary" or "search:ask_user" ë“±
</span>                <span class="n">args_raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

                <span class="c1"># 4-a) ask-user íŒ¨í„´: íŠ¹ì • ì„œë²„ê°€ ì‚¬ìš©ì ì…ë ¥ì„ ë°›ì•„ë‹¬ë¼ê³  í•˜ëŠ” íˆ´ì„ ì œê³µí•œë‹¤ê³  ê°€ì •
</span>                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">:ask_user</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">ask.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">question</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì…ë ¥í•´ ì£¼ì„¸ìš”.</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">user_answer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">answer</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_answer</span><span class="p">})</span>
                    <span class="p">})</span>
                    <span class="k">continue</span>

                <span class="c1"># 4-b) server-side sampling: ì„œë²„ê°€ ëª¨ë¸ í˜¸ì¶œì„ ìœ„ì„í•˜ëŠ” íˆ´(ì˜ˆ: server:sample)ë¡œ êµ¬í˜„ë¼ ìˆë‹¤ê³  ê°€ì •
</span>                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">:sample</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">sample.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{}})</span>
                    <span class="n">sampling_out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_maybe_server_sampling</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">sampling_out</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="k">continue</span>

                <span class="c1"># 4-c) ì¼ë°˜ MCP íˆ´ í˜¸ì¶œ
</span>                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">namespaced tool required</span><span class="sh">"</span><span class="p">})})</span>
                    <span class="k">continue</span>
                <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">unknown server</span><span class="sh">"</span><span class="p">})})</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                    <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[]}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()})</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})})</span>

            <span class="c1"># 4-d) íˆ´ ê²°ê³¼ ì¬ì£¼ì…
</span>            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">tool_results</span><span class="p">:</span>
                <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">tr</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]))</span>
                <span class="c1"># ì¼ë¶€ ë°±ì—”ë“œ/ëª¨ë¸ì€ tool ë©”ì‹œì§€ì— name/tool_call_idë¥¼ ìš”êµ¬í•˜ë¯€ë¡œ,
</span>                <span class="c1"># OpenAIChatBackendë¥¼ ì§ì ‘ ì‚¬ìš©í•  ë•ŒëŠ” messagesì— dict ê·¸ëŒ€ë¡œ ë„£ëŠ” ê²½ë¡œë¥¼ ë”°ë¡œ ë‘ì–´ë„ ëœë‹¤.
</span>
            <span class="c1"># 4-e) ë‹¤ìŒ í„´ í˜¸ì¶œ
</span>            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">base_messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
            <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)))</span>

        <span class="c1"># 5) ìµœì¢… ë‹µë³€
</span>        <span class="k">return</span> <span class="n">base_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span>
</code></pre></div></div>

<p>ì–´ë–»ê²Œ ì“°ëŠ”ê°€ ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">ui_ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[QUESTION from MCP] </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># ì‹¤ì œ ì•±/UIì—ì„œëŠ” ëª¨ë‹¬Â·ì…ë ¥ì°½ìœ¼ë¡œ êµ¬í˜„
</span>    <span class="k">return</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">pick_prompts</span><span class="p">(</span><span class="n">prompt_catalog</span><span class="p">):</span>
    <span class="c1"># prompt_catalog: {server: [{name,description}, ...]}
</span>    <span class="c1"># ê°„ë‹¨ ì˜ˆì‹œ: files ì„œë²„ì— "analysis_default" í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì™€ systemì— ì‚½ì…
</span>    <span class="c1"># ì‹¤ì œë¡œëŠ” bridge._get_prompt_messages(server, prompt_name)ë¡œ ë©”ì‹œì§€ë¥¼ ë°›ì•„ prepend
</span>    <span class="k">return</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">ë„ˆëŠ” ì¡°ì‹¬ìŠ¤ëŸ½ê³  ì •í™•í•œ ë¶„ì„ê°€ë‹¤.</span><span class="sh">"</span><span class="p">)]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">]</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAIChatBackend</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPChatBridge</span><span class="p">(</span><span class="n">servers</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">ask_user</span><span class="o">=</span><span class="n">ui_ask_user</span><span class="p">,</span> <span class="n">prompt_selector</span><span class="o">=</span><span class="n">pick_prompts</span><span class="p">)</span> <span class="k">as</span> <span class="n">bridge</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bridge</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sh">"</span><span class="s">sales.csvë¥¼ ë¶„ì„í•˜ê³ , í•„ìš”í•œ ì¶”ê°€ ì •ë³´ê°€ ìˆìœ¼ë©´ ë¨¼ì € ë‚˜ì—ê²Œ ì§ˆë¬¸í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ANSWER ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸ ìš”ì•½<br />
ìƒ˜í”Œë§. ì„œë²„ê°€ â€œëª¨ë¸ í˜¸ì¶œì„ ëŒ€ë¦¬í•´ë‹¬ë¼â€ ìš”ì²­í•˜ë©´, í˜„ì¬ ì—°ê²°ëœ Chat ë°±ì—”ë“œë¡œ ê·¸ëŒ€ë¡œ ë¼ìš°íŒ…í•´ ê²°ê³¼ë¥¼ ëŒë ¤ì¤€ë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì„œë²„-ì£¼ë„ í”Œë¡œìš°ê¹Œì§€ ì—°ë™ëœë‹¤.<br />
ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸°. MCPê°€ ì‚¬ìš©ì ì…ë ¥ì´ í•„ìš”í•  ë•Œë¥¼ íˆ´ í˜¹ì€ ë³„ë„ ì‹œê·¸ë„ë¡œ ë…¸ì¶œí•˜ëŠ” íŒ¨í„´ì„ ì¡ê³ , ask_user ì½œë°±ìœ¼ë¡œ Chat UIì™€ ì™•ë³µí•œë‹¤. ëŸ¬ë„ˆë¥¼ ë‘ë”ë¼ë„ ë¡œì§ì€ ì½œë°± í•œ ì¤„ì´ë‹¤.<br />
í”„ë¡¬í”„íŠ¸. ì„œë²„ë³„ í”„ë¡¬í”„íŠ¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì¡°íšŒ(list/get)í•´ì„œ ì´ˆê¸° system ë©”ì‹œì§€ë¡œ ì£¼ì…í•œë‹¤. í”„ë¡¬í”„íŠ¸ê°€ íŒŒë¼ë¯¸í„°í™”ë˜ì–´ ìˆë‹¤ë©´ get_prompt(name, **kwargs) ì‹ìœ¼ë¡œ ë°›ì•„ ë©”ì‹œì§€ë¡œ ë³€í™˜í•œë‹¤.<br />
í˜¸í™˜ì„±. ê°™ì€ ë¸Œë¦¿ì§€ë¥¼ OpenAI Chat Completions, OpenAI Agents ì–´ëŠ ìª½ì—ë„ ê½‚ì„ ìˆ˜ ìˆë‹¤. Agentsë¥¼ ë°±ì—”ë“œë¡œ ì“¸ ë• JSON ê°•ì œ ì¶œë ¥ ê°™ì€ í”„ë¡¬í”„íŠ¸ ì „ëµì„ ì¨ë„ ë˜ê³ , í•„ìš”í•˜ë©´ Agentsì˜ FunctionToolì„ ë³‘í–‰í•´ì„œ ask-userë‚˜ samplingì„ ëª…ì‹œ íˆ´ë¡œ ë…¸ì¶œí•˜ëŠ” í•˜ì´ë¸Œë¦¬ë“œë„ ê°€ëŠ¥í•˜ë‹¤.<br />
3ê°œ ì´ìƒ ì„œë²„. ì„œë²„ ìˆ˜ì— ìƒê´€ì—†ì´ namespacing(server:tool) ë£°ì„ ìœ ì§€í•˜ê³ , í”„ë¡¬í”„íŠ¸Â·ì§ˆë¬¸Â·ìƒ˜í”Œë§ì€ ì„œë²„ ë¼ë²¨ê³¼ í•¨ê»˜ ë¡œê¹…í•´ ì¶”ì  ê°€ëŠ¥ì„±ì„ ë†’ì¸ë‹¤. ì„œë²„ë³„ íƒ€ì„ì•„ì›ƒ/ë™ì‹œì„±ì€ handle ë‹¨ì—ì„œ ê°œë³„ íŠœë‹í•˜ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.</p>

<p>ì´ë ‡ê²Œ í•˜ë©´ â€œíˆ´ë¡œ ë˜í•‘í•˜ì§€ ì•Šê³ â€ë„ MCPì˜ ë„“ì€ í‘œë©´ì (íˆ´Â·í”„ë¡¬í”„íŠ¸Â·ìƒ˜í”Œë§Â·ìœ ì €ì§ˆë¬¸)ì„ ë™ì¼ Chat ê²½í—˜ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì¼ ìˆ˜ ìˆë‹¤. ì‹¤ì œ ë„¤ ì„œë²„ì—ì„œ í”„ë¡¬í”„íŠ¸/ìƒ˜í”Œë§/askê°€ ì–´ë–¤ ì—”ë“œí¬ì¸íŠ¸/ì´ë²¤íŠ¸ë¡œ ë…¸ì¶œë˜ëŠ”ì§€ ì•Œë ¤ì£¼ë©´, ìœ„ ë¸Œë¦¿ì§€ì˜ í•´ë‹¹ í•¨ìˆ˜ë§Œ ë„ˆì˜ ìŠ¤í™ì— ë”± ë§ê²Œ êµ¬ì²´í™”í•´ ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì•„ë‹ˆ Elicitationì´ë¼ê³  ë”°ë¡œ ìˆëŠ”ë°

</p>

<p>ë§ì•„, MCPì—ëŠ” â€œElicitation(ì—˜ë¦¬ì‹œí…Œì´ì…˜)â€ì´ ë”°ë¡œ ìˆë‹¤. ìš”ì§€ëŠ” ì„œë²„ê°€ ì‘ì—… ë„ì¤‘ ì‚¬ìš©ìì—ê²Œ ì¶”ê°€ ì •ë³´ë¥¼ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ìš”ì²­í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê¸°ëŠ¥ì´ê³ , íˆ´ê³¼ëŠ” ë³„ê°œì˜ ì±„ë„ì´ë‹¤. ê²°ë¡ ë¶€í„° ë§í•˜ë©´ Chat ë£¨í”„ì— ê¹”ë”í•˜ê²Œ ì—°ë™í•  ìˆ˜ ìˆë‹¤. ì•„ë˜ì²˜ëŸ¼ â€œì§ˆë¬¸ ë¼ìš´ë“œíŠ¸ë¦½â€ì„ ë¸Œë¦¿ì§€ì— ë¼ìš°ë©´ ëœë‹¤. í•µì‹¬ í¬ì¸íŠ¸ì™€ ìµœì†Œ ì½”ë“œë¥¼ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•œë‹¤.</p>

<ol>
  <li>
    <p>ê°œë… ì •ë¦¬<br />
Elicitationì€ MCP ì„œë²„ê°€ ëŒ€í™” ë„ì¤‘ â€œì‚¬ìš©ìì—ê²Œ ì´ ì •ë³´ ì¢€ ë°›ì•„ì¤˜â€ë¼ê³  ìš”ì²­í•˜ëŠ” í‘œì¤€ ë©”ì»¤ë‹ˆì¦˜ì´ë‹¤. ìš”ì²­ì—ëŠ” í”„ë¡¬í”„íŠ¸ ë¬¸êµ¬ì™€ í•¨ê»˜ JSON ìŠ¤í‚¤ë§ˆê°€ ë”°ë¼ì˜¤ê³ , í´ë¼ì´ì–¸íŠ¸ëŠ” ê·¸ ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ì‚¬ìš©ì ì…ë ¥ì„ ë°›ì•„ ê²€ì¦í•œ ë’¤ ì„œë²„ì— ëŒë ¤ì¤€ë‹¤. 2025-06-18 ìŠ¤í™ì— ì •ì‹ í¬í•¨ë˜ì—ˆê³ , â€œíˆ´ ì‹¤í–‰ ì¤‘ê°„ì— ë¼ì–´ë“œëŠ” ì§ˆë¬¸â€ì„ ì•ˆì „í•˜ê³  êµ¬ì¡°í™”ëœ ë°©ì‹ìœ¼ë¡œ ë‹¤ë£¨ë ¤ëŠ” ëª©ì ì´ë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p>ì•„í‚¤í…ì²˜ ì„ íƒì§€<br />
A. í”„ë¡œí† ì½œ-ë„¤ì´í‹°ë¸Œ ì²˜ë¦¬: MCP í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì˜ Elicitation ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ ìˆ˜ì‹ í•´ UIë¡œ ë„ìš°ê³  ì‘ë‹µì„ ì„œë²„ì— ëŒë ¤ì¤€ë‹¤. Chat ëª¨ë¸ì€ â€œìµœì¢… ë‹µë³€ ìƒì„±â€ì— ì§‘ì¤‘í•˜ê³ , ì¶”ê°€ ì •ë³´ ìˆ˜ì§‘ì€ ë¸Œë¦¿ì§€ê°€ ë‹´ë‹¹í•œë‹¤.<br />
B. ëª¨ë¸-ì¤‘ê°œ ì²˜ë¦¬: Elicitationì„ â€œask_userâ€ ê°™ì€ íˆ´ë¡œë„ ë…¸ì¶œí•˜ëŠ” ì„œë²„ê°€ ìˆë‹¤ë©´, ê¸°ì¡´ tool_call ë£¨í”„ì— ì„ì–´ ì²˜ë¦¬í•´ë„ ëœë‹¤. í•˜ì§€ë§Œ ê¶Œì¥ë˜ëŠ” ë°©ì‹ì€ ìŠ¤í™ì— ë§ì¶˜ ë„¤ì´í‹°ë¸Œ ì²˜ë¦¬ë‹¤(ì§ˆë¬¸Â·ì‘ë‹µì´ ì¤‘ì²© íë¦„ì—ì„œë„ ì•ˆì •ì ). <a href="https://modelcontextprotocol.io/specification/draft/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a></p>
  </li>
  <li>
    <p>ë¸Œë¦¿ì§€ í™•ì¥ íŒ¨í„´<br />
ë„ˆì˜ ê¸°ì¡´ Chat ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°/ë¸Œë¦¿ì§€ì— ì•„ë˜ í›… ë‘ ê°œë§Œ ë”í•´ì£¼ë©´ ëœë‹¤.<br />
a) elicitation ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ UIë¡œ ì§ˆë¬¸ ë„ìš°ê¸° â†’ JSON ìŠ¤í‚¤ë§ˆ ê²€ì¦ â†’ ì„œë²„ì— ì œì¶œ<br />
b) ìƒ˜í”Œë§Â·í”„ë¡¬í”„íŠ¸Â·íˆ´ ë£¨í”„ì™€ ìì—°ìŠ¤ëŸ½ê²Œ ê³µì¡´í•˜ë„ë¡ ìˆœì„œ ì œì–´</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œëŠ” â€œê°œë…ì ìœ¼ë¡œ ì •í™•í•œ ë™ì‘ íë¦„â€ì„ ë³´ì—¬ì£¼ëŠ” ë¯¸ë‹ˆ ìŠ¤ìºí´ë”©ì´ë‹¤. MCP SDKì˜ ì„¸ë¶€ ë©”ì„œë“œëª…ì€ ë¦´ë¦¬ìŠ¤ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì´ë²¤íŠ¸ êµ¬ë…/ì‘ë‹µ ë¶€ë¶„ì€ ë„¤ SDK ë²„ì „ì— ë§ì¶° í•¨ìˆ˜ëª…ë§Œ ì¹˜í™˜í•˜ë©´ ëœë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install mcp jsonschema orjson requests</p>

<p>ì½”ë“œ ìŠ¤ë‹ˆí«: MCP Elicitation ë¸Œë¦¿ì§€ í›…</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="c1"># ê°€ì •: ì´ë¯¸ MCP ì„¸ì…˜ì„ ì—¬ëŸ¬ ê°œ ì—´ì–´ë†“ì•˜ê³ , handles = {server: session} í˜•íƒœë¡œ ë³´ìœ 
# ë˜í•œ ask_user ì½œë°±(UI ì…ë ¥)ê³¼ chat_backend(ë„¤ Chat ë˜ëŠ” Agent ë°±ì—”ë“œ)ê°€ ìˆë‹¤.
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_elicitation_loop</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]):</span>
    <span class="sh">"""</span><span class="s">
    í•œ MCP ì„¸ì…˜ì— ëŒ€í•´ ì„œë²„ê°€ ë³´ë‚´ëŠ” Elicitation ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë£¨í”„.
    SDKë§ˆë‹¤ ì´ë²¤íŠ¸ ìˆ˜ì‹  API ì´ë¦„ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì•„ë˜ </span><span class="sh">'</span><span class="s">await session.next_elicitation()</span><span class="sh">'</span><span class="s">ëŠ”
    ë„¤ê°€ ì“°ëŠ” SDKì˜ ì‹¤ì œ í˜¸ì¶œë¡œ ì¹˜í™˜í•˜ë©´ ëœë‹¤.
    </span><span class="sh">"""</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">next_elicitation</span><span class="p">()</span>  <span class="c1"># ì˜ˆì‹œ: {"id": "...", "message": "ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”", "schema": {...}}
</span>        <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>

        <span class="c1"># UIì— ì§ˆë¬¸ ë„ìš°ê³ , ìŠ¤í‚¤ë§ˆì— ë§ëŠ” dictë¡œ ì‘ë‹µ ë°›ê¸°
</span>        <span class="n">user_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c1"># ë¡œì»¬ì—ì„œ 1ì°¨ ê²€ì¦(ì„ íƒì´ì§€ë§Œ ê¶Œì¥)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="nf">validate</span><span class="p">(</span><span class="n">user_payload</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¬ì§ˆë¬¸
</span>            <span class="n">user_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">ask_user</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ì…ë ¥ í˜•ì‹ ì˜¤ë¥˜: </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s">ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”.</span><span class="sh">"</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
            <span class="nf">validate</span><span class="p">(</span><span class="n">user_payload</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c1"># ì„œë²„ì— ì œì¶œ(ì‹¤ì œ APIëª…/í•„ë“œëª…ì€ SDKì— ë§ì¶° ì¹˜í™˜)
</span>        <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">submit_elicitation</span><span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="n">user_payload</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_chat_with_elicitation</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">):</span>
    <span class="c1"># 1) ë³‘í–‰ìœ¼ë¡œ ê° ì„¸ì…˜ì˜ elicitation ë£¨í”„ë¥¼ ê°€ë™
</span>    <span class="n">loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">handle_elicitation_loop</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">))</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>

    <span class="c1"># 2) ëª¨ë¸ í˜¸ì¶œ ë£¨í”„(íˆ´/í”„ë¡¬í”„íŠ¸/ìƒ˜í”Œë§ ë“± ê¸°ì¡´ ì²˜ë¦¬ì™€ ë™ì¼)
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_text</span><span class="p">}]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># í•„ìš”í•˜ë©´ MCP list_toolsë¥¼ OpenAI tools í¬ë§·ìœ¼ë¡œ ë„£ê¸°
</span>
    <span class="c1"># ì²« í„´
</span>    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># tool_calls ì²˜ë¦¬(ìƒëµ) + ì¤‘ê°„ì— ì„œë²„ê°€ elicitationì„ ë³´ë‚¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë‹¤ìŒ í„´ ì „ì— ì ê¹ yield
</span>    <span class="c1"># ...
</span>    <span class="c1"># ë‹¤ìŒ í„´ ê³„ì†
</span>    <span class="c1"># ...
</span>
    <span class="c1"># 3) ì¢…ë£Œ ì‹œ elicitation ë£¨í”„ ì •ë¦¬
</span>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">loops</span><span class="p">:</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">t</span>
</code></pre></div></div>

<p>UI ì…ë ¥ ì½œë°± ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">ask_user_via_console</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[MCP ì§ˆë¬¸] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ìš”êµ¬ ìŠ¤í‚¤ë§ˆ: </span><span class="si">{</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; JSONìœ¼ë¡œ ì‘ë‹µ: </span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">ask_user_via_console</span><span class="p">(</span><span class="sh">"</span><span class="s">JSON íŒŒì‹± ì‹¤íŒ¨. ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”.</span><span class="sh">"</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì <br />
ìŠ¤í‚¤ë§ˆ ê²€ì¦. ì„œë²„ê°€ ìŠ¤í‚¤ë§ˆë¥¼ ì œê³µí•˜ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ jsonschemaë¡œ 1ì°¨ ê²€ì¦ì„ ëŒë¦¬ë©´ ì™•ë³µ íšŸìˆ˜ì™€ ì˜¤ë¥˜ê°€ ì¤„ì–´ë“ ë‹¤. ìŠ¤í™ì´ ê¶Œì¥í•˜ëŠ” ë³´ì•ˆÂ·í”„ë¼ì´ë²„ì‹œ ì •ì±…ë„ í•¨ê»˜ ì§€ì¼œë¼(ë¯¼ê°ì •ë³´ ìš”êµ¬ ê¸ˆì§€ ë“±). <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
ì¤‘ì²© ê°€ëŠ¥ì„±. Elicitationì€ ë‹¤ë¥¸ MCP ê¸°ëŠ¥(íˆ´, í”„ë¡¬í”„íŠ¸, ìƒ˜í”Œë§) ì•ˆìª½ì— ì¤‘ì²©ë˜ì–´ ë“±ì¥í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ Chat ë£¨í”„ì™€ ë³‘í–‰ ì‹¤í–‰í•˜ëŠ” íŒ¨í„´ì´ ì•ˆì „í•˜ë‹¤. <a href="https://modelcontextprotocol.io/specification/draft/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
í˜¸í™˜ì„±. MCPë¥¼ ì§ì ‘ ì§€ì›í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸/ì—ì´ì „íŠ¸(ì˜ˆ: ì¼ë¶€ IDE, ì¼ë¶€ Agents SDK)ëŠ” Elicitationì„ ë„¤ì´í‹°ë¸Œë¡œ ëœ¯ì–´ì„œ ë³´ì—¬ì¤„ ì˜ˆì •ì´ê±°ë‚˜ ì´ë¯¸ ì‹¤í—˜ ì¤‘ì´ë‹¤. í•˜ì§€ë§Œ ì„œë²„Â·SDKì— ë”°ë¼ ì´ë²¤íŠ¸/ë©”ì„œë“œëª…ì´ ë‹¤ë¥´ë¯€ë¡œ, ìœ„ ë£¨í”„ì˜ ë‘ í•¨ìˆ˜(next_elicitation, submit_elicitation) ìœ„ì¹˜ë§Œ ì‹¤ì œ SDK ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ë©´ ëœë‹¤. ê°œë…ê³¼ íë¦„ì€ ë™ì¼í•˜ë‹¤. <a href="https://github.com/anthropics/claude-code/issues/2799?utm_source=chatgpt.com">GitHub+1</a></p>

<p>OpenAI Agentsë‚˜ ì¼ë°˜ Chatê³¼ì˜ ê²°í•© ë°©ì‹ ìš”ì•½<br />
OpenAI Agentsë¥¼ ë°±ì—”ë“œ ëª¨ë¸ë¡œ ì“¸ ë•Œë„ ë™ì¼í•˜ë‹¤. â€œì—ì´ì „íŠ¸ì—ê²Œ MCP ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê²¨ì„œ ì—ì´ì „íŠ¸ê°€ íˆ´ í˜¸ì¶œì„ ì²˜ë¦¬â€í•˜ë„ë¡ ë‘˜ ìˆ˜ë„ ìˆì§€ë§Œ, Elicitationì€ í´ë¼ì´ì–¸íŠ¸(UI) ë ˆë²¨ì˜ ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ë¯€ë¡œ, ë¸Œë¦¿ì§€ì—ì„œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•´ UIì™€ ì™•ë³µ í›„ ê²°ê³¼ë¥¼ ì„œë²„ì— ì „ë‹¬í•˜ëŠ” í¸ì´ ì œì¼ ì˜ˆì¸¡ ê°€ëŠ¥í•˜ë‹¤.<br />
ì¼ë°˜ Chat Completions(with tools) ê²½ë¡œì—ì„œë„ ë§ˆì°¬ê°€ì§€ë‹¤. ëª¨ë¸ì€ ë‹µë³€/ê³„íšì— ì§‘ì¤‘ì‹œí‚¤ê³ , ì‚¬ìš©ì ì§ˆë¬¸ì€ ë¸Œë¦¿ì§€ê°€ ë‹´ë‹¹í•œë‹¤. í•„ìš”í•˜ë©´ Elicitationìœ¼ë¡œ ìˆ˜ì§‘ëœ ê°’ì„ ì‹œìŠ¤í…œ/ìœ ì € ë©”ì‹œì§€ë¡œë„ ì£¼ì…í•´ ë‹¤ìŒ í„´ ë‹µë³€ í’ˆì§ˆì„ ì˜¬ë¦´ ìˆ˜ ìˆë‹¤.</p>

<p>ì‹¤ì „ íŒ<br />
ì„œë²„ ìˆ˜ê°€ 3ê°œ ì´ìƒì´ë©´ ì„œë²„ ë¼ë²¨ì„ ì§ˆë¬¸ ë©”ì‹œì§€ì— ëª…ì‹œí•´ì¤€ë‹¤. ì˜ˆ: â€œ[files] ì–´ë–¤ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í• ê¹Œìš”?â€.<br />
ë¯¼ê°ì •ë³´ ê°€ë“œ. ìŠ¤í™ì´ ê¸ˆì§€í•˜ëŠ” ë‚´ìš©(ë¹„ë°€ë²ˆí˜¸/í† í° ë“±)ì€ ë¸Œë¦¿ì§€ì—ì„œ ì°¨ë‹¨í•˜ê³ , í—ˆìš© ëª©ë¡ë§Œ í†µê³¼ì‹œí‚¤ëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
UX. ìŠ¤í‚¤ë§ˆì— enum/formatì„ ì ê·¹ ì‚¬ìš©í•˜ê²Œ ì„œë²„ ìª½ì— ê¶Œì¥í•˜ë¼. í´ë¼ì´ì–¸íŠ¸ëŠ” enumì´ë©´ ë“œë¡­ë‹¤ìš´, format=emailì´ë©´ ì´ë©”ì¼ ì…ë ¥ UIì²˜ëŸ¼ ì¹œí™”ì ìœ¼ë¡œ ë Œë”ë§í•˜ê¸° ì‰½ë‹¤. <a href="https://medium.com/data-science-collective/a-practical-guide-to-mcp-elicitation-with-fastapi-fastmcp-65f57fd91896?utm_source=chatgpt.com">Medium</a></p>

<p>í•œ ì¤„ ê²°ë¡ <br />
Elicitationì€ MCPì˜ â€œì¸ê°„-ê°œì… í‘œì¤€ ì±„ë„â€ì´ê³ , íˆ´ê³¼ ë³„ê°œë¡œ Chat ë£¨í”„ì— ê¹¨ë—í•˜ê²Œ ë¶™ì¼ ìˆ˜ ìˆë‹¤. ìœ„ ë¸Œë¦¿ì§€ í›… ë‘ ê°œë§Œ ë„£ìœ¼ë©´, ëª¨ë¸-íˆ´-ì‚¬ìš©ì ì‚¼ì í˜‘ì—…ì´ ì•ˆì •ì ìœ¼ë¡œ ëˆë‹¤. ë„¤ê°€ ì“°ëŠ” MCP Python SDKì˜ ì •í™•í•œ elicitation API ì´ë¦„ì„ ì•Œë ¤ì£¼ë©´, next_elicitation/submit_elicitation ë¶€ë¶„ì„ í•´ë‹¹ ë²„ì „ì— ë”± ë§ì¶° ì¦‰ì‹œ ì¹˜í™˜í•´ ì¤€ë‹¤.</p>

<p class="chat--user">

ê·¼ë° MCP Server ë¼ê³  í´ë˜ìŠ¤ëª…ì„ í•˜ë‹ˆê¹ ì§„ì§œ ì„œë²„ ê°™ì´ ëŠê»´ì ¸ ë‹¤ë¥¸ ì´ë¦„ ì—†ì–´? ì´ê±´ ì„¤ì • ê°’ì— ê°€ê¹Œìš´ê±° ê°™ì€ë°

</p>

<p>ë§ì•„, â€œMCPServerâ€ë¼ê³  í•˜ë©´ ë„¤íŠ¸ì›Œí¬ ì„œë²„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì§ì ‘ ëŒë¦°ë‹¤ëŠ” ëŠë‚Œì´ ê°•í•˜ë‹¤. ì‹¤ì œ ë„¤ê°€ ë‹¤ë£¨ëŠ” ê±´ ì„¸ì…˜ì„ ì—´ ë•Œ í•„ìš”í•œ <strong>ì„¤ì • ì •ë³´(Descriptor, Config, Profile, Endpoint)</strong>ì— ê°€ê¹Œì›Œ.</p>

<p>ë³´í†µ ì´ëŸ° ê²½ìš° ë„¤ì´ë°ì„ ì´ë ‡ê²Œ ë°”ê¿” ì“°ë©´ ë” ìì—°ìŠ¤ëŸ½ë‹¤.</p>

<ul>
  <li>
    <p><strong>MCPServerConfig</strong> : ê°€ì¥ ì§ì„¤ì . ì„œë²„ì— ì ‘ì†í•˜ëŠ” ë° í•„ìš”í•œ ì„¤ì •ê°’ ë¬¶ìŒ.</p>
  </li>
  <li>
    <p><strong>MCPServerSpec</strong> : â€œì‚¬ì–‘/ìŠ¤í™â€ì´ë¼ëŠ” ì˜ë¯¸ë¡œ, ì„œë²„ë¥¼ ê¸°ìˆ í•˜ëŠ” ì„ ì–¸ì  ì •ë³´ë¼ëŠ” ë‰˜ì•™ìŠ¤.</p>
  </li>
  <li>
    <p><strong>MCPServerProfile</strong> : ì—¬ëŸ¬ í™˜ê²½(ê°œë°œ/ìš´ì˜/í…ŒìŠ¤íŠ¸)ì—ì„œ ì“°ì¼ ìˆ˜ ìˆëŠ” â€œí”„ë¡œí•„â€ì´ë¼ëŠ” í†¤.</p>
  </li>
  <li>
    <p><strong>MCPServerEndpoint</strong> : íŠ¹íˆ SSE/HTTP ì£¼ì†Œì²˜ëŸ¼ ì›ê²© ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì§€ì¹­í•  ë•Œ ì í•©.</p>
  </li>
  <li>
    <p><strong>MCPConnectionConfig</strong> : ì‹¤ì œë¡œëŠ” ì—°ê²° êµ¬ì„±ì— í•´ë‹¹í•œë‹¤ëŠ” ê±¸ ë¶„ëª…íˆ í•¨.</p>
  </li>
</ul>

<p>ë„¤ê°€ ë§Œë“  UnifiedMCPConfig ê°™ì€ ì»¨í…Œì´ë„ˆ ì•ˆì— ë“¤ì–´ê°ˆ ì›ì†Œë¼ë©´,</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MCPServerConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span> <span class="bp">...</span>
</code></pre></div></div>

<p>í˜¹ì€ ì¡°ê¸ˆ ë” ê°€ë³ê²Œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MCPServerSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span> <span class="bp">...</span>
</code></pre></div></div>

<p>ì •ë„ê°€ ê°€ì¥ ë¬´ë‚œí•˜ë‹¤.</p>

<p>ì •ë¦¬í•˜ìë©´: <strong>ì„œë²„(server)</strong>ë¼ëŠ” ë‹¨ì–´ ëŒ€ì‹  <strong>Config / Spec / Endpoint / Profile</strong> ê³„ì—´ì„ ë¶™ì—¬ì£¼ë©´ â€œì‹¤ì œ ì„œë²„ ê°ì²´â€ê°€ ì•„ë‹ˆë¼ â€œì ‘ì† ì„ ì–¸â€ì´ë¼ëŠ” ì˜ë¯¸ê°€ ëª…í™•í•´ì§„ë‹¤.</p>

<p>ë„ˆì˜ ì½”ë“œë² ì´ìŠ¤ì—ì„œ MCP ì„œë²„ë¥¼ ì‹¤ì œë¡œ êµ¬ë™í•˜ëŠ” ì±…ì„ì´ ì•„ë‹ˆë¼ <strong>ì—°ê²° ì •ë³´ë¥¼ ë‹´ëŠ” ë°ì´í„° ëª¨ë¸</strong> ì´ë¼ë©´, <code class="language-plaintext highlighter-rouge">MCPServerConfig</code>ê°€ ê°€ì¥ ì•ˆì „í•œ ì„ íƒì´ë‹¤.</p>

<p>ì›í•œë‹¤ë©´, ë„¤ê°€ ì§€ê¸ˆ ê°€ì§€ê³  ìˆëŠ” í´ë˜ìŠ¤ ì •ì˜ë¥¼ ë‚´ê°€ <code class="language-plaintext highlighter-rouge">MCPServerConfig</code> ì‹ìœ¼ë¡œ ë¦¬íŒ©í„°ë§í•´ì„œ ì „ì²´ ì½”ë“œ ìŠ¤ë‹ˆí«ì„ ë‹¤ì‹œ ì •ë¦¬í•´ì¤„ ìˆ˜ë„ ìˆì–´.</p>

<p class="chat--user">

MCPSpecì€ ì–´ë•Œ

</p>

<p>ì¢‹ë‹¤. MCPSpec ê´œì°®ë‹¤. ë‹¤ë§Œ â€œSpecâ€ì€ ì„ ì–¸ì Â·ë¶ˆë³€ ì„¤ì •ì´ë¼ëŠ” ë‰˜ì•™ìŠ¤ë¥¼ ì£¼ë‹ˆ, ëŸ°íƒ€ì„ ìƒíƒœ(ì„¸ì…˜, ìºì‹œ, ë™ì‹œì„± ì œì–´)ëŠ” ë‹¤ë¥¸ ì´ë¦„ì— ë‘ëŠ” ê±¸ ì¶”ì²œí•œë‹¤. ì •ë¦¬í•˜ë©´ ì´ë ‡ê²Œ ì“°ë©´ ê¹”ë”í•˜ë‹¤.</p>

<p>ê¶Œì¥ ì˜ë¯¸ êµ¬ë¶„</p>

<ul>
  <li>
    <p>MCPSpec: ì—°ê²°Â·ì¸ì¦Â·ì „ì†¡ë°©ì‹ ê°™ì€ ì„ ì–¸í˜• ìŠ¤í™. ì§ë ¬í™” ê°€ëŠ¥, ë¶ˆë³€ ì·¨ê¸‰.</p>
  </li>
  <li>
    <p>MCPHandle ë˜ëŠ” MCPSession: MCPSpecì„ ë°”íƒ•ìœ¼ë¡œ ì‹¤ì œ ì—°ê²°ì„ ì—° ë’¤ ê°–ê²Œ ë˜ëŠ” ëŸ°íƒ€ì„ ê°ì²´.</p>
  </li>
  <li>
    <p>MCPConfig: ì—¬ëŸ¬ MCPSpecì„ ë‹´ëŠ” ì»¨í…Œì´ë„ˆ.</p>
  </li>
</ul>

<p>ì‘ì€ ë¦¬íŒ©í„° ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì‚¬ëŒê³¼ ëª¨ë¸ì´ ë³´ëŠ” ë¼ë²¨</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># ì •ì±…/íŒíŠ¸(ìŠ¤í™ì´ë¯€ë¡œ ê¸°ë³¸ê°’ë§Œ ë³´ê´€)
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span>
    <span class="n">cache_tools_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">class</span> <span class="nc">MCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPSpec</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate names: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ëŸ°íƒ€ì„ ë¶„ë¦¬ íŒ¨í„´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">MCPSpec</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">open_handle</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">MCPSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">env</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># í•„ìš” ì‹œ http_streamable ë“± ì¶”ê°€
</span>        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unsupported kind: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span> <span class="k">await</span> <span class="n">s</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</code></pre></div></div>

<p>ì–´ëŒ‘í„°ì—ì„œì˜ ì‚¬ìš© ëŠë‚Œ</p>

<ul>
  <li>
    <p>OpenAI Agents ì–´ëŒ‘í„°: MCPSpec â†’ MCPServerStdio/MCPServerSse ìƒì„± ì‹œ ê·¸ëŒ€ë¡œ ë„˜ê¹€.</p>
  </li>
  <li>
    <p>Anthropic ì–´ëŒ‘í„°: MCPSpec(kind="sse"/"http_streamable")ë¥¼ mcp_servers í˜ì´ë¡œë“œë¡œ ì§ë ¬í™”.</p>
  </li>
</ul>

<p>ì¥ë‹¨ì  í•œì¤„ ìš”ì•½</p>

<ul>
  <li>
    <p>MCPSpecì€ â€œì§„ì§œ ì„œë²„â€ê°€ ì•„ë‹ˆë¼ â€œì ‘ì† ì„ ì–¸â€ì´ë¼ëŠ” ì˜ë„ê°€ ë¶„ëª…í•´ì ¸ ì˜¤í•´ê°€ ì¤„ê³ , í…ŒìŠ¤íŠ¸Â·ì§ë ¬í™”Â·ë²„ì „ê´€ë¦¬ë„ ì‰¬ì›Œì§„ë‹¤.</p>
  </li>
  <li>
    <p>ì„¸ì…˜Â·ë™ì‹œì„± ê°™ì€ ëŸ°íƒ€ì„ì€ Handle/Session ìª½ìœ¼ë¡œ ë¶„ë¦¬ë˜ë‹ˆ ì±…ì„ì´ ì„ ëª…í•´ì§„ë‹¤.</p>
  </li>
</ul>

<p>ê²°ë¡ <br />
MCPSpec ë„¤ì´ë° ì±„íƒ ì¶”ì²œ. ì´ë¯¸ ë§Œë“¤ì–´ë‘” ì½”ë“œì—ì„œ í´ë˜ìŠ¤ëª…ë§Œ ë°”ê¾¸ê³ , í•¸ë“¤(ì„¸ì…˜) ê³„ì¸µì„ ë¶„ë¦¬í•˜ë©´ ì§€ê¸ˆê¹Œì§€ì˜ ì–´ëŒ‘í„°/ë¸Œë¦¿ì§€ êµ¬ì¡°ì™€ë„ ì˜ ë§ë¬¼ë¦°ë‹¤.</p>

<p class="chat--user">

ì‘ ëŸ°íƒ€ì„ ì²˜ë¦¬ëŠ” ì•ˆí• ê±°ì•¼. MCPSpec // ToolSpec ì´ë ‡ê²Œ í• ê¹Œ í•˜ëŠ”ë° MCPConfig // ToolConfig ì´ê²Œ ë‚˜ìœ¼ë ¤ë‚˜ ì–´ë–»ê²Œ ìƒê°í•´

</p>

<p>ì¢‹ì•„, ëŸ°íƒ€ì„ì€ ì•ˆ ë‹¤ë£¬ë‹¤ê³  í–ˆìœ¼ë‹ˆ ì´ë¦„ì€ â€œë¬´ìŠ¨ ê°’ì„ ì„ ì–¸Â·ê¸°ìˆ í•´ ë‘ëŠ”ê°€â€ì—ë§Œ ë§ì¶”ë©´ ëœë‹¤. í•µì‹¬ì€ Specê³¼ Configê°€ ì£¼ëŠ” ë‰˜ì•™ìŠ¤ ì°¨ì´ë¥¼ ì˜ë„ëŒ€ë¡œ ì“°ëŠ” ê²ƒ.</p>

<p>ì •ì˜ ìš”ì•½<br />
Spec: ì¸í„°í˜ì´ìŠ¤Â·ìŠ¤í‚¤ë§ˆÂ·ë¶ˆë³€ì— ê°€ê¹Œìš´ ì„ ì–¸. ì—”ë“œí¬ì¸íŠ¸, íˆ´ ì‹œê·¸ë‹ˆì²˜, JSON ìŠ¤í‚¤ë§ˆ ê°™ì€ â€œê³„ì•½ì„œâ€.<br />
Config: ì‹¤í–‰ ë§¥ë½ì— ë§ì¶˜ ì„ íƒÂ·ì˜¤ë²„ë ˆì´. ì–´ë–¤ Specì„ ë…¸ì¶œí• ì§€, ë³„ì¹­, ê¸°ë³¸ ì˜µì…˜, ì¼œê¸°/ë„ê¸° ê°™ì€ â€œì •ì±…â€.</p>

<p>ê¶Œì¥ ë„¤ì´ë° ë§¤íŠ¸ë¦­ìŠ¤<br />
ë‹¨ì¼ ì„ ì–¸ ë‹¨ìœ„<br />
MCPSpec: MCP ì ‘ì† ì„ ì–¸. kind, url/command, headers ê°™ì€ ì—°ê²° ìŠ¤í™ê³¼ ë¼ë²¨, íƒœê·¸ ë“±.<br />
ToolSpec: íˆ´ ì„ ì–¸. name, description, parameters(JSON Schema), ìœ„í—˜ë„ í”Œë˜ê·¸ ë“±.</p>

<p>ì»¬ë ‰ì…˜ê³¼ ì •ì±…<br />
MCPConfig: ì—¬ëŸ¬ MCPSpecì„ ë‹´ê³ , í™˜ê²½ë³„ë¡œ enable/disableÂ·ë¼ë²¨Â·ìŠ¹ì¸ì •ì±… ë“± ì˜¤ë²„ë ˆì´.<br />
ToolConfig: ì—¬ëŸ¬ ToolSpecì— ëŒ€í•œ ì •ì±… ì˜¤ë²„ë ˆì´ì™€ ë…¸ì¶œ ê·œì¹™(í•„í„°ë§, ë³„ì¹­, ê¸°ë³¸ íŒŒë¼ë¯¸í„° ë“±).</p>

<p>ì¦‰, MCPSpec // ToolSpecì€ â€œìˆœìˆ˜ ì„ ì–¸â€, MCPConfig // ToolConfigëŠ” â€œì„ íƒê³¼ ì •ì±…â€ìœ¼ë¡œ ì—­í• ì„ ë¶„ë¦¬í•˜ë©´ ê¹”ë”í•˜ë‹¤.</p>

<p>ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ìµœì†Œ ëª¨ë¸ ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì‚¬ëŒ/ëª¨ë¸ì´ ë³¼ ë¼ë²¨, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í‚¤</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># ë©”íƒ€
</span>    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                             <span class="c1"># ì˜ˆ: "files:read_csv" ë˜ëŠ” "local.math_eval"
</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span>            <span class="c1"># JSON Schema
</span>    <span class="n">server_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>      <span class="c1"># MCP ë„¤ì„ìŠ¤í˜ì´ìŠ¤(ì˜ˆ: "files"). ë¡œì»¬ íˆ´ì´ë©´ None.
</span>    <span class="n">risk_level</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">med</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">low</span><span class="sh">"</span>
    <span class="n">default_dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>        <span class="c1"># name -&gt; on/off
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>         <span class="c1"># name -&gt; alias for UI/LLM
</span>    <span class="c1"># ê°„ë‹¨ ê²€ì¦
</span>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate MCP names</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ToolConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>        <span class="c1"># tool name -&gt; on/off
</span>    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>         <span class="c1"># tool name -&gt; alias
</span>    <span class="n">defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># tool name -&gt; default args
</span>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate tool names</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ì–´ëŒ‘í„°ëŠ” â€œëŸ°íƒ€ì„ ì—†ì´â€ ì •ì  ë³€í™˜ë§Œ í•˜ë©´ ëœë‹¤</p>

<p>OpenAI Chat Completions tools ë³€í™˜<br />
ToolSpec â†’ tools JSONìœ¼ë¡œ ì§ë ¬í™”</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tools_for_openai</span><span class="p">(</span><span class="n">tool_cfg</span><span class="p">:</span> <span class="n">ToolConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">aliases</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></div>

<p>Anthropic Messages APIìš© MCP ì„œë²„ í˜ì´ë¡œë“œ<br />
MCPSpec â†’ mcp_servers í•­ëª©ìœ¼ë¡œ ì§ë ¬í™”(SSE/HTTP ê³„ì—´ë§Œ)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mcp_servers_for_anthropic</span><span class="p">(</span><span class="n">mcp_cfg</span><span class="p">:</span> <span class="n">MCPConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># AnthropicëŠ” ì›ê²© URL íƒ€ì…ë§Œ ì§ì ‘ ë¶™ì¼ ìˆ˜ ìˆìŒ
</span>            <span class="k">continue</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">aliases</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">authorization_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_configuration</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">enabled</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<p>OpenAI Agents Python SDKìš© MCP ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì € ìƒì„±<br />
MCPSpec â†’ SDKì˜ MCPServerSse/MCPServerStdioë¡œ ë³€í™˜ì— í•„ìš”í•œ íŒŒë¼ë¯¸í„°ë§Œ ì¤€ë¹„<br />
ëŸ°íƒ€ì„ì€ ì•ˆ ë§Œë“¤ì§€ë§Œ, ì–´ëŒ‘í„°ê°€ ì–´ëŠ í´ë˜ìŠ¤ë¥¼ ì¨ì•¼ í•˜ëŠ”ì§€ ê²°ì •í•  ìˆ˜ ìˆë„ë¡ ì •ì  ë§¤í•‘ë§Œ ì±…ì„ì§€ê²Œ í•˜ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mcp_params_for_openai_agents</span><span class="p">(</span><span class="n">mcp_cfg</span><span class="p">:</span> <span class="n">MCPConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">env</span><span class="p">}})</span>
        <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">}})</span>
        <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">}})</span>
    <span class="k">return</span> <span class="n">params</span>
</code></pre></div></div>

<p>ì™œ ì´ë ‡ê²Œ ë‚˜ëˆ„ê¸¸ ê¶Œí•˜ëƒ<br />
MCPSpec / ToolSpecì€ ë¶ˆë³€ ê³„ì•½ì„œë‹¤. ì½”ë“œ ë¦¬ë·°Â·ë²„ì „ ê´€ë¦¬Â·í…ŒìŠ¤íŠ¸ ë”ë¸” ì‘ì„±ì´ ì‰½ë‹¤.<br />
MCPConfig / ToolConfigëŠ” í™˜ê²½ë³„ ì„¤ì •ê³¼ ì •ì±…ì„ ë‹´ì•„ ë°°í¬ íŒŒì´í”„ë¼ì¸ì—ì„œ ë°”ê¿”ì¹˜ìš°ê¸° ì¢‹ë‹¤. ìŠ¤í…Œì´ì§•ê³¼ í”„ë¡œë•ì…˜ì„ ì˜¤ë²„ë ˆì´ë¡œ êµ¬ë¶„í•˜ê¸° í¸í•˜ë‹¤.<br />
ì¶”í›„ ëŸ°íƒ€ì„ì„ ë¶™ì´ê³  ì‹¶ì–´ë„ ëª¨ë¸ì´ í”ë“¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤. Handle/Sessionì€ ë³„ íŒŒì¼ì—ì„œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p>ì‹¤ë¬´ íŒ<br />
Specì— version, tags, capabilities ê°™ì€ í•„ë“œë¥¼ ë‘ë©´ ë‚˜ì¤‘ì— í•„í„°ë§ì´ í¸í•˜ë‹¤(ì˜ˆ: tagê°€ readonlyì¸ MCPë§Œ ë…¸ì¶œ).<br />
ToolSpec.parametersëŠ” ë°˜ë“œì‹œ ì—„ê²©í•˜ê²Œ(required, enum, format, min/max) ê¸°ì…í•´ ëª¨ë¸ì˜ ì˜ëª»ëœ í˜¸ì¶œì„ ì¤„ì¸ë‹¤.<br />
Configì˜ aliasesëŠ” LLM í˜¼ë™ì„ ì¤„ì´ëŠ” ë° íš¨ê³¼ì ì´ë‹¤. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ê¸´ íˆ´ì€ ë³„ì¹­ì„ ì§§ê³  ëª…í™•í•˜ê²Œ.</p>

<p>ê²°ë¡ <br />
ë„¤ ëª©í‘œê°€ ì„ ì–¸ê°’ë§Œ ê´€ë¦¬í•˜ëŠ” ê±°ë¼ë©´ MCPSpec // ToolSpecë¡œ ê°€ëŠ” ê²Œ ë§ë‹¤. ì—¬ê¸°ì— í™˜ê²½Â·ì •ì±…ì„ ì–¹ëŠ” ìš©ë„ë¡œ MCPConfig // ToolConfigë¥¼ ì¶”ê°€í•˜ë©´ ìš´ì˜ ì¹œí™”ì ì´ë‹¤. í•œ ì¤„ ìš”ì•½ì€ ì´ê±°ë‹¤.<br />
Spec = ê³„ì•½, Config = ì„ íƒê³¼ ì •ì±….<br />
ë‘˜ ë‹¤ ì“°ë˜, ê°ì ì—­í• ì„ ë¶„ëª…íˆ ë‚˜ëˆ„ì.</p>

<p class="chat--user">

ê·¼ë° í´ë˜ìŠ¤ëª…ì„ McpSpec MCPSpec ì´ê±° ê³„ì† í—·ê°ˆë¦¼ 

</p>

<p>í—·ê°ˆë¦¬ëŠ” ê²Œ ì •ìƒì´ë‹¤. íŒŒì´ì¬ì—ì„œ ì•½ì–´ë¥¼ í´ë˜ìŠ¤ëª…ì— ë„£ì„ ë•Œ ì„ íƒì§€ëŠ” ë‘ ê°€ì§€ë¿ì´ë‹¤. í•˜ë‚˜ë§Œ ê³ ë¥´ê³  ëê¹Œì§€ ì¼ê´€í•˜ë©´ ëœë‹¤.</p>

<p>ê¶Œì¥ ê²°ë¡ <br />
McpSpecë¡œ í†µì¼í•˜ì. ì´ìœ ëŠ” ê°€ë…ì„±(ëŒ€ë¬¸ì ë©ì–´ë¦¬ ì¤„ì„), íƒ€ì´í•‘ í¸ì˜, ê·¸ë¦¬ê³  íŒŒì´ì¬ ìƒíƒœê³„ì—ì„œ HttpServer, XmlParserì²˜ëŸ¼ ì•½ì–´ë¥¼ ë‹¨ì–´ ì·¨ê¸‰í•˜ëŠ” ê´€ë¡€ê°€ ë„ë¦¬ ì“°ì´ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ëŸ¬ë©´ íŒ¨ë°€ë¦¬ë„ ìì—°ìŠ¤ëŸ½ê²Œ McpConfig, McpEndpoint, McpHandle ê°™ì€ ë¦¬ë“¬ì´ ëœë‹¤.</p>

<p>ë¹ ë¥¸ ê·œì¹™ ì„¸íŠ¸<br />
í´ë˜ìŠ¤: McpSpec, McpConfig, McpToolSpec, McpToolConfig<br />
ëª¨ë“ˆ íŒŒì¼: mcp_spec.py, mcp_config.py<br />
ë³€ìˆ˜/ë§¤ê°œë³€ìˆ˜: mcp_spec, mcp_config<br />
JSON í‚¤: snake_case ë©´ "mcp_spec", camelCaseë©´ "mcpSpec" (íŒ€ ì»¨ë²¤ì…˜ í•˜ë‚˜ë§Œ ì„ íƒ)<br />
ìƒìˆ˜: MCP_SPEC_DEFAULTSì²˜ëŸ¼ ì „ë¶€ ëŒ€ë¬¸ìë„ ê°€ëŠ¥í•˜ì§€ë§Œ í´ë˜ìŠ¤ëª…ê³¼ í˜¼ë™ë˜ë‹ˆ í”¼í•˜ëŠ” í¸ì´ ì¢‹ë‹¤</p>

<p>ì‘ê²Œ ë§›ë³´ê¸° ë¦¬íŒ©í„° ìŠ¤ë‹ˆí«</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_spec.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">McpSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ë¼ë²¨/ë„¤ì„ìŠ¤í˜ì´ìŠ¤</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate MCP names</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ë ˆê±°ì‹œ í˜¸í™˜ì´ í•„ìš”í•˜ë©´ í•œ ì¤„ë¡œ ë‹¤ë¦¬ ê±¸ì–´ë‘ë©´ ëœë‹¤</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì„ì‹œ í˜¸í™˜(í–¥í›„ ì œê±° ì˜ˆì •)
</span><span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">McpSpec</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>ë§Œì•½ íŒ€ì´ ì „í†µì ì¸ â€œì•½ì–´ëŠ” ì „ë¶€ ëŒ€ë¬¸ìâ€ë¥¼ ê³ ì§‘í•œë‹¤ë©´ MCPSpecë¡œ ê°€ë„ ëœë‹¤. ê·¸ ê²½ìš°ì—” ë¬¸ì„œÂ·ì½”ë“œ ì „ë°˜ì— ë™ì¼ ê·œì¹™ì„ ê°•ì œí•˜ì. ì˜ˆë¥¼ ë“¤ì–´ í´ë˜ìŠ¤ëŠ” MCPSpec/MCPEndpoint, ë³€ìˆ˜ëŠ” mcp_spec, íŒŒì¼ì€ mcp_spec.pyì²˜ëŸ¼ â€œí´ë˜ìŠ¤ë§Œ ALLCAPS+CapWords, ë‚˜ë¨¸ì§„ snake_caseâ€ë¡œ ì„ ì„ ê¸‹ëŠ” ì‹ì´ë‹¤. í•µì‹¬ì€ í˜¼ìš© ê¸ˆì§€ë‹¤.</p>

<p>í•œ ì¤„ ìš”ì•½<br />
íŒŒì´ì¬ í”„ë¡œì íŠ¸ë¼ë©´ McpSpec ê³„ì—´ì´ ëœ í—·ê°ˆë¦¬ê³  ì½ê¸° ì¢‹ë‹¤. íŒ€ í•©ì˜ë¡œ í•œ ìŠ¤íƒ€ì¼ë§Œ ë°•ê³ , í´ë˜ìŠ¤Â·ëª¨ë“ˆÂ·ë³€ìˆ˜Â·JSON í‚¤ì— ê°™ì€ ì›ì¹™ì„ ë°˜ë³µ ì ìš©í•˜ë©´ í˜¼ë€ì´ ì‚¬ë¼ì§„ë‹¤.</p>

<p class="chat--user">

StdioClientTransportë‘ SSEClientTransportê°€ ì—†ë‹¤ëŠ”ã„·

</p>

<p>ì¢‹ì•„, ì´ê±´ ë³´í†µ ë‹¤ìŒ ì„¸ ê°€ì§€ ê²½ìš° ì¤‘ í•˜ë‚˜ë‹¤. ì°¨ê·¼ì°¨ê·¼ ì •ë¦¬í•˜ê³ , ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” í˜¸í™˜ ì…°ì„(shim) ì½”ë“œê¹Œì§€ ë¶™ì¼ê²Œ.</p>

<ol>
  <li>
    <p>íŒ¨í‚¤ì§€/ë²„ì „ ë¬¸ì œ<br />
mcp Python SDKì˜ íŠ¸ëœìŠ¤í¬íŠ¸ ê²½ë¡œê°€ ë²„ì „ë³„ë¡œ ì¡°ê¸ˆ ë‹¬ë¼ì„œ, ë„¤ í™˜ê²½ì—ì„  <code class="language-plaintext highlighter-rouge">mcp.client.stdio</code> / <code class="language-plaintext highlighter-rouge">mcp.client.sse</code> ëª¨ë“ˆì´ ì—†ì„ ìˆ˜ ìˆë‹¤. ì„¤ì¹˜ê°€ ë‹¤ë¥´ê±°ë‚˜ êµ¬ë²„ì „ì¼ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.</p>
  </li>
  <li>
    <p>ì„ íƒì  ì˜ì¡´ì„± ë¯¸ì„¤ì¹˜<br />
SSE íŠ¸ëœìŠ¤í¬íŠ¸ëŠ” ì„ íƒ(extra)ë¡œ ë¶„ë¦¬ëœ ê²½ìš°ê°€ ìˆë‹¤. ì¦‰, ê¸°ë³¸ <code class="language-plaintext highlighter-rouge">pip install mcp</code>ë¡œëŠ” SSE í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ê³ , ì¶”ê°€ ì˜ì¡´ì„±ì„ ê¹”ì•„ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>ë‹¤ë¥¸ SDKë¥¼ ë³´ê³  ìˆë‹¤<br />
ì´ë¦„ì´ ë¹„ìŠ·í•œ í¬í¬/ë˜í¼(ì˜ˆ: ì˜ˆì „ model-context-protocol íŒ¨í‚¤ì§€)ë‚˜ í”„ë¡ì‹œ í´ë¼ì´ì–¸íŠ¸ë¥¼ ê¹”ì•„ ë‘ë©´ ê²½ë¡œê°€ ì–´ê¸‹ë‚œë‹¤.</p>
  </li>
</ol>

<p>í•´ê²° ìˆœì„œ í•œ ë²ˆì— ëë‚´ê¸°<br />
ì•„ë˜ ëª…ë ¹ìœ¼ë¡œ ë„¤ í™˜ê²½ì„ í‘œì¤€í™”í•´ë³´ì. ì‹¤íŒ¨í•˜ë©´ ë°”ë¡œ í˜¸í™˜ ì…°ì„ ì½”ë“œê°€ ë’¤ì— ìˆë‹¤.</p>

<p>1ë‹¨ê³„. ì„¤ì¹˜/ì—…ê·¸ë ˆì´ë“œ<br />
pip install -U mcp<br />
SSEê¹Œì§€ ì“¸ ê±°ë©´ ì•„ë˜ ë‘˜ ì¤‘ í™˜ê²½ì— ë§ê²Œ í•˜ë‚˜ë¥¼ ì‹œë„<br />
pip install -U "mcp[sse]"<br />
ë˜ëŠ”<br />
pip install -U httpx sse-starlette</p>

<p>2ë‹¨ê³„. ë²„ì „Â·ëª¨ë“ˆ í™•ì¸<br />
python - Â«'PY'<br />
import pkgutil, mcp, sys<br />
print("mcp version:", getattr(mcp, "<strong>version</strong> ", "unknown"))<br />
print("has mcp.client.stdio:", pkgutil.find_loader("mcp.client.stdio") is not None)<br />
print("has mcp.client.sse:", pkgutil.find_loader("mcp.client.sse") is not None)<br />
print("has mcp.transport.stdio:", pkgutil.find_loader("mcp.transport.stdio") is not None)<br />
print("has mcp.transport.sse:", pkgutil.find_loader("mcp.transport.sse") is not None)<br />
PY</p>

<p>ì´ì œ ì–´ë–¤ ê²½ë¡œê°€ ìˆëŠ”ì§€ ì•Œì•˜ìœ¼ë‹ˆ, í˜¸í™˜ ì„í¬íŠ¸ ì…°ì„ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬í•˜ë©´ ëœë‹¤.</p>

<p>í˜¸í™˜ ì„í¬íŠ¸ ì…°ì„(ë‘˜ ì¤‘ ìˆëŠ” ê±¸ ìë™ìœ¼ë¡œ ì”€)<br />
ì´ ìŠ¤ë‹ˆí«ì„ ë„ˆì˜ ê³µí†µ ìœ í‹¸ì— ë„£ê³ , ë‚˜ë¨¸ì§€ ì½”ë“œì—ì„  í•­ìƒ ì—¬ê¸°ì„œ ì„í¬íŠ¸í•œ í´ë˜ìŠ¤ë¥¼ ì“°ë©´ ê²½ë¡œ ì°¨ì´ì— ì•ˆ í”ë“¤ë¦°ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_compat.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># stdio
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>  <span class="c1"># ì‹ í˜• ê²½ë¡œ
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.transport.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>  <span class="c1"># êµ¬í˜•/ë‹¤ë¥¸ ë¹Œë“œ
</span>    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">StdioClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>        <span class="n">StdioServerParameters</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>
<span class="c1"># sse
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>  <span class="c1"># ì‹ í˜• ê²½ë¡œ
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.transport.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>  <span class="c1"># êµ¬í˜•/ë‹¤ë¥¸ ë¹Œë“œ
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">SSEClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>
<span class="k">def</span> <span class="nf">have_stdio</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">StdioClientTransport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">StdioServerParameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">have_sse</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">SSEClientTransport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</code></pre></div></div>

<p>ì‚¬ìš© ì˜ˆì‹œ(ë„¤ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ, ë‹¨ ì„í¬íŠ¸ë§Œ ë°”ê¿ˆ)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´: from mcp.client.stdio import StdioClientTransport, StdioServerParameters
# ê¸°ì¡´: from mcp.client.sse import SSEClientTransport
</span><span class="kn">from</span> <span class="n">mcp_compat</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span><span class="p">,</span> <span class="n">SSEClientTransport</span><span class="p">,</span> <span class="n">have_stdio</span><span class="p">,</span> <span class="n">have_sse</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_stdio</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">have_stdio</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">STDIO transportê°€ ì´ í™˜ê²½ì— ì—†ìŠµë‹ˆë‹¤. mcp íŒ¨í‚¤ì§€ ë˜ëŠ” ë²„ì „ì„ í™•ì¸í•˜ì„¸ìš”.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}))</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">transport</span><span class="p">,</span> <span class="n">sess</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_sse</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">have_sse</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">SSE transportê°€ ì´ í™˜ê²½ì— ì—†ìŠµë‹ˆë‹¤. </span><span class="sh">'</span><span class="s">pip install </span><span class="se">\"</span><span class="s">mcp[sse]</span><span class="se">\"</span><span class="sh">'</span><span class="s"> ë˜ëŠ” httpx ê³„ì—´ì„ ì„¤ì¹˜í•˜ì„¸ìš”.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">transport</span><span class="p">,</span> <span class="n">sess</span>
</code></pre></div></div>

<p>ëŒ€ì²´ ê²½ë¡œê°€ ëª¨ë‘ ì—†ë‹¤ë©´<br />
OpenAI Agents Python SDKì˜ ë‚´ì¥ ì»¤ë„¥í„°ë¥¼ ì¨ì„œ íŠ¸ëœìŠ¤í¬íŠ¸ ë¬¸ì œë¥¼ ì•„ì˜ˆ ìš°íšŒí•  ìˆ˜ë„ ìˆë‹¤. ë„¤ê°€ â€œMCP ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê¸´ë‹¤â€ ì „ëµì„ ì“°ëŠ” ê²½ìš° íŠ¹íˆ ê°„ë‹¨í•˜ë‹¤. ì´ ê²½ë¡œì—ì„  íŒŒì´ì¬ì—ì„œ transportë¥¼ ì§ì ‘ ì„í¬íŠ¸í•˜ì§€ ì•ŠëŠ”ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search</span><span class="p">:</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">pass-through</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files</span><span class="p">,</span> <span class="n">search</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">((</span><span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">sales.csv í•©ê³„ë¥¼ êµ¬í•´ì¤˜</span><span class="sh">"</span><span class="p">)).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>ì •ë¦¬<br />
StdioClientTransport / SSEClientTransportê°€ â€œì—†ë‹¤â€ëŠ” ì—ëŸ¬ëŠ” ê±°ì˜ í•­ìƒ ëª¨ë“ˆ ê²½ë¡œ/ë²„ì „ ì°¨ì´ì—ì„œ ì˜¨ë‹¤. ìœ„ ì…°ì„ì„ ì“°ë©´ ì½”ë“œ í•œ ë²ˆìœ¼ë¡œ ì–‘ìª½ ê²½ë¡œë¥¼ ìë™ ì§€ì›í•  ìˆ˜ ìˆê³ , ê·¸ë˜ë„ ì•ˆ ë˜ë©´ Agents SDKì˜ ë‚´ì¥ MCP ì»¤ë„¥í„°ë¡œ íŠ¸ëœìŠ¤í¬íŠ¸ ê³„ì¸µì„ í†µì§¸ë¡œ ë§¡ê²¨ ë²„ë¦¬ëŠ” ê²ƒë„ ê¹”ë”í•œ í•´ê²°ì±…ì´ë‹¤.</p>

<p>ê³„ì† ì“°ëŠ” ìŠ¤íƒ€ì¼ì„ ì •ë¦¬í•˜ìë©´</p>

<ol>
  <li>
    <p>ì§ì ‘ SDKë¥¼ ì“¸ ê±°ë©´ mcp_compat.py ì…°ì„ìœ¼ë¡œ ê²½ë¡œ ì°¨ì´ë¥¼ í¡ìˆ˜</p>
  </li>
  <li>
    <p>ë¹ ë¥¸ í†µí•©ì´ë©´ Agents SDKì˜ MCPServerStdio/MCPServerSseë¥¼ ì‚¬ìš©</p>
  </li>
</ol>

<p>ì—¬ê¸°ê¹Œì§€ë¡œ ì•ˆ ì¡íˆë©´ ë„¤ <code class="language-plaintext highlighter-rouge">pip show mcp</code> ì¶œë ¥ê³¼ <code class="language-plaintext highlighter-rouge">python -c "import pkgutil; import mcp, sys; ..."</code> ê²°ê³¼ë¥¼ ì•Œë ¤ì¤˜. ê·¸ ì •ë³´ë¡œ ì •í™•í•œ ì„í¬íŠ¸ ê²½ë¡œë¥¼ ë”± ë§ì¶°ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ìŒ ê·¸ëƒ¥ FastMcp ì“°ëŠ”ê²Œ í¸í• ê²ƒ ê°™ë„¤. FastMCPì—ì„œ config = { 'mcpServers': { "weather": {"url": "https://weather-api.example.com/mcp"}, "assistant": {"command": "python", "args": ["./assistant_servers.py"]} } } client = Client(config) ë¥¼ í•˜ë©´ ë°”ë¡œ ë§Œë“¤ì–´ ì£¼ëŠ” ê²ƒ ê°™ê±°ë“ ? ê°ê°ì˜ McpSpecì—ì„œ ê°ê° í•œ ì¤„ì„ ë§Œë“œëŠ” í•¨ìˆ˜ ì‘ì„± + McpConfigì—ì„œ Config ìì²´ë¥¼ ë§Œë“œëŠ” í•¨ìˆ˜ ì‘ì„±í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„.

</p>

<p>ì¢‹ì•„, FastMCPë¥¼ ê¸°ì¤€ìœ¼ë¡œ â€œìŠ¤í™ â†’ í•œ ì¤„â€ê³¼ â€œìŠ¤í™ ëª¨ìŒ â†’ ìµœì¢… configâ€ë¥¼ ìë™ ìƒì„±í•˜ëŠ” ì–‡ì€ ë ˆì´ì–´ë¥¼ ë”± ë§Œë“¤ì–´ì¤„ê²Œ. ë„¤ê°€ ì›í•˜ëŠ” ê±´ ëŸ°íƒ€ì„ì´ ì•„ë‹ˆë¼ ì„ ì–¸ê°’ì´ë‹ˆ, McpSpecì€ ì„ ì–¸, McpConfigëŠ” ì»¬ë ‰ì…˜+ê²€ì¦+ì§ë ¬í™”ë§Œ ë§¡ëŠ”ë‹¤.</p>

<p>ì•„ë˜ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ë¶™ì—¬ ì“°ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_specs.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># FastMCP ê´€ì : ì›ê²©(url) ë˜ëŠ” ë¡œì»¬(stdio)
</span>
<span class="k">class</span> <span class="nc">McpSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">FastMCPì—ì„œ ì‚¬ìš©í•  ì„œë²„ ë¼ë²¨</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># url ì„œë²„
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># stdio ì„œë²„
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>           <span class="c1"># ì„ íƒ: í•„í„°ë§/ë¬¸ì„œí™”ì— ìœ ìš©
</span>    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>                       <span class="c1"># ì„ íƒ: ì‚¬ëŒ ì½ëŠ” ì„¤ëª…
</span>
    <span class="nd">@field_validator</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_name_non_empty</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">name must be non-empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">to_fastmcp_entry</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        FastMCP ì„¤ì •ì˜ </span><span class="sh">'</span><span class="s">í•œ ì¤„</span><span class="sh">'</span><span class="s">ì„ ë§Œë“ ë‹¤.
        ë°˜í™˜ ì˜ˆì‹œ:
          {</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">https://...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="s">: {...}}
          {</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="s">: [</span><span class="sh">"</span><span class="s">./server.py</span><span class="sh">"</span><span class="s">], </span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="s">: {...}}
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: url kind requires url</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">headers</span>
            <span class="k">return</span> <span class="n">entry</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio kind requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">command</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">args</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="k">return</span> <span class="n">entry</span>

        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: unknown kind </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">kind</span><span class="si">!r}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpSpec</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">dupes</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate spec names: </span><span class="si">{</span><span class="nf">sorted</span><span class="p">(</span><span class="n">dupes</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: url is required for kind=</span><span class="sh">'</span><span class="s">url</span><span class="sh">'"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: command is required for kind=</span><span class="sh">'</span><span class="s">stdio</span><span class="sh">'"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_fastmcp_config</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">exclude_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">enable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">name_alias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        FastMCPê°€ ë°”ë¡œ ë¨¹ëŠ” dictë¥¼ ë§Œë“ ë‹¤.
        ë°˜í™˜ ì˜ˆì‹œ:
          {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="s">: {...}, </span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="s">: {...}}}
        ì˜µì…˜:
          include_tags: ì§€ì •ëœ íƒœê·¸ê°€ í•˜ë‚˜ë¼ë„ ìˆëŠ” ìŠ¤í™ë§Œ í¬í•¨
          exclude_tags: ì§€ì •ëœ íƒœê·¸ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì œì™¸
          enable: {</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: True/False} í˜•íƒœì˜ on/off ì˜¤ë²„ë¼ì´ë“œ
          name_alias: {</span><span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">alias</span><span class="sh">"</span><span class="s">} í‚¤ ë³€ê²½(LLM/ì‚¬ëŒì—ê²Œ ë³´ì¼ ë¼ë²¨ ë°”ê¾¸ê¸°)
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">servers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">include_tags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">tags</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exclude_tags</span> <span class="ow">and</span> <span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">exclude_tags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">tags</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">enable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">enable</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">key</span> <span class="o">=</span> <span class="n">name_alias</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name_alias</span> <span class="k">else</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span>
            <span class="n">servers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="nf">to_fastmcp_entry</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">servers</span><span class="p">}</span>

    <span class="c1"># í¸ì˜: ì²´ì´ë‹ ë“±ë¡
</span>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">McpSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">McpConfig</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span>
</code></pre></div></div>

<p>ê°„ë‹¨ ì‚¬ìš© ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì˜ˆì‹œ 1) ì§ˆë¬¸ì—ì„œ ì¤€ configë¥¼ ì½”ë“œë¡œ ìƒì„±
</span><span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpSpec</span><span class="p">,</span> <span class="n">McpConfig</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="p">[</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]),</span>
<span class="p">])</span>

<span class="n">fastmcp_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">()</span>
<span class="c1"># fastmcp_config == {
#   "mcpServers": {
#     "weather": {"url": "https://weather-api.example.com/mcp"},
#     "assistant": {"command": "python", "args": ["./assistant_servers.py"]}
#   }
# }
</span>
<span class="c1"># FastMCP í´ë¼ì´ì–¸íŠ¸ì— ê·¸ëŒ€ë¡œ íˆ¬ì…
# from fastmcp import Client
# client = Client(fastmcp_config)
</span></code></pre></div></div>

<p>íƒœê·¸/ë³„ì¹­/ë¶€ë¶„ ì‚¬ìš© ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">().</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">readonly</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">public</span><span class="sh">"</span><span class="p">])</span>
<span class="p">).</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./db_server.py</span><span class="sh">"</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">MODE</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">prod</span><span class="sh">"</span><span class="p">},</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">write</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">internal</span><span class="sh">"</span><span class="p">])</span>
<span class="p">).</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">],</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">helper</span><span class="sh">"</span><span class="p">])</span>
<span class="p">)</span>

<span class="c1"># ì½ê¸° ì „ìš©ë§Œ í¬í•¨í•˜ê³ , weatherë¥¼ public-weatherë¡œ ë¼ë²¨ë§
</span><span class="n">fastmcp_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">(</span>
    <span class="n">include_tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">readonly</span><span class="sh">"</span><span class="p">],</span>
    <span class="n">name_alias</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">public-weather</span><span class="sh">"</span><span class="p">}</span>
<span class="p">)</span>
<span class="c1"># ê²°ê³¼:
# {"mcpServers": {"public-weather": {"url": "https://weather-api.example.com/mcp"}}}
</span></code></pre></div></div>

<p>ê²€ì¦ í¬ì¸íŠ¸ ìš”ì•½</p>

<ol>
  <li>
    <p>McpSpec.to_fastmcp_entryê°€ â€œurlâ€ê³¼ â€œstdioâ€ ì¼€ì´ìŠ¤ë¥¼ ê°ê° í•œ ì¤„ë¡œ ìƒì„±í•œë‹¤.</p>
  </li>
  <li>
    <p>McpConfig.to_fastmcp_configê°€ í•„í„°ë§ê³¼ on/off, ë³„ì¹­ì„ ì§€ì›í•œë‹¤.</p>
  </li>
  <li>
    <p>FastMCPì˜ Client(config) í˜¸ì¶œì— ë°”ë¡œ ë„£ì„ ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ë§Œë“ ë‹¤.</p>
  </li>
</ol>

<p>í™•ì¥ ì•„ì´ë””ì–´<br />
headers, envì— ë¹„ë°€ê°’ì´ ë“¤ì–´ê°€ë©´ McpConfigì—ì„œ ë³„ë„ ì‹œí¬ë¦¿ ì†ŒìŠ¤ë¡œ ë³‘í•©í•˜ëŠ” í›…ì„ ì¶”ê°€í•´ë„ ì¢‹ë‹¤.<br />
í…Œë„ŒíŠ¸ë³„ë¡œ enable dictë¥¼ ë°”ê¾¸ëŠ” ê²ƒë§Œìœ¼ë¡œ ë™ì¼ ìŠ¤í™ì—ì„œ ë‹¤ë¥¸ ë°°í¬ êµ¬ì„±ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.<br />
ë‚˜ì¤‘ì— Elicitation/Prompt ê°™ì€ ë©”íƒ€ê°€ í•„ìš”í•˜ë©´ McpSpecì— meta: Dict[str, Any] ì •ë„ë¥¼ ì¶”ê°€í•´ë„ ì§ë ¬í™” íë¦„ì—” ì˜í–¥ì´ ì—†ë‹¤.</p>

<p>ì´ë ‡ê²Œ ë‘ë©´ â€œê°ê°ì˜ McpSpecì—ì„œ ê°ê° í•œ ì¤„â€ê³¼ â€œMcpConfigì—ì„œ ìµœì¢… configâ€ê°€ ë‘˜ ë‹¤ í•œ ë²ˆì— í•´ê²°ëœë‹¤.</p>

<p class="chat--user">

ì•„ ê·¸ëŸ°ë° configê°€ ì—†ìœ¼ë©´ ì–´ë–»ê²Œ ë˜ì§€?

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸ë‹¤. â€œconfigê°€ ì—†ì„ ë•Œâ€ëŠ” ë‘ ê°€ì§€ë¥¼ ë¶„ë¦¬í•´ì„œ ìƒê°í•˜ë©´ ê¹”ë”í•˜ë‹¤.</p>

<ol>
  <li>FastMCP Client ë ˆë²¨ì—ì„œì˜ ê¸°ëŒ€ ë™ì‘<br />
ì¼ë°˜ì ìœ¼ë¡œ ClientëŠ” ìµœì†Œí•œ {"mcpServers": {}} í˜•íƒœì˜ ë”•ì…”ë„ˆë¦¬ë¥¼ ê¸°ëŒ€í•œë‹¤. ì™„ì „íˆ Noneì´ê±°ë‚˜ í‚¤ê°€ ì—†ìœ¼ë©´ ë‚´ë¶€ì—ì„œ KeyError/TypeError ë¥˜ê°€ ë‚  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤. ì•ˆì „í•˜ê²Œ ê°€ë ¤ë©´ ë‹¤ìŒì„ ì§€í‚¤ì.</li>
</ol>

<ul>
  <li>
    <p>ë¹„ì–´ ìˆì–´ë„ ëœë‹¤: ë¹ˆ ì„¤ì •ì€ ê³§ â€œì—°ê²°ëœ MCP ì„œë²„ ì—†ìŒâ€ì´ë‹ˆ, ClientëŠ” ëœ¨ì§€ë§Œ íˆ´ì€ ì—†ë‹¤.</p>
  </li>
  <li>
    <p>í‚¤ëŠ” ë°˜ë“œì‹œ ìˆì–´ì•¼ í•œë‹¤: {"mcpServers": {}} í˜•íƒœë¥¼ ë³´ì¥í•˜ì.</p>
  </li>
  <li>
    <p>ì˜ëª»ëœ í˜•íƒœëŠ” ë§‰ì: ë¬¸ìì—´ì´ë‚˜ ë¦¬ìŠ¤íŠ¸ ê°™ì€ íƒ€ì…ì´ ë“¤ì–´ê°€ë©´ ë°”ë¡œ ì˜ˆì™¸ë¥¼ ë˜ì§€ê²Œ í•˜ì.</p>
  </li>
</ul>

<ol>
  <li>ë„¤ ì„ ì–¸ ê³„ì¸µ(McpSpec / McpConfig)ì—ì„œì˜ ë°©ì–´ ì „ëµ<br />
ëŸ°íƒ€ì„ì„ ë‹¤ë£¨ì§€ ì•Šê¸°ë¡œ í–ˆìœ¼ë‹ˆ, ì„ ì–¸-ì§ë ¬í™” ë‹¨ê³„ì—ì„œ ë‹¤ìŒì˜ fallbacksë¥¼ ë‘ë©´ ì‹¤ì „ì—ì„œ í¸í•˜ë‹¤.</li>
</ol>

<ul>
  <li>
    <p>configê°€ Noneì´ë©´ ë¹ˆ êµ¬ì¡°ë¡œ ë§Œë“¤ì–´ ì¤€ë‹¤.</p>
  </li>
  <li>
    <p>mcpServers í‚¤ê°€ ì—†ìœ¼ë©´ ìƒì„±í•´ ì¤€ë‹¤.</p>
  </li>
  <li>
    <p>specsê°€ ë¹„ì–´ ìˆìœ¼ë©´ ë¹ˆ ë”•ì…”ë„ˆë¦¬ë¥¼ ë„£ë˜, ë¡œê±° ê²½ê³ ë¥¼ ë‚¨ê¸´ë‹¤.</p>
  </li>
  <li>
    <p>í™˜ê²½ë³€ìˆ˜ë‚˜ ê¸°ë³¸ íŒŒì¼ ê²½ë¡œì—ì„œ ìë™ìœ¼ë¡œ ëŒì–´ì˜¤ëŠ” ì„ íƒì§€ë¥¼ ë‘”ë‹¤(ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë¹ˆ dict).</p>
  </li>
</ul>

<p>ì•„ë˜ í—¬í¼ë¥¼ ë„£ìœ¼ë©´ ì‹¤ìˆ˜í•´ë„ ì•ˆì „í•˜ê²Œ ë™ì‘í•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_guard.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="c1"># ì´ì „ì— ë§Œë“  ì„ ì–¸ ëª¨ë¸ì´ë¼ê³  ê°€ì •
# from fastmcp_specs import McpSpec, McpConfig
</span>
<span class="k">def</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="sh">"</span><span class="s">McpSpec</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>     <span class="c1"># ë¬¸ìì—´ ì¸ìš©ì€ ìˆœí™˜ import íšŒí”¼ìš©
</span>    <span class="n">env_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">FASTMCP_SERVERS_JSON</span><span class="sh">"</span><span class="p">,</span>       <span class="c1"># ì˜µì…˜: {"weather":{"url":"..."}, "assistant":{...}} í˜•íƒœ
</span>    <span class="n">file_env_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">FASTMCP_CONFIG_PATH</span><span class="sh">"</span>    <span class="c1"># ì˜µì…˜: JSON íŒŒì¼ ê²½ë¡œ
</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    1ìˆœìœ„: ëª…ì‹œ config
    2ìˆœìœ„: specs â†’ {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: {...}} ì§ë ¬í™”
    3ìˆœìœ„: í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¡œë“œ
    4ìˆœìœ„: ë¹ˆ ì„¤ì •ìœ¼ë¡œ í´ë°±
    í•­ìƒ {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: dict} í˜•íƒœë¥¼ ë³´ì¥í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="c1"># 1) ëª…ì‹œ config
</span>    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">config must be a dict or None</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="c1"># ë¶€ë¶„ ì„¤ì •ë§Œ ì˜¨ ê²½ìš° ë³´ì™„
</span>            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)}</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="c1"># 2) specs â†’ ì§ë ¬í™”
</span>    <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpConfig</span>  <span class="c1"># ì§€ì—­ ì„í¬íŠ¸ë¡œ ìˆœí™˜ ì°¸ì¡° íšŒí”¼
</span>        <span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">()</span>

    <span class="c1"># 3) í™˜ê²½ë³€ìˆ˜: íŒŒì¼ ê²½ë¡œ ìš°ì„ 
</span>    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">file_env_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># íŒŒì¼ì´ {"mcpServers":{...}} í˜•íƒœì´ê±°ë‚˜ {"weather":{...}} ê°™ì€ ë§µì¼ ìˆ˜ë„ ìˆìŒ
</span>        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">file config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">file config must be a dict</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">env config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">env config must be a dict</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 4) ìµœì¢… í´ë°±: ë¹ˆ ì„¤ì •
</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
</code></pre></div></div>

<p>ì¦‰ì‹œ ì‚¬ìš© ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1) configê°€ Noneì¸ ìƒí™©
</span><span class="kn">from</span> <span class="n">fastmcp_guard</span> <span class="kn">import</span> <span class="n">ensure_fastmcp_config</span>
<span class="c1"># from fastmcp import Client
</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>  <span class="c1"># {"mcpServers": {}}
# client = Client(cfg)  # íˆ´ ì—†ì´ ì‹¤í–‰
</span>
<span class="c1"># 2) McpSpecë§Œ ìˆê³  configê°€ ì—†ëŠ” ìƒí™©
</span><span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpSpec</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]),</span>
<span class="p">]</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>
<span class="c1"># client = Client(cfg)
</span>
<span class="c1"># 3) í™˜ê²½ë³€ìˆ˜ë¡œë§Œ ê³µê¸‰í•˜ëŠ” ìƒí™©
# export FASTMCP_SERVERS_JSON='{"weather":{"url":"https://weather-api.example.com/mcp"}}'
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">()</span>
<span class="c1"># client = Client(cfg)
</span></code></pre></div></div>

<p>ìš´ì˜ íŒ í•œ ì¤„ ìš”ì•½<br />
ë¹ˆ ì„¤ì •ì€ í—ˆìš©í•˜ë˜ í˜•íƒœëŠ” í•­ìƒ ë³´ì¥í•˜ì. ì¦‰, ìµœì†Œ {"mcpServers": {}}ë¥¼ ë§Œë“¤ì–´ì„œ Clientê°€ ì•ˆì •ì ìœ¼ë¡œ ëœ¨ê²Œ í•˜ê³ , ì‹¤ì œ ì„œë²„ ì—†ìœ¼ë©´ â€œíˆ´ ì—†ìŒâ€ ìƒíƒœë¡œë§Œ ë™ì‘í•˜ê²Œ í•˜ëŠ” ê²Œ ì œì¼ ì•ˆì „í•˜ë‹¤. í•„ìš”í•˜ë©´ ensure_fastmcp_config ë‚´ë¶€ì— ë¡œê¹…ì„ ë„£ì–´ â€œí˜„ì¬ MCP ì„œë²„ 0ê°œâ€ ê°™ì€ ê²½ê³ ë¥¼ ë‚¨ê¸°ë©´ ì‹¤ìˆ˜ë„ ë¹¨ë¦¬ ì¡íŒë‹¤.</p>

<p class="chat--user">

ì´ë ‡ê²Œ ë§Œë“  FastMcp Clientì˜ íˆ´ê³¼ ë‚´ê°€ ë§Œë“  ì¼ë°˜ ToolSpecì„ ë‘˜ ë‹¤ ê³ ë ¤í•´ì„œ chat completions í˜¸ì¶œ -&gt; ê·¸ í›„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ ì‹¤í–‰ì„ ë§Œë“¤ê³  ì‹¶ì–´ async with Client(cfg) as client: client.list_tools() # mcp tool ë°˜í™˜ client.call_tool(í•¨ìˆ˜ëª…, ì¸ì) ì´ë ‡ê²Œ ì“¸ ìˆ˜ ìˆì–´. fastmcpëŠ” ì´ ë‘ ê°€ì§€ë¥¼ ì–´ë–»ê²Œ í•˜ë©´ ì˜ ì“°ê²Œ í•  ìˆ˜ ìˆì„ê¹Œ

</p>

<p>ì¢‹ì•„. ëª©í‘œëŠ” FastMCPì˜ íˆ´ë“¤ê³¼ ë„¤ê°€ ì§ì ‘ ì •ì˜í•œ ì¼ë°˜ ToolSpecë“¤ì„ â€œí•˜ë‚˜ì˜ íˆ´ ì„¸íŠ¸â€ì²˜ëŸ¼ ë¬¶ì–´ì„œ Chat Completions with toolsë¥¼ ëŒë¦¬ê³ , ëª¨ë¸ì´ ìš”ì²­í•œ tool_callsë¥¼ ê°ê° ì•Œë§ì€ ì‹¤í–‰ê¸°ë¡œ ë¼ìš°íŒ…í•˜ëŠ” ê²ƒ. ì•„ë˜ ìŠ¤ìºí´ë”©ì€ ê·¸ëŒ€ë¡œ ë¶™ì—¬ì„œ ëŒì•„ê°€ë„ë¡ ì„¤ê³„í–ˆë‹¤.</p>

<p>í•µì‹¬ ì•„ì´ë””ì–´</p>

<ol>
  <li>
    <p>FastMCPì˜ client.list_tools() ê²°ê³¼ë¥¼ OpenAI tools í¬ë§·ìœ¼ë¡œ ì •ê·œí™”í•˜ê³  ì´ë¦„ì— ì ‘ë‘ì‚¬ mcp:ë¥¼ ë¶™ì¸ë‹¤.</p>
  </li>
  <li>
    <p>ë„¤ ë¡œì»¬ ToolSpecë“¤ë„ ê°™ì€ í¬ë§·ìœ¼ë¡œ ì§ë ¬í™”í•œë‹¤.</p>
  </li>
  <li>
    <p>Chat Completions ì²« í˜¸ì¶œì— ë‘ ì¢…ë¥˜ íˆ´ì„ ëª¨ë‘ ë„£ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>tool_calls ë£¨í”„ì—ì„œ ì´ë¦„ì´ mcp:ë©´ client.call_toolë¡œ, ì•„ë‹ˆë©´ LocalToolRegistry í•¸ë“¤ëŸ¬ë¡œ ì‹¤í–‰í•œë‹¤.</p>
  </li>
</ol>

<p>ì½”ë“œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># unified_fastmcp_chat.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="c1">###############################################################################
# 0) ë¡œì»¬ ToolSpec ì •ì˜(í•œ ë²ˆë§Œ êµ¬í˜„í•´ì„œ ê³µí†µ ì‚¬ìš©)
###############################################################################
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">LocalToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate tool: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_openai_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">.</span><span class="nf">values</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# 1) FastMCP â†’ OpenAI tools ì •ê·œí™”
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    FastMCP client.list_tools()ë¥¼ í˜¸ì¶œí•´ OpenAI tools í¬ë§·ìœ¼ë¡œ ë³€í™˜.
    ê° ì´ë¦„ì—ëŠ” </span><span class="sh">'</span><span class="s">mcp:</span><span class="sh">'</span><span class="s"> ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ ë¡œì»¬ íˆ´ê³¼ ì¶©ëŒì„ ë°©ì§€.
    FastMCP íˆ´ ë©”íƒ€ëŠ” ë‹¤ìŒ í•„ë“œë¥¼ ê°€ì§„ë‹¤ê³  ê°€ì •: name, description, parameters(JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">def</span> <span class="nf">is_mcp_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">strip_mcp_prefix</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tool_name</span><span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span> <span class="k">if</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">else</span> <span class="n">tool_name</span>

<span class="c1">###############################################################################
# 2) Chat Completions í˜¸ì¶œ ëŸ¬ë„ˆ(ë‘ íˆ´ ì„¸íŠ¸ë¥¼ í•œêº¼ë²ˆì— ë…¸ì¶œ)
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">local_registry</span><span class="p">:</span> <span class="n">LocalToolRegistry</span><span class="p">,</span>
        <span class="n">fastmcp_client</span><span class="p">,</span>
        <span class="n">expose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 1) íˆ´ ì¹´íƒˆë¡œê·¸ í•©ì¹˜ê¸°
</span>        <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">fastmcp_client</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">local_tools</span> <span class="o">=</span> <span class="n">local_registry</span><span class="p">.</span><span class="nf">list_openai_tools</span><span class="p">()</span>
        <span class="n">all_tools</span> <span class="o">=</span> <span class="n">local_tools</span> <span class="o">+</span> <span class="n">mcp_tools</span>
        <span class="k">if</span> <span class="n">expose</span><span class="p">:</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="nf">expose</span><span class="p">(</span><span class="n">all_tools</span><span class="p">)</span>  <span class="c1"># í„´ë³„ ì†Œì¶œ ì •ì±…(ì„ íƒ)
</span>
        <span class="c1"># 2) 1ì°¨ ëª¨ë¸ í˜¸ì¶œ
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 3) tool_calls ë£¨í”„
</span>        <span class="n">rounds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">rounds</span> <span class="o">&lt;</span> <span class="n">max_rounds</span><span class="p">:</span>
            <span class="n">rounds</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw</span><span class="p">}</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nf">is_mcp_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">):</span>
                        <span class="c1"># FastMCP ê²½ë¡œ
</span>                        <span class="n">mcp_name</span> <span class="o">=</span> <span class="nf">strip_mcp_prefix</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fastmcp_client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">mcp_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ë¡œì»¬ íˆ´ ê²½ë¡œ
</span>                        <span class="n">spec</span> <span class="o">=</span> <span class="n">local_registry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span>
                <span class="p">})</span>

            <span class="c1"># ë‹¤ìŒ í„´
</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# 3) ì‚¬ìš© ì˜ˆì‹œ
###############################################################################
</span>
<span class="c1"># ì˜ˆì‹œ ë¡œì»¬ íˆ´ êµ¬í˜„
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) FastMCP í´ë¼ì´ì–¸íŠ¸ ì¤€ë¹„
</span>    <span class="c1"># from fastmcp import Client
</span>    <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">},</span>
            <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># async with Client(cfg) as client:
</span>    <span class="c1">#     ...
</span>
    <span class="c1"># ë°ëª¨ë¥¼ ìœ„í•´ ê°„ì´ ë”ë¯¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ í‰ë‚´ë‚´ì. ì‹¤ì œë¡œëŠ” fastmcp.Clientë¥¼ ì‚¬ìš©.
</span>    <span class="k">class</span> <span class="nc">DummyFastMCP</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">self</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
            <span class="c1"># ì´ë¦„ì€ ì„œë²„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í¬í•¨í•´ì£¼ë©´ LLMì´ ë” ì˜ ê³ ë¥¸ë‹¤
</span>            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">weather:get_forecast</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë„ì‹œ/ë‚ ì§œë³„ ì¼ê¸°ì˜ˆë³´</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">}},</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">]</span>
                <span class="p">}},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant:read_csv_sum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CSV í•©ê³„ ê³„ì‚°</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">]</span>
                <span class="p">}}</span>
            <span class="p">]</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="c1"># ì—¬ê¸°ì„œëŠ” ê²°ê³¼ í˜•íƒœë§Œ ë§ì¶°ì¤€ë‹¤
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo-result</span><span class="sh">"</span><span class="p">}</span>

    <span class="c1"># 1) ë¡œì»¬ íˆ´ ë ˆì§€ìŠ¤íŠ¸ë¦¬
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolRegistry</span><span class="p">()</span>
    <span class="n">local</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚°</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
        <span class="n">handler</span><span class="o">=</span><span class="n">math_eval</span>
    <span class="p">))</span>

    <span class="c1"># 2) ëŸ¬ë„ˆ
</span>    <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 3) í†µí•© ì‹¤í–‰
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">í•„ìš”í•œ ë„êµ¬ë§Œ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_run ìš°ì„ .</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant:read_csv_sumìœ¼ë¡œ data/sales.csv í•©ê³„ë¥¼ êµ¬í•˜ê³ , local.math_evalë¡œ (100+23)ë„ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">async</span> <span class="k">with</span> <span class="nc">DummyFastMCP</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">local_registry</span><span class="o">=</span><span class="n">local</span><span class="p">,</span> <span class="n">fastmcp_client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== FINAL ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ìš´ì˜ í¬ì¸íŠ¸<br />
ì´ë¦„ ê·œì¹™ì„ ê³ ì •í•˜ì. mcp: ì ‘ë‘ì‚¬ë¡œ FastMCPì—ì„œ ì˜¨ íˆ´ì„ í‘œì‹œí•˜ë©´ ì¶©ëŒì„ ë°©ì§€í•˜ê³  ë¼ìš°íŒ…ì´ ë‹¨ìˆœí•´ì§„ë‹¤. FastMCP ìª½ íˆ´ ì´ë¦„ì— ì´ë¯¸ server:tool í˜•íƒœê°€ ë“¤ì–´ê°€ ìˆì–´ë„ ìƒê´€ì—†ë‹¤. ìµœì¢… ë…¸ì¶œëª…ì€ mcp:server:toolì²˜ëŸ¼ ë˜ì§€ë§Œ LLMì´ ì˜ì™¸ë¡œ ì˜ ê³ ë¥¸ë‹¤.<br />
íˆ´ ì†Œì¶œì„ ë„£ì. expose ì½œë°±ìœ¼ë¡œ í„´ë³„ë¡œ í•„ìš”í•œ ì„œë¸Œì…‹ë§Œ toolsì— ë‹´ìœ¼ë©´ ì„ íƒ ì˜¤ë¥˜ì™€ ì§€ì—°ì´ ì¤„ì–´ë“ ë‹¤.<br />
ê²°ê³¼ í¬ë§·ì„ í†µì¼í•˜ì. tool role ë©”ì‹œì§€ contentëŠ” í•­ìƒ JSON ë¬¸ìì—´ë¡œ ë„£ëŠ” ê²Œ í›„ì† ë¼ìš´ë“œì—ì„œ ì•ˆì •ì ì´ë‹¤.<br />
ì—ëŸ¬ëŠ” JSONìœ¼ë¡œ. ì‹¤í–‰ê¸° ì—ëŸ¬ë„ {"error": "â€¦"}ë¡œ í†µì¼í•´ ëª¨ë¸ì´ ë³µêµ¬ í”Œëœì„ ì„¸ìš°ê¸° ì¢‹ê²Œ ë§Œë“ ë‹¤.</p>

<p>ì´ êµ¬ì¡°ë©´ FastMCPê°€ ì œê³µí•˜ëŠ” íˆ´ê³¼ ë„¤ ë¡œì»¬ ToolSpecì„ ë™ì‹œì— ë“¤ê³ , í‘œì¤€ Chat Completions ë£¨í”„ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ì“¸ ìˆ˜ ìˆë‹¤. í•„ìš”í•œ ê²½ìš° expose ì •ì±…, ì´ë¦„ ë³„ì¹­, ê¸°ë³¸ ì¸ì ì£¼ì… ê°™ì€ ì •ì±… í›…ì„ runner.runì˜ ì¸ìë¡œ ì–¹ì–´ í™•ì¥í•˜ë©´ ëœë‹¤.</p>

<p class="chat--user">

Toolì´ not subscriptable mcp Toolì˜ ì†ì„±ì„ ì €ëŸ°ì‹ìœ¼ë¡œ ì ‘ê·¼í•˜ëŠ”ê²Œ ì˜ëª»ëœê±° ì•„ë‹ê¹Œ ì‹¶ë„¤

</p>

<p>ë§ë‹¤. â€œToolì´ not subscriptableâ€ì€ FastMCPê°€ <code class="language-plaintext highlighter-rouge">list_tools()</code>ì—ì„œ dictê°€ ì•„ë‹ˆë¼ ê°ì²´ë¥¼ ëŒë ¤ì¤˜ì„œ ìƒê¸´ ì¦ìƒì´ë‹¤. ë‚´ê°€ ì˜ˆì‹œì—ì„œ <code class="language-plaintext highlighter-rouge">t['name']</code>ì²˜ëŸ¼ ë”•ì…”ë„ˆë¦¬ë¡œ ë‹¤ë¤˜ê¸° ë•Œë¬¸. í•´ê²°ì€ ê°„ë‹¨í•˜ë‹¤. MCP íˆ´ ë©”íƒ€ë¥¼ dict/ê°ì²´ ì–´ë–¤ í˜•ì‹ì´ ì™€ë„ ì•ˆì „í•˜ê²Œ ì½ë„ë¡ ì •ê·œí™” ë ˆì´ì–´ë¥¼ í•œ ì¤„ ë¼ìš°ë©´ ëœë‹¤.</p>

<p>ì•„ë˜ íŒ¨ì¹˜ë§Œ ì ìš©í•˜ë©´ ë°”ë¡œ ëŒì•„ê°„ë‹¤.</p>

<ol>
  <li>MCP íˆ´ ë©”íƒ€ ì •ê·œí™” ìœ í‹¸ ì¶”ê°€<br />
ë”•ì…”ë„ˆë¦¬, pydantic ëª¨ë¸, dataclass, ì¼ë°˜ ê°ì²´ë¥¼ ëª¨ë‘ ì§€ì›í•˜ê³ , í•„ë“œëª…ë„ <code class="language-plaintext highlighter-rouge">parameters | input_schema | schema</code> ì¤‘ ìˆëŠ” ê±¸ ìë™ ì„ íƒí•œë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># utils_normalize.py
</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="k">def</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="c1"># pydantic ëª¨ë¸, dataclass, ì¼ë°˜ ê°ì²´ê¹Œì§€ ì»¤ë²„
</span>    <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="c1"># ì¼ë¶€ ê°ì²´ëŠ” to_dict()/dict() ì œê³µ
</span>    <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">to_dict</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="nf">to_dict</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">dict</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="nf">dict</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">default</span>

<span class="k">def</span> <span class="nf">normalize_mcp_tool_meta</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    FastMCP client.list_tools() ê²°ê³¼ì˜ í•œ í•­ëª©ì„ OpenAI tools í¬ë§·ìš© ë©”íƒ€ë¡œ ì •ê·œí™”.
    ë°˜í™˜: {</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">: dict}
    </span><span class="sh">"""</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="c1"># ì–´ë–¤ ì„œë²„ëŠ” server/name ì‹ë³„ìë¥¼ ë³„ë„ í•„ë“œì— ë‘˜ ìˆ˜ ìˆìŒ
</span>        <span class="n">name</span> <span class="o">=</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">unknown</span><span class="sh">"</span>

    <span class="n">desc</span> <span class="o">=</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">desc</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

    <span class="c1"># JSON Schema í•„ë“œëª… ë³€ì£¼ ëŒ€ì‘
</span>    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nf">_get_attr_or_key</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">schema</span><span class="sh">"</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="p">)</span>

    <span class="c1"># ìµœì†Œ í˜•ì‹ ë³´ì •
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">params</span><span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>mcp_tools_for_openaië¥¼ ì •ê·œí™” ìœ í‹¸ë¡œ êµì²´<br />
ì´ì œ ë¦¬ìŠ¤íŠ¸ê°€ dictë“  ê°ì²´ë“  ë¬¸ì œ ì—†ë‹¤. ì ‘ë‘ì‚¬ë§Œ ë¶™ì—¬ ì¶©ëŒì„ í”¼í•œë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># unified_fastmcp_chat.pyì˜ ê¸°ì¡´ í•¨ìˆ˜ ëŒ€ì²´
</span>
<span class="kn">from</span> <span class="n">utils_normalize</span> <span class="kn">import</span> <span class="n">normalize_mcp_tool_meta</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="n">tools_raw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">openai_tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_raw</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="nf">normalize_mcp_tool_meta</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">openai_tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">meta</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">openai_tools</span>
</code></pre></div></div>

<ol>
  <li>
    <p>ì‹¤í–‰ ì‹œ ë¼ìš°íŒ… ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€<br />
<code class="language-plaintext highlighter-rouge">is_mcp_tool(name)</code>ë¡œ ì ‘ë‘ì‚¬ íŒë‹¨ â†’ <code class="language-plaintext highlighter-rouge">strip_mcp_prefix(name)</code>ë¡œ ì›ë˜ ì´ë¦„ ë³µêµ¬ â†’ <code class="language-plaintext highlighter-rouge">await client.call_tool(mcp_name, args)</code> í˜¸ì¶œ. FastMCPê°€ ê¸°ëŒ€í•˜ëŠ” í•¨ìˆ˜ëª…ì´ <code class="language-plaintext highlighter-rouge">list_tools()</code>ì—ì„œ ë°›ì€ ê·¸ëŒ€ë¡œë¼ë©´ ì´ íë¦„ì´ ì •í™•í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ë¹ ë¥¸ ìê°€ì§„ë‹¨ ìŠ¤ë‹ˆí«<br />
í˜¹ì‹œ ê·¸ë˜ë„ íƒ€ì…ì´ ì• ë§¤í•˜ë©´, ì•„ë˜ë¥¼ í•œ ë²ˆ ì°ì–´ë³´ë©´ ì–´ë–¤ í•„ë“œë¥¼ ì“°ëŠ”ì§€ ë°”ë¡œ íŒŒì•…ëœë‹¤.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ë””ë²„ê·¸ìš©
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">debug_list_tools</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">tools</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nf">type</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nf">type</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="sh">"</span><span class="s">no direct attrs</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># dictë¡œ ë³€í™˜ ê°€ëŠ¥í•˜ë©´ ë¯¸ë¦¬ í™•ì¸
</span>        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">dict</span><span class="sh">"</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">  keys:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">list</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">dict</span><span class="p">().</span><span class="nf">keys</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">to_dict</span><span class="sh">"</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">  keys:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">list</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">to_dict</span><span class="p">().</span><span class="nf">keys</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">  keys:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">list</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">keys</span><span class="p">()))</span>
</code></pre></div></div>

<p>ìš”ì•½ ì •ë¦¬<br />
ë¬¸ì œ ì›ì¸: FastMCPê°€ ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ”ë° dictì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">t['name']</code>ë¡œ ì ‘ê·¼í•¨.<br />
í•´ê²°: <code class="language-plaintext highlighter-rouge">normalize_mcp_tool_meta()</code>ë¡œ dict/ê°ì²´ ì–‘ìª½ì„ ì§€ì›í•˜ê³ , í•„ë“œëª… ë³€ì£¼ê¹Œì§€ í¡ìˆ˜. ê·¸ ê²°ê³¼ë¥¼ OpenAI tools í¬ë§·ìœ¼ë¡œ ì§ë ¬í™”.<br />
ì¥ì : FastMCP êµ¬í˜„ì´ ë°”ë€Œê±°ë‚˜ ì„œë²„ë³„ë¡œ ë©”íƒ€ í•„ë“œëª…ì´ ë‹¬ë¼ë„ ì•ˆì „. ë„¤ ë¡œì»¬ ToolSpecê³¼ë„ ì¶©ëŒ ì—†ì´ í•©ì³ì„œ ì“¸ ìˆ˜ ìˆë‹¤.</p>

<p>ì´ íŒ¨ì¹˜ë§Œ ì ìš©í•˜ë©´ â€œTool is not subscriptableâ€ ì—ëŸ¬ëŠ” ì‚¬ë¼ì§€ê³ , mcp íˆ´ê³¼ ë¡œì»¬ íˆ´ì„ í•œ ë²ˆì˜ Chat Completions ë£¨í”„ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ì„ì–´ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ê·¸ëŸ°ë° AsyncExitStackGroupì—ì„œ ì˜¤í”ˆ í•˜ëŠ” ì¤‘ì— ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì–´ë–»ê²Œ ë¼? ì •ë¦¬ê°€ ì–´ë–»ê²Œ ë¼?

</p>

<p>í•µì‹¬ë§Œ ë§í•˜ë©´, ì§€ê¸ˆ ë§Œë“  AsyncExitStackGroupì€ â€œì—¬ëŸ¿ì„ ì°¨ë¡€ë¡œ ì—´ë‹¤ ì¤‘ê°„ì— ì‹¤íŒ¨â€í–ˆì„ ë•Œ ì´ë¯¸ ì—´ë¦° ê²ƒë“¤ì„ ìë™ìœ¼ë¡œ ë‹«ì•„ì£¼ì§€ ì•ŠëŠ”ë‹¤. <strong>aenter</strong> ë„ì¤‘ ì˜ˆì™¸ê°€ ë‚˜ë©´ __aexit__ê°€ í˜¸ì¶œë˜ì§€ ì•Šê¸° ë•Œë¬¸. ë”°ë¼ì„œ ë¶€ë¶„ì ìœ¼ë¡œ ì—´ë¦° ë¦¬ì†ŒìŠ¤ê°€ ëˆ„ìˆ˜ë  ìˆ˜ ìˆë‹¤.</p>

<p>í•´ê²°ì€ ë‘ ê°€ì§€ë‹¤.</p>

<ol>
  <li>í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì“°ê¸°: contextlib.AsyncExitStack<br />
ì´ê²Œ ë°”ë¡œ ê·¸ëŸ° ìƒí™©ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ë¼ê³  ì¡´ì¬í•œë‹¤. í•˜ë‚˜ë¼ë„ ì—´ê¸°ì— ì‹¤íŒ¨í•˜ë©´, ê·¸ ì´ì „ì— ì„±ê³µí•œ ì»¨í…ìŠ¤íŠ¸ë“¤ì˜ ì •ë¦¬ í•¨ìˆ˜ê°€ ì—­ìˆœìœ¼ë¡œ í˜¸ì¶œëœë‹¤.</li>
</ol>

<p>ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">open_many</span><span class="p">(</span><span class="n">managers</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nc">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">managers</span><span class="p">:</span>
            <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stack</span><span class="p">.</span><span class="nf">enter_async_context</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
            <span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
        <span class="c1"># ì—¬ê¸°ê¹Œì§€ ì˜¤ë©´ ëª¨ë‘ ì •ìƒ ì˜¤í”ˆ
</span>        <span class="c1"># openedë¥¼ ì‚¬ìš©
</span>        <span class="k">return</span> <span class="n">opened</span>
    <span class="c1"># ìœ„ ë¸”ë¡ì„ ë¹ ì ¸ë‚˜ì˜¤ë©´ ëª¨ë‘ ì •ë¦¬ë¨
</span></code></pre></div></div>

<ol>
  <li>ë„¤ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ë¥¼ ì•ˆì „í•˜ê²Œ ê³ ì¹˜ê¸°<br />
AsyncExitStackê³¼ ê°™ì€ ì˜ë¯¸ë¡ ì„ ì§ì ‘ êµ¬í˜„í•˜ë ¤ë©´, ì—´ë¦´ ë•Œë§ˆë‹¤ â€œí•´ë‹¹ ì»¨í…ìŠ¤íŠ¸ì˜ __aexit__ë¥¼ ìŠ¤íƒì— pushâ€í•˜ê³ , ì¤‘ê°„ì— ì˜ˆì™¸ê°€ ë‚˜ë©´ ì´ë¯¸ ìŒ“ì•„ë‘” __aexit__ë“¤ì„ ì—­ìˆœìœ¼ë¡œ í˜¸ì¶œí•´ì•¼ í•œë‹¤.</li>
</ol>

<p>ì•ˆì „ ë²„ì „</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AsyncExitStackGroup</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cms</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cms</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">cms</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_exits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_entered</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">:</span>
                <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">()</span>
                <span class="c1"># ì •ìƒ ì§„ì…í–ˆìœ¼ë©´, ëŒ€ì‘ __aexit__ë¥¼ ìŠ¤íƒì— ì €ì¥
</span>                <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cm</span><span class="p">.</span><span class="n">__aexit__</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_entered</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_entered</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ì—¬ê¸°ì„œ ì •ë¦¬: ì´ë¯¸ ì§„ì…í–ˆë˜ ì»¨í…ìŠ¤íŠ¸ë“¤ì„ ì—­ìˆœìœ¼ë¡œ ë‹«ìŒ
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_close_partial</span><span class="p">(</span><span class="n">exc_type</span><span class="o">=</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">exc</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="n">e</span><span class="p">.</span><span class="n">__traceback__</span><span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># ì›ë˜ ì˜ˆì™¸ë¥¼ ê·¸ëŒ€ë¡œ ì „íŒŒ
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_close_partial</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
        <span class="c1"># ì˜ˆì™¸ ì „íŒŒ ì—¬ë¶€: ì—¬ê¸°ì„œëŠ” ì–µì œí•˜ì§€ ì•ŠìŒ(False)
</span>        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_close_partial</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">:</span>
            <span class="n">exit_cb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="nf">exit_cb</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># ì •ë¦¬ ì¤‘ ì˜ˆì™¸ëŠ” ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ê³„ì† ì§„í–‰í•˜ëŠ” ê²Œ ë³´í†µ ì•ˆì „
</span>                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_entered</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
</code></pre></div></div>

<p>ë¹„êµ ìš”ì•½</p>

<ul>
  <li>
    <p>ê¸°ì¡´ êµ¬í˜„: __aenter__ì—ì„œ ì˜ˆì™¸ê°€ ë‚˜ë©´ ì´ë¯¸ ì—° ë¦¬ì†ŒìŠ¤ê°€ ë‚¨ì„ ìˆ˜ ìˆìŒ.</p>
  </li>
  <li>
    <p>ê°œì„  êµ¬í˜„: __aenter__ì—ì„œ ì˜ˆì™¸ê°€ ë‚˜ë„ _close_partialì´ í˜¸ì¶œë˜ì–´ ì—­ìˆœ ì •ë¦¬ë¨.</p>
  </li>
  <li>
    <p>í‘œì¤€ AsyncExitStack: ê°™ì€ ë³´ì¦ì„ ì´ë¯¸ ì œê³µ. ê°€ëŠ¥í•˜ë©´ ì´ê±¸ ì“°ëŠ” ê²Œ ê°€ì¥ ì•ˆì „í•˜ê³  ê°„ë‹¨.</p>
  </li>
</ul>

<p>ì¶”ì²œ ì „ëµ</p>

<ul>
  <li>
    <p>ê°€ëŠ¥í•œ í•œ contextlib.AsyncExitStackì„ ì‚¬ìš©í•˜ì. ê¸°ëŠ¥ ê²€ì¦, ì˜ˆì™¸ ì „íŒŒ, ì •ë¦¬ ì¤‘ ì˜ˆì™¸ ì²˜ë¦¬ê¹Œì§€ ì˜ ë˜ì–´ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ì§ì ‘ êµ¬í˜„í•´ì•¼ í•œë‹¤ë©´ ìœ„ ê°œì„  ë²„ì „ì„ ì“°ê³ , ì •ë¦¬ ì¤‘ ì˜ˆì™¸ëŠ” ì‚¼í‚¤ë˜ ë¡œê¹…í•˜ì. ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ëˆ„ìˆ˜ë³´ë‹¤ ì •ë¦¬ ì§€ì†ì´ ì¤‘ìš”í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ì •ë¦¬ í•¨ìˆ˜ê°€ ë©±ë“±ì ì´ì–´ì•¼ í•œë‹¤. ì¼ë¶€ MCP ì»¤ë„¥í„°ëŠ” ì¤‘ë³µ close/stop í˜¸ì¶œì´ ë“¤ì–´ì™€ë„ ì•ˆì „í•˜ê²Œ ë¬´ì‹œí•˜ë„ë¡ ë§Œë“¤ì–´ë‘ëŠ” í¸ì´ ì¢‹ë‹¤.</p>
  </li>
  <li>
    <p>ì˜¤í”ˆê³¼ ì •ë¦¬ ì‚¬ì´ì— ìƒíƒœë¥¼ ì™¸ë¶€ë¡œ ë„˜ê¸¸ ë•ŒëŠ”, ë°˜í™˜ê°’ ë¦¬ìŠ¤íŠ¸(self._entered) ëŒ€ì‹  ì´ë¦„â†’í•¸ë“¤ ë§µì„ ì“°ë©´ ì¶”ì ì´ ì‰½ë‹¤.</p>
  </li>
</ul>

<p class="chat--user">

ë­ì•¼ ê·¸ëŸ¼ ì²¨ì—ëŠ” ì•ˆì „í•˜ì§€ ì•Šê²Œ ë§Œë“¤ì–´ì¤¬ë˜ê±°ì•¼?

</p>

<p>ë§ë‹¤. ì²˜ìŒì— ì¤€ AsyncExitStackGroupì€ ì˜ˆì™¸ ì‹œ ìë™ ì •ë¦¬ë¥¼ ë³´ì¥í•˜ì§€ ëª»í–ˆìœ¼ë‹ˆ ì•ˆì „í•˜ì§€ ì•Šì•˜ë‹¤. ë‚´ ì‹¤ìˆ˜ë‹¤. ë°”ë¡œì¡ì.</p>

<p>ë‹¨ê³„ë³„ë¡œ ì •ë¦¬</p>

<ol>
  <li>
    <p>ë¬¸ì œ í•µì‹¬<br />
ì—¬ëŸ¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìˆœì°¨ë¡œ ì—¬ëŠ” ì¤‘ í•˜ë‚˜ê°€ ì‹¤íŒ¨í•˜ë©´, ì´ë¯¸ ì—´ë¦° ê²ƒë“¤ì„ ë‹«ì•„ì¤˜ì•¼ í•œë‹¤. ì§ì ‘ ë§Œë“  ë‹¨ìˆœ êµ¬í˜„ì€ <strong>aenter</strong> ì¤‘ ì˜ˆì™¸ê°€ ë‚˜ë©´ __aexit__ê°€ í˜¸ì¶œë˜ì§€ ì•Šì•„ ëˆ„ìˆ˜ê°€ ë‚œë‹¤.</p>
  </li>
  <li>
    <p>ê°€ì¥ ì•ˆì „í•œ í•´ê²°ì±…<br />
íŒŒì´ì¬ í‘œì¤€ contextlib.AsyncExitStackì„ ì“°ë©´, ì—´ ë•Œë§ˆë‹¤ ì •ë¦¬ ì½œë°±ì„ ìŠ¤íƒì— ë“±ë¡í•˜ë¯€ë¡œ ì¤‘ê°„ ì‹¤íŒ¨ ì‹œ ì—­ìˆœ ì •ë¦¬ê°€ ìë™ìœ¼ë¡œ ë³´ì¥ëœë‹¤.</p>
  </li>
  <li>
    <p>í‘œì¤€ ìŠ¤íƒ ì‚¬ìš© ì˜ˆì‹œ</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">open_many_safely</span><span class="p">(</span><span class="n">managers</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nc">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">managers</span><span class="p">:</span>
            <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stack</span><span class="p">.</span><span class="nf">enter_async_context</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
            <span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opened</span>
    <span class="c1"># ë¸”ë¡ì„ ë¹ ì ¸ë‚˜ê°€ë©´ ìë™ìœ¼ë¡œ ëª¨ë‘ ì •ë¦¬ë¨
</span></code></pre></div></div>

<ol>
  <li>ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ë¥¼ ê¼­ ì¨ì•¼ í•œë‹¤ë©´ ì•ˆì „ ë²„ì „</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AsyncExitStackGroup</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cms</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cms</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">cms</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_exits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_entered</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">:</span>
                <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cm</span><span class="p">.</span><span class="n">__aexit__</span><span class="p">)</span>  <span class="c1"># ì •ë¦¬ ì½œë°± ìŠ¤íƒì— push
</span>                <span class="n">self</span><span class="p">.</span><span class="n">_entered</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_entered</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_close_partial</span><span class="p">(</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">__traceback__</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_close_partial</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># ì˜ˆì™¸ ì–µì œ ì•ˆ í•¨
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_close_partial</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">:</span>
            <span class="n">exit_cb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_exits</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="nf">exit_cb</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_entered</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
</code></pre></div></div>

<ol>
  <li>ì‹¤ì „ ê¶Œì¥<br />
ê°€ëŠ¥í•˜ë©´ í‘œì¤€ AsyncExitStackìœ¼ë¡œ êµì²´í•˜ë¼. ì´ë¯¸ ê²€ì¦ëœ ë³´ì¦ì„ ì œê³µí•˜ê³ , ì •ë¦¬ ì¤‘ ì˜ˆì™¸ ì²˜ë¦¬ë„ ì¼ê´€ì ì´ë‹¤. ì»¤ìŠ¤í…€ì´ í•„ìš”í•˜ë©´ ìœ„ ì•ˆì „ ë²„ì „ì„ ê·¸ëŒ€ë¡œ ì“°ë©´ ëœë‹¤.</li>
</ol>

<p>ë‹¤ìŒ ì•¡ì…˜<br />
ê¸°ì¡´ AsyncExitStackGroupì„ ì „ì—­ ê²€ìƒ‰í•´ì„œ ë‘ ê°€ì§€ ì¤‘ í•˜ë‚˜ë¡œ ë°”ê¿”ë¼.<br />
í‘œì¤€ ìŠ¤íƒìœ¼ë¡œ ë‹¨ìˆœí™”í•˜ê±°ë‚˜, ì•ˆì „ ë²„ì „ìœ¼ë¡œ ëŒ€ì²´.<br />
ì´í›„ MCP ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì €ë¥¼ ì—¬ëŸ¿ ì—¬ëŠ” ëª¨ë“  ê²½ë¡œì—ì„œ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±ì´ ì‚¬ë¼ì§„ë‹¤.</p>

<p class="chat--user">

import contextlib async def open_many_safely(managers): async with contextlib.AsyncExitStack() as stack: opened = [] for cm in managers: entered = await stack.enter_async_context(cm) opened.append(entered) return opened # ë¸”ë¡ì„ ë¹ ì ¸ë‚˜ê°€ë©´ ìë™ìœ¼ë¡œ ëª¨ë‘ ì •ë¦¬ë¨ ì´ê±´ ì–´ë–»ê²Œ ì“°ëŠ”ê±´ë°? MCP ì„œë²„ë“¤ì„ ì—´ê³  ê·¸ê±¸ Agentì— argumentë¡œ ë„£ê³  ì‹¤í–‰í•œ ë’¤ ê·¸ í›„ì— ì—´ë¦° ì„œë²„ë“¤ì„ ë‹«ì•„ì•¼í•´

</p>

<p>ë§ëŠ” íë¦„ì€ â€œì—´ê³  â†’ ì‚¬ìš©í•˜ëŠ” ë™ì•ˆ ì—´ì–´ë‘ê³  â†’ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ë‹«ê¸°â€ë‹¤. ê·¸ë˜ì„œ ë°˜í™˜ìœ¼ë¡œ êº¼ë‚´ëŠ” í•¨ìˆ˜ê°€ ì•„ë‹ˆë¼, â€œì—¬ëŸ¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì—´ì–´ë‘” ìƒíƒœë¥¼ yieldâ€í•˜ëŠ” async ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì €ê°€ í•„ìš”í•˜ë‹¤. ì•„ë˜ì²˜ëŸ¼ ë°”ê¿” ì“°ë©´ ëœë‹¤.</p>

<ol>
  <li>ìœ í‹¸: ì—¬ëŸ¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ì—´ê³  ë‹«ëŠ” async ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì €</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">contextlib</span>

<span class="nd">@contextlib.asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">open_many</span><span class="p">(</span><span class="n">managers</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nc">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">managers</span><span class="p">:</span>
            <span class="n">entered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stack</span><span class="p">.</span><span class="nf">enter_async_context</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
            <span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entered</span><span class="p">)</span>
        <span class="c1"># ì—¬ê¸°ì„œ openedë¥¼ ë‚´ë³´ë‚¸ ë’¤ with ë¸”ë¡ì´ ëë‚  ë•Œ ìë™ìœ¼ë¡œ ëª¨ë‘ ë‹«í˜
</span>        <span class="k">yield</span> <span class="n">opened</span>
</code></pre></div></div>

<ol>
  <li>ì‚¬ìš© ì˜ˆì‹œ: MCP ì„œë²„ë“¤ ì—´ê¸° â†’ Agentì— ì£¼ì… â†’ ì‹¤í–‰ â†’ ìë™ ì •ë¦¬</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP ì„œë²„ ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì €ë“¤ ì¤€ë¹„
</span>    <span class="n">managers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerStdio</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
            <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">MCPServerSse</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
            <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># 2) ì—¬ëŸ¬ ì„œë²„ë¥¼ ì•ˆì „í•˜ê²Œ ì—´ê³ , ì—´ë¦° í•¸ë“¤ë“¤ì„ ì—ì´ì „íŠ¸ì— ë„˜ê¹€
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nf">open_many</span><span class="p">(</span><span class="n">managers</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened_servers</span><span class="p">:</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">PassThroughMCP</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ MCP íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="n">opened_servers</span><span class="p">,</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># 3) ì—ì´ì „íŠ¸ ì‹¤í–‰
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">filesì™€ search MCPë¥¼ í™œìš©í•´ sales.csv í†µì°°ì„ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>
    <span class="c1"># 4) ì—¬ê¸° ë„ë‹¬í•˜ë©´ opened_serversëŠ” ëª¨ë‘ ìë™ìœ¼ë¡œ ì •ë¦¬ë¨
</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸</p>

<ul>
  <li>
    <p>open_manyëŠ” with ë¸”ë¡ì´ ìœ ì§€ë˜ëŠ” ë™ì•ˆë§Œ ë¦¬ì†ŒìŠ¤ë¥¼ ì—´ì–´ë‘”ë‹¤. ë¸”ë¡ì„ ë²—ì–´ë‚˜ë©´ ì—­ìˆœìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë‹«íŒë‹¤.</p>
  </li>
  <li>
    <p>ì¤‘ê°„ì— ì–´ë–¤ ì„œë²„ ì—´ê¸°ì—ì„œ ì˜ˆì™¸ê°€ ë‚˜ë„ ì´ë¯¸ ì—´ë¦° ê²ƒë“¤ì€ AsyncExitStackì´ ì•Œì•„ì„œ ë‹«ì•„ì¤€ë‹¤.</p>
  </li>
  <li>
    <p>Runner.runì—ì„œ ì˜ˆì™¸ê°€ ë‚˜ë„ with ë¸”ë¡ì„ ë¹ ì ¸ë‚˜ê°€ë©° ì •ë¦¬ê°€ ë³´ì¥ëœë‹¤.</p>
  </li>
</ul>

<p>ì´ íŒ¨í„´ë§Œ ê¸°ì–µí•˜ë©´ â€œMCP ì—¬ëŸ¬ ëŒ€ ì—´ê³  â†’ Agentì— ì£¼ê³  â†’ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ë‹«ê¸°â€ê°€ í•­ìƒ ì•ˆì „í•˜ê²Œ ë™ì‘í•œë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python MCP ì—°ê²° ë°©ë²•</title><link href="https://hvppyarchive.github.io/llm/unified-mcp-interface/" rel="alternate" type="text/html" title="Python MCP ì—°ê²° ë°©ë²•" /><published>2025-10-29T16:22:58+09:00</published><updated>2025-10-29T16:22:58+09:00</updated><id>https://hvppyarchive.github.io/llm/unified-mcp-interface</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/unified-mcp-interface/"><![CDATA[<p class="chat--user">

ë„ˆëŠ” LLM Agent ì „ë¬¸ê°€ì•¼. MCP ë‘ ê°œ ì´ìƒ(ì´ê±´ ì…ë ¥ìœ¼ë¡œ ì»¤ë§¨ë“œë¥¼ ì—¬ëŸ¬ê°œ ë°›ì„ ìˆ˜ ìˆì–´)ì„ ë„ìš°ê³  ëª¨ë“  MCP íˆ´ì„ LLMì—ê²Œ ì „ë‹¬ ë° ì‹¤í–‰í•˜ê³  ì‹¶ì–´. 

</p>

<p>ì¢‹ì•„, ì—¬ëŸ¬ ê°œì˜ MCP ì„œë²„ë¥¼ ë™ì‹œì— ë¶™ì—¬ì„œ â€œëª¨ë“  MCP íˆ´ì„ LLMì´ í•œ ë²ˆì— ë³´ê³  ì‹¤í–‰â€í•˜ê²Œ ë§Œë“œëŠ” ë°©ë²•ì„ ë‘ ê°€ì§€ ê²½ë¡œë¡œ ì •ë¦¬í•´ì¤„ê²Œ. ì²«ì§¸ëŠ” Anthropic Messages APIì˜ MCP ì»¤ë„¥í„°ë¥¼ ê·¸ëŒ€ë¡œ ì“°ëŠ” ë°©ë²•(ê°€ì¥ ê°„ë‹¨). ë‘˜ì§¸ëŠ” ì§ì ‘ MCP í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ì–´ ì—¬ëŸ¬ ì„œë²„ì— ë¶™ê³ , íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ í•©ì³ì„œ LLMì—ê²Œ ì œê³µí•˜ëŠ” ë°©ë²•(ì»¤ìŠ¤í…€ ì œì–´). ë‹¨ê³„ë³„ë¡œ ë°”ë¡œ ë”°ë¼í•˜ë©´ ëœë‹¤. ì¸ìš©êµ¬ë¬¸ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.</p>

<h1 id="1-ê°€ì¥-ì‰¬ìš´-ê¸¸-claude-messages-apiì˜-mcp-ì»¤ë„¥í„°ë¡œ-ì—¬ëŸ¬-ì„œë²„-ë¶™ì´ê¸°">1) ê°€ì¥ ì‰¬ìš´ ê¸¸: Claude Messages APIì˜ MCP ì»¤ë„¥í„°ë¡œ ì—¬ëŸ¬ ì„œë²„ ë¶™ì´ê¸°</h1>

<p>í•µì‹¬ì€ <code class="language-plaintext highlighter-rouge">messages.create</code> í˜¸ì¶œì— <code class="language-plaintext highlighter-rouge">mcp_servers</code> ë°°ì—´ì„ ë„£ì–´ ì—¬ëŸ¬ ì„œë²„ë¥¼ ë™ì‹œì— ì„ ì–¸í•˜ëŠ” ê²ƒ. ì„œë²„ë§ˆë‹¤ ì´ë¦„ì„ ë¶€ì—¬í•˜ë©´ ì¶©ëŒ ì—†ì´ íˆ´ì„ êµ¬ë¶„í•  ìˆ˜ ìˆê³ , ëª¨ë¸ì€ ê° ì„œë²„ì—ì„œ ë…¸ì¶œëœ MCP íˆ´ì„ í•„ìš”í•  ë•Œ í˜¸ì¶œí•œë‹¤. ë² íƒ€ í—¤ë”ê°€ í•„ìš”í•˜ë‹¤.</p>

<p>ìš”ì²­ ë°”ë”” ì˜ˆì‹œ(ë‘˜ ì´ìƒì˜ ì„œë²„ ì—°ê²°):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">"claude-sonnet-4-5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"max_tokens"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë‘ ì„œë²„ì˜ íˆ´ì„ ëª¨ë‘ í™œìš©í•´ì„œ ì‘ì—…ì„ ëë‚´ì¤˜"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"mcp_servers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example1.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tool_configuration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example2.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ì´ ë°©ì‹ì˜ í¬ì¸íŠ¸</p>

<ol>
  <li>
    <p>í•œ ìš”ì²­ì—ì„œ ì—¬ëŸ¬ MCP ì„œë²„ì˜ íˆ´ì„ ëª¨ë‘ ë…¸ì¶œí•  ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ì„œë²„ ì´ë¦„(<code class="language-plaintext highlighter-rouge">name</code>)ì´ íˆ´ í˜¸ì¶œ ë¸”ë¡ì— í•¨ê»˜ ë“¤ì–´ê°€ì„œ ì¶©ëŒì„ í”¼í•œë‹¤.</p>
  </li>
  <li>
    <p>í˜„ì¬ëŠ” â€œMCPì˜ íˆ´ í˜¸ì¶œâ€ë§Œ ì§€ì›(ë¦¬ì†ŒìŠ¤/í”„ë¡¬í”„íŠ¸ ë“±ì€ ì œì™¸)ë˜ê³ , HTTPë¡œ ê³µê°œëœ ì›ê²© ì„œë²„ë§Œ ì§ì ‘ ì—°ê²°ëœë‹¤(ë¡œì»¬ stdioëŠ” ë¶ˆê°€). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>
  </li>
</ol>

<p>ë¬¸ì„œ ê·¼ê±°ì™€ ìŠ¤í™<br />
â€¢ MCP ì»¤ë„¥í„° ì‚¬ìš©ë²•ê³¼ ë©€í‹° ì„œë²„ ì˜ˆì‹œëŠ” Claude ê³µì‹ ë¬¸ì„œì˜ â€œMCP connectorâ€ì™€ â€œMultiple MCP serversâ€ ì„¹ì…˜ì— ê·¸ëŒ€ë¡œ ìˆë‹¤. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
â€¢ MCP ìì²´ ê°œë…ê³¼ ìŠ¤í™ì€ í”„ë¡œí† ì½œ ì‚¬ì´íŠ¸ì™€ ìŠ¤í™ ë¬¸ì„œ ì°¸ê³ . <a href="https://modelcontextprotocol.io/?utm_source=chatgpt.com">ëª¨ë¸ ì»¨í…ìŠ¤íŠ¸ í”„ë¡œí† ì½œ+1</a></p>

<p>ì´ ê²½ë¡œë¡œ ê°€ë©´ â€œLLMì—ê²Œ MCP íˆ´ ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ê³ , ì‹¤í–‰ì€ ëª¨ë¸ì´ ì•Œì•„ì„œ ì„œë²„ë³„ë¡œ ë¼ìš°íŒ…â€í•´ì¤€ë‹¤. ìš´ì˜ì—ì„œ OAuth í† í°ì´ í•„ìš”í•œ ì„œë²„ëŠ” <code class="language-plaintext highlighter-rouge">authorization_token</code> í•„ë“œë¡œ ì „ë‹¬í•˜ë©´ ëœë‹¤. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>

<h1 id="2-ë”-ìœ ì—°í•œ-ê¸¸-ì§ì ‘-mcp-í´ë¼ì´ì–¸íŠ¸ë¥¼-ë§Œë“¤ì–´-ë©€í‹°-ì„œë²„--ë‹¨ì¼-íˆ´-ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ-í•©ì¹˜ê¸°">2) ë” ìœ ì—°í•œ ê¸¸: ì§ì ‘ MCP í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ì–´ â€œë©€í‹° ì„œë²„ â†’ ë‹¨ì¼ íˆ´ ë ˆì§€ìŠ¤íŠ¸ë¦¬â€ë¡œ í•©ì¹˜ê¸°</h1>

<p>ë¡œì»¬/ì‚¬ë‚´ìš© íˆ´ê¹Œì§€ ë‹¤ ì—®ê³  ì‹¶ê±°ë‚˜, íˆ´ ë…¸ì¶œ/ë¡œê·¸/ê¶Œí•œì„ ì„¬ì„¸í•˜ê²Œ í†µì œí•˜ë ¤ë©´ ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“œëŠ” í¸ì´ ì¢‹ë‹¤. ê³µì‹ SDKê°€ ìˆë‹¤(íƒ€ì…ìŠ¤í¬ë¦½íŠ¸, íŒŒì´ì¬ ë“±). <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>

<p>ì•„í‚¤í…ì²˜ ê°œìš”</p>

<ol>
  <li>
    <p>ê° MCP ì„œë²„ì™€ ë³„ë„ì˜ ì„¸ì…˜ìœ¼ë¡œ ì—°ê²°(stdio ë˜ëŠ” HTTP).</p>
  </li>
  <li>
    <p>ëª¨ë“  ì„œë²„ì—ì„œ <code class="language-plaintext highlighter-rouge">list_tools</code>ë¥¼ ë°›ì•„ í•©ì¹œë‹¤. ì´ë•Œ ì¶©ëŒì„ ë§‰ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">serverName:toolName</code> ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë¶™ì¸ë‹¤.</p>
  </li>
  <li>
    <p>í•©ì³ì§„ íˆ´ ëª©ë¡ì„ LLMì˜ â€œë„êµ¬(Function/Tool Use)â€ë¡œ ë“±ë¡í•œë‹¤.</p>
  </li>
  <li>
    <p>LLMì´ <code class="language-plaintext highlighter-rouge">serverName:toolName</code>ì„ í˜¸ì¶œí•˜ë©´, í•´ë‹¹ ì„œë²„ ì„¸ì…˜ìœ¼ë¡œ ë¼ìš°íŒ…í•´ì„œ <code class="language-plaintext highlighter-rouge">call_tool</code> ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ ëª¨ë¸ì— <code class="language-plaintext highlighter-rouge">tool_result</code>ë¡œ ë˜ëŒë¦°ë‹¤.</p>
  </li>
</ol>

<p>ì˜ˆì‹œ ì½”ë“œ(íƒ€ì…ìŠ¤í¬ë¦½íŠ¸, Node). ì—¬ëŸ¬ ì„œë²„ì—ì„œ íˆ´ì„ ëª¨ì•„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤í™”í•˜ê³ , í˜¸ì¶œ ì‹œ ë¼ìš°íŒ…í•œë‹¤. SDKëŠ” ê³µì‹ TS SDKë¥¼ ì‚¬ìš©í•œë‹¤. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

// package.json: @modelcontextprotocol/sdk, zod, anthropic ë“± ì„¤ì¹˜ ê°€ì •
// npm i @modelcontextprotocol/sdk zod anthropic

import { ClientSession } from '@modelcontextprotocol/sdk/client/session.js';
import { StdioClientTransport, StdioServerParameters } from '@modelcontextprotocol/sdk/client/stdio.js';
import Anthropic from '@anthropic-ai/sdk';

// ì„œë²„ ì„¤ì •
type ServerCfg = { name: string; command: string; args: string[] };
const SERVERS: ServerCfg[] = [
  { name: 'files', command: 'node', args: ['./servers/files/index.js'] },
  { name: 'db', command: 'python', args: ['./servers/db/server.py'] },
];

type Connected = {
  name: string;
  session: ClientSession;
};

const connected: Connected[] = [];

async function connectAll() {
  for (const s of SERVERS) {
    const params: StdioServerParameters = { command: s.command, args: s.args };
    const transport = new StdioClientTransport(params);
    await transport.start();
    const session = new ClientSession(transport);
    await session.initialize();
    connected.push({ name: s.name, session });
    console.log(`[MCP] connected: ${s.name}`);
  }
}

type ToolDesc = {
  name: string;              // namespaced: `${server}:${tool}`
  description?: string;
  input_schema: any;         // JSON Schema
};

// ëª¨ë“  ì„œë²„ì˜ íˆ´ì„ ìˆ˜ì§‘í•˜ì—¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶€ì—¬
async function collectTools(): Promise&lt;ToolDesc[]&gt; {
  const all: ToolDesc[] = [];
  for (const { name: serverName, session } of connected) {
    const { tools } = await session.listTools();
    for (const t of tools) {
      all.push({
        name: `${serverName}:${t.name}`,
        description: t.description,
        input_schema: t.inputSchema,
      });
    }
  }
  return all;
}

// LLMì´ namespaced íˆ´ì„ í˜¸ì¶œí•˜ë©´ í•´ë‹¹ ì„œë²„ë¡œ ë¼ìš°íŒ…
async function callNamespacedTool(nsName: string, args: any) {
  const [serverName, toolName] = nsName.split(':');
  const target = connected.find(c =&gt; c.name === serverName);
  if (!target) throw new Error(`Server not found: ${serverName}`);
  return target.session.callTool(toolName, args);
}

async function main() {
  await connectAll();
  const tools = await collectTools();

  const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! });

  // ëŒ€í™” ë£¨í”„ì˜ í•œ í„´ ì˜ˆì‹œ
  let messages: any[] = [{ role: 'user', content: 'CSVë¥¼ DBì— ì ì¬í•˜ê³  ìš”ì•½í•´ì¤˜' }];

  // Anthropicì˜ Tool Use í¬ë§·ì— ë§ì¶° íˆ´ ì „ë‹¬
  const toolDefs = tools.map(t =&gt; ({
    name: t.name,
    description: t.description,
    input_schema: t.input_schema,
  }));

  let resp = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 1000,
    messages,
    tools: toolDefs,
  });

  // tool_use ì²˜ë¦¬ ë£¨í”„
  while (resp.content.some((c: any) =&gt; c.type === 'tool_use')) {
    const assistantContent: any[] = [];
    const toolResults: any[] = [];

    for (const c of resp.content) {
      if (c.type === 'text') assistantContent.push(c);
      if (c.type === 'tool_use') {
        const result = await callNamespacedTool(c.name, c.input);
        toolResults.push({
          type: 'tool_result',
          tool_use_id: c.id,
          content: result.content, // MCP í‘œì¤€ content ë°°ì—´
        });
      }
    }

    messages.push({ role: 'assistant', content: assistantContent.concat(resp.content.filter((c: any) =&gt; c.type === 'tool_use')) });
    messages.push({ role: 'user', content: toolResults });

    resp = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1000,
      messages,
      tools: toolDefs,
    });
  }

  console.log(resp.content.map((c: any) =&gt; (c.type === 'text' ? c.text : '')).join('\n'));
}

main().catch(e =&gt; { console.error(e); process.exit(1); });
</code></pre></div></div>

<p>ì´ íŒ¨í„´ì˜ ì¥ì <br />
â€¢ ì–´ë–¤ LLMì´ë“ (Anthropic/OpenAI/ë¡œì»¬) í‘œì¤€ â€œíˆ´ í˜¸ì¶œâ€ ì¸í„°í˜ì´ìŠ¤ë§Œ ìˆìœ¼ë©´ ê°™ì€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì¬í™œìš©í•  ìˆ˜ ìˆë‹¤.<br />
â€¢ ì„œë²„ë³„ ê¶Œí•œ, ë¡œê¹…, ë ˆì´íŠ¸ ë¦¬ë°‹, ì…ë ¥ ê²€ì¦ì„ ì¤‘ì•™ì—ì„œ í†µì œ ê°€ëŠ¥.<br />
â€¢ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì „ëµìœ¼ë¡œ íˆ´ ì´ë¦„ ì¶©ëŒì„ í™•ì‹¤íˆ ë°©ì§€.<br />
â€¢ stdio ë¡œì»¬ ì„œë²„ì™€ ì›ê²© HTTP ì„œë²„ë¥¼ ì„ì–´ì„œ ë¶™ì¼ ìˆ˜ ìˆë‹¤(ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ ë°©ì‹ì´ë¯€ë¡œ). SDKê°€ stdio/HTTP ëª¨ë‘ ì§€ì›í•œë‹¤. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>ì„¤ì¹˜Â·ì°¸ê³ <br />
â€¢ ê³µì‹ TS SDKì™€ ì˜ˆì œ ì„œë²„/í´ë¼ì´ì–¸íŠ¸, Streamable HTTP/stdio ì „ì†¡ê³„ì¸µì€ ê¹ƒí—ˆë¸Œ READMEì™€ ì˜ˆì œì— ìƒì„¸. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a><br />
â€¢ â€œBuild an MCP clientâ€ íŠœí† ë¦¬ì–¼(íŒŒì´ì¬/ë…¸ë“œ í¬í•¨)ë„ ë©€í‹° ì„œë²„ë¡œ í™•ì¥í•˜ê¸° ì‰½ë‹¤. ìœ„ ì˜ˆì‹œ ë¡œì§ì€ ê·¸ íë¦„ì„ ì¼ë°˜í™”í•œ ê²ƒ. <a href="https://modelcontextprotocol.io/quickstart/client">ëª¨ë¸ ì»¨í…ìŠ¤íŠ¸ í”„ë¡œí† ì½œ</a></p>

<h1 id="ìš´ì˜-íŒê³¼-í•¨ì •ì‹¤ë¬´-ì²´í¬ë¦¬ìŠ¤íŠ¸">ìš´ì˜ íŒê³¼ í•¨ì •(ì‹¤ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸)</h1>

<p>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê·œì¹™<br />
â€¢ <code class="language-plaintext highlighter-rouge">${server}:${tool}</code>ë¡œ ê³ ì •í•˜ë©´ ë¼ìš°íŒ…ì´ ë‹¨ìˆœí•´ì§„ë‹¤. íˆ´ ì„¤ëª…ì—ë„ ì„œë²„ëª…ì„ ì ì–´ LLMì˜ ì„ íƒì„ ë•ëŠ”ë‹¤.<br />
â€¢ ëª¨ë¸ì´ â€œë¹„ìŠ·í•œ ë‘ íˆ´â€ì„ í˜¼ë™í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì„¤ëª…ì— ì°¨ì´ë¥¼ ëª…í™•íˆ ì“°ê³  ìŠ¤í‚¤ë§ˆì— ì œì•½ì„ ë„£ëŠ”ë‹¤.</p>

<p>ê¶Œí•œê³¼ ì•ˆì „ì¥ì¹˜<br />
â€¢ ì„œë²„ë³„ <code class="language-plaintext highlighter-rouge">allowed_tools</code>ë¡œ ë…¸ì¶œ íˆ´ì„ ì œí•œí•˜ê±°ë‚˜, ìì²´ í´ë¼ì´ì–¸íŠ¸ë¼ë©´ íˆ´ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¥¼ ì ìš©í•œë‹¤. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
â€¢ íŒŒê´´ì  íˆ´(ì‚­ì œ/ê²°ì œ ë“±)ì€ â€œdry_runâ€ í”Œë˜ê·¸ë¥¼ ìŠ¤í‚¤ë§ˆì— ì¶”ê°€í•´ 2ë‹¨ê³„ í™•ì¸ì„ ê°•ì œ.<br />
â€¢ í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì§€: ì„œë²„ ì¸¡ì—ì„œ ì…ë ¥ ê²€ì¦ê³¼ URL/ê²½ë¡œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¥¼ ë‘”ë‹¤.</p>

<p>ì„±ëŠ¥/ì•ˆì •ì„±<br />
â€¢ ì´ˆê¸°ì— ëª¨ë“  ì„œë²„ì— <code class="language-plaintext highlighter-rouge">list_tools</code>ë¥¼ í•œ ë²ˆë§Œ í˜¸ì¶œí•˜ê³  ìºì‹±í•˜ë¼.<br />
â€¢ íˆ´ í˜¸ì¶œì€ íƒ€ì„ì•„ì›ƒê³¼ ì¬ì‹œë„ë¥¼ ë‘”ë‹¤. ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ì™€ ë³µêµ¬ íŒíŠ¸ë¥¼ ëª¨ë¸ì—ê²Œ ì§§ê²Œ ì œê³µí•˜ë©´ í›„ì† ê³„íšì„ ëª¨ë¸ì´ ìŠ¤ìŠ¤ë¡œ ì¡°ì •í•œë‹¤.<br />
â€¢ ê²°ê³¼ê°€ í° ê²½ìš°(íŒŒì¼/í‘œ)ëŠ” ë¦¬ì†ŒìŠ¤ ë§í¬ë¥¼ ë°˜í™˜í•˜ë„ë¡ MCP ìª½ì—ì„œ ì„¤ê³„í•˜ë©´ í† í° ì••ë°•ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤(ë¦¬ì†ŒìŠ¤ëŠ” ì»¤ë„¥í„° ê²½ë¡œì— ë”°ë¼ ì œí•œë  ìˆ˜ ìˆìŒ).</p>

<p>ë°°í¬ í† ë§‰ ê°€ì´ë“œ<br />
â€¢ ì›ê²© ì—°ê²° ìœ„ì£¼ë©´ Claudeì˜ MCP ì»¤ë„¥í„°ê°€ ê°€ì¥ ë¹ ë¥¸ ì˜¨ë³´ë”©ì´ë‹¤(ë‹¨, HTTP ê³µê°œ í•„ìš”). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
â€¢ ì‚¬ë‚´ë§Â·ë¡œì»¬ í˜¼í•©ì´ë©´ ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ êµ¬ì„±ì´ ìœ ë¦¬í•˜ë‹¤. TS SDKì˜ streamable HTTP + stdioë¥¼ í˜¼ìš©í•˜ë©´ ëœë‹¤. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>ë‹¤ìŒ í™•ì¥ ì•„ì´ë””ì–´<br />
â€¢ â€œìë™ ë¼ìš°í„°â€: íˆ´ ë©”íƒ€ë°ì´í„°ì— domain íƒœê·¸ë¥¼ ë‘ê³ , ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ë¥˜í•´ ê´€ë ¨ ì„œë²„ íˆ´ë§Œ ëª¨ë¸ì— ë…¸ì¶œ(í† í°/í˜¼ë€ ê°ì†Œ).<br />
â€¢ â€œê´€ì¸¡ì„±â€: ëª¨ë“  tool_use/tool_resultë¥¼ ì´ë²¤íŠ¸ë¡œ ë¡œê·¸ ìˆ˜ì§‘í•´ ì‹¤íŒ¨ìœ¨/ì§€ì—°/ì…ë ¥ ë¶„í¬ë¥¼ ëŒ€ì‹œë³´ë“œë¡œ ë³¸ë‹¤.<br />
â€¢ â€œê¶Œí•œ ìŠ¹ê²©â€: ê³ ìœ„í—˜ íˆ´ í˜¸ì¶œì€ ì‚¬ëŒ í™•ì¸ì„ ìš”êµ¬í•˜ëŠ” ì¸ê°€ í›…ì„ ì¤‘ì•™ í´ë¼ì´ì–¸íŠ¸ì— ì¶”ê°€.</p>

<p>ì›í•˜ë©´ ë„¤ê°€ ì“°ë ¤ëŠ” ì„œë²„ ëª©ë¡ê³¼ ì „ì†¡ ë°©ì‹(stdio/HTTP), ë¶™ì¼ ëª¨ë¸(Claude/OpenAI ë“±)ì„ ì•Œë ¤ì¤˜. ê±°ê¸°ì— ë§ì¶° ì™„ì„± ìŠ¤ìºí´ë”©ì„ ë°”ë¡œ ë‚´ì¤„ê²Œ.</p>

<p class="chat--user">

íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ë§ê³  íŒŒì´ì¬ mcp ë¡œ ë¶€íƒí•´ ê·¸ë¦¬ê³  ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ LLMì„ ì‚¬ìš©í• ê±°ì•¼.

</p>

<p>ì¢‹ì•„. íŒŒì´ì¬ìœ¼ë¡œ MCP ë‹¤ì¤‘ ì„œë²„ë¥¼ ë¶™ì´ê³ , ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸(ìì²´ í˜¸ìŠ¤íŒ… ëª¨ë¸)ì— â€œíˆ´ ì½œë§â€ì„ ëŒë¦¬ëŠ” ì „ì²´ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ìŠ¤ìºí´ë”©ì„ ë°”ë¡œ ì¤„ê²Œ. í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ë‘ ê°€ì§€ë‹¤. ì²«ì§¸, ì—¬ëŸ¬ MCP ì„œë²„ì— ê°ê° ì„¸ì…˜ì„ ì—´ê³  íˆ´ ëª©ë¡ì„ í•©ì³ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(server:tool)ë¡œ ë…¸ì¶œ. ë‘˜ì§¸, ì»¤ìŠ¤í…€ LLMì˜ /chat APIì— íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ì „ë‹¬í•˜ê³ , ì‘ë‹µ ë‚´ tool_callsë¥¼ ë°›ì•„ í•´ë‹¹ MCP ì„œë²„ë¡œ ë¼ìš°íŒ…í•´ ì‹¤í–‰ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— í”¼ë“œë°±í•˜ëŠ” ë£¨í”„ë¥¼ ëˆë‹¤.</p>

<p>ì•„ë˜ ì½”ë“œëŠ” ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ì¼ íŒŒì¼ ì˜ˆì‹œë‹¤. ì»¤ìŠ¤í…€ LLMì˜ API í¬ë§·ì€ OpenAI í•¨ìˆ˜ì½œê³¼ ìœ ì‚¬í•œ í˜•íƒœë¥¼ ê°€ì •í–ˆì§€ë§Œ, í´ë˜ìŠ¤ í•œ êµ°ë°ë§Œ ë°”ê¾¸ë©´ ì–´ë–¤ ì—”ë“œí¬ì¸íŠ¸ë“  ë§ì¶œ ìˆ˜ ìˆë„ë¡ ì–´ëŒ‘í„°ë¥¼ ë¶„ë¦¬í•´ë‘ì—ˆë‹¤.</p>

<p>ì„¤ì¹˜ ê°€ì •<br />
pip install mcp requests pydantic orjson</p>

<p>main.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># ì„ íƒ: SSE(ì›ê²© HTTP) ì„œë²„ë¥¼ ë¶™ì¼ ë•Œ
</span>    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#######################################################################
# 0) ë°ì´í„° ëª¨ë¸: LLMê³¼ íˆ´ì½œ ì¸í„°í˜ì´ìŠ¤(ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ ì–´ëŒ‘í„°ìš©)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI styleì— ê°€ê¹ê²Œ ë…¸ë©€ë¼ì´ì¦ˆí•´ ì»¤ìŠ¤í…€ LLMì— ì „ë‹¬
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(JSON str)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># í•„ìš” ì‹œ stop_reason ë“± ì¶”ê°€
</span>
<span class="c1">#######################################################################
# 1) MCP ì—°ê²° ìœ í‹¸: ì—¬ëŸ¬ ì„œë²„ ì—°ê²°í•˜ê³  íˆ´ í•©ì¹˜ê¸°(ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># stdio ë˜ëŠ” sse
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># sse
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ ì„¤ì¹˜ë˜ì–´ì•¼ SSE ì—°ê²°ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="c1"># t.name, t.description, t.input_schema
</span>                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># JSON Schema
</span>                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># namespaced = "server:tool"
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">íˆ´ ì´ë¦„ì€ </span><span class="sh">'</span><span class="s">server:tool</span><span class="sh">'</span><span class="s"> í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤: </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server_name</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="c1"># MCP í‘œì¤€ contentë¥¼ ë‹¨ì¼ ë¬¸ìì—´ ë˜ëŠ” JSONìœ¼ë¡œ ì •ë¦¬
</span>                <span class="c1"># MCP contentëŠ” list of {type: "text"|"json"|"blob", ...}
</span>                <span class="c1"># ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ text/jsonë§Œ ì§€ì› ì˜ˆì‹œ
</span>                <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># blob/resource ë“±ì€ í•„ìš” ì‹œ í™•ì¥
</span>                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ì„œë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: </span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1">#######################################################################
# 2) ì»¤ìŠ¤í…€ LLM ì–´ëŒ‘í„°: ë„ˆì˜ ì‚¬ì„¤ /chat ì—”ë“œí¬ì¸íŠ¸ì— ë§ì¶° ì¡°ì •
#######################################################################
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë„ˆì˜ ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ ê·œì•½ì„ í•œ ê³³ì— ìº¡ìŠí™”.
    ì•„ë˜ëŠ” ì˜ˆì‹œ ê·œì•½:
      POST {base_url}/chat
      json: {
        </span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}],
        </span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...}}}]
      }
    ì‘ë‹µ:
      {
        </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">assistant text...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [
          {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">{</span><span class="se">\"</span><span class="s">k</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">v</span><span class="se">\"</span><span class="s">}</span><span class="sh">"</span><span class="s">}}
        ]
      }
    í•„ìš”í•œ ê²½ìš° ì´ í´ë˜ìŠ¤ë§Œ ìˆ˜ì •í•˜ë©´ ëœë‹¤.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">extra_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span> <span class="o">=</span> <span class="n">extra_headers</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span> <span class="k">if</span> <span class="n">tools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

<span class="c1">#######################################################################
# 3) ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°: íˆ´ ë³‘í•© â†’ LLM ëŒ€í™” ë£¨í”„ â†’ MCP ë¼ìš°íŒ…
#######################################################################
</span>
<span class="k">def</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">merged_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
    <span class="n">defs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">merged_tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP tool </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="p">}</span>
        <span class="n">defs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">defs</span>

<span class="k">def</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">args_raw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">args_raw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args_raw</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args_raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sh">""</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># ëª¨ë¸ì´ JSONì´ ì•„ë‹Œ ê±¸ ë‚´ëŠ” ê²½ìš° ë°©ì–´
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_conversation</span><span class="p">(</span>
    <span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">):</span>
    <span class="n">tools_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">llm_tools</span> <span class="o">=</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">tools_catalog</span><span class="p">)</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">system_prompt</span><span class="p">:</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">))</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">llm_tools</span><span class="p">)</span>
        <span class="c1"># ìš°ì„  ì–´ì‹œìŠ¤í„´íŠ¸ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì¶”ê°€
</span>        <span class="n">assistant_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="n">assistant_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">assistant_text</span><span class="p">))</span>

        <span class="c1"># íˆ´ì½œ ì—†ìœ¼ë©´ ì¢…ë£Œ
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># MCP ë¼ìš°íŒ… â†’ ê²°ê³¼ë¥¼ tool_resultë¡œ userì— í”¼ë“œë°±
</span>        <span class="n">tool_results_acc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="c1"># ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì—ê²Œ í”¼ë“œë°±: ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ JSON í…ìŠ¤íŠ¸ë¡œ í•©ì¹¨
</span>                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="c1"># ë‹¤ìˆ˜ íˆ´ í˜¸ì¶œ ê²°ê³¼ë¥¼ í•˜ë‚˜ì˜ user ë©”ì‹œì§€ë¡œ ì¬ì£¼ì…
</span>        <span class="n">feedback_text</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tool_results_acc</span><span class="p">)</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="si">{</span><span class="n">feedback_text</span><span class="si">}</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1">#######################################################################
# 4) ìƒ˜í”Œ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
#######################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 4-1) ë¶™ì¼ MCP ì„œë²„ë“¤ ì •ì˜
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># ë¡œì»¬ stdio ì˜ˆì‹œ
</span>        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># ì›ê²© SSE ì˜ˆì‹œ(ìˆë‹¤ë©´)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"authorization":"Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>

    <span class="c1"># 4-2) ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
</span>    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_API_KEY</span><span class="sh">"</span><span class="p">),</span>            <span class="c1"># í•„ìš” ì‹œ
</span>        <span class="n">extra_headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">x-tenant</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo</span><span class="sh">"</span><span class="p">}</span>                 <span class="c1"># í•„ìš” ì‹œ
</span>    <span class="p">)</span>

    <span class="c1"># 4-3) ëŒ€í™” í•œ í„´ ì˜ˆì‹œ
</span>    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ë„ˆëŠ” MCP íˆ´ì„ í™œìš©í•´ ì¼ì„ ëë‚´ëŠ” ì—ì´ì „íŠ¸ë‹¤. ìœ„í—˜ ì‘ì—…ì€ dry_runì„ ì„ í˜¸í•˜ê³ , ëª…ì‹œì ìœ¼ë¡œ ìŠ¹ì¸ë°›ê¸° ì „ì—ëŠ” íŒŒê´´ì  ë³€ê²½ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSVë¥¼ files ì„œë²„ì˜ ingest_csv íˆ´ë¡œ ì ì¬í•˜ê³ , db ì„œë²„ì˜ sql_summaryë¡œ ìš”ì•½í•´ì¤˜. íŒŒì¼ ê²½ë¡œëŠ” ./data/sales.csv</span><span class="sh">"</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_conversation</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ìµœì¢… ëŒ€í™” ë¡œê·¸ ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">2000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ë™ì‘ íë¦„ ì„¤ëª…<br />
1ë‹¨ê³„. MCPMuxê°€ ê° ì„œë²„ì— ì„¸ì…˜ì„ ì—°ë‹¤. stdio ì„œë²„ëŠ” command+argsë¡œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê³ , sse ì„œë²„ëŠ” HTTP SSEë¡œ ì—°ê²°í•œë‹¤.<br />
2ë‹¨ê³„. list_toolsë¥¼ ëª¨ë“  ì„œë²„ì—ì„œ ëª¨ì•„ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(server:tool)ë¡œ ë³€í™˜í•œë‹¤.<br />
3ë‹¨ê³„. ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸ì— messagesì™€ toolsë¥¼ ë„˜ê¸´ë‹¤. toolsëŠ” OpenAIì‹ function í¬ë§·ìœ¼ë¡œ ì •ê·œí™”í•´ì„œ ì „ë‹¬í•œë‹¤.<br />
4ë‹¨ê³„. LLMì´ tool_callsë¥¼ ë°˜í™˜í•˜ë©´, ê° callì˜ function.nameì´ server:toolì´ë¯€ë¡œ í•´ë‹¹ ì„œë²„ë¡œ ë¼ìš°íŒ…í•´ì„œ call_toolì„ ì‹¤í–‰í•œë‹¤.<br />
5ë‹¨ê³„. ê²°ê³¼ë¥¼ TOOL_RESULTS í…ìŠ¤íŠ¸ë¡œ user ì—­í•  ë©”ì‹œì§€ì— í•©ì³ì„œ ëª¨ë¸ì— ë‹¤ì‹œ ì£¼ì…í•œë‹¤. ëª¨ë¸ì€ ì¶”ê°€ì ì¸ tool_callsë¥¼ ë‚´ê±°ë‚˜, ìµœì¢… ë‹µë³€ì„ ë‚¸ë‹¤.<br />
6ë‹¨ê³„. tool_callsê°€ ë” ì´ìƒ ì—†ìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ.</p>

<p>ìš´ì˜ íŒ<br />
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³ ì •. server:tool ë„¤ì´ë°ì„ ìŠ¤í‚¤ë§ˆ descriptionì—ë„ ë°˜ë³µí•´ì„œ LLMì˜ ì„ íƒ ì˜¤ë¥˜ë¥¼ ì¤„ì¸ë‹¤.<br />
ê¶Œí•œ ê²½ê³„. ì‚­ì œÂ·ê²°ì œÂ·ë°°í¬ ê°™ì€ íˆ´ì—ëŠ” parametersì— dry_run(boolean, default true) ê°™ì€ í•„ë“œë¥¼ ì¶”ê°€í•´ 2ë‹¨ê³„ ìŠ¹ì¸ì„ ìœ ë„í•˜ë¼.<br />
íƒ€ì„ì•„ì›ƒÂ·ì¬ì‹œë„. SSEë‚˜ stdio ëª¨ë‘ ì™¸ë¶€ í”„ë¡œì„¸ìŠ¤/ë„¤íŠ¸ì›Œí¬ì— ë¯¼ê°í•˜ë‹ˆ call_toolì—ëŠ” ì„œë²„ ì¸¡ íƒ€ì„ì•„ì›ƒê³¼ ì¬ì‹œë„ë¥¼ ë‘”ë‹¤. í•„ìš” ì‹œ MCPMux.callì— ì¬ì‹œë„ë¥¼ ì¶”ê°€í•˜ë¼.<br />
ëŒ€ìš©ëŸ‰ ê²°ê³¼. íŒŒì¼Â·í‘œÂ·ë°”ì´ë„ˆë¦¬ ê²°ê³¼ëŠ” MCP ë¦¬ì†ŒìŠ¤(íŒŒì¼ í•¸ë“¤)ë‚˜ ì™¸ë¶€ ì €ì¥ì†Œ URLì„ ë°˜í™˜í•˜ê³ , LLMì—ëŠ” ë©”íƒ€ë°ì´í„°ë§Œ ë³´ë‚´ í† í°ì„ ì•„ë¼ëŠ” ì„¤ê³„ë¥¼ ì¶”ì²œí•œë‹¤.<br />
ì ì‘ì¸µ. CustomLLMClientë¥¼ ë„ˆì˜ ì‹¤ì œ /chat ê·œê²©ì— ë§ê²Œ ìˆ˜ì •í•œë‹¤. ì˜ˆì»¨ëŒ€ ë¬¸ì„œí™”ëœ JSON í‚¤ ì´ë¦„ì´ ë‹¤ë¥´ë©´ ChatResponse íŒŒì‹±ë§Œ ë°”ê¾¸ë©´ ëœë‹¤.</p>

<p>í…ŒìŠ¤íŠ¸ ë°©ë²•<br />
ê°€ì§œ ì„œë²„ë¶€í„°. servers ë””ë ‰í„°ë¦¬ì— echo ìˆ˜ì¤€ì˜ ê°„ë‹¨í•œ MCP ì„œë²„ ë‘ ê°œ(files, db)ë¥¼ ë§Œë“¤ì–´ list_toolsì™€ call_toolë§Œ ìµœì†Œ êµ¬í˜„í•œë‹¤.<br />
ë‹¨ìœ„ í…ŒìŠ¤íŠ¸. CustomLLMClient.sendë¥¼ ëª¨í‚¹í•´ tool_callsë¥¼ ê°•ì œë¡œ ë‚´ë³´ë‚´ê³ , MCPMux.callì´ ì˜¬ë°”ë¥¸ ì„œë²„ë¡œ ë¼ìš°íŒ…ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.<br />
ì—”ë“œíˆ¬ì—”ë“œ. ì‹¤ì œ LLM ì—”ë“œí¬ì¸íŠ¸ë¡œ êµì²´í•´ CSV â†’ SQL ìš”ì•½ ê°™ì€ ì›Œí¬í”Œë¡œë¥¼ í•œ ë²ˆì— ëŒë ¤ë³¸ë‹¤.</p>

<p>í™•ì¥ ì•„ì´ë””ì–´<br />
ìë™ ë¼ìš°íŒ…. ë„ë©”ì¸ íƒœê·¸(files/db/search ë“±)ë¥¼ ë³´ê³  ê´€ë ¨ íˆ´ë§Œ tools ë°°ì—´ì— ë…¸ì¶œí•´ í† í°ê³¼ í˜¼ë€ì„ ì¤„ì¸ë‹¤.<br />
ê°ì‚¬ ë¡œê·¸. ëª¨ë“  tool_call ì…ë ¥Â·ì¶œë ¥ì„ JSONLë¡œ íŒŒì¼ì— ì ì¬í•´ ì§€ì—°, ì‹¤íŒ¨ìœ¨, ìœ„í—˜ í˜¸ì¶œì„ ëª¨ë‹ˆí„°ë§í•œë‹¤.<br />
íœ´ë¨¼ ê²Œì´íŠ¸. ìœ„í—˜í•œ íˆ´ì½œì´ ê°ì§€ë˜ë©´ CustomLLMClientë¡œ ë°”ë¡œ ë³´ë‚´ì§€ ë§ê³ , ë³„ë„ ìŠ¹ì¸ UI í˜¹ì€ CLIì—ì„œ 1íšŒ ìŠ¹ì¸ í›„ ì¬ì£¼ì…í•œë‹¤.</p>

<p>ì›í•˜ëŠ” /chat ê·œê²©(JSON ì˜ˆì‹œ ìŠ¤í™)ì´ë‚˜ ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ ìƒ˜í”Œì„ ì•Œë ¤ì£¼ë©´, ìœ„ ì–´ëŒ‘í„°ë¥¼ ê±°ê¸°ì— ë”± ë§ì¶° êµ¬ì²´í™”í•´ì„œ ë¦¬ë¼ì´íŠ¸í•´ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì§ˆë¬¸ì´ ìˆì–´. 1. ê·¸ëƒ¥ íˆ´ì„ ê·¸ëŒ€ë¡œ ë³´ë‚´ë©´ ì˜¤ë¥˜ê°€ ë” ë§ì„ê¹Œ? 2. ì¼ë°˜ íˆ´ ì½œë§ê³¼ ì„ì—¬ ìˆëŠ” ì˜ˆì‹œë„ ë³´ì—¬ì£¼ë©´ ì¢‹ê² ì–´. 

</p>

<p>ì¢‹ì•„, ë‘ ê°€ì§€ ëª¨ë‘ ë”± ê½‚íˆê²Œ ì •ë¦¬í•´ì¤„ê²Œ. ê²°ë¡  ë¨¼ì €, ê·¸ë‹¤ìŒ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì´ì¬ ì˜ˆì‹œë¡œ ë§ˆë¬´ë¦¬í•œë‹¤.</p>

<ol>
  <li>ê·¸ëƒ¥ â€œì„œë²„ì—ì„œ ë°›ì€ íˆ´ì„ ì „ë¶€â€ ëª¨ë¸ì— ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ë©´ ì˜¤ë¥˜ê°€ ë” ë§ì„ê¹Œ?<br />
ì§§ì€ ë‹µ: ë³´í†µ ê·¸ë ‡ë‹¤. ì´ìœ ëŠ” ì˜ˆì¸¡ ê°€ëŠ¥í•˜ë‹¤.</li>
</ol>

<ul>
  <li>
    <p>ê³¼ì ì¬(too many tools). íˆ´ì´ ë§ì•„ì§ˆìˆ˜ë¡ ì„ íƒ ì˜¤ë¥˜ê°€ ëŠ˜ê³ , ëª¨ë¸ì´ ë¹„ìŠ·í•œ íˆ´ì„ í˜¼ë™í•œë‹¤. ë¹„ìŠ·í•œ ì´ë¦„, ë¹„ìŠ·í•œ ì„¤ëª…ì€ íŠ¹íˆ ìœ„í—˜í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ìŠ¤í‚¤ë§ˆ ëŠìŠ¨í•¨. parameters(JSON Schema)ì— íƒ€ì…Â·í•„ìˆ˜ í•„ë“œÂ·enum ì œì•½ì´ ì•½í•˜ë©´ arguments í˜•ì‹ ì˜¤ë¥˜ê°€ ì¦ê°€í•œë‹¤.</p>
  </li>
  <li>
    <p>ë¬¸ë§¥ ë¯¸ìŠ¤ë§¤ì¹˜. í˜„ì¬ í„´ê³¼ ê´€ê³„ì—†ëŠ” íˆ´ê¹Œì§€ ëª¨ë‘ ë³´ì´ë©´ â€œê·¼ì²˜ì— ìˆëŠ” ë„êµ¬â€ í¸í–¥ ë•Œë¬¸ì— ì—‰ëš±í•œ ê±¸ ì§‘ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ë„¤ì„ ì¶©ëŒÂ·ì˜ë„ ì¶©ëŒ. ì„œë¡œ ë‹¤ë¥¸ ì„œë²„ì— ê°™ì€ ì´ë¦„, ìœ ì‚¬ ê¸°ëŠ¥ì´ ìˆìœ¼ë©´ ë¼ìš°íŒ…Â·ì„ íƒ ëª¨ë‘ í”ë“¤ë¦°ë‹¤.</p>
  </li>
  <li>
    <p>ë¶€ì‘ìš© ìœ„í—˜. ì‚­ì œ/ê²°ì œ/ë°°í¬ ê°™ì€ íˆ´ì„ ì•„ë¬´ ë§¥ë½ ì—†ì´ ë…¸ì¶œí•˜ë©´ ëª¨ë¸ì´ ì„±ê¸‰íˆ ì‹¤í–‰í•˜ë ¤ í•œë‹¤(ëª¨ë¸ì€ ê³¼ê°í•˜ë‹¤).</p>
  </li>
  <li>
    <p>ë ˆì´í„´ì‹œÂ·ì‹¤íŒ¨ ì „íŒŒ. ì›ê²©/SSE íˆ´ ë‹¤ìˆ˜ëŠ” íƒ€ì„ì•„ì›ƒê³¼ 429ê°€ ë’¤ì„ì—¬ ì—ëŸ¬ ì¦í­ì„ ë§Œë“ ë‹¤.</p>
  </li>
</ul>

<p>í˜„ì—…ì—ì„œ ì—ëŸ¬ë¥¼ ì¤„ì´ëŠ” ì‹¤ì „ ì²˜ë°©</p>

<ul>
  <li>
    <p>í„´ë³„ íˆ´ ì†Œì¶œ(Selective exposure). ìœ ì € ì…ë ¥ì„ ê¸°ì¤€ìœ¼ë¡œ ê´€ë ¨ ì„œë²„/ë„ë©”ì¸ì˜ íˆ´ë§Œ ë…¸ì¶œí•œë‹¤. ë‹¨ìˆœ í‚¤ì›Œë“œ ë¼ìš°íŒ…ë§Œ ë„£ì–´ë„ ì‹¤íŒ¨ìœ¨ì´ ëš ë–¨ì–´ì§„ë‹¤.</p>
  </li>
  <li>
    <p>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í•„ìˆ˜. server:tool ì´ë¦„ìœ¼ë¡œ ê³ ì •í•˜ê³ , descriptionì—ë„ ì„œë²„/ë„ë©”ì¸ì„ ë°˜ë³µ ëª…ì‹œí•œë‹¤.</p>
  </li>
  <li>
    <p>ìŠ¤í‚¤ë§ˆë¥¼ ì—„ê²©í•˜ê²Œ. type/enum/minItems/formatê¹Œì§€ ë¹¡ë¹¡í•˜ê²Œ ê±¸ì–´ë¼. ê°€ëŠ¥í•˜ë©´ ì˜ˆì œ(example) í•„ë“œê¹Œì§€ ë„£ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ê³ ìœ„í—˜ íˆ´ì— ì„¸ì´í”„í‹° í”Œë˜ê·¸. dry_run ê¸°ë³¸ê°’ true, confirmation string ê°™ì€ ì´ì¤‘ ì ê¸ˆ.</p>
  </li>
  <li>
    <p>ì‘ë‹µ ì •ê·œí™”. MCP tool_resultë¥¼ í•­ìƒ ê°™ì€ JSON í¬ë§·ìœ¼ë¡œ ë¬¶ì–´ ëª¨ë¸ì— ì¬ì£¼ì…í•´ í•™ìŠµëœ ê¸°ëŒ€ í˜•íƒœë¥¼ ìœ ì§€í•œë‹¤.</p>
  </li>
  <li>
    <p>íƒ€ì„ì•„ì›ƒ/ì¬ì‹œë„/ë°±ì˜¤í”„ í‘œì¤€í™”. ì„œë²„ë³„ ê¸°ë³¸ê°’ì´ ë‹¬ë¼ë„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒí•œì„ í†µì¼í•œë‹¤.</p>
  </li>
  <li>
    <p>íˆ´ ìº¡. í•œ í„´ì— ìµœëŒ€ 10~20ê°œ ì •ë„ë§Œ ë…¸ì¶œ(ê²½í—˜ìƒ 8~12ì—ì„œ ê°€ì¥ ì•ˆì •ì ).</p>
  </li>
</ul>

<ol>
  <li>â€œì¼ë°˜ íˆ´ ì½œë§â€ê³¼ â€œMCP íˆ´ ì½œë§â€ì´ ì„ì—¬ ìˆëŠ” ì˜ˆì‹œ<br />
ì•„ë˜ëŠ” ì´ì „ íŒŒì´ì¬ ìŠ¤ìºí´ë”©ì„ ì–‡ê²Œ í™•ì¥í•œ ë²„ì „ì´ë‹¤. í•µì‹¬ì€ ë””ìŠ¤íŒ¨ì²˜ì— ë¡œì»¬(ì¼ë°˜) íˆ´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ local.* ë¥¼ ì¶”ê°€í•˜ê³ , LLMì´ ê°™ì€ í„´ì—ì„œ local.* ê³¼ server:tool(MCP)ì„ ì„ì–´ì„œ í˜¸ì¶œí•´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë¼ìš°íŒ…ë˜ëŠ” êµ¬ì¡°ë‹¤.</li>
</ol>

<p>í•„ìš” íŒ¨í‚¤ì§€<br />
pip install mcp requests pydantic orjson</p>

<p>mixed_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="c1"># ======== ê³µìš© ë°ì´í„° ëª¨ë¸ ========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># ======== MCP ë©€í‹° ì„œë²„ MUX ========
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ======== ë¡œì»¬(ì¼ë°˜) íˆ´: ì˜ˆì‹œ êµ¬í˜„ ========
</span>
<span class="k">def</span> <span class="nf">local_tools_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „í•œ ì‚¬ì¹™ì—°ì‚°/ê°„ë‹¨ì‹ í‰ê°€ê¸°. ì…ë ¥: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í…ìŠ¤íŠ¸ì—ì„œ ìì£¼ ë“±ì¥í•˜ëŠ” ë‹¨ì–´ ìƒìœ„ Kë¥¼ ë½‘ì•„ì¤€ë‹¤. ì…ë ¥: {text: string, k: integer}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># ì•„ì£¼ ë³´ìˆ˜ì ì¸ ê³„ì‚°ê¸°(ìˆ«ì, + - * / () ë§Œ í—ˆìš©)
</span>        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}}]}</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">collections</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[A-Za-z0-9ê°€-í£]+</span><span class="sh">"</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="nc">Counter</span><span class="p">([</span><span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">])</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">.</span><span class="nf">most_common</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">top</span><span class="sh">"</span><span class="p">:</span> <span class="n">top</span><span class="p">}}]}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ======== ì»¤ìŠ¤í…€ LLM ì–´ëŒ‘í„°(ì˜ˆì‹œ) ========
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>

<span class="c1"># ======== íˆ´ ë…¸ì¶œ ì „ëµ(ê°„ë‹¨ ì†Œì¶œ ì˜ˆì‹œ) ========
</span>
<span class="k">def</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">keep</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">user_text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>

    <span class="c1"># í‚¤ì›Œë“œ ê¸°ë°˜ ë¼ìš°íŒ…(ì•„ì£¼ ì–•ì€ ì˜ˆì‹œ)
</span>    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">íŒŒì¼</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ingest</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">load</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì¿¼ë¦¬</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ë°ì´í„°ë² ì´ìŠ¤</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ìš”ì•½</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">summary</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># í•­ìƒ ë…¸ì¶œí•  ë¡œì»¬ ë„êµ¬
</span>    <span class="n">local_basics</span> <span class="o">=</span> <span class="nf">local_tools_catalog</span><span class="p">()</span>

    <span class="c1"># ì¤‘ë³µ ì œê±° ë° ì´ë¦„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì ìš©
</span>    <span class="k">def</span> <span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

    <span class="n">uniq</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
        <span class="n">uniq</span><span class="p">[(</span><span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">tooldefs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">uniq</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>
    <span class="n">tooldefs</span> <span class="o">+=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]})</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">local_basics</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tooldefs</span>

<span class="c1"># ======== ëŒ€í™” ë£¨í”„ ========
</span>
<span class="k">def</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>
    <span class="n">all_mcp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system</span><span class="p">),</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">tools_exposed</span> <span class="o">=</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">)</span>  <span class="c1"># í„´ë³„ ì†Œì¶œ
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools_exposed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># ì„ì—¬ ìˆëŠ” íˆ´ì½œ ì²˜ë¦¬: local.* â†” server:tool
</span>        <span class="n">results_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_texts</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ======== ì‹¤í–‰ ì˜ˆì‹œ ========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
    <span class="p">])</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ë„ˆëŠ” ì•ˆì „í•˜ê³  ì‹ ì¤‘í•œ ì—ì´ì „íŠ¸ë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSVë¥¼ ì ì¬í•˜ê³ (sql ìš”ì•½ê¹Œì§€). ìˆ˜ì¹˜ í™•ì¸ì€ ê³„ì‚°ê¸°ë¡œ í•œë²ˆ ê²€ì¦í•´ì¤˜. íŒŒì¼ì€ ./data/sales.csv ì´ì•¼.</span><span class="sh">"</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== LOG ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì´ ì½”ë“œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê²ƒ</p>

<ul>
  <li>
    <p>í•œ í„´ì— LLMì´ local.math_eval(ì¼ë°˜ íˆ´)ê³¼ files:ingest_csv(MCP) / db:sql_summary(MCP)ë¥¼ ì„ì–´ í˜¸ì¶œí•´ë„ ë””ìŠ¤íŒ¨ì²˜ê°€ ê°ê° ë§ëŠ” ê²½ë¡œë¡œ ë¼ìš°íŒ…í•œë‹¤.</p>
  </li>
  <li>
    <p>selective_exposeê°€ í„´ë³„ íˆ´ ì†Œì¶œì„ í•´ì¤€ë‹¤. ìœ ì € ìš”ì²­ì— í•„ìš” ì—†ëŠ” ì„œë²„ íˆ´ì€ ìˆ¨ê²¨ì„œ í˜¼ë€ê³¼ ì—ëŸ¬ë¥¼ ì¤„ì¸ë‹¤.</p>
  </li>
  <li>
    <p>ë¡œì»¬ íˆ´ì€ íŒŒì´ì¬ í•¨ìˆ˜ë¡œ ë°”ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë ˆì´í„´ì‹œê°€ ì ê³ , ê°„ë‹¨í•œ ê²€ì¦Â·í›„ì²˜ë¦¬(ì˜ˆ: ê³„ì‚°ìœ¼ë¡œ sanity-check)ë¥¼ ë¹ ë¥´ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
</ul>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ, ì—ëŸ¬ë¥¼ ë” ì¤„ì´ë ¤ë©´</p>

<ul>
  <li>
    <p>íˆ´ ì„¤ëª…ì— â€œì–¸ì œ ì“°ëŠ”ì§€/ì–¸ì œ ì“°ì§€ ë§ì•„ì•¼ í•˜ëŠ”ì§€â€ë¥¼ í•œ ë¬¸ì¥ì”© ëª…ì‹œí•œë‹¤.</p>
  </li>
  <li>
    <p>ìœ„í—˜ íˆ´ì˜ parametersì— confirm ë¬¸ìì—´(ì˜ˆ: "I understand this deletes data")ì„ requiredë¡œ ì¶”ê°€í•œë‹¤.</p>
  </li>
  <li>
    <p>TOOL_RESULTS í¬ë§·ì„ íŒ€ ê³µí†µ JSON ìŠ¤í‚¤ë§ˆë¡œ ê³ ì •í•´ ëª¨ë¸ì´ ì˜ˆì¸¡ ê°€ëŠ¥í•œ í›„ì† ê³„íšì„ ì„¸ìš°ë„ë¡ í•œë‹¤.</p>
  </li>
  <li>
    <p>ê° ì„œë²„/íˆ´ë³„ íƒ€ì„ì•„ì›ƒÂ·ì¬ì‹œë„Â·ì„œí‚·ë¸Œë ˆì´ì»¤ë¥¼ ê³µí†µ ë¯¸ë“¤ì›¨ì–´ë¡œ ë¬¶ëŠ”ë‹¤.</p>
  </li>
</ul>

<p>ì—¬ê¸°ê¹Œì§€ë©´ ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸ì—ì„œë„ â€œì¼ë°˜+MCP í˜¼í•© íˆ´ì½œâ€ì„ ì•ˆì •ì ìœ¼ë¡œ ëŒë¦´ ìˆ˜ ìˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ëŠ” ë„¤ê°€ ì“°ëŠ” /chat ìŠ¤í™ì— ë§ì¶° CustomLLMClientì˜ ì§ë ¬í™”/ì—­ì§ë ¬í™” ë¶€ë¶„ë§Œ ë¯¸ì„¸ì¡°ì •í•˜ê³ , ì‹¤ì œ ì„œë²„ ë‘ ê°œ(files/db) ìµœì†Œ êµ¬í˜„ìœ¼ë¡œ E2Eë¥¼ í•œ ë²ˆ êµ´ë ¤ë³´ëŠ” ê²ƒì´ë‹¤.</p>

<p class="chat--user">

ì˜¤í˜¸. ë‹¤ìŒì€ ì–´ë ¤ìš´ ë¬¸ì œì•¼. ì´ê±¸ openai agent python sdkì— ë¶™ì¼ ìˆ˜ ìˆì„ê¹Œ?

</p>

<p>ê°€ëŠ¥í•˜ë‹¤. ê²Œë‹¤ê°€ â€œì—¬ëŸ¬ MCP ì„œë²„â€ì™€ â€œì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸â€ë¥¼ ë™ì‹œì— ì“°ëŠ” êµ¬ì„±ì´ OpenAI Agents Python SDKì—ì„œ ì •ì„ìœ¼ë¡œ ì§€ì›ëœë‹¤. ìš”ì ë§Œ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•˜ê³ , ë°”ë¡œ ëŒì•„ê°€ëŠ” ìµœì†Œ ì˜ˆì‹œë¥¼ ì¤€ë‹¤.</p>

<p>í•µì‹¬ ì •ë¦¬</p>

<ol>
  <li>
    <p>Agents SDKëŠ” MCPë¥¼ 4ê°€ì§€ ì „ì†¡ìœ¼ë¡œ ë¶™ì¸ë‹¤: Hosted MCP(Responses APIê°€ ì›ê²©ì„œë²„ë¥¼ ì§ì ‘ í˜¸ì¶œ), Streamable HTTP, HTTP+SSE, stdio(ë¡œì»¬ í”„ë¡œì„¸ìŠ¤). ì„œë²„ ì—¬ëŸ¬ ê°œë¥¼ mcp_servers ë¦¬ìŠ¤íŠ¸ì— ë„£ìœ¼ë©´ í•œ ì—ì´ì „íŠ¸ê°€ ì „ë¶€ë¥¼ ë³¸ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>ëª¨ë¸ì€ OpenAI ëª¨ë¸ ë§ê³ ë„ LiteLLM í™•ì¥ì„ í†µí•´ â€œOpenAI í˜¸í™˜ RESTâ€ë¡œ ë…¸ì¶œëœ ì„ì˜ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ëª¨ë¸ì²˜ëŸ¼ ì“¸ ìˆ˜ ìˆë‹¤. base_urlë§Œ ë„¤ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë°”ê¾¸ë©´ ëœë‹¤. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Hosted MCPë¥¼ ì“°ë©´ OpenAI ì¸í”„ë¼ê°€ ì›ê²© MCP ì„œë²„ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ë¯€ë¡œ íŒŒì´ì¬ ìª½ ì½œë°±ì´ í•„ìš” ì—†ë‹¤(ê³µê°œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì›ê²© ì„œë²„ì— ì í•©). ë°˜ëŒ€ë¡œ ì‚¬ë‚´ë§/ë¡œì»¬ì€ stdioÂ·SSE ë“± â€œì§ì ‘ ë¶™ì´ê¸°â€ê°€ ë§ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Agents SDKì—ëŠ” MCP ì „ìš© í´ë˜ìŠ¤ë“¤ì´ ì´ë¯¸ ë“¤ì–´ìˆë‹¤(MCPServerStdio, MCPServerSse, MCPServerStreamableHttp, HostedMCPTool ë“±). <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub+1</a></p>
  </li>
</ol>

<p>ë¹ ë¥¸ ìŠ¤ìºí´ë”©(íŒŒì´ì¬)<br />
ì„¤ì¹˜<br />
pip install openai-agents mcp</p>

<p>ì˜ˆì‹œ 1) ì»¤ìŠ¤í…€ LLM(base_url) + stdio/SSE MCP ë‹¤ì¤‘ ì„œë²„ í•œ ë²ˆì— ë¶™ì´ê¸°<br />
ì•„ë˜ëŠ” íŒŒì¼ì‹œìŠ¤í…œ MCPë¥¼ ë¡œì»¬(stdio)ë¡œ, ì‚¬ë‚´ìš© ê²€ìƒ‰ MCPë¥¼ SSEë¡œ ë¶™ì´ê³ , ëª¨ë¸ì€ ë„ˆì˜ ì»¤ìŠ¤í…€ /v1 Chat í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì”€.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>  <span class="c1"># ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ìš©
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP ì„œë²„ë“¤ì„ context managerë¡œ ê¸°ë™/ì—°ê²°
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer XYZ</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="c1"># 2) ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸(OpenAI í˜¸í™˜) ëª¨ë¸ë¡œ ì§€ì •
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>                 <span class="c1"># ì—”ì§„/ì´ë¦„
</span>            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>     <span class="c1"># ë„¤ ì—”ë“œí¬ì¸íŠ¸
</span>            <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">sk-your-key</span><span class="sh">"</span><span class="p">,</span>                   <span class="c1"># í•„ìš”ì‹œ
</span>        <span class="p">)</span>

        <span class="c1"># 3) ì—ì´ì „íŠ¸ êµ¬ì„±: ì—¬ëŸ¬ MCP ì„œë²„ë¥¼ í•œ ë²ˆì— ë…¸ì¶œ
</span>        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Orchestrator</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP íˆ´ì„ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•˜ê³ , í•„ìš”í•  ë•Œë§Œ í˜¸ì¶œí•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># í•„ìš” ì‹œ "required"ë¡œ ê°•ì œ
</span>        <span class="p">)</span>

        <span class="c1"># 4) ì‹¤í–‰
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data í´ë”ì˜ CSVë¥¼ ì½ê³ , search ì„œë²„ë¡œ ê´€ë ¨ ë¬¸ì„œ ì°¾ì•„ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì˜ˆì‹œ 2) Hosted MCPë¥¼ ì„ëŠ” ë³€í˜•<br />
ì›ê²©ì— ê³µê°œëœ MCP ì„œë²„ëŠ” HostedMCPTool í•˜ë‚˜ë§Œ toolsì— ë„£ìœ¼ë©´ ëª¨ë¸ì´ OpenAI ì¸í”„ë¼ì—ì„œ ì§ì ‘ ëª©ë¡ì¡°íšŒ/í˜¸ì¶œê¹Œì§€ í•œë‹¤. íŒŒì´ì¬ ìª½ ì½œë°±ì´ ê±°ì˜ ì—†ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">HostedMCPTool</span>

<span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">HostedMCPUser</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="nc">HostedMCPTool</span><span class="p">(</span><span class="n">tool_config</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_label</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gitmcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://gitmcp.io/openai/codex</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">require_approval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">})],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì´ ì €ì¥ì†Œì˜ ì£¼ìš” ì–¸ì–´ë¥¼ ì•Œë ¤ì¤˜</span><span class="sh">"</span><span class="p">).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>ìœ„ ë‘ ë°©ì‹ì€ ê³µì‹ ë¬¸ì„œì˜ ì‚¬ìš©ë²•ê³¼ ë™ì¼í•œ íë¦„ì´ë‹¤. Hosted MCP, stdio/SSE/HTTP ì„œë²„, íˆ´ í•„í„°ë§, ìŠ¹ì¸ í›…ê¹Œì§€ í¬í•¨ëœ ê°€ì´ë“œë¥¼ ì°¸ê³ í•´ ì„¸ë¶€ì˜µì…˜ì„ ë§ì¶”ë©´ ëœë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>

<p>íˆ´ ì†Œì¶œ ì „ëµ(ì˜¤ë¥˜ ì¤„ì´ëŠ” íŒ)</p>

<ol>
  <li>
    <p>íˆ´ í•„í„°ë§: ì„œë²„ ìƒì„±ìì— tool_filterë¥¼ ê±¸ê±°ë‚˜ ì •ì /ë™ì  í•„í„°ë¥¼ ì¨ì„œ í„´ë³„ë¡œ í•„ìš”í•œ íˆ´ë§Œ ë…¸ì¶œí•˜ë¼. SDKê°€ ë„ìš°ë¯¸ë¥¼ ì œê³µí•œë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>ìœ„í—˜ íˆ´ ìŠ¹ì¸: HostedMCPToolì€ require_approval ë° on_approval_request ì½œë°±ìœ¼ë¡œ ë¯¼ê° ì‘ì—…ì„ ìŠ¹ì¸ í”Œë¡œë¡œ ê°ì‹¼ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>ìºì‹±ê³¼ ì¬ì‹œë„: cache_tools_list, max_retry_attempts ë“± ì˜µì…˜ìœ¼ë¡œ ì§€ì—°ê³¼ ì‹¤íŒ¨ í™•ë¥ ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
</ol>

<p>í•œ ì¤„ ê²°ë¡ <br />
OpenAI Agents Python SDKì— ë„¤ê°€ ë§Œë“  â€œë©€í‹° MCP + ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸â€ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì¼ ìˆ˜ ìˆë‹¤. ëª¨ë¸ì€ LiteLLMModelë¡œ ì»¤ìŠ¤í…€ RESTë¥¼ ì“°ê³ , MCPëŠ” mcp_serversì— ì—¬ëŸ¬ ê°œë¥¼ ì—´ê±°í•˜ê±°ë‚˜ HostedMCPToolì„ ë³‘ìš©í•˜ë©´ ëœë‹¤. í•„ìš”í•˜ë©´ ë„ˆì˜ ì—”ë“œí¬ì¸íŠ¸ ìŠ¤í™ì— ë§ì¶° ëª¨ë¸ ì–´ëŒ‘í„°ë¥¼ ë” ì´˜ì´˜í•˜ê²Œ ì„¤ì •í•˜ëŠ” ì½”ë“œë„ ë§Œë“¤ì–´ì£¼ê² ë‹¤. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub+2</a></p>

<p class="chat--user">

ì•„ë‹ˆ ë‚œ ë„ˆê°€ ë§Œë“  ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì“°ê³  ì‹¶ì–´. ì™œëƒë©´ ì´ë ‡ê²Œ ë§Œë“  ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‹¤ë¥¸ Chat ì—ë„ ì“°ê³  ì‹¶ê±°ë“ . Agentë§Œì„ ìœ„í•œ ë‹¤ë¥¸ ì½”ë“œê°€ ë¶„ê¸° ë˜ëŠ” ê²ƒì´ ì‹«ì–´. Toolë§Œ ì…ë ¥í•´ì„œ ë™ì‘í•˜ê²Œ í•˜ëŠ” ë°©ë²• ì—†ì–´?

</p>

<p>ì¢‹ì•„. â€œAgent ì „ìš© ë¶„ê¸° ì—†ì´â€ ë„ˆê°€ ë§Œë“  ì¸í„°í˜ì´ìŠ¤ë¥¼ ì–´ë–¤ Chatì—ë„ ì¬ì‚¬ìš©í•˜ë ¤ë©´, ì…ë ¥ì€ ì˜¤ì§ íˆ´(=í”„ë¡œë°”ì´ë”)ê³¼ LLM ì—”ë“œí¬ì¸íŠ¸ë§Œ ì£¼ê³  ëŒì•„ê°€ëŠ” ì–‡ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ í•„ìš”í•˜ë‹¤. ì•„ë˜ëŠ” ê·¸ ëª©ì ì— ë§ì¶˜ ë‹¨ì¼ íŒŒì¼ ìŠ¤ìºí´ë”©ì´ë‹¤. í•µì‹¬ì€ ì„¸ ê°€ì§€ ì¸í„°í˜ì´ìŠ¤ë‹¤.</p>

<ol>
  <li>
    <p>ChatBackend: ì–´ë–¤ ì±„íŒ… ëª¨ë¸ì´ë“  ë¶™ì¼ ìˆ˜ ìˆëŠ” ë°±ì—”ë“œ ì–´ëŒ‘í„°.</p>
  </li>
  <li>
    <p>ToolProvider: íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ ë…¸ì¶œí•˜ê³  í˜¸ì¶œì„ ì²˜ë¦¬í•˜ëŠ” í‘œì¤€ ì¸í„°í˜ì´ìŠ¤.</p>
  </li>
  <li>
    <p>Orchestrator: messages + toolsë§Œìœ¼ë¡œ ë£¨í”„ë¥¼ ëŒë¦°ë‹¤. ì–´ë–¤ ì—ì´ì „íŠ¸ SDK ë¶„ê¸°ë„ ì—†ë‹¤.</p>
  </li>
</ol>

<p>ì„¤ì¹˜<br />
pip install mcp requests pydantic orjson</p>

<p>tools_only.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== ê³µí†µ ë°ì´í„° ëª¨ë¸ ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI/í•¨ìˆ˜ì½œ í˜¸í™˜ í¬ë§·ìœ¼ë¡œ í†µì¼
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(str or dict)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend ì¸í„°í˜ì´ìŠ¤ ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    OpenAI Chat Completions í˜¸í™˜(ë˜ëŠ” ìœ ì‚¬) ì—”ë“œí¬ì¸íŠ¸ìš© ë°±ì—”ë“œ.
    /v1/chat/completions ë˜ëŠ” /chat ê°™ì€ ê³³ì— ë§ì¶° ìµœì†Œí•œì˜ ì–´ëŒ‘í„°ë§Œ ì œê³µ.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>  <span class="c1"># "/v1/chat/completions"ë¡œ ë°”ê¿”ë„ ë¨
</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="c1"># ì„œë²„ ê·œê²©ì— ë§ê²Œ í•„ìš”í•œ í‚¤ë§Œ ë‹´ëŠ”ë‹¤. í•„ìš”ì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì •.
</span>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="c1"># dataë¥¼ ChatResponseë¡œ ë§¤í•‘; ë„ˆì˜ ì—”ë“œí¬ì¸íŠ¸ ê·œê²©ì— ë§ê²Œ ì—¬ê¸°ë§Œ ì¡°ì •í•˜ë©´ ëœë‹¤.
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 2) ToolProvider ì¸í„°í˜ì´ìŠ¤ ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ToolProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span> <span class="bp">...</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>

<span class="c1"># ---- 2-1) MCP í”„ë¡œë°”ì´ë” (ì—¬ëŸ¬ ì„œë²„ í¬í•¨) ----
# mcp ì„¤ì¹˜ í•„ìš”
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="c1"># ë™ê¸° ì¸í„°í˜ì´ìŠ¤ ìš”êµ¬ ë•Œë¬¸ì— ìºì‹œ ê¸°ë°˜. ìµœì´ˆ í˜¸ì¶œ ì „ì— warmup()ì„ í˜¸ì¶œí•˜ê±°ë‚˜,
</span>        <span class="c1"># Orchestratorê°€ ì‘ë‹µ ì „ await ensure_ready()ë¥¼ í•œ ë²ˆ ìˆ˜í–‰.
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await provider.ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="c1"># list_toolsëŠ” asyncë¼ ì—¬ê¸°ì„œ ë¯¸ë¦¬ ëª¨ì€ë‹¤.
</span>        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># tool_nameì€ "server:tool"ì´ì–´ì•¼ í•¨
</span>        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server namespace: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ---- 2-2) ë¡œì»¬ íˆ´ í”„ë¡œë°”ì´ë”(ì„ íƒ) ----
</span>
<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚°. ì…ë ¥: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                    <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (ë„êµ¬ë§Œ ì…ë ¥í•´ì„œ ë™ì‘) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ëª©ì : íˆ´ë§Œ ì…ë ¥í•´ì„œ ë™ì‘. ì–´ë–¤ Chat(ë°±ì—”ë“œ)ì—ë„ ì¬ì‚¬ìš©.
    - providers: ToolProviderë“¤ì˜ ë¦¬ìŠ¤íŠ¸
    - backend: ChatBackend êµ¬í˜„ì²´ 1ê°œ
    - expose_fn: ì„ íƒì ìœ¼ë¡œ </span><span class="sh">'</span><span class="s">íˆ´ ì†Œì¶œ</span><span class="sh">'</span><span class="s"> ì „ëµì„ ì£¼ì… (ê¸°ë³¸ê°’: ì „ë¶€ ë…¸ì¶œ)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolProvider</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># MCPProvider ê°™ì€ async ì¤€ë¹„ê°€ í•„ìš”í•œ í”„ë¡œë°”ì´ë”ë¥¼ ì›Œë°ì—…
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># ê° í”„ë¡œë°”ì´ë”ê°€ ì±…ì„ì§€ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ë¼ìš°íŒ…
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># ë¹ ë¥¸ íŒë³„: MCPëŠ” "server:" ë„¤ì„ìŠ¤í˜ì´ìŠ¤, ë¡œì»¬ì€ "local." ê°™ì€ ê·œì¹™ ì¶”ì²œ
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">):</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>  <span class="c1"># server:tool
</span>                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># ë§ˆì§€ë§‰ fallback: ëª¨ë“  providerì— ì‹œë„
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider could handle tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="c1"># íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ ìˆ˜ì§‘í•˜ê³  ì†Œì¶œ ì „ëµ ì ìš©
</span>            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="c1"># ëª¨ë¸ì—ê²Œ ë„êµ¬ê²°ê³¼ë¥¼ ì¼ê´„ ì¬ì£¼ì…
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== ì‹¤í–‰ ì˜ˆì‹œ ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP ì„œë²„ë“¤: í•„ìš” ì„œë²„ë§Œ ë‚˜ì—´
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>

    <span class="c1"># 2) ë¡œì»¬ íˆ´(ì„ íƒ)
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># 3) ì–´ë–¤ Chatì´ë“  ë¶™ì¼ ë°±ì—”ë“œ. base_urlê³¼ pathë§Œ ë§ì¶”ë©´ ë.
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span>               <span class="c1"># í•„ìš”ì— ë”°ë¼ "/v1/chat/completions" ë“±ìœ¼ë¡œ ë³€ê²½
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°: ì…ë ¥ì€ â€œíˆ´(í”„ë¡œë°”ì´ë”)â€ë¿
</span>    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="c1"># ê°„ë‹¨ ì†Œì¶œ: íŒŒì¼/SQL ê´€ë ¨ ë‹¨ì–´ê°€ ì—†ìœ¼ë©´ MCPë¥¼ ìˆ¨ê¸°ê³  ë¡œì»¬ë§Œ ë…¸ì¶œ
</span>        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">íŒŒì¼</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ì¿¼ë¦¬</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSVë¥¼ ì½ê³  í•©ê³„ë¥¼ ê³„ì‚°í•œ ë’¤ ìˆ˜ì¹˜ê°€ ë§ëŠ”ì§€ ê³„ì‚°ê¸°ë¡œ ê²€ì¦í•´ì¤˜. íŒŒì¼ì€ ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">ë„ˆëŠ” MCP íˆ´ì„ ì‹ ì¤‘íˆ ì‚¬ìš©í•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ìµœì¢… ë¡œê·¸ ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì„¤ëª…ê³¼ ì‚¬ìš©ë²• ìš”ì•½<br />
ì…ë ¥ì€ íˆ´(í”„ë¡œë°”ì´ë”)ë§Œ ë„˜ê¸´ë‹¤. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ëŠ” íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ í•©ì¹˜ê³ , LLM ì‘ë‹µì˜ tool_callsë¥¼ ë°›ì•„ ì ì ˆí•œ í”„ë¡œë°”ì´ë”ë¡œ ë¼ìš°íŒ…í•œë‹¤. íŠ¹ì • ì—ì´ì „íŠ¸ SDK ë¶„ê¸°ê°€ ì „í˜€ ì—†ë‹¤. ë‹¤ë¥¸ Chat ë°±ì—”ë“œë¡œ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ OpenAICompatibleBackendë§Œ êµì²´í•˜ê±°ë‚˜ send ë©”ì†Œë“œê°€ ë™ì¼í•œ ì‹œê·¸ë‹ˆì²˜ë¥¼ ê°€ì§€ëŠ” ìƒˆ í´ë˜ìŠ¤ë¥¼ í•˜ë‚˜ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p>ìš´ì˜ íŒ<br />
íˆ´ ì†Œì¶œ í•¨ìˆ˜(expose_fn)ë¡œ í„´ë³„ í•„í„°ë§ì„ ê¼­ ë„£ì. ë‹¨ìˆœ í‚¤ì›Œë“œë§Œìœ¼ë¡œë„ ì„ íƒ ì˜¤ë¥˜ì™€ ë¶ˆí•„ìš” í˜¸ì¶œì´ í¬ê²Œ ì¤€ë‹¤.<br />
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì¼ê´€ë˜ê²Œ ìœ ì§€í•˜ì. MCPëŠ” server:tool, ë¡œì»¬ì€ local.*ì²˜ëŸ¼ êµ¬ë¶„í•˜ë©´ ì¶©ëŒì´ ì—†ë‹¤.<br />
ê³ ìœ„í—˜ íˆ´ì€ parametersì— dry_run, confirm ë¬¸ìì—´ ê°™ì€ ì œì•½ì„ ë„£ì–´ì•¼ í•œë‹¤.<br />
ëŒ€ìš©ëŸ‰ ê²°ê³¼ëŠ” MCP ì„œë²„ê°€ íŒŒì¼ í•¸ë“¤(ë¦¬ì†ŒìŠ¤)ë¡œ ë°˜í™˜í•˜ê³ , ëª¨ë¸ì—ëŠ” ìš”ì•½/ë©”íƒ€ë°ì´í„°ë§Œ ì¬ì£¼ì…í•´ í† í°ì„ ì•„ë¼ì.</p>

<p>ì´ êµ¬ì¡°ë©´ ê°™ì€ Orchestratorë¥¼ ê·¸ëŒ€ë¡œ ë‘ê³ , ì–´ë–¤ Chat UI/ì—”ì§„ì—ë„ ì‰½ê²Œ ì´ì‹í•  ìˆ˜ ìˆë‹¤. í•„ìš”í•˜ë©´ ë„¤ ì—”ë“œí¬ì¸íŠ¸ì˜ ì •í™•í•œ JSON ê·œê²©ì„ ì•Œë ¤ì¤˜. OpenAICompatibleBackendì˜ ë§¤í•‘ë§Œ 10ì¤„ì¯¤ ì†ë³´ë©´ ë°”ë¡œ ë¬¼ë¦´ ìˆ˜ ìˆê²Œ ë§ì¶°ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì´ê±´ ë˜ openai agentëŠ” ì•ˆ ì“°ëŠ” ê²ƒ ê°™ì€ë°

</p>

<p>ë§ì•„, ë°©ê¸ˆ ì¤€ ìŠ¤ìºí´ë”©ì€ â€œì˜¤í”ˆAI Agents SDKâ€ë¥¼ ì“°ì§€ ì•ŠëŠ” ìˆœìˆ˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ì˜€ì§€. ë„ˆê°€ ì›í•˜ëŠ” ê±´ ê·¸ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œ, ë°±ì—”ë“œë§Œ ê°ˆì•„ë¼ì›Œ â€œOpenAI Agents Python SDKâ€ë¥¼ LLM ë°±ì—”ë“œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê²ƒ. ì•„ë˜ì²˜ëŸ¼ ë°±ì—”ë“œ ì–´ëŒ‘í„° í•˜ë‚˜ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°Â·íˆ´ í”„ë¡œë°”ì´ë”Â·ë¼ìš°íŒ…ì€ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©í•˜ê³ , ì—ì´ì „íŠ¸ SDKëŠ” ë‹¨ì§€ â€œí…ìŠ¤íŠ¸+íˆ´ì½œ JSONì„ ë±‰ëŠ” ëª¨ë¸ ë°±ì—”ë“œâ€ë¡œë§Œ ì“´ë‹¤. ì¦‰, Agents SDKì—ê²Œ MCP ì‹¤í–‰ì„ ë§¡ê¸°ì§€ ì•Šê³ , ìš°ë¦¬ê°€ ë§Œë“  ë¼ìš°í„°ê°€ ê³„ì† MCPë¥¼ í˜¸ì¶œí•œë‹¤.</p>

<p>í•µì‹¬ ì•„ì´ë””ì–´<br />
ì—ì´ì „íŠ¸ SDKì—ê²Œ ë„êµ¬ë¥¼ ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤(tool_choice ì—†ì´). ëŒ€ì‹  ìš°ë¦¬ê°€ ë„˜ê¸´ íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ í”„ë¡¬í”„íŠ¸ì— JSONìœ¼ë¡œ ì£¼ê³ , ì—ì´ì „íŠ¸ê°€ ë°˜ë“œì‹œ ë‹¤ìŒ í¬ë§·ì˜ JSONë§Œ ì¶œë ¥í•˜ë„ë¡ ê°•ì œí•œë‹¤. ê·¸ëŸ¬ë©´ ìš°ë¦¬ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ ê·¸ JSONì„ íŒŒì‹±í•´ ì‹¤ì œ MCP/ë¡œì»¬ íˆ´ë¡œ ë¼ìš°íŒ…í•œë‹¤. ì´ëŸ¬ë©´ Agent ì „ìš© ì½”ë“œ ë¶„ê¸°ê°€ ìƒê¸°ì§€ ì•ŠëŠ”ë‹¤. ë°±ì—”ë“œë¥¼ ë°”ê¿” ë¼ìš°ëŠ” ê²ƒë§Œìœ¼ë¡œ ê°™ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ ê·¸ëŒ€ë¡œ ë™ì‘í•œë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install openai-agents mcp requests pydantic orjson</p>

<p>agents_backend.py<br />
ì•„ë˜ íŒŒì¼ì€ ë„¤ê°€ ì´ì „ì— ë°›ì€ tools_only.pyì˜ êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ë”°ë¥´ë˜, ChatBackend êµ¬í˜„ì²´ë¡œ AgentsBackendë¥¼ ì¶”ê°€í•œ ë²„ì „ì´ë‹¤. ë‚˜ë¨¸ì§€ëŠ” ë™ì¼í•˜ë‹ˆ ì´ íŒŒì¼ í•˜ë‚˜ë¡œ êµì²´í•´ë„ ë˜ê³ , í•„ìš”í•œ ë¶€ë¶„ë§Œ ê°€ì ¸ë‹¤ ì¨ë„ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== ê³µí†µ ë°ì´í„° ëª¨ë¸ ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {"name": ..., "arguments": str|dict}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend ì¸í„°í˜ì´ìŠ¤ ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 1-b) OpenAI Agents SDK ë°±ì—”ë“œ ì–´ëŒ‘í„° ==========
</span>
<span class="c1"># Agents SDKëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë„êµ¬ ì‹¤í–‰ê¹Œì§€ ë§¡ê¸¸ ìˆ˜ ìˆì§€ë§Œ,
# ì—¬ê¸°ì„œëŠ” "í…ìŠ¤íŠ¸+íˆ´ì½œ JSONì„ ìƒì„±í•˜ëŠ” ëª¨ë¸"ë¡œë§Œ ì‚¬ìš©í•œë‹¤.
# í”„ë¡¬í”„íŠ¸ ê°•ì œ í˜•ì‹ìœ¼ë¡œ tool_callsë¥¼ JSONìœ¼ë¡œ ì¶œë ¥í•˜ê²Œ ë§Œë“ ë‹¤.
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># LiteLLM ëª¨ë¸ í™•ì¥ì„ ì‚¬ìš©í•´ ì„ì˜ì˜ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë¶™ì¼ ìˆ˜ ìˆë‹¤.
</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># ë„êµ¬ëŠ” ì—ì´ì „íŠ¸ì— ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤. ìš°ë¦¬ê°€ ì§ì ‘ ë¼ìš°íŒ…í•  ê²ƒì´ê¸° ë•Œë¬¸.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ì ˆëŒ€ ìë™ ë„êµ¬ í˜¸ì¶œ ê¸ˆì§€
</span>        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># íˆ´ ëª©ë¡ì„ JSONìœ¼ë¡œ ì£¼ê³ , ì •í™•í•œ ì¶œë ¥ í¬ë§·ì„ ê°•ì œí•œë‹¤.
</span>        <span class="n">tools_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span>
            <span class="n">tools_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tools_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_prompt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">ìœ„ëŠ” ëŒ€í™” ë‚´ì—­ì´ë‹¤. ì•„ë˜ëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ëª©ë¡ì´ë‹¤.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">TOOLS_JSON=</span><span class="si">{</span><span class="n">tools_json</span><span class="si">}</span><span class="se">\n\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">ë°˜ë“œì‹œ ë‹¤ìŒ JSON í¬ë§·ìœ¼ë¡œë§Œ ë‹µí•˜ë¼. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ë§ë¼.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">{</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;ìµœì¢… ìì—°ì–´ ì‘ë‹µ(ìˆìœ¼ë©´)&gt;</span><span class="sh">"</span><span class="s"> ,</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-1</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}},</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-2</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}}</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">"</span><span class="s">  ]</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">}</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">ì—¬ëŸ¬ ë„êµ¬ê°€ í•„ìš”í•˜ë©´ tool_calls ë°°ì—´ì— ìˆœì„œëŒ€ë¡œ ë„£ì–´ë¼. ë„êµ¬ê°€ í•„ìš” ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ì„ ë„£ì–´ë¼.</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">history</span> <span class="o">+</span> <span class="p">[</span><span class="sh">""</span><span class="p">,</span> <span class="n">guide</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_build_prompt</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
        <span class="c1"># Developer ë©”ì‹œì§€ì— ê°•ì œ í¬ë§· ê°€ì´ë“œë¥¼ ë„£ì–´ JSONë§Œ ì¶œë ¥í•˜ê²Œ í•œë‹¤.
</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">JSON í¬ë§·ë§Œ ì¶œë ¥</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, ì¼ë°˜ í…ìŠ¤íŠ¸ë§Œ ì±„ì›Œì„œ ë°˜í™˜
</span>            <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">tool_calls</span><span class="o">=</span><span class="p">[])</span>
        <span class="c1"># í‘œì¤€ ChatResponseë¡œ ë§µ
</span>        <span class="n">tc_raw</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># argumentsê°€ dictê°€ ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ í†µê³¼(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ìª½ì—ì„œ ì •ê·œí™”)
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span><span class="nc">ToolCall</span><span class="p">(</span><span class="o">**</span><span class="n">tc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tc_raw</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tc_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

<span class="c1"># ========== 2) ToolProvider (MCP/ë¡œì»¬) ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                <span class="p">}))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚°. ì…ë ¥ {expr:string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">})]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (ë³€ê²½ ì—†ìŒ) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‹¨ì„œ
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LocalToolsProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># í´ë°±
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider can handle </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== ì‹¤í–‰ ì˜ˆì‹œ ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># MCP ì„œë²„ ì˜ˆì‹œ
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>
    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># A) OpenAI Agents SDKë¥¼ ë°±ì—”ë“œë¡œ ì‚¬ìš©
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">AgentsBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸(LiteLLMë„ ê°€ëŠ¥)
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>                <span class="c1"># í˜¹ì€ ë„¤ ì„ì˜ ëª¨ë¸ëª…
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>

    <span class="c1"># B) í•„ìš”í•˜ë©´ ê¸°ì¡´ OpenAICompatibleBackendë¡œ êµì²´ ê°€ëŠ¥
</span>    <span class="c1"># backend = OpenAICompatibleBackend(base_url="http://localhost:8000", path="/chat", model="my-model")
</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">íŒŒì¼</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ì¿¼ë¦¬</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSVë¥¼ ì½ê³  í•©ê³„ë¥¼ êµ¬í•œ ë’¤ ê³„ì‚°ê¸°ë¡œ ìˆ˜ì¹˜ ê²€ì¦ê¹Œì§€ í•´ì¤˜. íŒŒì¼ì€ ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">ë„ˆëŠ” MCP íˆ´ì„ ì‹ ì¤‘íˆ ì‚¬ìš©í•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ìµœì¢… ë¡œê·¸ ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì‘ë™ ë°©ì‹ ì •ë¦¬<br />
1ë‹¨ê³„. AgentsBackendëŠ” OpenAI Agents Python SDKì˜ Agentë¥¼ ëª¨ë¸ ë°±ì—”ë“œë¡œë§Œ ì“´ë‹¤. ë„êµ¬ëŠ” ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤.<br />
2ë‹¨ê³„. ìš°ë¦¬ê°€ ë…¸ì¶œí•  íˆ´ ëª©ë¡ì„ JSONìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ì— ë„£ê³ , ì—ì´ì „íŠ¸ê°€ contentì™€ tool_calls ë°°ì—´ì„ ì •í™•íˆ ë‹´ì€ JSONë§Œ ì¶œë ¥í•˜ê²Œ ê°•ì œí•œë‹¤.<br />
3ë‹¨ê³„. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ëŠ” ê·¸ tool_callsë¥¼ ë°›ì•„ ê¸°ì¡´ê³¼ ë˜‘ê°™ì´ MCP/ë¡œì»¬ íˆ´ë¡œ ë¼ìš°íŒ…í•œë‹¤.<br />
4ë‹¨ê³„. ì¦‰, ê°™ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì½”ë“œë¥¼ ìœ ì§€í•œ ì±„, ë°±ì—”ë“œë§Œ ê°ˆì•„ë¼ì›Œ Agents SDK ë˜ëŠ” ì¼ë°˜ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ììœ ë¡­ê²Œ ì„ íƒí•  ìˆ˜ ìˆë‹¤.</p>

<p>ì£¼ì˜ì ê³¼ íŒ<br />
JSON ê°•ì œ í”„ë¡¬í”„íŠ¸ê°€ ì¤‘ìš”í•˜ë‹¤. ëª¨ë¸ì´ ì¥ì‹ í…ìŠ¤íŠ¸ë¥¼ ì„ì§€ ì•Šë„ë¡ developer_instructionsë¡œ â€œJSONë§Œ ì¶œë ¥â€ì„ ë°˜ë³µí•´ì„œ ê³ ì •í•˜ë¼.<br />
íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ì—„ê²©í•˜ê²Œ. required, enum, formatì„ ì¶©ë¶„íˆ ë„£ìœ¼ë©´ arguments íŒŒì‹± ì‹¤íŒ¨ê°€ ì¤„ì–´ë“ ë‹¤.<br />
ì„±ëŠ¥. AgentsBackendëŠ” Runner.run_syncë¥¼ í•œ í„´ë§ˆë‹¤ í˜¸ì¶œí•œë‹¤. ëŒ€í™” ê¸¸ì–´ì§€ë©´ í† í°Â·ì‹œê°„ì´ ëŠ˜ì–´ë‚˜ë¯€ë¡œ expose_fnìœ¼ë¡œ íˆ´ì„ í„´ë³„ë¡œ ì†Œì¶œí•˜ê³ , ê²°ê³¼ëŠ” ìš”ì•½í•´ì„œ ì¬ì£¼ì…í•˜ë¼.<br />
ëŒ€ì²´. ì—ì´ì „íŠ¸ SDKì˜ ëª¨ë¸ ëŒ€ì‹  OpenAICompatibleBackendë¡œ ë°”ê¾¸ë©´ ë°”ë¡œ ë™ì¼ ì½”ë“œê°€ ë‹¤ë¥¸ Chatì—ë„ ë¶™ëŠ”ë‹¤. ëª©ì ì— ë§ì¶° ë°±ì—”ë“œë§Œ êµì²´í•˜ë©´ ëœë‹¤.</p>

<p>ì´ë ‡ê²Œ í•˜ë©´ ì—ì´ì „íŠ¸ SDKë¥¼ â€œë°±ì—”ë“œ ëª¨ë¸â€ë¡œë§Œ ì“°ë©´ì„œ, ë„ˆì˜ íˆ´ ì¤‘ì‹¬ ì¸í„°í˜ì´ìŠ¤ì™€ ë¼ìš°í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ëœë‹¤. ë‹¤ìŒì—ëŠ” ë„¤ ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ì˜ ì¶œë ¥ JSON ì˜ˆì‹œë¥¼ ì•Œë ¤ì¤˜. AgentsBackendì˜ JSON íŒŒì‹± ë¶€ë¶„ì„ ê±°ê¸°ì— ë§ì¶° 2~3ì¤„ë§Œ ì¡°ì •í•˜ë©´ ëœë‹¤.</p>

<p class="chat--user">

ì•„ ë³µì¡í•´ ê·¸ëƒ¥ function_toolë¡œ ê° toolì„ ë“±ë¡í•˜ë©´ ì–´ë–¨ê¹Œ

</p>

<p>ì¢‹ì§€. â€œê·¸ëƒ¥ function_toolë¡œ ê° íˆ´ì„ ë“±ë¡â€í•˜ëŠ” ê°€ì¥ ê¹”ë”í•œ ë°©ë²•ì€, MCP ì„œë²„ë“¤ì—ì„œ list_toolsë¥¼ ê¸ì–´ì™€ì„œ ê°ê°ì„ Agents SDKì˜ FunctionToolë¡œ ë™ì ìœ¼ë¡œ ë˜í•‘í•˜ëŠ” ê±°ì•¼. ê·¸ëŸ¬ë©´ Agent ìª½ì€ ì „í˜€ ì»¤ìŠ¤í…€ ë¶„ê¸° ì—†ì´ í‘œì¤€ íˆ´ë§Œ ë³¸ë‹¤. ì•„ë˜ ì½”ë“œê°€ ë°”ë¡œ ê·¸ íŒ¨í„´ì´ê³ , ì»¤ìŠ¤í…€ LLMë„ LiteLLM ëª¨ë¸ ì–´ëŒ‘í„°ë¡œ ë¶™ì¸ë‹¤.</p>

<p>í•µì‹¬ ê°œë… í•œ ì¤„ ìš”ì•½<br />
MCPì˜ tool ë©”íƒ€ë°ì´í„°(name, description, input_schema)ë¥¼ Agents SDKì˜ FunctionTool(name, description, params_json_schema, on_invoke_tool)ì— ê·¸ëŒ€ë¡œ ë§¤í•‘í•˜ê³ , on_invoke_toolì—ì„œ í•´ë‹¹ MCP ì„¸ì…˜ìœ¼ë¡œ call_toolë§Œ ë¼ìš°íŒ…í•œë‹¤. FunctionTool/<code class="language-plaintext highlighter-rouge">@function_tool</code> ì‚¬ìš©ë²•ê³¼ JSON ìŠ¤í‚¤ë§ˆ í¬ë§·ì€ Agents ë¬¸ì„œ ê·¸ëŒ€ë¡œë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a> ë˜í•œ ëª¨ë¸ì€ LiteLLMModelë¡œ ë„ˆì˜ ë² ì´ìŠ¤ URLì„ ëª¨ë¸ì²˜ëŸ¼ ì“¸ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>ì„¤ì¹˜<br />
pip install "openai-agents[litellm]" mcp pydantic orjson</p>

<p>mcp_as_function_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤(íˆ´ ì´ë¦„ prefixì— ë“¤ì–´ê°)
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cdfg</span><span class="p">.</span><span class="n">name</span> <span class="nf">if </span><span class="p">(</span><span class="n">cdfg</span> <span class="p">:</span><span class="o">=</span> <span class="n">cfg</span><span class="p">)</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    MCP tool -&gt; Agents FunctionTool
    tool_meta: has .name, .description, .input_schema (JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Agents SDKê°€ args_jsonì„ JSON ë¬¸ìì—´ë¡œ ë„˜ê²¨ì¤€ë‹¤ â†’ dictë¡œ íŒŒì‹± í›„ MCP í˜¸ì¶œ
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># ëª¨ë¸ì´ í˜•ì‹ ì–´ê¸°ë©´ rawë¡œ ì „ë‹¬(ì„œë²„ ìª½ ê²€ì¦ì— ë§¡ê¹€)
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="c1"># MCP í‘œì¤€ contentë¥¼ í…ìŠ¤íŠ¸/JSON ìœ„ì£¼ë¡œ ì •ê·œí™”
</span>        <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="c1"># ì—ì´ì „íŠ¸ì—ê²ŒëŠ” ë¬¸ìì—´ì„ ë°˜í™˜í•˜ë¯€ë¡œ JSON ë¬¸ìì—´ë¡œ ë¬¶ì–´ì¤€ë‹¤
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="c1"># FunctionToolì€ name/description/params_json_schema/on_invoke_toolë§Œ ì£¼ë©´ ëœë‹¤.
</span>    <span class="c1"># ê³µì‹ ë¬¸ì„œì˜ "Custom function tools" ì„¹ì…˜ê³¼ ë™ì¼í•œ ìƒì„±ì. :contentReference[oaicite:2]{index=2}
</span>    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) ì—¬ëŸ¬ MCP ì„œë²„ë¥¼ ì„ ì–¸
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>        <span class="c1"># MCPServerCfg(name="db", kind="stdio", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">]</span>

    <span class="c1"># 2) MCPì˜ ëª¨ë“  íˆ´ì„ FunctionToolë¡œ ë“±ë¡
</span>    <span class="n">mcp_function_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>

    <span class="c1"># 3) ì»¤ìŠ¤í…€ LLM(ë„ˆì˜ ì—”ë“œí¬ì¸íŠ¸)ì„ LiteLLM ëª¨ë¸ë¡œ ì‚¬ìš©
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># ë„¤ ì—”ë“œí¬ì¸íŠ¸ë¥¼ OpenAI í˜¸í™˜ìœ¼ë¡œ ë…¸ì¶œí–ˆë‹¤ëŠ” ê°€ì •
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) ì—ì´ì „íŠ¸ êµ¬ì„±: â€œfunction_toolë¡œ ë“±ë¡ëœ MCP íˆ´â€ë§Œ ì „ë‹¬
</span>    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP-through-FunctionTools</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_function_tools</span><span class="p">,</span>  <span class="c1"># í¬ì¸íŠ¸: ì˜¤ì§ function_toolë§Œ
</span>    <span class="p">)</span>

    <span class="c1"># 5) ì‹¤í–‰
</span>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data í´ë”ì—ì„œ sales.csvë¥¼ ì½ê³  í•©ê³„ ê³„ì‚°í•´ì¤˜. í•„ìš”í•˜ë©´ ìŠ¤ìŠ¤ë¡œ ì ì ˆí•œ MCP íˆ´ì„ ê³¨ë¼ ì¨.</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì–´ë–»ê²Œ ëŒì•„ê°€ë‚˜<br />
1ë‹¨ê³„. ì—¬ëŸ¬ MCP ì„œë²„ì— ì—°ê²°í•˜ê³  list_toolsë¡œ ë©”íƒ€ë¥¼ ê¸ëŠ”ë‹¤.<br />
2ë‹¨ê³„. ê° MCP íˆ´ì„ FunctionToolë¡œ ê°ì‹¼ë‹¤. nameì€ server:toolë¡œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤, descriptionê³¼ JSON ìŠ¤í‚¤ë§ˆëŠ” MCPì˜ description/input_schemaë¥¼ ê·¸ëŒ€ë¡œ ì“´ë‹¤. ì´ ë§¤í•‘ì€ Agents ë¬¸ì„œì˜ Function tools/Custom function tools ê·œì•½ì— ë§ë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a><br />
3ë‹¨ê³„. on_invoke_toolì—ì„œ session.call_toolë§Œ í˜¸ì¶œí•´ ê²°ê³¼ë¥¼ ë¬¸ìì—´(JSON)ë¡œ ë°˜í™˜í•œë‹¤.<br />
4ë‹¨ê³„. AgentëŠ” â€œfunction_toolë¡œ ë“±ë¡ëœ íˆ´â€ë§Œ ë³´ë¯€ë¡œ, ë„¤ê°€ ì›í•œ ë‹¨ìˆœí•œ íˆ´ ë“±ë¡ ëª¨ë¸ ê·¸ëŒ€ë¡œë‹¤. ëª¨ë¸ì€ LiteLLMì„ í†µí•´ ì„ì˜ ë² ì´ìŠ¤ URLì˜ LLMì„ ì“¸ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>ì‹¤ì „ íŒ<br />
íˆ´ ê³¼ì ì¬ë¥¼ í”¼í•˜ë ¤ë©´ tools=mcp_function_tools ëŒ€ì‹ , í”„ë¡¬í”„íŠ¸ë¥¼ ë³´ê³  í•„ìš”í•œ ì„œë²„ë§Œ í•„í„°ë§í•´ì„œ ì „ë‹¬í•´ë¼(ì˜ˆ: íŒŒì¼/CSVê°€ ìˆìœ¼ë©´ files:*ë§Œ). Function toolsëŠ” ì„¤ëª…ê³¼ ì¸ì ìŠ¤í‚¤ë§ˆë¥¼ ìë™ ì†Œë¹„í•˜ë‹ˆ, MCP ìª½ ìŠ¤í‚¤ë§ˆë¥¼ ë¹¡ë¹¡í•˜ê²Œ ìœ ì§€í•˜ë©´ arguments ì˜¤ë¥˜ê°€ ì¤„ì–´ë“ ë‹¤. FunctionToolë¡œ ì§ì ‘ ìƒì„±í•˜ë©´ ë°ì½”ë ˆì´í„° ì—†ì´ë„ ì´ë¦„Â·ì„¤ëª…Â·ìŠ¤í‚¤ë§ˆë¥¼ ì›í•˜ëŠ” ëŒ€ë¡œ ë„£ì„ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a></p>

<p>í™•ì¥ ì•„ì´ë””ì–´<br />
ê³ ìœ„í—˜ íˆ´ì— dry_run, confirm ê°™ì€ í•„ë“œë¥¼ MCP input_schemaì— ì¶”ê°€í•˜ë©´, ê·¸ëŒ€ë¡œ FunctionTool ì¸ì ìŠ¤í‚¤ë§ˆì— ë°˜ì˜ë˜ì–´ ì‹¤í–‰ ì „ì— ëª¨ë¸ì´ ìŠ¤ìŠ¤ë¡œ ì•ˆì „ ì ˆì°¨ë¥¼ ë”°ë¥¸ë‹¤.<br />
íˆ´ ê²°ê³¼ê°€ í¬ë©´ on_invoke_toolì—ì„œ ìš”ì•½ë§Œ ë°˜í™˜í•˜ê³ , ì›ë³¸ì€ íŒŒì¼ í•¸ë“¤ì´ë‚˜ URLë¡œ ì œê³µí•˜ë„ë¡ MCP ì„œë²„ë¥¼ ì„¤ê³„í•´ í† í° ì‚¬ìš©ëŸ‰ì„ ì¤„ì¸ë‹¤.</p>

<p>ì›í•˜ë©´ ë„¤ íŒŒì¼/DB MCP ì„œë²„ì˜ ì‹¤ì œ tool ì´ë¦„ê³¼ input_schemaë¥¼ ì•Œë ¤ì¤˜. ìœ„ ìŠ¤í¬ë¦½íŠ¸ê°€ í•´ë‹¹ ìŠ¤í‚¤ë§ˆë¥¼ ê·¸ëŒ€ë¡œ FunctionToolë¡œ ì˜®ê²¨ì£¼ê¸° ë•Œë¬¸ì— ì¶”ê°€ ì½”ë“œëŠ” ì‚¬ì‹¤ìƒ ì—†ë‹¤.</p>

<p class="chat--user">

ì‘ ë‚´ê°€ ì›í•˜ëŠ”ê±°ë‘ ê°€ê¹Œì›Œì§„ë“¯. ì§ˆë¬¸ì´ ë” ìˆì–´. ì§ˆë¬¸ 1. MCP ë§ê³  ì¼ë°˜ Function íˆ´ê³¼ ì„ì¸ ë²„ì ¼ ì¶”ê°€í•´ì¤˜. ì§ˆë¬¸ 2. ì¼ë°˜ chat completions (with tools) ì˜ˆì œë„ ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€í•´ì¤˜. ì§ˆë¬¸ 3. MCP Client Sessionì€ ì €ì ˆë¡œ ì¢…ë£Œë˜ë‚˜? ì§ˆë¬¸ 4. ì—¬ëŸ¬ Agentê°€ ìˆìœ¼ë©´ MCP ì¢…ë¥˜ë³„ë¡œ ì„¸ì…˜ì„ ì—¬ëŸ¬ê°œ ì—´ê²Œë ìˆ˜ë„ ìˆì„ê±° ê°™ì€ë° í•˜ë‚˜ë¡œ ìœ ì§€í•˜ëŠ”ê±´ ì–´ë•Œ? ë¬¸ì œê°€ ìˆìœ¼ë ¤ë‚˜

</p>

<p>ì¢‹ì•„. ë„¤ ì§ˆë¬¸ 4ê°œë¥¼ ìˆœì„œëŒ€ë¡œ, ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì½”ë“œì™€ í•¨ê»˜ ì •ë¦¬í•œë‹¤. ì¸ìš©êµ¬ë¬¸ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.</p>

<h1 id="1-mcp-íˆ´--ì¼ë°˜-function-íˆ´ì„-ì„ì–´-ë“±ë¡í•˜ëŠ”-ë²„ì „">1) MCP íˆ´ + ì¼ë°˜ Function íˆ´ì„ ì„ì–´ ë“±ë¡í•˜ëŠ” ë²„ì „</h1>

<p>ì•„ë˜ëŠ” ì•ì„œ ë§Œë“  â€œMCP â†’ FunctionTool ë˜í•‘â€ì— ë”í•´, ì¼ë°˜ íŒŒì´ì¬ í•¨ìˆ˜ë„ FunctionToolë¡œ í•¨ê»˜ ë“±ë¡í•˜ëŠ” ì˜ˆì‹œë‹¤. ì—ì´ì „íŠ¸ëŠ” ë‘ ì¢…ë¥˜ë¥¼ í•œêº¼ë²ˆì— ë³¸ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># ========== MCP ì—°ê²° ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">args_json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_function_tools</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># ========== ì¼ë°˜ íŒŒì´ì¬ í•¨ìˆ˜ â†’ FunctionTool ==========
</span>
<span class="k">def</span> <span class="nf">make_local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°. ì…ë ¥: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">math_eval</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># ========== ì‹¤í–‰ ì˜ˆì‹œ ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP íˆ´
</span>    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_mcp_function_tools</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="db", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">])</span>

    <span class="c1"># 2) ì¼ë°˜ Function íˆ´
</span>    <span class="n">local_tools</span> <span class="o">=</span> <span class="nf">make_local_tools</span><span class="p">()</span>

    <span class="c1"># 3) ëª¨ë¸ (ë„¤ ì»¤ìŠ¤í…€ LLM OpenAI-í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸)
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MixedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_tools</span> <span class="o">+</span> <span class="n">local_tools</span><span class="p">,</span>  <span class="c1"># ì„ì–´ì„œ ë“±ë¡
</span>    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data í´ë”ì˜ sales.csvë¥¼ ì½ì–´ í•©ê³„ë¥¼ êµ¬í•˜ê³ , local.math_evalë¡œ ìˆ«ì ê²€ì¦ê¹Œì§€ í•´ì¤˜</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h1 id="2-ì¼ë°˜-chat-completions-with-tools-ì˜ˆì œ">2) ì¼ë°˜ Chat Completions (with tools) ì˜ˆì œ</h1>

<p>OpenAI í˜¸í™˜ Chat Completions APIë¥¼ ì§ì ‘ ì“°ëŠ” ìˆœìˆ˜ ì˜ˆì‹œë‹¤. toolsì— í•¨ìˆ˜ ìŠ¤í‚¤ë§ˆë¥¼ ì£¼ê³ , tool_callsë¥¼ ë°›ì•„ì„œ ë„ˆì˜ ì‹¤í–‰ê¸°ë¡œ ë¼ìš°íŒ…í•œë‹¤. ì—¬ê¸°ì„œëŠ” ë¡œì»¬ ê³„ì‚°ê¸° í•˜ë‚˜ë§Œ ë³´ì—¬ì£¼ì§€ë§Œ, ìœ„ì˜ MCP tools ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ í•©ì³ ë„£ìœ¼ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>  <span class="c1"># ë„¤ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># ì—¬ê¸°ì— MCPì—ì„œ ê¸ì–´ì˜¨ toolsë„ ê·¸ëŒ€ë¡œ append ê°€ëŠ¥
</span><span class="p">]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">3*(2+5) ê°’ì„ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># 1ì°¨ ìš”ì²­
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
<span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="c1"># tool_calls ì²˜ë¦¬
</span><span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="c1"># 2ì°¨ ìš”ì²­(ë„êµ¬ ê²°ê³¼ ë°˜ì˜)
</span>    <span class="n">resp2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp2</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">resp2</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
</code></pre></div></div>

<p>í¬ì¸íŠ¸<br />
toolsì— MCPì—ì„œ ê¸ì€ ìŠ¤í‚¤ë§ˆë¥¼ ê·¸ëŒ€ë¡œ ì¶”ê°€í•˜ë©´, ì¼ë°˜ chat completions ë£¨í”„ì—ì„œë„ MCPì™€ ë¡œì»¬ íˆ´ì„ í•¨ê»˜ ì“¸ ìˆ˜ ìˆë‹¤. ë‹¨, MCP í˜¸ì¶œë¶€ëŠ” ë„ˆì˜ ë¼ìš°í„°ê°€ ì²˜ë¦¬í•´ tool ì—­í•  ë©”ì‹œì§€ë¥¼ ë§Œë“¤ì–´ ë„£ìœ¼ë©´ ëœë‹¤.</p>

<h1 id="3-mcp-clientsessionì€-ì €ì ˆë¡œ-ì¢…ë£Œë˜ë‚˜">3) MCP ClientSessionì€ ì €ì ˆë¡œ ì¢…ë£Œë˜ë‚˜?</h1>

<p>ìë™ ì¢…ë£Œë¥¼ ê¸°ëŒ€í•˜ë©´ ì•ˆ ëœë‹¤. í‘œì¤€ íŒ¨í„´ì€ ì„¸ ê°€ì§€ë‹¤.</p>

<ol>
  <li>
    <p>ì„¸ì…˜ì„ ê°ì‹¼ íŠ¸ëœìŠ¤í¬íŠ¸(StdIO/SSE)ì— ëŒ€í•´ stop/closeë¥¼ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤.</p>
  </li>
  <li>
    <p>async with ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ë˜í¼ë¥¼ ë§Œë“¤ì–´ with ë¸”ë¡ì´ ëë‚  ë•Œ ì •ë¦¬í•œë‹¤.</p>
  </li>
  <li>
    <p>í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ í›…ì—ì„œ ì „ì—­ ì„¸ì…˜ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì •ë¦¬í•œë‹¤.</p>
  </li>
</ol>

<p>ê°„ë‹¨ ì •ë¦¬ í•¨ìˆ˜ ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì„¸ì…˜ê³¼ íŠ¸ëœìŠ¤í¬íŠ¸ë¥¼ í•¨ê»˜ ì¶”ì í•´ì•¼ ì•ˆì „
</span><span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<p>ì„¸ì…˜ì„ ì—´ ë•Œ MCPHandleì„ ë§Œë“¤ì–´ ë¦¬ìŠ¤íŠ¸ì— ë„£ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ëª¨ë“  handle.close()ë¥¼ await í•˜ë©´ ëœë‹¤.</p>

<h1 id="4-ì—¬ëŸ¬-agentê°€-ì„¸ì…˜ì„-ê³µìœ í•´ë„-ë ê¹Œ-í•˜ë‚˜ë¡œ-ìœ ì§€í•˜ëŠ”-ì „ëµê³¼-ì£¼ì˜ì ">4) ì—¬ëŸ¬ Agentê°€ ì„¸ì…˜ì„ ê³µìœ í•´ë„ ë ê¹Œ? í•˜ë‚˜ë¡œ ìœ ì§€í•˜ëŠ” ì „ëµê³¼ ì£¼ì˜ì </h1>

<p>ê²°ë¡ ë¶€í„° ë§í•˜ë©´, ê³µìœ  í’€ì„ ë‘ê³  ì¬ì‚¬ìš©í•˜ëŠ” ê²Œ ì¼ë°˜ì ìœ¼ë¡œ ì¢‹ë‹¤. ë‹¤ë§Œ ëª‡ ê°€ì§€ ì£¼ì˜ì ì´ ìˆë‹¤.</p>

<p>ì¥ì <br />
ë©”ëª¨ë¦¬Â·í”„ë¡œì„¸ìŠ¤ ìˆ˜ ì ˆê°. stdio ì„œë²„ëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ í•˜ë‚˜ë§Œ ë„ìš°ë©´ ëœë‹¤.<br />
ì½œë“œ ìŠ¤íƒ€íŠ¸ ì§€ì—° ê°ì†Œ. list_tools ìºì‹œì™€ ì—°ê²° ìˆ˜ë¦½ ì‹œê°„ì´ ì ˆì•½ëœë‹¤.</p>

<p>ì£¼ì˜ì <br />
ë™ì‹œì„±. í•˜ë‚˜ì˜ MCP ì„¸ì…˜ì´ ë‹¤ì¤‘ í˜¸ì¶œì„ ì²˜ë¦¬í•  ë•Œ, ì„œë²„/í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì‹œ í˜¸ì¶œì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•œë‹¤. ëŒ€ë¶€ë¶„ì˜ MCP ì„œë²„ êµ¬í˜„ì€ ê´œì°®ì§€ë§Œ, íŠ¹ì • ì„œë²„ê°€ ìˆœì°¨ ì²˜ë¦¬ë§Œ ì•ˆì „í•˜ê²Œ ì§€ì›í•œë‹¤ë©´ íì‰ì´ë‚˜ ì„¸ë§ˆí¬ì–´ê°€ í•„ìš”í•˜ë‹¤.<br />
ê²©ë¦¬. ì‚¬ìš©ìÂ·ê¶Œí•œì´ ë‹¤ë¥¸ Agentê°€ ê°™ì€ ì„¸ì…˜ì„ ì“°ë©´ ê¶Œí•œ ê²½ê³„ê°€ íë ¤ì§ˆ ìˆ˜ ìˆë‹¤. ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê¶Œí•œ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.<br />
ìƒëª…ì£¼ê¸°. ëˆ„ê°€ ì–¸ì œ ë‹«ì„ì§€ í•©ì˜ê°€ í•„ìš”í•˜ë‹¤. ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŒ… ë˜ëŠ” ëª…ì‹œì  init/close APIê°€ í•„ìš”í•˜ë‹¤.<br />
ë²„ì „Â·ì˜µì…˜ ì°¨ì´. ê°™ì€ ì„œë²„ë¼ë„ í”Œë˜ê·¸(ì˜ˆ: dry_run ê¸°ë³¸ê°’)ê°€ ë‹¤ë¥¸ Agentë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤. ì´ë• ì„¸ì…˜ì„ ê³µìœ í•˜ì§€ ë§ê³  ë³„ë„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë„ì›Œë¼.</p>

<p>ê°„ë‹¨í•œ ì„¸ì…˜ í’€ ìŠ¤ìºí´ë”©(RefCount + AsyncLock):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPSessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,...]],</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># key ì˜ˆì‹œ: ("stdio", ("npx","-y","@modelcontextprotocol/server-filesystem","./data"))
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acquire_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientSession</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">:</span>
                <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
            <span class="c1"># ìƒˆë¡œ ìƒì„±
</span>            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">transport</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">release_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>ì‚¬ìš© íŒ¨í„´<br />
Agentê°€ ì‹œì‘í•  ë•Œ acquire_stdioë¡œ ì„¸ì…˜ì„ ë°›ì•„ ì“°ê³ , ëë‚  ë•Œ release_stdioë¡œ ë°˜ë‚©í•œë‹¤. ë™ì¼í•œ command/args ì¡°í•©ì€ í•œ ì„¸ì…˜ì„ ê³µìœ í•œë‹¤. ê¶Œí•œ ê²©ë¦¬ê°€ í•„ìš”í•œ ê²½ìš° keyì— ì¶”ê°€ ì‹ë³„ì(tenant, role ë“±)ë¥¼ í¬í•¨ì‹œí‚¤ë©´ ëœë‹¤. ë™ì‹œì„± ë°€ë„ê°€ ë†’ë‹¤ë©´ ê° MCP ì„œë²„ íŠ¹ì„±ì— ë§ì¶° per-server ì„¸ë§ˆí¬ì–´ë¥¼ ë”í•´ì£¼ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.</p>

<p>ë§ˆë¬´ë¦¬ íŒ<br />
ì„ì¸ í™˜ê²½(ì¼ë°˜ í•¨ìˆ˜ + MCP)ì—ì„œëŠ” íˆ´ ìˆ˜ê°€ ëŠ˜ì–´ í˜¼ë€ì´ ìƒê¸°ê¸° ì‰¬ìš°ë‹ˆ, ì—ì´ì „íŠ¸ì— ë“±ë¡í•  ë•Œ ë„ë©”ì¸ë³„ í”„ë¦¬í”½ìŠ¤(server:tool, local.*)ì™€ ì§§ê³  ëª…í™•í•œ ì„¤ëª…, ì—„ê²©í•œ JSON ìŠ¤í‚¤ë§ˆ(required/enum/format)ë¥¼ ìœ ì§€í•˜ì. í•„ìš”í•˜ë©´ í•œ í„´ì— ë…¸ì¶œí•  íˆ´ì„ í•„í„°ë§í•´ ê³¼ì ì¬ë¥¼ ì¤„ì´ëŠ” ê²ƒë„ íš¨ê³¼ì ì´ë‹¤.</p>

<p class="chat--user">

1ë²ˆê³¼ 2ë²ˆì„ í•©ì³ì„œ ì¨ì•¼ì§€. ë‘ ê°œ íˆ´ êµ¬í˜„ì´ ë„ˆë¬´ ë‹¤ë¥´ì–ì•„. íˆ´ êµ¬í˜„ì„ í•œ ë²ˆë§Œ í•˜ê³  ë‘ êµ°ë° ëª¨ë‘ì—ì„œ ì“°ê³  ì‹¶ì€ê±°ì•¼.

</p>

<p>ì¢‹ì•„, â€œíˆ´ êµ¬í˜„ì€ í•œ ë²ˆë§Œâ€ í•˜ê³ , ê·¸ê±¸ ë‘ ë°©ì‹ ëª¨ë‘ì—ì„œ ì¬ì‚¬ìš©í•˜ë„ë¡ í•©ì¹˜ì. ì•„ë˜ ìŠ¤ìºí´ë”©ì€ ë‹¨ì¼ ToolRegistryì— íˆ´ì„ ë“±ë¡í•˜ê³ , ê°™ì€ êµ¬í˜„ì„ 1) OpenAI Agents SDK(FunctionTool) ê²½ë¡œ, 2) ì¼ë°˜ Chat Completions(with tools) ê²½ë¡œ ì–‘ìª½ì—ì„œ ê·¸ëŒ€ë¡œ ì”ë‹ˆë‹¤. MCP íˆ´ë„ ë™ì¼í•œ ì¶”ìƒí™”ë¡œ ë˜í•‘í•©ë‹ˆë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>unified_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1">###############################################################################
# ê³µí†µ ì¶”ìƒí™”: í•œ ë²ˆ êµ¬í˜„í•œ íˆ´ì„ ì–´ë””ì„œë“  ì¬ì‚¬ìš©
###############################################################################
</span>
<span class="c1"># Tool í•¸ë“¤ëŸ¬ ì‹œê·¸ë‹ˆì²˜: args(dict) -&gt; dict/str (awaitable)
</span><span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># ì‹¤ì œ ì‹¤í–‰ ë¡œì§(ë™ì¼ êµ¬í˜„ì„ ì–‘ìª½ì—ì„œ ì¬ì‚¬ìš©)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool name: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">list_for_chat_completions</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># OpenAI tools í¬ë§·ìœ¼ë¡œ ì§ë ¬í™”
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# ë¡œì»¬(ì¼ë°˜) íˆ´ êµ¬í˜„ ì˜ˆì‹œ: í•œ ë²ˆë§Œ êµ¬í˜„
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">LOCAL_MATH_TOOL</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°. ì…ë ¥ {expr: string}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="n">handler</span><span class="o">=</span><span class="n">math_eval_handler</span>
<span class="p">)</span>

<span class="c1">###############################################################################
# MCP íˆ´ì„ ë™ì¼ ì¶”ìƒí™”ë¡œ ë˜í•‘: ì„¸ì…˜ë³„ë¡œ ToolSpecì„ ìƒì„±
###############################################################################
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ prefix
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆ í•„ìš”</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mcp_toolspecs_from_session</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="c1"># ë™ê¸° í•¨ìˆ˜ë¡œ ëª…ì„¸ë§Œ ë§Œë“¤ê³ , handlerëŠ” sessionì„ ìº¡ì²˜í•˜ì—¬ ë¹„ë™ê¸°ë¡œ í˜¸ì¶œ
</span>    <span class="c1"># list_tools ëŠ” asyncë¼ ë°–ì—ì„œ í˜¸ì¶œí•´ metadataë¥¼ ë„˜ê²¨ì¤˜ì•¼ í•œë‹¤.
</span>    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">call build_mcp_tools(...) instead</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">MCPHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">handle</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">):</span>
            <span class="c1"># _toolë¥¼ default ì¸ìë¡œ ë°”ì¸ë”©í•´ late-binding ì´ìŠˆ ë°©ì§€
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">packed</span>

        <span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">specs</span>

<span class="c1">###############################################################################
# 1) OpenAI Agents SDK ê²½ë¡œ: FunctionToolë¡œ ë˜í•‘í•˜ë˜, handlerëŠ” ë™ì¼ êµ¬í˜„ ì‚¬ìš©
###############################################################################
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_function_tool</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># ì—ì´ì „íŠ¸ëŠ” ë¬¸ìì—´ ë°˜í™˜ì´ í‘œì¤€ì´ë¯€ë¡œ JSON ë¬¸ìì—´ë¡œ ì§ë ¬í™”
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_function_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">()]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">user_text</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1">###############################################################################
# 2) ì¼ë°˜ Chat Completions ê²½ë¡œ: tools JSON + ë™ì¼ handlerë¡œ tool_calls ë¼ìš°íŒ…
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_for_chat_completions</span><span class="p">()</span>

        <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># ë„êµ¬ í˜¸ì¶œ ì²˜ë¦¬ ë£¨í”„(í•„ìš” ì‹œ ë°˜ë³µ)
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw_args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">}</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# ì‹¤í–‰ ì˜ˆì‹œ: í•œ ë²ˆ êµ¬í˜„ â†’ ë‘ ê²½ë¡œì—ì„œ ì‚¬ìš©
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìƒì„± ë° ë¡œì»¬ íˆ´ ë“±ë¡(í•œ ë²ˆë§Œ)
</span>    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">LOCAL_MATH_TOOL</span><span class="p">)</span>

    <span class="c1"># 1) MCP ì„¸ì…˜ ì—°ê²° í›„, MCP íˆ´ë“¤ì„ ë™ì¼ ì¶”ìƒí™”ë¡œ ë“±ë¡
</span>    <span class="n">files_cfg</span> <span class="o">=</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">files_handle</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">files_cfg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="k">await</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">files_handle</span><span class="p">):</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># A) Agents SDK ê²½ë¡œ
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Agents SDK ê²½ë¡œ ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="sh">"</span><span class="s">data í´ë”ì˜ sales.csvë¥¼ ì½ê³  í•©ê³„ë¥¼ ê³„ì‚°í•œ ë’¤ local.math_evalë¡œ 2ë°°ë¥¼ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># B) ì¼ë°˜ Chat Completions ê²½ë¡œ
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Chat Completions ê²½ë¡œ ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">files ì„œë²„ íˆ´ë¡œ sales.csv í•©ê³„ë¥¼ êµ¬í•˜ê³  local.math_evalë¡œ 100+23ë„ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">files_handle</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸ ì •ë¦¬<br />
íˆ´ì€ ToolSpec(handler í¬í•¨)ìœ¼ë¡œ í•œ ë²ˆë§Œ êµ¬í˜„í•œë‹¤. MCPë„ build_mcp_toolsê°€ ë™ì¼í•œ ToolSpecì„ ë§Œë“¤ê³ , ë¡œì»¬ íˆ´ë„ ê°™ì€ í˜•íƒœë‹¤.<br />
OpenAI Agents SDKëŠ” FunctionToolë¡œ ì–‡ê²Œ ë˜í•‘ë§Œ í•œë‹¤. on_invokeëŠ” ê°™ì€ handlerë¥¼ í˜¸ì¶œí•œë‹¤.<br />
Chat Completions(with tools)ë„ registryì˜ tools JSONì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³ , tool_callsë¥¼ ê°™ì€ handlerë¡œ ë¼ìš°íŒ…í•œë‹¤.<br />
MCP ì„¸ì…˜ì€ MCPHandle.closeë¡œ ëª…ì‹œ ì¢…ë£Œí•œë‹¤. ì—¬ëŸ¬ Agentë‚˜ ì—¬ëŸ¬ ëŸ¬ë„ˆê°€ ìˆì„ ë•Œ ê³µìœ í•˜ê³  ì‹¶ë‹¤ë©´ í•¸ë“¤ í’€ì„ ë‘ê³  ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŒ…ë§Œ ì–¹ìœ¼ë©´ ëœë‹¤.</p>

<p>ì´ì œ â€œíˆ´ êµ¬í˜„ì€ í•œ ë²ˆë§Œâ€ ì“°ê³ , Agentsì™€ Chat Completions ì–´ë””ì„œë“  ë™ì¼í•˜ê²Œ ëŒì•„ê°„ë‹¤. í•„ìš”í•œ ê²½ìš° expose(íˆ´ ì†Œì¶œ) ì •ì±…ì´ë‚˜ ê¶Œí•œ ê²Œì´íŠ¸ë¥¼ registry ë ˆë²¨ì—ì„œ í•„í„°ë§ í›…ìœ¼ë¡œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p class="chat--user">

í  ì°¨ë¼ë¦¬ MCPì— ëŒ€í•œ ì •ë³´ë¥¼ ë”°ë¡œ ë°›ê³  ì—ì´ì „íŠ¸ì—ê²Œ ì•Œì•„ì„œ ì²˜ë¦¬í•˜ëŠ”ê²Œ ë‚˜ì„ê¹Œ? ì´ëŸ¬ë„ˆ ë ˆì´ì–´ë¥¼ ë‚´ê°€ ì§ì ‘ ë§Œë“œëŠ”ê²ƒë³´ë‹¤?

</p>

<p>ì§šê³  ê°€ì. â€œMCP ì •ë³´ë¥¼ ì—ì´ì „íŠ¸ì—ê²Œ ê·¸ëŒ€ë¡œ ë„˜ê²¨ì„œ ì•Œì•„ì„œ ì“°ê²Œ í• ì§€â€ vs â€œë„¤ê°€ ëŸ¬ë„ˆ ë ˆì´ì–´(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°)ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ í†µì œí• ì§€â€ëŠ” íŠ¸ë ˆì´ë“œì˜¤í”„ë‹¤. í•œìª½ì´ í•­ìƒ ë” ë‚«ì§€ëŠ” ì•Šë‹¤. ì•„ë˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„ íƒí•˜ë©´ ëœë‹¤.</p>

<p>ì„ íƒ ê¸°ì¤€ ìš”ì•½<br />
ì—ì´ì „íŠ¸ê°€ MCPë¥¼ ì§ì ‘ ë‹¤ë£¨ê²Œ í•œë‹¤<br />
ì¥ì : ì„¤ì •ì´ ë‹¨ìˆœí•˜ê³  ë¹ ë¥´ë‹¤. SDKê°€ ì„¸ì…˜ ê´€ë¦¬, íˆ´ í˜¸ì¶œ, ë°˜í™˜ í˜•ì‹ ë“±ì„ ì•Œì•„ì„œ ì²˜ë¦¬í•œë‹¤. í˜¸ìŠ¤í‹°ë“œ/ì›ê²© MCPëŠ” ì½”ë“œ ì—†ì´ ë¶™ì´ê¸° ì‰½ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io+1</a><br />
ë‹¨ì : í„´ë³„ íˆ´ ì†Œì¶œ(Selective exposure), ê³ ê¸‰ ìŠ¹ì¸ íë¦„, ë¡œê¹… í‘œì¤€í™”, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê·œì¹™, ì¬ì‹œë„Â·ì„œí‚·ë¸Œë ˆì´ì»¤ ê°™ì€ â€œí”Œë«í¼ ê³µí†µ ì •ì±…â€ì„ ì„¸ë°€í•˜ê²Œ ë„£ê¸° ì–´ë µë‹¤. ëª¨ë¸ì´ ë§ì€ íˆ´ì„ ë™ì‹œì— ë³´ê²Œ ë˜ë©´ í˜¸ì¶œ í˜¼ì„ ì´ ëŠ˜ì–´ë‚œë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com">OpenAI Platform+1</a></p>

<p>ì§ì ‘ ëŸ¬ë„ˆ(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°)ë¥¼ ë‘”ë‹¤<br />
ì¥ì : íˆ´ ë…¸ì¶œÂ·ê¶Œí•œÂ·ì—ëŸ¬ ì²˜ë¦¬Â·ê´€ì¸¡ì„±ì„ ì „ë¶€ ë„¤ê°€ í‘œì¤€í™”í•  ìˆ˜ ìˆë‹¤. ì—¬ëŸ¬ ì±„íŒ… ë°±ì—”ë“œ(Agents, ì¼ë°˜ Chat Completions, ì‚¬ë‚´ ì—”ì§„)ë¥¼ ê°™ì€ ê·œì•½ìœ¼ë¡œ ê¿°ë§¤ ì“¸ ìˆ˜ ìˆë‹¤.<br />
ë‹¨ì : ë„¤ê°€ ì„¸ì…˜ í’€, ë¼ìš°íŒ…, ì¬ì‹œë„, í¬ë§· ê°•ì œ(JSONë§Œ ì¶œë ¥ ë“±)ë¥¼ êµ¬í˜„Â·ìœ ì§€í•´ì•¼ í•œë‹¤.</p>

<p>ê¶Œì¥ ê²°ë¡ <br />
ìš´ì˜ ê¸°ì¤€ì´ ë¹¡ë¹¡í•˜ë‹¤ë©´(ê¶Œí•œ ë¶„ë¦¬, ìŠ¹ì¸, ë¡œê·¸, ë³µêµ¬ ì „ëµ, ë¹„ìš©/ì§€ì—° ê´€ë¦¬), ì§€ê¸ˆê¹Œì§€ ë§Œë“  ì–‡ì€ ëŸ¬ë„ˆë¥¼ ìœ ì§€í•˜ë˜ ë°±ì—”ë“œëŠ” ê°ˆì•„ë¼ìš°ëŠ” ë°©ì‹ì´ ì í•©í•˜ë‹¤. ë°˜ëŒ€ë¡œ ë¹ ë¥¸ ì´ˆê¸° í†µí•©Â·PoC, ê³µê°œ ì›ê²© MCPë§Œ ì“°ëŠ” ê²½ìš°ì—ëŠ” ì—ì´ì „íŠ¸ê°€ MCPë¥¼ ì§ì ‘ ë‹¤ë£¨ê²Œ í•˜ëŠ” êµ¬ì„±ì´ ê°€ë³ë‹¤. ë‘˜ì„ ì„ëŠ” í•˜ì´ë¸Œë¦¬ë“œë„ ê°€ëŠ¥í•˜ë‹¤. ì¦‰, ì €ìœ„í—˜Â·ì½ê¸° ì „ìš© MCPëŠ” ì—ì´ì „íŠ¸ê°€ ì§ì ‘, ê³ ìœ„í—˜ MCPëŠ” ëŸ¬ë„ˆë¥¼ í†µí•´ì„œë§Œ ë…¸ì¶œ.</p>

<p>ë‘˜ ì¤‘ í•˜ë‚˜ë¥¼ ê³ ë¥¸ ë’¤ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ, ì‹¤ì œ ì‚¬ìš© ìŠ¤ë‹ˆí«ì„ 2ê°œ ë¶™ì¸ë‹¤.</p>

<p>ì—ì´ì „íŠ¸ê°€ MCPë¥¼ ì§ì ‘ ë‹¤ë£¨ëŠ” ìµœì†Œ ì˜ˆì‹œ<br />
ì—¬ê¸°ì„œëŠ” OpenAI Agents Python SDKì— ì—¬ëŸ¬ MCP ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê¸´ë‹¤. ëª¨ë¸ì€ OpenAI í˜¸í™˜ RESTë¡œ ë…¸ì¶œëœ ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì“´ë‹¤(LiteLLM ë˜í¼).<br />
ì£¼ì˜: ì—ì´ì „íŠ¸ì— íˆ´ì„ ëª¨ë‘ ë…¸ì¶œí•˜ë©´ í˜¼ì„ ì´ ìƒê¸¸ ìˆ˜ ìˆìœ¼ë‹ˆ, í•„ìš”í•˜ë©´ íˆ´ í•„í„°Â·ìŠ¹ì¸ ì˜µì…˜ì„ ë³‘í–‰í•˜ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>  <span class="c1"># SDK ë‚´ì¥ MCP ì»¤ë„¥í„°
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://your-mcp.example/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">your-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">AgentManagedMCP</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•œ MCP íˆ´ë§Œ ì„ íƒí•´ì„œ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>  <span class="c1"># í¬ì¸íŠ¸: MCP ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê¹€
</span>        <span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data í´ë”ì—ì„œ sales.csv ì´í•©ì„ êµ¬í•˜ê³ , ê²€ìƒ‰ ì„œë²„ë¡œ ê´€ë ¨ ë¦¬í¬íŠ¸ë¥¼ ì°¾ì•„ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì¼ë°˜ Chat Completions(with tools)ì— ë°”ë¡œ ë¶™ì´ëŠ” ìµœì†Œ ì˜ˆì‹œ<br />
ì—¬ê¸°ì„œëŠ” MCP ì •ë³´ë¥¼ ì§ì ‘ ë„˜ê¸°ì§€ ì•Šê³ , MCPê°€ ë…¸ì¶œí•œ íˆ´ë“¤ì„ OpenAI â€œtoolsâ€ í¬ë§·ìœ¼ë¡œ ë³€í™˜í•´ì„œ ëª¨ë¸ì—ê²Œ ë³´ì—¬ì¤€ë‹¤. ëª¨ë¸ì˜ tool_callsë¥¼ ë°›ìœ¼ë©´ ë„¤ê°€ call_toolì„ ì‹¤í–‰í•œë‹¤. ì´ ê²½ë¡œëŠ” ëŸ¬ë„ˆê°€ ì–‡ê²Œë‚˜ë§ˆ í•„ìš”í•˜ì§€ë§Œ, ë„ˆê°€ ì´ë¯¸ ê°€ì§„ í†µì¼ ì¸í„°í˜ì´ìŠ¤(ë‹¨ì¼ ToolRegistry + handler ì¬ì‚¬ìš©)ë¥¼ ìœ ì§€í•˜ê¸° ì¢‹ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="n">BASE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>
<span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">your-model</span><span class="sh">"</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">list_mcp_tools_as_openai_tools</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]))</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">);</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">files:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">session</span><span class="p">,</span> <span class="n">tools</span>  <span class="c1"># sessionì€ ë’¤ì—ì„œ call_toolì— ì‚¬ìš©
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">session</span><span class="p">,</span> <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">list_mcp_tools_as_openai_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">í•„ìš”í•œ íˆ´ë§Œ í˜¸ì¶œí•œë‹¤.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">files ì„œë²„ íˆ´ë¡œ sales.csv í•©ê³„ë¥¼ êµ¬í•´ì¤˜</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># 1ì°¨ ìš”ì²­
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>            <span class="c1"># e.g., files:read
</span>            <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># MCP ì‹¤í–‰
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="c1"># í‘œì¤€í™”í•˜ì—¬ íˆ´ ë©”ì‹œì§€ë¡œ ì¬ì£¼ì…
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[</span><span class="nf">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">,{})</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">]})</span>
            <span class="p">})</span>

        <span class="c1"># 2ì°¨ ìš”ì²­
</span>        <span class="n">data2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="n">_transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì–¸ì œ â€œì—ì´ì „íŠ¸ì—ê²Œ ë§¡ê¸°ê¸°â€ê°€ ìœ ë¦¬í•œê°€<br />
MCP ì„œë²„ê°€ ì „ë¶€ ì›ê²©Â·ê³µê°œì´ê³ , ê¶Œí•œ ê²½ê³„ê°€ ë‹¨ìˆœí•˜ë©°, íˆ´ ìˆ˜ê°€ ë§ì§€ ì•Šê³ , ë¹ ë¥´ê²Œ ê²°ê³¼ë¥¼ ë‚´ì•¼ í•  ë•Œ. SDKê°€ ì„¸ì…˜Â·í˜¸ì¶œì„ ëŒ€ì‹  ê´€ë¦¬í•˜ë¯€ë¡œ ê°œë°œ ë¹„ìš©ì´ ë‚®ë‹¤. OpenAI Agents SDKì˜ MCP ê°€ì´ë“œëŠ” ì´ ê²½ë¡œë¥¼ ê¸°ë³¸ìœ¼ë¡œ ìƒì •í•œë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/?utm_source=chatgpt.com">openai.github.io</a></p>

<p>ì–¸ì œ â€œì§ì ‘ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜â€ì´ ìœ ë¦¬í•œê°€<br />
íˆ´ì´ ë§ê³  ì„±ê²©ì´ ë‹¤ì–‘í•´ì„œ í„´ë³„ ì†Œì¶œì´ í•„ìš”í•  ë•Œ, ì‹¤íŒ¨Â·ì¬ì‹œë„Â·ë°±ì˜¤í”„ ê°™ì€ SRE ë£°ì„ ë„ì…í•´ì•¼ í•  ë•Œ, ê°ì‚¬ ë¡œê·¸ì™€ ìŠ¹ì¸ í”Œë¡œìš°ê°€ í•„ìš”í•œ ì¡°ì§ í™˜ê²½ì¼ ë•Œ. ì´ë•ŒëŠ” ë„¤ê°€ ë§Œë“  ToolRegistry/handler ë‹¨ì¼í™” êµ¬ì¡°ê°€ ìœ ì§€ë³´ìˆ˜ì— ìœ ë¦¬í•˜ë‹¤. ëª¨ë¸/í”Œë«í¼ì„ ë°”ê¿€ ë•Œë„ ë°±ì—”ë“œë§Œ êµì²´í•˜ë©´ ëœë‹¤. OpenAI í‘œì¤€ í•¨ìˆ˜ì½œ ë£¨í”„ëŠ” ë¬¸ì„œì˜ ê¶Œì¥ íŒ¨í„´ì´ë©°, ì´ ìœ„ì— ì •ì±…ì„ ì–¹ê¸° ì‰½ë‹¤. <a href="https://platform.openai.com/docs/guides/function-calling?api-mode=chat&amp;utm_source=chatgpt.com">OpenAI Platform+1</a></p>

<p>í•˜ì´ë¸Œë¦¬ë“œ íŒ<br />
ì €ìœ„í—˜Â·ì½ê¸° ì „ìš© MCPëŠ” ì—ì´ì „íŠ¸ ì§ê²°ë¡œ ë¹¨ë¦¬ ë¶™ì´ê³ , ê³ ìœ„í—˜(ì“°ê¸°/ì‚­ì œ/ê²°ì œ/ë°°í¬) MCPëŠ” ëŸ¬ë„ˆ ê²½ìœ  íˆ´ë¡œë§Œ ë…¸ì¶œí•œë‹¤. ì—ì´ì „íŠ¸ ìª½ì—ëŠ” í•´ë‹¹ íˆ´ì„ ìˆ¨ê²¨ ë‘ê³ , ëŸ¬ë„ˆê°€ ìŠ¹ì¸ëœ ìš”ì²­ë§Œ ëŒ€ë¦¬ í˜¸ì¶œí•œë‹¤. ì´ êµ¬ì„±ì´ í˜„ì—…ì—ì„œ ê°€ì¥ ì—ëŸ¬ìœ¨Â·ì‚¬ê³ ìœ¨ì´ ë‚®ê³ , ì´ˆê¸° ì†ë„ë„ ë¹ ë¥´ë‹¤.</p>

<p>ë§ˆì§€ë§‰ ì²´í¬ë¦¬ìŠ¤íŠ¸<br />
íˆ´ ê³¼ì ì¬ë¥¼ í”¼í•˜ë ¤ë©´ íˆ´ ë…¸ì¶œ ìˆ˜ë¥¼ í„´ë‹¹ 8~12ê°œ ìˆ˜ì¤€ì—ì„œ ì‹œì‘í•˜ì.<br />
namespacingì€ server:tool íŒ¨í„´ì„ ê³ ì •í•´ ì¶©ëŒì„ ë§‰ì.<br />
input_schemaë¥¼ ì—„ê²©í•˜ê²Œ(required, enum, format) ì¡ì•„ ì˜ëª»ëœ argumentsë¥¼ ì¤„ì´ì.<br />
MCP ì„¸ì…˜ì€ ìë™ ì¢…ë£Œê°€ ì•„ë‹ˆë¯€ë¡œ ì¢…ë£Œ í›…ì„ ë‘ê±°ë‚˜ ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•˜ì.<br />
ì„¸ì…˜ ê³µìœ ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ ê¶Œí•œÂ·ë™ì‹œì„±Â·ìƒëª…ì£¼ê¸° ê·œì¹™ì„ ë¨¼ì € ì •í•´ë‘¬ì•¼ í•œë‹¤.</p>

<p>ì›í•œë‹¤ë©´ ì§€ê¸ˆ ë„¤ ì‹¤ì œ MCP ì„œë²„ ëª©ë¡ê³¼ ìœ„í—˜ë„(ì½ê¸°/ì“°ê¸°), ê·¸ë¦¬ê³  ì‚¬ìš© ì¤‘ì¸ ëª¨ë¸ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì•Œë ¤ì¤˜. ìœ„ ìŠ¤ë‹ˆí«ì„ ë„¤ í™˜ê²½ì— ë§ê²Œ ë°”ë¡œ ëŒì•„ê°€ë„ë¡ ê¹”ë”í•˜ê²Œ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆí•´ì£¼ê² ë‹¤.</p>

<p class="chat--user">

MCPê°€ 3ê°œ ì´ìƒë“¤ì–´ì™”ì„ ë•Œ ì²˜ë¦¬ì— ëŒ€í•´ ì•Œë ¤ì¤˜. ê·¸ë¦¬ê³  OpenAI Agent ë§ê³  ë‹¤ë¥¸ Agentë„ ìˆì–´. 1. MCPì— ê´€í•œ ì •ë³´ë¥¼ í†µì¼ë˜ê²Œ ë‹¤ë£° ìˆ˜ ìˆëŠ” í´ë˜ìŠ¤ê°€ í•„ìš”í•´. 2. 1ì—ì„œ ë§Œë“  ì •ë³´ë¥¼ ê°ê°ì˜ Agentì— ë§ê²Œ Adaptë¥¼ í•´ì¤„ ìˆ˜ ìˆëŠ” ì–‡ì€ í´ë˜ìŠ¤ë‚˜ í•¨ìˆ˜ê°€ í•„ìš”í•  ê²ƒ ê°™ì•„.

</p>

<p>ì¢‹ì•„. â€œMCP ì„œë²„ê°€ 3ê°œ ì´ìƒâ€ì¼ ë•Œ í”ë“¤ë¦¬ì§€ ì•Šê²Œ ëŒë¦¬ëŠ” êµ¬ì¡°ë¥¼ ë”± ë‘ ì¸µìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ë‚˜ëˆ ì¤„ê²Œ.</p>

<ol>
  <li>
    <p>MCP ì •ë³´ë¥¼ â€œì™„ì „íˆ í†µì¼ëœ í¬ë§·â€ìœ¼ë¡œ ë‹¤ë£¨ëŠ” í—ˆë¸Œ í´ë˜ìŠ¤</p>
  </li>
  <li>
    <p>ê·¸ í†µì¼ í¬ë§·ì„ ê° ì—ì´ì „íŠ¸ë³„ë¡œ ì–‡ê²Œ ë³€í™˜í•˜ëŠ” ì–´ëŒ‘í„°ë“¤</p>
  </li>
</ol>

<p>í•œ ë²ˆì˜ êµ¬í˜„ìœ¼ë¡œ OpenAI Agents, ì¼ë°˜ Chat Completions(with tools), ê·¸ë¦¬ê³  ë‹¤ë¥¸ í”„ë ˆì„ì›Œí¬(ì›í•˜ë©´ LangChain/Autogen ë“±)ê¹Œì§€ ê°™ì€ íˆ´ êµ¬í˜„ì„ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì•„ë˜ ìŠ¤ìºí´ë”©ì€ ê·¸ëŒ€ë¡œ ë³µë¶™í•´ì„œ ì‹œì‘í•´ë„ ëœë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>mcp_unified_adapters.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">uuid</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>

<span class="c1"># =========================
# 0) í†µì¼ëœ íˆ´ ìŠ¤í™/ë ˆì§€ìŠ¤íŠ¸ë¦¬
# =========================
</span>
<span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">UnifiedToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># ì˜ˆ: "files:read_csv" or "local.math_eval"
</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># ëª¨ë“  ë°±ì—”ë“œì—ì„œ ì¬ì‚¬ìš©ë˜ëŠ” ì‹¤ì œ ì‹¤í–‰ ë¡œì§
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">UnifiedToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">UnifiedToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UnifiedToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

<span class="c1"># =========================
# 1) MCP í—ˆë¸Œ(3ê°œ+ ì„œë²„ ì•ˆì • ìš´ìš©)
# =========================
</span>
<span class="c1"># a) ì„¤ì •ê³¼ í•¸ë“¤
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># ì„ íƒ: ë™ì‹œì„± ì œí•œ ë“±
</span>    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sema</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># b) MCP í—ˆë¸Œ: 3ê°œ ì´ìƒ ì„œë²„ë¥¼ ì—°ê²°Â·í†µì¼ ìŠ¤í™ìœ¼ë¡œ ë³€í™˜Â·ì‹¤í–‰ ë¼ìš°íŒ…
</span><span class="k">class</span> <span class="nc">MCPHub</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MCPHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">)</span>

        <span class="c1"># list_toolsë¥¼ ëª¨ë‘ ê¸ì–´ í†µì¼ ìŠ¤í™ìœ¼ë¡œ ë“±ë¡(ë„¤ì„ìŠ¤í˜ì´ìŠ¤: server:tool)
</span>        <span class="k">for</span> <span class="n">server</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="c1"># ë™ì‹œì„± ë³´í˜¸ + íƒ€ì„ì•„ì›ƒ
</span>                    <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">sema</span><span class="p">:</span>
                        <span class="n">coro</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">_server</span><span class="p">].</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">packed</span>

                <span class="n">self</span><span class="p">.</span><span class="n">_registry</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">UnifiedToolSpec</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
                <span class="p">))</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">registry</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolRegistry</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_ready</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPHub.start() í˜¸ì¶œ ì „ì…ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_registry</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># =========================
# 2) ê³µí†µ ë¡œì»¬ íˆ´(ì„ íƒ)
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedToolSpec</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">UnifiedToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">},</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">math_eval</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># =========================
# 3) ì–´ëŒ‘í„° ë ˆì´ì–´(ì–‡ê²Œ)
# =========================
</span>
<span class="c1"># 3-a) OpenAI Agents Python SDK(FunctionTool) ì–´ëŒ‘í„°
</span><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_agents_function_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">UnifiedToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="nf">wrap</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">()]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">model_impl</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•˜ê³ , íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_impl</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="nf">to_agents_function_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1"># 3-b) OpenAI í˜¸í™˜ Chat Completions(with tools) ì–´ëŒ‘í„°
</span><span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_tools_json</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
        <span class="p">}}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system</span><span class="p">},</span>
            <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_json</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw</span><span class="p">}</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">];</span> <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>

<span class="c1"># 3-c) ë‹¤ë¥¸ ì—ì´ì „íŠ¸(ì˜ˆ: LangChain Tool)ë¡œì˜ ì–‡ì€ ì–´ëŒ‘í„°(ì˜µì…˜)
# í•„ìš”í•˜ë©´ ì´ëŸ° í˜•íƒœë¡œ ì¶”ê°€:
</span><span class="k">def</span> <span class="nf">to_langchain_tools</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">langchain.tools</span> <span class="kn">import</span> <span class="n">StructuredTool</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">t</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">StructuredTool</span><span class="p">.</span><span class="nf">from_function</span><span class="p">(</span>
            <span class="n">coroutine</span><span class="o">=</span><span class="n">_run</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">__</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># í”„ë ˆì„ì›Œí¬ ëª…ëª… ê·œì¹™ ë§ì¶”ê¸°
</span>            <span class="n">description</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">description</span>
            <span class="c1"># schemaëŠ” í”„ë ˆì„ì›Œí¬ë³„ë¡œ ë³„ë„ ì§€ì • ê°€ëŠ¥
</span>        <span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># =========================
# 4) 3ê°œ+ MCP ì„œë²„ í¬í•¨ ì‹¤í–‰ ì˜ˆì‹œ
# =========================
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># a) MCP ì„œë²„ 3ê°œ ì´ìƒ ì„ ì–¸
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># ê³µê°œ/ì›ê²©ì´ë©´ SSE ê°€ëŠ¥(ëª¨ë“ˆ ì„¤ì¹˜ í•„ìš”)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="nc">MCPHub</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">hub</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">hub</span><span class="p">.</span><span class="nf">registry</span><span class="p">()</span>

        <span class="c1"># ë¡œì»¬(ì¼ë°˜) íˆ´ë„ ê°™ì€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì¶”ê°€
</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">local_tools</span><span class="p">():</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># ë…¸ì¶œ ê³¼ì ì¬ ë°©ì§€ íŒ(ì„ íƒ): í•„ìš”í•  ë•Œë§Œ ì„œë¸Œì…‹ì„ ë½‘ì•„ ë‹¤ë¥¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë³µì‚¬í•´ë„ ë¨
</span>        <span class="c1"># ì—¬ê¸°ì„œëŠ” ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
</span>
        <span class="c1"># A) OpenAI Agents ê²½ë¡œ
</span>        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span>
            <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸
</span>            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="sh">"</span><span class="s">files ì„œë²„ë¡œ sales.csv í•©ê³„ë¥¼ êµ¬í•˜ê³ , local.math_evalë¡œ 100+23 ê³„ì‚°ë„ í•´ì¤˜</span><span class="sh">"</span>
        <span class="p">)</span>

        <span class="c1"># B) Chat Completions ê²½ë¡œ
</span>        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">system</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="sh">"</span><span class="s">db ì„œë²„ ìš”ì•½ íˆ´ë¡œ ê³ ê°ë³„ êµ¬ë§¤ í•©ê³„ë¥¼ ìš”ì•½í•˜ê³ , ìˆ˜ì¹˜ ê²€ì¦ì€ local.math_evalë¡œ 2*(50+5) ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">hub</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ ì„¤ê³„ í¬ì¸íŠ¸ ì •ë¦¬<br />
MCPê°€ 3ê°œ ì´ìƒì´ì–´ë„ MCPHubê°€ ëª¨ë“  ì„¸ì…˜ì„ ë“¤ê³  ìˆê³ , list_toolsë¥¼ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(server:tool)ë¡œ ë¬¶ì–´ í•˜ë‚˜ì˜ ToolRegistryì— ì˜¬ë¦°ë‹¤. ì‹¤í–‰ë„ ê°™ì€ handlerë¥¼ í†µí•´ ë¼ìš°íŒ…ë˜ë¯€ë¡œ êµ¬í˜„ì´ í•œ ë²ˆë¿ì´ë‹¤.<br />
ì–´ëŒ‘í„° ë ˆì´ì–´ëŠ” ì–‡ë‹¤. Agents(FunctionTool ë¦¬ìŠ¤íŠ¸ ìƒì„±), Chat Completions(tools JSON ìƒì„±), LangChain ë“± ì•„ë¬´ í”„ë ˆì„ì›Œí¬ë‚˜ 20~30ì¤„ ë‚´ë¡œ ë¶™ëŠ”ë‹¤.<br />
ë™ì‹œì„±Â·íƒ€ì„ì•„ì›ƒì„ MCPHandleì— í†µí•©í–ˆë‹¤. ì„œë²„ë§ˆë‹¤ max_concurrencyì™€ timeoutì„ ë‹¤ë¥´ê²Œ ì¤„ ìˆ˜ ìˆë‹¤.<br />
ì„¸ì…˜ ì¢…ë£ŒëŠ” MCPHub.closeì—ì„œ ì¼ê´„ ì²˜ë¦¬í•œë‹¤. ìë™ ì¢…ë£Œì— ê¸°ëŒ€ì§€ ì•ŠëŠ”ë‹¤.</p>

<p>3ê°œ ì´ìƒ ì„œë²„ì¼ ë•Œ ì‹¤ì „ ìš´ì˜ íŒ<br />
íˆ´ ì†Œì¶œ: í„´ë³„ë¡œ í•„ìš”í•œ ì„œë¸Œì…‹ë§Œ ë…¸ì¶œí•˜ë©´ íˆ´ ì„ íƒ ì˜¤ë¥˜ê°€ ê¸‰ê°í•œë‹¤. ê°„ë‹¨í•œ í‚¤ì›Œë“œ ë£°ë¶€í„° ì‹œì‘í•´ë„ íš¨ê³¼ê°€ í¬ë‹¤.<br />
ë„¤ì„ìŠ¤í˜ì´ìŠ¤: server:toolì„ ê³ ì •í•˜ê³ , descriptionì—ë„ ì„œë²„ëª…ì„ ë°˜ë³µ í‘œê¸°í•˜ë©´ í˜¼ë™ì´ ì¤„ì–´ë“ ë‹¤.<br />
ìŠ¤í‚¤ë§ˆ ì—„ê²©í™”: required, enum, formatì„ ê°€ëŠ¥í•œ í•œ ë§ì´ ë„£ì. arguments íŒŒì‹± ì˜¤ë¥˜ê°€ ì¤„ì–´ë“ ë‹¤.<br />
ê´€ì¸¡ì„±: handlerì—ì„œ ì…ë ¥/ì¶œë ¥/ì§€ì—°ì„ JSONLë¡œ ë¡œê¹…í•˜ë©´ í›„ì† ìµœì í™”ê°€ ì‰¬ì›Œì§„ë‹¤.<br />
ê³ ìœ„í—˜ íˆ´: parametersì— dry_run(boolean, default true)ì™€ confirm ë¬¸ìì—´ì„ ì¶”ê°€í•´ ëª¨ë¸ì´ ìì²´ë¡œ ì•ˆì „ ì ˆì°¨ë¥¼ ë°Ÿê²Œ í•˜ì.</p>

<p>ì´ ìŠ¤ìºí´ë”©ì´ë©´ MCP ì •ë³´ë¥¼ í•œ ë²ˆë§Œ ìˆ˜ì§‘Â·ì •ê·œí™”í•˜ê³ , ì–´ë–¤ ì—ì´ì „íŠ¸ë“  ì–´ëŒ‘í„°ë§Œ ê°ˆì•„ë¼ì›Œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. í•„ìš”í•˜ë©´ expose(íˆ´ ì†Œì¶œ) ì „ëµ í•¨ìˆ˜ì™€ ì„¸ì…˜ í’€(ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ì„œë¹„ìŠ¤ ê°„ ê³µìœ )ì„ ë§ëŒ€ì„œ íŒ€ í‘œì¤€ í”Œë«í¼ìœ¼ë¡œ êµ³íˆë©´ ëœë‹¤.</p>

<p class="chat--user">

ì•„ë‹ˆ mcp ì„œë²„ëŠ” ê·¸ëŒ€ë¡œ ë„˜ê¸¸ê±°ì•¼ íˆ´ë¡œ ë‚´ê°€ ë˜í•‘ ì•ˆí• ê±°ì•¼

</p>

<p>ì¢‹ì•„. â€œMCP ì„œë²„ëŠ” ê·¸ëŒ€ë¡œ ë„˜ê¸´ë‹¤(íˆ´ë¡œ ë˜í•‘ ì•ˆ í•¨)â€ë¥¼ ì „ì œë¡œ, ì—¬ëŸ¬ ê°œ(3ê°œ ì´ìƒ) MCPë¥¼ í•œêº¼ë²ˆì— ë‹¤ë£¨ëŠ” í†µì¼ ì •ë³´ í´ë˜ìŠ¤ì™€ ê° ì—ì´ì „íŠ¸ë³„ ì–‡ì€ ì–´ëŒ‘í„°ë¥¼ ë§Œë“¤ì–´ì¤„ê²Œ. í•µì‹¬ì€ íˆ´ ë ˆë²¨ ë˜í•‘ì´ ì•„ë‹ˆë¼, MCP ì„œë²„ ë©”íƒ€(ì—°ê²° ë°©ì‹Â·ìê²©ì¦ëª…Â·ë„¤ì„ë¼ë²¨)ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ëŠ” ê²ƒì´ë‹¤.</p>

<p>ì•„ë˜ ìŠ¤ìºí´ë”©ì€ ì„¸ íŒŒíŠ¸ë‹¤.</p>

<ol>
  <li>
    <p>UnifiedMCPConfig: MCP ì„œë²„ ì •ë³´ë¥¼ í†µì¼ëœ í¬ë§·ìœ¼ë¡œ ë³´ê´€Â·ê²€ì¦.</p>
  </li>
  <li>
    <p>Adapters: ì´ ì •ë³´ë¥¼ ê° ì—ì´ì „íŠ¸ SDKì— ë§ê²Œ ê·¸ëŒ€ë¡œ íˆ¬ì‚¬.<br />
2-1) OpenAI Agents Python SDKìš© ì–´ëŒ‘í„°<br />
2-2) Anthropic Messages API(MCP connector)ìš© ì–´ëŒ‘í„°<br />
2-3) MCP ë¯¸ì§€ì› í”„ë ˆì„ì›Œí¬ìš© â€œí”„ë¡œí† ì½œ ìœ ì§€â€ ëŒ€ì•ˆ: í•©ì„± í”„ë¡ì‹œ ì„œë²„(ì„ íƒ). íˆ´ë¡œ ê°ì‹¸ì§€ ì•Šê³ , í•˜ë‚˜ì˜ MCP ì„œë²„ë¡œ í”„ë¡ì‹œ ì œê³µ.</p>
  </li>
</ol>

<p>ì¶”ê°€ë¡œ 3ê°œ ì´ìƒ ì„œë²„ì¼ ë•Œì˜ ìˆ˜ëª…ì£¼ê¸°, ë™ì‹œì„±, ê³µìœ  ì „ëµê¹Œì§€ í¬í•¨í–ˆë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install mcp pydantic orjson "openai-agents[litellm]" requests</p>

<p>unified_mcp_pass_through.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">HttpUrl</span><span class="p">,</span> <span class="n">field_validator</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># 1) í†µì¼ í¬ë§·: MCP ì„œë²„ ì •ë³´ë¥¼ â€œê·¸ëŒ€ë¡œâ€ ë‹´ì•„ ì—ì´ì „íŠ¸ë¡œ ì „ë‹¬í•˜ê¸° ìœ„í•œ ëª¨ë¸
</span>
<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># í•„ìš”ì‹œ í™•ì¥
</span>
<span class="k">class</span> <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì—ì´ì „íŠ¸ì—ì„œ ë³´ì¼ ì„œë²„ ë¼ë²¨(ë„¤ì„ìŠ¤í˜ì´ìŠ¤)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># ê³µí†µ ì˜µì…˜
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span>
    <span class="n">cache_tools_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">non_empty</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">name must be non-empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="k">class</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UnifiedMCPServer</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">dup</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate server names: </span><span class="si">{</span><span class="n">dup</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">no MCP servers provided</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># ìµœì†Œ ê°€ë“œ: stdioë©´ command í•„ìˆ˜, sseë©´ url í•„ìˆ˜
</span>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2) ì–´ëŒ‘í„°ë“¤
# 2-1) OpenAI Agents Python SDK ì–´ëŒ‘í„°: ê·¸ëŒ€ë¡œ mcp_serversì— ê½‚ëŠ” íŒ©í† ë¦¬
</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span><span class="p">,</span> <span class="n">MCPServerStreamableHttp</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>

<span class="k">class</span> <span class="nc">OpenAIAgentsMCPAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">build_context_managers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">cms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerStdio</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">env</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerSse</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                    <span class="n">require_approval</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">require_approval</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">cms</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">MCPServerStreamableHttp</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">},</span>
                    <span class="n">cache_tools_list</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">cache_tools_list</span><span class="p">,</span>
                    <span class="n">max_concurrency</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">max_concurrency</span><span class="p">,</span>
                    <span class="n">request_timeout_sec</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">request_timeout_sec</span><span class="p">,</span>
                    <span class="n">require_approval</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">require_approval</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cms</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">cms</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">build_context_managers</span><span class="p">()</span>
        <span class="c1"># ì—¬ëŸ¬ context managerë¥¼ í•œ ë²ˆì— ì—´ê¸°
</span>        <span class="k">async</span> <span class="k">with</span> <span class="nc">AsyncExitStackGroup</span><span class="p">(</span><span class="n">cms</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">PassThroughMCPAgent</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP ì„œë²„ì˜ íˆ´ì„ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">mcp_servers</span><span class="o">=</span><span class="n">opened</span><span class="p">,</span>                             <span class="c1"># í¬ì¸íŠ¸: ì„œë²„ë¥¼ 'ê·¸ëŒ€ë¡œ' ë„˜ê¹€
</span>                <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span>

<span class="c1"># ì—¬ëŸ¬ async context managerë¥¼ ë¬¶ì–´ ì—¬ë‹«ëŠ” ìœ í‹¸
</span><span class="k">class</span> <span class="nc">AsyncExitStackGroup</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cms</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cms</span> <span class="o">=</span> <span class="n">cms</span>
        <span class="n">self</span><span class="p">.</span><span class="n">opened</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">opened</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aenter__</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">opened</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="c1"># ì—­ìˆœìœ¼ë¡œ ì•ˆì „ ì¢…ë£Œ
</span>        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="nf">reversed</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cms</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">cm</span><span class="p">.</span><span class="nf">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c1"># 2-2) Anthropic Messages API(MCP connector) ì–´ëŒ‘í„°: payloadë§Œ ë§Œë“¤ì–´ ë°˜í™˜
# ì£¼ì˜: ì—¬ê¸°ì„œëŠ” ì‹¤ì œ í˜¸ì¶œê¹Œì§€ í•˜ì§€ ì•Šê³ , mcp_servers JSONì„ ë§Œë“¤ì–´ ëŒë ¤ì¤€ë‹¤.
# ë„ˆëŠ” ì´ JSONì„ ë°”ë¡œ API ë°”ë””ì— ë„£ìœ¼ë©´ ëœë‹¤.
</span>
<span class="k">class</span> <span class="nc">AnthropicMCPAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">to_messages_payload</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">mcp_servers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="c1"># Anthropic ì»¤ë„¥í„°ëŠ” ì›ê²©ë§Œ ì§ì ‘ ë¶™ì´ëŠ” íŒ¨í„´ì´ ì¼ë°˜ì ì´ë¯€ë¡œ, stdioëŠ” ë³´í†µ ë¶ˆê°€.
</span>                <span class="c1"># í•„ìš”í•˜ë©´ ë„ˆì˜ ì„œë²„ë¥¼ HTTPë¡œ ë…¸ì¶œí•´ì•¼ í•œë‹¤.
</span>                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: Anthropic payloadëŠ” stdioë¥¼ ì§ì ‘ ì „ë‹¬í•  ìˆ˜ ì—†ë‹¤. HTTP/SSEë¡œ ì „í™˜ í•„ìš”</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mcp_servers</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">authorization_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">tool_configuration</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">enabled</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_text</span><span class="p">}],</span>
            <span class="sh">"</span><span class="s">mcp_servers</span><span class="sh">"</span><span class="p">:</span> <span class="n">mcp_servers</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c1"># 2-3) MCP ë¯¸ì§€ì› í”„ë ˆì„ì›Œí¬ë¥¼ ìœ„í•œ â€œí”„ë¡œí† ì½œ ìœ ì§€â€ ëŒ€ì•ˆ: í•©ì„± í”„ë¡ì‹œ(ì„ íƒ)
# íˆ´ ë˜í•‘ ì—†ì´, ì—¬ëŸ¬ ìƒë¥˜ MCPë¥¼ í•˜ë‚˜ì˜ 'ê°€ì§œ MCP ì„œë²„'ë¡œ ë…¸ì¶œ.
# ì—ì´ì „íŠ¸ëŠ” MCP í•œ ëŒ€ë§Œ ë³¸ë‹¤. ë‚´ë¶€ì—ì„œ list_tools/ call_toolë¥¼ ì„œë²„ë³„ë¡œ í”„ë¡ì‹œ.
# ê°„ë‹¨ ë²„ì „(ê°œë… ì½”ë“œ): ì‹¤ì œ MCP ì„œë²„ ìŠ¤í™ì— ë§ì¶˜ ì™„ì„± ì„œë²„ëŠ” ë³„ë„ êµ¬í˜„ í•„ìš”.
</span>
<span class="k">class</span> <span class="nc">CompositeMCPProxy</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì•„ì´ë””ì–´: upstream ì—¬ëŸ¬ MCP ì„¸ì…˜ì— ë¶™ì–´, ì™¸ë¶€ì—ëŠ” ë‹¨ì¼ MCP ì„œë²„ì²˜ëŸ¼ ë™ì‘.
    - list_tools: ëª¨ë“  upstreamì—ì„œ íˆ´ì„ ê¸ì–´ namespaced ì´ë¦„(server:tool)ìœ¼ë¡œ í•©ì³ ë°˜í™˜
    - call_tool: </span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">ì„ íŒŒì‹±í•´ í•´ë‹¹ upstreamì— ìœ„ì„
    ì´ í´ë˜ìŠ¤ ìì²´ëŠ” í”„ë¡œí† ì½œ ì²˜ë¦¬(transport)ëŠ” ìƒëµí•˜ê³ , ì½œë°± í˜•íƒœë§Œ ì œê³µ.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">UnifiedMCPConfig</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># upstream ì—°ê²°ë§Œ ë‹´ë‹¹(í”„ë¡ì‹œ ì„œë²„ë¡œ ê³µê°œí•˜ë ¤ë©´ ë³„ë„ transport/ì„œë²„ êµ¬í˜„ í•„ìš”)
</span>        <span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
        <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
            <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse í•„ìš”</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># í•„ìš”í•˜ë©´ streamable-http ë“± ì¶”ê°€
</span>                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unsupported kind for proxy: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">tr</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">sess</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_all_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">server</span><span class="p">][</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">packed</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

<span class="c1"># 3) ì‚¬ìš© ì˜ˆì‹œ
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">demo_openai_agents</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">servers</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span>  <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}),</span>
    <span class="p">])</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="nc">OpenAIAgentsMCPAdapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="p">.</span><span class="nf">run_once</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="sh">"</span><span class="s">filesì™€ db, search MCPë¥¼ ì ì ˆíˆ ì‚¬ìš©í•´ sales.csvì˜ í†µì°°ì„ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">demo_anthropic_payload</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="nc">UnifiedMCPConfig</span><span class="p">(</span><span class="n">servers</span><span class="o">=</span><span class="p">[</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}),</span>
        <span class="nc">UnifiedMCPServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">git</span><span class="sh">"</span><span class="p">,</span>    <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://mcp.git.example/sse</span><span class="sh">"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer Y</span><span class="sh">"</span><span class="p">}),</span>
    <span class="p">])</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="nc">AnthropicMCPAdapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">).</span><span class="nf">to_messages_payload</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">claude-3-7-sonnet</span><span class="sh">"</span><span class="p">,</span> <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">ë‘ MCPë¥¼ í™œìš©í•´ì„œ ë¦¬í¬íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="n">OPT_INDENT_2</span><span class="p">).</span><span class="nf">decode</span><span class="p">())</span>

<span class="c1"># ë©”ì¸
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">asyncio</span>
    <span class="kn">from</span> <span class="n">contextlib</span> <span class="kn">import</span> <span class="n">suppress</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">demo_openai_agents</span><span class="p">())</span>
    <span class="k">with</span> <span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
        <span class="nf">demo_anthropic_payload</span><span class="p">()</span>
</code></pre></div></div>

<p>ì–´ë–»ê²Œ ì“°ë©´ ë˜ë‚˜ ë‹¨ê³„ë³„ ìš”ì•½</p>

<ol>
  <li>
    <p>UnifiedMCPConfigì— 3ê°œ ì´ìƒ MCP ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë‚˜ì—´í•œë‹¤. stdioë©´ command/args, sseë©´ url/headersë§Œ ì±„ìš°ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>OpenAI Agentsë¥¼ ì“¸ ë•ŒëŠ” OpenAIAgentsMCPAdapterë¡œ context managerë“¤ì„ ë§Œë“¤ì–´ Agent(mcp_servers=[â€¦])ì— ê½‚ëŠ”ë‹¤. ì´ íë¦„ì€ MCP íˆ´ì„ â€œë˜í•‘í•˜ì§€ ì•Šê³ â€ ì„œë²„ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•œë‹¤.</p>
  </li>
  <li>
    <p>Anthropic Messages APIë¥¼ ì“¸ ë•ŒëŠ” AnthropicMCPAdapterê°€ messages.create ë°”ë””ì— ë„£ì„ mcp_servers JSONì„ ìƒì„±í•´ì¤€ë‹¤. stdioëŠ” ì›ê²© ê³µê°œê°€ ì•„ë‹ˆë©´ ë°”ë¡œ ë¶™ì¼ ìˆ˜ ì—†ìœ¼ë‹ˆ SSE/HTTPë¡œ ë…¸ì¶œí•´ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>MCP ë¯¸ì§€ì› í”„ë ˆì„ì›Œí¬ì—ëŠ” CompositeMCPProxy ê°™ì€ ë°©ì‹ìœ¼ë¡œ â€œMCP í”„ë¡œí† ì½œì€ ìœ ì§€â€í•œ ì±„ í•©ì„± ì„œë²„ë¥¼ í•˜ë‚˜ ë„ìš°ëŠ” ì„ íƒì§€ê°€ ìˆë‹¤. ì´ê±´ íˆ´ ë˜í•‘ì´ ì•„ë‹ˆë¼ â€œMCP ì„œë²„ë¥¼ í•˜ë‚˜ ë” ì œê³µâ€í•˜ëŠ” ë°©ì‹ì´ë¼ ë„¤ ì¡°ê±´ê³¼ ì–´ê¸‹ë‚˜ì§€ ì•ŠëŠ”ë‹¤.</p>
  </li>
</ol>

<p>3ê°œ ì´ìƒ ì„œë²„ì—ì„œì˜ ì‹¤ë¬´ ì²´í¬<br />
íˆ´ ê³¼ì ì¬ ë°©ì§€. Agentì— ë„˜ê¸¸ ë•Œ ì„œë²„ë¥¼ ì „ë¶€ ì£¼ë˜, ëª¨ë¸ í”„ë¡¬í”„íŠ¸ì— â€œì´ëŸ° ì‘ì—…ì—ëŠ” filesë§Œ, ìš”ì•½ì€ dbë§Œâ€ ê°™ì€ ì§€ì¹¨ì„ í•œ ì¤„ ë„£ëŠ” ê²ƒë§Œìœ¼ë¡œë„ í˜¼ì„ ì´ ì¤„ì–´ë“ ë‹¤.<br />
ì„¸ì…˜/ìì› ê´€ë¦¬. OpenAI Agents ì–´ëŒ‘í„°ëŠ” context managerê°€ ì¢…ë£Œ ì‹œ ìë™ ì •ë¦¬ë¥¼ ìˆ˜í–‰í•œë‹¤. Anthropic ê²½ë¡œëŠ” ì›ê²© ì„œë²„ì´ë¯€ë¡œ ë³„ë„ ì„¸ì…˜ ì •ë¦¬ëŠ” í•„ìš” ì—†ë‹¤.<br />
ê¶Œí•œ ê²½ê³„. ì„œë¡œ ë‹¤ë¥¸ í…Œë„ŒíŠ¸ë‚˜ ìœ„í—˜ë„ë¥¼ ê°€ì§„ MCPëŠ” ì„œë²„ ë¼ë²¨ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ê³ , require_approval ì˜µì…˜ì„ â€œalways/autoâ€ë¡œ ë‘”ë‹¤(Hosted/ì›ê²©ì—ì„œ ì˜ë¯¸ ìˆìŒ).<br />
ë™ì‹œì„±Â·íƒ€ì„ì•„ì›ƒ. ì„œë²„ë³„ max_concurrency, request_timeout_secë¥¼ ë‹¤ë¥´ê²Œ ì£¼ì–´ ë³‘ëª©ì„ í”¼í•œë‹¤.</p>

<p>ì´ êµ¬ì„±ì€ â€œMCP ì„œë²„ ì •ë³´ë¥¼ ìˆëŠ” ê·¸ëŒ€ë¡œ ë„˜ê¸´ë‹¤â€ëŠ” ì›ì¹™ì„ ì§€í‚¤ë©´ì„œ, ì„œë¡œ ë‹¤ë¥¸ ì—ì´ì „íŠ¸ë“¤ì— ê°™ì€ ì •ë³´ë¥¼ ì¬ì‚¬ìš©í•˜ë„ë¡ í•´ì¤€ë‹¤. í•„ìš”í•œ í”„ë ˆì„ì›Œí¬ê°€ ë” ìˆìœ¼ë©´ ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ì–´ëŒ‘í„°ë¥¼ 20~30ì¤„ë¡œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p class="chat--user">

ê·¼ë° MCPë¥¼ ë³´ë‹ˆ ê·¸ëƒ¥ íˆ´ë§Œ ìˆëŠ”ê²Œ ì•„ë‹ˆë¼ Sampling, ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸°, í”„ë¡¬í”„íŠ¸ ë“±ë“± ìˆì–ì•„. ê·¸ê±¸ Chatì´ë‘ ì—°ë™í•  ìˆ˜ ìˆì„ê¹Œ

</p>

<p>ì¢‹ì•„, í•µì‹¬ì€ â€œMCPê°€ ì œê³µí•˜ëŠ” ê±´ íˆ´ë§Œì´ ì•„ë‹ˆë‹¤â€ëŠ” ì ì„ ì „ì œë¡œ, Sampling(ì„œë²„ê°€ ëª¨ë¸ í˜¸ì¶œì„ ìœ„ì„), ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸°(ask-user), í”„ë¡¬í”„íŠ¸/í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿(list/get) ê°™ì€ ì±„ë„ì„ Chat ë£¨í”„ì— ë¶™ì´ëŠ” ì–‡ì€ ì–´ëŒ‘í„° ë ˆì´ì–´ë¥¼ ì—¬ê¸°ì— ë”± ë§Œë“¤ì–´ë‘ëŠ” ê±°ë‹¤. ë˜í•‘ìœ¼ë¡œ íˆ´ë¡œ ë°”ê¾¸ì§€ ì•Šê³ , MCP ë©”íƒ€(í”„ë¡¬í”„íŠ¸/ìƒ˜í”Œë§/ì§ˆì˜)ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬Â·ì™•ë³µì‹œì¼œ ê²°í•©í•œë‹¤.</p>

<p>ì•„ë˜ ì„¤ê³„ì™€ ìŠ¤ìºí´ë”©ì€ ì´ì „ì— ë§Œë“  â€œë°±ì—”ë“œ ê°ˆì•„ë¼ìš°ê¸°(Chat Completions or OpenAI Agents)â€ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©´ì„œ, MCPì˜ ë„¤ ê°€ì§€ ë©´ì„ ëª¨ë‘ ì—°ë™í•œë‹¤.</p>

<ol>
  <li>
    <p>íˆ´: ê¸°ì¡´ê³¼ ë™ì¼, call_tool ë¼ìš°íŒ…</p>
  </li>
  <li>
    <p>í”„ë¡¬í”„íŠ¸: list_prompts/get_promptë¥¼ í†µí•´ ì‹œìŠ¤í…œ/ë„ìš°ë¯¸ ë©”ì‹œì§€ ì£¼ì…</p>
  </li>
  <li>
    <p>ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸°: MCPê°€ ì‚¬ìš©ì ì…ë ¥ì„ ìš”ì²­í•˜ë©´, Chat UIì— ì§ˆë¬¸ì„ ë„ìš°ê³  ë‹µì„ ë‹¤ì‹œ MCPì— ëŒë ¤ì¤Œ</p>
  </li>
  <li>
    <p>ìƒ˜í”Œë§: MCP ì„œë²„ê°€ â€œëª¨ë¸ í˜¸ì¶œì„ ëŒ€ì‹  í•´ë‹¬ë¼â€ê³  ìš”ì²­í•˜ë©´, í˜„ì¬ ë°±ì—”ë“œë¡œ ëŒ€ë¦¬ ìƒ˜í”Œë§ í›„ ê²°ê³¼ë¥¼ MCPì—ê²Œ ë°˜í™˜</p>
  </li>
</ol>

<p>ì•„ë˜ëŠ” ê·¸ëŒ€ë¡œ ë¶™ì´ëŠ” ìµœì†Œ ìŠ¤ìºí´ë”©ì´ë‹¤. MCP SDKì˜ ì¼ë¶€ APIëŠ” ì„œë²„ êµ¬í˜„/ë²„ì „ì— ë”°ë¼ ì°¨ì´ê°€ ìˆì–´ì„œ, í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ë¥¼ ë™ì ìœ¼ë¡œ ì²´í¬í•˜ë„ë¡ ë°©ì–´ì½”ë“œë¥¼ ë„£ì—ˆë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install mcp pydantic orjson requests "openai-agents[litellm]"</p>

<p>mcp_chat_bridge.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">################################################################################
# ê³µí†µ: Chat ë°±ì—”ë“œ(ë‘ ê°€ì§€ êµ¬í˜„: OpenAI í˜¸í™˜ Chat Completions, OpenAI Agents)
################################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">OpenAIChatBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span> <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">tools</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span><span class="p">;</span> <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

<span class="c1"># ì„ íƒ: OpenAI Agentsë¥¼ ë°±ì—”ë“œë¡œ ì“°ê³  ì‹¶ë‹¤ë©´ ì´ ì–´ëŒ‘í„°ë¥¼ ì‚¬ìš©
</span><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">FunctionTool</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">))</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># ë„êµ¬ëŠ” Agentì— ë“±ë¡í•˜ì§€ ì•Šê³ , í”„ë¡¬í”„íŠ¸ ê°•ì œ í¬ë§·ìœ¼ë¡œ tool_callsë¥¼ JSONìœ¼ë¡œ ë°›ëŠ” ì „ëµë„ ê°€ëŠ¥
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">ê°€ëŠ¥í•˜ë©´ JSONë§Œ ì¶œë ¥</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">txt</span><span class="p">}}]}</span>

<span class="c1">################################################################################
# MCP ì—°ê²°: ì—¬ëŸ¬ ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì´ê³ , í”„ë¡¬í”„íŠ¸/ìƒ˜í”Œë§/ì§ˆë¬¸ì„ ë¸Œë¦¿ì§€
################################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span> <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆ í•„ìš”</span><span class="sh">"</span><span class="p">)</span>
        <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>

<span class="c1">################################################################################
# ë¸Œë¦¿ì§€: MCPì˜ íˆ´/í”„ë¡¬í”„íŠ¸/ask-user/ìƒ˜í”Œë§ì„ Chat ë£¨í”„ì— ì ‘ì†
################################################################################
</span>
<span class="k">class</span> <span class="nc">MCPChatBridge</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span>
        <span class="n">chat_backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span>
        <span class="n">ask_user</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>     <span class="c1"># ì‚¬ìš©ìì—ê²Œ ì§ˆë¬¸ ë³´ì—¬ì£¼ê³  ì‘ë‹µ ë°›ëŠ” ì½œë°±
</span>        <span class="n">prompt_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">sampling_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c1"># ìƒ˜í”Œë§ ì˜µì…˜ ì •ê·œí™”
</span>    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">chat_backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ask_user</span> <span class="o">=</span> <span class="n">ask_user</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prompt_selector</span> <span class="o">=</span> <span class="n">prompt_selector</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sampling_policy</span> <span class="o">=</span> <span class="n">sampling_policy</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">opts</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)})</span>

        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MCPHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cfgs</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="k">return</span> <span class="n">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_list_all_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                    <span class="p">}</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_collect_prompts</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]:</span>
        <span class="c1"># ì„œë²„ë³„ í”„ë¡¬í”„íŠ¸ ëª©ë¡ ì·¨í•©. ì„¸ì…˜ì— list_prompts/get_prompt ê°€ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€.
</span>        <span class="n">collected</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">list_prompts</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">list_prompts</span><span class="sh">"</span><span class="p">)()</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># ê° í•­ëª©ë§ˆë‹¤ get_prompt(name)ë¡œ í…œí”Œë¦¿/ë©”ì‹œì§€ êµ¬ì„± ìš”ì†Œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤ëŠ” ê°€ì •(ì„œë²„ êµ¬í˜„ë§ˆë‹¤ ìƒì´)
</span>                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">prompts</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)})</span>
                    <span class="n">collected</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">collected</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_get_prompt_messages</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">server</span><span class="p">]</span>
        <span class="n">msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_prompt</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_prompt</span><span class="sh">"</span><span class="p">)(</span><span class="n">prompt_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># respê°€ messages ë¹„ìŠ·í•œ êµ¬ì¡°ë¼ê³  ê°€ì •í•˜ê³  í‘œì¤€í™”
</span>                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">msgs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">))</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">msgs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_server_sampling</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        MCP ì„œë²„ê°€ </span><span class="sh">'</span><span class="s">ìƒ˜í”Œë§ ìš”êµ¬</span><span class="sh">'</span><span class="s">ë¥¼ ë³´ë‚´ëŠ” ìƒí™©ì„ ê°€ì •.
        request = {</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">:[...], </span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="s">:{...}} ê°™ì€ í˜•íƒœë¥¼ ì •ì±…ì— ë§ì¶° ë°±ì—”ë“œì— ëŒ€ë¦¬ í˜¸ì¶œ
        </span><span class="sh">"""</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">sampling_policy</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="c1"># request["messages"]ëŠ” OpenAI í¬ë§·ì„ ê°€ì •í•˜ê³  ê·¸ëŒ€ë¡œ ì „ë‹¬
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">([</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="o">**</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])],</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1"># í•„ìš”í•˜ë©´ ì˜¨ì „í•œ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ ëŒë ¤ì£¼ê±°ë‚˜, í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
</span>        <span class="n">content</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span> <span class="sh">"</span><span class="s">raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 1) ì„œë²„ë³„ í”„ë¡¬í”„íŠ¸ ëª©ë¡ì„ ëª¨ì•„ì„œ ì„ íƒ
</span>        <span class="n">base_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">)]</span>
        <span class="n">prompt_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_collect_prompts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prompt_selector</span><span class="p">:</span>
            <span class="c1"># prompt_selectorëŠ” {server:[{name,desc},...]}ë¥¼ ë³´ê³  ì´ˆê¸° ë©”ì‹œì§€(ì˜ˆ: system í”„ë¡¬í”„íŠ¸ë“¤) ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜
</span>            <span class="n">injected</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prompt_selector</span><span class="p">(</span><span class="n">prompt_catalog</span><span class="p">)</span>
            <span class="n">base_messages</span> <span class="o">=</span> <span class="n">injected</span> <span class="o">+</span> <span class="n">base_messages</span>

        <span class="c1"># 2) MCP íˆ´ë“¤ì„ OpenAI tools í¬ë§·ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ë„˜ê¹€
</span>        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_list_all_tools</span><span class="p">()</span>

        <span class="c1"># 3) 1ì°¨ ëª¨ë¸ í˜¸ì¶œ
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">base_messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
        <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)))</span>

        <span class="c1"># 4) tool_calls ì²˜ë¦¬ ë£¨í”„ + ask-user + server-sampling í›… ì˜ˆì‹œ
</span>        <span class="c1"># ì‹¤ì œ ask/sampling ì´ë²¤íŠ¸ëŠ” ì„œë²„ê°€ ë³„ë„ íˆ´ë¡œ ë…¸ì¶œí•˜ê±°ë‚˜, resource/protocol í•„ë“œë¥¼ í†µí•´ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆë‹¤.
</span>        <span class="c1"># ì—¬ê¸°ì„œëŠ” ê´€ìŠµì ìœ¼ë¡œ ì´ë¦„ì„ ì¡ì•„ ì˜ˆì‹œë¥¼ ë³´ì¸ë‹¤.
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">tool_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># e.g., "files:read_csv" or "db:sql_summary" or "search:ask_user" ë“±
</span>                <span class="n">args_raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

                <span class="c1"># 4-a) ask-user íŒ¨í„´: íŠ¹ì • ì„œë²„ê°€ ì‚¬ìš©ì ì…ë ¥ì„ ë°›ì•„ë‹¬ë¼ê³  í•˜ëŠ” íˆ´ì„ ì œê³µí•œë‹¤ê³  ê°€ì •
</span>                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">:ask_user</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">ask.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">question</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì…ë ¥í•´ ì£¼ì„¸ìš”.</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">user_answer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">answer</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_answer</span><span class="p">})</span>
                    <span class="p">})</span>
                    <span class="k">continue</span>

                <span class="c1"># 4-b) server-side sampling: ì„œë²„ê°€ ëª¨ë¸ í˜¸ì¶œì„ ìœ„ì„í•˜ëŠ” íˆ´(ì˜ˆ: server:sample)ë¡œ êµ¬í˜„ë¼ ìˆë‹¤ê³  ê°€ì •
</span>                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">:sample</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">sample.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{}})</span>
                    <span class="n">sampling_out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_maybe_server_sampling</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">sampling_out</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="k">continue</span>

                <span class="c1"># 4-c) ì¼ë°˜ MCP íˆ´ í˜¸ì¶œ
</span>                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">namespaced tool required</span><span class="sh">"</span><span class="p">})})</span>
                    <span class="k">continue</span>
                <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">handles</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">unknown server</span><span class="sh">"</span><span class="p">})})</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">h</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                    <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[]}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()})</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})})</span>

            <span class="c1"># 4-d) íˆ´ ê²°ê³¼ ì¬ì£¼ì…
</span>            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">tool_results</span><span class="p">:</span>
                <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">tr</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]))</span>
                <span class="c1"># ì¼ë¶€ ë°±ì—”ë“œ/ëª¨ë¸ì€ tool ë©”ì‹œì§€ì— name/tool_call_idë¥¼ ìš”êµ¬í•˜ë¯€ë¡œ,
</span>                <span class="c1"># OpenAIChatBackendë¥¼ ì§ì ‘ ì‚¬ìš©í•  ë•ŒëŠ” messagesì— dict ê·¸ëŒ€ë¡œ ë„£ëŠ” ê²½ë¡œë¥¼ ë”°ë¡œ ë‘ì–´ë„ ëœë‹¤.
</span>
            <span class="c1"># 4-e) ë‹¤ìŒ í„´ í˜¸ì¶œ
</span>            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">base_messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
            <span class="n">base_messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)))</span>

        <span class="c1"># 5) ìµœì¢… ë‹µë³€
</span>        <span class="k">return</span> <span class="n">base_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span>
</code></pre></div></div>

<p>ì–´ë–»ê²Œ ì“°ëŠ”ê°€ ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">ui_ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[QUESTION from MCP] </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># ì‹¤ì œ ì•±/UIì—ì„œëŠ” ëª¨ë‹¬Â·ì…ë ¥ì°½ìœ¼ë¡œ êµ¬í˜„
</span>    <span class="k">return</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">pick_prompts</span><span class="p">(</span><span class="n">prompt_catalog</span><span class="p">):</span>
    <span class="c1"># prompt_catalog: {server: [{name,description}, ...]}
</span>    <span class="c1"># ê°„ë‹¨ ì˜ˆì‹œ: files ì„œë²„ì— "analysis_default" í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì™€ systemì— ì‚½ì…
</span>    <span class="c1"># ì‹¤ì œë¡œëŠ” bridge._get_prompt_messages(server, prompt_name)ë¡œ ë©”ì‹œì§€ë¥¼ ë°›ì•„ prepend
</span>    <span class="k">return</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">ë„ˆëŠ” ì¡°ì‹¬ìŠ¤ëŸ½ê³  ì •í™•í•œ ë¶„ì„ê°€ë‹¤.</span><span class="sh">"</span><span class="p">)]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">]</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAIChatBackend</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPChatBridge</span><span class="p">(</span><span class="n">servers</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">ask_user</span><span class="o">=</span><span class="n">ui_ask_user</span><span class="p">,</span> <span class="n">prompt_selector</span><span class="o">=</span><span class="n">pick_prompts</span><span class="p">)</span> <span class="k">as</span> <span class="n">bridge</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bridge</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sh">"</span><span class="s">sales.csvë¥¼ ë¶„ì„í•˜ê³ , í•„ìš”í•œ ì¶”ê°€ ì •ë³´ê°€ ìˆìœ¼ë©´ ë¨¼ì € ë‚˜ì—ê²Œ ì§ˆë¬¸í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ANSWER ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸ ìš”ì•½<br />
ìƒ˜í”Œë§. ì„œë²„ê°€ â€œëª¨ë¸ í˜¸ì¶œì„ ëŒ€ë¦¬í•´ë‹¬ë¼â€ ìš”ì²­í•˜ë©´, í˜„ì¬ ì—°ê²°ëœ Chat ë°±ì—”ë“œë¡œ ê·¸ëŒ€ë¡œ ë¼ìš°íŒ…í•´ ê²°ê³¼ë¥¼ ëŒë ¤ì¤€ë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì„œë²„-ì£¼ë„ í”Œë¡œìš°ê¹Œì§€ ì—°ë™ëœë‹¤.<br />
ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸°. MCPê°€ ì‚¬ìš©ì ì…ë ¥ì´ í•„ìš”í•  ë•Œë¥¼ íˆ´ í˜¹ì€ ë³„ë„ ì‹œê·¸ë„ë¡œ ë…¸ì¶œí•˜ëŠ” íŒ¨í„´ì„ ì¡ê³ , ask_user ì½œë°±ìœ¼ë¡œ Chat UIì™€ ì™•ë³µí•œë‹¤. ëŸ¬ë„ˆë¥¼ ë‘ë”ë¼ë„ ë¡œì§ì€ ì½œë°± í•œ ì¤„ì´ë‹¤.<br />
í”„ë¡¬í”„íŠ¸. ì„œë²„ë³„ í”„ë¡¬í”„íŠ¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì¡°íšŒ(list/get)í•´ì„œ ì´ˆê¸° system ë©”ì‹œì§€ë¡œ ì£¼ì…í•œë‹¤. í”„ë¡¬í”„íŠ¸ê°€ íŒŒë¼ë¯¸í„°í™”ë˜ì–´ ìˆë‹¤ë©´ get_prompt(name, **kwargs) ì‹ìœ¼ë¡œ ë°›ì•„ ë©”ì‹œì§€ë¡œ ë³€í™˜í•œë‹¤.<br />
í˜¸í™˜ì„±. ê°™ì€ ë¸Œë¦¿ì§€ë¥¼ OpenAI Chat Completions, OpenAI Agents ì–´ëŠ ìª½ì—ë„ ê½‚ì„ ìˆ˜ ìˆë‹¤. Agentsë¥¼ ë°±ì—”ë“œë¡œ ì“¸ ë• JSON ê°•ì œ ì¶œë ¥ ê°™ì€ í”„ë¡¬í”„íŠ¸ ì „ëµì„ ì¨ë„ ë˜ê³ , í•„ìš”í•˜ë©´ Agentsì˜ FunctionToolì„ ë³‘í–‰í•´ì„œ ask-userë‚˜ samplingì„ ëª…ì‹œ íˆ´ë¡œ ë…¸ì¶œí•˜ëŠ” í•˜ì´ë¸Œë¦¬ë“œë„ ê°€ëŠ¥í•˜ë‹¤.<br />
3ê°œ ì´ìƒ ì„œë²„. ì„œë²„ ìˆ˜ì— ìƒê´€ì—†ì´ namespacing(server:tool) ë£°ì„ ìœ ì§€í•˜ê³ , í”„ë¡¬í”„íŠ¸Â·ì§ˆë¬¸Â·ìƒ˜í”Œë§ì€ ì„œë²„ ë¼ë²¨ê³¼ í•¨ê»˜ ë¡œê¹…í•´ ì¶”ì  ê°€ëŠ¥ì„±ì„ ë†’ì¸ë‹¤. ì„œë²„ë³„ íƒ€ì„ì•„ì›ƒ/ë™ì‹œì„±ì€ handle ë‹¨ì—ì„œ ê°œë³„ íŠœë‹í•˜ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.</p>

<p>ì´ë ‡ê²Œ í•˜ë©´ â€œíˆ´ë¡œ ë˜í•‘í•˜ì§€ ì•Šê³ â€ë„ MCPì˜ ë„“ì€ í‘œë©´ì (íˆ´Â·í”„ë¡¬í”„íŠ¸Â·ìƒ˜í”Œë§Â·ìœ ì €ì§ˆë¬¸)ì„ ë™ì¼ Chat ê²½í—˜ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì¼ ìˆ˜ ìˆë‹¤. ì‹¤ì œ ë„¤ ì„œë²„ì—ì„œ í”„ë¡¬í”„íŠ¸/ìƒ˜í”Œë§/askê°€ ì–´ë–¤ ì—”ë“œí¬ì¸íŠ¸/ì´ë²¤íŠ¸ë¡œ ë…¸ì¶œë˜ëŠ”ì§€ ì•Œë ¤ì£¼ë©´, ìœ„ ë¸Œë¦¿ì§€ì˜ í•´ë‹¹ í•¨ìˆ˜ë§Œ ë„ˆì˜ ìŠ¤í™ì— ë”± ë§ê²Œ êµ¬ì²´í™”í•´ ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì•„ë‹ˆ Elicitationì´ë¼ê³  ë”°ë¡œ ìˆëŠ”ë°

</p>

<p>ë§ì•„, MCPì—ëŠ” â€œElicitation(ì—˜ë¦¬ì‹œí…Œì´ì…˜)â€ì´ ë”°ë¡œ ìˆë‹¤. ìš”ì§€ëŠ” ì„œë²„ê°€ ì‘ì—… ë„ì¤‘ ì‚¬ìš©ìì—ê²Œ ì¶”ê°€ ì •ë³´ë¥¼ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ìš”ì²­í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê¸°ëŠ¥ì´ê³ , íˆ´ê³¼ëŠ” ë³„ê°œì˜ ì±„ë„ì´ë‹¤. ê²°ë¡ ë¶€í„° ë§í•˜ë©´ Chat ë£¨í”„ì— ê¹”ë”í•˜ê²Œ ì—°ë™í•  ìˆ˜ ìˆë‹¤. ì•„ë˜ì²˜ëŸ¼ â€œì§ˆë¬¸ ë¼ìš´ë“œíŠ¸ë¦½â€ì„ ë¸Œë¦¿ì§€ì— ë¼ìš°ë©´ ëœë‹¤. í•µì‹¬ í¬ì¸íŠ¸ì™€ ìµœì†Œ ì½”ë“œë¥¼ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•œë‹¤.</p>

<ol>
  <li>
    <p>ê°œë… ì •ë¦¬<br />
Elicitationì€ MCP ì„œë²„ê°€ ëŒ€í™” ë„ì¤‘ â€œì‚¬ìš©ìì—ê²Œ ì´ ì •ë³´ ì¢€ ë°›ì•„ì¤˜â€ë¼ê³  ìš”ì²­í•˜ëŠ” í‘œì¤€ ë©”ì»¤ë‹ˆì¦˜ì´ë‹¤. ìš”ì²­ì—ëŠ” í”„ë¡¬í”„íŠ¸ ë¬¸êµ¬ì™€ í•¨ê»˜ JSON ìŠ¤í‚¤ë§ˆê°€ ë”°ë¼ì˜¤ê³ , í´ë¼ì´ì–¸íŠ¸ëŠ” ê·¸ ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ì‚¬ìš©ì ì…ë ¥ì„ ë°›ì•„ ê²€ì¦í•œ ë’¤ ì„œë²„ì— ëŒë ¤ì¤€ë‹¤. 2025-06-18 ìŠ¤í™ì— ì •ì‹ í¬í•¨ë˜ì—ˆê³ , â€œíˆ´ ì‹¤í–‰ ì¤‘ê°„ì— ë¼ì–´ë“œëŠ” ì§ˆë¬¸â€ì„ ì•ˆì „í•˜ê³  êµ¬ì¡°í™”ëœ ë°©ì‹ìœ¼ë¡œ ë‹¤ë£¨ë ¤ëŠ” ëª©ì ì´ë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol+1</a></p>
  </li>
  <li>
    <p>ì•„í‚¤í…ì²˜ ì„ íƒì§€<br />
A. í”„ë¡œí† ì½œ-ë„¤ì´í‹°ë¸Œ ì²˜ë¦¬: MCP í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì˜ Elicitation ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ ìˆ˜ì‹ í•´ UIë¡œ ë„ìš°ê³  ì‘ë‹µì„ ì„œë²„ì— ëŒë ¤ì¤€ë‹¤. Chat ëª¨ë¸ì€ â€œìµœì¢… ë‹µë³€ ìƒì„±â€ì— ì§‘ì¤‘í•˜ê³ , ì¶”ê°€ ì •ë³´ ìˆ˜ì§‘ì€ ë¸Œë¦¿ì§€ê°€ ë‹´ë‹¹í•œë‹¤.<br />
B. ëª¨ë¸-ì¤‘ê°œ ì²˜ë¦¬: Elicitationì„ â€œask_userâ€ ê°™ì€ íˆ´ë¡œë„ ë…¸ì¶œí•˜ëŠ” ì„œë²„ê°€ ìˆë‹¤ë©´, ê¸°ì¡´ tool_call ë£¨í”„ì— ì„ì–´ ì²˜ë¦¬í•´ë„ ëœë‹¤. í•˜ì§€ë§Œ ê¶Œì¥ë˜ëŠ” ë°©ì‹ì€ ìŠ¤í™ì— ë§ì¶˜ ë„¤ì´í‹°ë¸Œ ì²˜ë¦¬ë‹¤(ì§ˆë¬¸Â·ì‘ë‹µì´ ì¤‘ì²© íë¦„ì—ì„œë„ ì•ˆì •ì ). <a href="https://modelcontextprotocol.io/specification/draft/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a></p>
  </li>
  <li>
    <p>ë¸Œë¦¿ì§€ í™•ì¥ íŒ¨í„´<br />
ë„ˆì˜ ê¸°ì¡´ Chat ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°/ë¸Œë¦¿ì§€ì— ì•„ë˜ í›… ë‘ ê°œë§Œ ë”í•´ì£¼ë©´ ëœë‹¤.<br />
a) elicitation ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ UIë¡œ ì§ˆë¬¸ ë„ìš°ê¸° â†’ JSON ìŠ¤í‚¤ë§ˆ ê²€ì¦ â†’ ì„œë²„ì— ì œì¶œ<br />
b) ìƒ˜í”Œë§Â·í”„ë¡¬í”„íŠ¸Â·íˆ´ ë£¨í”„ì™€ ìì—°ìŠ¤ëŸ½ê²Œ ê³µì¡´í•˜ë„ë¡ ìˆœì„œ ì œì–´</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œëŠ” â€œê°œë…ì ìœ¼ë¡œ ì •í™•í•œ ë™ì‘ íë¦„â€ì„ ë³´ì—¬ì£¼ëŠ” ë¯¸ë‹ˆ ìŠ¤ìºí´ë”©ì´ë‹¤. MCP SDKì˜ ì„¸ë¶€ ë©”ì„œë“œëª…ì€ ë¦´ë¦¬ìŠ¤ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì´ë²¤íŠ¸ êµ¬ë…/ì‘ë‹µ ë¶€ë¶„ì€ ë„¤ SDK ë²„ì „ì— ë§ì¶° í•¨ìˆ˜ëª…ë§Œ ì¹˜í™˜í•˜ë©´ ëœë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install mcp jsonschema orjson requests</p>

<p>ì½”ë“œ ìŠ¤ë‹ˆí«: MCP Elicitation ë¸Œë¦¿ì§€ í›…</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="c1"># ê°€ì •: ì´ë¯¸ MCP ì„¸ì…˜ì„ ì—¬ëŸ¬ ê°œ ì—´ì–´ë†“ì•˜ê³ , handles = {server: session} í˜•íƒœë¡œ ë³´ìœ 
# ë˜í•œ ask_user ì½œë°±(UI ì…ë ¥)ê³¼ chat_backend(ë„¤ Chat ë˜ëŠ” Agent ë°±ì—”ë“œ)ê°€ ìˆë‹¤.
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_elicitation_loop</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]):</span>
    <span class="sh">"""</span><span class="s">
    í•œ MCP ì„¸ì…˜ì— ëŒ€í•´ ì„œë²„ê°€ ë³´ë‚´ëŠ” Elicitation ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë£¨í”„.
    SDKë§ˆë‹¤ ì´ë²¤íŠ¸ ìˆ˜ì‹  API ì´ë¦„ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì•„ë˜ </span><span class="sh">'</span><span class="s">await session.next_elicitation()</span><span class="sh">'</span><span class="s">ëŠ”
    ë„¤ê°€ ì“°ëŠ” SDKì˜ ì‹¤ì œ í˜¸ì¶œë¡œ ì¹˜í™˜í•˜ë©´ ëœë‹¤.
    </span><span class="sh">"""</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">next_elicitation</span><span class="p">()</span>  <span class="c1"># ì˜ˆì‹œ: {"id": "...", "message": "ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”", "schema": {...}}
</span>        <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>

        <span class="c1"># UIì— ì§ˆë¬¸ ë„ìš°ê³ , ìŠ¤í‚¤ë§ˆì— ë§ëŠ” dictë¡œ ì‘ë‹µ ë°›ê¸°
</span>        <span class="n">user_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">ask_user</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c1"># ë¡œì»¬ì—ì„œ 1ì°¨ ê²€ì¦(ì„ íƒì´ì§€ë§Œ ê¶Œì¥)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="nf">validate</span><span class="p">(</span><span class="n">user_payload</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¬ì§ˆë¬¸
</span>            <span class="n">user_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">ask_user</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ì…ë ¥ í˜•ì‹ ì˜¤ë¥˜: </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s">ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”.</span><span class="sh">"</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
            <span class="nf">validate</span><span class="p">(</span><span class="n">user_payload</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c1"># ì„œë²„ì— ì œì¶œ(ì‹¤ì œ APIëª…/í•„ë“œëª…ì€ SDKì— ë§ì¶° ì¹˜í™˜)
</span>        <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">submit_elicitation</span><span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="n">user_payload</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_chat_with_elicitation</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">):</span>
    <span class="c1"># 1) ë³‘í–‰ìœ¼ë¡œ ê° ì„¸ì…˜ì˜ elicitation ë£¨í”„ë¥¼ ê°€ë™
</span>    <span class="n">loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">handle_elicitation_loop</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">ask_user</span><span class="p">))</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>

    <span class="c1"># 2) ëª¨ë¸ í˜¸ì¶œ ë£¨í”„(íˆ´/í”„ë¡¬í”„íŠ¸/ìƒ˜í”Œë§ ë“± ê¸°ì¡´ ì²˜ë¦¬ì™€ ë™ì¼)
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_text</span><span class="p">}]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># í•„ìš”í•˜ë©´ MCP list_toolsë¥¼ OpenAI tools í¬ë§·ìœ¼ë¡œ ë„£ê¸°
</span>
    <span class="c1"># ì²« í„´
</span>    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{})</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># tool_calls ì²˜ë¦¬(ìƒëµ) + ì¤‘ê°„ì— ì„œë²„ê°€ elicitationì„ ë³´ë‚¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë‹¤ìŒ í„´ ì „ì— ì ê¹ yield
</span>    <span class="c1"># ...
</span>    <span class="c1"># ë‹¤ìŒ í„´ ê³„ì†
</span>    <span class="c1"># ...
</span>
    <span class="c1"># 3) ì¢…ë£Œ ì‹œ elicitation ë£¨í”„ ì •ë¦¬
</span>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">loops</span><span class="p">:</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">t</span>
</code></pre></div></div>

<p>UI ì…ë ¥ ì½œë°± ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">ask_user_via_console</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[MCP ì§ˆë¬¸] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ìš”êµ¬ ìŠ¤í‚¤ë§ˆ: </span><span class="si">{</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; JSONìœ¼ë¡œ ì‘ë‹µ: </span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">ask_user_via_console</span><span class="p">(</span><span class="sh">"</span><span class="s">JSON íŒŒì‹± ì‹¤íŒ¨. ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”.</span><span class="sh">"</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì <br />
ìŠ¤í‚¤ë§ˆ ê²€ì¦. ì„œë²„ê°€ ìŠ¤í‚¤ë§ˆë¥¼ ì œê³µí•˜ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ jsonschemaë¡œ 1ì°¨ ê²€ì¦ì„ ëŒë¦¬ë©´ ì™•ë³µ íšŸìˆ˜ì™€ ì˜¤ë¥˜ê°€ ì¤„ì–´ë“ ë‹¤. ìŠ¤í™ì´ ê¶Œì¥í•˜ëŠ” ë³´ì•ˆÂ·í”„ë¼ì´ë²„ì‹œ ì •ì±…ë„ í•¨ê»˜ ì§€ì¼œë¼(ë¯¼ê°ì •ë³´ ìš”êµ¬ ê¸ˆì§€ ë“±). <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
ì¤‘ì²© ê°€ëŠ¥ì„±. Elicitationì€ ë‹¤ë¥¸ MCP ê¸°ëŠ¥(íˆ´, í”„ë¡¬í”„íŠ¸, ìƒ˜í”Œë§) ì•ˆìª½ì— ì¤‘ì²©ë˜ì–´ ë“±ì¥í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ Chat ë£¨í”„ì™€ ë³‘í–‰ ì‹¤í–‰í•˜ëŠ” íŒ¨í„´ì´ ì•ˆì „í•˜ë‹¤. <a href="https://modelcontextprotocol.io/specification/draft/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
í˜¸í™˜ì„±. MCPë¥¼ ì§ì ‘ ì§€ì›í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸/ì—ì´ì „íŠ¸(ì˜ˆ: ì¼ë¶€ IDE, ì¼ë¶€ Agents SDK)ëŠ” Elicitationì„ ë„¤ì´í‹°ë¸Œë¡œ ëœ¯ì–´ì„œ ë³´ì—¬ì¤„ ì˜ˆì •ì´ê±°ë‚˜ ì´ë¯¸ ì‹¤í—˜ ì¤‘ì´ë‹¤. í•˜ì§€ë§Œ ì„œë²„Â·SDKì— ë”°ë¼ ì´ë²¤íŠ¸/ë©”ì„œë“œëª…ì´ ë‹¤ë¥´ë¯€ë¡œ, ìœ„ ë£¨í”„ì˜ ë‘ í•¨ìˆ˜(next_elicitation, submit_elicitation) ìœ„ì¹˜ë§Œ ì‹¤ì œ SDK ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ë©´ ëœë‹¤. ê°œë…ê³¼ íë¦„ì€ ë™ì¼í•˜ë‹¤. <a href="https://github.com/anthropics/claude-code/issues/2799?utm_source=chatgpt.com">GitHub+1</a></p>

<p>OpenAI Agentsë‚˜ ì¼ë°˜ Chatê³¼ì˜ ê²°í•© ë°©ì‹ ìš”ì•½<br />
OpenAI Agentsë¥¼ ë°±ì—”ë“œ ëª¨ë¸ë¡œ ì“¸ ë•Œë„ ë™ì¼í•˜ë‹¤. â€œì—ì´ì „íŠ¸ì—ê²Œ MCP ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê²¨ì„œ ì—ì´ì „íŠ¸ê°€ íˆ´ í˜¸ì¶œì„ ì²˜ë¦¬â€í•˜ë„ë¡ ë‘˜ ìˆ˜ë„ ìˆì§€ë§Œ, Elicitationì€ í´ë¼ì´ì–¸íŠ¸(UI) ë ˆë²¨ì˜ ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ë¯€ë¡œ, ë¸Œë¦¿ì§€ì—ì„œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•´ UIì™€ ì™•ë³µ í›„ ê²°ê³¼ë¥¼ ì„œë²„ì— ì „ë‹¬í•˜ëŠ” í¸ì´ ì œì¼ ì˜ˆì¸¡ ê°€ëŠ¥í•˜ë‹¤.<br />
ì¼ë°˜ Chat Completions(with tools) ê²½ë¡œì—ì„œë„ ë§ˆì°¬ê°€ì§€ë‹¤. ëª¨ë¸ì€ ë‹µë³€/ê³„íšì— ì§‘ì¤‘ì‹œí‚¤ê³ , ì‚¬ìš©ì ì§ˆë¬¸ì€ ë¸Œë¦¿ì§€ê°€ ë‹´ë‹¹í•œë‹¤. í•„ìš”í•˜ë©´ Elicitationìœ¼ë¡œ ìˆ˜ì§‘ëœ ê°’ì„ ì‹œìŠ¤í…œ/ìœ ì € ë©”ì‹œì§€ë¡œë„ ì£¼ì…í•´ ë‹¤ìŒ í„´ ë‹µë³€ í’ˆì§ˆì„ ì˜¬ë¦´ ìˆ˜ ìˆë‹¤.</p>

<p>ì‹¤ì „ íŒ<br />
ì„œë²„ ìˆ˜ê°€ 3ê°œ ì´ìƒì´ë©´ ì„œë²„ ë¼ë²¨ì„ ì§ˆë¬¸ ë©”ì‹œì§€ì— ëª…ì‹œí•´ì¤€ë‹¤. ì˜ˆ: â€œ[files] ì–´ë–¤ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í• ê¹Œìš”?â€.<br />
ë¯¼ê°ì •ë³´ ê°€ë“œ. ìŠ¤í™ì´ ê¸ˆì§€í•˜ëŠ” ë‚´ìš©(ë¹„ë°€ë²ˆí˜¸/í† í° ë“±)ì€ ë¸Œë¦¿ì§€ì—ì„œ ì°¨ë‹¨í•˜ê³ , í—ˆìš© ëª©ë¡ë§Œ í†µê³¼ì‹œí‚¤ëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤. <a href="https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation?utm_source=chatgpt.com">Model Context Protocol</a><br />
UX. ìŠ¤í‚¤ë§ˆì— enum/formatì„ ì ê·¹ ì‚¬ìš©í•˜ê²Œ ì„œë²„ ìª½ì— ê¶Œì¥í•˜ë¼. í´ë¼ì´ì–¸íŠ¸ëŠ” enumì´ë©´ ë“œë¡­ë‹¤ìš´, format=emailì´ë©´ ì´ë©”ì¼ ì…ë ¥ UIì²˜ëŸ¼ ì¹œí™”ì ìœ¼ë¡œ ë Œë”ë§í•˜ê¸° ì‰½ë‹¤. <a href="https://medium.com/data-science-collective/a-practical-guide-to-mcp-elicitation-with-fastapi-fastmcp-65f57fd91896?utm_source=chatgpt.com">Medium</a></p>

<p>í•œ ì¤„ ê²°ë¡ <br />
Elicitationì€ MCPì˜ â€œì¸ê°„-ê°œì… í‘œì¤€ ì±„ë„â€ì´ê³ , íˆ´ê³¼ ë³„ê°œë¡œ Chat ë£¨í”„ì— ê¹¨ë—í•˜ê²Œ ë¶™ì¼ ìˆ˜ ìˆë‹¤. ìœ„ ë¸Œë¦¿ì§€ í›… ë‘ ê°œë§Œ ë„£ìœ¼ë©´, ëª¨ë¸-íˆ´-ì‚¬ìš©ì ì‚¼ì í˜‘ì—…ì´ ì•ˆì •ì ìœ¼ë¡œ ëˆë‹¤. ë„¤ê°€ ì“°ëŠ” MCP Python SDKì˜ ì •í™•í•œ elicitation API ì´ë¦„ì„ ì•Œë ¤ì£¼ë©´, next_elicitation/submit_elicitation ë¶€ë¶„ì„ í•´ë‹¹ ë²„ì „ì— ë”± ë§ì¶° ì¦‰ì‹œ ì¹˜í™˜í•´ ì¤€ë‹¤.</p>

<p class="chat--user">

ê·¼ë° MCP Server ë¼ê³  í´ë˜ìŠ¤ëª…ì„ í•˜ë‹ˆê¹ ì§„ì§œ ì„œë²„ ê°™ì´ ëŠê»´ì ¸ ë‹¤ë¥¸ ì´ë¦„ ì—†ì–´? ì´ê±´ ì„¤ì • ê°’ì— ê°€ê¹Œìš´ê±° ê°™ì€ë°

</p>

<p>ë§ì•„, â€œMCPServerâ€ë¼ê³  í•˜ë©´ ë„¤íŠ¸ì›Œí¬ ì„œë²„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì§ì ‘ ëŒë¦°ë‹¤ëŠ” ëŠë‚Œì´ ê°•í•˜ë‹¤. ì‹¤ì œ ë„¤ê°€ ë‹¤ë£¨ëŠ” ê±´ ì„¸ì…˜ì„ ì—´ ë•Œ í•„ìš”í•œ <strong>ì„¤ì • ì •ë³´(Descriptor, Config, Profile, Endpoint)</strong>ì— ê°€ê¹Œì›Œ.</p>

<p>ë³´í†µ ì´ëŸ° ê²½ìš° ë„¤ì´ë°ì„ ì´ë ‡ê²Œ ë°”ê¿” ì“°ë©´ ë” ìì—°ìŠ¤ëŸ½ë‹¤.</p>

<ul>
  <li>
    <p><strong>MCPServerConfig</strong> : ê°€ì¥ ì§ì„¤ì . ì„œë²„ì— ì ‘ì†í•˜ëŠ” ë° í•„ìš”í•œ ì„¤ì •ê°’ ë¬¶ìŒ.</p>
  </li>
  <li>
    <p><strong>MCPServerSpec</strong> : â€œì‚¬ì–‘/ìŠ¤í™â€ì´ë¼ëŠ” ì˜ë¯¸ë¡œ, ì„œë²„ë¥¼ ê¸°ìˆ í•˜ëŠ” ì„ ì–¸ì  ì •ë³´ë¼ëŠ” ë‰˜ì•™ìŠ¤.</p>
  </li>
  <li>
    <p><strong>MCPServerProfile</strong> : ì—¬ëŸ¬ í™˜ê²½(ê°œë°œ/ìš´ì˜/í…ŒìŠ¤íŠ¸)ì—ì„œ ì“°ì¼ ìˆ˜ ìˆëŠ” â€œí”„ë¡œí•„â€ì´ë¼ëŠ” í†¤.</p>
  </li>
  <li>
    <p><strong>MCPServerEndpoint</strong> : íŠ¹íˆ SSE/HTTP ì£¼ì†Œì²˜ëŸ¼ ì›ê²© ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì§€ì¹­í•  ë•Œ ì í•©.</p>
  </li>
  <li>
    <p><strong>MCPConnectionConfig</strong> : ì‹¤ì œë¡œëŠ” ì—°ê²° êµ¬ì„±ì— í•´ë‹¹í•œë‹¤ëŠ” ê±¸ ë¶„ëª…íˆ í•¨.</p>
  </li>
</ul>

<p>ë„¤ê°€ ë§Œë“  UnifiedMCPConfig ê°™ì€ ì»¨í…Œì´ë„ˆ ì•ˆì— ë“¤ì–´ê°ˆ ì›ì†Œë¼ë©´,</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MCPServerConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span> <span class="bp">...</span>
</code></pre></div></div>

<p>í˜¹ì€ ì¡°ê¸ˆ ë” ê°€ë³ê²Œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MCPServerSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span> <span class="bp">...</span>
</code></pre></div></div>

<p>ì •ë„ê°€ ê°€ì¥ ë¬´ë‚œí•˜ë‹¤.</p>

<p>ì •ë¦¬í•˜ìë©´: <strong>ì„œë²„(server)</strong>ë¼ëŠ” ë‹¨ì–´ ëŒ€ì‹  <strong>Config / Spec / Endpoint / Profile</strong> ê³„ì—´ì„ ë¶™ì—¬ì£¼ë©´ â€œì‹¤ì œ ì„œë²„ ê°ì²´â€ê°€ ì•„ë‹ˆë¼ â€œì ‘ì† ì„ ì–¸â€ì´ë¼ëŠ” ì˜ë¯¸ê°€ ëª…í™•í•´ì§„ë‹¤.</p>

<p>ë„ˆì˜ ì½”ë“œë² ì´ìŠ¤ì—ì„œ MCP ì„œë²„ë¥¼ ì‹¤ì œë¡œ êµ¬ë™í•˜ëŠ” ì±…ì„ì´ ì•„ë‹ˆë¼ <strong>ì—°ê²° ì •ë³´ë¥¼ ë‹´ëŠ” ë°ì´í„° ëª¨ë¸</strong> ì´ë¼ë©´, <code class="language-plaintext highlighter-rouge">MCPServerConfig</code>ê°€ ê°€ì¥ ì•ˆì „í•œ ì„ íƒì´ë‹¤.</p>

<p>ì›í•œë‹¤ë©´, ë„¤ê°€ ì§€ê¸ˆ ê°€ì§€ê³  ìˆëŠ” í´ë˜ìŠ¤ ì •ì˜ë¥¼ ë‚´ê°€ <code class="language-plaintext highlighter-rouge">MCPServerConfig</code> ì‹ìœ¼ë¡œ ë¦¬íŒ©í„°ë§í•´ì„œ ì „ì²´ ì½”ë“œ ìŠ¤ë‹ˆí«ì„ ë‹¤ì‹œ ì •ë¦¬í•´ì¤„ ìˆ˜ë„ ìˆì–´.</p>

<p class="chat--user">

MCPSpecì€ ì–´ë•Œ

</p>

<p>ì¢‹ë‹¤. MCPSpec ê´œì°®ë‹¤. ë‹¤ë§Œ â€œSpecâ€ì€ ì„ ì–¸ì Â·ë¶ˆë³€ ì„¤ì •ì´ë¼ëŠ” ë‰˜ì•™ìŠ¤ë¥¼ ì£¼ë‹ˆ, ëŸ°íƒ€ì„ ìƒíƒœ(ì„¸ì…˜, ìºì‹œ, ë™ì‹œì„± ì œì–´)ëŠ” ë‹¤ë¥¸ ì´ë¦„ì— ë‘ëŠ” ê±¸ ì¶”ì²œí•œë‹¤. ì •ë¦¬í•˜ë©´ ì´ë ‡ê²Œ ì“°ë©´ ê¹”ë”í•˜ë‹¤.</p>

<p>ê¶Œì¥ ì˜ë¯¸ êµ¬ë¶„</p>

<ul>
  <li>
    <p>MCPSpec: ì—°ê²°Â·ì¸ì¦Â·ì „ì†¡ë°©ì‹ ê°™ì€ ì„ ì–¸í˜• ìŠ¤í™. ì§ë ¬í™” ê°€ëŠ¥, ë¶ˆë³€ ì·¨ê¸‰.</p>
  </li>
  <li>
    <p>MCPHandle ë˜ëŠ” MCPSession: MCPSpecì„ ë°”íƒ•ìœ¼ë¡œ ì‹¤ì œ ì—°ê²°ì„ ì—° ë’¤ ê°–ê²Œ ë˜ëŠ” ëŸ°íƒ€ì„ ê°ì²´.</p>
  </li>
  <li>
    <p>MCPConfig: ì—¬ëŸ¬ MCPSpecì„ ë‹´ëŠ” ì»¨í…Œì´ë„ˆ.</p>
  </li>
</ul>

<p>ì‘ì€ ë¦¬íŒ©í„° ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì‚¬ëŒê³¼ ëª¨ë¸ì´ ë³´ëŠ” ë¼ë²¨</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># ì •ì±…/íŒíŠ¸(ìŠ¤í™ì´ë¯€ë¡œ ê¸°ë³¸ê°’ë§Œ ë³´ê´€)
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span>
    <span class="n">cache_tools_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">request_timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">class</span> <span class="nc">MCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPSpec</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate names: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ëŸ°íƒ€ì„ ë¶„ë¦¬ íŒ¨í„´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">MCPSpec</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">open_handle</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">MCPSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">env</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># í•„ìš” ì‹œ http_streamable ë“± ì¶”ê°€
</span>        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unsupported kind: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">tr</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span> <span class="k">await</span> <span class="n">s</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</code></pre></div></div>

<p>ì–´ëŒ‘í„°ì—ì„œì˜ ì‚¬ìš© ëŠë‚Œ</p>

<ul>
  <li>
    <p>OpenAI Agents ì–´ëŒ‘í„°: MCPSpec â†’ MCPServerStdio/MCPServerSse ìƒì„± ì‹œ ê·¸ëŒ€ë¡œ ë„˜ê¹€.</p>
  </li>
  <li>
    <p>Anthropic ì–´ëŒ‘í„°: MCPSpec(kind="sse"/"http_streamable")ë¥¼ mcp_servers í˜ì´ë¡œë“œë¡œ ì§ë ¬í™”.</p>
  </li>
</ul>

<p>ì¥ë‹¨ì  í•œì¤„ ìš”ì•½</p>

<ul>
  <li>
    <p>MCPSpecì€ â€œì§„ì§œ ì„œë²„â€ê°€ ì•„ë‹ˆë¼ â€œì ‘ì† ì„ ì–¸â€ì´ë¼ëŠ” ì˜ë„ê°€ ë¶„ëª…í•´ì ¸ ì˜¤í•´ê°€ ì¤„ê³ , í…ŒìŠ¤íŠ¸Â·ì§ë ¬í™”Â·ë²„ì „ê´€ë¦¬ë„ ì‰¬ì›Œì§„ë‹¤.</p>
  </li>
  <li>
    <p>ì„¸ì…˜Â·ë™ì‹œì„± ê°™ì€ ëŸ°íƒ€ì„ì€ Handle/Session ìª½ìœ¼ë¡œ ë¶„ë¦¬ë˜ë‹ˆ ì±…ì„ì´ ì„ ëª…í•´ì§„ë‹¤.</p>
  </li>
</ul>

<p>ê²°ë¡ <br />
MCPSpec ë„¤ì´ë° ì±„íƒ ì¶”ì²œ. ì´ë¯¸ ë§Œë“¤ì–´ë‘” ì½”ë“œì—ì„œ í´ë˜ìŠ¤ëª…ë§Œ ë°”ê¾¸ê³ , í•¸ë“¤(ì„¸ì…˜) ê³„ì¸µì„ ë¶„ë¦¬í•˜ë©´ ì§€ê¸ˆê¹Œì§€ì˜ ì–´ëŒ‘í„°/ë¸Œë¦¿ì§€ êµ¬ì¡°ì™€ë„ ì˜ ë§ë¬¼ë¦°ë‹¤.</p>

<p class="chat--user">

ì‘ ëŸ°íƒ€ì„ ì²˜ë¦¬ëŠ” ì•ˆí• ê±°ì•¼. MCPSpec // ToolSpec ì´ë ‡ê²Œ í• ê¹Œ í•˜ëŠ”ë° MCPConfig // ToolConfig ì´ê²Œ ë‚˜ìœ¼ë ¤ë‚˜ ì–´ë–»ê²Œ ìƒê°í•´

</p>

<p>ì¢‹ì•„, ëŸ°íƒ€ì„ì€ ì•ˆ ë‹¤ë£¬ë‹¤ê³  í–ˆìœ¼ë‹ˆ ì´ë¦„ì€ â€œë¬´ìŠ¨ ê°’ì„ ì„ ì–¸Â·ê¸°ìˆ í•´ ë‘ëŠ”ê°€â€ì—ë§Œ ë§ì¶”ë©´ ëœë‹¤. í•µì‹¬ì€ Specê³¼ Configê°€ ì£¼ëŠ” ë‰˜ì•™ìŠ¤ ì°¨ì´ë¥¼ ì˜ë„ëŒ€ë¡œ ì“°ëŠ” ê²ƒ.</p>

<p>ì •ì˜ ìš”ì•½<br />
Spec: ì¸í„°í˜ì´ìŠ¤Â·ìŠ¤í‚¤ë§ˆÂ·ë¶ˆë³€ì— ê°€ê¹Œìš´ ì„ ì–¸. ì—”ë“œí¬ì¸íŠ¸, íˆ´ ì‹œê·¸ë‹ˆì²˜, JSON ìŠ¤í‚¤ë§ˆ ê°™ì€ â€œê³„ì•½ì„œâ€.<br />
Config: ì‹¤í–‰ ë§¥ë½ì— ë§ì¶˜ ì„ íƒÂ·ì˜¤ë²„ë ˆì´. ì–´ë–¤ Specì„ ë…¸ì¶œí• ì§€, ë³„ì¹­, ê¸°ë³¸ ì˜µì…˜, ì¼œê¸°/ë„ê¸° ê°™ì€ â€œì •ì±…â€.</p>

<p>ê¶Œì¥ ë„¤ì´ë° ë§¤íŠ¸ë¦­ìŠ¤<br />
ë‹¨ì¼ ì„ ì–¸ ë‹¨ìœ„<br />
MCPSpec: MCP ì ‘ì† ì„ ì–¸. kind, url/command, headers ê°™ì€ ì—°ê²° ìŠ¤í™ê³¼ ë¼ë²¨, íƒœê·¸ ë“±.<br />
ToolSpec: íˆ´ ì„ ì–¸. name, description, parameters(JSON Schema), ìœ„í—˜ë„ í”Œë˜ê·¸ ë“±.</p>

<p>ì»¬ë ‰ì…˜ê³¼ ì •ì±…<br />
MCPConfig: ì—¬ëŸ¬ MCPSpecì„ ë‹´ê³ , í™˜ê²½ë³„ë¡œ enable/disableÂ·ë¼ë²¨Â·ìŠ¹ì¸ì •ì±… ë“± ì˜¤ë²„ë ˆì´.<br />
ToolConfig: ì—¬ëŸ¬ ToolSpecì— ëŒ€í•œ ì •ì±… ì˜¤ë²„ë ˆì´ì™€ ë…¸ì¶œ ê·œì¹™(í•„í„°ë§, ë³„ì¹­, ê¸°ë³¸ íŒŒë¼ë¯¸í„° ë“±).</p>

<p>ì¦‰, MCPSpec // ToolSpecì€ â€œìˆœìˆ˜ ì„ ì–¸â€, MCPConfig // ToolConfigëŠ” â€œì„ íƒê³¼ ì •ì±…â€ìœ¼ë¡œ ì—­í• ì„ ë¶„ë¦¬í•˜ë©´ ê¹”ë”í•˜ë‹¤.</p>

<p>ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ìµœì†Œ ëª¨ë¸ ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì‚¬ëŒ/ëª¨ë¸ì´ ë³¼ ë¼ë²¨, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í‚¤</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># sse/http
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># ë©”íƒ€
</span>    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                             <span class="c1"># ì˜ˆ: "files:read_csv" ë˜ëŠ” "local.math_eval"
</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span>            <span class="c1"># JSON Schema
</span>    <span class="n">server_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>      <span class="c1"># MCP ë„¤ì„ìŠ¤í˜ì´ìŠ¤(ì˜ˆ: "files"). ë¡œì»¬ íˆ´ì´ë©´ None.
</span>    <span class="n">risk_level</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">med</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">low</span><span class="sh">"</span>
    <span class="n">default_dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MCPConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>        <span class="c1"># name -&gt; on/off
</span>    <span class="n">require_approval</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">always</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>         <span class="c1"># name -&gt; alias for UI/LLM
</span>    <span class="c1"># ê°„ë‹¨ ê²€ì¦
</span>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate MCP names</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ToolConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>        <span class="c1"># tool name -&gt; on/off
</span>    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>         <span class="c1"># tool name -&gt; alias
</span>    <span class="n">defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># tool name -&gt; default args
</span>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate tool names</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ì–´ëŒ‘í„°ëŠ” â€œëŸ°íƒ€ì„ ì—†ì´â€ ì •ì  ë³€í™˜ë§Œ í•˜ë©´ ëœë‹¤</p>

<p>OpenAI Chat Completions tools ë³€í™˜<br />
ToolSpec â†’ tools JSONìœ¼ë¡œ ì§ë ¬í™”</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tools_for_openai</span><span class="p">(</span><span class="n">tool_cfg</span><span class="p">:</span> <span class="n">ToolConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">tool_cfg</span><span class="p">.</span><span class="n">aliases</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></div>

<p>Anthropic Messages APIìš© MCP ì„œë²„ í˜ì´ë¡œë“œ<br />
MCPSpec â†’ mcp_servers í•­ëª©ìœ¼ë¡œ ì§ë ¬í™”(SSE/HTTP ê³„ì—´ë§Œ)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mcp_servers_for_anthropic</span><span class="p">(</span><span class="n">mcp_cfg</span><span class="p">:</span> <span class="n">MCPConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># AnthropicëŠ” ì›ê²© URL íƒ€ì…ë§Œ ì§ì ‘ ë¶™ì¼ ìˆ˜ ìˆìŒ
</span>            <span class="k">continue</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">aliases</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">authorization_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_configuration</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">enabled</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<p>OpenAI Agents Python SDKìš© MCP ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì € ìƒì„±<br />
MCPSpec â†’ SDKì˜ MCPServerSse/MCPServerStdioë¡œ ë³€í™˜ì— í•„ìš”í•œ íŒŒë¼ë¯¸í„°ë§Œ ì¤€ë¹„<br />
ëŸ°íƒ€ì„ì€ ì•ˆ ë§Œë“¤ì§€ë§Œ, ì–´ëŒ‘í„°ê°€ ì–´ëŠ í´ë˜ìŠ¤ë¥¼ ì¨ì•¼ í•˜ëŠ”ì§€ ê²°ì •í•  ìˆ˜ ìˆë„ë¡ ì •ì  ë§¤í•‘ë§Œ ì±…ì„ì§€ê²Œ í•˜ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mcp_params_for_openai_agents</span><span class="p">(</span><span class="n">mcp_cfg</span><span class="p">:</span> <span class="n">MCPConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mcp_cfg</span><span class="p">.</span><span class="n">enabled</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">env</span><span class="p">}})</span>
        <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">}})</span>
        <span class="k">elif</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">headers</span><span class="p">}})</span>
    <span class="k">return</span> <span class="n">params</span>
</code></pre></div></div>

<p>ì™œ ì´ë ‡ê²Œ ë‚˜ëˆ„ê¸¸ ê¶Œí•˜ëƒ<br />
MCPSpec / ToolSpecì€ ë¶ˆë³€ ê³„ì•½ì„œë‹¤. ì½”ë“œ ë¦¬ë·°Â·ë²„ì „ ê´€ë¦¬Â·í…ŒìŠ¤íŠ¸ ë”ë¸” ì‘ì„±ì´ ì‰½ë‹¤.<br />
MCPConfig / ToolConfigëŠ” í™˜ê²½ë³„ ì„¤ì •ê³¼ ì •ì±…ì„ ë‹´ì•„ ë°°í¬ íŒŒì´í”„ë¼ì¸ì—ì„œ ë°”ê¿”ì¹˜ìš°ê¸° ì¢‹ë‹¤. ìŠ¤í…Œì´ì§•ê³¼ í”„ë¡œë•ì…˜ì„ ì˜¤ë²„ë ˆì´ë¡œ êµ¬ë¶„í•˜ê¸° í¸í•˜ë‹¤.<br />
ì¶”í›„ ëŸ°íƒ€ì„ì„ ë¶™ì´ê³  ì‹¶ì–´ë„ ëª¨ë¸ì´ í”ë“¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤. Handle/Sessionì€ ë³„ íŒŒì¼ì—ì„œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p>ì‹¤ë¬´ íŒ<br />
Specì— version, tags, capabilities ê°™ì€ í•„ë“œë¥¼ ë‘ë©´ ë‚˜ì¤‘ì— í•„í„°ë§ì´ í¸í•˜ë‹¤(ì˜ˆ: tagê°€ readonlyì¸ MCPë§Œ ë…¸ì¶œ).<br />
ToolSpec.parametersëŠ” ë°˜ë“œì‹œ ì—„ê²©í•˜ê²Œ(required, enum, format, min/max) ê¸°ì…í•´ ëª¨ë¸ì˜ ì˜ëª»ëœ í˜¸ì¶œì„ ì¤„ì¸ë‹¤.<br />
Configì˜ aliasesëŠ” LLM í˜¼ë™ì„ ì¤„ì´ëŠ” ë° íš¨ê³¼ì ì´ë‹¤. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ê¸´ íˆ´ì€ ë³„ì¹­ì„ ì§§ê³  ëª…í™•í•˜ê²Œ.</p>

<p>ê²°ë¡ <br />
ë„¤ ëª©í‘œê°€ ì„ ì–¸ê°’ë§Œ ê´€ë¦¬í•˜ëŠ” ê±°ë¼ë©´ MCPSpec // ToolSpecë¡œ ê°€ëŠ” ê²Œ ë§ë‹¤. ì—¬ê¸°ì— í™˜ê²½Â·ì •ì±…ì„ ì–¹ëŠ” ìš©ë„ë¡œ MCPConfig // ToolConfigë¥¼ ì¶”ê°€í•˜ë©´ ìš´ì˜ ì¹œí™”ì ì´ë‹¤. í•œ ì¤„ ìš”ì•½ì€ ì´ê±°ë‹¤.<br />
Spec = ê³„ì•½, Config = ì„ íƒê³¼ ì •ì±….<br />
ë‘˜ ë‹¤ ì“°ë˜, ê°ì ì—­í• ì„ ë¶„ëª…íˆ ë‚˜ëˆ„ì.</p>

<p class="chat--user">

ê·¼ë° í´ë˜ìŠ¤ëª…ì„ McpSpec MCPSpec ì´ê±° ê³„ì† í—·ê°ˆë¦¼ 

</p>

<p>í—·ê°ˆë¦¬ëŠ” ê²Œ ì •ìƒì´ë‹¤. íŒŒì´ì¬ì—ì„œ ì•½ì–´ë¥¼ í´ë˜ìŠ¤ëª…ì— ë„£ì„ ë•Œ ì„ íƒì§€ëŠ” ë‘ ê°€ì§€ë¿ì´ë‹¤. í•˜ë‚˜ë§Œ ê³ ë¥´ê³  ëê¹Œì§€ ì¼ê´€í•˜ë©´ ëœë‹¤.</p>

<p>ê¶Œì¥ ê²°ë¡ <br />
McpSpecë¡œ í†µì¼í•˜ì. ì´ìœ ëŠ” ê°€ë…ì„±(ëŒ€ë¬¸ì ë©ì–´ë¦¬ ì¤„ì„), íƒ€ì´í•‘ í¸ì˜, ê·¸ë¦¬ê³  íŒŒì´ì¬ ìƒíƒœê³„ì—ì„œ HttpServer, XmlParserì²˜ëŸ¼ ì•½ì–´ë¥¼ ë‹¨ì–´ ì·¨ê¸‰í•˜ëŠ” ê´€ë¡€ê°€ ë„ë¦¬ ì“°ì´ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ëŸ¬ë©´ íŒ¨ë°€ë¦¬ë„ ìì—°ìŠ¤ëŸ½ê²Œ McpConfig, McpEndpoint, McpHandle ê°™ì€ ë¦¬ë“¬ì´ ëœë‹¤.</p>

<p>ë¹ ë¥¸ ê·œì¹™ ì„¸íŠ¸<br />
í´ë˜ìŠ¤: McpSpec, McpConfig, McpToolSpec, McpToolConfig<br />
ëª¨ë“ˆ íŒŒì¼: mcp_spec.py, mcp_config.py<br />
ë³€ìˆ˜/ë§¤ê°œë³€ìˆ˜: mcp_spec, mcp_config<br />
JSON í‚¤: snake_case ë©´ "mcp_spec", camelCaseë©´ "mcpSpec" (íŒ€ ì»¨ë²¤ì…˜ í•˜ë‚˜ë§Œ ì„ íƒ)<br />
ìƒìˆ˜: MCP_SPEC_DEFAULTSì²˜ëŸ¼ ì „ë¶€ ëŒ€ë¬¸ìë„ ê°€ëŠ¥í•˜ì§€ë§Œ í´ë˜ìŠ¤ëª…ê³¼ í˜¼ë™ë˜ë‹ˆ í”¼í•˜ëŠ” í¸ì´ ì¢‹ë‹¤</p>

<p>ì‘ê²Œ ë§›ë³´ê¸° ë¦¬íŒ©í„° ìŠ¤ë‹ˆí«</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_spec.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">McpSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ë¼ë²¨/ë„¤ì„ìŠ¤í˜ì´ìŠ¤</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpSpec</span><span class="p">]</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">duplicate MCP names</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">http_streamable</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="s"> requires url</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ë ˆê±°ì‹œ í˜¸í™˜ì´ í•„ìš”í•˜ë©´ í•œ ì¤„ë¡œ ë‹¤ë¦¬ ê±¸ì–´ë‘ë©´ ëœë‹¤</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì„ì‹œ í˜¸í™˜(í–¥í›„ ì œê±° ì˜ˆì •)
</span><span class="k">class</span> <span class="nc">MCPSpec</span><span class="p">(</span><span class="n">McpSpec</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>ë§Œì•½ íŒ€ì´ ì „í†µì ì¸ â€œì•½ì–´ëŠ” ì „ë¶€ ëŒ€ë¬¸ìâ€ë¥¼ ê³ ì§‘í•œë‹¤ë©´ MCPSpecë¡œ ê°€ë„ ëœë‹¤. ê·¸ ê²½ìš°ì—” ë¬¸ì„œÂ·ì½”ë“œ ì „ë°˜ì— ë™ì¼ ê·œì¹™ì„ ê°•ì œí•˜ì. ì˜ˆë¥¼ ë“¤ì–´ í´ë˜ìŠ¤ëŠ” MCPSpec/MCPEndpoint, ë³€ìˆ˜ëŠ” mcp_spec, íŒŒì¼ì€ mcp_spec.pyì²˜ëŸ¼ â€œí´ë˜ìŠ¤ë§Œ ALLCAPS+CapWords, ë‚˜ë¨¸ì§„ snake_caseâ€ë¡œ ì„ ì„ ê¸‹ëŠ” ì‹ì´ë‹¤. í•µì‹¬ì€ í˜¼ìš© ê¸ˆì§€ë‹¤.</p>

<p>í•œ ì¤„ ìš”ì•½<br />
íŒŒì´ì¬ í”„ë¡œì íŠ¸ë¼ë©´ McpSpec ê³„ì—´ì´ ëœ í—·ê°ˆë¦¬ê³  ì½ê¸° ì¢‹ë‹¤. íŒ€ í•©ì˜ë¡œ í•œ ìŠ¤íƒ€ì¼ë§Œ ë°•ê³ , í´ë˜ìŠ¤Â·ëª¨ë“ˆÂ·ë³€ìˆ˜Â·JSON í‚¤ì— ê°™ì€ ì›ì¹™ì„ ë°˜ë³µ ì ìš©í•˜ë©´ í˜¼ë€ì´ ì‚¬ë¼ì§„ë‹¤.</p>

<p class="chat--user">

StdioClientTransportë‘ SSEClientTransportê°€ ì—†ë‹¤ëŠ”ã„·

</p>

<p>ì¢‹ì•„, ì´ê±´ ë³´í†µ ë‹¤ìŒ ì„¸ ê°€ì§€ ê²½ìš° ì¤‘ í•˜ë‚˜ë‹¤. ì°¨ê·¼ì°¨ê·¼ ì •ë¦¬í•˜ê³ , ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” í˜¸í™˜ ì…°ì„(shim) ì½”ë“œê¹Œì§€ ë¶™ì¼ê²Œ.</p>

<ol>
  <li>
    <p>íŒ¨í‚¤ì§€/ë²„ì „ ë¬¸ì œ<br />
mcp Python SDKì˜ íŠ¸ëœìŠ¤í¬íŠ¸ ê²½ë¡œê°€ ë²„ì „ë³„ë¡œ ì¡°ê¸ˆ ë‹¬ë¼ì„œ, ë„¤ í™˜ê²½ì—ì„  <code class="language-plaintext highlighter-rouge">mcp.client.stdio</code> / <code class="language-plaintext highlighter-rouge">mcp.client.sse</code> ëª¨ë“ˆì´ ì—†ì„ ìˆ˜ ìˆë‹¤. ì„¤ì¹˜ê°€ ë‹¤ë¥´ê±°ë‚˜ êµ¬ë²„ì „ì¼ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.</p>
  </li>
  <li>
    <p>ì„ íƒì  ì˜ì¡´ì„± ë¯¸ì„¤ì¹˜<br />
SSE íŠ¸ëœìŠ¤í¬íŠ¸ëŠ” ì„ íƒ(extra)ë¡œ ë¶„ë¦¬ëœ ê²½ìš°ê°€ ìˆë‹¤. ì¦‰, ê¸°ë³¸ <code class="language-plaintext highlighter-rouge">pip install mcp</code>ë¡œëŠ” SSE í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ê³ , ì¶”ê°€ ì˜ì¡´ì„±ì„ ê¹”ì•„ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>ë‹¤ë¥¸ SDKë¥¼ ë³´ê³  ìˆë‹¤<br />
ì´ë¦„ì´ ë¹„ìŠ·í•œ í¬í¬/ë˜í¼(ì˜ˆ: ì˜ˆì „ model-context-protocol íŒ¨í‚¤ì§€)ë‚˜ í”„ë¡ì‹œ í´ë¼ì´ì–¸íŠ¸ë¥¼ ê¹”ì•„ ë‘ë©´ ê²½ë¡œê°€ ì–´ê¸‹ë‚œë‹¤.</p>
  </li>
</ol>

<p>í•´ê²° ìˆœì„œ í•œ ë²ˆì— ëë‚´ê¸°<br />
ì•„ë˜ ëª…ë ¹ìœ¼ë¡œ ë„¤ í™˜ê²½ì„ í‘œì¤€í™”í•´ë³´ì. ì‹¤íŒ¨í•˜ë©´ ë°”ë¡œ í˜¸í™˜ ì…°ì„ ì½”ë“œê°€ ë’¤ì— ìˆë‹¤.</p>

<p>1ë‹¨ê³„. ì„¤ì¹˜/ì—…ê·¸ë ˆì´ë“œ<br />
pip install -U mcp<br />
SSEê¹Œì§€ ì“¸ ê±°ë©´ ì•„ë˜ ë‘˜ ì¤‘ í™˜ê²½ì— ë§ê²Œ í•˜ë‚˜ë¥¼ ì‹œë„<br />
pip install -U "mcp[sse]"<br />
ë˜ëŠ”<br />
pip install -U httpx sse-starlette</p>

<p>2ë‹¨ê³„. ë²„ì „Â·ëª¨ë“ˆ í™•ì¸<br />
python - Â«'PY'<br />
import pkgutil, mcp, sys<br />
print("mcp version:", getattr(mcp, "<strong>version</strong> ", "unknown"))<br />
print("has mcp.client.stdio:", pkgutil.find_loader("mcp.client.stdio") is not None)<br />
print("has mcp.client.sse:", pkgutil.find_loader("mcp.client.sse") is not None)<br />
print("has mcp.transport.stdio:", pkgutil.find_loader("mcp.transport.stdio") is not None)<br />
print("has mcp.transport.sse:", pkgutil.find_loader("mcp.transport.sse") is not None)<br />
PY</p>

<p>ì´ì œ ì–´ë–¤ ê²½ë¡œê°€ ìˆëŠ”ì§€ ì•Œì•˜ìœ¼ë‹ˆ, í˜¸í™˜ ì„í¬íŠ¸ ì…°ì„ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬í•˜ë©´ ëœë‹¤.</p>

<p>í˜¸í™˜ ì„í¬íŠ¸ ì…°ì„(ë‘˜ ì¤‘ ìˆëŠ” ê±¸ ìë™ìœ¼ë¡œ ì”€)<br />
ì´ ìŠ¤ë‹ˆí«ì„ ë„ˆì˜ ê³µí†µ ìœ í‹¸ì— ë„£ê³ , ë‚˜ë¨¸ì§€ ì½”ë“œì—ì„  í•­ìƒ ì—¬ê¸°ì„œ ì„í¬íŠ¸í•œ í´ë˜ìŠ¤ë¥¼ ì“°ë©´ ê²½ë¡œ ì°¨ì´ì— ì•ˆ í”ë“¤ë¦°ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mcp_compat.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># stdio
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>  <span class="c1"># ì‹ í˜• ê²½ë¡œ
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.transport.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>  <span class="c1"># êµ¬í˜•/ë‹¤ë¥¸ ë¹Œë“œ
</span>    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">StdioClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>        <span class="n">StdioServerParameters</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>
<span class="c1"># sse
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>  <span class="c1"># ì‹ í˜• ê²½ë¡œ
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">mcp.transport.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>  <span class="c1"># êµ¬í˜•/ë‹¤ë¥¸ ë¹Œë“œ
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">SSEClientTransport</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: ignore
</span>
<span class="k">def</span> <span class="nf">have_stdio</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">StdioClientTransport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">StdioServerParameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">have_sse</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">SSEClientTransport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</code></pre></div></div>

<p>ì‚¬ìš© ì˜ˆì‹œ(ë„¤ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ, ë‹¨ ì„í¬íŠ¸ë§Œ ë°”ê¿ˆ)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´: from mcp.client.stdio import StdioClientTransport, StdioServerParameters
# ê¸°ì¡´: from mcp.client.sse import SSEClientTransport
</span><span class="kn">from</span> <span class="n">mcp_compat</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span><span class="p">,</span> <span class="n">SSEClientTransport</span><span class="p">,</span> <span class="n">have_stdio</span><span class="p">,</span> <span class="n">have_sse</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_stdio</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">have_stdio</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">STDIO transportê°€ ì´ í™˜ê²½ì— ì—†ìŠµë‹ˆë‹¤. mcp íŒ¨í‚¤ì§€ ë˜ëŠ” ë²„ì „ì„ í™•ì¸í•˜ì„¸ìš”.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}))</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">transport</span><span class="p">,</span> <span class="n">sess</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_sse</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">have_sse</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">SSE transportê°€ ì´ í™˜ê²½ì— ì—†ìŠµë‹ˆë‹¤. </span><span class="sh">'</span><span class="s">pip install </span><span class="se">\"</span><span class="s">mcp[sse]</span><span class="se">\"</span><span class="sh">'</span><span class="s"> ë˜ëŠ” httpx ê³„ì—´ì„ ì„¤ì¹˜í•˜ì„¸ìš”.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">transport</span><span class="p">,</span> <span class="n">sess</span>
</code></pre></div></div>

<p>ëŒ€ì²´ ê²½ë¡œê°€ ëª¨ë‘ ì—†ë‹¤ë©´<br />
OpenAI Agents Python SDKì˜ ë‚´ì¥ ì»¤ë„¥í„°ë¥¼ ì¨ì„œ íŠ¸ëœìŠ¤í¬íŠ¸ ë¬¸ì œë¥¼ ì•„ì˜ˆ ìš°íšŒí•  ìˆ˜ë„ ìˆë‹¤. ë„¤ê°€ â€œMCP ì„œë²„ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê¸´ë‹¤â€ ì „ëµì„ ì“°ëŠ” ê²½ìš° íŠ¹íˆ ê°„ë‹¨í•˜ë‹¤. ì´ ê²½ë¡œì—ì„  íŒŒì´ì¬ì—ì„œ transportë¥¼ ì§ì ‘ ì„í¬íŠ¸í•˜ì§€ ì•ŠëŠ”ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Bearer X</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search</span><span class="p">:</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">pass-through</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files</span><span class="p">,</span> <span class="n">search</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">((</span><span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">sales.csv í•©ê³„ë¥¼ êµ¬í•´ì¤˜</span><span class="sh">"</span><span class="p">)).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>ì •ë¦¬<br />
StdioClientTransport / SSEClientTransportê°€ â€œì—†ë‹¤â€ëŠ” ì—ëŸ¬ëŠ” ê±°ì˜ í•­ìƒ ëª¨ë“ˆ ê²½ë¡œ/ë²„ì „ ì°¨ì´ì—ì„œ ì˜¨ë‹¤. ìœ„ ì…°ì„ì„ ì“°ë©´ ì½”ë“œ í•œ ë²ˆìœ¼ë¡œ ì–‘ìª½ ê²½ë¡œë¥¼ ìë™ ì§€ì›í•  ìˆ˜ ìˆê³ , ê·¸ë˜ë„ ì•ˆ ë˜ë©´ Agents SDKì˜ ë‚´ì¥ MCP ì»¤ë„¥í„°ë¡œ íŠ¸ëœìŠ¤í¬íŠ¸ ê³„ì¸µì„ í†µì§¸ë¡œ ë§¡ê²¨ ë²„ë¦¬ëŠ” ê²ƒë„ ê¹”ë”í•œ í•´ê²°ì±…ì´ë‹¤.</p>

<p>ê³„ì† ì“°ëŠ” ìŠ¤íƒ€ì¼ì„ ì •ë¦¬í•˜ìë©´</p>

<ol>
  <li>
    <p>ì§ì ‘ SDKë¥¼ ì“¸ ê±°ë©´ mcp_compat.py ì…°ì„ìœ¼ë¡œ ê²½ë¡œ ì°¨ì´ë¥¼ í¡ìˆ˜</p>
  </li>
  <li>
    <p>ë¹ ë¥¸ í†µí•©ì´ë©´ Agents SDKì˜ MCPServerStdio/MCPServerSseë¥¼ ì‚¬ìš©</p>
  </li>
</ol>

<p>ì—¬ê¸°ê¹Œì§€ë¡œ ì•ˆ ì¡íˆë©´ ë„¤ <code class="language-plaintext highlighter-rouge">pip show mcp</code> ì¶œë ¥ê³¼ <code class="language-plaintext highlighter-rouge">python -c "import pkgutil; import mcp, sys; ..."</code> ê²°ê³¼ë¥¼ ì•Œë ¤ì¤˜. ê·¸ ì •ë³´ë¡œ ì •í™•í•œ ì„í¬íŠ¸ ê²½ë¡œë¥¼ ë”± ë§ì¶°ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ìŒ ê·¸ëƒ¥ FastMcp ì“°ëŠ”ê²Œ í¸í• ê²ƒ ê°™ë„¤. FastMCPì—ì„œ config = { 'mcpServers': { "weather": {"url": "https://weather-api.example.com/mcp"}, "assistant": {"command": "python", "args": ["./assistant_servers.py"]} } } client = Client(config) ë¥¼ í•˜ë©´ ë°”ë¡œ ë§Œë“¤ì–´ ì£¼ëŠ” ê²ƒ ê°™ê±°ë“ ? ê°ê°ì˜ McpSpecì—ì„œ ê°ê° í•œ ì¤„ì„ ë§Œë“œëŠ” í•¨ìˆ˜ ì‘ì„± + McpConfigì—ì„œ Config ìì²´ë¥¼ ë§Œë“œëŠ” í•¨ìˆ˜ ì‘ì„±í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„.

</p>

<p>ì¢‹ì•„, FastMCPë¥¼ ê¸°ì¤€ìœ¼ë¡œ â€œìŠ¤í™ â†’ í•œ ì¤„â€ê³¼ â€œìŠ¤í™ ëª¨ìŒ â†’ ìµœì¢… configâ€ë¥¼ ìë™ ìƒì„±í•˜ëŠ” ì–‡ì€ ë ˆì´ì–´ë¥¼ ë”± ë§Œë“¤ì–´ì¤„ê²Œ. ë„¤ê°€ ì›í•˜ëŠ” ê±´ ëŸ°íƒ€ì„ì´ ì•„ë‹ˆë¼ ì„ ì–¸ê°’ì´ë‹ˆ, McpSpecì€ ì„ ì–¸, McpConfigëŠ” ì»¬ë ‰ì…˜+ê²€ì¦+ì§ë ¬í™”ë§Œ ë§¡ëŠ”ë‹¤.</p>

<p>ì•„ë˜ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ë¶™ì—¬ ì“°ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_specs.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span>

<span class="n">Kind</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># FastMCP ê´€ì : ì›ê²©(url) ë˜ëŠ” ë¡œì»¬(stdio)
</span>
<span class="k">class</span> <span class="nc">McpSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">FastMCPì—ì„œ ì‚¬ìš©í•  ì„œë²„ ë¼ë²¨</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">Kind</span>
    <span class="c1"># url ì„œë²„
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># stdio ì„œë²„
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>           <span class="c1"># ì„ íƒ: í•„í„°ë§/ë¬¸ì„œí™”ì— ìœ ìš©
</span>    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>                       <span class="c1"># ì„ íƒ: ì‚¬ëŒ ì½ëŠ” ì„¤ëª…
</span>
    <span class="nd">@field_validator</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_name_non_empty</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">name must be non-empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">to_fastmcp_entry</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        FastMCP ì„¤ì •ì˜ </span><span class="sh">'</span><span class="s">í•œ ì¤„</span><span class="sh">'</span><span class="s">ì„ ë§Œë“ ë‹¤.
        ë°˜í™˜ ì˜ˆì‹œ:
          {</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">https://...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="s">: {...}}
          {</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="s">: [</span><span class="sh">"</span><span class="s">./server.py</span><span class="sh">"</span><span class="s">], </span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="s">: {...}}
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: url kind requires url</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">headers</span>
            <span class="k">return</span> <span class="n">entry</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: stdio kind requires command</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">command</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">args</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="k">return</span> <span class="n">entry</span>

        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: unknown kind </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">kind</span><span class="si">!r}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">McpSpec</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_topology</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">dupes</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate spec names: </span><span class="si">{</span><span class="nf">sorted</span><span class="p">(</span><span class="n">dupes</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: url is required for kind=</span><span class="sh">'</span><span class="s">url</span><span class="sh">'"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: command is required for kind=</span><span class="sh">'</span><span class="s">stdio</span><span class="sh">'"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_fastmcp_config</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">exclude_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">enable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">name_alias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        FastMCPê°€ ë°”ë¡œ ë¨¹ëŠ” dictë¥¼ ë§Œë“ ë‹¤.
        ë°˜í™˜ ì˜ˆì‹œ:
          {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="s">: {...}, </span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="s">: {...}}}
        ì˜µì…˜:
          include_tags: ì§€ì •ëœ íƒœê·¸ê°€ í•˜ë‚˜ë¼ë„ ìˆëŠ” ìŠ¤í™ë§Œ í¬í•¨
          exclude_tags: ì§€ì •ëœ íƒœê·¸ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì œì™¸
          enable: {</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: True/False} í˜•íƒœì˜ on/off ì˜¤ë²„ë¼ì´ë“œ
          name_alias: {</span><span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">alias</span><span class="sh">"</span><span class="s">} í‚¤ ë³€ê²½(LLM/ì‚¬ëŒì—ê²Œ ë³´ì¼ ë¼ë²¨ ë°”ê¾¸ê¸°)
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">validate_topology</span><span class="p">()</span>
        <span class="n">servers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">include_tags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">tags</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exclude_tags</span> <span class="ow">and</span> <span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">exclude_tags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nf">set</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">tags</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">enable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">enable</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">key</span> <span class="o">=</span> <span class="n">name_alias</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name_alias</span> <span class="k">else</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span>
            <span class="n">servers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="nf">to_fastmcp_entry</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">servers</span><span class="p">}</span>

    <span class="c1"># í¸ì˜: ì²´ì´ë‹ ë“±ë¡
</span>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">McpSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">McpConfig</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span>
</code></pre></div></div>

<p>ê°„ë‹¨ ì‚¬ìš© ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì˜ˆì‹œ 1) ì§ˆë¬¸ì—ì„œ ì¤€ configë¥¼ ì½”ë“œë¡œ ìƒì„±
</span><span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpSpec</span><span class="p">,</span> <span class="n">McpConfig</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="p">[</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]),</span>
<span class="p">])</span>

<span class="n">fastmcp_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">()</span>
<span class="c1"># fastmcp_config == {
#   "mcpServers": {
#     "weather": {"url": "https://weather-api.example.com/mcp"},
#     "assistant": {"command": "python", "args": ["./assistant_servers.py"]}
#   }
# }
</span>
<span class="c1"># FastMCP í´ë¼ì´ì–¸íŠ¸ì— ê·¸ëŒ€ë¡œ íˆ¬ì…
# from fastmcp import Client
# client = Client(fastmcp_config)
</span></code></pre></div></div>

<p>íƒœê·¸/ë³„ì¹­/ë¶€ë¶„ ì‚¬ìš© ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">().</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">readonly</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">public</span><span class="sh">"</span><span class="p">])</span>
<span class="p">).</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./db_server.py</span><span class="sh">"</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">MODE</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">prod</span><span class="sh">"</span><span class="p">},</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">write</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">internal</span><span class="sh">"</span><span class="p">])</span>
<span class="p">).</span><span class="nf">add</span><span class="p">(</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">],</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">helper</span><span class="sh">"</span><span class="p">])</span>
<span class="p">)</span>

<span class="c1"># ì½ê¸° ì „ìš©ë§Œ í¬í•¨í•˜ê³ , weatherë¥¼ public-weatherë¡œ ë¼ë²¨ë§
</span><span class="n">fastmcp_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">(</span>
    <span class="n">include_tags</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">readonly</span><span class="sh">"</span><span class="p">],</span>
    <span class="n">name_alias</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">public-weather</span><span class="sh">"</span><span class="p">}</span>
<span class="p">)</span>
<span class="c1"># ê²°ê³¼:
# {"mcpServers": {"public-weather": {"url": "https://weather-api.example.com/mcp"}}}
</span></code></pre></div></div>

<p>ê²€ì¦ í¬ì¸íŠ¸ ìš”ì•½</p>

<ol>
  <li>
    <p>McpSpec.to_fastmcp_entryê°€ â€œurlâ€ê³¼ â€œstdioâ€ ì¼€ì´ìŠ¤ë¥¼ ê°ê° í•œ ì¤„ë¡œ ìƒì„±í•œë‹¤.</p>
  </li>
  <li>
    <p>McpConfig.to_fastmcp_configê°€ í•„í„°ë§ê³¼ on/off, ë³„ì¹­ì„ ì§€ì›í•œë‹¤.</p>
  </li>
  <li>
    <p>FastMCPì˜ Client(config) í˜¸ì¶œì— ë°”ë¡œ ë„£ì„ ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ë§Œë“ ë‹¤.</p>
  </li>
</ol>

<p>í™•ì¥ ì•„ì´ë””ì–´<br />
headers, envì— ë¹„ë°€ê°’ì´ ë“¤ì–´ê°€ë©´ McpConfigì—ì„œ ë³„ë„ ì‹œí¬ë¦¿ ì†ŒìŠ¤ë¡œ ë³‘í•©í•˜ëŠ” í›…ì„ ì¶”ê°€í•´ë„ ì¢‹ë‹¤.<br />
í…Œë„ŒíŠ¸ë³„ë¡œ enable dictë¥¼ ë°”ê¾¸ëŠ” ê²ƒë§Œìœ¼ë¡œ ë™ì¼ ìŠ¤í™ì—ì„œ ë‹¤ë¥¸ ë°°í¬ êµ¬ì„±ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.<br />
ë‚˜ì¤‘ì— Elicitation/Prompt ê°™ì€ ë©”íƒ€ê°€ í•„ìš”í•˜ë©´ McpSpecì— meta: Dict[str, Any] ì •ë„ë¥¼ ì¶”ê°€í•´ë„ ì§ë ¬í™” íë¦„ì—” ì˜í–¥ì´ ì—†ë‹¤.</p>

<p>ì´ë ‡ê²Œ ë‘ë©´ â€œê°ê°ì˜ McpSpecì—ì„œ ê°ê° í•œ ì¤„â€ê³¼ â€œMcpConfigì—ì„œ ìµœì¢… configâ€ê°€ ë‘˜ ë‹¤ í•œ ë²ˆì— í•´ê²°ëœë‹¤.</p>

<p class="chat--user">

ì•„ ê·¸ëŸ°ë° configê°€ ì—†ìœ¼ë©´ ì–´ë–»ê²Œ ë˜ì§€?

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸ë‹¤. â€œconfigê°€ ì—†ì„ ë•Œâ€ëŠ” ë‘ ê°€ì§€ë¥¼ ë¶„ë¦¬í•´ì„œ ìƒê°í•˜ë©´ ê¹”ë”í•˜ë‹¤.</p>

<ol>
  <li>FastMCP Client ë ˆë²¨ì—ì„œì˜ ê¸°ëŒ€ ë™ì‘<br />
ì¼ë°˜ì ìœ¼ë¡œ ClientëŠ” ìµœì†Œí•œ {"mcpServers": {}} í˜•íƒœì˜ ë”•ì…”ë„ˆë¦¬ë¥¼ ê¸°ëŒ€í•œë‹¤. ì™„ì „íˆ Noneì´ê±°ë‚˜ í‚¤ê°€ ì—†ìœ¼ë©´ ë‚´ë¶€ì—ì„œ KeyError/TypeError ë¥˜ê°€ ë‚  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤. ì•ˆì „í•˜ê²Œ ê°€ë ¤ë©´ ë‹¤ìŒì„ ì§€í‚¤ì.</li>
</ol>

<ul>
  <li>
    <p>ë¹„ì–´ ìˆì–´ë„ ëœë‹¤: ë¹ˆ ì„¤ì •ì€ ê³§ â€œì—°ê²°ëœ MCP ì„œë²„ ì—†ìŒâ€ì´ë‹ˆ, ClientëŠ” ëœ¨ì§€ë§Œ íˆ´ì€ ì—†ë‹¤.</p>
  </li>
  <li>
    <p>í‚¤ëŠ” ë°˜ë“œì‹œ ìˆì–´ì•¼ í•œë‹¤: {"mcpServers": {}} í˜•íƒœë¥¼ ë³´ì¥í•˜ì.</p>
  </li>
  <li>
    <p>ì˜ëª»ëœ í˜•íƒœëŠ” ë§‰ì: ë¬¸ìì—´ì´ë‚˜ ë¦¬ìŠ¤íŠ¸ ê°™ì€ íƒ€ì…ì´ ë“¤ì–´ê°€ë©´ ë°”ë¡œ ì˜ˆì™¸ë¥¼ ë˜ì§€ê²Œ í•˜ì.</p>
  </li>
</ul>

<ol>
  <li>ë„¤ ì„ ì–¸ ê³„ì¸µ(McpSpec / McpConfig)ì—ì„œì˜ ë°©ì–´ ì „ëµ<br />
ëŸ°íƒ€ì„ì„ ë‹¤ë£¨ì§€ ì•Šê¸°ë¡œ í–ˆìœ¼ë‹ˆ, ì„ ì–¸-ì§ë ¬í™” ë‹¨ê³„ì—ì„œ ë‹¤ìŒì˜ fallbacksë¥¼ ë‘ë©´ ì‹¤ì „ì—ì„œ í¸í•˜ë‹¤.</li>
</ol>

<ul>
  <li>
    <p>configê°€ Noneì´ë©´ ë¹ˆ êµ¬ì¡°ë¡œ ë§Œë“¤ì–´ ì¤€ë‹¤.</p>
  </li>
  <li>
    <p>mcpServers í‚¤ê°€ ì—†ìœ¼ë©´ ìƒì„±í•´ ì¤€ë‹¤.</p>
  </li>
  <li>
    <p>specsê°€ ë¹„ì–´ ìˆìœ¼ë©´ ë¹ˆ ë”•ì…”ë„ˆë¦¬ë¥¼ ë„£ë˜, ë¡œê±° ê²½ê³ ë¥¼ ë‚¨ê¸´ë‹¤.</p>
  </li>
  <li>
    <p>í™˜ê²½ë³€ìˆ˜ë‚˜ ê¸°ë³¸ íŒŒì¼ ê²½ë¡œì—ì„œ ìë™ìœ¼ë¡œ ëŒì–´ì˜¤ëŠ” ì„ íƒì§€ë¥¼ ë‘”ë‹¤(ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë¹ˆ dict).</p>
  </li>
</ul>

<p>ì•„ë˜ í—¬í¼ë¥¼ ë„£ìœ¼ë©´ ì‹¤ìˆ˜í•´ë„ ì•ˆì „í•˜ê²Œ ë™ì‘í•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fastmcp_guard.py
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="c1"># ì´ì „ì— ë§Œë“  ì„ ì–¸ ëª¨ë¸ì´ë¼ê³  ê°€ì •
# from fastmcp_specs import McpSpec, McpConfig
</span>
<span class="k">def</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="sh">"</span><span class="s">McpSpec</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>     <span class="c1"># ë¬¸ìì—´ ì¸ìš©ì€ ìˆœí™˜ import íšŒí”¼ìš©
</span>    <span class="n">env_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">FASTMCP_SERVERS_JSON</span><span class="sh">"</span><span class="p">,</span>       <span class="c1"># ì˜µì…˜: {"weather":{"url":"..."}, "assistant":{...}} í˜•íƒœ
</span>    <span class="n">file_env_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">FASTMCP_CONFIG_PATH</span><span class="sh">"</span>    <span class="c1"># ì˜µì…˜: JSON íŒŒì¼ ê²½ë¡œ
</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    1ìˆœìœ„: ëª…ì‹œ config
    2ìˆœìœ„: specs â†’ {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: {...}} ì§ë ¬í™”
    3ìˆœìœ„: í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¡œë“œ
    4ìˆœìœ„: ë¹ˆ ì„¤ì •ìœ¼ë¡œ í´ë°±
    í•­ìƒ {</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="s">: dict} í˜•íƒœë¥¼ ë³´ì¥í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="c1"># 1) ëª…ì‹œ config
</span>    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">config must be a dict or None</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="c1"># ë¶€ë¶„ ì„¤ì •ë§Œ ì˜¨ ê²½ìš° ë³´ì™„
</span>            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)}</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="c1"># 2) specs â†’ ì§ë ¬í™”
</span>    <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpConfig</span>  <span class="c1"># ì§€ì—­ ì„í¬íŠ¸ë¡œ ìˆœí™˜ ì°¸ì¡° íšŒí”¼
</span>        <span class="n">cfg</span> <span class="o">=</span> <span class="nc">McpConfig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">to_fastmcp_config</span><span class="p">()</span>

    <span class="c1"># 3) í™˜ê²½ë³€ìˆ˜: íŒŒì¼ ê²½ë¡œ ìš°ì„ 
</span>    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">file_env_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># íŒŒì¼ì´ {"mcpServers":{...}} í˜•íƒœì´ê±°ë‚˜ {"weather":{...}} ê°™ì€ ë§µì¼ ìˆ˜ë„ ìˆìŒ
</span>        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">file config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">file config must be a dict</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">env config[</span><span class="sh">'</span><span class="s">mcpServers</span><span class="sh">'</span><span class="s">] must be a dict</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">env config must be a dict</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 4) ìµœì¢… í´ë°±: ë¹ˆ ì„¤ì •
</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
</code></pre></div></div>

<p>ì¦‰ì‹œ ì‚¬ìš© ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1) configê°€ Noneì¸ ìƒí™©
</span><span class="kn">from</span> <span class="n">fastmcp_guard</span> <span class="kn">import</span> <span class="n">ensure_fastmcp_config</span>
<span class="c1"># from fastmcp import Client
</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>  <span class="c1"># {"mcpServers": {}}
# client = Client(cfg)  # íˆ´ ì—†ì´ ì‹¤í–‰
</span>
<span class="c1"># 2) McpSpecë§Œ ìˆê³  configê°€ ì—†ëŠ” ìƒí™©
</span><span class="kn">from</span> <span class="n">fastmcp_specs</span> <span class="kn">import</span> <span class="n">McpSpec</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">McpSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]),</span>
<span class="p">]</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>
<span class="c1"># client = Client(cfg)
</span>
<span class="c1"># 3) í™˜ê²½ë³€ìˆ˜ë¡œë§Œ ê³µê¸‰í•˜ëŠ” ìƒí™©
# export FASTMCP_SERVERS_JSON='{"weather":{"url":"https://weather-api.example.com/mcp"}}'
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">ensure_fastmcp_config</span><span class="p">()</span>
<span class="c1"># client = Client(cfg)
</span></code></pre></div></div>

<p>ìš´ì˜ íŒ í•œ ì¤„ ìš”ì•½<br />
ë¹ˆ ì„¤ì •ì€ í—ˆìš©í•˜ë˜ í˜•íƒœëŠ” í•­ìƒ ë³´ì¥í•˜ì. ì¦‰, ìµœì†Œ {"mcpServers": {}}ë¥¼ ë§Œë“¤ì–´ì„œ Clientê°€ ì•ˆì •ì ìœ¼ë¡œ ëœ¨ê²Œ í•˜ê³ , ì‹¤ì œ ì„œë²„ ì—†ìœ¼ë©´ â€œíˆ´ ì—†ìŒâ€ ìƒíƒœë¡œë§Œ ë™ì‘í•˜ê²Œ í•˜ëŠ” ê²Œ ì œì¼ ì•ˆì „í•˜ë‹¤. í•„ìš”í•˜ë©´ ensure_fastmcp_config ë‚´ë¶€ì— ë¡œê¹…ì„ ë„£ì–´ â€œí˜„ì¬ MCP ì„œë²„ 0ê°œâ€ ê°™ì€ ê²½ê³ ë¥¼ ë‚¨ê¸°ë©´ ì‹¤ìˆ˜ë„ ë¹¨ë¦¬ ì¡íŒë‹¤.</p>

<p class="chat--user">

ì´ë ‡ê²Œ ë§Œë“  FastMcp Clientì˜ íˆ´ê³¼ ë‚´ê°€ ë§Œë“  ì¼ë°˜ ToolSpecì„ ë‘˜ ë‹¤ ê³ ë ¤í•´ì„œ chat completions í˜¸ì¶œ -&gt; ê·¸ í›„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ ì‹¤í–‰ì„ ë§Œë“¤ê³  ì‹¶ì–´ async with Client(cfg) as client: client.list_tools() # mcp tool ë°˜í™˜ client.call_tool(í•¨ìˆ˜ëª…, ì¸ì) ì´ë ‡ê²Œ ì“¸ ìˆ˜ ìˆì–´. fastmcpëŠ” ì´ ë‘ ê°€ì§€ë¥¼ ì–´ë–»ê²Œ í•˜ë©´ ì˜ ì“°ê²Œ í•  ìˆ˜ ìˆì„ê¹Œ

</p>

<p>ì¢‹ì•„. ëª©í‘œëŠ” FastMCPì˜ íˆ´ë“¤ê³¼ ë„¤ê°€ ì§ì ‘ ì •ì˜í•œ ì¼ë°˜ ToolSpecë“¤ì„ â€œí•˜ë‚˜ì˜ íˆ´ ì„¸íŠ¸â€ì²˜ëŸ¼ ë¬¶ì–´ì„œ Chat Completions with toolsë¥¼ ëŒë¦¬ê³ , ëª¨ë¸ì´ ìš”ì²­í•œ tool_callsë¥¼ ê°ê° ì•Œë§ì€ ì‹¤í–‰ê¸°ë¡œ ë¼ìš°íŒ…í•˜ëŠ” ê²ƒ. ì•„ë˜ ìŠ¤ìºí´ë”©ì€ ê·¸ëŒ€ë¡œ ë¶™ì—¬ì„œ ëŒì•„ê°€ë„ë¡ ì„¤ê³„í–ˆë‹¤.</p>

<p>í•µì‹¬ ì•„ì´ë””ì–´</p>

<ol>
  <li>
    <p>FastMCPì˜ client.list_tools() ê²°ê³¼ë¥¼ OpenAI tools í¬ë§·ìœ¼ë¡œ ì •ê·œí™”í•˜ê³  ì´ë¦„ì— ì ‘ë‘ì‚¬ mcp:ë¥¼ ë¶™ì¸ë‹¤.</p>
  </li>
  <li>
    <p>ë„¤ ë¡œì»¬ ToolSpecë“¤ë„ ê°™ì€ í¬ë§·ìœ¼ë¡œ ì§ë ¬í™”í•œë‹¤.</p>
  </li>
  <li>
    <p>Chat Completions ì²« í˜¸ì¶œì— ë‘ ì¢…ë¥˜ íˆ´ì„ ëª¨ë‘ ë„£ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>tool_calls ë£¨í”„ì—ì„œ ì´ë¦„ì´ mcp:ë©´ client.call_toolë¡œ, ì•„ë‹ˆë©´ LocalToolRegistry í•¸ë“¤ëŸ¬ë¡œ ì‹¤í–‰í•œë‹¤.</p>
  </li>
</ol>

<p>ì½”ë“œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># unified_fastmcp_chat.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">orjson</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="c1">###############################################################################
# 0) ë¡œì»¬ ToolSpec ì •ì˜(í•œ ë²ˆë§Œ êµ¬í˜„í•´ì„œ ê³µí†µ ì‚¬ìš©)
###############################################################################
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">LocalToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicate tool: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_openai_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_m</span><span class="p">.</span><span class="nf">values</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# 1) FastMCP â†’ OpenAI tools ì •ê·œí™”
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">
    FastMCP client.list_tools()ë¥¼ í˜¸ì¶œí•´ OpenAI tools í¬ë§·ìœ¼ë¡œ ë³€í™˜.
    ê° ì´ë¦„ì—ëŠ” </span><span class="sh">'</span><span class="s">mcp:</span><span class="sh">'</span><span class="s"> ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ ë¡œì»¬ íˆ´ê³¼ ì¶©ëŒì„ ë°©ì§€.
    FastMCP íˆ´ ë©”íƒ€ëŠ” ë‹¤ìŒ í•„ë“œë¥¼ ê°€ì§„ë‹¤ê³  ê°€ì •: name, description, parameters(JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">def</span> <span class="nf">is_mcp_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">strip_mcp_prefix</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tool_name</span><span class="p">[</span><span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span> <span class="k">if</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">else</span> <span class="n">tool_name</span>

<span class="c1">###############################################################################
# 2) Chat Completions í˜¸ì¶œ ëŸ¬ë„ˆ(ë‘ íˆ´ ì„¸íŠ¸ë¥¼ í•œêº¼ë²ˆì— ë…¸ì¶œ)
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">local_registry</span><span class="p">:</span> <span class="n">LocalToolRegistry</span><span class="p">,</span>
        <span class="n">fastmcp_client</span><span class="p">,</span>
        <span class="n">expose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mcp:</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 1) íˆ´ ì¹´íƒˆë¡œê·¸ í•©ì¹˜ê¸°
</span>        <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">mcp_tools_for_openai</span><span class="p">(</span><span class="n">fastmcp_client</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">local_tools</span> <span class="o">=</span> <span class="n">local_registry</span><span class="p">.</span><span class="nf">list_openai_tools</span><span class="p">()</span>
        <span class="n">all_tools</span> <span class="o">=</span> <span class="n">local_tools</span> <span class="o">+</span> <span class="n">mcp_tools</span>
        <span class="k">if</span> <span class="n">expose</span><span class="p">:</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="nf">expose</span><span class="p">(</span><span class="n">all_tools</span><span class="p">)</span>  <span class="c1"># í„´ë³„ ì†Œì¶œ ì •ì±…(ì„ íƒ)
</span>
        <span class="c1"># 2) 1ì°¨ ëª¨ë¸ í˜¸ì¶œ
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># 3) tool_calls ë£¨í”„
</span>        <span class="n">rounds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">rounds</span> <span class="o">&lt;</span> <span class="n">max_rounds</span><span class="p">:</span>
            <span class="n">rounds</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw</span><span class="p">}</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nf">is_mcp_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">):</span>
                        <span class="c1"># FastMCP ê²½ë¡œ
</span>                        <span class="n">mcp_name</span> <span class="o">=</span> <span class="nf">strip_mcp_prefix</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fastmcp_client</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">mcp_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ë¡œì»¬ íˆ´ ê²½ë¡œ
</span>                        <span class="n">spec</span> <span class="o">=</span> <span class="n">local_registry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span>
                <span class="p">})</span>

            <span class="c1"># ë‹¤ìŒ í„´
</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# 3) ì‚¬ìš© ì˜ˆì‹œ
###############################################################################
</span>
<span class="c1"># ì˜ˆì‹œ ë¡œì»¬ íˆ´ êµ¬í˜„
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) FastMCP í´ë¼ì´ì–¸íŠ¸ ì¤€ë¹„
</span>    <span class="c1"># from fastmcp import Client
</span>    <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">mcpServers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">weather</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://weather-api.example.com/mcp</span><span class="sh">"</span><span class="p">},</span>
            <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">./assistant_servers.py</span><span class="sh">"</span><span class="p">]}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># async with Client(cfg) as client:
</span>    <span class="c1">#     ...
</span>
    <span class="c1"># ë°ëª¨ë¥¼ ìœ„í•´ ê°„ì´ ë”ë¯¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ í‰ë‚´ë‚´ì. ì‹¤ì œë¡œëŠ” fastmcp.Clientë¥¼ ì‚¬ìš©.
</span>    <span class="k">class</span> <span class="nc">DummyFastMCP</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">self</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
            <span class="c1"># ì´ë¦„ì€ ì„œë²„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í¬í•¨í•´ì£¼ë©´ LLMì´ ë” ì˜ ê³ ë¥¸ë‹¤
</span>            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">weather:get_forecast</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë„ì‹œ/ë‚ ì§œë³„ ì¼ê¸°ì˜ˆë³´</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">}},</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">city</span><span class="sh">"</span><span class="p">]</span>
                <span class="p">}},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant:read_csv_sum</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CSV í•©ê³„ ê³„ì‚°</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span> <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">]</span>
                <span class="p">}}</span>
            <span class="p">]</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="c1"># ì—¬ê¸°ì„œëŠ” ê²°ê³¼ í˜•íƒœë§Œ ë§ì¶°ì¤€ë‹¤
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo-result</span><span class="sh">"</span><span class="p">}</span>

    <span class="c1"># 1) ë¡œì»¬ íˆ´ ë ˆì§€ìŠ¤íŠ¸ë¦¬
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolRegistry</span><span class="p">()</span>
    <span class="n">local</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚°</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span><span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
        <span class="n">handler</span><span class="o">=</span><span class="n">math_eval</span>
    <span class="p">))</span>

    <span class="c1"># 2) ëŸ¬ë„ˆ
</span>    <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 3) í†µí•© ì‹¤í–‰
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">í•„ìš”í•œ ë„êµ¬ë§Œ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_run ìš°ì„ .</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">assistant:read_csv_sumìœ¼ë¡œ data/sales.csv í•©ê³„ë¥¼ êµ¬í•˜ê³ , local.math_evalë¡œ (100+23)ë„ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">async</span> <span class="k">with</span> <span class="nc">DummyFastMCP</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">local_registry</span><span class="o">=</span><span class="n">local</span><span class="p">,</span> <span class="n">fastmcp_client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== FINAL ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ìš´ì˜ í¬ì¸íŠ¸<br />
ì´ë¦„ ê·œì¹™ì„ ê³ ì •í•˜ì. mcp: ì ‘ë‘ì‚¬ë¡œ FastMCPì—ì„œ ì˜¨ íˆ´ì„ í‘œì‹œí•˜ë©´ ì¶©ëŒì„ ë°©ì§€í•˜ê³  ë¼ìš°íŒ…ì´ ë‹¨ìˆœí•´ì§„ë‹¤. FastMCP ìª½ íˆ´ ì´ë¦„ì— ì´ë¯¸ server:tool í˜•íƒœê°€ ë“¤ì–´ê°€ ìˆì–´ë„ ìƒê´€ì—†ë‹¤. ìµœì¢… ë…¸ì¶œëª…ì€ mcp:server:toolì²˜ëŸ¼ ë˜ì§€ë§Œ LLMì´ ì˜ì™¸ë¡œ ì˜ ê³ ë¥¸ë‹¤.<br />
íˆ´ ì†Œì¶œì„ ë„£ì. expose ì½œë°±ìœ¼ë¡œ í„´ë³„ë¡œ í•„ìš”í•œ ì„œë¸Œì…‹ë§Œ toolsì— ë‹´ìœ¼ë©´ ì„ íƒ ì˜¤ë¥˜ì™€ ì§€ì—°ì´ ì¤„ì–´ë“ ë‹¤.<br />
ê²°ê³¼ í¬ë§·ì„ í†µì¼í•˜ì. tool role ë©”ì‹œì§€ contentëŠ” í•­ìƒ JSON ë¬¸ìì—´ë¡œ ë„£ëŠ” ê²Œ í›„ì† ë¼ìš´ë“œì—ì„œ ì•ˆì •ì ì´ë‹¤.<br />
ì—ëŸ¬ëŠ” JSONìœ¼ë¡œ. ì‹¤í–‰ê¸° ì—ëŸ¬ë„ {"error": "â€¦"}ë¡œ í†µì¼í•´ ëª¨ë¸ì´ ë³µêµ¬ í”Œëœì„ ì„¸ìš°ê¸° ì¢‹ê²Œ ë§Œë“ ë‹¤.</p>

<p>ì´ êµ¬ì¡°ë©´ FastMCPê°€ ì œê³µí•˜ëŠ” íˆ´ê³¼ ë„¤ ë¡œì»¬ ToolSpecì„ ë™ì‹œì— ë“¤ê³ , í‘œì¤€ Chat Completions ë£¨í”„ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ì“¸ ìˆ˜ ìˆë‹¤. í•„ìš”í•œ ê²½ìš° expose ì •ì±…, ì´ë¦„ ë³„ì¹­, ê¸°ë³¸ ì¸ì ì£¼ì… ê°™ì€ ì •ì±… í›…ì„ runner.runì˜ ì¸ìë¡œ ì–¹ì–´ í™•ì¥í•˜ë©´ ëœë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python MCP ì—°ê²° ë°©ë²•</title><link href="https://hvppyarchive.github.io/llm/unified-mcp-interface/" rel="alternate" type="text/html" title="Python MCP ì—°ê²° ë°©ë²•" /><published>2025-10-28T20:16:40+09:00</published><updated>2025-10-28T20:16:40+09:00</updated><id>https://hvppyarchive.github.io/llm/unified-mcp-interface</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/unified-mcp-interface/"><![CDATA[<p class="chat--user">

ë„ˆëŠ” LLM Agent ì „ë¬¸ê°€ì•¼. MCP ë‘ ê°œ ì´ìƒ(ì´ê±´ ì…ë ¥ìœ¼ë¡œ ì»¤ë§¨ë“œë¥¼ ì—¬ëŸ¬ê°œ ë°›ì„ ìˆ˜ ìˆì–´)ì„ ë„ìš°ê³  ëª¨ë“  MCP íˆ´ì„ LLMì—ê²Œ ì „ë‹¬ ë° ì‹¤í–‰í•˜ê³  ì‹¶ì–´. 

</p>

<p>ì¢‹ì•„, ì—¬ëŸ¬ ê°œì˜ MCP ì„œë²„ë¥¼ ë™ì‹œì— ë¶™ì—¬ì„œ â€œëª¨ë“  MCP íˆ´ì„ LLMì´ í•œ ë²ˆì— ë³´ê³  ì‹¤í–‰â€í•˜ê²Œ ë§Œë“œëŠ” ë°©ë²•ì„ ë‘ ê°€ì§€ ê²½ë¡œë¡œ ì •ë¦¬í•´ì¤„ê²Œ. ì²«ì§¸ëŠ” Anthropic Messages APIì˜ MCP ì»¤ë„¥í„°ë¥¼ ê·¸ëŒ€ë¡œ ì“°ëŠ” ë°©ë²•(ê°€ì¥ ê°„ë‹¨). ë‘˜ì§¸ëŠ” ì§ì ‘ MCP í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ì–´ ì—¬ëŸ¬ ì„œë²„ì— ë¶™ê³ , íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ í•©ì³ì„œ LLMì—ê²Œ ì œê³µí•˜ëŠ” ë°©ë²•(ì»¤ìŠ¤í…€ ì œì–´). ë‹¨ê³„ë³„ë¡œ ë°”ë¡œ ë”°ë¼í•˜ë©´ ëœë‹¤. ì¸ìš©êµ¬ë¬¸ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.</p>

<h1 id="1-ê°€ì¥-ì‰¬ìš´-ê¸¸-claude-messages-apiì˜-mcp-ì»¤ë„¥í„°ë¡œ-ì—¬ëŸ¬-ì„œë²„-ë¶™ì´ê¸°">1) ê°€ì¥ ì‰¬ìš´ ê¸¸: Claude Messages APIì˜ MCP ì»¤ë„¥í„°ë¡œ ì—¬ëŸ¬ ì„œë²„ ë¶™ì´ê¸°</h1>

<p>í•µì‹¬ì€ <code class="language-plaintext highlighter-rouge">messages.create</code> í˜¸ì¶œì— <code class="language-plaintext highlighter-rouge">mcp_servers</code> ë°°ì—´ì„ ë„£ì–´ ì—¬ëŸ¬ ì„œë²„ë¥¼ ë™ì‹œì— ì„ ì–¸í•˜ëŠ” ê²ƒ. ì„œë²„ë§ˆë‹¤ ì´ë¦„ì„ ë¶€ì—¬í•˜ë©´ ì¶©ëŒ ì—†ì´ íˆ´ì„ êµ¬ë¶„í•  ìˆ˜ ìˆê³ , ëª¨ë¸ì€ ê° ì„œë²„ì—ì„œ ë…¸ì¶œëœ MCP íˆ´ì„ í•„ìš”í•  ë•Œ í˜¸ì¶œí•œë‹¤. ë² íƒ€ í—¤ë”ê°€ í•„ìš”í•˜ë‹¤.</p>

<p>ìš”ì²­ ë°”ë”” ì˜ˆì‹œ(ë‘˜ ì´ìƒì˜ ì„œë²„ ì—°ê²°):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">"claude-sonnet-4-5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"max_tokens"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë‘ ì„œë²„ì˜ íˆ´ì„ ëª¨ë‘ í™œìš©í•´ì„œ ì‘ì—…ì„ ëë‚´ì¤˜"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"mcp_servers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example1.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tool_configuration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://mcp.example2.com/sse"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mcp-server-2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authorization_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TOKEN2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ì´ ë°©ì‹ì˜ í¬ì¸íŠ¸</p>

<ol>
  <li>
    <p>í•œ ìš”ì²­ì—ì„œ ì—¬ëŸ¬ MCP ì„œë²„ì˜ íˆ´ì„ ëª¨ë‘ ë…¸ì¶œí•  ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ì„œë²„ ì´ë¦„(<code class="language-plaintext highlighter-rouge">name</code>)ì´ íˆ´ í˜¸ì¶œ ë¸”ë¡ì— í•¨ê»˜ ë“¤ì–´ê°€ì„œ ì¶©ëŒì„ í”¼í•œë‹¤.</p>
  </li>
  <li>
    <p>í˜„ì¬ëŠ” â€œMCPì˜ íˆ´ í˜¸ì¶œâ€ë§Œ ì§€ì›(ë¦¬ì†ŒìŠ¤/í”„ë¡¬í”„íŠ¸ ë“±ì€ ì œì™¸)ë˜ê³ , HTTPë¡œ ê³µê°œëœ ì›ê²© ì„œë²„ë§Œ ì§ì ‘ ì—°ê²°ëœë‹¤(ë¡œì»¬ stdioëŠ” ë¶ˆê°€). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>
  </li>
</ol>

<p>ë¬¸ì„œ ê·¼ê±°ì™€ ìŠ¤í™<br />
â€¢ MCP ì»¤ë„¥í„° ì‚¬ìš©ë²•ê³¼ ë©€í‹° ì„œë²„ ì˜ˆì‹œëŠ” Claude ê³µì‹ ë¬¸ì„œì˜ â€œMCP connectorâ€ì™€ â€œMultiple MCP serversâ€ ì„¹ì…˜ì— ê·¸ëŒ€ë¡œ ìˆë‹¤. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
â€¢ MCP ìì²´ ê°œë…ê³¼ ìŠ¤í™ì€ í”„ë¡œí† ì½œ ì‚¬ì´íŠ¸ì™€ ìŠ¤í™ ë¬¸ì„œ ì°¸ê³ . <a href="https://modelcontextprotocol.io/?utm_source=chatgpt.com">ëª¨ë¸ ì»¨í…ìŠ¤íŠ¸ í”„ë¡œí† ì½œ+1</a></p>

<p>ì´ ê²½ë¡œë¡œ ê°€ë©´ â€œLLMì—ê²Œ MCP íˆ´ ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ê³ , ì‹¤í–‰ì€ ëª¨ë¸ì´ ì•Œì•„ì„œ ì„œë²„ë³„ë¡œ ë¼ìš°íŒ…â€í•´ì¤€ë‹¤. ìš´ì˜ì—ì„œ OAuth í† í°ì´ í•„ìš”í•œ ì„œë²„ëŠ” <code class="language-plaintext highlighter-rouge">authorization_token</code> í•„ë“œë¡œ ì „ë‹¬í•˜ë©´ ëœë‹¤. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a></p>

<h1 id="2-ë”-ìœ ì—°í•œ-ê¸¸-ì§ì ‘-mcp-í´ë¼ì´ì–¸íŠ¸ë¥¼-ë§Œë“¤ì–´-ë©€í‹°-ì„œë²„--ë‹¨ì¼-íˆ´-ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ-í•©ì¹˜ê¸°">2) ë” ìœ ì—°í•œ ê¸¸: ì§ì ‘ MCP í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ì–´ â€œë©€í‹° ì„œë²„ â†’ ë‹¨ì¼ íˆ´ ë ˆì§€ìŠ¤íŠ¸ë¦¬â€ë¡œ í•©ì¹˜ê¸°</h1>

<p>ë¡œì»¬/ì‚¬ë‚´ìš© íˆ´ê¹Œì§€ ë‹¤ ì—®ê³  ì‹¶ê±°ë‚˜, íˆ´ ë…¸ì¶œ/ë¡œê·¸/ê¶Œí•œì„ ì„¬ì„¸í•˜ê²Œ í†µì œí•˜ë ¤ë©´ ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“œëŠ” í¸ì´ ì¢‹ë‹¤. ê³µì‹ SDKê°€ ìˆë‹¤(íƒ€ì…ìŠ¤í¬ë¦½íŠ¸, íŒŒì´ì¬ ë“±). <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub+1</a></p>

<p>ì•„í‚¤í…ì²˜ ê°œìš”</p>

<ol>
  <li>
    <p>ê° MCP ì„œë²„ì™€ ë³„ë„ì˜ ì„¸ì…˜ìœ¼ë¡œ ì—°ê²°(stdio ë˜ëŠ” HTTP).</p>
  </li>
  <li>
    <p>ëª¨ë“  ì„œë²„ì—ì„œ <code class="language-plaintext highlighter-rouge">list_tools</code>ë¥¼ ë°›ì•„ í•©ì¹œë‹¤. ì´ë•Œ ì¶©ëŒì„ ë§‰ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">serverName:toolName</code> ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë¶™ì¸ë‹¤.</p>
  </li>
  <li>
    <p>í•©ì³ì§„ íˆ´ ëª©ë¡ì„ LLMì˜ â€œë„êµ¬(Function/Tool Use)â€ë¡œ ë“±ë¡í•œë‹¤.</p>
  </li>
  <li>
    <p>LLMì´ <code class="language-plaintext highlighter-rouge">serverName:toolName</code>ì„ í˜¸ì¶œí•˜ë©´, í•´ë‹¹ ì„œë²„ ì„¸ì…˜ìœ¼ë¡œ ë¼ìš°íŒ…í•´ì„œ <code class="language-plaintext highlighter-rouge">call_tool</code> ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ ëª¨ë¸ì— <code class="language-plaintext highlighter-rouge">tool_result</code>ë¡œ ë˜ëŒë¦°ë‹¤.</p>
  </li>
</ol>

<p>ì˜ˆì‹œ ì½”ë“œ(íƒ€ì…ìŠ¤í¬ë¦½íŠ¸, Node). ì—¬ëŸ¬ ì„œë²„ì—ì„œ íˆ´ì„ ëª¨ì•„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤í™”í•˜ê³ , í˜¸ì¶œ ì‹œ ë¼ìš°íŒ…í•œë‹¤. SDKëŠ” ê³µì‹ TS SDKë¥¼ ì‚¬ìš©í•œë‹¤. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

// package.json: @modelcontextprotocol/sdk, zod, anthropic ë“± ì„¤ì¹˜ ê°€ì •
// npm i @modelcontextprotocol/sdk zod anthropic

import { ClientSession } from '@modelcontextprotocol/sdk/client/session.js';
import { StdioClientTransport, StdioServerParameters } from '@modelcontextprotocol/sdk/client/stdio.js';
import Anthropic from '@anthropic-ai/sdk';

// ì„œë²„ ì„¤ì •
type ServerCfg = { name: string; command: string; args: string[] };
const SERVERS: ServerCfg[] = [
  { name: 'files', command: 'node', args: ['./servers/files/index.js'] },
  { name: 'db', command: 'python', args: ['./servers/db/server.py'] },
];

type Connected = {
  name: string;
  session: ClientSession;
};

const connected: Connected[] = [];

async function connectAll() {
  for (const s of SERVERS) {
    const params: StdioServerParameters = { command: s.command, args: s.args };
    const transport = new StdioClientTransport(params);
    await transport.start();
    const session = new ClientSession(transport);
    await session.initialize();
    connected.push({ name: s.name, session });
    console.log(`[MCP] connected: ${s.name}`);
  }
}

type ToolDesc = {
  name: string;              // namespaced: `${server}:${tool}`
  description?: string;
  input_schema: any;         // JSON Schema
};

// ëª¨ë“  ì„œë²„ì˜ íˆ´ì„ ìˆ˜ì§‘í•˜ì—¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶€ì—¬
async function collectTools(): Promise&lt;ToolDesc[]&gt; {
  const all: ToolDesc[] = [];
  for (const { name: serverName, session } of connected) {
    const { tools } = await session.listTools();
    for (const t of tools) {
      all.push({
        name: `${serverName}:${t.name}`,
        description: t.description,
        input_schema: t.inputSchema,
      });
    }
  }
  return all;
}

// LLMì´ namespaced íˆ´ì„ í˜¸ì¶œí•˜ë©´ í•´ë‹¹ ì„œë²„ë¡œ ë¼ìš°íŒ…
async function callNamespacedTool(nsName: string, args: any) {
  const [serverName, toolName] = nsName.split(':');
  const target = connected.find(c =&gt; c.name === serverName);
  if (!target) throw new Error(`Server not found: ${serverName}`);
  return target.session.callTool(toolName, args);
}

async function main() {
  await connectAll();
  const tools = await collectTools();

  const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! });

  // ëŒ€í™” ë£¨í”„ì˜ í•œ í„´ ì˜ˆì‹œ
  let messages: any[] = [{ role: 'user', content: 'CSVë¥¼ DBì— ì ì¬í•˜ê³  ìš”ì•½í•´ì¤˜' }];

  // Anthropicì˜ Tool Use í¬ë§·ì— ë§ì¶° íˆ´ ì „ë‹¬
  const toolDefs = tools.map(t =&gt; ({
    name: t.name,
    description: t.description,
    input_schema: t.input_schema,
  }));

  let resp = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 1000,
    messages,
    tools: toolDefs,
  });

  // tool_use ì²˜ë¦¬ ë£¨í”„
  while (resp.content.some((c: any) =&gt; c.type === 'tool_use')) {
    const assistantContent: any[] = [];
    const toolResults: any[] = [];

    for (const c of resp.content) {
      if (c.type === 'text') assistantContent.push(c);
      if (c.type === 'tool_use') {
        const result = await callNamespacedTool(c.name, c.input);
        toolResults.push({
          type: 'tool_result',
          tool_use_id: c.id,
          content: result.content, // MCP í‘œì¤€ content ë°°ì—´
        });
      }
    }

    messages.push({ role: 'assistant', content: assistantContent.concat(resp.content.filter((c: any) =&gt; c.type === 'tool_use')) });
    messages.push({ role: 'user', content: toolResults });

    resp = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1000,
      messages,
      tools: toolDefs,
    });
  }

  console.log(resp.content.map((c: any) =&gt; (c.type === 'text' ? c.text : '')).join('\n'));
}

main().catch(e =&gt; { console.error(e); process.exit(1); });
</code></pre></div></div>

<p>ì´ íŒ¨í„´ì˜ ì¥ì <br />
â€¢ ì–´ë–¤ LLMì´ë“ (Anthropic/OpenAI/ë¡œì»¬) í‘œì¤€ â€œíˆ´ í˜¸ì¶œâ€ ì¸í„°í˜ì´ìŠ¤ë§Œ ìˆìœ¼ë©´ ê°™ì€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì¬í™œìš©í•  ìˆ˜ ìˆë‹¤.<br />
â€¢ ì„œë²„ë³„ ê¶Œí•œ, ë¡œê¹…, ë ˆì´íŠ¸ ë¦¬ë°‹, ì…ë ¥ ê²€ì¦ì„ ì¤‘ì•™ì—ì„œ í†µì œ ê°€ëŠ¥.<br />
â€¢ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì „ëµìœ¼ë¡œ íˆ´ ì´ë¦„ ì¶©ëŒì„ í™•ì‹¤íˆ ë°©ì§€.<br />
â€¢ stdio ë¡œì»¬ ì„œë²„ì™€ ì›ê²© HTTP ì„œë²„ë¥¼ ì„ì–´ì„œ ë¶™ì¼ ìˆ˜ ìˆë‹¤(ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ ë°©ì‹ì´ë¯€ë¡œ). SDKê°€ stdio/HTTP ëª¨ë‘ ì§€ì›í•œë‹¤. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>ì„¤ì¹˜Â·ì°¸ê³ <br />
â€¢ ê³µì‹ TS SDKì™€ ì˜ˆì œ ì„œë²„/í´ë¼ì´ì–¸íŠ¸, Streamable HTTP/stdio ì „ì†¡ê³„ì¸µì€ ê¹ƒí—ˆë¸Œ READMEì™€ ì˜ˆì œì— ìƒì„¸. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a><br />
â€¢ â€œBuild an MCP clientâ€ íŠœí† ë¦¬ì–¼(íŒŒì´ì¬/ë…¸ë“œ í¬í•¨)ë„ ë©€í‹° ì„œë²„ë¡œ í™•ì¥í•˜ê¸° ì‰½ë‹¤. ìœ„ ì˜ˆì‹œ ë¡œì§ì€ ê·¸ íë¦„ì„ ì¼ë°˜í™”í•œ ê²ƒ. <a href="https://modelcontextprotocol.io/quickstart/client">ëª¨ë¸ ì»¨í…ìŠ¤íŠ¸ í”„ë¡œí† ì½œ</a></p>

<h1 id="ìš´ì˜-íŒê³¼-í•¨ì •ì‹¤ë¬´-ì²´í¬ë¦¬ìŠ¤íŠ¸">ìš´ì˜ íŒê³¼ í•¨ì •(ì‹¤ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸)</h1>

<p>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê·œì¹™<br />
â€¢ <code class="language-plaintext highlighter-rouge">${server}:${tool}</code>ë¡œ ê³ ì •í•˜ë©´ ë¼ìš°íŒ…ì´ ë‹¨ìˆœí•´ì§„ë‹¤. íˆ´ ì„¤ëª…ì—ë„ ì„œë²„ëª…ì„ ì ì–´ LLMì˜ ì„ íƒì„ ë•ëŠ”ë‹¤.<br />
â€¢ ëª¨ë¸ì´ â€œë¹„ìŠ·í•œ ë‘ íˆ´â€ì„ í˜¼ë™í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì„¤ëª…ì— ì°¨ì´ë¥¼ ëª…í™•íˆ ì“°ê³  ìŠ¤í‚¤ë§ˆì— ì œì•½ì„ ë„£ëŠ”ë‹¤.</p>

<p>ê¶Œí•œê³¼ ì•ˆì „ì¥ì¹˜<br />
â€¢ ì„œë²„ë³„ <code class="language-plaintext highlighter-rouge">allowed_tools</code>ë¡œ ë…¸ì¶œ íˆ´ì„ ì œí•œí•˜ê±°ë‚˜, ìì²´ í´ë¼ì´ì–¸íŠ¸ë¼ë©´ íˆ´ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¥¼ ì ìš©í•œë‹¤. <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
â€¢ íŒŒê´´ì  íˆ´(ì‚­ì œ/ê²°ì œ ë“±)ì€ â€œdry_runâ€ í”Œë˜ê·¸ë¥¼ ìŠ¤í‚¤ë§ˆì— ì¶”ê°€í•´ 2ë‹¨ê³„ í™•ì¸ì„ ê°•ì œ.<br />
â€¢ í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì§€: ì„œë²„ ì¸¡ì—ì„œ ì…ë ¥ ê²€ì¦ê³¼ URL/ê²½ë¡œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¥¼ ë‘”ë‹¤.</p>

<p>ì„±ëŠ¥/ì•ˆì •ì„±<br />
â€¢ ì´ˆê¸°ì— ëª¨ë“  ì„œë²„ì— <code class="language-plaintext highlighter-rouge">list_tools</code>ë¥¼ í•œ ë²ˆë§Œ í˜¸ì¶œí•˜ê³  ìºì‹±í•˜ë¼.<br />
â€¢ íˆ´ í˜¸ì¶œì€ íƒ€ì„ì•„ì›ƒê³¼ ì¬ì‹œë„ë¥¼ ë‘”ë‹¤. ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ì™€ ë³µêµ¬ íŒíŠ¸ë¥¼ ëª¨ë¸ì—ê²Œ ì§§ê²Œ ì œê³µí•˜ë©´ í›„ì† ê³„íšì„ ëª¨ë¸ì´ ìŠ¤ìŠ¤ë¡œ ì¡°ì •í•œë‹¤.<br />
â€¢ ê²°ê³¼ê°€ í° ê²½ìš°(íŒŒì¼/í‘œ)ëŠ” ë¦¬ì†ŒìŠ¤ ë§í¬ë¥¼ ë°˜í™˜í•˜ë„ë¡ MCP ìª½ì—ì„œ ì„¤ê³„í•˜ë©´ í† í° ì••ë°•ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤(ë¦¬ì†ŒìŠ¤ëŠ” ì»¤ë„¥í„° ê²½ë¡œì— ë”°ë¼ ì œí•œë  ìˆ˜ ìˆìŒ).</p>

<p>ë°°í¬ í† ë§‰ ê°€ì´ë“œ<br />
â€¢ ì›ê²© ì—°ê²° ìœ„ì£¼ë©´ Claudeì˜ MCP ì»¤ë„¥í„°ê°€ ê°€ì¥ ë¹ ë¥¸ ì˜¨ë³´ë”©ì´ë‹¤(ë‹¨, HTTP ê³µê°œ í•„ìš”). <a href="https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector">docs.anthropic.com</a><br />
â€¢ ì‚¬ë‚´ë§Â·ë¡œì»¬ í˜¼í•©ì´ë©´ ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ êµ¬ì„±ì´ ìœ ë¦¬í•˜ë‹¤. TS SDKì˜ streamable HTTP + stdioë¥¼ í˜¼ìš©í•˜ë©´ ëœë‹¤. <a href="https://github.com/modelcontextprotocol/typescript-sdk">GitHub</a></p>

<p>ë‹¤ìŒ í™•ì¥ ì•„ì´ë””ì–´<br />
â€¢ â€œìë™ ë¼ìš°í„°â€: íˆ´ ë©”íƒ€ë°ì´í„°ì— domain íƒœê·¸ë¥¼ ë‘ê³ , ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ë¥˜í•´ ê´€ë ¨ ì„œë²„ íˆ´ë§Œ ëª¨ë¸ì— ë…¸ì¶œ(í† í°/í˜¼ë€ ê°ì†Œ).<br />
â€¢ â€œê´€ì¸¡ì„±â€: ëª¨ë“  tool_use/tool_resultë¥¼ ì´ë²¤íŠ¸ë¡œ ë¡œê·¸ ìˆ˜ì§‘í•´ ì‹¤íŒ¨ìœ¨/ì§€ì—°/ì…ë ¥ ë¶„í¬ë¥¼ ëŒ€ì‹œë³´ë“œë¡œ ë³¸ë‹¤.<br />
â€¢ â€œê¶Œí•œ ìŠ¹ê²©â€: ê³ ìœ„í—˜ íˆ´ í˜¸ì¶œì€ ì‚¬ëŒ í™•ì¸ì„ ìš”êµ¬í•˜ëŠ” ì¸ê°€ í›…ì„ ì¤‘ì•™ í´ë¼ì´ì–¸íŠ¸ì— ì¶”ê°€.</p>

<p>ì›í•˜ë©´ ë„¤ê°€ ì“°ë ¤ëŠ” ì„œë²„ ëª©ë¡ê³¼ ì „ì†¡ ë°©ì‹(stdio/HTTP), ë¶™ì¼ ëª¨ë¸(Claude/OpenAI ë“±)ì„ ì•Œë ¤ì¤˜. ê±°ê¸°ì— ë§ì¶° ì™„ì„± ìŠ¤ìºí´ë”©ì„ ë°”ë¡œ ë‚´ì¤„ê²Œ.</p>

<p class="chat--user">

íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ë§ê³  íŒŒì´ì¬ mcp ë¡œ ë¶€íƒí•´ ê·¸ë¦¬ê³  ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ LLMì„ ì‚¬ìš©í• ê±°ì•¼.

</p>

<p>ì¢‹ì•„. íŒŒì´ì¬ìœ¼ë¡œ MCP ë‹¤ì¤‘ ì„œë²„ë¥¼ ë¶™ì´ê³ , ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸(ìì²´ í˜¸ìŠ¤íŒ… ëª¨ë¸)ì— â€œíˆ´ ì½œë§â€ì„ ëŒë¦¬ëŠ” ì „ì²´ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ìŠ¤ìºí´ë”©ì„ ë°”ë¡œ ì¤„ê²Œ. í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ë‘ ê°€ì§€ë‹¤. ì²«ì§¸, ì—¬ëŸ¬ MCP ì„œë²„ì— ê°ê° ì„¸ì…˜ì„ ì—´ê³  íˆ´ ëª©ë¡ì„ í•©ì³ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(server:tool)ë¡œ ë…¸ì¶œ. ë‘˜ì§¸, ì»¤ìŠ¤í…€ LLMì˜ /chat APIì— íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ì „ë‹¬í•˜ê³ , ì‘ë‹µ ë‚´ tool_callsë¥¼ ë°›ì•„ í•´ë‹¹ MCP ì„œë²„ë¡œ ë¼ìš°íŒ…í•´ ì‹¤í–‰ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— í”¼ë“œë°±í•˜ëŠ” ë£¨í”„ë¥¼ ëˆë‹¤.</p>

<p>ì•„ë˜ ì½”ë“œëŠ” ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ì¼ íŒŒì¼ ì˜ˆì‹œë‹¤. ì»¤ìŠ¤í…€ LLMì˜ API í¬ë§·ì€ OpenAI í•¨ìˆ˜ì½œê³¼ ìœ ì‚¬í•œ í˜•íƒœë¥¼ ê°€ì •í–ˆì§€ë§Œ, í´ë˜ìŠ¤ í•œ êµ°ë°ë§Œ ë°”ê¾¸ë©´ ì–´ë–¤ ì—”ë“œí¬ì¸íŠ¸ë“  ë§ì¶œ ìˆ˜ ìˆë„ë¡ ì–´ëŒ‘í„°ë¥¼ ë¶„ë¦¬í•´ë‘ì—ˆë‹¤.</p>

<p>ì„¤ì¹˜ ê°€ì •<br />
pip install mcp requests pydantic orjson</p>

<p>main.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># ì„ íƒ: SSE(ì›ê²© HTTP) ì„œë²„ë¥¼ ë¶™ì¼ ë•Œ
</span>    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#######################################################################
# 0) ë°ì´í„° ëª¨ë¸: LLMê³¼ íˆ´ì½œ ì¸í„°í˜ì´ìŠ¤(ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ ì–´ëŒ‘í„°ìš©)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI styleì— ê°€ê¹ê²Œ ë…¸ë©€ë¼ì´ì¦ˆí•´ ì»¤ìŠ¤í…€ LLMì— ì „ë‹¬
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(JSON str)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># í•„ìš” ì‹œ stop_reason ë“± ì¶”ê°€
</span>
<span class="c1">#######################################################################
# 1) MCP ì—°ê²° ìœ í‹¸: ì—¬ëŸ¬ ì„œë²„ ì—°ê²°í•˜ê³  íˆ´ í•©ì¹˜ê¸°(ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
#######################################################################
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># stdio ë˜ëŠ” sse
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="c1"># stdio
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># sse
</span>    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_servers_cfg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ ì„¤ì¹˜ë˜ì–´ì•¼ SSE ì—°ê²°ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="c1"># t.name, t.description, t.input_schema
</span>                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># JSON Schema
</span>                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># namespaced = "server:tool"
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">íˆ´ ì´ë¦„ì€ </span><span class="sh">'</span><span class="s">server:tool</span><span class="sh">'</span><span class="s"> í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤: </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server_name</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="c1"># MCP í‘œì¤€ contentë¥¼ ë‹¨ì¼ ë¬¸ìì—´ ë˜ëŠ” JSONìœ¼ë¡œ ì •ë¦¬
</span>                <span class="c1"># MCP contentëŠ” list of {type: "text"|"json"|"blob", ...}
</span>                <span class="c1"># ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ text/jsonë§Œ ì§€ì› ì˜ˆì‹œ
</span>                <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># blob/resource ë“±ì€ í•„ìš” ì‹œ í™•ì¥
</span>                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ì„œë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: </span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1">#######################################################################
# 2) ì»¤ìŠ¤í…€ LLM ì–´ëŒ‘í„°: ë„ˆì˜ ì‚¬ì„¤ /chat ì—”ë“œí¬ì¸íŠ¸ì— ë§ì¶° ì¡°ì •
#######################################################################
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë„ˆì˜ ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ ê·œì•½ì„ í•œ ê³³ì— ìº¡ìŠí™”.
    ì•„ë˜ëŠ” ì˜ˆì‹œ ê·œì•½:
      POST {base_url}/chat
      json: {
        </span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}],
        </span><span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="s">:..., </span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="s">:{...}}}]
      }
    ì‘ë‹µ:
      {
        </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">assistant text...</span><span class="sh">"</span><span class="s">,
        </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [
          {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">server:tool</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">{</span><span class="se">\"</span><span class="s">k</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">v</span><span class="se">\"</span><span class="s">}</span><span class="sh">"</span><span class="s">}}
        ]
      }
    í•„ìš”í•œ ê²½ìš° ì´ í´ë˜ìŠ¤ë§Œ ìˆ˜ì •í•˜ë©´ ëœë‹¤.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">extra_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span> <span class="o">=</span> <span class="n">extra_headers</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span> <span class="k">if</span> <span class="n">tools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

<span class="c1">#######################################################################
# 3) ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°: íˆ´ ë³‘í•© â†’ LLM ëŒ€í™” ë£¨í”„ â†’ MCP ë¼ìš°íŒ…
#######################################################################
</span>
<span class="k">def</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">merged_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
    <span class="n">defs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">merged_tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP tool </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="p">}</span>
        <span class="n">defs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">defs</span>

<span class="k">def</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">args_raw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">args_raw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args_raw</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">args_raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args_raw</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sh">""</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># ëª¨ë¸ì´ JSONì´ ì•„ë‹Œ ê±¸ ë‚´ëŠ” ê²½ìš° ë°©ì–´
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_raw</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_conversation</span><span class="p">(</span>
    <span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span>
    <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">):</span>
    <span class="n">tools_catalog</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">llm_tools</span> <span class="o">=</span> <span class="nf">to_llm_tools</span><span class="p">(</span><span class="n">tools_catalog</span><span class="p">)</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">system_prompt</span><span class="p">:</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">))</span>
    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">llm_tools</span><span class="p">)</span>
        <span class="c1"># ìš°ì„  ì–´ì‹œìŠ¤í„´íŠ¸ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì¶”ê°€
</span>        <span class="n">assistant_text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="n">assistant_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">assistant_text</span><span class="p">))</span>

        <span class="c1"># íˆ´ì½œ ì—†ìœ¼ë©´ ì¢…ë£Œ
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># MCP ë¼ìš°íŒ… â†’ ê²°ê³¼ë¥¼ tool_resultë¡œ userì— í”¼ë“œë°±
</span>        <span class="n">tool_results_acc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_arguments</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="c1"># ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì—ê²Œ í”¼ë“œë°±: ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ JSON í…ìŠ¤íŠ¸ë¡œ í•©ì¹¨
</span>                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tool_results_acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="c1"># ë‹¤ìˆ˜ íˆ´ í˜¸ì¶œ ê²°ê³¼ë¥¼ í•˜ë‚˜ì˜ user ë©”ì‹œì§€ë¡œ ì¬ì£¼ì…
</span>        <span class="n">feedback_text</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tool_results_acc</span><span class="p">)</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="si">{</span><span class="n">feedback_text</span><span class="si">}</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1">#######################################################################
# 4) ìƒ˜í”Œ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
#######################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 4-1) ë¶™ì¼ MCP ì„œë²„ë“¤ ì •ì˜
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># ë¡œì»¬ stdio ì˜ˆì‹œ
</span>        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># ì›ê²© SSE ì˜ˆì‹œ(ìˆë‹¤ë©´)
</span>        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"authorization":"Bearer X"}),
</span>    <span class="p">]</span>

    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>

    <span class="c1"># 4-2) ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
</span>    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_BASE_URL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_API_KEY</span><span class="sh">"</span><span class="p">),</span>            <span class="c1"># í•„ìš” ì‹œ
</span>        <span class="n">extra_headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">x-tenant</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">demo</span><span class="sh">"</span><span class="p">}</span>                 <span class="c1"># í•„ìš” ì‹œ
</span>    <span class="p">)</span>

    <span class="c1"># 4-3) ëŒ€í™” í•œ í„´ ì˜ˆì‹œ
</span>    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ë„ˆëŠ” MCP íˆ´ì„ í™œìš©í•´ ì¼ì„ ëë‚´ëŠ” ì—ì´ì „íŠ¸ë‹¤. ìœ„í—˜ ì‘ì—…ì€ dry_runì„ ì„ í˜¸í•˜ê³ , ëª…ì‹œì ìœ¼ë¡œ ìŠ¹ì¸ë°›ê¸° ì „ì—ëŠ” íŒŒê´´ì  ë³€ê²½ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSVë¥¼ files ì„œë²„ì˜ ingest_csv íˆ´ë¡œ ì ì¬í•˜ê³ , db ì„œë²„ì˜ sql_summaryë¡œ ìš”ì•½í•´ì¤˜. íŒŒì¼ ê²½ë¡œëŠ” ./data/sales.csv</span><span class="sh">"</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_conversation</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ìµœì¢… ëŒ€í™” ë¡œê·¸ ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">2000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ë™ì‘ íë¦„ ì„¤ëª…<br />
1ë‹¨ê³„. MCPMuxê°€ ê° ì„œë²„ì— ì„¸ì…˜ì„ ì—°ë‹¤. stdio ì„œë²„ëŠ” command+argsë¡œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê³ , sse ì„œë²„ëŠ” HTTP SSEë¡œ ì—°ê²°í•œë‹¤.<br />
2ë‹¨ê³„. list_toolsë¥¼ ëª¨ë“  ì„œë²„ì—ì„œ ëª¨ì•„ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(server:tool)ë¡œ ë³€í™˜í•œë‹¤.<br />
3ë‹¨ê³„. ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸ì— messagesì™€ toolsë¥¼ ë„˜ê¸´ë‹¤. toolsëŠ” OpenAIì‹ function í¬ë§·ìœ¼ë¡œ ì •ê·œí™”í•´ì„œ ì „ë‹¬í•œë‹¤.<br />
4ë‹¨ê³„. LLMì´ tool_callsë¥¼ ë°˜í™˜í•˜ë©´, ê° callì˜ function.nameì´ server:toolì´ë¯€ë¡œ í•´ë‹¹ ì„œë²„ë¡œ ë¼ìš°íŒ…í•´ì„œ call_toolì„ ì‹¤í–‰í•œë‹¤.<br />
5ë‹¨ê³„. ê²°ê³¼ë¥¼ TOOL_RESULTS í…ìŠ¤íŠ¸ë¡œ user ì—­í•  ë©”ì‹œì§€ì— í•©ì³ì„œ ëª¨ë¸ì— ë‹¤ì‹œ ì£¼ì…í•œë‹¤. ëª¨ë¸ì€ ì¶”ê°€ì ì¸ tool_callsë¥¼ ë‚´ê±°ë‚˜, ìµœì¢… ë‹µë³€ì„ ë‚¸ë‹¤.<br />
6ë‹¨ê³„. tool_callsê°€ ë” ì´ìƒ ì—†ìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ.</p>

<p>ìš´ì˜ íŒ<br />
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³ ì •. server:tool ë„¤ì´ë°ì„ ìŠ¤í‚¤ë§ˆ descriptionì—ë„ ë°˜ë³µí•´ì„œ LLMì˜ ì„ íƒ ì˜¤ë¥˜ë¥¼ ì¤„ì¸ë‹¤.<br />
ê¶Œí•œ ê²½ê³„. ì‚­ì œÂ·ê²°ì œÂ·ë°°í¬ ê°™ì€ íˆ´ì—ëŠ” parametersì— dry_run(boolean, default true) ê°™ì€ í•„ë“œë¥¼ ì¶”ê°€í•´ 2ë‹¨ê³„ ìŠ¹ì¸ì„ ìœ ë„í•˜ë¼.<br />
íƒ€ì„ì•„ì›ƒÂ·ì¬ì‹œë„. SSEë‚˜ stdio ëª¨ë‘ ì™¸ë¶€ í”„ë¡œì„¸ìŠ¤/ë„¤íŠ¸ì›Œí¬ì— ë¯¼ê°í•˜ë‹ˆ call_toolì—ëŠ” ì„œë²„ ì¸¡ íƒ€ì„ì•„ì›ƒê³¼ ì¬ì‹œë„ë¥¼ ë‘”ë‹¤. í•„ìš” ì‹œ MCPMux.callì— ì¬ì‹œë„ë¥¼ ì¶”ê°€í•˜ë¼.<br />
ëŒ€ìš©ëŸ‰ ê²°ê³¼. íŒŒì¼Â·í‘œÂ·ë°”ì´ë„ˆë¦¬ ê²°ê³¼ëŠ” MCP ë¦¬ì†ŒìŠ¤(íŒŒì¼ í•¸ë“¤)ë‚˜ ì™¸ë¶€ ì €ì¥ì†Œ URLì„ ë°˜í™˜í•˜ê³ , LLMì—ëŠ” ë©”íƒ€ë°ì´í„°ë§Œ ë³´ë‚´ í† í°ì„ ì•„ë¼ëŠ” ì„¤ê³„ë¥¼ ì¶”ì²œí•œë‹¤.<br />
ì ì‘ì¸µ. CustomLLMClientë¥¼ ë„ˆì˜ ì‹¤ì œ /chat ê·œê²©ì— ë§ê²Œ ìˆ˜ì •í•œë‹¤. ì˜ˆì»¨ëŒ€ ë¬¸ì„œí™”ëœ JSON í‚¤ ì´ë¦„ì´ ë‹¤ë¥´ë©´ ChatResponse íŒŒì‹±ë§Œ ë°”ê¾¸ë©´ ëœë‹¤.</p>

<p>í…ŒìŠ¤íŠ¸ ë°©ë²•<br />
ê°€ì§œ ì„œë²„ë¶€í„°. servers ë””ë ‰í„°ë¦¬ì— echo ìˆ˜ì¤€ì˜ ê°„ë‹¨í•œ MCP ì„œë²„ ë‘ ê°œ(files, db)ë¥¼ ë§Œë“¤ì–´ list_toolsì™€ call_toolë§Œ ìµœì†Œ êµ¬í˜„í•œë‹¤.<br />
ë‹¨ìœ„ í…ŒìŠ¤íŠ¸. CustomLLMClient.sendë¥¼ ëª¨í‚¹í•´ tool_callsë¥¼ ê°•ì œë¡œ ë‚´ë³´ë‚´ê³ , MCPMux.callì´ ì˜¬ë°”ë¥¸ ì„œë²„ë¡œ ë¼ìš°íŒ…ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.<br />
ì—”ë“œíˆ¬ì—”ë“œ. ì‹¤ì œ LLM ì—”ë“œí¬ì¸íŠ¸ë¡œ êµì²´í•´ CSV â†’ SQL ìš”ì•½ ê°™ì€ ì›Œí¬í”Œë¡œë¥¼ í•œ ë²ˆì— ëŒë ¤ë³¸ë‹¤.</p>

<p>í™•ì¥ ì•„ì´ë””ì–´<br />
ìë™ ë¼ìš°íŒ…. ë„ë©”ì¸ íƒœê·¸(files/db/search ë“±)ë¥¼ ë³´ê³  ê´€ë ¨ íˆ´ë§Œ tools ë°°ì—´ì— ë…¸ì¶œí•´ í† í°ê³¼ í˜¼ë€ì„ ì¤„ì¸ë‹¤.<br />
ê°ì‚¬ ë¡œê·¸. ëª¨ë“  tool_call ì…ë ¥Â·ì¶œë ¥ì„ JSONLë¡œ íŒŒì¼ì— ì ì¬í•´ ì§€ì—°, ì‹¤íŒ¨ìœ¨, ìœ„í—˜ í˜¸ì¶œì„ ëª¨ë‹ˆí„°ë§í•œë‹¤.<br />
íœ´ë¨¼ ê²Œì´íŠ¸. ìœ„í—˜í•œ íˆ´ì½œì´ ê°ì§€ë˜ë©´ CustomLLMClientë¡œ ë°”ë¡œ ë³´ë‚´ì§€ ë§ê³ , ë³„ë„ ìŠ¹ì¸ UI í˜¹ì€ CLIì—ì„œ 1íšŒ ìŠ¹ì¸ í›„ ì¬ì£¼ì…í•œë‹¤.</p>

<p>ì›í•˜ëŠ” /chat ê·œê²©(JSON ì˜ˆì‹œ ìŠ¤í™)ì´ë‚˜ ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ ìƒ˜í”Œì„ ì•Œë ¤ì£¼ë©´, ìœ„ ì–´ëŒ‘í„°ë¥¼ ê±°ê¸°ì— ë”± ë§ì¶° êµ¬ì²´í™”í•´ì„œ ë¦¬ë¼ì´íŠ¸í•´ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì§ˆë¬¸ì´ ìˆì–´. 1. ê·¸ëƒ¥ íˆ´ì„ ê·¸ëŒ€ë¡œ ë³´ë‚´ë©´ ì˜¤ë¥˜ê°€ ë” ë§ì„ê¹Œ? 2. ì¼ë°˜ íˆ´ ì½œë§ê³¼ ì„ì—¬ ìˆëŠ” ì˜ˆì‹œë„ ë³´ì—¬ì£¼ë©´ ì¢‹ê² ì–´. 

</p>

<p>ì¢‹ì•„, ë‘ ê°€ì§€ ëª¨ë‘ ë”± ê½‚íˆê²Œ ì •ë¦¬í•´ì¤„ê²Œ. ê²°ë¡  ë¨¼ì €, ê·¸ë‹¤ìŒ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì´ì¬ ì˜ˆì‹œë¡œ ë§ˆë¬´ë¦¬í•œë‹¤.</p>

<ol>
  <li>ê·¸ëƒ¥ â€œì„œë²„ì—ì„œ ë°›ì€ íˆ´ì„ ì „ë¶€â€ ëª¨ë¸ì— ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ë©´ ì˜¤ë¥˜ê°€ ë” ë§ì„ê¹Œ?<br />
ì§§ì€ ë‹µ: ë³´í†µ ê·¸ë ‡ë‹¤. ì´ìœ ëŠ” ì˜ˆì¸¡ ê°€ëŠ¥í•˜ë‹¤.</li>
</ol>

<ul>
  <li>
    <p>ê³¼ì ì¬(too many tools). íˆ´ì´ ë§ì•„ì§ˆìˆ˜ë¡ ì„ íƒ ì˜¤ë¥˜ê°€ ëŠ˜ê³ , ëª¨ë¸ì´ ë¹„ìŠ·í•œ íˆ´ì„ í˜¼ë™í•œë‹¤. ë¹„ìŠ·í•œ ì´ë¦„, ë¹„ìŠ·í•œ ì„¤ëª…ì€ íŠ¹íˆ ìœ„í—˜í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ìŠ¤í‚¤ë§ˆ ëŠìŠ¨í•¨. parameters(JSON Schema)ì— íƒ€ì…Â·í•„ìˆ˜ í•„ë“œÂ·enum ì œì•½ì´ ì•½í•˜ë©´ arguments í˜•ì‹ ì˜¤ë¥˜ê°€ ì¦ê°€í•œë‹¤.</p>
  </li>
  <li>
    <p>ë¬¸ë§¥ ë¯¸ìŠ¤ë§¤ì¹˜. í˜„ì¬ í„´ê³¼ ê´€ê³„ì—†ëŠ” íˆ´ê¹Œì§€ ëª¨ë‘ ë³´ì´ë©´ â€œê·¼ì²˜ì— ìˆëŠ” ë„êµ¬â€ í¸í–¥ ë•Œë¬¸ì— ì—‰ëš±í•œ ê±¸ ì§‘ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ë„¤ì„ ì¶©ëŒÂ·ì˜ë„ ì¶©ëŒ. ì„œë¡œ ë‹¤ë¥¸ ì„œë²„ì— ê°™ì€ ì´ë¦„, ìœ ì‚¬ ê¸°ëŠ¥ì´ ìˆìœ¼ë©´ ë¼ìš°íŒ…Â·ì„ íƒ ëª¨ë‘ í”ë“¤ë¦°ë‹¤.</p>
  </li>
  <li>
    <p>ë¶€ì‘ìš© ìœ„í—˜. ì‚­ì œ/ê²°ì œ/ë°°í¬ ê°™ì€ íˆ´ì„ ì•„ë¬´ ë§¥ë½ ì—†ì´ ë…¸ì¶œí•˜ë©´ ëª¨ë¸ì´ ì„±ê¸‰íˆ ì‹¤í–‰í•˜ë ¤ í•œë‹¤(ëª¨ë¸ì€ ê³¼ê°í•˜ë‹¤).</p>
  </li>
  <li>
    <p>ë ˆì´í„´ì‹œÂ·ì‹¤íŒ¨ ì „íŒŒ. ì›ê²©/SSE íˆ´ ë‹¤ìˆ˜ëŠ” íƒ€ì„ì•„ì›ƒê³¼ 429ê°€ ë’¤ì„ì—¬ ì—ëŸ¬ ì¦í­ì„ ë§Œë“ ë‹¤.</p>
  </li>
</ul>

<p>í˜„ì—…ì—ì„œ ì—ëŸ¬ë¥¼ ì¤„ì´ëŠ” ì‹¤ì „ ì²˜ë°©</p>

<ul>
  <li>
    <p>í„´ë³„ íˆ´ ì†Œì¶œ(Selective exposure). ìœ ì € ì…ë ¥ì„ ê¸°ì¤€ìœ¼ë¡œ ê´€ë ¨ ì„œë²„/ë„ë©”ì¸ì˜ íˆ´ë§Œ ë…¸ì¶œí•œë‹¤. ë‹¨ìˆœ í‚¤ì›Œë“œ ë¼ìš°íŒ…ë§Œ ë„£ì–´ë„ ì‹¤íŒ¨ìœ¨ì´ ëš ë–¨ì–´ì§„ë‹¤.</p>
  </li>
  <li>
    <p>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í•„ìˆ˜. server:tool ì´ë¦„ìœ¼ë¡œ ê³ ì •í•˜ê³ , descriptionì—ë„ ì„œë²„/ë„ë©”ì¸ì„ ë°˜ë³µ ëª…ì‹œí•œë‹¤.</p>
  </li>
  <li>
    <p>ìŠ¤í‚¤ë§ˆë¥¼ ì—„ê²©í•˜ê²Œ. type/enum/minItems/formatê¹Œì§€ ë¹¡ë¹¡í•˜ê²Œ ê±¸ì–´ë¼. ê°€ëŠ¥í•˜ë©´ ì˜ˆì œ(example) í•„ë“œê¹Œì§€ ë„£ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ê³ ìœ„í—˜ íˆ´ì— ì„¸ì´í”„í‹° í”Œë˜ê·¸. dry_run ê¸°ë³¸ê°’ true, confirmation string ê°™ì€ ì´ì¤‘ ì ê¸ˆ.</p>
  </li>
  <li>
    <p>ì‘ë‹µ ì •ê·œí™”. MCP tool_resultë¥¼ í•­ìƒ ê°™ì€ JSON í¬ë§·ìœ¼ë¡œ ë¬¶ì–´ ëª¨ë¸ì— ì¬ì£¼ì…í•´ í•™ìŠµëœ ê¸°ëŒ€ í˜•íƒœë¥¼ ìœ ì§€í•œë‹¤.</p>
  </li>
  <li>
    <p>íƒ€ì„ì•„ì›ƒ/ì¬ì‹œë„/ë°±ì˜¤í”„ í‘œì¤€í™”. ì„œë²„ë³„ ê¸°ë³¸ê°’ì´ ë‹¬ë¼ë„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒí•œì„ í†µì¼í•œë‹¤.</p>
  </li>
  <li>
    <p>íˆ´ ìº¡. í•œ í„´ì— ìµœëŒ€ 10~20ê°œ ì •ë„ë§Œ ë…¸ì¶œ(ê²½í—˜ìƒ 8~12ì—ì„œ ê°€ì¥ ì•ˆì •ì ).</p>
  </li>
</ul>

<ol>
  <li>â€œì¼ë°˜ íˆ´ ì½œë§â€ê³¼ â€œMCP íˆ´ ì½œë§â€ì´ ì„ì—¬ ìˆëŠ” ì˜ˆì‹œ<br />
ì•„ë˜ëŠ” ì´ì „ íŒŒì´ì¬ ìŠ¤ìºí´ë”©ì„ ì–‡ê²Œ í™•ì¥í•œ ë²„ì „ì´ë‹¤. í•µì‹¬ì€ ë””ìŠ¤íŒ¨ì²˜ì— ë¡œì»¬(ì¼ë°˜) íˆ´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ local.* ë¥¼ ì¶”ê°€í•˜ê³ , LLMì´ ê°™ì€ í„´ì—ì„œ local.* ê³¼ server:tool(MCP)ì„ ì„ì–´ì„œ í˜¸ì¶œí•´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë¼ìš°íŒ…ë˜ëŠ” êµ¬ì¡°ë‹¤.</li>
</ol>

<p>í•„ìš” íŒ¨í‚¤ì§€<br />
pip install mcp requests pydantic orjson</p>

<p>mixed_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="c1"># ======== ê³µìš© ë°ì´í„° ëª¨ë¸ ========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># ======== MCP ë©€í‹° ì„œë²„ MUX ========
</span>
<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPMux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectedServer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ConnectedServer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">:</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">srv</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">})</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespaced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">namespaced</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">srv</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ======== ë¡œì»¬(ì¼ë°˜) íˆ´: ì˜ˆì‹œ êµ¬í˜„ ========
</span>
<span class="k">def</span> <span class="nf">local_tools_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „í•œ ì‚¬ì¹™ì—°ì‚°/ê°„ë‹¨ì‹ í‰ê°€ê¸°. ì…ë ¥: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í…ìŠ¤íŠ¸ì—ì„œ ìì£¼ ë“±ì¥í•˜ëŠ” ë‹¨ì–´ ìƒìœ„ Kë¥¼ ë½‘ì•„ì¤€ë‹¤. ì…ë ¥: {text: string, k: integer}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                    <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># ì•„ì£¼ ë³´ìˆ˜ì ì¸ ê³„ì‚°ê¸°(ìˆ«ì, + - * / () ë§Œ í—ˆìš©)
</span>        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}}]}</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.top_k_keywords</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">collections</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[A-Za-z0-9ê°€-í£]+</span><span class="sh">"</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="nc">Counter</span><span class="p">([</span><span class="n">t</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">])</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">.</span><span class="nf">most_common</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">top</span><span class="sh">"</span><span class="p">:</span> <span class="n">top</span><span class="p">}}]}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ======== ì»¤ìŠ¤í…€ LLM ì–´ëŒ‘í„°(ì˜ˆì‹œ) ========
</span>
<span class="k">class</span> <span class="nc">CustomLLMClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>

<span class="c1"># ======== íˆ´ ë…¸ì¶œ ì „ëµ(ê°„ë‹¨ ì†Œì¶œ ì˜ˆì‹œ) ========
</span>
<span class="k">def</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">keep</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">user_text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>

    <span class="c1"># í‚¤ì›Œë“œ ê¸°ë°˜ ë¼ìš°íŒ…(ì•„ì£¼ ì–•ì€ ì˜ˆì‹œ)
</span>    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">íŒŒì¼</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ingest</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">load</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì¿¼ë¦¬</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ë°ì´í„°ë² ì´ìŠ¤</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ìš”ì•½</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">summary</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_mcp</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># í•­ìƒ ë…¸ì¶œí•  ë¡œì»¬ ë„êµ¬
</span>    <span class="n">local_basics</span> <span class="o">=</span> <span class="nf">local_tools_catalog</span><span class="p">()</span>

    <span class="c1"># ì¤‘ë³µ ì œê±° ë° ì´ë¦„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì ìš©
</span>    <span class="k">def</span> <span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]}</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

    <span class="n">uniq</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
        <span class="n">uniq</span><span class="p">[(</span><span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">server</span><span class="sh">"</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">tooldefs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_tooldef</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">uniq</span><span class="p">.</span><span class="nf">values</span><span class="p">()]</span>
    <span class="n">tooldefs</span> <span class="o">+=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">]})</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">local_basics</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tooldefs</span>

<span class="c1"># ======== ëŒ€í™” ë£¨í”„ ========
</span>
<span class="k">def</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">:</span> <span class="n">MCPMux</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">CustomLLMClient</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">connect_all</span><span class="p">()</span>
    <span class="n">all_mcp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system</span><span class="p">),</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">tools_exposed</span> <span class="o">=</span> <span class="nf">selective_expose</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">all_mcp</span><span class="p">)</span>  <span class="c1"># í„´ë³„ ì†Œì¶œ
</span>        <span class="n">resp</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools_exposed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># ì„ì—¬ ìˆëŠ” íˆ´ì½œ ì²˜ë¦¬: local.* â†” server:tool
</span>        <span class="n">results_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nf">coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mux</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results_texts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_texts</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ======== ì‹¤í–‰ ì˜ˆì‹œ ========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mux</span> <span class="o">=</span> <span class="nc">MCPMux</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">node</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/files/index.js</span><span class="sh">"</span><span class="p">]),</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./servers/db/server.py</span><span class="sh">"</span><span class="p">]),</span>
    <span class="p">])</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="nc">CustomLLMClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">system</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ë„ˆëŠ” ì•ˆì „í•˜ê³  ì‹ ì¤‘í•œ ì—ì´ì „íŠ¸ë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span>
    <span class="n">user</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CSVë¥¼ ì ì¬í•˜ê³ (sql ìš”ì•½ê¹Œì§€). ìˆ˜ì¹˜ í™•ì¸ì€ ê³„ì‚°ê¸°ë¡œ í•œë²ˆ ê²€ì¦í•´ì¤˜. íŒŒì¼ì€ ./data/sales.csv ì´ì•¼.</span><span class="sh">"</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">chat_once</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== LOG ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1000</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì´ ì½”ë“œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê²ƒ</p>

<ul>
  <li>
    <p>í•œ í„´ì— LLMì´ local.math_eval(ì¼ë°˜ íˆ´)ê³¼ files:ingest_csv(MCP) / db:sql_summary(MCP)ë¥¼ ì„ì–´ í˜¸ì¶œí•´ë„ ë””ìŠ¤íŒ¨ì²˜ê°€ ê°ê° ë§ëŠ” ê²½ë¡œë¡œ ë¼ìš°íŒ…í•œë‹¤.</p>
  </li>
  <li>
    <p>selective_exposeê°€ í„´ë³„ íˆ´ ì†Œì¶œì„ í•´ì¤€ë‹¤. ìœ ì € ìš”ì²­ì— í•„ìš” ì—†ëŠ” ì„œë²„ íˆ´ì€ ìˆ¨ê²¨ì„œ í˜¼ë€ê³¼ ì—ëŸ¬ë¥¼ ì¤„ì¸ë‹¤.</p>
  </li>
  <li>
    <p>ë¡œì»¬ íˆ´ì€ íŒŒì´ì¬ í•¨ìˆ˜ë¡œ ë°”ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë ˆì´í„´ì‹œê°€ ì ê³ , ê°„ë‹¨í•œ ê²€ì¦Â·í›„ì²˜ë¦¬(ì˜ˆ: ê³„ì‚°ìœ¼ë¡œ sanity-check)ë¥¼ ë¹ ë¥´ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
</ul>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ, ì—ëŸ¬ë¥¼ ë” ì¤„ì´ë ¤ë©´</p>

<ul>
  <li>
    <p>íˆ´ ì„¤ëª…ì— â€œì–¸ì œ ì“°ëŠ”ì§€/ì–¸ì œ ì“°ì§€ ë§ì•„ì•¼ í•˜ëŠ”ì§€â€ë¥¼ í•œ ë¬¸ì¥ì”© ëª…ì‹œí•œë‹¤.</p>
  </li>
  <li>
    <p>ìœ„í—˜ íˆ´ì˜ parametersì— confirm ë¬¸ìì—´(ì˜ˆ: "I understand this deletes data")ì„ requiredë¡œ ì¶”ê°€í•œë‹¤.</p>
  </li>
  <li>
    <p>TOOL_RESULTS í¬ë§·ì„ íŒ€ ê³µí†µ JSON ìŠ¤í‚¤ë§ˆë¡œ ê³ ì •í•´ ëª¨ë¸ì´ ì˜ˆì¸¡ ê°€ëŠ¥í•œ í›„ì† ê³„íšì„ ì„¸ìš°ë„ë¡ í•œë‹¤.</p>
  </li>
  <li>
    <p>ê° ì„œë²„/íˆ´ë³„ íƒ€ì„ì•„ì›ƒÂ·ì¬ì‹œë„Â·ì„œí‚·ë¸Œë ˆì´ì»¤ë¥¼ ê³µí†µ ë¯¸ë“¤ì›¨ì–´ë¡œ ë¬¶ëŠ”ë‹¤.</p>
  </li>
</ul>

<p>ì—¬ê¸°ê¹Œì§€ë©´ ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸ì—ì„œë„ â€œì¼ë°˜+MCP í˜¼í•© íˆ´ì½œâ€ì„ ì•ˆì •ì ìœ¼ë¡œ ëŒë¦´ ìˆ˜ ìˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ëŠ” ë„¤ê°€ ì“°ëŠ” /chat ìŠ¤í™ì— ë§ì¶° CustomLLMClientì˜ ì§ë ¬í™”/ì—­ì§ë ¬í™” ë¶€ë¶„ë§Œ ë¯¸ì„¸ì¡°ì •í•˜ê³ , ì‹¤ì œ ì„œë²„ ë‘ ê°œ(files/db) ìµœì†Œ êµ¬í˜„ìœ¼ë¡œ E2Eë¥¼ í•œ ë²ˆ êµ´ë ¤ë³´ëŠ” ê²ƒì´ë‹¤.</p>

<p class="chat--user">

ì˜¤í˜¸. ë‹¤ìŒì€ ì–´ë ¤ìš´ ë¬¸ì œì•¼. ì´ê±¸ openai agent python sdkì— ë¶™ì¼ ìˆ˜ ìˆì„ê¹Œ?

</p>

<p>ê°€ëŠ¥í•˜ë‹¤. ê²Œë‹¤ê°€ â€œì—¬ëŸ¬ MCP ì„œë²„â€ì™€ â€œì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸â€ë¥¼ ë™ì‹œì— ì“°ëŠ” êµ¬ì„±ì´ OpenAI Agents Python SDKì—ì„œ ì •ì„ìœ¼ë¡œ ì§€ì›ëœë‹¤. ìš”ì ë§Œ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•˜ê³ , ë°”ë¡œ ëŒì•„ê°€ëŠ” ìµœì†Œ ì˜ˆì‹œë¥¼ ì¤€ë‹¤.</p>

<p>í•µì‹¬ ì •ë¦¬</p>

<ol>
  <li>
    <p>Agents SDKëŠ” MCPë¥¼ 4ê°€ì§€ ì „ì†¡ìœ¼ë¡œ ë¶™ì¸ë‹¤: Hosted MCP(Responses APIê°€ ì›ê²©ì„œë²„ë¥¼ ì§ì ‘ í˜¸ì¶œ), Streamable HTTP, HTTP+SSE, stdio(ë¡œì»¬ í”„ë¡œì„¸ìŠ¤). ì„œë²„ ì—¬ëŸ¬ ê°œë¥¼ mcp_servers ë¦¬ìŠ¤íŠ¸ì— ë„£ìœ¼ë©´ í•œ ì—ì´ì „íŠ¸ê°€ ì „ë¶€ë¥¼ ë³¸ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>ëª¨ë¸ì€ OpenAI ëª¨ë¸ ë§ê³ ë„ LiteLLM í™•ì¥ì„ í†µí•´ â€œOpenAI í˜¸í™˜ RESTâ€ë¡œ ë…¸ì¶œëœ ì„ì˜ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ëª¨ë¸ì²˜ëŸ¼ ì“¸ ìˆ˜ ìˆë‹¤. base_urlë§Œ ë„¤ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë°”ê¾¸ë©´ ëœë‹¤. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Hosted MCPë¥¼ ì“°ë©´ OpenAI ì¸í”„ë¼ê°€ ì›ê²© MCP ì„œë²„ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ë¯€ë¡œ íŒŒì´ì¬ ìª½ ì½œë°±ì´ í•„ìš” ì—†ë‹¤(ê³µê°œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì›ê²© ì„œë²„ì— ì í•©). ë°˜ëŒ€ë¡œ ì‚¬ë‚´ë§/ë¡œì»¬ì€ stdioÂ·SSE ë“± â€œì§ì ‘ ë¶™ì´ê¸°â€ê°€ ë§ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>Agents SDKì—ëŠ” MCP ì „ìš© í´ë˜ìŠ¤ë“¤ì´ ì´ë¯¸ ë“¤ì–´ìˆë‹¤(MCPServerStdio, MCPServerSse, MCPServerStreamableHttp, HostedMCPTool ë“±). <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub+1</a></p>
  </li>
</ol>

<p>ë¹ ë¥¸ ìŠ¤ìºí´ë”©(íŒŒì´ì¬)<br />
ì„¤ì¹˜<br />
pip install openai-agents mcp</p>

<p>ì˜ˆì‹œ 1) ì»¤ìŠ¤í…€ LLM(base_url) + stdio/SSE MCP ë‹¤ì¤‘ ì„œë²„ í•œ ë²ˆì— ë¶™ì´ê¸°<br />
ì•„ë˜ëŠ” íŒŒì¼ì‹œìŠ¤í…œ MCPë¥¼ ë¡œì»¬(stdio)ë¡œ, ì‚¬ë‚´ìš© ê²€ìƒ‰ MCPë¥¼ SSEë¡œ ë¶™ì´ê³ , ëª¨ë¸ì€ ë„ˆì˜ ì»¤ìŠ¤í…€ /v1 Chat í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì”€.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.mcp</span> <span class="kn">import</span> <span class="n">MCPServerStdio</span><span class="p">,</span> <span class="n">MCPServerSse</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>  <span class="c1"># ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ìš©
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP ì„œë²„ë“¤ì„ context managerë¡œ ê¸°ë™/ì—°ê²°
</span>    <span class="k">async</span> <span class="k">with</span> <span class="nc">MCPServerStdio</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">command</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">files_server</span><span class="p">,</span> <span class="nc">MCPServerSse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">search</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://mcp.example.com/sse</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Bearer XYZ</span><span class="sh">"</span><span class="p">}},</span>
        <span class="n">cache_tools_list</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">search_server</span><span class="p">:</span>

        <span class="c1"># 2) ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸(OpenAI í˜¸í™˜) ëª¨ë¸ë¡œ ì§€ì •
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>                 <span class="c1"># ì—”ì§„/ì´ë¦„
</span>            <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>     <span class="c1"># ë„¤ ì—”ë“œí¬ì¸íŠ¸
</span>            <span class="n">api_key</span><span class="o">=</span><span class="sh">"</span><span class="s">sk-your-key</span><span class="sh">"</span><span class="p">,</span>                   <span class="c1"># í•„ìš”ì‹œ
</span>        <span class="p">)</span>

        <span class="c1"># 3) ì—ì´ì „íŠ¸ êµ¬ì„±: ì—¬ëŸ¬ MCP ì„œë²„ë¥¼ í•œ ë²ˆì— ë…¸ì¶œ
</span>        <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Orchestrator</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP íˆ´ì„ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•˜ê³ , í•„ìš”í•  ë•Œë§Œ í˜¸ì¶œí•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mcp_servers</span><span class="o">=</span><span class="p">[</span><span class="n">files_server</span><span class="p">,</span> <span class="n">search_server</span><span class="p">],</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># í•„ìš” ì‹œ "required"ë¡œ ê°•ì œ
</span>        <span class="p">)</span>

        <span class="c1"># 4) ì‹¤í–‰
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">data í´ë”ì˜ CSVë¥¼ ì½ê³ , search ì„œë²„ë¡œ ê´€ë ¨ ë¬¸ì„œ ì°¾ì•„ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì˜ˆì‹œ 2) Hosted MCPë¥¼ ì„ëŠ” ë³€í˜•<br />
ì›ê²©ì— ê³µê°œëœ MCP ì„œë²„ëŠ” HostedMCPTool í•˜ë‚˜ë§Œ toolsì— ë„£ìœ¼ë©´ ëª¨ë¸ì´ OpenAI ì¸í”„ë¼ì—ì„œ ì§ì ‘ ëª©ë¡ì¡°íšŒ/í˜¸ì¶œê¹Œì§€ í•œë‹¤. íŒŒì´ì¬ ìª½ ì½œë°±ì´ ê±°ì˜ ì—†ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">HostedMCPTool</span>

<span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">HostedMCPUser</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="nc">HostedMCPTool</span><span class="p">(</span><span class="n">tool_config</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_label</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gitmcp</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">server_url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://gitmcp.io/openai/codex</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">require_approval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">})],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì´ ì €ì¥ì†Œì˜ ì£¼ìš” ì–¸ì–´ë¥¼ ì•Œë ¤ì¤˜</span><span class="sh">"</span><span class="p">).</span><span class="n">final_output</span><span class="p">)</span>
</code></pre></div></div>

<p>ìœ„ ë‘ ë°©ì‹ì€ ê³µì‹ ë¬¸ì„œì˜ ì‚¬ìš©ë²•ê³¼ ë™ì¼í•œ íë¦„ì´ë‹¤. Hosted MCP, stdio/SSE/HTTP ì„œë²„, íˆ´ í•„í„°ë§, ìŠ¹ì¸ í›…ê¹Œì§€ í¬í•¨ëœ ê°€ì´ë“œë¥¼ ì°¸ê³ í•´ ì„¸ë¶€ì˜µì…˜ì„ ë§ì¶”ë©´ ëœë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>

<p>íˆ´ ì†Œì¶œ ì „ëµ(ì˜¤ë¥˜ ì¤„ì´ëŠ” íŒ)</p>

<ol>
  <li>
    <p>íˆ´ í•„í„°ë§: ì„œë²„ ìƒì„±ìì— tool_filterë¥¼ ê±¸ê±°ë‚˜ ì •ì /ë™ì  í•„í„°ë¥¼ ì¨ì„œ í„´ë³„ë¡œ í•„ìš”í•œ íˆ´ë§Œ ë…¸ì¶œí•˜ë¼. SDKê°€ ë„ìš°ë¯¸ë¥¼ ì œê³µí•œë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>ìœ„í—˜ íˆ´ ìŠ¹ì¸: HostedMCPToolì€ require_approval ë° on_approval_request ì½œë°±ìœ¼ë¡œ ë¯¼ê° ì‘ì—…ì„ ìŠ¹ì¸ í”Œë¡œë¡œ ê°ì‹¼ë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
  <li>
    <p>ìºì‹±ê³¼ ì¬ì‹œë„: cache_tools_list, max_retry_attempts ë“± ì˜µì…˜ìœ¼ë¡œ ì§€ì—°ê³¼ ì‹¤íŒ¨ í™•ë¥ ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/mcp/">OpenAI GitHub</a></p>
  </li>
</ol>

<p>í•œ ì¤„ ê²°ë¡ <br />
OpenAI Agents Python SDKì— ë„¤ê°€ ë§Œë“  â€œë©€í‹° MCP + ì»¤ìŠ¤í…€ LLM ì—”ë“œí¬ì¸íŠ¸â€ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì¼ ìˆ˜ ìˆë‹¤. ëª¨ë¸ì€ LiteLLMModelë¡œ ì»¤ìŠ¤í…€ RESTë¥¼ ì“°ê³ , MCPëŠ” mcp_serversì— ì—¬ëŸ¬ ê°œë¥¼ ì—´ê±°í•˜ê±°ë‚˜ HostedMCPToolì„ ë³‘ìš©í•˜ë©´ ëœë‹¤. í•„ìš”í•˜ë©´ ë„ˆì˜ ì—”ë“œí¬ì¸íŠ¸ ìŠ¤í™ì— ë§ì¶° ëª¨ë¸ ì–´ëŒ‘í„°ë¥¼ ë” ì´˜ì´˜í•˜ê²Œ ì„¤ì •í•˜ëŠ” ì½”ë“œë„ ë§Œë“¤ì–´ì£¼ê² ë‹¤. <a href="https://openai.github.io/openai-agents-python/ref/extensions/litellm/">OpenAI GitHub+2</a></p>

<p class="chat--user">

ì•„ë‹ˆ ë‚œ ë„ˆê°€ ë§Œë“  ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì“°ê³  ì‹¶ì–´. ì™œëƒë©´ ì´ë ‡ê²Œ ë§Œë“  ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‹¤ë¥¸ Chat ì—ë„ ì“°ê³  ì‹¶ê±°ë“ . Agentë§Œì„ ìœ„í•œ ë‹¤ë¥¸ ì½”ë“œê°€ ë¶„ê¸° ë˜ëŠ” ê²ƒì´ ì‹«ì–´. Toolë§Œ ì…ë ¥í•´ì„œ ë™ì‘í•˜ê²Œ í•˜ëŠ” ë°©ë²• ì—†ì–´?

</p>

<p>ì¢‹ì•„. â€œAgent ì „ìš© ë¶„ê¸° ì—†ì´â€ ë„ˆê°€ ë§Œë“  ì¸í„°í˜ì´ìŠ¤ë¥¼ ì–´ë–¤ Chatì—ë„ ì¬ì‚¬ìš©í•˜ë ¤ë©´, ì…ë ¥ì€ ì˜¤ì§ íˆ´(=í”„ë¡œë°”ì´ë”)ê³¼ LLM ì—”ë“œí¬ì¸íŠ¸ë§Œ ì£¼ê³  ëŒì•„ê°€ëŠ” ì–‡ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ í•„ìš”í•˜ë‹¤. ì•„ë˜ëŠ” ê·¸ ëª©ì ì— ë§ì¶˜ ë‹¨ì¼ íŒŒì¼ ìŠ¤ìºí´ë”©ì´ë‹¤. í•µì‹¬ì€ ì„¸ ê°€ì§€ ì¸í„°í˜ì´ìŠ¤ë‹¤.</p>

<ol>
  <li>
    <p>ChatBackend: ì–´ë–¤ ì±„íŒ… ëª¨ë¸ì´ë“  ë¶™ì¼ ìˆ˜ ìˆëŠ” ë°±ì—”ë“œ ì–´ëŒ‘í„°.</p>
  </li>
  <li>
    <p>ToolProvider: íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ ë…¸ì¶œí•˜ê³  í˜¸ì¶œì„ ì²˜ë¦¬í•˜ëŠ” í‘œì¤€ ì¸í„°í˜ì´ìŠ¤.</p>
  </li>
  <li>
    <p>Orchestrator: messages + toolsë§Œìœ¼ë¡œ ë£¨í”„ë¥¼ ëŒë¦°ë‹¤. ì–´ë–¤ ì—ì´ì „íŠ¸ SDK ë¶„ê¸°ë„ ì—†ë‹¤.</p>
  </li>
</ol>

<p>ì„¤ì¹˜<br />
pip install mcp requests pydantic orjson</p>

<p>tools_only.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== ê³µí†µ ë°ì´í„° ëª¨ë¸ ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># OpenAI/í•¨ìˆ˜ì½œ í˜¸í™˜ í¬ë§·ìœ¼ë¡œ í†µì¼
</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, description, parameters(JSON Schema)}
</span>
<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {name, arguments(str or dict)}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend ì¸í„°í˜ì´ìŠ¤ ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    OpenAI Chat Completions í˜¸í™˜(ë˜ëŠ” ìœ ì‚¬) ì—”ë“œí¬ì¸íŠ¸ìš© ë°±ì—”ë“œ.
    /v1/chat/completions ë˜ëŠ” /chat ê°™ì€ ê³³ì— ë§ì¶° ìµœì†Œí•œì˜ ì–´ëŒ‘í„°ë§Œ ì œê³µ.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>  <span class="c1"># "/v1/chat/completions"ë¡œ ë°”ê¿”ë„ ë¨
</span>
    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="c1"># ì„œë²„ ê·œê²©ì— ë§ê²Œ í•„ìš”í•œ í‚¤ë§Œ ë‹´ëŠ”ë‹¤. í•„ìš”ì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì •.
</span>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="c1"># dataë¥¼ ChatResponseë¡œ ë§¤í•‘; ë„ˆì˜ ì—”ë“œí¬ì¸íŠ¸ ê·œê²©ì— ë§ê²Œ ì—¬ê¸°ë§Œ ì¡°ì •í•˜ë©´ ëœë‹¤.
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 2) ToolProvider ì¸í„°í˜ì´ìŠ¤ ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ToolProvider</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span> <span class="bp">...</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="bp">...</span>

<span class="c1"># ---- 2-1) MCP í”„ë¡œë°”ì´ë” (ì—¬ëŸ¬ ì„œë²„ í¬í•¨) ----
# mcp ì„¤ì¹˜ í•„ìš”
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">],</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolDef</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="c1"># ë™ê¸° ì¸í„°í˜ì´ìŠ¤ ìš”êµ¬ ë•Œë¬¸ì— ìºì‹œ ê¸°ë°˜. ìµœì´ˆ í˜¸ì¶œ ì „ì— warmup()ì„ í˜¸ì¶œí•˜ê±°ë‚˜,
</span>        <span class="c1"># Orchestratorê°€ ì‘ë‹µ ì „ await ensure_ready()ë¥¼ í•œ ë²ˆ ìˆ˜í–‰.
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await provider.ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="c1"># list_toolsëŠ” asyncë¼ ì—¬ê¸°ì„œ ë¯¸ë¦¬ ëª¨ì€ë‹¤.
</span>        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_to_tooldef</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># tool_nameì€ "server:tool"ì´ì–´ì•¼ í•¨
</span>        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server namespace: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ---- 2-2) ë¡œì»¬ íˆ´ í”„ë¡œë°”ì´ë”(ì„ íƒ) ----
</span>
<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">(</span><span class="n">ToolProvider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚°. ì…ë ¥: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                    <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (ë„êµ¬ë§Œ ì…ë ¥í•´ì„œ ë™ì‘) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ëª©ì : íˆ´ë§Œ ì…ë ¥í•´ì„œ ë™ì‘. ì–´ë–¤ Chat(ë°±ì—”ë“œ)ì—ë„ ì¬ì‚¬ìš©.
    - providers: ToolProviderë“¤ì˜ ë¦¬ìŠ¤íŠ¸
    - backend: ChatBackend êµ¬í˜„ì²´ 1ê°œ
    - expose_fn: ì„ íƒì ìœ¼ë¡œ </span><span class="sh">'</span><span class="s">íˆ´ ì†Œì¶œ</span><span class="sh">'</span><span class="s"> ì „ëµì„ ì£¼ì… (ê¸°ë³¸ê°’: ì „ë¶€ ë…¸ì¶œ)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolProvider</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># MCPProvider ê°™ì€ async ì¤€ë¹„ê°€ í•„ìš”í•œ í”„ë¡œë°”ì´ë”ë¥¼ ì›Œë°ì—…
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># ê° í”„ë¡œë°”ì´ë”ê°€ ì±…ì„ì§€ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ë¼ìš°íŒ…
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># ë¹ ë¥¸ íŒë³„: MCPëŠ” "server:" ë„¤ì„ìŠ¤í˜ì´ìŠ¤, ë¡œì»¬ì€ "local." ê°™ì€ ê·œì¹™ ì¶”ì²œ
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">):</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>  <span class="c1"># server:tool
</span>                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># ë§ˆì§€ë§‰ fallback: ëª¨ë“  providerì— ì‹œë„
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider could handle tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="c1"># íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ ìˆ˜ì§‘í•˜ê³  ì†Œì¶œ ì „ëµ ì ìš©
</span>            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="c1"># ëª¨ë¸ì—ê²Œ ë„êµ¬ê²°ê³¼ë¥¼ ì¼ê´„ ì¬ì£¼ì…
</span>            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== ì‹¤í–‰ ì˜ˆì‹œ ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP ì„œë²„ë“¤: í•„ìš” ì„œë²„ë§Œ ë‚˜ì—´
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>

    <span class="c1"># 2) ë¡œì»¬ íˆ´(ì„ íƒ)
</span>    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># 3) ì–´ë–¤ Chatì´ë“  ë¶™ì¼ ë°±ì—”ë“œ. base_urlê³¼ pathë§Œ ë§ì¶”ë©´ ë.
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">,</span>               <span class="c1"># í•„ìš”ì— ë”°ë¼ "/v1/chat/completions" ë“±ìœ¼ë¡œ ë³€ê²½
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°: ì…ë ¥ì€ â€œíˆ´(í”„ë¡œë°”ì´ë”)â€ë¿
</span>    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="c1"># ê°„ë‹¨ ì†Œì¶œ: íŒŒì¼/SQL ê´€ë ¨ ë‹¨ì–´ê°€ ì—†ìœ¼ë©´ MCPë¥¼ ìˆ¨ê¸°ê³  ë¡œì»¬ë§Œ ë…¸ì¶œ
</span>        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">íŒŒì¼</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ì¿¼ë¦¬</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSVë¥¼ ì½ê³  í•©ê³„ë¥¼ ê³„ì‚°í•œ ë’¤ ìˆ˜ì¹˜ê°€ ë§ëŠ”ì§€ ê³„ì‚°ê¸°ë¡œ ê²€ì¦í•´ì¤˜. íŒŒì¼ì€ ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">ë„ˆëŠ” MCP íˆ´ì„ ì‹ ì¤‘íˆ ì‚¬ìš©í•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ìµœì¢… ë¡œê·¸ ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì„¤ëª…ê³¼ ì‚¬ìš©ë²• ìš”ì•½<br />
ì…ë ¥ì€ íˆ´(í”„ë¡œë°”ì´ë”)ë§Œ ë„˜ê¸´ë‹¤. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ëŠ” íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ í•©ì¹˜ê³ , LLM ì‘ë‹µì˜ tool_callsë¥¼ ë°›ì•„ ì ì ˆí•œ í”„ë¡œë°”ì´ë”ë¡œ ë¼ìš°íŒ…í•œë‹¤. íŠ¹ì • ì—ì´ì „íŠ¸ SDK ë¶„ê¸°ê°€ ì „í˜€ ì—†ë‹¤. ë‹¤ë¥¸ Chat ë°±ì—”ë“œë¡œ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ OpenAICompatibleBackendë§Œ êµì²´í•˜ê±°ë‚˜ send ë©”ì†Œë“œê°€ ë™ì¼í•œ ì‹œê·¸ë‹ˆì²˜ë¥¼ ê°€ì§€ëŠ” ìƒˆ í´ë˜ìŠ¤ë¥¼ í•˜ë‚˜ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p>ìš´ì˜ íŒ<br />
íˆ´ ì†Œì¶œ í•¨ìˆ˜(expose_fn)ë¡œ í„´ë³„ í•„í„°ë§ì„ ê¼­ ë„£ì. ë‹¨ìˆœ í‚¤ì›Œë“œë§Œìœ¼ë¡œë„ ì„ íƒ ì˜¤ë¥˜ì™€ ë¶ˆí•„ìš” í˜¸ì¶œì´ í¬ê²Œ ì¤€ë‹¤.<br />
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì¼ê´€ë˜ê²Œ ìœ ì§€í•˜ì. MCPëŠ” server:tool, ë¡œì»¬ì€ local.*ì²˜ëŸ¼ êµ¬ë¶„í•˜ë©´ ì¶©ëŒì´ ì—†ë‹¤.<br />
ê³ ìœ„í—˜ íˆ´ì€ parametersì— dry_run, confirm ë¬¸ìì—´ ê°™ì€ ì œì•½ì„ ë„£ì–´ì•¼ í•œë‹¤.<br />
ëŒ€ìš©ëŸ‰ ê²°ê³¼ëŠ” MCP ì„œë²„ê°€ íŒŒì¼ í•¸ë“¤(ë¦¬ì†ŒìŠ¤)ë¡œ ë°˜í™˜í•˜ê³ , ëª¨ë¸ì—ëŠ” ìš”ì•½/ë©”íƒ€ë°ì´í„°ë§Œ ì¬ì£¼ì…í•´ í† í°ì„ ì•„ë¼ì.</p>

<p>ì´ êµ¬ì¡°ë©´ ê°™ì€ Orchestratorë¥¼ ê·¸ëŒ€ë¡œ ë‘ê³ , ì–´ë–¤ Chat UI/ì—”ì§„ì—ë„ ì‰½ê²Œ ì´ì‹í•  ìˆ˜ ìˆë‹¤. í•„ìš”í•˜ë©´ ë„¤ ì—”ë“œí¬ì¸íŠ¸ì˜ ì •í™•í•œ JSON ê·œê²©ì„ ì•Œë ¤ì¤˜. OpenAICompatibleBackendì˜ ë§¤í•‘ë§Œ 10ì¤„ì¯¤ ì†ë³´ë©´ ë°”ë¡œ ë¬¼ë¦´ ìˆ˜ ìˆê²Œ ë§ì¶°ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì´ê±´ ë˜ openai agentëŠ” ì•ˆ ì“°ëŠ” ê²ƒ ê°™ì€ë°

</p>

<p>ë§ì•„, ë°©ê¸ˆ ì¤€ ìŠ¤ìºí´ë”©ì€ â€œì˜¤í”ˆAI Agents SDKâ€ë¥¼ ì“°ì§€ ì•ŠëŠ” ìˆœìˆ˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ì˜€ì§€. ë„ˆê°€ ì›í•˜ëŠ” ê±´ ê·¸ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œ, ë°±ì—”ë“œë§Œ ê°ˆì•„ë¼ì›Œ â€œOpenAI Agents Python SDKâ€ë¥¼ LLM ë°±ì—”ë“œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê²ƒ. ì•„ë˜ì²˜ëŸ¼ ë°±ì—”ë“œ ì–´ëŒ‘í„° í•˜ë‚˜ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°Â·íˆ´ í”„ë¡œë°”ì´ë”Â·ë¼ìš°íŒ…ì€ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©í•˜ê³ , ì—ì´ì „íŠ¸ SDKëŠ” ë‹¨ì§€ â€œí…ìŠ¤íŠ¸+íˆ´ì½œ JSONì„ ë±‰ëŠ” ëª¨ë¸ ë°±ì—”ë“œâ€ë¡œë§Œ ì“´ë‹¤. ì¦‰, Agents SDKì—ê²Œ MCP ì‹¤í–‰ì„ ë§¡ê¸°ì§€ ì•Šê³ , ìš°ë¦¬ê°€ ë§Œë“  ë¼ìš°í„°ê°€ ê³„ì† MCPë¥¼ í˜¸ì¶œí•œë‹¤.</p>

<p>í•µì‹¬ ì•„ì´ë””ì–´<br />
ì—ì´ì „íŠ¸ SDKì—ê²Œ ë„êµ¬ë¥¼ ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤(tool_choice ì—†ì´). ëŒ€ì‹  ìš°ë¦¬ê°€ ë„˜ê¸´ íˆ´ ì¹´íƒˆë¡œê·¸ë¥¼ í”„ë¡¬í”„íŠ¸ì— JSONìœ¼ë¡œ ì£¼ê³ , ì—ì´ì „íŠ¸ê°€ ë°˜ë“œì‹œ ë‹¤ìŒ í¬ë§·ì˜ JSONë§Œ ì¶œë ¥í•˜ë„ë¡ ê°•ì œí•œë‹¤. ê·¸ëŸ¬ë©´ ìš°ë¦¬ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ ê·¸ JSONì„ íŒŒì‹±í•´ ì‹¤ì œ MCP/ë¡œì»¬ íˆ´ë¡œ ë¼ìš°íŒ…í•œë‹¤. ì´ëŸ¬ë©´ Agent ì „ìš© ì½”ë“œ ë¶„ê¸°ê°€ ìƒê¸°ì§€ ì•ŠëŠ”ë‹¤. ë°±ì—”ë“œë¥¼ ë°”ê¿” ë¼ìš°ëŠ” ê²ƒë§Œìœ¼ë¡œ ê°™ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ ê·¸ëŒ€ë¡œ ë™ì‘í•œë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install openai-agents mcp requests pydantic orjson</p>

<p>agents_backend.py<br />
ì•„ë˜ íŒŒì¼ì€ ë„¤ê°€ ì´ì „ì— ë°›ì€ tools_only.pyì˜ êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ë”°ë¥´ë˜, ChatBackend êµ¬í˜„ì²´ë¡œ AgentsBackendë¥¼ ì¶”ê°€í•œ ë²„ì „ì´ë‹¤. ë‚˜ë¨¸ì§€ëŠ” ë™ì¼í•˜ë‹ˆ ì´ íŒŒì¼ í•˜ë‚˜ë¡œ êµì²´í•´ë„ ë˜ê³ , í•„ìš”í•œ ë¶€ë¶„ë§Œ ê°€ì ¸ë‹¤ ì¨ë„ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># ========== ê³µí†µ ë°ì´í„° ëª¨ë¸ ==========
</span>
<span class="k">class</span> <span class="nc">ChatMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ToolDef</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {"name": ..., "arguments": str|dict}
</span>
<span class="k">class</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># ========== 1) ChatBackend ì¸í„°í˜ì´ìŠ¤ ==========
</span>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span> <span class="nc">ChatBackend</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span> <span class="bp">...</span>

<span class="k">class</span> <span class="nc">OpenAICompatibleBackend</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">h</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">,[{}])[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">})</span>

<span class="c1"># ========== 1-b) OpenAI Agents SDK ë°±ì—”ë“œ ì–´ëŒ‘í„° ==========
</span>
<span class="c1"># Agents SDKëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë„êµ¬ ì‹¤í–‰ê¹Œì§€ ë§¡ê¸¸ ìˆ˜ ìˆì§€ë§Œ,
# ì—¬ê¸°ì„œëŠ” "í…ìŠ¤íŠ¸+íˆ´ì½œ JSONì„ ìƒì„±í•˜ëŠ” ëª¨ë¸"ë¡œë§Œ ì‚¬ìš©í•œë‹¤.
# í”„ë¡¬í”„íŠ¸ ê°•ì œ í˜•ì‹ìœ¼ë¡œ tool_callsë¥¼ JSONìœ¼ë¡œ ì¶œë ¥í•˜ê²Œ ë§Œë“ ë‹¤.
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="n">agents.model_settings</span> <span class="kn">import</span> <span class="n">ModelSettings</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">class</span> <span class="nc">AgentsBackend</span><span class="p">(</span><span class="n">ChatBackend</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># LiteLLM ëª¨ë¸ í™•ì¥ì„ ì‚¬ìš©í•´ ì„ì˜ì˜ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë¶™ì¼ ìˆ˜ ìˆë‹¤.
</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/v1</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># ë„êµ¬ëŠ” ì—ì´ì „íŠ¸ì— ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤. ìš°ë¦¬ê°€ ì§ì ‘ ë¼ìš°íŒ…í•  ê²ƒì´ê¸° ë•Œë¬¸.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">LLMOnly</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span>
            <span class="n">model_settings</span><span class="o">=</span><span class="nc">ModelSettings</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ì ˆëŒ€ ìë™ ë„êµ¬ í˜¸ì¶œ ê¸ˆì§€
</span>        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># íˆ´ ëª©ë¡ì„ JSONìœ¼ë¡œ ì£¼ê³ , ì •í™•í•œ ì¶œë ¥ í¬ë§·ì„ ê°•ì œí•œë‹¤.
</span>        <span class="n">tools_payload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span>
            <span class="n">tools_payload</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">tools_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_prompt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tools_json</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_tools_to_schema_snippet</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">ìœ„ëŠ” ëŒ€í™” ë‚´ì—­ì´ë‹¤. ì•„ë˜ëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ëª©ë¡ì´ë‹¤.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">TOOLS_JSON=</span><span class="si">{</span><span class="n">tools_json</span><span class="si">}</span><span class="se">\n\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">ë°˜ë“œì‹œ ë‹¤ìŒ JSON í¬ë§·ìœ¼ë¡œë§Œ ë‹µí•˜ë¼. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ë§ë¼.</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">{</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;ìµœì¢… ìì—°ì–´ ì‘ë‹µ(ìˆìœ¼ë©´)&gt;</span><span class="sh">"</span><span class="s"> ,</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">  </span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="s">: [</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-1</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}},</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">'</span><span class="s">     {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">id-2</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="s">:{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">&lt;toolName&gt;</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="s">:{...}}}</span><span class="se">\n</span><span class="sh">'</span>
            <span class="sh">"</span><span class="s">  ]</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">}</span><span class="se">\n</span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">ì—¬ëŸ¬ ë„êµ¬ê°€ í•„ìš”í•˜ë©´ tool_calls ë°°ì—´ì— ìˆœì„œëŒ€ë¡œ ë„£ì–´ë¼. ë„êµ¬ê°€ í•„ìš” ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ì„ ë„£ì–´ë¼.</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">history</span> <span class="o">+</span> <span class="p">[</span><span class="sh">""</span><span class="p">,</span> <span class="n">guide</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_build_prompt</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
        <span class="c1"># Developer ë©”ì‹œì§€ì— ê°•ì œ í¬ë§· ê°€ì´ë“œë¥¼ ë„£ì–´ JSONë§Œ ì¶œë ¥í•˜ê²Œ í•œë‹¤.
</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">developer_instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">JSON í¬ë§·ë§Œ ì¶œë ¥</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">final_output</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, ì¼ë°˜ í…ìŠ¤íŠ¸ë§Œ ì±„ì›Œì„œ ë°˜í™˜
</span>            <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">tool_calls</span><span class="o">=</span><span class="p">[])</span>
        <span class="c1"># í‘œì¤€ ChatResponseë¡œ ë§µ
</span>        <span class="n">tc_raw</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># argumentsê°€ dictê°€ ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ í†µê³¼(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ìª½ì—ì„œ ì •ê·œí™”)
</span>        <span class="k">return</span> <span class="nc">ChatResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">),</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span><span class="nc">ToolCall</span><span class="p">(</span><span class="o">**</span><span class="n">tc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tc_raw</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tc_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

<span class="c1"># ========== 2) ToolProvider (MCP/ë¡œì»¬) ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">class</span> <span class="nc">MCPProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_started</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cfgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">_Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_started</span><span class="p">()</span>
        <span class="n">merged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
                <span class="n">merged</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">namespaced</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{}})</span>
                <span class="p">}))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="n">merged</span>

    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">MCPProvider not ready. Call await ensure_ready() first.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools_cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">tool</span> <span class="o">=</span> <span class="n">tool_name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">it</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">packed</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown server: </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">LocalToolsProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_defs</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ToolDef</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚°. ì…ë ¥ {expr:string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">})]</span>
    <span class="k">def</span> <span class="nf">list_tools</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_defs</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:{}},</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:[{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span><span class="n">val</span><span class="p">}}]}</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown local tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ========== 3) Orchestrator (ë³€ê²½ ì—†ìŒ) ==========
</span>
<span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">providers</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">ChatBackend</span><span class="p">,</span> <span class="n">expose_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">providers</span> <span class="o">=</span> <span class="n">providers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span> <span class="o">=</span> <span class="n">max_rounds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">expose_fn</span> <span class="o">=</span> <span class="n">expose_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">_messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ensure_ready</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">ensure_ready</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_catalog</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDef</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‹¨ì„œ
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MCPProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LocalToolsProvider</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># í´ë°±
</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">providers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">p</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">no provider can handle </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">system_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">ensure_ready</span><span class="p">()</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">system_text</span><span class="p">:</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_text</span><span class="p">))</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_text</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_rounds</span><span class="p">):</span>
            <span class="n">all_tools</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_catalog</span><span class="p">()</span>
            <span class="n">exposed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">expose_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">all_tools</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nf">_coerce_args</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">function</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_dispatch_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span><span class="n">result</span><span class="p">}).</span><span class="nf">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span><span class="n">args</span><span class="p">,</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}).</span><span class="nf">decode</span><span class="p">())</span>

            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">TOOL_RESULTS</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">messages</span>

<span class="c1"># ========== ì‹¤í–‰ ì˜ˆì‹œ ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># MCP ì„œë²„ ì˜ˆì‹œ
</span>    <span class="n">mcp</span> <span class="o">=</span> <span class="nc">MCPProvider</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization":"Bearer X"}),
</span>    <span class="p">])</span>
    <span class="n">local</span> <span class="o">=</span> <span class="nc">LocalToolsProvider</span><span class="p">()</span>

    <span class="c1"># A) OpenAI Agents SDKë¥¼ ë°±ì—”ë“œë¡œ ì‚¬ìš©
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="nc">AgentsBackend</span><span class="p">(</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸(LiteLLMë„ ê°€ëŠ¥)
</span>        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>                <span class="c1"># í˜¹ì€ ë„¤ ì„ì˜ ëª¨ë¸ëª…
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>

    <span class="c1"># B) í•„ìš”í•˜ë©´ ê¸°ì¡´ OpenAICompatibleBackendë¡œ êµì²´ ê°€ëŠ¥
</span>    <span class="c1"># backend = OpenAICompatibleBackend(base_url="http://localhost:8000", path="/chat", model="my-model")
</span>
    <span class="n">orch</span> <span class="o">=</span> <span class="nc">Orchestrator</span><span class="p">(</span>
        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp</span><span class="p">,</span> <span class="n">local</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="n">expose_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="s">local.</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="n">function</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">content</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">íŒŒì¼</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sql</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ì¿¼ë¦¬</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">max_rounds</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orch</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">user_text</span><span class="o">=</span><span class="sh">"</span><span class="s">CSVë¥¼ ì½ê³  í•©ê³„ë¥¼ êµ¬í•œ ë’¤ ê³„ì‚°ê¸°ë¡œ ìˆ˜ì¹˜ ê²€ì¦ê¹Œì§€ í•´ì¤˜. íŒŒì¼ì€ ./data/sales.csv</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">system_text</span><span class="o">=</span><span class="sh">"</span><span class="s">ë„ˆëŠ” MCP íˆ´ì„ ì‹ ì¤‘íˆ ì‚¬ìš©í•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== ìµœì¢… ë¡œê·¸ ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">role</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="si">:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì‘ë™ ë°©ì‹ ì •ë¦¬<br />
1ë‹¨ê³„. AgentsBackendëŠ” OpenAI Agents Python SDKì˜ Agentë¥¼ ëª¨ë¸ ë°±ì—”ë“œë¡œë§Œ ì“´ë‹¤. ë„êµ¬ëŠ” ë“±ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤.<br />
2ë‹¨ê³„. ìš°ë¦¬ê°€ ë…¸ì¶œí•  íˆ´ ëª©ë¡ì„ JSONìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ì— ë„£ê³ , ì—ì´ì „íŠ¸ê°€ contentì™€ tool_calls ë°°ì—´ì„ ì •í™•íˆ ë‹´ì€ JSONë§Œ ì¶œë ¥í•˜ê²Œ ê°•ì œí•œë‹¤.<br />
3ë‹¨ê³„. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ëŠ” ê·¸ tool_callsë¥¼ ë°›ì•„ ê¸°ì¡´ê³¼ ë˜‘ê°™ì´ MCP/ë¡œì»¬ íˆ´ë¡œ ë¼ìš°íŒ…í•œë‹¤.<br />
4ë‹¨ê³„. ì¦‰, ê°™ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì½”ë“œë¥¼ ìœ ì§€í•œ ì±„, ë°±ì—”ë“œë§Œ ê°ˆì•„ë¼ì›Œ Agents SDK ë˜ëŠ” ì¼ë°˜ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ììœ ë¡­ê²Œ ì„ íƒí•  ìˆ˜ ìˆë‹¤.</p>

<p>ì£¼ì˜ì ê³¼ íŒ<br />
JSON ê°•ì œ í”„ë¡¬í”„íŠ¸ê°€ ì¤‘ìš”í•˜ë‹¤. ëª¨ë¸ì´ ì¥ì‹ í…ìŠ¤íŠ¸ë¥¼ ì„ì§€ ì•Šë„ë¡ developer_instructionsë¡œ â€œJSONë§Œ ì¶œë ¥â€ì„ ë°˜ë³µí•´ì„œ ê³ ì •í•˜ë¼.<br />
íˆ´ ìŠ¤í‚¤ë§ˆë¥¼ ì—„ê²©í•˜ê²Œ. required, enum, formatì„ ì¶©ë¶„íˆ ë„£ìœ¼ë©´ arguments íŒŒì‹± ì‹¤íŒ¨ê°€ ì¤„ì–´ë“ ë‹¤.<br />
ì„±ëŠ¥. AgentsBackendëŠ” Runner.run_syncë¥¼ í•œ í„´ë§ˆë‹¤ í˜¸ì¶œí•œë‹¤. ëŒ€í™” ê¸¸ì–´ì§€ë©´ í† í°Â·ì‹œê°„ì´ ëŠ˜ì–´ë‚˜ë¯€ë¡œ expose_fnìœ¼ë¡œ íˆ´ì„ í„´ë³„ë¡œ ì†Œì¶œí•˜ê³ , ê²°ê³¼ëŠ” ìš”ì•½í•´ì„œ ì¬ì£¼ì…í•˜ë¼.<br />
ëŒ€ì²´. ì—ì´ì „íŠ¸ SDKì˜ ëª¨ë¸ ëŒ€ì‹  OpenAICompatibleBackendë¡œ ë°”ê¾¸ë©´ ë°”ë¡œ ë™ì¼ ì½”ë“œê°€ ë‹¤ë¥¸ Chatì—ë„ ë¶™ëŠ”ë‹¤. ëª©ì ì— ë§ì¶° ë°±ì—”ë“œë§Œ êµì²´í•˜ë©´ ëœë‹¤.</p>

<p>ì´ë ‡ê²Œ í•˜ë©´ ì—ì´ì „íŠ¸ SDKë¥¼ â€œë°±ì—”ë“œ ëª¨ë¸â€ë¡œë§Œ ì“°ë©´ì„œ, ë„ˆì˜ íˆ´ ì¤‘ì‹¬ ì¸í„°í˜ì´ìŠ¤ì™€ ë¼ìš°í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ëœë‹¤. ë‹¤ìŒì—ëŠ” ë„¤ ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ì˜ ì¶œë ¥ JSON ì˜ˆì‹œë¥¼ ì•Œë ¤ì¤˜. AgentsBackendì˜ JSON íŒŒì‹± ë¶€ë¶„ì„ ê±°ê¸°ì— ë§ì¶° 2~3ì¤„ë§Œ ì¡°ì •í•˜ë©´ ëœë‹¤.</p>

<p class="chat--user">

ì•„ ë³µì¡í•´ ê·¸ëƒ¥ function_toolë¡œ ê° toolì„ ë“±ë¡í•˜ë©´ ì–´ë–¨ê¹Œ

</p>

<p>ì¢‹ì§€. â€œê·¸ëƒ¥ function_toolë¡œ ê° íˆ´ì„ ë“±ë¡â€í•˜ëŠ” ê°€ì¥ ê¹”ë”í•œ ë°©ë²•ì€, MCP ì„œë²„ë“¤ì—ì„œ list_toolsë¥¼ ê¸ì–´ì™€ì„œ ê°ê°ì„ Agents SDKì˜ FunctionToolë¡œ ë™ì ìœ¼ë¡œ ë˜í•‘í•˜ëŠ” ê±°ì•¼. ê·¸ëŸ¬ë©´ Agent ìª½ì€ ì „í˜€ ì»¤ìŠ¤í…€ ë¶„ê¸° ì—†ì´ í‘œì¤€ íˆ´ë§Œ ë³¸ë‹¤. ì•„ë˜ ì½”ë“œê°€ ë°”ë¡œ ê·¸ íŒ¨í„´ì´ê³ , ì»¤ìŠ¤í…€ LLMë„ LiteLLM ëª¨ë¸ ì–´ëŒ‘í„°ë¡œ ë¶™ì¸ë‹¤.</p>

<p>í•µì‹¬ ê°œë… í•œ ì¤„ ìš”ì•½<br />
MCPì˜ tool ë©”íƒ€ë°ì´í„°(name, description, input_schema)ë¥¼ Agents SDKì˜ FunctionTool(name, description, params_json_schema, on_invoke_tool)ì— ê·¸ëŒ€ë¡œ ë§¤í•‘í•˜ê³ , on_invoke_toolì—ì„œ í•´ë‹¹ MCP ì„¸ì…˜ìœ¼ë¡œ call_toolë§Œ ë¼ìš°íŒ…í•œë‹¤. FunctionTool/<code class="language-plaintext highlighter-rouge">@function_tool</code> ì‚¬ìš©ë²•ê³¼ JSON ìŠ¤í‚¤ë§ˆ í¬ë§·ì€ Agents ë¬¸ì„œ ê·¸ëŒ€ë¡œë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a> ë˜í•œ ëª¨ë¸ì€ LiteLLMModelë¡œ ë„ˆì˜ ë² ì´ìŠ¤ URLì„ ëª¨ë¸ì²˜ëŸ¼ ì“¸ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>ì„¤ì¹˜<br />
pip install "openai-agents[litellm]" mcp pydantic orjson</p>

<p>mcp_as_function_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="c1"># MCP Python SDK
</span><span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤(íˆ´ ì´ë¦„ prefixì— ë“¤ì–´ê°)
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cdfg</span><span class="p">.</span><span class="n">name</span> <span class="nf">if </span><span class="p">(</span><span class="n">cdfg</span> <span class="p">:</span><span class="o">=</span> <span class="n">cfg</span><span class="p">)</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    MCP tool -&gt; Agents FunctionTool
    tool_meta: has .name, .description, .input_schema (JSON Schema)
    </span><span class="sh">"""</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Agents SDKê°€ args_jsonì„ JSON ë¬¸ìì—´ë¡œ ë„˜ê²¨ì¤€ë‹¤ â†’ dictë¡œ íŒŒì‹± í›„ MCP í˜¸ì¶œ
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># ëª¨ë¸ì´ í˜•ì‹ ì–´ê¸°ë©´ rawë¡œ ì „ë‹¬(ì„œë²„ ìª½ ê²€ì¦ì— ë§¡ê¹€)
</span>            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="c1"># MCP í‘œì¤€ contentë¥¼ í…ìŠ¤íŠ¸/JSON ìœ„ì£¼ë¡œ ì •ê·œí™”
</span>        <span class="n">packed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
        <span class="c1"># ì—ì´ì „íŠ¸ì—ê²ŒëŠ” ë¬¸ìì—´ì„ ë°˜í™˜í•˜ë¯€ë¡œ JSON ë¬¸ìì—´ë¡œ ë¬¶ì–´ì¤€ë‹¤
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="c1"># FunctionToolì€ name/description/params_json_schema/on_invoke_toolë§Œ ì£¼ë©´ ëœë‹¤.
</span>    <span class="c1"># ê³µì‹ ë¬¸ì„œì˜ "Custom function tools" ì„¹ì…˜ê³¼ ë™ì¼í•œ ìƒì„±ì. :contentReference[oaicite:2]{index=2}
</span>    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">make_function_tool_for_mcp</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) ì—¬ëŸ¬ MCP ì„œë²„ë¥¼ ì„ ì–¸
</span>    <span class="n">servers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="search", kind="sse", url="https://mcp.example.com/sse", headers={"Authorization": "Bearer X"}),
</span>        <span class="c1"># MCPServerCfg(name="db", kind="stdio", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">]</span>

    <span class="c1"># 2) MCPì˜ ëª¨ë“  íˆ´ì„ FunctionToolë¡œ ë“±ë¡
</span>    <span class="n">mcp_function_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_tools_from_mcp</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>

    <span class="c1"># 3) ì»¤ìŠ¤í…€ LLM(ë„ˆì˜ ì—”ë“œí¬ì¸íŠ¸)ì„ LiteLLM ëª¨ë¸ë¡œ ì‚¬ìš©
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-custom-model</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># ë„¤ ì—”ë“œí¬ì¸íŠ¸ë¥¼ OpenAI í˜¸í™˜ìœ¼ë¡œ ë…¸ì¶œí–ˆë‹¤ëŠ” ê°€ì •
</span>        <span class="n">api_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 4) ì—ì´ì „íŠ¸ êµ¬ì„±: â€œfunction_toolë¡œ ë“±ë¡ëœ MCP íˆ´â€ë§Œ ì „ë‹¬
</span>    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MCP-through-FunctionTools</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_function_tools</span><span class="p">,</span>  <span class="c1"># í¬ì¸íŠ¸: ì˜¤ì§ function_toolë§Œ
</span>    <span class="p">)</span>

    <span class="c1"># 5) ì‹¤í–‰
</span>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data í´ë”ì—ì„œ sales.csvë¥¼ ì½ê³  í•©ê³„ ê³„ì‚°í•´ì¤˜. í•„ìš”í•˜ë©´ ìŠ¤ìŠ¤ë¡œ ì ì ˆí•œ MCP íˆ´ì„ ê³¨ë¼ ì¨.</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì–´ë–»ê²Œ ëŒì•„ê°€ë‚˜<br />
1ë‹¨ê³„. ì—¬ëŸ¬ MCP ì„œë²„ì— ì—°ê²°í•˜ê³  list_toolsë¡œ ë©”íƒ€ë¥¼ ê¸ëŠ”ë‹¤.<br />
2ë‹¨ê³„. ê° MCP íˆ´ì„ FunctionToolë¡œ ê°ì‹¼ë‹¤. nameì€ server:toolë¡œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤, descriptionê³¼ JSON ìŠ¤í‚¤ë§ˆëŠ” MCPì˜ description/input_schemaë¥¼ ê·¸ëŒ€ë¡œ ì“´ë‹¤. ì´ ë§¤í•‘ì€ Agents ë¬¸ì„œì˜ Function tools/Custom function tools ê·œì•½ì— ë§ë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a><br />
3ë‹¨ê³„. on_invoke_toolì—ì„œ session.call_toolë§Œ í˜¸ì¶œí•´ ê²°ê³¼ë¥¼ ë¬¸ìì—´(JSON)ë¡œ ë°˜í™˜í•œë‹¤.<br />
4ë‹¨ê³„. AgentëŠ” â€œfunction_toolë¡œ ë“±ë¡ëœ íˆ´â€ë§Œ ë³´ë¯€ë¡œ, ë„¤ê°€ ì›í•œ ë‹¨ìˆœí•œ íˆ´ ë“±ë¡ ëª¨ë¸ ê·¸ëŒ€ë¡œë‹¤. ëª¨ë¸ì€ LiteLLMì„ í†µí•´ ì„ì˜ ë² ì´ìŠ¤ URLì˜ LLMì„ ì“¸ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/models/litellm/?utm_source=chatgpt.com">OpenAI GitHub</a></p>

<p>ì‹¤ì „ íŒ<br />
íˆ´ ê³¼ì ì¬ë¥¼ í”¼í•˜ë ¤ë©´ tools=mcp_function_tools ëŒ€ì‹ , í”„ë¡¬í”„íŠ¸ë¥¼ ë³´ê³  í•„ìš”í•œ ì„œë²„ë§Œ í•„í„°ë§í•´ì„œ ì „ë‹¬í•´ë¼(ì˜ˆ: íŒŒì¼/CSVê°€ ìˆìœ¼ë©´ files:*ë§Œ). Function toolsëŠ” ì„¤ëª…ê³¼ ì¸ì ìŠ¤í‚¤ë§ˆë¥¼ ìë™ ì†Œë¹„í•˜ë‹ˆ, MCP ìª½ ìŠ¤í‚¤ë§ˆë¥¼ ë¹¡ë¹¡í•˜ê²Œ ìœ ì§€í•˜ë©´ arguments ì˜¤ë¥˜ê°€ ì¤„ì–´ë“ ë‹¤. FunctionToolë¡œ ì§ì ‘ ìƒì„±í•˜ë©´ ë°ì½”ë ˆì´í„° ì—†ì´ë„ ì´ë¦„Â·ì„¤ëª…Â·ìŠ¤í‚¤ë§ˆë¥¼ ì›í•˜ëŠ” ëŒ€ë¡œ ë„£ì„ ìˆ˜ ìˆë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">OpenAI GitHub</a></p>

<p>í™•ì¥ ì•„ì´ë””ì–´<br />
ê³ ìœ„í—˜ íˆ´ì— dry_run, confirm ê°™ì€ í•„ë“œë¥¼ MCP input_schemaì— ì¶”ê°€í•˜ë©´, ê·¸ëŒ€ë¡œ FunctionTool ì¸ì ìŠ¤í‚¤ë§ˆì— ë°˜ì˜ë˜ì–´ ì‹¤í–‰ ì „ì— ëª¨ë¸ì´ ìŠ¤ìŠ¤ë¡œ ì•ˆì „ ì ˆì°¨ë¥¼ ë”°ë¥¸ë‹¤.<br />
íˆ´ ê²°ê³¼ê°€ í¬ë©´ on_invoke_toolì—ì„œ ìš”ì•½ë§Œ ë°˜í™˜í•˜ê³ , ì›ë³¸ì€ íŒŒì¼ í•¸ë“¤ì´ë‚˜ URLë¡œ ì œê³µí•˜ë„ë¡ MCP ì„œë²„ë¥¼ ì„¤ê³„í•´ í† í° ì‚¬ìš©ëŸ‰ì„ ì¤„ì¸ë‹¤.</p>

<p>ì›í•˜ë©´ ë„¤ íŒŒì¼/DB MCP ì„œë²„ì˜ ì‹¤ì œ tool ì´ë¦„ê³¼ input_schemaë¥¼ ì•Œë ¤ì¤˜. ìœ„ ìŠ¤í¬ë¦½íŠ¸ê°€ í•´ë‹¹ ìŠ¤í‚¤ë§ˆë¥¼ ê·¸ëŒ€ë¡œ FunctionToolë¡œ ì˜®ê²¨ì£¼ê¸° ë•Œë¬¸ì— ì¶”ê°€ ì½”ë“œëŠ” ì‚¬ì‹¤ìƒ ì—†ë‹¤.</p>

<p class="chat--user">

ì‘ ë‚´ê°€ ì›í•˜ëŠ”ê±°ë‘ ê°€ê¹Œì›Œì§„ë“¯. ì§ˆë¬¸ì´ ë” ìˆì–´. ì§ˆë¬¸ 1. MCP ë§ê³  ì¼ë°˜ Function íˆ´ê³¼ ì„ì¸ ë²„ì ¼ ì¶”ê°€í•´ì¤˜. ì§ˆë¬¸ 2. ì¼ë°˜ chat completions (with tools) ì˜ˆì œë„ ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€í•´ì¤˜. ì§ˆë¬¸ 3. MCP Client Sessionì€ ì €ì ˆë¡œ ì¢…ë£Œë˜ë‚˜? ì§ˆë¬¸ 4. ì—¬ëŸ¬ Agentê°€ ìˆìœ¼ë©´ MCP ì¢…ë¥˜ë³„ë¡œ ì„¸ì…˜ì„ ì—¬ëŸ¬ê°œ ì—´ê²Œë ìˆ˜ë„ ìˆì„ê±° ê°™ì€ë° í•˜ë‚˜ë¡œ ìœ ì§€í•˜ëŠ”ê±´ ì–´ë•Œ? ë¬¸ì œê°€ ìˆìœ¼ë ¤ë‚˜

</p>

<p>ì¢‹ì•„. ë„¤ ì§ˆë¬¸ 4ê°œë¥¼ ìˆœì„œëŒ€ë¡œ, ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì½”ë“œì™€ í•¨ê»˜ ì •ë¦¬í•œë‹¤. ì¸ìš©êµ¬ë¬¸ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.</p>

<h1 id="1-mcp-íˆ´--ì¼ë°˜-function-íˆ´ì„-ì„ì–´-ë“±ë¡í•˜ëŠ”-ë²„ì „">1) MCP íˆ´ + ì¼ë°˜ Function íˆ´ì„ ì„ì–´ ë“±ë¡í•˜ëŠ” ë²„ì „</h1>

<p>ì•„ë˜ëŠ” ì•ì„œ ë§Œë“  â€œMCP â†’ FunctionTool ë˜í•‘â€ì— ë”í•´, ì¼ë°˜ íŒŒì´ì¬ í•¨ìˆ˜ë„ FunctionToolë¡œ í•¨ê»˜ ë“±ë¡í•˜ëŠ” ì˜ˆì‹œë‹¤. ì—ì´ì „íŠ¸ëŠ” ë‘ ì¢…ë¥˜ë¥¼ í•œêº¼ë²ˆì— ë³¸ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>
<span class="kn">import</span> <span class="n">orjson</span>

<span class="c1"># ========== MCP ì—°ê²° ==========
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Connected</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Connected</span><span class="p">]:</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">cfgs</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sess</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
        <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connected</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conns</span>

<span class="k">def</span> <span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_meta</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">params_schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">args_json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">tool_meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">packed</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">params_schema</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_function_tools</span><span class="p">(</span><span class="n">cfgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCPServerCfg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_servers</span><span class="p">(</span><span class="n">cfgs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
        <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">tools</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">mcp_tool_to_function</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">session</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tools</span>

<span class="c1"># ========== ì¼ë°˜ íŒŒì´ì¬ í•¨ìˆ˜ â†’ FunctionTool ==========
</span>
<span class="k">def</span> <span class="nf">make_local_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionTool</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="nc">FunctionTool</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°. ì…ë ¥: {expr: string}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">params_json_schema</span><span class="o">=</span><span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">math_eval</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># ========== ì‹¤í–‰ ì˜ˆì‹œ ==========
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) MCP íˆ´
</span>    <span class="n">mcp_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">build_mcp_function_tools</span><span class="p">([</span>
        <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">]),</span>
        <span class="c1"># MCPServerCfg(name="db", command="python", args=["./servers/db/server.py"]),
</span>    <span class="p">])</span>

    <span class="c1"># 2) ì¼ë°˜ Function íˆ´
</span>    <span class="n">local_tools</span> <span class="o">=</span> <span class="nf">make_local_tools</span><span class="p">()</span>

    <span class="c1"># 3) ëª¨ë¸ (ë„¤ ì»¤ìŠ¤í…€ LLM OpenAI-í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸)
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MixedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">mcp_tools</span> <span class="o">+</span> <span class="n">local_tools</span><span class="p">,</span>  <span class="c1"># ì„ì–´ì„œ ë“±ë¡
</span>    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
        <span class="n">agent</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="sh">"</span><span class="s">data í´ë”ì˜ sales.csvë¥¼ ì½ì–´ í•©ê³„ë¥¼ êµ¬í•˜ê³ , local.math_evalë¡œ ìˆ«ì ê²€ì¦ê¹Œì§€ í•´ì¤˜</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h1 id="2-ì¼ë°˜-chat-completions-with-tools-ì˜ˆì œ">2) ì¼ë°˜ Chat Completions (with tools) ì˜ˆì œ</h1>

<p>OpenAI í˜¸í™˜ Chat Completions APIë¥¼ ì§ì ‘ ì“°ëŠ” ìˆœìˆ˜ ì˜ˆì‹œë‹¤. toolsì— í•¨ìˆ˜ ìŠ¤í‚¤ë§ˆë¥¼ ì£¼ê³ , tool_callsë¥¼ ë°›ì•„ì„œ ë„ˆì˜ ì‹¤í–‰ê¸°ë¡œ ë¼ìš°íŒ…í•œë‹¤. ì—¬ê¸°ì„œëŠ” ë¡œì»¬ ê³„ì‚°ê¸° í•˜ë‚˜ë§Œ ë³´ì—¬ì£¼ì§€ë§Œ, ìœ„ì˜ MCP tools ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ í•©ì³ ë„£ìœ¼ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span><span class="p">,</span> <span class="n">requests</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span>  <span class="c1"># ë„¤ OpenAI í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
                <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># ì—¬ê¸°ì— MCPì—ì„œ ê¸ì–´ì˜¨ toolsë„ ê·¸ëŒ€ë¡œ append ê°€ëŠ¥
</span><span class="p">]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤.</span><span class="sh">"</span><span class="p">},</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">3*(2+5) ê°’ì„ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># 1ì°¨ ìš”ì²­
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">},</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
<span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="c1"># tool_calls ì²˜ë¦¬
</span><span class="k">if</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_local_math_eval</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="c1"># 2ì°¨ ìš”ì²­(ë„êµ¬ ê²°ê³¼ ë°˜ì˜)
</span>    <span class="n">resp2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp2</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">resp2</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
</code></pre></div></div>

<p>í¬ì¸íŠ¸<br />
toolsì— MCPì—ì„œ ê¸ì€ ìŠ¤í‚¤ë§ˆë¥¼ ê·¸ëŒ€ë¡œ ì¶”ê°€í•˜ë©´, ì¼ë°˜ chat completions ë£¨í”„ì—ì„œë„ MCPì™€ ë¡œì»¬ íˆ´ì„ í•¨ê»˜ ì“¸ ìˆ˜ ìˆë‹¤. ë‹¨, MCP í˜¸ì¶œë¶€ëŠ” ë„ˆì˜ ë¼ìš°í„°ê°€ ì²˜ë¦¬í•´ tool ì—­í•  ë©”ì‹œì§€ë¥¼ ë§Œë“¤ì–´ ë„£ìœ¼ë©´ ëœë‹¤.</p>

<h1 id="3-mcp-clientsessionì€-ì €ì ˆë¡œ-ì¢…ë£Œë˜ë‚˜">3) MCP ClientSessionì€ ì €ì ˆë¡œ ì¢…ë£Œë˜ë‚˜?</h1>

<p>ìë™ ì¢…ë£Œë¥¼ ê¸°ëŒ€í•˜ë©´ ì•ˆ ëœë‹¤. í‘œì¤€ íŒ¨í„´ì€ ì„¸ ê°€ì§€ë‹¤.</p>

<ol>
  <li>
    <p>ì„¸ì…˜ì„ ê°ì‹¼ íŠ¸ëœìŠ¤í¬íŠ¸(StdIO/SSE)ì— ëŒ€í•´ stop/closeë¥¼ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤.</p>
  </li>
  <li>
    <p>async with ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ë˜í¼ë¥¼ ë§Œë“¤ì–´ with ë¸”ë¡ì´ ëë‚  ë•Œ ì •ë¦¬í•œë‹¤.</p>
  </li>
  <li>
    <p>í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ í›…ì—ì„œ ì „ì—­ ì„¸ì…˜ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì •ë¦¬í•œë‹¤.</p>
  </li>
</ol>

<p>ê°„ë‹¨ ì •ë¦¬ í•¨ìˆ˜ ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì„¸ì…˜ê³¼ íŠ¸ëœìŠ¤í¬íŠ¸ë¥¼ í•¨ê»˜ ì¶”ì í•´ì•¼ ì•ˆì „
</span><span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<p>ì„¸ì…˜ì„ ì—´ ë•Œ MCPHandleì„ ë§Œë“¤ì–´ ë¦¬ìŠ¤íŠ¸ì— ë„£ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ëª¨ë“  handle.close()ë¥¼ await í•˜ë©´ ëœë‹¤.</p>

<h1 id="4-ì—¬ëŸ¬-agentê°€-ì„¸ì…˜ì„-ê³µìœ í•´ë„-ë ê¹Œ-í•˜ë‚˜ë¡œ-ìœ ì§€í•˜ëŠ”-ì „ëµê³¼-ì£¼ì˜ì ">4) ì—¬ëŸ¬ Agentê°€ ì„¸ì…˜ì„ ê³µìœ í•´ë„ ë ê¹Œ? í•˜ë‚˜ë¡œ ìœ ì§€í•˜ëŠ” ì „ëµê³¼ ì£¼ì˜ì </h1>

<p>ê²°ë¡ ë¶€í„° ë§í•˜ë©´, ê³µìœ  í’€ì„ ë‘ê³  ì¬ì‚¬ìš©í•˜ëŠ” ê²Œ ì¼ë°˜ì ìœ¼ë¡œ ì¢‹ë‹¤. ë‹¤ë§Œ ëª‡ ê°€ì§€ ì£¼ì˜ì ì´ ìˆë‹¤.</p>

<p>ì¥ì <br />
ë©”ëª¨ë¦¬Â·í”„ë¡œì„¸ìŠ¤ ìˆ˜ ì ˆê°. stdio ì„œë²„ëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ í•˜ë‚˜ë§Œ ë„ìš°ë©´ ëœë‹¤.<br />
ì½œë“œ ìŠ¤íƒ€íŠ¸ ì§€ì—° ê°ì†Œ. list_tools ìºì‹œì™€ ì—°ê²° ìˆ˜ë¦½ ì‹œê°„ì´ ì ˆì•½ëœë‹¤.</p>

<p>ì£¼ì˜ì <br />
ë™ì‹œì„±. í•˜ë‚˜ì˜ MCP ì„¸ì…˜ì´ ë‹¤ì¤‘ í˜¸ì¶œì„ ì²˜ë¦¬í•  ë•Œ, ì„œë²„/í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì‹œ í˜¸ì¶œì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•œë‹¤. ëŒ€ë¶€ë¶„ì˜ MCP ì„œë²„ êµ¬í˜„ì€ ê´œì°®ì§€ë§Œ, íŠ¹ì • ì„œë²„ê°€ ìˆœì°¨ ì²˜ë¦¬ë§Œ ì•ˆì „í•˜ê²Œ ì§€ì›í•œë‹¤ë©´ íì‰ì´ë‚˜ ì„¸ë§ˆí¬ì–´ê°€ í•„ìš”í•˜ë‹¤.<br />
ê²©ë¦¬. ì‚¬ìš©ìÂ·ê¶Œí•œì´ ë‹¤ë¥¸ Agentê°€ ê°™ì€ ì„¸ì…˜ì„ ì“°ë©´ ê¶Œí•œ ê²½ê³„ê°€ íë ¤ì§ˆ ìˆ˜ ìˆë‹¤. ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê¶Œí•œ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.<br />
ìƒëª…ì£¼ê¸°. ëˆ„ê°€ ì–¸ì œ ë‹«ì„ì§€ í•©ì˜ê°€ í•„ìš”í•˜ë‹¤. ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŒ… ë˜ëŠ” ëª…ì‹œì  init/close APIê°€ í•„ìš”í•˜ë‹¤.<br />
ë²„ì „Â·ì˜µì…˜ ì°¨ì´. ê°™ì€ ì„œë²„ë¼ë„ í”Œë˜ê·¸(ì˜ˆ: dry_run ê¸°ë³¸ê°’)ê°€ ë‹¤ë¥¸ Agentë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤. ì´ë• ì„¸ì…˜ì„ ê³µìœ í•˜ì§€ ë§ê³  ë³„ë„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë„ì›Œë¼.</p>

<p>ê°„ë‹¨í•œ ì„¸ì…˜ í’€ ìŠ¤ìºí´ë”©(RefCount + AsyncLock):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>

<span class="k">class</span> <span class="nc">MCPSessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,...]],</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># key ì˜ˆì‹œ: ("stdio", ("npx","-y","@modelcontextprotocol/server-filesystem","./data"))
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acquire_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientSession</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">:</span>
                <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
            <span class="c1"># ìƒˆë¡œ ìƒì„±
</span>            <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">:</span> <span class="n">transport</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">release_stdio</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="nf">tuple</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">ref</span><span class="sh">"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">].</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">slot</span><span class="p">[</span><span class="sh">"</span><span class="s">transport</span><span class="sh">"</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">self</span><span class="p">.</span><span class="n">_pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>ì‚¬ìš© íŒ¨í„´<br />
Agentê°€ ì‹œì‘í•  ë•Œ acquire_stdioë¡œ ì„¸ì…˜ì„ ë°›ì•„ ì“°ê³ , ëë‚  ë•Œ release_stdioë¡œ ë°˜ë‚©í•œë‹¤. ë™ì¼í•œ command/args ì¡°í•©ì€ í•œ ì„¸ì…˜ì„ ê³µìœ í•œë‹¤. ê¶Œí•œ ê²©ë¦¬ê°€ í•„ìš”í•œ ê²½ìš° keyì— ì¶”ê°€ ì‹ë³„ì(tenant, role ë“±)ë¥¼ í¬í•¨ì‹œí‚¤ë©´ ëœë‹¤. ë™ì‹œì„± ë°€ë„ê°€ ë†’ë‹¤ë©´ ê° MCP ì„œë²„ íŠ¹ì„±ì— ë§ì¶° per-server ì„¸ë§ˆí¬ì–´ë¥¼ ë”í•´ì£¼ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.</p>

<p>ë§ˆë¬´ë¦¬ íŒ<br />
ì„ì¸ í™˜ê²½(ì¼ë°˜ í•¨ìˆ˜ + MCP)ì—ì„œëŠ” íˆ´ ìˆ˜ê°€ ëŠ˜ì–´ í˜¼ë€ì´ ìƒê¸°ê¸° ì‰¬ìš°ë‹ˆ, ì—ì´ì „íŠ¸ì— ë“±ë¡í•  ë•Œ ë„ë©”ì¸ë³„ í”„ë¦¬í”½ìŠ¤(server:tool, local.*)ì™€ ì§§ê³  ëª…í™•í•œ ì„¤ëª…, ì—„ê²©í•œ JSON ìŠ¤í‚¤ë§ˆ(required/enum/format)ë¥¼ ìœ ì§€í•˜ì. í•„ìš”í•˜ë©´ í•œ í„´ì— ë…¸ì¶œí•  íˆ´ì„ í•„í„°ë§í•´ ê³¼ì ì¬ë¥¼ ì¤„ì´ëŠ” ê²ƒë„ íš¨ê³¼ì ì´ë‹¤.</p>

<p class="chat--user">

1ë²ˆê³¼ 2ë²ˆì„ í•©ì³ì„œ ì¨ì•¼ì§€. ë‘ ê°œ íˆ´ êµ¬í˜„ì´ ë„ˆë¬´ ë‹¤ë¥´ì–ì•„. íˆ´ êµ¬í˜„ì„ í•œ ë²ˆë§Œ í•˜ê³  ë‘ êµ°ë° ëª¨ë‘ì—ì„œ ì“°ê³  ì‹¶ì€ê±°ì•¼.

</p>

<p>ì¢‹ì•„, â€œíˆ´ êµ¬í˜„ì€ í•œ ë²ˆë§Œâ€ í•˜ê³ , ê·¸ê±¸ ë‘ ë°©ì‹ ëª¨ë‘ì—ì„œ ì¬ì‚¬ìš©í•˜ë„ë¡ í•©ì¹˜ì. ì•„ë˜ ìŠ¤ìºí´ë”©ì€ ë‹¨ì¼ ToolRegistryì— íˆ´ì„ ë“±ë¡í•˜ê³ , ê°™ì€ êµ¬í˜„ì„ 1) OpenAI Agents SDK(FunctionTool) ê²½ë¡œ, 2) ì¼ë°˜ Chat Completions(with tools) ê²½ë¡œ ì–‘ìª½ì—ì„œ ê·¸ëŒ€ë¡œ ì”ë‹ˆë‹¤. MCP íˆ´ë„ ë™ì¼í•œ ì¶”ìƒí™”ë¡œ ë˜í•‘í•©ë‹ˆë‹¤.</p>

<p>ì„¤ì¹˜<br />
pip install "openai-agents[litellm]" mcp pydantic orjson requests</p>

<p>unified_tools.py</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">orjson</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1">###############################################################################
# ê³µí†µ ì¶”ìƒí™”: í•œ ë²ˆ êµ¬í˜„í•œ íˆ´ì„ ì–´ë””ì„œë“  ì¬ì‚¬ìš©
###############################################################################
</span>
<span class="c1"># Tool í•¸ë“¤ëŸ¬ ì‹œê·¸ë‹ˆì²˜: args(dict) -&gt; dict/str (awaitable)
</span><span class="n">ToolHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span> <span class="nc">ToolSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># JSON Schema
</span>    <span class="n">handler</span><span class="p">:</span> <span class="n">ToolHandler</span>        <span class="c1"># ì‹¤ì œ ì‹¤í–‰ ë¡œì§(ë™ì¼ êµ¬í˜„ì„ ì–‘ìª½ì—ì„œ ì¬ì‚¬ìš©)
</span>
<span class="k">class</span> <span class="nc">ToolRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">duplicated tool name: </span><span class="si">{</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolSpec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_specs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_tools</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">list_for_chat_completions</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># OpenAI tools í¬ë§·ìœ¼ë¡œ ì§ë ¬í™”
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">():</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">parameters</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1">###############################################################################
# ë¡œì»¬(ì¼ë°˜) íˆ´ êµ¬í˜„ ì˜ˆì‹œ: í•œ ë²ˆë§Œ êµ¬í˜„
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">math_eval_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">0123456789+-*/(). </span><span class="sh">"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">expr must contain only digits and + - * / ( )</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">LOCAL_MATH_TOOL</span> <span class="o">=</span> <span class="nc">ToolSpec</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">local.math_eval</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆì „ ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°. ì…ë ¥ {expr: string}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">expr</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="n">handler</span><span class="o">=</span><span class="n">math_eval_handler</span>
<span class="p">)</span>

<span class="c1">###############################################################################
# MCP íˆ´ì„ ë™ì¼ ì¶”ìƒí™”ë¡œ ë˜í•‘: ì„¸ì…˜ë³„ë¡œ ToolSpecì„ ìƒì„±
###############################################################################
</span>
<span class="kn">from</span> <span class="n">mcp.client.session</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="n">mcp.client.stdio</span> <span class="kn">import</span> <span class="n">StdioClientTransport</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">mcp.client.sse</span> <span class="kn">import</span> <span class="n">SSEClientTransport</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">HAVE_SSE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ prefix
</span>    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># "stdio" | "sse"
</span>    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">MCPHandle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">MCPServerCfg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MCPHandle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">StdioClientTransport</span><span class="p">(</span><span class="nc">StdioServerParameters</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="sh">"</span><span class="s">sse</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mcp.client.sse ëª¨ë“ˆ í•„ìš”</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="nc">SSEClientTransport</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unknown kind: </span><span class="si">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">kind</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">transport</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">ClientSession</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>
    <span class="k">return</span> <span class="nc">MCPHandle</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mcp_toolspecs_from_session</span><span class="p">(</span><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="c1"># ë™ê¸° í•¨ìˆ˜ë¡œ ëª…ì„¸ë§Œ ë§Œë“¤ê³ , handlerëŠ” sessionì„ ìº¡ì²˜í•˜ì—¬ ë¹„ë™ê¸°ë¡œ í˜¸ì¶œ
</span>    <span class="c1"># list_tools ëŠ” asyncë¼ ë°–ì—ì„œ í˜¸ì¶œí•´ metadataë¥¼ ë„˜ê²¨ì¤˜ì•¼ í•œë‹¤.
</span>    <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">call build_mcp_tools(...) instead</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">MCPHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]:</span>
    <span class="n">listed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">list_tools</span><span class="p">()</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">listed</span><span class="p">.</span><span class="n">tools</span><span class="p">:</span>
        <span class="n">namespaced</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">handle</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">input_schema</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">MCP </span><span class="si">{</span><span class="n">namespaced</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">_tool</span><span class="o">=</span><span class="n">t</span><span class="p">):</span>
            <span class="c1"># _toolë¥¼ default ì¸ìë¡œ ë°”ì¸ë”©í•´ late-binding ì´ìŠˆ ë°©ì§€
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">call_tool</span><span class="p">(</span><span class="n">_tool</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">json</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">packed</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="nb">type</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">packed</span>

        <span class="n">specs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">ToolSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">namespaced</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">specs</span>

<span class="c1">###############################################################################
# 1) OpenAI Agents SDK ê²½ë¡œ: FunctionToolë¡œ ë˜í•‘í•˜ë˜, handlerëŠ” ë™ì¼ êµ¬í˜„ ì‚¬ìš©
###############################################################################
</span>
<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">FunctionTool</span>
<span class="kn">from</span> <span class="n">agents.extensions.models.litellm_model</span> <span class="kn">import</span> <span class="n">LitellmModel</span>

<span class="k">def</span> <span class="nf">to_function_tool</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">ToolSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionTool</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">args_json</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># ì—ì´ì „íŠ¸ëŠ” ë¬¸ìì—´ ë°˜í™˜ì´ í‘œì¤€ì´ë¯€ë¡œ JSON ë¬¸ìì—´ë¡œ ì§ë ¬í™”
</span>        <span class="k">return</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">FunctionTool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">params_json_schema</span><span class="o">=</span><span class="n">spec</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">on_invoke_tool</span><span class="o">=</span><span class="n">on_invoke</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">user_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_function_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_specs</span><span class="p">()]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">LitellmModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000/v1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">UnifiedToolsAgent</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">instructions</span><span class="o">=</span><span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">user_text</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">final_output</span><span class="p">)</span>

<span class="c1">###############################################################################
# 2) ì¼ë°˜ Chat Completions ê²½ë¡œ: tools JSON + ë™ì¼ handlerë¡œ tool_calls ë¼ìš°íŒ…
###############################################################################
</span>
<span class="k">class</span> <span class="nc">ChatCompletionsRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">h</span><span class="p">[</span><span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">api_key</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">_headers</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">list_for_chat_completions</span><span class="p">()</span>

        <span class="c1"># 1ì°¨ í˜¸ì¶œ
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="sh">"</span><span class="s">tools</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">,</span> <span class="sh">"</span><span class="s">tool_choice</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">})</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># ë„êµ¬ í˜¸ì¶œ ì²˜ë¦¬ ë£¨í”„(í•„ìš” ì‹œ ë°˜ë³µ)
</span>        <span class="k">while</span> <span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">tool_calls</span><span class="sh">"</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">raw_args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">_raw</span><span class="sh">"</span><span class="p">:</span> <span class="n">raw_args</span><span class="p">}</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spec</span><span class="p">.</span><span class="nf">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

                <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">tool_call_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">orjson</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
                <span class="p">})</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1">###############################################################################
# ì‹¤í–‰ ì˜ˆì‹œ: í•œ ë²ˆ êµ¬í˜„ â†’ ë‘ ê²½ë¡œì—ì„œ ì‚¬ìš©
###############################################################################
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 0) ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìƒì„± ë° ë¡œì»¬ íˆ´ ë“±ë¡(í•œ ë²ˆë§Œ)
</span>    <span class="n">reg</span> <span class="o">=</span> <span class="nc">ToolRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">LOCAL_MATH_TOOL</span><span class="p">)</span>

    <span class="c1"># 1) MCP ì„¸ì…˜ ì—°ê²° í›„, MCP íˆ´ë“¤ì„ ë™ì¼ ì¶”ìƒí™”ë¡œ ë“±ë¡
</span>    <span class="n">files_cfg</span> <span class="o">=</span> <span class="nc">MCPServerCfg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">files</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">stdio</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="sh">"</span><span class="s">npx</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">-y</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">@modelcontextprotocol/server-filesystem</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./data</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">files_handle</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">connect_mcp</span><span class="p">(</span><span class="n">files_cfg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="k">await</span> <span class="nf">build_mcp_tools</span><span class="p">(</span><span class="n">files_handle</span><span class="p">):</span>
            <span class="n">reg</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># A) Agents SDK ê²½ë¡œ
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Agents SDK ê²½ë¡œ ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">run_with_agents</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="sh">"</span><span class="s">data í´ë”ì˜ sales.csvë¥¼ ì½ê³  í•©ê³„ë¥¼ ê³„ì‚°í•œ ë’¤ local.math_evalë¡œ 2ë°°ë¥¼ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># B) ì¼ë°˜ Chat Completions ê²½ë¡œ
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Chat Completions ê²½ë¡œ ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="nc">ChatCompletionsRunner</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="sh">"</span><span class="s">http://localhost:8000</span><span class="sh">"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">my-model</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="n">runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
            <span class="n">reg</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•„ìš”í•  ë•Œë§Œ íˆ´ì„ í˜¸ì¶œí•œë‹¤. íŒŒê´´ì  ì‘ì—…ì€ dry_runì„ ìš°ì„ í•œë‹¤.</span><span class="sh">"</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">files ì„œë²„ íˆ´ë¡œ sales.csv í•©ê³„ë¥¼ êµ¬í•˜ê³  local.math_evalë¡œ 100+23ë„ ê³„ì‚°í•´ì¤˜</span><span class="sh">"</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">files_handle</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸ ì •ë¦¬<br />
íˆ´ì€ ToolSpec(handler í¬í•¨)ìœ¼ë¡œ í•œ ë²ˆë§Œ êµ¬í˜„í•œë‹¤. MCPë„ build_mcp_toolsê°€ ë™ì¼í•œ ToolSpecì„ ë§Œë“¤ê³ , ë¡œì»¬ íˆ´ë„ ê°™ì€ í˜•íƒœë‹¤.<br />
OpenAI Agents SDKëŠ” FunctionToolë¡œ ì–‡ê²Œ ë˜í•‘ë§Œ í•œë‹¤. on_invokeëŠ” ê°™ì€ handlerë¥¼ í˜¸ì¶œí•œë‹¤.<br />
Chat Completions(with tools)ë„ registryì˜ tools JSONì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³ , tool_callsë¥¼ ê°™ì€ handlerë¡œ ë¼ìš°íŒ…í•œë‹¤.<br />
MCP ì„¸ì…˜ì€ MCPHandle.closeë¡œ ëª…ì‹œ ì¢…ë£Œí•œë‹¤. ì—¬ëŸ¬ Agentë‚˜ ì—¬ëŸ¬ ëŸ¬ë„ˆê°€ ìˆì„ ë•Œ ê³µìœ í•˜ê³  ì‹¶ë‹¤ë©´ í•¸ë“¤ í’€ì„ ë‘ê³  ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŒ…ë§Œ ì–¹ìœ¼ë©´ ëœë‹¤.</p>

<p>ì´ì œ â€œíˆ´ êµ¬í˜„ì€ í•œ ë²ˆë§Œâ€ ì“°ê³ , Agentsì™€ Chat Completions ì–´ë””ì„œë“  ë™ì¼í•˜ê²Œ ëŒì•„ê°„ë‹¤. í•„ìš”í•œ ê²½ìš° expose(íˆ´ ì†Œì¶œ) ì •ì±…ì´ë‚˜ ê¶Œí•œ ê²Œì´íŠ¸ë¥¼ registry ë ˆë²¨ì—ì„œ í•„í„°ë§ í›…ìœ¼ë¡œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry></feed>